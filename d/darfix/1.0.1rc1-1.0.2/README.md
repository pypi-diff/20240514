# Comparing `tmp/darfix-1.0.1rc1.tar.gz` & `tmp/darfix-1.0.2.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "darfix-1.0.1rc1.tar", last modified: Mon Apr 15 12:10:21 2024, max compression
+gzip compressed data, was "darfix-1.0.2.tar", last modified: Tue May 14 08:42:01 2024, max compression
```

## Comparing `darfix-1.0.1rc1.tar` & `darfix-1.0.2.tar`

### file list

```diff
@@ -1,192 +1,199 @@
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.592047 darfix-1.0.1rc1/
--rw-r--r--   0 payno     (1000) payno     (1000)     1110 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/LICENSE
--rw-r--r--   0 payno     (1000) payno     (1000)     5255 2024-04-15 12:10:21.592047 darfix-1.0.1rc1/PKG-INFO
--rw-r--r--   0 payno     (1000) payno     (1000)     2778 2024-04-15 09:19:34.000000 darfix-1.0.1rc1/README.rst
--rw-r--r--   0 payno     (1000) payno     (1000)      302 2024-04-15 09:19:34.000000 darfix-1.0.1rc1/pyproject.toml
--rw-r--r--   0 payno     (1000) payno     (1000)     2120 2024-04-15 12:10:21.592047 darfix-1.0.1rc1/setup.cfg
--rw-r--r--   0 payno     (1000) payno     (1000)       69 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/setup.py
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.568047 darfix-1.0.1rc1/src/
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.568047 darfix-1.0.1rc1/src/darfix/
--rw-r--r--   0 payno     (1000) payno     (1000)      546 2024-04-15 09:58:22.000000 darfix-1.0.1rc1/src/darfix/__init__.py
--rw-r--r--   0 payno     (1000) payno     (1000)      654 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/_config.py
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.568047 darfix-1.0.1rc1/src/darfix/app/
--rw-r--r--   0 payno     (1000) payno     (1000)        0 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/app/__init__.py
--rw-r--r--   0 payno     (1000) payno     (1000)     2903 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/app/__main__.py
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.568047 darfix-1.0.1rc1/src/darfix/core/
--rw-r--r--   0 payno     (1000) payno     (1000)       73 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/core/__init__.py
--rw-r--r--   0 payno     (1000) payno     (1000)      344 2024-04-15 09:19:34.000000 darfix-1.0.1rc1/src/darfix/core/autofocus.py
--rw-r--r--   0 payno     (1000) payno     (1000)     9947 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/core/componentsMatching.py
--rw-r--r--   0 payno     (1000) payno     (1000)     3610 2024-04-15 09:19:34.000000 darfix-1.0.1rc1/src/darfix/core/data_selection.py
--rw-r--r--   0 payno     (1000) payno     (1000)   104214 2024-04-15 09:53:18.000000 darfix-1.0.1rc1/src/darfix/core/dataset.py
--rw-r--r--   0 payno     (1000) payno     (1000)     9183 2024-04-15 09:53:22.000000 darfix-1.0.1rc1/src/darfix/core/dimension.py
--rw-r--r--   0 payno     (1000) payno     (1000)     7361 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/core/geneticShiftDetection.py
--rw-r--r--   0 payno     (1000) payno     (1000)     6945 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/core/imageOperations.py
--rw-r--r--   0 payno     (1000) payno     (1000)    12049 2024-04-15 09:19:34.000000 darfix-1.0.1rc1/src/darfix/core/imageRegistration.py
--rw-r--r--   0 payno     (1000) payno     (1000)    19114 2024-04-15 09:19:34.000000 darfix-1.0.1rc1/src/darfix/core/mapping.py
--rw-r--r--   0 payno     (1000) payno     (1000)    17222 2024-02-13 08:51:56.000000 darfix-1.0.1rc1/src/darfix/core/process.py
--rw-r--r--   0 payno     (1000) payno     (1000)     3234 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/core/roi.py
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.568047 darfix-1.0.1rc1/src/darfix/core/test/
--rw-r--r--   0 payno     (1000) payno     (1000)        0 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/core/test/__init__.py
--rw-r--r--   0 payno     (1000) payno     (1000)     2677 2024-03-20 10:11:33.000000 darfix-1.0.1rc1/src/darfix/core/test/test_components_matching.py
--rw-r--r--   0 payno     (1000) payno     (1000)     1104 2024-02-13 08:51:56.000000 darfix-1.0.1rc1/src/darfix/core/test/test_data_selection.py
--rw-r--r--   0 payno     (1000) payno     (1000)    32117 2024-04-15 09:19:34.000000 darfix-1.0.1rc1/src/darfix/core/test/test_dataset.py
--rw-r--r--   0 payno     (1000) payno     (1000)    15661 2024-03-20 10:11:33.000000 darfix-1.0.1rc1/src/darfix/core/test/test_dimension.py
--rw-r--r--   0 payno     (1000) payno     (1000)     4119 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/core/test/test_ga.py
--rw-r--r--   0 payno     (1000) payno     (1000)     7140 2024-03-20 10:11:33.000000 darfix-1.0.1rc1/src/darfix/core/test/test_image_operations.py
--rw-r--r--   0 payno     (1000) payno     (1000)    15939 2024-03-20 10:11:33.000000 darfix-1.0.1rc1/src/darfix/core/test/test_image_registration.py
--rw-r--r--   0 payno     (1000) payno     (1000)     5153 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/core/test/test_mapping.py
--rw-r--r--   0 payno     (1000) payno     (1000)     3500 2024-03-20 10:11:33.000000 darfix-1.0.1rc1/src/darfix/core/test/test_roi.py
--rw-r--r--   0 payno     (1000) payno     (1000)     3550 2024-03-20 10:11:33.000000 darfix-1.0.1rc1/src/darfix/core/test/test_workflow.py
--rw-r--r--   0 payno     (1000) payno     (1000)      950 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/core/utils.py
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.572047 darfix-1.0.1rc1/src/darfix/decomposition/
--rw-r--r--   0 payno     (1000) payno     (1000)       73 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/decomposition/__init__.py
--rw-r--r--   0 payno     (1000) payno     (1000)     6589 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/decomposition/base.py
--rw-r--r--   0 payno     (1000) payno     (1000)    10875 2024-04-15 09:19:34.000000 darfix-1.0.1rc1/src/darfix/decomposition/ipca.py
--rw-r--r--   0 payno     (1000) payno     (1000)     3997 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/decomposition/nica.py
--rw-r--r--   0 payno     (1000) payno     (1000)     4463 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/decomposition/nmf.py
--rw-r--r--   0 payno     (1000) payno     (1000)     3540 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/decomposition/pca.py
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.572047 darfix-1.0.1rc1/src/darfix/decomposition/test/
--rw-r--r--   0 payno     (1000) payno     (1000)       73 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/decomposition/test/__init__.py
--rw-r--r--   0 payno     (1000) payno     (1000)     1792 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/decomposition/test/test_base.py
--rw-r--r--   0 payno     (1000) payno     (1000)     3449 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/decomposition/test/test_ipca.py
--rw-r--r--   0 payno     (1000) payno     (1000)     4709 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/decomposition/test/test_nica.py
--rw-r--r--   0 payno     (1000) payno     (1000)     1396 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/decomposition/test/test_nmf.py
--rw-r--r--   0 payno     (1000) payno     (1000)     1497 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/decomposition/test/utils.py
--rw-r--r--   0 payno     (1000) payno     (1000)     1494 2024-03-20 10:11:33.000000 darfix-1.0.1rc1/src/darfix/dtypes.py
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.572047 darfix-1.0.1rc1/src/darfix/gui/
--rw-r--r--   0 payno     (1000) payno     (1000)     1886 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/gui/PCAWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)       73 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/gui/__init__.py
--rw-r--r--   0 payno     (1000) payno     (1000)     5275 2024-03-20 10:11:33.000000 darfix-1.0.1rc1/src/darfix/gui/binningWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)     7057 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/gui/blindSourceSeparationWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)     6123 2024-03-20 10:11:33.000000 darfix-1.0.1rc1/src/darfix/gui/dataPartitionWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)    14268 2024-04-15 09:53:18.000000 darfix-1.0.1rc1/src/darfix/gui/datasetSelectionWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)    25221 2024-04-15 09:19:34.000000 darfix-1.0.1rc1/src/darfix/gui/dimensionsWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)    13147 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/gui/displayComponentsWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)    19805 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/gui/grainPlotWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)     2018 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/gui/lineProfileWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)     7928 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/gui/linkComponentsWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)     6617 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/gui/magnificationWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)     3410 2024-04-15 09:53:18.000000 darfix-1.0.1rc1/src/darfix/gui/metadataWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)    21925 2024-04-15 09:19:34.000000 darfix-1.0.1rc1/src/darfix/gui/noiseRemovalWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)      716 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/gui/operationThread.py
--rw-r--r--   0 payno     (1000) payno     (1000)     4105 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/gui/projectionWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)    22733 2024-03-20 10:11:34.000000 darfix-1.0.1rc1/src/darfix/gui/rockingCurvesWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)     3527 2024-03-20 10:11:34.000000 darfix-1.0.1rc1/src/darfix/gui/roiLimitsToolbar.py
--rw-r--r--   0 payno     (1000) payno     (1000)     9458 2024-03-20 10:11:34.000000 darfix-1.0.1rc1/src/darfix/gui/roiSelectionWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)    10021 2024-03-20 10:11:34.000000 darfix-1.0.1rc1/src/darfix/gui/rsmHistogramWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)     2610 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/gui/rsmWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)    13880 2024-03-20 10:11:34.000000 darfix-1.0.1rc1/src/darfix/gui/shiftCorrectionWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)     1707 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/gui/showStackWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)     6627 2024-03-20 10:11:34.000000 darfix-1.0.1rc1/src/darfix/gui/utils.py
--rw-r--r--   0 payno     (1000) payno     (1000)     3869 2024-03-20 10:11:34.000000 darfix-1.0.1rc1/src/darfix/gui/weakBeamWidget.py
--rw-r--r--   0 payno     (1000) payno     (1000)     2449 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/gui/zSumWidget.py
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.572047 darfix-1.0.1rc1/src/darfix/io/
--rw-r--r--   0 payno     (1000) payno     (1000)        0 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/io/__init__.py
--rw-r--r--   0 payno     (1000) payno     (1000)     2284 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/io/dataset_io.py
--rw-r--r--   0 payno     (1000) payno     (1000)       64 2024-02-13 08:51:56.000000 darfix-1.0.1rc1/src/darfix/io/hdf5.py
--rw-r--r--   0 payno     (1000) payno     (1000)    10758 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/io/utils.py
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.572047 darfix-1.0.1rc1/src/darfix/resources/
--rw-r--r--   0 payno     (1000) payno     (1000)        0 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/resources/__init__.py
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.572047 darfix-1.0.1rc1/src/darfix/resources/gui/
--rw-r--r--   0 payno     (1000) payno     (1000)        0 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/resources/gui/__init__.py
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.572047 darfix-1.0.1rc1/src/darfix/resources/gui/icons/
--rw-r--r--   0 payno     (1000) payno     (1000)        0 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/resources/gui/icons/__init__.py
--rw-r--r--   0 payno     (1000) payno     (1000)     1363 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/resources/gui/icons/curves.png
--rw-r--r--   0 payno     (1000) payno     (1000)     6830 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/resources/gui/icons/curves.svg
--rw-r--r--   0 payno     (1000) payno     (1000)     2555 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/resources/gui/icons/resize.png
--rw-r--r--   0 payno     (1000) payno     (1000)     8233 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/resources/gui/icons/resize.svg
--rw-r--r--   0 payno     (1000) payno     (1000)     1068 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/resources/gui/icons/scatter.png
--rw-r--r--   0 payno     (1000) payno     (1000)    20421 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/resources/gui/icons/scatter.svg
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.572047 darfix-1.0.1rc1/src/darfix/test/
--rw-r--r--   0 payno     (1000) payno     (1000)        0 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/darfix/test/__init__.py
--rw-r--r--   0 payno     (1000) payno     (1000)     1159 2024-02-13 15:27:02.000000 darfix-1.0.1rc1/src/darfix/test/conftest.py
--rw-r--r--   0 payno     (1000) payno     (1000)     8871 2024-03-20 10:11:34.000000 darfix-1.0.1rc1/src/darfix/test/utils.py
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.584047 darfix-1.0.1rc1/src/darfix.egg-info/
--rw-r--r--   0 payno     (1000) payno     (1000)     5255 2024-04-15 12:10:19.000000 darfix-1.0.1rc1/src/darfix.egg-info/PKG-INFO
--rw-r--r--   0 payno     (1000) payno     (1000)     6816 2024-04-15 12:10:20.000000 darfix-1.0.1rc1/src/darfix.egg-info/SOURCES.txt
--rw-r--r--   0 payno     (1000) payno     (1000)        1 2024-04-15 12:10:19.000000 darfix-1.0.1rc1/src/darfix.egg-info/dependency_links.txt
--rw-r--r--   0 payno     (1000) payno     (1000)      293 2024-04-15 12:10:19.000000 darfix-1.0.1rc1/src/darfix.egg-info/entry_points.txt
--rw-r--r--   0 payno     (1000) payno     (1000)     1497 2024-04-15 12:10:19.000000 darfix-1.0.1rc1/src/darfix.egg-info/requires.txt
--rw-r--r--   0 payno     (1000) payno     (1000)       30 2024-04-15 12:10:19.000000 darfix-1.0.1rc1/src/darfix.egg-info/top_level.txt
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.568047 darfix-1.0.1rc1/src/orangecontrib/
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.572047 darfix-1.0.1rc1/src/orangecontrib/darfix/
--rw-r--r--   0 payno     (1000) payno     (1000)        0 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/__init__.py
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.572047 darfix-1.0.1rc1/src/orangecontrib/darfix/test/
--rw-r--r--   0 payno     (1000) payno     (1000)      482 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/test/__init__.py
--rw-r--r--   0 payno     (1000) payno     (1000)     1782 2024-04-15 09:19:34.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/test/test_ewoks.py
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.576047 darfix-1.0.1rc1/src/orangecontrib/darfix/tutorials/
--rw-r--r--   0 payno     (1000) payno     (1000)        0 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/tutorials/__init__.py
--rw-r--r--   0 payno     (1000) payno     (1000)     7661 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/tutorials/darfix_example1.ows
--rw-r--r--   0 payno     (1000) payno     (1000)     5116 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/tutorials/darfix_example2.ows
--rw-r--r--   0 payno     (1000) payno     (1000)  8391680 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/tutorials/strain_0000.edf
--rw-r--r--   0 payno     (1000) payno     (1000)  8403250 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/tutorials/strain_0001.edf
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.584047 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/
--rw-r--r--   0 payno     (1000) payno     (1000)     1133 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/__init__.py
--rw-r--r--   0 payno     (1000) payno     (1000)     1920 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/binning.py
--rw-r--r--   0 payno     (1000) payno     (1000)     2182 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/blindsourceseparation.py
--rw-r--r--   0 payno     (1000) payno     (1000)     1462 2024-03-20 10:11:34.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/datacopy.py
--rw-r--r--   0 payno     (1000) payno     (1000)     2145 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/datapartition.py
--rw-r--r--   0 payno     (1000) payno     (1000)     4491 2024-04-15 09:19:34.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/dataselection.py
--rw-r--r--   0 payno     (1000) payno     (1000)     4075 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/dimensions.py
--rw-r--r--   0 payno     (1000) payno     (1000)     1425 2024-03-20 10:11:34.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/flash.py
--rw-r--r--   0 payno     (1000) payno     (1000)     1390 2024-03-20 10:11:34.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/grainplot.py
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.584047 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/
--rw-r--r--   0 payno     (1000) payno     (1000)        0 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/__init__.py
--rw-r--r--   0 payno     (1000) payno     (1000)     1599 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/axes.png
--rw-r--r--   0 payno     (1000) payno     (1000)     5038 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/axes.svg
--rw-r--r--   0 payno     (1000) payno     (1000)     3212 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/bss.png
--rw-r--r--   0 payno     (1000) payno     (1000)     4986 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/bss.svg
--rw-r--r--   0 payno     (1000) payno     (1000)      506 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/category.svg
--rw-r--r--   0 payno     (1000) payno     (1000)     8068 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/copy.svg
--rw-r--r--   0 payno     (1000) payno     (1000)      912 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/curves.png
--rw-r--r--   0 payno     (1000) payno     (1000)    51435 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/curves.svg
--rw-r--r--   0 payno     (1000) payno     (1000)   233309 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/darfix_icon.png
--rw-r--r--   0 payno     (1000) payno     (1000)    35611 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/darfix_icon.svg
--rw-r--r--   0 payno     (1000) payno     (1000)   236860 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/darfix_icon8.png
--rw-r--r--   0 payno     (1000) payno     (1000)      621 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/filter.png
--rw-r--r--   0 payno     (1000) payno     (1000)     2253 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/filter.svg
--rw-r--r--   0 payno     (1000) payno     (1000)     2709 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/flash.svg
--rw-r--r--   0 payno     (1000) payno     (1000)     4286 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/gaussian.png
--rw-r--r--   0 payno     (1000) payno     (1000)    10053 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/gaussian.svg
--rw-r--r--   0 payno     (1000) payno     (1000)    22180 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/grainplot.png
--rw-r--r--   0 payno     (1000) payno     (1000)  2409867 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/grainplot.svg
--rw-r--r--   0 payno     (1000) payno     (1000)    64642 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/image-select-box.svg
--rw-r--r--   0 payno     (1000) payno     (1000)    16836 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/line_profile.png
--rw-r--r--   0 payno     (1000) payno     (1000)   132131 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/line_profile.svg
--rw-r--r--   0 payno     (1000) payno     (1000)     9458 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/link.png
--rw-r--r--   0 payno     (1000) payno     (1000)     2431 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/link.svg
--rw-r--r--   0 payno     (1000) payno     (1000)      593 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/metadata.png
--rw-r--r--   0 payno     (1000) payno     (1000)     3126 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/metadata.svg
--rw-r--r--   0 payno     (1000) payno     (1000)      631 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/mywidget.svg
--rw-r--r--   0 payno     (1000) payno     (1000)     6218 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/noise_removal.png
--rw-r--r--   0 payno     (1000) payno     (1000)     4375 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/noise_removal.svg
--rw-r--r--   0 payno     (1000) payno     (1000)     6897 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/noise_removal_backup.svg
--rw-r--r--   0 payno     (1000) payno     (1000)     3583 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/param_dims.png
--rw-r--r--   0 payno     (1000) payno     (1000)     9708 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/param_dims.svg
--rw-r--r--   0 payno     (1000) payno     (1000)     4325 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/pca.png
--rw-r--r--   0 payno     (1000) payno     (1000)    21388 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/pca.svg
--rw-r--r--   0 payno     (1000) payno     (1000)     2140 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/random.svg
--rw-r--r--   0 payno     (1000) payno     (1000)      857 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/resize.png
--rw-r--r--   0 payno     (1000) payno     (1000)     6668 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/roi.png
--rw-r--r--   0 payno     (1000) payno     (1000)    66544 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/roi.svg
--rw-r--r--   0 payno     (1000) payno     (1000)     3260 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/save.svg
--rw-r--r--   0 payno     (1000) payno     (1000)     8108 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/shift_correction.svg
--rw-r--r--   0 payno     (1000) payno     (1000)     4978 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/upload.svg
--rw-r--r--   0 payno     (1000) payno     (1000)     2853 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/zsum.svg
--rw-r--r--   0 payno     (1000) payno     (1000)      554 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/lineprofile.py
--rw-r--r--   0 payno     (1000) payno     (1000)      561 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/linkcomponents.py
--rw-r--r--   0 payno     (1000) payno     (1000)     1014 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/metadata.py
--rw-r--r--   0 payno     (1000) payno     (1000)     3887 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/noiseremoval.py
--rw-r--r--   0 payno     (1000) payno     (1000)     1294 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/pca.py
--rw-r--r--   0 payno     (1000) payno     (1000)     1987 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/projection.py
--rw-r--r--   0 payno     (1000) payno     (1000)     1523 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/rockingcurves.py
--rw-r--r--   0 payno     (1000) payno     (1000)     2655 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/roiselection.py
--rw-r--r--   0 payno     (1000) payno     (1000)     2715 2024-03-20 10:11:34.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/rsmhistogram.py
--rw-r--r--   0 payno     (1000) payno     (1000)     2469 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/shiftcorrection.py
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.584047 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/test/
--rw-r--r--   0 payno     (1000) payno     (1000)     1279 2024-03-20 10:11:34.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/test/test_data_selection.py
--rw-r--r--   0 payno     (1000) payno     (1000)     5740 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/transformation.py
--rw-r--r--   0 payno     (1000) payno     (1000)     1942 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/weakbeam.py
--rw-r--r--   0 payno     (1000) payno     (1000)     1172 2024-01-26 09:09:46.000000 darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/zsum.py
-drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-04-15 12:10:21.584047 darfix-1.0.1rc1/src/snippets/
--rw-r--r--   0 payno     (1000) payno     (1000)     1691 2024-02-13 12:43:36.000000 darfix-1.0.1rc1/src/snippets/convert_edf_to_hdf5.py
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.367415 darfix-1.0.2/
+-rw-r--r--   0 payno     (1000) payno     (1000)     1110 2024-01-26 09:09:46.000000 darfix-1.0.2/LICENSE
+-rw-r--r--   0 payno     (1000) payno     (1000)     5634 2024-05-14 08:42:01.367415 darfix-1.0.2/PKG-INFO
+-rw-r--r--   0 payno     (1000) payno     (1000)     2778 2024-04-15 09:19:34.000000 darfix-1.0.2/README.rst
+-rw-r--r--   0 payno     (1000) payno     (1000)      302 2024-04-15 09:19:34.000000 darfix-1.0.2/pyproject.toml
+-rw-r--r--   0 payno     (1000) payno     (1000)     2171 2024-05-14 08:42:01.367415 darfix-1.0.2/setup.cfg
+-rw-r--r--   0 payno     (1000) payno     (1000)       69 2024-01-26 09:09:46.000000 darfix-1.0.2/setup.py
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.343415 darfix-1.0.2/src/
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.343415 darfix-1.0.2/src/darfix/
+-rw-r--r--   0 payno     (1000) payno     (1000)      543 2024-05-14 08:41:18.000000 darfix-1.0.2/src/darfix/__init__.py
+-rw-r--r--   0 payno     (1000) payno     (1000)      646 2024-04-17 11:43:47.000000 darfix-1.0.2/src/darfix/_config.py
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.343415 darfix-1.0.2/src/darfix/app/
+-rw-r--r--   0 payno     (1000) payno     (1000)        0 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/app/__init__.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     2946 2024-05-13 09:37:33.000000 darfix-1.0.2/src/darfix/app/__main__.py
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.343415 darfix-1.0.2/src/darfix/core/
+-rw-r--r--   0 payno     (1000) payno     (1000)       73 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/core/__init__.py
+-rw-r--r--   0 payno     (1000) payno     (1000)      898 2024-05-13 09:37:33.000000 darfix-1.0.2/src/darfix/core/array_utils.py
+-rw-r--r--   0 payno     (1000) payno     (1000)      344 2024-04-15 09:19:34.000000 darfix-1.0.2/src/darfix/core/autofocus.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     9947 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/core/componentsMatching.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     3857 2024-05-14 07:52:05.000000 darfix-1.0.2/src/darfix/core/data_selection.py
+-rw-r--r--   0 payno     (1000) payno     (1000)   105337 2024-05-13 12:43:02.000000 darfix-1.0.2/src/darfix/core/dataset.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     9245 2024-05-13 09:37:33.000000 darfix-1.0.2/src/darfix/core/dimension.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     7361 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/core/geneticShiftDetection.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     6945 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/core/imageOperations.py
+-rw-r--r--   0 payno     (1000) payno     (1000)    12049 2024-04-15 09:19:34.000000 darfix-1.0.2/src/darfix/core/imageRegistration.py
+-rw-r--r--   0 payno     (1000) payno     (1000)    19114 2024-04-15 09:19:34.000000 darfix-1.0.2/src/darfix/core/mapping.py
+-rw-r--r--   0 payno     (1000) payno     (1000)    17976 2024-05-14 07:52:05.000000 darfix-1.0.2/src/darfix/core/process.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     3234 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/core/roi.py
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.347415 darfix-1.0.2/src/darfix/core/test/
+-rw-r--r--   0 payno     (1000) payno     (1000)        0 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/core/test/__init__.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     2677 2024-03-20 10:11:33.000000 darfix-1.0.2/src/darfix/core/test/test_components_matching.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     1104 2024-02-13 08:51:56.000000 darfix-1.0.2/src/darfix/core/test/test_data_selection.py
+-rw-r--r--   0 payno     (1000) payno     (1000)    32117 2024-04-15 09:19:34.000000 darfix-1.0.2/src/darfix/core/test/test_dataset.py
+-rw-r--r--   0 payno     (1000) payno     (1000)    15661 2024-03-20 10:11:33.000000 darfix-1.0.2/src/darfix/core/test/test_dimension.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     4119 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/core/test/test_ga.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     7140 2024-03-20 10:11:33.000000 darfix-1.0.2/src/darfix/core/test/test_image_operations.py
+-rw-r--r--   0 payno     (1000) payno     (1000)    15939 2024-03-20 10:11:33.000000 darfix-1.0.2/src/darfix/core/test/test_image_registration.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     5153 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/core/test/test_mapping.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     3500 2024-03-20 10:11:33.000000 darfix-1.0.2/src/darfix/core/test/test_roi.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     3550 2024-03-20 10:11:33.000000 darfix-1.0.2/src/darfix/core/test/test_workflow.py
+-rw-r--r--   0 payno     (1000) payno     (1000)      950 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/core/utils.py
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.347415 darfix-1.0.2/src/darfix/decomposition/
+-rw-r--r--   0 payno     (1000) payno     (1000)       73 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/decomposition/__init__.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     6589 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/decomposition/base.py
+-rw-r--r--   0 payno     (1000) payno     (1000)    10875 2024-04-15 09:19:34.000000 darfix-1.0.2/src/darfix/decomposition/ipca.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     3997 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/decomposition/nica.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     4463 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/decomposition/nmf.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     3540 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/decomposition/pca.py
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.347415 darfix-1.0.2/src/darfix/decomposition/test/
+-rw-r--r--   0 payno     (1000) payno     (1000)       73 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/decomposition/test/__init__.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     1792 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/decomposition/test/test_base.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     3449 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/decomposition/test/test_ipca.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     4709 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/decomposition/test/test_nica.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     1396 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/decomposition/test/test_nmf.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     1497 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/decomposition/test/utils.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     1494 2024-04-26 13:08:25.000000 darfix-1.0.2/src/darfix/dtypes.py
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.347415 darfix-1.0.2/src/darfix/gui/
+-rw-r--r--   0 payno     (1000) payno     (1000)     1886 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/gui/PCAWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)       73 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/gui/__init__.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     5275 2024-04-26 13:08:25.000000 darfix-1.0.2/src/darfix/gui/binningWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     7057 2024-04-26 13:08:25.000000 darfix-1.0.2/src/darfix/gui/blindSourceSeparationWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     6123 2024-04-26 13:08:25.000000 darfix-1.0.2/src/darfix/gui/dataPartitionWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)    14517 2024-05-13 09:37:33.000000 darfix-1.0.2/src/darfix/gui/datasetSelectionWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)    24450 2024-05-13 09:37:33.000000 darfix-1.0.2/src/darfix/gui/dimensionsWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)    13147 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/gui/displayComponentsWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)    19805 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/gui/grainPlotWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     2018 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/gui/lineProfileWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     7928 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/gui/linkComponentsWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     6617 2024-04-26 13:08:25.000000 darfix-1.0.2/src/darfix/gui/magnificationWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     3410 2024-04-15 09:53:18.000000 darfix-1.0.2/src/darfix/gui/metadataWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)    21925 2024-04-26 13:08:25.000000 darfix-1.0.2/src/darfix/gui/noiseRemovalWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)      716 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/gui/operationThread.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     4105 2024-04-26 13:08:25.000000 darfix-1.0.2/src/darfix/gui/projectionWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)    22733 2024-03-20 10:11:34.000000 darfix-1.0.2/src/darfix/gui/rockingCurvesWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     3527 2024-03-20 10:11:34.000000 darfix-1.0.2/src/darfix/gui/roiLimitsToolbar.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     9458 2024-04-26 13:08:25.000000 darfix-1.0.2/src/darfix/gui/roiSelectionWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)    10021 2024-03-20 10:11:34.000000 darfix-1.0.2/src/darfix/gui/rsmHistogramWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     2610 2024-04-26 13:08:25.000000 darfix-1.0.2/src/darfix/gui/rsmWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)    13880 2024-04-26 13:08:25.000000 darfix-1.0.2/src/darfix/gui/shiftCorrectionWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     1707 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/gui/showStackWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     6627 2024-03-20 10:11:34.000000 darfix-1.0.2/src/darfix/gui/utils.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     3869 2024-04-26 13:08:25.000000 darfix-1.0.2/src/darfix/gui/weakBeamWidget.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     2449 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/gui/zSumWidget.py
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.347415 darfix-1.0.2/src/darfix/io/
+-rw-r--r--   0 payno     (1000) payno     (1000)        0 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/io/__init__.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     2284 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/io/dataset_io.py
+-rw-r--r--   0 payno     (1000) payno     (1000)      400 2024-05-13 14:33:07.000000 darfix-1.0.2/src/darfix/io/hdf5.py
+-rw-r--r--   0 payno     (1000) payno     (1000)    10787 2024-05-14 07:52:05.000000 darfix-1.0.2/src/darfix/io/utils.py
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.347415 darfix-1.0.2/src/darfix/resources/
+-rw-r--r--   0 payno     (1000) payno     (1000)        0 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/resources/__init__.py
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.347415 darfix-1.0.2/src/darfix/resources/gui/
+-rw-r--r--   0 payno     (1000) payno     (1000)        0 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/resources/gui/__init__.py
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.347415 darfix-1.0.2/src/darfix/resources/gui/icons/
+-rw-r--r--   0 payno     (1000) payno     (1000)        0 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/resources/gui/icons/__init__.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     1363 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/resources/gui/icons/curves.png
+-rw-r--r--   0 payno     (1000) payno     (1000)     6830 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/resources/gui/icons/curves.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)     2555 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/resources/gui/icons/resize.png
+-rw-r--r--   0 payno     (1000) payno     (1000)     8233 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/resources/gui/icons/resize.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)     1068 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/resources/gui/icons/scatter.png
+-rw-r--r--   0 payno     (1000) payno     (1000)    20421 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/resources/gui/icons/scatter.svg
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.347415 darfix-1.0.2/src/darfix/test/
+-rw-r--r--   0 payno     (1000) payno     (1000)        0 2024-01-26 09:09:46.000000 darfix-1.0.2/src/darfix/test/__init__.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     1159 2024-02-13 15:27:02.000000 darfix-1.0.2/src/darfix/test/conftest.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     1246 2024-05-13 09:37:33.000000 darfix-1.0.2/src/darfix/test/test_array_utils.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     8871 2024-03-20 10:11:34.000000 darfix-1.0.2/src/darfix/test/utils.py
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.363415 darfix-1.0.2/src/darfix.egg-info/
+-rw-r--r--   0 payno     (1000) payno     (1000)     5634 2024-05-14 08:41:58.000000 darfix-1.0.2/src/darfix.egg-info/PKG-INFO
+-rw-r--r--   0 payno     (1000) payno     (1000)     7033 2024-05-14 08:41:58.000000 darfix-1.0.2/src/darfix.egg-info/SOURCES.txt
+-rw-r--r--   0 payno     (1000) payno     (1000)        1 2024-05-14 08:41:58.000000 darfix-1.0.2/src/darfix.egg-info/dependency_links.txt
+-rw-r--r--   0 payno     (1000) payno     (1000)      293 2024-05-14 08:41:58.000000 darfix-1.0.2/src/darfix.egg-info/entry_points.txt
+-rw-r--r--   0 payno     (1000) payno     (1000)     1569 2024-05-14 08:41:58.000000 darfix-1.0.2/src/darfix.egg-info/requires.txt
+-rw-r--r--   0 payno     (1000) payno     (1000)       30 2024-05-14 08:41:58.000000 darfix-1.0.2/src/darfix.egg-info/top_level.txt
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.343415 darfix-1.0.2/src/orangecontrib/
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.347415 darfix-1.0.2/src/orangecontrib/darfix/
+-rw-r--r--   0 payno     (1000) payno     (1000)        0 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/__init__.py
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.347415 darfix-1.0.2/src/orangecontrib/darfix/test/
+-rw-r--r--   0 payno     (1000) payno     (1000)      482 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/test/__init__.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     2989 2024-05-14 07:52:05.000000 darfix-1.0.2/src/orangecontrib/darfix/test/test_ewoks.py
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.347415 darfix-1.0.2/src/orangecontrib/darfix/tutorials/
+-rw-r--r--   0 payno     (1000) payno     (1000)        0 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/tutorials/__init__.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     7661 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/tutorials/darfix_example1.ows
+-rw-r--r--   0 payno     (1000) payno     (1000)     5116 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/tutorials/darfix_example2.ows
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.351415 darfix-1.0.2/src/orangecontrib/darfix/tutorials/edf_dataset/
+-rw-r--r--   0 payno     (1000) payno     (1000)  8391680 2024-05-14 07:52:05.000000 darfix-1.0.2/src/orangecontrib/darfix/tutorials/edf_dataset/strain_0000.edf
+-rw-r--r--   0 payno     (1000) payno     (1000)  8403250 2024-05-14 07:52:05.000000 darfix-1.0.2/src/orangecontrib/darfix/tutorials/edf_dataset/strain_0001.edf
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.355415 darfix-1.0.2/src/orangecontrib/darfix/tutorials/hdf5_dataset/
+-rw-r--r--   0 payno     (1000) payno     (1000)  1086664 2024-05-14 07:52:05.000000 darfix-1.0.2/src/orangecontrib/darfix/tutorials/hdf5_dataset/strain.hdf5
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.355415 darfix-1.0.2/src/orangecontrib/darfix/tutorials/hdf5_dataset/treated/
+-rw-r--r--   0 payno     (1000) payno     (1000)  4002048 2024-05-14 06:59:53.000000 darfix-1.0.2/src/orangecontrib/darfix/tutorials/hdf5_dataset/treated/data.hdf5
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.359415 darfix-1.0.2/src/orangecontrib/darfix/widgets/
+-rw-r--r--   0 payno     (1000) payno     (1000)     1133 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/__init__.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     1920 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/binning.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     2182 2024-04-26 13:08:25.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/blindsourceseparation.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     1462 2024-03-20 10:11:34.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/datacopy.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     2145 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/datapartition.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     4259 2024-05-13 09:37:33.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/dataselection.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     4075 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/dimensions.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     1425 2024-03-20 10:11:34.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/flash.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     1390 2024-03-20 10:11:34.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/grainplot.py
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.363415 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/
+-rw-r--r--   0 payno     (1000) payno     (1000)        0 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/__init__.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     1599 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/axes.png
+-rw-r--r--   0 payno     (1000) payno     (1000)     5038 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/axes.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)     3212 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/bss.png
+-rw-r--r--   0 payno     (1000) payno     (1000)     4986 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/bss.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)      506 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/category.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)     8068 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/copy.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)      912 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/curves.png
+-rw-r--r--   0 payno     (1000) payno     (1000)    51435 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/curves.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)   233309 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/darfix_icon.png
+-rw-r--r--   0 payno     (1000) payno     (1000)    35611 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/darfix_icon.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)   236860 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/darfix_icon8.png
+-rw-r--r--   0 payno     (1000) payno     (1000)      621 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/filter.png
+-rw-r--r--   0 payno     (1000) payno     (1000)     2253 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/filter.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)     2709 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/flash.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)     4286 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/gaussian.png
+-rw-r--r--   0 payno     (1000) payno     (1000)    10053 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/gaussian.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)    22180 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/grainplot.png
+-rw-r--r--   0 payno     (1000) payno     (1000)  2409867 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/grainplot.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)    64642 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/image-select-box.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)    16836 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/line_profile.png
+-rw-r--r--   0 payno     (1000) payno     (1000)   132131 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/line_profile.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)     9458 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/link.png
+-rw-r--r--   0 payno     (1000) payno     (1000)     2431 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/link.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)      593 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/metadata.png
+-rw-r--r--   0 payno     (1000) payno     (1000)     3126 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/metadata.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)      631 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/mywidget.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)     6218 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/noise_removal.png
+-rw-r--r--   0 payno     (1000) payno     (1000)     4375 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/noise_removal.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)     6897 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/noise_removal_backup.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)     3583 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/param_dims.png
+-rw-r--r--   0 payno     (1000) payno     (1000)     9708 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/param_dims.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)     4325 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/pca.png
+-rw-r--r--   0 payno     (1000) payno     (1000)    21388 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/pca.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)     2140 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/random.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)      857 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/resize.png
+-rw-r--r--   0 payno     (1000) payno     (1000)     6668 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/roi.png
+-rw-r--r--   0 payno     (1000) payno     (1000)    66544 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/roi.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)     3260 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/save.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)     8108 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/shift_correction.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)     4978 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/upload.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)     2853 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/zsum.svg
+-rw-r--r--   0 payno     (1000) payno     (1000)      554 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/lineprofile.py
+-rw-r--r--   0 payno     (1000) payno     (1000)      561 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/linkcomponents.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     1014 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/metadata.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     3887 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/noiseremoval.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     1294 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/pca.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     1987 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/projection.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     1523 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/rockingcurves.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     2655 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/roiselection.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     2715 2024-03-20 10:11:34.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/rsmhistogram.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     2469 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/shiftcorrection.py
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.363415 darfix-1.0.2/src/orangecontrib/darfix/widgets/test/
+-rw-r--r--   0 payno     (1000) payno     (1000)     1279 2024-03-20 10:11:34.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/test/test_data_selection.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     5740 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/transformation.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     1942 2024-01-26 09:09:46.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/weakbeam.py
+-rw-r--r--   0 payno     (1000) payno     (1000)     1172 2024-04-26 13:08:25.000000 darfix-1.0.2/src/orangecontrib/darfix/widgets/zsum.py
+drwxr-xr-x   0 payno     (1000) payno     (1000)        0 2024-05-14 08:42:01.363415 darfix-1.0.2/src/snippets/
+-rw-r--r--   0 payno     (1000) payno     (1000)     1691 2024-02-13 12:43:36.000000 darfix-1.0.2/src/snippets/convert_edf_to_hdf5.py
```

### Comparing `darfix-1.0.1rc1/LICENSE` & `darfix-1.0.2/LICENSE`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/PKG-INFO` & `darfix-1.0.2/PKG-INFO`

 * *Files 6% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: darfix
-Version: 1.0.1rc1
+Version: 1.0.2
 Summary: Computer vision software for the interpretation of diffraction images
 Home-page: https://gitlab.esrf.fr/XRD/darfix
 Author: J.Garriga
 Author-email: julia.garriga@esrf.fr
 License: MIT
 Project-URL: Source, https://gitlab.esrf.fr/XRD/darfix/
 Project-URL: Documentation, http://www.edna-site.org/pub/doc/darfix/latest
@@ -31,28 +31,30 @@
 Requires-Dist: scikit-learn; extra == "full"
 Requires-Dist: PyQt5; extra == "full"
 Requires-Dist: ewoksorange>=0.1.0; extra == "full"
 Requires-Dist: orange3; extra == "full"
 Requires-Dist: orange3<=3.32.0; python_version < "3.8" and extra == "full"
 Requires-Dist: orange3<=3.30.1; python_version < "3.7" and extra == "full"
 Requires-Dist: openTSNE<=0.6.1; python_version < "3.7" and extra == "full"
+Requires-Dist: bottleneck<=1.3.8; python_version < "3.7" and extra == "full"
 Requires-Dist: tqdm; extra == "full"
 Requires-Dist: hdf5plugin; extra == "full"
 Provides-Extra: test
 Requires-Dist: matplotlib>=1.2.0; extra == "test"
 Requires-Dist: opencv-python-headless<4.7,>=4.3.0.36; extra == "test"
 Requires-Dist: scikit-image>=0.17.1; python_version >= "3.7" and extra == "test"
 Requires-Dist: scikit-image<0.17.1; python_version < "3.7" and extra == "test"
 Requires-Dist: scikit-learn; extra == "test"
 Requires-Dist: PyQt5; extra == "test"
 Requires-Dist: ewoksorange>=0.1.0; extra == "test"
 Requires-Dist: orange3; extra == "test"
 Requires-Dist: orange3<=3.32.0; python_version < "3.8" and extra == "test"
 Requires-Dist: orange3<=3.30.1; python_version < "3.7" and extra == "test"
 Requires-Dist: openTSNE<=0.6.1; python_version < "3.7" and extra == "test"
+Requires-Dist: bottleneck<=1.3.8; python_version < "3.7" and extra == "test"
 Requires-Dist: tqdm; extra == "test"
 Requires-Dist: hdf5plugin; extra == "test"
 Requires-Dist: pytest; extra == "test"
 Provides-Extra: dev
 Requires-Dist: matplotlib>=1.2.0; extra == "dev"
 Requires-Dist: opencv-python-headless<4.7,>=4.3.0.36; extra == "dev"
 Requires-Dist: scikit-image>=0.17.1; python_version >= "3.7" and extra == "dev"
@@ -60,14 +62,15 @@
 Requires-Dist: scikit-learn; extra == "dev"
 Requires-Dist: PyQt5; extra == "dev"
 Requires-Dist: ewoksorange>=0.1.0; extra == "dev"
 Requires-Dist: orange3; extra == "dev"
 Requires-Dist: orange3<=3.32.0; python_version < "3.8" and extra == "dev"
 Requires-Dist: orange3<=3.30.1; python_version < "3.7" and extra == "dev"
 Requires-Dist: openTSNE<=0.6.1; python_version < "3.7" and extra == "dev"
+Requires-Dist: bottleneck<=1.3.8; python_version < "3.7" and extra == "dev"
 Requires-Dist: tqdm; extra == "dev"
 Requires-Dist: hdf5plugin; extra == "dev"
 Requires-Dist: pytest; extra == "dev"
 Requires-Dist: black>=22; extra == "dev"
 Requires-Dist: flake8>=4; extra == "dev"
 Requires-Dist: flake8_nb>=0.3.1; extra == "dev"
 Provides-Extra: doc
@@ -78,28 +81,30 @@
 Requires-Dist: scikit-learn; extra == "doc"
 Requires-Dist: PyQt5; extra == "doc"
 Requires-Dist: ewoksorange>=0.1.0; extra == "doc"
 Requires-Dist: orange3; extra == "doc"
 Requires-Dist: orange3<=3.32.0; python_version < "3.8" and extra == "doc"
 Requires-Dist: orange3<=3.30.1; python_version < "3.7" and extra == "doc"
 Requires-Dist: openTSNE<=0.6.1; python_version < "3.7" and extra == "doc"
+Requires-Dist: bottleneck<=1.3.8; python_version < "3.7" and extra == "doc"
 Requires-Dist: tqdm; extra == "doc"
 Requires-Dist: hdf5plugin; extra == "doc"
 Requires-Dist: pytest; extra == "doc"
 Requires-Dist: matplotlib>=1.2.0; extra == "doc"
 Requires-Dist: opencv-python-headless<4.7,>=4.3.0.36; extra == "doc"
 Requires-Dist: scikit-image>=0.17.1; python_version >= "3.7" and extra == "doc"
 Requires-Dist: scikit-image<0.17.1; python_version < "3.7" and extra == "doc"
 Requires-Dist: scikit-learn; extra == "doc"
 Requires-Dist: PyQt5; extra == "doc"
 Requires-Dist: ewoksorange>=0.1.0; extra == "doc"
 Requires-Dist: orange3; extra == "doc"
 Requires-Dist: orange3<=3.32.0; python_version < "3.8" and extra == "doc"
 Requires-Dist: orange3<=3.30.1; python_version < "3.7" and extra == "doc"
 Requires-Dist: openTSNE<=0.6.1; python_version < "3.7" and extra == "doc"
+Requires-Dist: bottleneck<=1.3.8; python_version < "3.7" and extra == "doc"
 Requires-Dist: tqdm; extra == "doc"
 Requires-Dist: hdf5plugin; extra == "doc"
 Requires-Dist: sphinx>=4.5; extra == "doc"
 Requires-Dist: sphinx-autodoc-typehints>=1.16; extra == "doc"
 Requires-Dist: nbsphinx; extra == "doc"
 Requires-Dist: recommonmark; extra == "doc"
 Requires-Dist: pydata_sphinx_theme<0.15; extra == "doc"
```

### Comparing `darfix-1.0.1rc1/README.rst` & `darfix-1.0.2/README.rst`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/setup.cfg` & `darfix-1.0.2/setup.cfg`

 * *Files 6% similar despite different names*

```diff
@@ -45,29 +45,30 @@
 	darfix=orangecontrib.darfix.widgets
 orange.canvas.help = 
 	html-index=orangecontrib.darfix.widgets:WIDGET_HELP_PATH
 ewoks.tasks.class = 
 	darfix.core.process=darfix
 
 [options.package_data]
-* = *.ows, *.png, *.svg, *.edf
+* = *.ows, *.png, *.svg, *.edf, *.hdf5
 
 [options.extras_require]
 full = 
 	matplotlib >=1.2.0
 	opencv-python-headless >=4.3.0.36,<4.7
 	scikit-image>=0.17.1; python_version >= "3.7"
 	scikit-image<0.17.1; python_version < "3.7"
 	scikit-learn
 	PyQt5
 	ewoksorange >=0.1.0
 	orange3
 	orange3<=3.32.0; python_version < "3.8"
 	orange3<=3.30.1; python_version < "3.7"
 	openTSNE<=0.6.1; python_version < "3.7"
+	bottleneck<=1.3.8; python_version < "3.7"
 	tqdm
 	hdf5plugin
 test = 
 	%(full)s
 	pytest
 dev = 
 	%(test)s
```

### Comparing `darfix-1.0.1rc1/src/darfix/__init__.py` & `darfix-1.0.2/src/darfix/__init__.py`

 * *Files 2% similar despite different names*

```diff
@@ -6,13 +6,13 @@
 - silx.io: Functions for input/output operations
 - silx.utils: Miscellaneous convenient functions
 """
 
 __authors__ = ["J. Garriga"]
 __license__ = "MIT"
 __date__ = "16/12/2019"
-__version__ = "1.0.1rc1"
+__version__ = "1.0.2"
 
 from ._config import Config as _Config
 
 config = _Config()
 """Global configuration shared with the whole library"""
```

### Comparing `darfix-1.0.1rc1/src/darfix/_config.py` & `darfix-1.0.2/src/darfix/_config.py`

 * *Files 2% similar despite different names*

```diff
@@ -2,15 +2,15 @@
 """
 
 __authors__ = ["J. Garriga"]
 __license__ = "MIT"
 __date__ = "19/11/2020"
 
 
-class Config(object):
+class Config:
     """
     Class containing shared global configuration for the darfix project.
 
     .. versionadded:: 0.3
     """
 
     DEFAULT_COLORMAP_NAME = "cividis"
```

### Comparing `darfix-1.0.1rc1/src/darfix/app/__main__.py` & `darfix-1.0.2/src/darfix/app/__main__.py`

 * *Files 7% similar despite different names*

```diff
@@ -57,26 +57,30 @@
         type=str,
         default=None,
     )
 
     args, deprecated = parser.parse_known_args(argv[1:])
     if not args.workflow:
         parser.error("Please enter the workflow filename")
-    if not (args.file_directory or args.first_filename):
-        parser.error("Please enter the file directory or first filename")
+    # if not (args.file_directory or args.first_filename):
+    #    parser.error("Please enter the file directory or first filename")
 
-    root_dir = args.file_directory
     if args.first_filename:
         filenames = args.first_filename
-    else:
+    elif args.file_directory:
         filenames = sorted(
-            [x for x in glob.glob(os.path.join(root_dir, "*")) if is_image_file(x)]
+            [
+                x
+                for x in glob.glob(os.path.join(args.file_directory, "*"))
+                if is_image_file(x)
+            ]
         )
-    if args.treated_data:
-        root_dir = args.treated_data
+    else:
+        filenames = None
+
     if "--in-disk" in deprecated:
         print("\nDeprecation warning: use --on-disk instead of --in-disk")
         in_memory = False
     else:
         in_memory = not args.on_disk
     if args.title:
         title = args.title
@@ -86,15 +90,15 @@
     print("\nLoading workflow", repr(args.workflow), "...")
     graph = load_graph(args.workflow)
 
     print("Setting workflow inputs parameters ...")
     graph_data_selection(
         graph=graph,
         filenames=filenames,
-        root_dir=root_dir,
+        root_dir=args.treated_data,
         in_memory=in_memory,
         title=title,
     )
 
     print("Executing workflow ...")
     results = _execute_graph(graph, **extra_options)
     print("Result of workflow '%s':\n%s" % (args.workflow, pformat(results)))
```

### Comparing `darfix-1.0.1rc1/src/darfix/core/componentsMatching.py` & `darfix-1.0.2/src/darfix/core/componentsMatching.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/core/data_selection.py` & `darfix-1.0.2/src/darfix/core/data_selection.py`

 * *Files 10% similar despite different names*

```diff
@@ -20,14 +20,17 @@
     When `filenames` is a string, it will be treated as a file pattern.
 
     :param filenames: filenames to be loaded. If filenames is a str then consider it as a file pattern (for EDF files). If is an iterable consider a list of EDF files. If this is a DataUrl expected it readable by silx get_data function
     :param metadata_url: path to the scan metadata for HDF5 containing positioner information in order to load metadata for non-edf files
     """
     indices = li_indices = None
     root_dir_specified = bool(root_dir)
+    if isinstance(filenames, Iterable) and not isinstance(filenames, str) and isH5:
+        assert len(filenames) == 1
+        filenames = filenames[0]
 
     if isinstance(filenames, DataUrl):
         assert filenames.file_path() not in (
             "",
             None,
         ), "no file_path provided to the DataUrl"
         if not root_dir_specified:
@@ -38,14 +41,16 @@
             in_memory=in_memory,
             copy_files=copy_files,
             isH5=isH5,
             title=title,
             metadata_url=metadata_url,
         )
     elif isinstance(filenames, str):
+        if not filenames:
+            raise ValueError("'filenames' cannot be an empty string")
         if not root_dir_specified:
             root_dir = _get_root_dir(filenames)
         dataset = Dataset(
             _dir=root_dir,
             first_filename=filenames,
             in_memory=in_memory,
             copy_files=copy_files,
@@ -63,17 +68,19 @@
             in_memory=in_memory,
             copy_files=copy_files,
             isH5=isH5,
             title=title,
             metadata_url=metadata_url,
         )
     else:
-        raise TypeError(f"filenames of type {type(filenames)} is not handle")
+        raise TypeError(f"filenames of type {type(filenames)} is not supported")
 
-    if isinstance(dark_filename, str):
+    if not dark_filename:
+        bg_dataset = None
+    elif isinstance(dark_filename, str):
         dark_root_dir = os.path.join(dataset.dir, "dark")
         os.makedirs(dark_root_dir, exist_ok=True)
         bg_dataset = Dataset(
             _dir=dark_root_dir,
             first_filename=dark_filename,
             copy_files=False,
             isH5=isH5,
@@ -89,16 +96,14 @@
         bg_dataset = Dataset(
             _dir=dark_root_dir,
             first_filename=dark_filename,
             copy_files=False,
             isH5=isH5,
             metadata_url=None,
         )
-    elif dark_filename is None:
-        bg_dataset = None
     else:
         raise TypeError(f"dark_filename of type {type(dark_filename)} is not handle")
 
     return dataset, indices, li_indices, bg_dataset
 
 
 def _get_root_dir(filename: str) -> str:
```

### Comparing `darfix-1.0.1rc1/src/darfix/core/dataset.py` & `darfix-1.0.2/src/darfix/core/dataset.py`

 * *Files 2% similar despite different names*

```diff
@@ -12,6503 +12,6573 @@
 000000b0: 2069 6d70 6f72 7420 7061 7274 6961 6c0a   import partial.
 000000c0: 6672 6f6d 206d 756c 7469 7072 6f63 6573  from multiproces
 000000d0: 7369 6e67 2069 6d70 6f72 7420 506f 6f6c  sing import Pool
 000000e0: 0a66 726f 6d20 656e 756d 2069 6d70 6f72  .from enum impor
 000000f0: 7420 496e 7445 6e75 6d0a 6672 6f6d 2074  t IntEnum.from t
 00000100: 7970 696e 6720 696d 706f 7274 2054 7570  yping import Tup
 00000110: 6c65 2c20 4f70 7469 6f6e 616c 2c20 4765  le, Optional, Ge
-00000120: 6e65 7261 746f 722c 2055 6e69 6f6e 0a66  nerator, Union.f
-00000130: 726f 6d20 6e75 6d62 6572 7320 696d 706f  rom numbers impo
-00000140: 7274 204e 756d 6265 720a 6672 6f6d 2063  rt Number.from c
-00000150: 6f6e 7465 7874 6c69 6220 696d 706f 7274  ontextlib import
-00000160: 2063 6f6e 7465 7874 6d61 6e61 6765 720a   contextmanager.
-00000170: 0a69 6d70 6f72 7420 6835 7079 0a69 6d70  .import h5py.imp
-00000180: 6f72 7420 6e75 6d70 790a 0a69 6d70 6f72  ort numpy..impor
-00000190: 7420 6661 6269 6f0a 696d 706f 7274 2073  t fabio.import s
-000001a0: 696c 780a 6672 6f6d 2073 696c 782e 696f  ilx.from silx.io
-000001b0: 2069 6d70 6f72 7420 7574 696c 730a 6672   import utils.fr
-000001c0: 6f6d 2073 696c 782e 696f 2069 6d70 6f72  om silx.io impor
-000001d0: 7420 6661 6269 6f68 350a 6672 6f6d 2073  t fabioh5.from s
-000001e0: 696c 782e 696f 2e75 726c 2069 6d70 6f72  ilx.io.url impor
-000001f0: 7420 4461 7461 5572 6c0a 6672 6f6d 2073  t DataUrl.from s
-00000200: 6b6c 6561 726e 2e65 7863 6570 7469 6f6e  klearn.exception
-00000210: 7320 696d 706f 7274 2043 6f6e 7665 7267  s import Converg
-00000220: 656e 6365 5761 726e 696e 670a 0a66 726f  enceWarning..fro
-00000230: 6d20 6461 7266 6978 2e63 6f72 652e 6469  m darfix.core.di
-00000240: 6d65 6e73 696f 6e20 696d 706f 7274 2041  mension import A
-00000250: 6371 7569 7369 7469 6f6e 4469 6d73 2c20  cquisitionDims, 
-00000260: 4469 6d65 6e73 696f 6e2c 2050 4f53 4954  Dimension, POSIT
-00000270: 494f 4e45 525f 4d45 5441 4441 5441 0a66  IONER_METADATA.f
-00000280: 726f 6d20 6461 7266 6978 2e63 6f72 652e  rom darfix.core.
-00000290: 696d 6167 654f 7065 7261 7469 6f6e 7320  imageOperations 
-000002a0: 696d 706f 7274 2069 6d67 3269 6d67 5f6d  import img2img_m
-000002b0: 6561 6e2c 2063 6875 6e6b 5f69 6d61 6765  ean, chunk_image
-000002c0: 0a66 726f 6d20 6461 7266 6978 2e63 6f72  .from darfix.cor
-000002d0: 652e 696d 6167 654f 7065 7261 7469 6f6e  e.imageOperation
-000002e0: 7320 696d 706f 7274 2028 0a20 2020 2062  s import (.    b
-000002f0: 6163 6b67 726f 756e 645f 7375 6274 7261  ackground_subtra
-00000300: 6374 696f 6e2c 0a20 2020 2062 6163 6b67  ction,.    backg
-00000310: 726f 756e 645f 7375 6274 7261 6374 696f  round_subtractio
-00000320: 6e5f 3244 2c0a 290a 6672 6f6d 2064 6172  n_2D,.).from dar
-00000330: 6669 782e 636f 7265 2e69 6d61 6765 4f70  fix.core.imageOp
-00000340: 6572 6174 696f 6e73 2069 6d70 6f72 7420  erations import 
-00000350: 686f 745f 7069 7865 6c5f 7265 6d6f 7661  hot_pixel_remova
-00000360: 6c5f 3344 2c20 686f 745f 7069 7865 6c5f  l_3D, hot_pixel_
-00000370: 7265 6d6f 7661 6c5f 3244 0a66 726f 6d20  removal_2D.from 
-00000380: 6461 7266 6978 2e63 6f72 652e 696d 6167  darfix.core.imag
-00000390: 654f 7065 7261 7469 6f6e 7320 696d 706f  eOperations impo
-000003a0: 7274 2074 6872 6573 686f 6c64 5f72 656d  rt threshold_rem
-000003b0: 6f76 616c 2c20 6d61 736b 5f72 656d 6f76  oval, mask_remov
-000003c0: 616c 0a66 726f 6d20 6461 7266 6978 2e63  al.from darfix.c
-000003d0: 6f72 652e 696d 6167 654f 7065 7261 7469  ore.imageOperati
-000003e0: 6f6e 7320 696d 706f 7274 204d 6574 686f  ons import Metho
-000003f0: 640a 6672 6f6d 2064 6172 6669 782e 636f  d.from darfix.co
-00000400: 7265 2e69 6d61 6765 5265 6769 7374 7261  re.imageRegistra
-00000410: 7469 6f6e 2069 6d70 6f72 7420 7368 6966  tion import shif
-00000420: 745f 6465 7465 6374 696f 6e2c 2061 7070  t_detection, app
-00000430: 6c79 5f73 6869 6674 0a66 726f 6d20 6461  ly_shift.from da
-00000440: 7266 6978 2e63 6f72 652e 6d61 7070 696e  rfix.core.mappin
-00000450: 6720 696d 706f 7274 2028 0a20 2020 2066  g import (.    f
-00000460: 6974 5f64 6174 612c 0a20 2020 2066 6974  it_data,.    fit
-00000470: 5f32 645f 6461 7461 2c0a 2020 2020 636f  _2d_data,.    co
-00000480: 6d70 7574 655f 6d6f 6d65 6e74 732c 0a20  mpute_moments,. 
-00000490: 2020 2063 6f6d 7075 7465 5f72 736d 2c0a     compute_rsm,.
-000004a0: 2020 2020 636f 6d70 7574 655f 6d61 676e      compute_magn
-000004b0: 6966 6963 6174 696f 6e2c 0a20 2020 2063  ification,.    c
-000004c0: 616c 6375 6c61 7465 5f52 534d 5f68 6973  alculate_RSM_his
-000004d0: 746f 6772 616d 2c0a 2020 2020 7265 7363  togram,.    resc
-000004e0: 616c 655f 6461 7461 2c0a 290a 6672 6f6d  ale_data,.).from
-000004f0: 2064 6172 6669 782e 636f 7265 2e72 6f69   darfix.core.roi
-00000500: 2069 6d70 6f72 7420 6170 706c 795f 3244   import apply_2D
-00000510: 5f52 4f49 2c20 6170 706c 795f 3344 5f52  _ROI, apply_3D_R
-00000520: 4f49 0a66 726f 6d20 6461 7266 6978 2e63  OI.from darfix.c
-00000530: 6f72 652e 7574 696c 7320 696d 706f 7274  ore.utils import
-00000540: 2077 7261 7054 6f32 7069 0a66 726f 6d20   wrapTo2pi.from 
-00000550: 6461 7266 6978 2e64 6563 6f6d 706f 7369  darfix.decomposi
-00000560: 7469 6f6e 2e69 7063 6120 696d 706f 7274  tion.ipca import
-00000570: 2049 5043 410a 6672 6f6d 2064 6172 6669   IPCA.from darfi
-00000580: 782e 6465 636f 6d70 6f73 6974 696f 6e2e  x.decomposition.
-00000590: 6e6d 6620 696d 706f 7274 204e 4d46 0a66  nmf import NMF.f
-000005a0: 726f 6d20 6461 7266 6978 2e64 6563 6f6d  rom darfix.decom
-000005b0: 706f 7369 7469 6f6e 2e6e 6963 6120 696d  position.nica im
-000005c0: 706f 7274 204e 4943 410a 6672 6f6d 2064  port NICA.from d
-000005d0: 6172 6669 782e 696f 2069 6d70 6f72 7420  arfix.io import 
-000005e0: 7574 696c 7320 6173 2069 6f5f 7574 696c  utils as io_util
-000005f0: 730a 0a5f 6c6f 6767 6572 203d 206c 6f67  s.._logger = log
-00000600: 6769 6e67 2e67 6574 4c6f 6767 6572 285f  ging.getLogger(_
-00000610: 5f66 696c 655f 5f29 0a0a 0a63 6c61 7373  _file__)...class
-00000620: 204f 7065 7261 7469 6f6e 2849 6e74 456e   Operation(IntEn
-00000630: 756d 293a 0a20 2020 2022 2222 0a20 2020  um):.    """.   
-00000640: 2046 6c61 6773 2066 6f72 2064 6966 6665   Flags for diffe
-00000650: 7265 6e74 206f 7065 7261 7469 6f6e 7320  rent operations 
-00000660: 696e 2044 6174 6173 6574 0a20 2020 2022  in Dataset.    "
-00000670: 2222 0a0a 2020 2020 5041 5254 4954 494f  ""..    PARTITIO
-00000680: 4e20 3d20 300a 2020 2020 4253 203d 2031  N = 0.    BS = 1
-00000690: 0a20 2020 2048 5020 3d20 320a 2020 2020  .    HP = 2.    
-000006a0: 5448 5245 5348 4f4c 4420 3d20 330a 2020  THRESHOLD = 3.  
-000006b0: 2020 5348 4946 5420 3d20 340a 2020 2020    SHIFT = 4.    
-000006c0: 524f 4920 3d20 350a 2020 2020 4d4f 4d45  ROI = 5.    MOME
-000006d0: 4e54 5320 3d20 360a 2020 2020 4649 5420  NTS = 6.    FIT 
-000006e0: 3d20 370a 2020 2020 4249 4e4e 494e 4720  = 7.    BINNING 
-000006f0: 3d20 380a 2020 2020 4d41 534b 203d 2039  = 8.    MASK = 9
-00000700: 0a0a 0a63 6c61 7373 205f 5374 6174 654f  ...class _StateO
-00000710: 664f 7065 7261 7469 6f6e 733a 0a20 2020  fOperations:.   
-00000720: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-00000730: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-00000740: 662e 5f69 735f 7275 6e6e 696e 6720 3d20  f._is_running = 
-00000750: 5b46 616c 7365 5d20 2a20 6c65 6e28 4f70  [False] * len(Op
-00000760: 6572 6174 696f 6e29 0a0a 2020 2020 6465  eration)..    de
-00000770: 6620 5f73 7461 7274 2873 656c 662c 206f  f _start(self, o
-00000780: 7065 7261 7469 6f6e 3a20 4f70 7469 6f6e  peration: Option
-00000790: 616c 5b4f 7065 7261 7469 6f6e 5d29 202d  al[Operation]) -
-000007a0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-000007b0: 6966 206f 7065 7261 7469 6f6e 2069 7320  if operation is 
-000007c0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000007d0: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
-000007e0: 2073 656c 662e 5f69 735f 7275 6e6e 696e   self._is_runnin
-000007f0: 675b 6f70 6572 6174 696f 6e5d 203d 2054  g[operation] = T
-00000800: 7275 650a 0a20 2020 2064 6566 2073 746f  rue..    def sto
-00000810: 7028 7365 6c66 2c20 6f70 6572 6174 696f  p(self, operatio
-00000820: 6e3a 204f 7074 696f 6e61 6c5b 4f70 6572  n: Optional[Oper
-00000830: 6174 696f 6e5d 2920 2d3e 204e 6f6e 653a  ation]) -> None:
-00000840: 0a20 2020 2020 2020 2069 6620 6f70 6572  .        if oper
-00000850: 6174 696f 6e20 6973 204e 6f6e 653a 0a20  ation is None:. 
-00000860: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00000870: 6e0a 2020 2020 2020 2020 7365 6c66 2e5f  n.        self._
-00000880: 6973 5f72 756e 6e69 6e67 5b6f 7065 7261  is_running[opera
-00000890: 7469 6f6e 5d20 3d20 4661 6c73 650a 0a20  tion] = False.. 
-000008a0: 2020 2040 636f 6e74 6578 746d 616e 6167     @contextmanag
-000008b0: 6572 0a20 2020 2064 6566 2072 756e 5f63  er.    def run_c
-000008c0: 6f6e 7465 7874 2873 656c 662c 206f 7065  ontext(self, ope
-000008d0: 7261 7469 6f6e 3a20 4f70 7469 6f6e 616c  ration: Optional
-000008e0: 5b4f 7065 7261 7469 6f6e 5d29 3a0a 2020  [Operation]):.  
-000008f0: 2020 2020 2020 7365 6c66 2e5f 7374 6172        self._star
-00000900: 7428 6f70 6572 6174 696f 6e29 0a20 2020  t(operation).   
-00000910: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00000920: 2020 2020 2020 7969 656c 640a 2020 2020        yield.    
-00000930: 2020 2020 6669 6e61 6c6c 793a 0a20 2020      finally:.   
-00000940: 2020 2020 2020 2020 2073 656c 662e 7374           self.st
-00000950: 6f70 286f 7065 7261 7469 6f6e 290a 0a20  op(operation).. 
-00000960: 2020 2064 6566 2069 735f 7275 6e6e 696e     def is_runnin
-00000970: 6728 7365 6c66 2c20 6f70 6572 6174 696f  g(self, operatio
-00000980: 6e3a 204f 7065 7261 7469 6f6e 2920 2d3e  n: Operation) ->
-00000990: 2062 6f6f 6c3a 0a20 2020 2020 2020 2072   bool:.        r
-000009a0: 6574 7572 6e20 7365 6c66 2e5f 6973 5f72  eturn self._is_r
-000009b0: 756e 6e69 6e67 5b6f 7065 7261 7469 6f6e  unning[operation
-000009c0: 5d0a 0a0a 636c 6173 7320 4461 7461 7365  ]...class Datase
-000009d0: 743a 0a20 2020 2022 2222 436c 6173 7320  t:.    """Class 
-000009e0: 746f 2064 6566 696e 6520 6120 6461 7461  to define a data
-000009f0: 7365 7420 6672 6f6d 2061 2073 6572 6965  set from a serie
-00000a00: 7320 6f66 2064 6174 6120 6669 6c65 732e  s of data files.
-00000a10: 0a20 2020 2054 6865 2069 6465 6120 6f66  .    The idea of
-00000a20: 2074 6869 7320 636c 6173 7320 6973 2074   this class is t
-00000a30: 6f20 6d61 6b65 206c 6966 6520 6561 7369  o make life easi
-00000a40: 6572 2066 6f72 2074 6865 2075 7365 7220  er for the user 
-00000a50: 7768 656e 2075 7369 6e67 2064 6172 6669  when using darfi
-00000a60: 782e 0a20 2020 204d 6f73 7420 6f66 2074  x..    Most of t
-00000a70: 6865 206f 7065 7261 7469 6f6e 7320 6f6e  he operations on
-00000a80: 2064 6172 6669 7820 6e65 6564 2074 6f20   darfix need to 
-00000a90: 7573 6520 616c 6c20 7468 6520 6461 7461  use all the data
-00000aa0: 2074 6f20 6265 2063 6f6d 7075 7465 642c   to be computed,
-00000ab0: 0a20 2020 2068 6176 696e 6720 6120 7772  .    having a wr
-00000ac0: 6170 7065 7220 6c69 6b65 2044 6174 6173  apper like Datas
-00000ad0: 6574 2061 6c6c 6f77 7320 746f 2065 7865  et allows to exe
-00000ae0: 6375 7465 2074 6865 206f 7065 7261 7469  cute the operati
-00000af0: 6f6e 7320 6f6e 2074 6861 7420 7361 6d65  ons on that same
-00000b00: 2064 6174 610a 2020 2020 7769 7468 6f75   data.    withou
-00000b10: 7420 6861 7669 6e67 2074 6f20 6c6f 6164  t having to load
-00000b20: 2074 6865 2064 6174 6120 6174 2065 6163   the data at eac
-00000b30: 6820 7374 6570 2e0a 2020 2020 5468 6973  h step..    This
-00000b40: 2069 7320 6e6f 7420 6120 476f 6420 6f62   is not a God ob
-00000b50: 6a65 6374 3a20 4f70 6572 6174 696f 6e73  ject: Operations
-00000b60: 206f 6e20 7468 6520 736f 7572 6365 2064   on the source d
-00000b70: 6174 6120 2865 2e67 2e20 626c 696e 6420  ata (e.g. blind 
-00000b80: 736f 7572 6365 2073 6570 6172 6174 696f  source separatio
-00000b90: 6e2c 2068 6f74 2070 6978 656c 2072 656d  n, hot pixel rem
-00000ba0: 6f76 616c 2c0a 2020 2020 7368 6966 7420  oval,.    shift 
-00000bb0: 636f 7272 6563 7469 6f6e 2920 6172 6520  correction) are 
-00000bc0: 696d 706c 656d 656e 7465 6420 6173 2070  implemented as p
-00000bd0: 7572 6520 7472 616e 7366 6f72 6d61 7469  ure transformati
-00000be0: 6f6e 7320 6163 7469 6e67 206f 6e20 7468  ons acting on th
-00000bf0: 6973 2065 6e74 6974 792c 0a20 2020 2073  is entity,.    s
-00000c00: 7563 6820 7468 6174 2074 6865 7265 2061  uch that there a
-00000c10: 7265 206e 6f20 7369 6465 2065 6666 6563  re no side effec
-00000c20: 7473 2061 6e64 2074 6865 206f 7065 7261  ts and the opera
-00000c30: 7469 6f6e 7320 6361 6e20 6265 2063 6861  tions can be cha
-00000c40: 696e 6564 2074 6f67 6574 6865 7220 746f  ined together to
-00000c50: 2064 6566 696e 650a 2020 2020 6120 636f   define.    a co
-00000c60: 6d70 7574 6174 696f 6e61 6c20 776f 726b  mputational work
-00000c70: 666c 6f77 2e0a 2020 2020 416c 7468 6f75  flow..    Althou
-00000c80: 6768 2069 7420 6973 2061 2063 6f6d 706c  gh it is a compl
-00000c90: 6578 2063 6c61 7373 2064 7565 2074 6f20  ex class due to 
-00000ca0: 7468 6520 6e65 7874 2074 6869 6e67 733a  the next things:
-00000cb0: 0a20 2020 202d 2054 6865 2064 6174 6120  .    - The data 
-00000cc0: 6361 6e20 6265 206c 6f61 6465 6420 6f6e  can be loaded on
-00000cd0: 206d 656d 6f72 7920 6f72 206f 6e20 6469   memory or on di
-00000ce0: 736b 2e20 5768 656e 2074 6865 2064 6174  sk. When the dat
-00000cf0: 6120 6973 206f 6e20 6469 736b 2c0a 2020  a is on disk,.  
-00000d00: 2020 7468 6520 636f 7265 206f 7065 7261    the core opera
-00000d10: 7469 6f6e 7320 6172 6520 6361 6c6c 6564  tions are called
-00000d20: 2075 7369 6e67 2063 6875 6e6b 7320 6f66   using chunks of
-00000d30: 2074 6865 2064 6174 6120 746f 2072 6564   the data to red
-00000d40: 7563 6520 6974 7320 7369 7a65 206f 6e20  uce its size on 
-00000d50: 6d65 6d6f 7279 2e0a 2020 2020 2d20 4120  memory..    - A 
-00000d60: 4461 7461 7365 7420 616c 6c6f 7773 2074  Dataset allows t
-00000d70: 6865 2075 7365 7220 746f 2075 7365 206f  he user to use o
-00000d80: 6e6c 7920 7061 7274 206f 6620 7468 6520  nly part of the 
-00000d90: 6461 7461 2066 6f72 2063 6572 7461 696e  data for certain
-00000da0: 206f 7065 7261 7469 6f6e 732c 0a20 2020   operations,.   
-00000db0: 2077 6869 6368 2061 6c6c 6f77 7320 746f   which allows to
-00000dc0: 2068 6176 6520 6120 6d75 6368 2066 6173   have a much fas
-00000dd0: 7465 7220 7072 6f63 6573 7369 6e67 206f  ter processing o
-00000de0: 6620 7468 6f73 652e 2054 6869 7320 6973  f those. This is
-00000df0: 2064 6f6e 6520 7573 696e 6720 7468 650a   done using the.
-00000e00: 2020 2020 6069 6e64 6963 6573 6020 616e      `indices` an
-00000e10: 6420 6062 675f 696e 6469 6365 7360 2061  d `bg_indices` a
-00000e20: 7474 7269 6275 7465 732e 0a20 2020 202d  ttributes..    -
-00000e30: 2049 7420 616c 736f 2061 6c6c 6f77 732c   It also allows,
-00000e40: 2066 6f72 2063 6572 7461 696e 206f 7065   for certain ope
-00000e50: 7261 7469 6f6e 7320 616e 6420 6174 2063  rations and at c
-00000e60: 6572 7461 696e 2063 6173 6573 2c20 746f  ertain cases, to
-00000e70: 2073 746f 7020 6120 7275 6e6e 696e 6720   stop a running 
-00000e80: 6f70 6572 6174 696f 6e2e 0a20 2020 2054  operation..    T
-00000e90: 6869 7320 6973 2064 6f6e 6520 7769 7468  his is done with
-00000ea0: 2074 6865 2061 7474 7269 6275 7465 7320   the attributes 
-00000eb0: 6072 756e 6e69 6e67 5f64 6174 6160 2061  `running_data` a
-00000ec0: 6e64 2060 7374 6174 655f 6f66 5f6f 7065  nd `state_of_ope
-00000ed0: 7261 7469 6f6e 7360 2c20 7768 6963 680a  rations`, which.
-00000ee0: 2020 2020 636f 6e74 6169 6e20 7468 6520      contain the 
-00000ef0: 6044 6174 6160 206f 626a 6563 7420 7769  `Data` object wi
-00000f00: 7468 2074 6865 2064 6174 6120 6265 696e  th the data bein
-00000f10: 6720 6d6f 6469 6669 6564 2061 6e64 2061  g modified and a
-00000f20: 206c 6973 7420 6f66 2074 6865 206f 7065   list of the ope
-00000f30: 7261 7469 6f6e 730a 2020 2020 746f 2073  rations.    to s
-00000f40: 746f 702e 0a20 2020 202d 2054 6865 2060  top..    - The `
-00000f50: 6469 6d73 6020 6174 7472 6962 7574 6520  dims` attribute 
-00000f60: 6973 2061 2064 6963 7469 6f6e 6172 7920  is a dictionary 
-00000f70: 636f 6e74 6169 6e69 6e67 2074 6865 2064  containing the d
-00000f80: 696d 656e 7369 6f6e 7320 7468 6174 0a20  imensions that. 
-00000f90: 2020 2073 6861 7065 2074 6865 2064 6174     shape the dat
-00000fa0: 612e 2053 6576 6572 616c 206f 7065 7261  a. Several opera
-00000fb0: 7469 6f6e 7320 6361 6e20 6265 2061 7070  tions can be app
-00000fc0: 6c69 6564 206f 6e20 6f6e 6c79 2070 6172  lied on only par
-00000fd0: 7420 6f66 2074 6865 2064 6174 610a 2020  t of the data.  
-00000fe0: 2020 6465 7065 6e64 696e 6720 6f6e 2074    depending on t
-00000ff0: 6865 2064 696d 656e 7369 6f6e 7320 7368  he dimensions sh
-00001000: 6170 652e 0a0a 2020 2020 3a70 6172 616d  ape...    :param
-00001010: 205f 6469 723a 2047 6c6f 6261 6c20 6469   _dir: Global di
-00001020: 7265 6374 6f72 7920 746f 2075 7365 2061  rectory to use a
-00001030: 6e64 2073 6176 6520 616c 6c20 7468 6520  nd save all the 
-00001040: 6461 7461 2069 6e20 7468 6520 6469 6666  data in the diff
-00001050: 6572 656e 740a 2020 2020 2020 2020 6f70  erent.        op
-00001060: 6572 6174 696f 6e73 2e0a 2020 2020 3a74  erations..    :t
-00001070: 7970 6520 5f64 6972 3a20 7374 720a 2020  ype _dir: str.  
-00001080: 2020 3a70 6172 616d 2064 6174 613a 2049    :param data: I
-00001090: 6620 6e6f 7420 4e6f 6e65 2c20 7365 7473  f not None, sets
-000010a0: 2074 6865 2044 6174 6120 6172 7261 7920   the Data array 
-000010b0: 7769 7468 2074 6865 2064 6174 6120 6f66  with the data of
-000010c0: 2074 6865 2064 6174 6173 6574 0a20 2020   the dataset.   
-000010d0: 2020 2020 2074 6f20 7573 652c 2064 6566       to use, def
-000010e0: 6175 6c74 204e 6f6e 650a 2020 2020 3a74  ault None.    :t
-000010f0: 7970 6520 6461 7461 3a20 3a63 6c61 7373  ype data: :class
-00001100: 3a60 4461 7461 602c 206f 7074 696f 6e61  :`Data`, optiona
-00001110: 6c0a 2020 2020 3a70 6172 616d 2072 6177  l.    :param raw
-00001120: 5f66 6f6c 6465 723a 2050 6174 6820 746f  _folder: Path to
-00001130: 2074 6865 2066 6f6c 6465 7220 7468 6174   the folder that
-00001140: 2063 6f6e 7461 696e 7320 7468 6520 6461   contains the da
-00001150: 7461 2c20 6465 6661 756c 7473 2074 6f0a  ta, defaults to.
-00001160: 2020 2020 2020 2020 4e6f 6e65 0a20 2020          None.   
-00001170: 203a 7479 7065 2072 6177 5f66 6f6c 6465   :type raw_folde
-00001180: 723a 2055 6e69 6f6e 5b4e 6f6e 652c 7374  r: Union[None,st
-00001190: 725d 2c20 6f70 7469 6f6e 616c 0a20 2020  r], optional.   
-000011a0: 203a 7061 7261 6d20 6669 6c65 6e61 6d65   :param filename
-000011b0: 733a 204f 7264 6572 6564 206c 6973 7420  s: Ordered list 
-000011c0: 6f66 2066 696c 656e 616d 6573 2c20 6465  of filenames, de
-000011d0: 6661 756c 7473 2074 6f20 4e6f 6e65 2028  faults to None (
-000011e0: 6578 7065 6374 6564 2066 6f72 2045 4446  expected for EDF
-000011f0: 2066 696c 6573 292e 0a20 2020 203a 7479   files)..    :ty
-00001200: 7065 2066 696c 656e 616d 6573 3a20 556e  pe filenames: Un
-00001210: 696f 6e5b 4765 6e65 7261 746f 722c 4974  ion[Generator,It
-00001220: 6572 6174 6f72 2c4c 6973 745d 2c20 6f70  erator,List], op
-00001230: 7469 6f6e 616c 0a20 2020 203a 7061 7261  tional.    :para
-00001240: 6d20 6469 6d73 3a20 4469 6d65 6e73 696f  m dims: Dimensio
-00001250: 6e73 2064 6963 7469 6f6e 6172 790a 2020  ns dictionary.  
-00001260: 2020 3a74 7970 6520 6469 6d73 3a20 4163    :type dims: Ac
-00001270: 7175 6973 6974 696f 6e44 696d 732c 206f  quisitionDims, o
-00001280: 7074 696f 6e61 6c0a 2020 2020 3a70 6172  ptional.    :par
-00001290: 616d 2074 7261 6e73 666f 726d 6174 696f  am transformatio
-000012a0: 6e3a 2041 7865 7320 746f 2075 7365 2077  n: Axes to use w
-000012b0: 6865 6e20 6469 7370 6c61 7969 6e67 2074  hen displaying t
-000012c0: 6865 2069 6d61 6765 730a 2020 2020 3a74  he images.    :t
-000012d0: 7970 6520 7472 616e 7366 6f72 6d61 7469  ype transformati
-000012e0: 6f6e 3a20 6e64 6172 7261 792c 206f 7074  on: ndarray, opt
-000012f0: 696f 6e61 6c0a 2020 2020 3a70 6172 616d  ional.    :param
-00001300: 2069 6e5f 6d65 6d6f 7279 3a20 4966 2054   in_memory: If T
-00001310: 7275 652c 2064 6174 6120 6973 206c 6f61  rue, data is loa
-00001320: 6465 6420 696e 746f 206d 656d 6f72 792c  ded into memory,
-00001330: 2065 6c73 652c 2064 6174 6120 6973 2072   else, data is r
-00001340: 6561 6420 696e 0a20 2020 2020 2020 2063  ead in.        c
-00001350: 6875 6e6b 7320 6465 7065 6e64 696e 6720  hunks depending 
-00001360: 6f6e 2074 6865 2061 6c67 6f72 6974 686d  on the algorithm
-00001370: 2074 6f20 6170 706c 792c 2064 6566 6175   to apply, defau
-00001380: 6c74 7320 746f 2046 616c 7365 2e0a 2020  lts to False..  
-00001390: 2020 3a74 7970 6520 696e 5f6d 656d 6f72    :type in_memor
-000013a0: 793a 2062 6f6f 6c2c 206f 7074 696f 6e61  y: bool, optiona
-000013b0: 6c0a 2020 2020 3a70 6172 616d 2063 6f70  l.    :param cop
-000013c0: 795f 6669 6c65 733a 2049 6620 5472 7565  y_files: If True
-000013d0: 2c20 6372 6561 7465 7320 6120 6e65 7720  , creates a new 
-000013e0: 7472 6561 7465 6420 6461 7461 2066 6f6c  treated data fol
-000013f0: 6465 7220 616e 6420 646f 6573 6e27 7420  der and doesn't 
-00001400: 7265 706c 6163 650a 2020 2020 2020 2020  replace.        
-00001410: 7468 6520 6469 7265 6374 6f72 7920 6669  the directory fi
-00001420: 6c65 732e 0a20 2020 203a 7479 7065 2063  les..    :type c
-00001430: 6f70 795f 6669 6c65 733a 2062 6f6f 6c2c  opy_files: bool,
-00001440: 206f 7074 696f 6e61 6c0a 2020 2020 3a70   optional.    :p
-00001450: 6172 616d 2069 7348 353a 2054 7275 6520  aram isH5: True 
-00001460: 6966 2074 6865 2064 6174 6120 6973 2063  if the data is c
-00001470: 6f6e 7461 696e 696e 6564 2069 6e74 6f20  ontainined into 
-00001480: 4844 4635 2066 696c 650a 2020 2020 3a70  HDF5 file.    :p
-00001490: 6172 616d 206d 6574 6164 6174 615f 7572  aram metadata_ur
-000014a0: 6c3a 204f 7074 696f 6e61 6c20 7572 6c20  l: Optional url 
-000014b0: 746f 2074 6865 206d 6574 6164 6174 6120  to the metadata 
-000014c0: 2869 6e20 6361 7365 206f 6620 6e6f 6e2d  (in case of non-
-000014d0: 4544 4620 6163 7175 6973 6974 696f 6e29  EDF acquisition)
-000014e0: 0a20 2020 2022 2222 0a0a 2020 2020 6465  .    """..    de
-000014f0: 6620 5f5f 696e 6974 5f5f 280a 2020 2020  f __init__(.    
-00001500: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00001510: 2020 5f64 6972 2c0a 2020 2020 2020 2020    _dir,.        
-00001520: 6461 7461 3d4e 6f6e 652c 0a20 2020 2020  data=None,.     
-00001530: 2020 2072 6177 5f66 6f6c 6465 723d 4e6f     raw_folder=No
-00001540: 6e65 2c0a 2020 2020 2020 2020 6669 7273  ne,.        firs
-00001550: 745f 6669 6c65 6e61 6d65 3d4e 6f6e 652c  t_filename=None,
-00001560: 0a20 2020 2020 2020 2066 696c 656e 616d  .        filenam
-00001570: 6573 3d4e 6f6e 652c 0a20 2020 2020 2020  es=None,.       
-00001580: 2064 696d 733d 4e6f 6e65 2c0a 2020 2020   dims=None,.    
-00001590: 2020 2020 7472 616e 7366 6f72 6d61 7469      transformati
-000015a0: 6f6e 3d4e 6f6e 652c 0a20 2020 2020 2020  on=None,.       
-000015b0: 2069 6e5f 6d65 6d6f 7279 3d54 7275 652c   in_memory=True,
-000015c0: 0a20 2020 2020 2020 2063 6f70 795f 6669  .        copy_fi
-000015d0: 6c65 733d 4661 6c73 652c 0a20 2020 2020  les=False,.     
-000015e0: 2020 2069 7348 353d 4661 6c73 652c 0a20     isH5=False,. 
-000015f0: 2020 2020 2020 2074 6974 6c65 3d22 222c         title="",
-00001600: 0a20 2020 2020 2020 206d 6574 6164 6174  .        metadat
-00001610: 615f 7572 6c3a 204f 7074 696f 6e61 6c5b  a_url: Optional[
-00001620: 4461 7461 5572 6c5d 203d 204e 6f6e 652c  DataUrl] = None,
-00001630: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
-00001640: 7365 6c66 2e5f 6461 7461 203d 204e 6f6e  self._data = Non
-00001650: 650a 2020 2020 2020 2020 7365 6c66 2e5f  e.        self._
-00001660: 6672 616d 6573 5f69 6e74 656e 7369 7479  frames_intensity
-00001670: 203d 205b 5d0a 2020 2020 2020 2020 7365   = [].        se
-00001680: 6c66 2e72 756e 6e69 6e67 5f64 6174 6120  lf.running_data 
-00001690: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
-000016a0: 656c 662e 6d6f 6d65 6e74 735f 6469 6d73  elf.moments_dims
-000016b0: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
-000016c0: 6c66 2e73 7461 7465 5f6f 665f 6f70 6572  lf.state_of_oper
-000016d0: 6174 696f 6e73 203d 205f 5374 6174 654f  ations = _StateO
-000016e0: 664f 7065 7261 7469 6f6e 7328 290a 2020  fOperations().  
-000016f0: 2020 2020 2020 7365 6c66 2e5f 6469 7220        self._dir 
-00001700: 3d20 5f64 6972 0a20 2020 2020 2020 2073  = _dir.        s
-00001710: 656c 662e 5f74 7261 6e73 666f 726d 6174  elf._transformat
-00001720: 696f 6e20 3d20 7472 616e 7366 6f72 6d61  ion = transforma
-00001730: 7469 6f6e 0a20 2020 2020 2020 2073 656c  tion.        sel
-00001740: 662e 5f74 6974 6c65 203d 2074 6974 6c65  f._title = title
-00001750: 0a20 2020 2020 2020 2069 6620 636f 7079  .        if copy
-00001760: 5f66 696c 6573 3a0a 2020 2020 2020 2020  _files:.        
-00001770: 2020 2020 7365 6c66 2e5f 6469 7220 3d20      self._dir = 
-00001780: 6f73 2e70 6174 682e 6a6f 696e 2873 656c  os.path.join(sel
-00001790: 662e 5f64 6972 2c20 2274 7265 6174 6564  f._dir, "treated
-000017a0: 2229 0a20 2020 2020 2020 2020 2020 2074  ").            t
-000017b0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-000017c0: 2020 2020 6f73 2e6d 616b 6564 6972 7328      os.makedirs(
-000017d0: 7365 6c66 2e5f 6469 722c 2065 7869 7374  self._dir, exist
-000017e0: 5f6f 6b3d 5472 7565 290a 2020 2020 2020  _ok=True).      
-000017f0: 2020 2020 2020 6578 6365 7074 2050 6572        except Per
-00001800: 6d69 7373 696f 6e45 7272 6f72 3a0a 2020  missionError:.  
-00001810: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00001820: 6973 6520 5065 726d 6973 7369 6f6e 4572  ise PermissionEr
-00001830: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00001840: 2020 2020 2020 2020 2022 4164 6420 6120           "Add a 
-00001850: 6469 7265 6374 6f72 7920 696e 2074 6865  directory in the
-00001860: 2054 7265 6174 6564 2044 6174 6120 7461   Treated Data ta
-00001870: 6220 7769 7468 2057 5249 5445 2070 6572  b with WRITE per
-00001880: 6d69 7373 696f 6e22 0a20 2020 2020 2020  mission".       
-00001890: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-000018a0: 2020 2020 6966 2064 696d 7320 6973 204e      if dims is N
-000018b0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000018c0: 2073 656c 662e 5f5f 6469 6d73 203d 2041   self.__dims = A
-000018d0: 6371 7569 7369 7469 6f6e 4469 6d73 2829  cquisitionDims()
-000018e0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-000018f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00001900: 7420 6973 696e 7374 616e 6365 280a 2020  t isinstance(.  
-00001910: 2020 2020 2020 2020 2020 2020 2020 6469                di
-00001920: 6d73 2c20 4163 7175 6973 6974 696f 6e44  ms, AcquisitionD
-00001930: 696d 730a 2020 2020 2020 2020 2020 2020  ims.            
-00001940: 292c 2022 4174 7472 6962 7574 6520 6469  ), "Attribute di
-00001950: 6d73 2068 6173 2074 6f20 6265 206f 6620  ms has to be of 
-00001960: 636c 6173 7320 4163 7175 6973 6974 696f  class Acquisitio
-00001970: 6e44 696d 7322 0a20 2020 2020 2020 2020  nDims".         
-00001980: 2020 2073 656c 662e 5f5f 6469 6d73 203d     self.__dims =
-00001990: 2064 696d 730a 2020 2020 2020 2020 2320   dims.        # 
-000019a0: 4b65 7973 3a20 6469 6d65 6e73 696f 6e73  Keys: dimensions
-000019b0: 206e 616d 6573 2c20 7661 6c75 6573 3a20   names, values: 
-000019c0: 6469 6d65 6e73 696f 6e73 2076 616c 7565  dimensions value
-000019d0: 730a 2020 2020 2020 2020 7365 6c66 2e5f  s.        self._
-000019e0: 6469 6d65 6e73 696f 6e73 5f76 616c 7565  dimensions_value
-000019f0: 7320 3d20 7b7d 0a20 2020 2020 2020 2073  s = {}.        s
-00001a00: 656c 662e 5f69 6e5f 6d65 6d6f 7279 203d  elf._in_memory =
-00001a10: 2069 6e5f 6d65 6d6f 7279 0a20 2020 2020   in_memory.     
-00001a20: 2020 2073 656c 662e 5f69 7348 3520 3d20     self._isH5 = 
-00001a30: 6973 4835 0a0a 2020 2020 2020 2020 6966  isH5..        if
-00001a40: 2064 6174 6120 6973 206e 6f74 204e 6f6e   data is not Non
-00001a50: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-00001a60: 656c 662e 5f64 6174 6120 3d20 6461 7461  elf._data = data
-00001a70: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00001a80: 2020 2020 2020 2020 2020 2069 6620 6669             if fi
-00001a90: 6c65 6e61 6d65 7320 6973 204e 6f6e 6520  lenames is None 
-00001aa0: 616e 6420 6669 7273 745f 6669 6c65 6e61  and first_filena
-00001ab0: 6d65 2069 7320 4e6f 6e65 3a0a 2020 2020  me is None:.    
-00001ac0: 2020 2020 2020 2020 2020 2020 6669 6c65              file
-00001ad0: 6e61 6d65 7320 3d20 736f 7274 6564 280a  names = sorted(.
-00001ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001af0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00001b00: 2020 2020 2020 2020 2020 2020 2020 780a                x.
-00001b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001b20: 2020 2020 2020 2020 666f 7220 7820 696e          for x in
-00001b30: 2067 6c6f 622e 676c 6f62 280a 2020 2020   glob.glob(.    
-00001b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001b50: 2020 2020 2020 2020 6f73 2e70 6174 682e          os.path.
-00001b60: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
-00001b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001b80: 2020 2020 2020 5f64 6972 2069 6620 7261        _dir if ra
-00001b90: 775f 666f 6c64 6572 2069 7320 4e6f 6e65  w_folder is None
-00001ba0: 2065 6c73 6520 7261 775f 666f 6c64 6572   else raw_folder
-00001bb0: 2c20 222a 220a 2020 2020 2020 2020 2020  , "*".          
-00001bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001bd0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00001be0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00001bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001c00: 2020 2020 2020 6966 206f 732e 7061 7468        if os.path
-00001c10: 2e69 7366 696c 6528 7829 0a20 2020 2020  .isfile(x).     
-00001c20: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
-00001c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001c40: 2029 0a20 2020 2020 2020 2020 2020 2073   ).            s
-00001c50: 656c 662e 6669 6c65 6e61 6d65 7320 3d20  elf.filenames = 
-00001c60: 6669 6c65 6e61 6d65 730a 2020 2020 2020  filenames.      
-00001c70: 2020 2020 2020 7365 6c66 2e66 6972 7374        self.first
-00001c80: 5f66 696c 656e 616d 6520 3d20 6669 7273  _filename = firs
-00001c90: 745f 6669 6c65 6e61 6d65 0a0a 2020 2020  t_filename..    
-00001ca0: 2020 2020 2020 2020 6d65 7461 6461 7461          metadata
-00001cb0: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
-00001cc0: 2020 6461 7461 5f75 726c 7320 3d20 5b5d    data_urls = []
-00001cd0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00001ce0: 2073 656c 662e 5f69 7348 353a 0a20 2020   self._isH5:.   
-00001cf0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00001d00: 6973 696e 7374 616e 6365 2866 6972 7374  isinstance(first
-00001d10: 5f66 696c 656e 616d 652c 2044 6174 6155  _filename, DataU
-00001d20: 726c 293a 0a20 2020 2020 2020 2020 2020  rl):.           
-00001d30: 2020 2020 2020 2020 2075 726c 203d 2066           url = f
-00001d40: 6972 7374 5f66 696c 656e 616d 650a 2020  irst_filename.  
-00001d50: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00001d60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00001d70: 2020 2020 2020 2020 7572 6c20 3d20 4461          url = Da
-00001d80: 7461 5572 6c28 6669 7273 745f 6669 6c65  taUrl(first_file
-00001d90: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
-00001da0: 2020 2020 2020 2320 6c6f 6164 2064 6174        # load dat
-00001db0: 610a 0a20 2020 2020 2020 2020 2020 2020  a..             
-00001dc0: 2020 2064 6566 2067 6574 5f6d 6574 6164     def get_metad
-00001dd0: 6174 6128 6461 7461 5f73 6c69 6365 2920  ata(data_slice) 
-00001de0: 2d3e 2074 7570 6c65 3a0a 2020 2020 2020  -> tuple:.      
-00001df0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00001e00: 206d 6574 6164 6174 615f 7572 6c20 6973   metadata_url is
-00001e10: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00001e20: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00001e30: 6574 7572 6e20 5f48 4446 354d 6574 6164  eturn _HDF5Metad
-00001e40: 6174 6152 6561 6465 7228 6d65 7461 6461  ataReader(metada
-00001e50: 7461 3d7b 7d29 0a20 2020 2020 2020 2020  ta={}).         
-00001e60: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00001e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001e80: 2020 2020 2020 2020 206d 6574 6164 6174           metadat
-00001e90: 6120 3d20 7b7d 0a20 2020 2020 2020 2020  a = {}.         
-00001ea0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00001eb0: 6974 6820 7369 6c78 2e69 6f2e 6f70 656e  ith silx.io.open
-00001ec0: 286d 6574 6164 6174 615f 7572 6c2e 6669  (metadata_url.fi
-00001ed0: 6c65 5f70 6174 6828 2929 2061 7320 6835  le_path()) as h5
-00001ee0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00001ef0: 2020 2020 2020 2020 2020 2020 2020 6d65                me
-00001f00: 7461 6461 7461 5f70 6174 6820 3d20 6d65  tadata_path = me
-00001f10: 7461 6461 7461 5f75 726c 2e64 6174 615f  tadata_url.data_
-00001f20: 7061 7468 2829 0a20 2020 2020 2020 2020  path().         
-00001f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001f40: 2020 2069 6620 6d65 7461 6461 7461 5f70     if metadata_p
-00001f50: 6174 6820 6e6f 7420 696e 2068 353a 0a20  ath not in h5:. 
-00001f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001f70: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00001f80: 6169 7365 204b 6579 4572 726f 7228 0a20  aise KeyError(. 
-00001f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001fb0: 2020 2066 2255 6e61 626c 6520 746f 2066     f"Unable to f
-00001fc0: 696e 6420 6d65 7461 6461 7461 2070 6174  ind metadata pat
-00001fd0: 6820 7b6d 6574 6164 6174 615f 7061 7468  h {metadata_path
-00001fe0: 7d20 696e 207b 6d65 7461 6461 7461 5f75  } in {metadata_u
-00001ff0: 726c 2e66 696c 655f 7061 7468 2829 7d22  rl.file_path()}"
-00002000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002020: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00002030: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00002040: 6574 6164 6174 615f 6772 6f75 7020 3d20  etadata_group = 
-00002050: 6835 5b6d 6574 6164 6174 615f 7061 7468  h5[metadata_path
-00002060: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00002070: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00002080: 7220 6461 7461 7365 7420 696e 206d 6574  r dataset in met
-00002090: 6164 6174 615f 6772 6f75 702e 6b65 7973  adata_group.keys
-000020a0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-000020b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000020c0: 2020 2020 2320 7765 206f 6e6c 7920 6861      # we only ha
-000020d0: 6e64 6c65 2031 4420 6461 7461 7365 740a  ndle 1D dataset.
-000020e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000020f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002100: 6966 2028 0a20 2020 2020 2020 2020 2020  if (.           
-00002110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002120: 2020 2020 2020 2020 2069 7369 6e73 7461           isinsta
-00002130: 6e63 6528 6d65 7461 6461 7461 5f67 726f  nce(metadata_gro
-00002140: 7570 5b64 6174 6173 6574 5d2c 2068 3570  up[dataset], h5p
-00002150: 792e 4461 7461 7365 7429 0a20 2020 2020  y.Dataset).     
-00002160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002170: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00002180: 6e64 206d 6574 6164 6174 615f 6772 6f75  nd metadata_grou
-00002190: 705b 6461 7461 7365 745d 2e6e 6469 6d20  p[dataset].ndim 
-000021a0: 3d3d 2031 0a20 2020 2020 2020 2020 2020  == 1.           
-000021b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000021c0: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
-000021d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000021e0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-000021f0: 656e 286d 6574 6164 6174 615f 6772 6f75  en(metadata_grou
-00002200: 705b 6461 7461 7365 745d 2920 3c3d 2064  p[dataset]) <= d
-00002210: 6174 615f 736c 6963 653a 0a20 2020 2020  ata_slice:.     
-00002220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002240: 2020 2023 2054 4f44 4f3a 2069 7320 7468     # TODO: is th
-00002250: 6973 2077 6172 6e69 6e67 2061 6c77 6179  is warning alway
-00002260: 7320 636f 7272 6563 7420 616e 6420 7265  s correct and re
-00002270: 6c65 7661 6e74 203f 0a20 2020 2020 2020  levant ?.       
-00002280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000022a0: 205f 6c6f 6767 6572 2e77 6172 6e69 6e67   _logger.warning
-000022b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000022c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000022d0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-000022e0: 556e 6162 6c65 2074 6f20 6163 6365 7373  Unable to access
-000022f0: 2074 6f20 696e 6465 7820 7b64 6174 615f   to index {data_
-00002300: 736c 6963 657d 206f 6620 7468 6520 6461  slice} of the da
-00002310: 7461 7365 7420 7b6d 6574 6164 6174 615f  taset {metadata_
-00002320: 6772 6f75 705b 6461 7461 7365 745d 2e6e  group[dataset].n
-00002330: 616d 657d 220a 2020 2020 2020 2020 2020  ame}".          
-00002340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002350: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00002360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002380: 2020 2020 2020 2020 6d65 7461 6461 7461          metadata
-00002390: 5b64 6174 6173 6574 5d20 3d20 4e6f 6e65  [dataset] = None
-000023a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000023b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000023c0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000023d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000023e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000023f0: 2020 206d 6574 6164 6174 615b 6461 7461     metadata[data
-00002400: 7365 745d 203d 206d 6574 6164 6174 615f  set] = metadata_
-00002410: 6772 6f75 705b 6461 7461 7365 745d 5b0a  group[dataset][.
-00002420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002440: 2020 2020 2020 2020 2020 2020 6461 7461              data
-00002450: 5f73 6c69 6365 0a20 2020 2020 2020 2020  _slice.         
-00002460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002470: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
-00002480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002490: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000024a0: 5f48 4446 354d 6574 6164 6174 6152 6561  _HDF5MetadataRea
-000024b0: 6465 7228 6d65 7461 6461 7461 3d6d 6574  der(metadata=met
-000024c0: 6164 6174 6129 0a0a 2020 2020 2020 2020  adata)..        
-000024d0: 2020 2020 2020 2020 7769 7468 2073 696c          with sil
-000024e0: 782e 696f 2e6f 7065 6e28 7572 6c2e 6669  x.io.open(url.fi
-000024f0: 6c65 5f70 6174 6828 2929 2061 7320 6835  le_path()) as h5
-00002500: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00002510: 2020 2020 2020 6864 6635 5f69 7465 6d20        hdf5_item 
-00002520: 3d20 6835 5b75 726c 2e64 6174 615f 7061  = h5[url.data_pa
-00002530: 7468 2829 5d0a 2020 2020 2020 2020 2020  th()].          
-00002540: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-00002550: 2069 7369 6e73 7461 6e63 6528 6864 6635   isinstance(hdf5
-00002560: 5f69 7465 6d2c 2068 3570 792e 4461 7461  _item, h5py.Data
-00002570: 7365 7429 3a0a 2020 2020 2020 2020 2020  set):.          
-00002580: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00002590: 6973 6520 5661 6c75 6545 7272 6f72 280a  ise ValueError(.
-000025a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000025b0: 2020 2020 2020 2020 2020 2020 6622 7572              f"ur
-000025c0: 6c20 6461 7461 2070 6174 6820 6973 206e  l data path is n
-000025d0: 6f74 2070 6f69 6e74 696e 6720 746f 2061  ot pointing to a
-000025e0: 2048 4446 3520 6461 7461 7365 7420 6275   HDF5 dataset bu
-000025f0: 7420 746f 207b 7479 7065 2868 6466 355f  t to {type(hdf5_
-00002600: 6974 656d 297d 220a 2020 2020 2020 2020  item)}".        
-00002610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002620: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00002630: 2020 2020 2020 6e5f 6672 616d 6573 203d        n_frames =
-00002640: 2068 6466 355f 6974 656d 2e73 6861 7065   hdf5_item.shape
-00002650: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-00002660: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-00002670: 6765 286e 5f66 7261 6d65 7329 3a0a 2020  ge(n_frames):.  
-00002680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002690: 2020 6461 7461 5f75 726c 732e 6170 7065    data_urls.appe
-000026a0: 6e64 280a 2020 2020 2020 2020 2020 2020  nd(.            
-000026b0: 2020 2020 2020 2020 2020 2020 4461 7461              Data
-000026c0: 5572 6c28 0a20 2020 2020 2020 2020 2020  Url(.           
-000026d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000026e0: 2066 696c 655f 7061 7468 3d75 726c 2e66   file_path=url.f
-000026f0: 696c 655f 7061 7468 2829 2c0a 2020 2020  ile_path(),.    
-00002700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002710: 2020 2020 2020 2020 6461 7461 5f70 6174          data_pat
-00002720: 683d 7572 6c2e 6461 7461 5f70 6174 6828  h=url.data_path(
-00002730: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00002740: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00002750: 6174 615f 736c 6963 653d 692c 0a20 2020  ata_slice=i,.   
-00002760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002770: 2020 2020 2020 2020 2073 6368 656d 653d           scheme=
-00002780: 2273 696c 7822 2c0a 2020 2020 2020 2020  "silx",.        
+00000120: 6e65 7261 746f 722c 2055 6e69 6f6e 2c20  nerator, Union, 
+00000130: 4469 6374 0a66 726f 6d20 6e75 6d62 6572  Dict.from number
+00000140: 7320 696d 706f 7274 204e 756d 6265 720a  s import Number.
+00000150: 6672 6f6d 2063 6f6e 7465 7874 6c69 6220  from contextlib 
+00000160: 696d 706f 7274 2063 6f6e 7465 7874 6d61  import contextma
+00000170: 6e61 6765 720a 0a69 6d70 6f72 7420 6835  nager..import h5
+00000180: 7079 0a69 6d70 6f72 7420 6e75 6d70 790a  py.import numpy.
+00000190: 0a69 6d70 6f72 7420 6661 6269 6f0a 696d  .import fabio.im
+000001a0: 706f 7274 2073 696c 780a 6672 6f6d 2073  port silx.from s
+000001b0: 696c 782e 696f 2069 6d70 6f72 7420 7574  ilx.io import ut
+000001c0: 696c 730a 6672 6f6d 2073 696c 782e 696f  ils.from silx.io
+000001d0: 2069 6d70 6f72 7420 6661 6269 6f68 350a   import fabioh5.
+000001e0: 6672 6f6d 2073 696c 782e 696f 2e75 726c  from silx.io.url
+000001f0: 2069 6d70 6f72 7420 4461 7461 5572 6c0a   import DataUrl.
+00000200: 6672 6f6d 2073 6b6c 6561 726e 2e65 7863  from sklearn.exc
+00000210: 6570 7469 6f6e 7320 696d 706f 7274 2043  eptions import C
+00000220: 6f6e 7665 7267 656e 6365 5761 726e 696e  onvergenceWarnin
+00000230: 670a 0a66 726f 6d20 6461 7266 6978 2e63  g..from darfix.c
+00000240: 6f72 652e 6469 6d65 6e73 696f 6e20 696d  ore.dimension im
+00000250: 706f 7274 2041 6371 7569 7369 7469 6f6e  port Acquisition
+00000260: 4469 6d73 2c20 4469 6d65 6e73 696f 6e2c  Dims, Dimension,
+00000270: 2050 4f53 4954 494f 4e45 525f 4d45 5441   POSITIONER_META
+00000280: 4441 5441 0a66 726f 6d20 6461 7266 6978  DATA.from darfix
+00000290: 2e63 6f72 652e 696d 6167 654f 7065 7261  .core.imageOpera
+000002a0: 7469 6f6e 7320 696d 706f 7274 2069 6d67  tions import img
+000002b0: 3269 6d67 5f6d 6561 6e2c 2063 6875 6e6b  2img_mean, chunk
+000002c0: 5f69 6d61 6765 0a66 726f 6d20 6461 7266  _image.from darf
+000002d0: 6978 2e63 6f72 652e 696d 6167 654f 7065  ix.core.imageOpe
+000002e0: 7261 7469 6f6e 7320 696d 706f 7274 2028  rations import (
+000002f0: 0a20 2020 2062 6163 6b67 726f 756e 645f  .    background_
+00000300: 7375 6274 7261 6374 696f 6e2c 0a20 2020  subtraction,.   
+00000310: 2062 6163 6b67 726f 756e 645f 7375 6274   background_subt
+00000320: 7261 6374 696f 6e5f 3244 2c0a 290a 6672  raction_2D,.).fr
+00000330: 6f6d 2064 6172 6669 782e 636f 7265 2e69  om darfix.core.i
+00000340: 6d61 6765 4f70 6572 6174 696f 6e73 2069  mageOperations i
+00000350: 6d70 6f72 7420 686f 745f 7069 7865 6c5f  mport hot_pixel_
+00000360: 7265 6d6f 7661 6c5f 3344 2c20 686f 745f  removal_3D, hot_
+00000370: 7069 7865 6c5f 7265 6d6f 7661 6c5f 3244  pixel_removal_2D
+00000380: 0a66 726f 6d20 6461 7266 6978 2e63 6f72  .from darfix.cor
+00000390: 652e 696d 6167 654f 7065 7261 7469 6f6e  e.imageOperation
+000003a0: 7320 696d 706f 7274 2074 6872 6573 686f  s import thresho
+000003b0: 6c64 5f72 656d 6f76 616c 2c20 6d61 736b  ld_removal, mask
+000003c0: 5f72 656d 6f76 616c 0a66 726f 6d20 6461  _removal.from da
+000003d0: 7266 6978 2e63 6f72 652e 696d 6167 654f  rfix.core.imageO
+000003e0: 7065 7261 7469 6f6e 7320 696d 706f 7274  perations import
+000003f0: 204d 6574 686f 640a 6672 6f6d 2064 6172   Method.from dar
+00000400: 6669 782e 636f 7265 2e69 6d61 6765 5265  fix.core.imageRe
+00000410: 6769 7374 7261 7469 6f6e 2069 6d70 6f72  gistration impor
+00000420: 7420 7368 6966 745f 6465 7465 6374 696f  t shift_detectio
+00000430: 6e2c 2061 7070 6c79 5f73 6869 6674 0a66  n, apply_shift.f
+00000440: 726f 6d20 6461 7266 6978 2e63 6f72 652e  rom darfix.core.
+00000450: 6d61 7070 696e 6720 696d 706f 7274 2028  mapping import (
+00000460: 0a20 2020 2066 6974 5f64 6174 612c 0a20  .    fit_data,. 
+00000470: 2020 2066 6974 5f32 645f 6461 7461 2c0a     fit_2d_data,.
+00000480: 2020 2020 636f 6d70 7574 655f 6d6f 6d65      compute_mome
+00000490: 6e74 732c 0a20 2020 2063 6f6d 7075 7465  nts,.    compute
+000004a0: 5f72 736d 2c0a 2020 2020 636f 6d70 7574  _rsm,.    comput
+000004b0: 655f 6d61 676e 6966 6963 6174 696f 6e2c  e_magnification,
+000004c0: 0a20 2020 2063 616c 6375 6c61 7465 5f52  .    calculate_R
+000004d0: 534d 5f68 6973 746f 6772 616d 2c0a 2020  SM_histogram,.  
+000004e0: 2020 7265 7363 616c 655f 6461 7461 2c0a    rescale_data,.
+000004f0: 290a 6672 6f6d 2064 6172 6669 782e 636f  ).from darfix.co
+00000500: 7265 2e72 6f69 2069 6d70 6f72 7420 6170  re.roi import ap
+00000510: 706c 795f 3244 5f52 4f49 2c20 6170 706c  ply_2D_ROI, appl
+00000520: 795f 3344 5f52 4f49 0a66 726f 6d20 6461  y_3D_ROI.from da
+00000530: 7266 6978 2e63 6f72 652e 7574 696c 7320  rfix.core.utils 
+00000540: 696d 706f 7274 2077 7261 7054 6f32 7069  import wrapTo2pi
+00000550: 0a66 726f 6d20 6461 7266 6978 2e64 6563  .from darfix.dec
+00000560: 6f6d 706f 7369 7469 6f6e 2e69 7063 6120  omposition.ipca 
+00000570: 696d 706f 7274 2049 5043 410a 6672 6f6d  import IPCA.from
+00000580: 2064 6172 6669 782e 6465 636f 6d70 6f73   darfix.decompos
+00000590: 6974 696f 6e2e 6e6d 6620 696d 706f 7274  ition.nmf import
+000005a0: 204e 4d46 0a66 726f 6d20 6461 7266 6978   NMF.from darfix
+000005b0: 2e64 6563 6f6d 706f 7369 7469 6f6e 2e6e  .decomposition.n
+000005c0: 6963 6120 696d 706f 7274 204e 4943 410a  ica import NICA.
+000005d0: 6672 6f6d 2064 6172 6669 782e 696f 2069  from darfix.io i
+000005e0: 6d70 6f72 7420 7574 696c 7320 6173 2069  mport utils as i
+000005f0: 6f5f 7574 696c 730a 6672 6f6d 2064 6172  o_utils.from dar
+00000600: 6669 782e 636f 7265 2069 6d70 6f72 7420  fix.core import 
+00000610: 6172 7261 795f 7574 696c 730a 0a5f 6c6f  array_utils.._lo
+00000620: 6767 6572 203d 206c 6f67 6769 6e67 2e67  gger = logging.g
+00000630: 6574 4c6f 6767 6572 285f 5f66 696c 655f  etLogger(__file_
+00000640: 5f29 0a0a 0a63 6c61 7373 204f 7065 7261  _)...class Opera
+00000650: 7469 6f6e 2849 6e74 456e 756d 293a 0a20  tion(IntEnum):. 
+00000660: 2020 2022 2222 0a20 2020 2046 6c61 6773     """.    Flags
+00000670: 2066 6f72 2064 6966 6665 7265 6e74 206f   for different o
+00000680: 7065 7261 7469 6f6e 7320 696e 2044 6174  perations in Dat
+00000690: 6173 6574 0a20 2020 2022 2222 0a0a 2020  aset.    """..  
+000006a0: 2020 5041 5254 4954 494f 4e20 3d20 300a    PARTITION = 0.
+000006b0: 2020 2020 4253 203d 2031 0a20 2020 2048      BS = 1.    H
+000006c0: 5020 3d20 320a 2020 2020 5448 5245 5348  P = 2.    THRESH
+000006d0: 4f4c 4420 3d20 330a 2020 2020 5348 4946  OLD = 3.    SHIF
+000006e0: 5420 3d20 340a 2020 2020 524f 4920 3d20  T = 4.    ROI = 
+000006f0: 350a 2020 2020 4d4f 4d45 4e54 5320 3d20  5.    MOMENTS = 
+00000700: 360a 2020 2020 4649 5420 3d20 370a 2020  6.    FIT = 7.  
+00000710: 2020 4249 4e4e 494e 4720 3d20 380a 2020    BINNING = 8.  
+00000720: 2020 4d41 534b 203d 2039 0a0a 0a63 6c61    MASK = 9...cla
+00000730: 7373 205f 5374 6174 654f 664f 7065 7261  ss _StateOfOpera
+00000740: 7469 6f6e 733a 0a20 2020 2064 6566 205f  tions:.    def _
+00000750: 5f69 6e69 745f 5f28 7365 6c66 293a 0a20  _init__(self):. 
+00000760: 2020 2020 2020 2073 656c 662e 5f69 735f         self._is_
+00000770: 7275 6e6e 696e 6720 3d20 5b46 616c 7365  running = [False
+00000780: 5d20 2a20 6c65 6e28 4f70 6572 6174 696f  ] * len(Operatio
+00000790: 6e29 0a0a 2020 2020 6465 6620 5f73 7461  n)..    def _sta
+000007a0: 7274 2873 656c 662c 206f 7065 7261 7469  rt(self, operati
+000007b0: 6f6e 3a20 4f70 7469 6f6e 616c 5b4f 7065  on: Optional[Ope
+000007c0: 7261 7469 6f6e 5d29 202d 3e20 4e6f 6e65  ration]) -> None
+000007d0: 3a0a 2020 2020 2020 2020 6966 206f 7065  :.        if ope
+000007e0: 7261 7469 6f6e 2069 7320 4e6f 6e65 3a0a  ration is None:.
+000007f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00000800: 726e 0a20 2020 2020 2020 2073 656c 662e  rn.        self.
+00000810: 5f69 735f 7275 6e6e 696e 675b 6f70 6572  _is_running[oper
+00000820: 6174 696f 6e5d 203d 2054 7275 650a 0a20  ation] = True.. 
+00000830: 2020 2064 6566 2073 746f 7028 7365 6c66     def stop(self
+00000840: 2c20 6f70 6572 6174 696f 6e3a 204f 7074  , operation: Opt
+00000850: 696f 6e61 6c5b 4f70 6572 6174 696f 6e5d  ional[Operation]
+00000860: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00000870: 2020 2069 6620 6f70 6572 6174 696f 6e20     if operation 
+00000880: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00000890: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+000008a0: 2020 2020 7365 6c66 2e5f 6973 5f72 756e      self._is_run
+000008b0: 6e69 6e67 5b6f 7065 7261 7469 6f6e 5d20  ning[operation] 
+000008c0: 3d20 4661 6c73 650a 0a20 2020 2040 636f  = False..    @co
+000008d0: 6e74 6578 746d 616e 6167 6572 0a20 2020  ntextmanager.   
+000008e0: 2064 6566 2072 756e 5f63 6f6e 7465 7874   def run_context
+000008f0: 2873 656c 662c 206f 7065 7261 7469 6f6e  (self, operation
+00000900: 3a20 4f70 7469 6f6e 616c 5b4f 7065 7261  : Optional[Opera
+00000910: 7469 6f6e 5d29 3a0a 2020 2020 2020 2020  tion]):.        
+00000920: 7365 6c66 2e5f 7374 6172 7428 6f70 6572  self._start(oper
+00000930: 6174 696f 6e29 0a20 2020 2020 2020 2074  ation).        t
+00000940: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00000950: 7969 656c 640a 2020 2020 2020 2020 6669  yield.        fi
+00000960: 6e61 6c6c 793a 0a20 2020 2020 2020 2020  nally:.         
+00000970: 2020 2073 656c 662e 7374 6f70 286f 7065     self.stop(ope
+00000980: 7261 7469 6f6e 290a 0a20 2020 2064 6566  ration)..    def
+00000990: 2069 735f 7275 6e6e 696e 6728 7365 6c66   is_running(self
+000009a0: 2c20 6f70 6572 6174 696f 6e3a 204f 7065  , operation: Ope
+000009b0: 7261 7469 6f6e 2920 2d3e 2062 6f6f 6c3a  ration) -> bool:
+000009c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000009d0: 7365 6c66 2e5f 6973 5f72 756e 6e69 6e67  self._is_running
+000009e0: 5b6f 7065 7261 7469 6f6e 5d0a 0a0a 636c  [operation]...cl
+000009f0: 6173 7320 4461 7461 7365 743a 0a20 2020  ass Dataset:.   
+00000a00: 2022 2222 436c 6173 7320 746f 2064 6566   """Class to def
+00000a10: 696e 6520 6120 6461 7461 7365 7420 6672  ine a dataset fr
+00000a20: 6f6d 2061 2073 6572 6965 7320 6f66 2064  om a series of d
+00000a30: 6174 6120 6669 6c65 732e 0a20 2020 2054  ata files..    T
+00000a40: 6865 2069 6465 6120 6f66 2074 6869 7320  he idea of this 
+00000a50: 636c 6173 7320 6973 2074 6f20 6d61 6b65  class is to make
+00000a60: 206c 6966 6520 6561 7369 6572 2066 6f72   life easier for
+00000a70: 2074 6865 2075 7365 7220 7768 656e 2075   the user when u
+00000a80: 7369 6e67 2064 6172 6669 782e 0a20 2020  sing darfix..   
+00000a90: 204d 6f73 7420 6f66 2074 6865 206f 7065   Most of the ope
+00000aa0: 7261 7469 6f6e 7320 6f6e 2064 6172 6669  rations on darfi
+00000ab0: 7820 6e65 6564 2074 6f20 7573 6520 616c  x need to use al
+00000ac0: 6c20 7468 6520 6461 7461 2074 6f20 6265  l the data to be
+00000ad0: 2063 6f6d 7075 7465 642c 0a20 2020 2068   computed,.    h
+00000ae0: 6176 696e 6720 6120 7772 6170 7065 7220  aving a wrapper 
+00000af0: 6c69 6b65 2044 6174 6173 6574 2061 6c6c  like Dataset all
+00000b00: 6f77 7320 746f 2065 7865 6375 7465 2074  ows to execute t
+00000b10: 6865 206f 7065 7261 7469 6f6e 7320 6f6e  he operations on
+00000b20: 2074 6861 7420 7361 6d65 2064 6174 610a   that same data.
+00000b30: 2020 2020 7769 7468 6f75 7420 6861 7669      without havi
+00000b40: 6e67 2074 6f20 6c6f 6164 2074 6865 2064  ng to load the d
+00000b50: 6174 6120 6174 2065 6163 6820 7374 6570  ata at each step
+00000b60: 2e0a 2020 2020 5468 6973 2069 7320 6e6f  ..    This is no
+00000b70: 7420 6120 476f 6420 6f62 6a65 6374 3a20  t a God object: 
+00000b80: 4f70 6572 6174 696f 6e73 206f 6e20 7468  Operations on th
+00000b90: 6520 736f 7572 6365 2064 6174 6120 2865  e source data (e
+00000ba0: 2e67 2e20 626c 696e 6420 736f 7572 6365  .g. blind source
+00000bb0: 2073 6570 6172 6174 696f 6e2c 2068 6f74   separation, hot
+00000bc0: 2070 6978 656c 2072 656d 6f76 616c 2c0a   pixel removal,.
+00000bd0: 2020 2020 7368 6966 7420 636f 7272 6563      shift correc
+00000be0: 7469 6f6e 2920 6172 6520 696d 706c 656d  tion) are implem
+00000bf0: 656e 7465 6420 6173 2070 7572 6520 7472  ented as pure tr
+00000c00: 616e 7366 6f72 6d61 7469 6f6e 7320 6163  ansformations ac
+00000c10: 7469 6e67 206f 6e20 7468 6973 2065 6e74  ting on this ent
+00000c20: 6974 792c 0a20 2020 2073 7563 6820 7468  ity,.    such th
+00000c30: 6174 2074 6865 7265 2061 7265 206e 6f20  at there are no 
+00000c40: 7369 6465 2065 6666 6563 7473 2061 6e64  side effects and
+00000c50: 2074 6865 206f 7065 7261 7469 6f6e 7320   the operations 
+00000c60: 6361 6e20 6265 2063 6861 696e 6564 2074  can be chained t
+00000c70: 6f67 6574 6865 7220 746f 2064 6566 696e  ogether to defin
+00000c80: 650a 2020 2020 6120 636f 6d70 7574 6174  e.    a computat
+00000c90: 696f 6e61 6c20 776f 726b 666c 6f77 2e0a  ional workflow..
+00000ca0: 2020 2020 416c 7468 6f75 6768 2069 7420      Although it 
+00000cb0: 6973 2061 2063 6f6d 706c 6578 2063 6c61  is a complex cla
+00000cc0: 7373 2064 7565 2074 6f20 7468 6520 6e65  ss due to the ne
+00000cd0: 7874 2074 6869 6e67 733a 0a20 2020 202d  xt things:.    -
+00000ce0: 2054 6865 2064 6174 6120 6361 6e20 6265   The data can be
+00000cf0: 206c 6f61 6465 6420 6f6e 206d 656d 6f72   loaded on memor
+00000d00: 7920 6f72 206f 6e20 6469 736b 2e20 5768  y or on disk. Wh
+00000d10: 656e 2074 6865 2064 6174 6120 6973 206f  en the data is o
+00000d20: 6e20 6469 736b 2c0a 2020 2020 7468 6520  n disk,.    the 
+00000d30: 636f 7265 206f 7065 7261 7469 6f6e 7320  core operations 
+00000d40: 6172 6520 6361 6c6c 6564 2075 7369 6e67  are called using
+00000d50: 2063 6875 6e6b 7320 6f66 2074 6865 2064   chunks of the d
+00000d60: 6174 6120 746f 2072 6564 7563 6520 6974  ata to reduce it
+00000d70: 7320 7369 7a65 206f 6e20 6d65 6d6f 7279  s size on memory
+00000d80: 2e0a 2020 2020 2d20 4120 4461 7461 7365  ..    - A Datase
+00000d90: 7420 616c 6c6f 7773 2074 6865 2075 7365  t allows the use
+00000da0: 7220 746f 2075 7365 206f 6e6c 7920 7061  r to use only pa
+00000db0: 7274 206f 6620 7468 6520 6461 7461 2066  rt of the data f
+00000dc0: 6f72 2063 6572 7461 696e 206f 7065 7261  or certain opera
+00000dd0: 7469 6f6e 732c 0a20 2020 2077 6869 6368  tions,.    which
+00000de0: 2061 6c6c 6f77 7320 746f 2068 6176 6520   allows to have 
+00000df0: 6120 6d75 6368 2066 6173 7465 7220 7072  a much faster pr
+00000e00: 6f63 6573 7369 6e67 206f 6620 7468 6f73  ocessing of thos
+00000e10: 652e 2054 6869 7320 6973 2064 6f6e 6520  e. This is done 
+00000e20: 7573 696e 6720 7468 650a 2020 2020 6069  using the.    `i
+00000e30: 6e64 6963 6573 6020 616e 6420 6062 675f  ndices` and `bg_
+00000e40: 696e 6469 6365 7360 2061 7474 7269 6275  indices` attribu
+00000e50: 7465 732e 0a20 2020 202d 2049 7420 616c  tes..    - It al
+00000e60: 736f 2061 6c6c 6f77 732c 2066 6f72 2063  so allows, for c
+00000e70: 6572 7461 696e 206f 7065 7261 7469 6f6e  ertain operation
+00000e80: 7320 616e 6420 6174 2063 6572 7461 696e  s and at certain
+00000e90: 2063 6173 6573 2c20 746f 2073 746f 7020   cases, to stop 
+00000ea0: 6120 7275 6e6e 696e 6720 6f70 6572 6174  a running operat
+00000eb0: 696f 6e2e 0a20 2020 2054 6869 7320 6973  ion..    This is
+00000ec0: 2064 6f6e 6520 7769 7468 2074 6865 2061   done with the a
+00000ed0: 7474 7269 6275 7465 7320 6072 756e 6e69  ttributes `runni
+00000ee0: 6e67 5f64 6174 6160 2061 6e64 2060 7374  ng_data` and `st
+00000ef0: 6174 655f 6f66 5f6f 7065 7261 7469 6f6e  ate_of_operation
+00000f00: 7360 2c20 7768 6963 680a 2020 2020 636f  s`, which.    co
+00000f10: 6e74 6169 6e20 7468 6520 6044 6174 6160  ntain the `Data`
+00000f20: 206f 626a 6563 7420 7769 7468 2074 6865   object with the
+00000f30: 2064 6174 6120 6265 696e 6720 6d6f 6469   data being modi
+00000f40: 6669 6564 2061 6e64 2061 206c 6973 7420  fied and a list 
+00000f50: 6f66 2074 6865 206f 7065 7261 7469 6f6e  of the operation
+00000f60: 730a 2020 2020 746f 2073 746f 702e 0a20  s.    to stop.. 
+00000f70: 2020 202d 2054 6865 2060 6469 6d73 6020     - The `dims` 
+00000f80: 6174 7472 6962 7574 6520 6973 2061 2064  attribute is a d
+00000f90: 6963 7469 6f6e 6172 7920 636f 6e74 6169  ictionary contai
+00000fa0: 6e69 6e67 2074 6865 2064 696d 656e 7369  ning the dimensi
+00000fb0: 6f6e 7320 7468 6174 0a20 2020 2073 6861  ons that.    sha
+00000fc0: 7065 2074 6865 2064 6174 612e 2053 6576  pe the data. Sev
+00000fd0: 6572 616c 206f 7065 7261 7469 6f6e 7320  eral operations 
+00000fe0: 6361 6e20 6265 2061 7070 6c69 6564 206f  can be applied o
+00000ff0: 6e20 6f6e 6c79 2070 6172 7420 6f66 2074  n only part of t
+00001000: 6865 2064 6174 610a 2020 2020 6465 7065  he data.    depe
+00001010: 6e64 696e 6720 6f6e 2074 6865 2064 696d  nding on the dim
+00001020: 656e 7369 6f6e 7320 7368 6170 652e 0a0a  ensions shape...
+00001030: 2020 2020 3a70 6172 616d 205f 6469 723a      :param _dir:
+00001040: 2047 6c6f 6261 6c20 6469 7265 6374 6f72   Global director
+00001050: 7920 746f 2075 7365 2061 6e64 2073 6176  y to use and sav
+00001060: 6520 616c 6c20 7468 6520 6461 7461 2069  e all the data i
+00001070: 6e20 7468 6520 6469 6666 6572 656e 740a  n the different.
+00001080: 2020 2020 2020 2020 6f70 6572 6174 696f          operatio
+00001090: 6e73 2e0a 2020 2020 3a74 7970 6520 5f64  ns..    :type _d
+000010a0: 6972 3a20 7374 720a 2020 2020 3a70 6172  ir: str.    :par
+000010b0: 616d 2064 6174 613a 2049 6620 6e6f 7420  am data: If not 
+000010c0: 4e6f 6e65 2c20 7365 7473 2074 6865 2044  None, sets the D
+000010d0: 6174 6120 6172 7261 7920 7769 7468 2074  ata array with t
+000010e0: 6865 2064 6174 6120 6f66 2074 6865 2064  he data of the d
+000010f0: 6174 6173 6574 0a20 2020 2020 2020 2074  ataset.        t
+00001100: 6f20 7573 652c 2064 6566 6175 6c74 204e  o use, default N
+00001110: 6f6e 650a 2020 2020 3a74 7970 6520 6461  one.    :type da
+00001120: 7461 3a20 3a63 6c61 7373 3a60 4461 7461  ta: :class:`Data
+00001130: 602c 206f 7074 696f 6e61 6c0a 2020 2020  `, optional.    
+00001140: 3a70 6172 616d 2072 6177 5f66 6f6c 6465  :param raw_folde
+00001150: 723a 2050 6174 6820 746f 2074 6865 2066  r: Path to the f
+00001160: 6f6c 6465 7220 7468 6174 2063 6f6e 7461  older that conta
+00001170: 696e 7320 7468 6520 6461 7461 2c20 6465  ins the data, de
+00001180: 6661 756c 7473 2074 6f0a 2020 2020 2020  faults to.      
+00001190: 2020 4e6f 6e65 0a20 2020 203a 7479 7065    None.    :type
+000011a0: 2072 6177 5f66 6f6c 6465 723a 2055 6e69   raw_folder: Uni
+000011b0: 6f6e 5b4e 6f6e 652c 7374 725d 2c20 6f70  on[None,str], op
+000011c0: 7469 6f6e 616c 0a20 2020 203a 7061 7261  tional.    :para
+000011d0: 6d20 6669 6c65 6e61 6d65 733a 204f 7264  m filenames: Ord
+000011e0: 6572 6564 206c 6973 7420 6f66 2066 696c  ered list of fil
+000011f0: 656e 616d 6573 2c20 6465 6661 756c 7473  enames, defaults
+00001200: 2074 6f20 4e6f 6e65 2028 6578 7065 6374   to None (expect
+00001210: 6564 2066 6f72 2045 4446 2066 696c 6573  ed for EDF files
+00001220: 292e 0a20 2020 203a 7479 7065 2066 696c  )..    :type fil
+00001230: 656e 616d 6573 3a20 556e 696f 6e5b 4765  enames: Union[Ge
+00001240: 6e65 7261 746f 722c 4974 6572 6174 6f72  nerator,Iterator
+00001250: 2c4c 6973 745d 2c20 6f70 7469 6f6e 616c  ,List], optional
+00001260: 0a20 2020 203a 7061 7261 6d20 6469 6d73  .    :param dims
+00001270: 3a20 4469 6d65 6e73 696f 6e73 2064 6963  : Dimensions dic
+00001280: 7469 6f6e 6172 790a 2020 2020 3a74 7970  tionary.    :typ
+00001290: 6520 6469 6d73 3a20 4163 7175 6973 6974  e dims: Acquisit
+000012a0: 696f 6e44 696d 732c 206f 7074 696f 6e61  ionDims, optiona
+000012b0: 6c0a 2020 2020 3a70 6172 616d 2074 7261  l.    :param tra
+000012c0: 6e73 666f 726d 6174 696f 6e3a 2041 7865  nsformation: Axe
+000012d0: 7320 746f 2075 7365 2077 6865 6e20 6469  s to use when di
+000012e0: 7370 6c61 7969 6e67 2074 6865 2069 6d61  splaying the ima
+000012f0: 6765 730a 2020 2020 3a74 7970 6520 7472  ges.    :type tr
+00001300: 616e 7366 6f72 6d61 7469 6f6e 3a20 6e64  ansformation: nd
+00001310: 6172 7261 792c 206f 7074 696f 6e61 6c0a  array, optional.
+00001320: 2020 2020 3a70 6172 616d 2069 6e5f 6d65      :param in_me
+00001330: 6d6f 7279 3a20 4966 2054 7275 652c 2064  mory: If True, d
+00001340: 6174 6120 6973 206c 6f61 6465 6420 696e  ata is loaded in
+00001350: 746f 206d 656d 6f72 792c 2065 6c73 652c  to memory, else,
+00001360: 2064 6174 6120 6973 2072 6561 6420 696e   data is read in
+00001370: 0a20 2020 2020 2020 2063 6875 6e6b 7320  .        chunks 
+00001380: 6465 7065 6e64 696e 6720 6f6e 2074 6865  depending on the
+00001390: 2061 6c67 6f72 6974 686d 2074 6f20 6170   algorithm to ap
+000013a0: 706c 792c 2064 6566 6175 6c74 7320 746f  ply, defaults to
+000013b0: 2046 616c 7365 2e0a 2020 2020 3a74 7970   False..    :typ
+000013c0: 6520 696e 5f6d 656d 6f72 793a 2062 6f6f  e in_memory: boo
+000013d0: 6c2c 206f 7074 696f 6e61 6c0a 2020 2020  l, optional.    
+000013e0: 3a70 6172 616d 2063 6f70 795f 6669 6c65  :param copy_file
+000013f0: 733a 2049 6620 5472 7565 2c20 6372 6561  s: If True, crea
+00001400: 7465 7320 6120 6e65 7720 7472 6561 7465  tes a new treate
+00001410: 6420 6461 7461 2066 6f6c 6465 7220 616e  d data folder an
+00001420: 6420 646f 6573 6e27 7420 7265 706c 6163  d doesn't replac
+00001430: 650a 2020 2020 2020 2020 7468 6520 6469  e.        the di
+00001440: 7265 6374 6f72 7920 6669 6c65 732e 0a20  rectory files.. 
+00001450: 2020 203a 7479 7065 2063 6f70 795f 6669     :type copy_fi
+00001460: 6c65 733a 2062 6f6f 6c2c 206f 7074 696f  les: bool, optio
+00001470: 6e61 6c0a 2020 2020 3a70 6172 616d 2069  nal.    :param i
+00001480: 7348 353a 2054 7275 6520 6966 2074 6865  sH5: True if the
+00001490: 2064 6174 6120 6973 2063 6f6e 7461 696e   data is contain
+000014a0: 696e 6564 2069 6e74 6f20 4844 4635 2066  ined into HDF5 f
+000014b0: 696c 650a 2020 2020 3a70 6172 616d 206d  ile.    :param m
+000014c0: 6574 6164 6174 615f 7572 6c3a 204f 7074  etadata_url: Opt
+000014d0: 696f 6e61 6c20 7572 6c20 746f 2074 6865  ional url to the
+000014e0: 206d 6574 6164 6174 6120 2869 6e20 6361   metadata (in ca
+000014f0: 7365 206f 6620 6e6f 6e2d 4544 4620 6163  se of non-EDF ac
+00001500: 7175 6973 6974 696f 6e29 0a20 2020 2022  quisition).    "
+00001510: 2222 0a0a 2020 2020 6465 6620 5f5f 696e  ""..    def __in
+00001520: 6974 5f5f 280a 2020 2020 2020 2020 7365  it__(.        se
+00001530: 6c66 2c0a 2020 2020 2020 2020 5f64 6972  lf,.        _dir
+00001540: 3a20 7374 722c 0a20 2020 2020 2020 2064  : str,.        d
+00001550: 6174 613d 4e6f 6e65 2c0a 2020 2020 2020  ata=None,.      
+00001560: 2020 7261 775f 666f 6c64 6572 3d4e 6f6e    raw_folder=Non
+00001570: 652c 0a20 2020 2020 2020 2066 6972 7374  e,.        first
+00001580: 5f66 696c 656e 616d 653d 4e6f 6e65 2c0a  _filename=None,.
+00001590: 2020 2020 2020 2020 6669 6c65 6e61 6d65          filename
+000015a0: 733d 4e6f 6e65 2c0a 2020 2020 2020 2020  s=None,.        
+000015b0: 6469 6d73 3d4e 6f6e 652c 0a20 2020 2020  dims=None,.     
+000015c0: 2020 2074 7261 6e73 666f 726d 6174 696f     transformatio
+000015d0: 6e3d 4e6f 6e65 2c0a 2020 2020 2020 2020  n=None,.        
+000015e0: 696e 5f6d 656d 6f72 793d 5472 7565 2c0a  in_memory=True,.
+000015f0: 2020 2020 2020 2020 636f 7079 5f66 696c          copy_fil
+00001600: 6573 3d46 616c 7365 2c0a 2020 2020 2020  es=False,.      
+00001610: 2020 6973 4835 3a20 626f 6f6c 203d 2046    isH5: bool = F
+00001620: 616c 7365 2c0a 2020 2020 2020 2020 7469  alse,.        ti
+00001630: 746c 653a 204f 7074 696f 6e61 6c5b 7374  tle: Optional[st
+00001640: 725d 203d 204e 6f6e 652c 0a20 2020 2020  r] = None,.     
+00001650: 2020 206d 6574 6164 6174 615f 7572 6c3a     metadata_url:
+00001660: 204f 7074 696f 6e61 6c5b 556e 696f 6e5b   Optional[Union[
+00001670: 4461 7461 5572 6c2c 2073 7472 5d5d 203d  DataUrl, str]] =
+00001680: 204e 6f6e 652c 0a20 2020 2029 3a0a 2020   None,.    ):.  
+00001690: 2020 2020 2020 7365 6c66 2e5f 6461 7461        self._data
+000016a0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+000016b0: 7365 6c66 2e5f 6672 616d 6573 5f69 6e74  self._frames_int
+000016c0: 656e 7369 7479 203d 205b 5d0a 2020 2020  ensity = [].    
+000016d0: 2020 2020 7365 6c66 2e72 756e 6e69 6e67      self.running
+000016e0: 5f64 6174 6120 3d20 4e6f 6e65 0a20 2020  _data = None.   
+000016f0: 2020 2020 2073 656c 662e 6d6f 6d65 6e74       self.moment
+00001700: 735f 6469 6d73 203d 207b 7d0a 2020 2020  s_dims = {}.    
+00001710: 2020 2020 7365 6c66 2e73 7461 7465 5f6f      self.state_o
+00001720: 665f 6f70 6572 6174 696f 6e73 203d 205f  f_operations = _
+00001730: 5374 6174 654f 664f 7065 7261 7469 6f6e  StateOfOperation
+00001740: 7328 290a 2020 2020 2020 2020 7365 6c66  s().        self
+00001750: 2e5f 6469 7220 3d20 5f64 6972 0a20 2020  ._dir = _dir.   
+00001760: 2020 2020 2073 656c 662e 5f74 7261 6e73       self._trans
+00001770: 666f 726d 6174 696f 6e20 3d20 7472 616e  formation = tran
+00001780: 7366 6f72 6d61 7469 6f6e 0a20 2020 2020  sformation.     
+00001790: 2020 2073 656c 662e 5f74 6974 6c65 203d     self._title =
+000017a0: 2074 6974 6c65 206f 7220 2222 0a20 2020   title or "".   
+000017b0: 2020 2020 2069 6620 636f 7079 5f66 696c       if copy_fil
+000017c0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+000017d0: 7365 6c66 2e5f 6469 7220 3d20 6f73 2e70  self._dir = os.p
+000017e0: 6174 682e 6a6f 696e 2873 656c 662e 5f64  ath.join(self._d
+000017f0: 6972 2c20 2274 7265 6174 6564 2229 0a20  ir, "treated"). 
+00001800: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00001810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001820: 6f73 2e6d 616b 6564 6972 7328 7365 6c66  os.makedirs(self
+00001830: 2e5f 6469 722c 2065 7869 7374 5f6f 6b3d  ._dir, exist_ok=
+00001840: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+00001850: 2020 6578 6365 7074 2050 6572 6d69 7373    except Permiss
+00001860: 696f 6e45 7272 6f72 3a0a 2020 2020 2020  ionError:.      
+00001870: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00001880: 5065 726d 6973 7369 6f6e 4572 726f 7228  PermissionError(
+00001890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000018a0: 2020 2020 2022 4164 6420 6120 6469 7265       "Add a dire
+000018b0: 6374 6f72 7920 696e 2074 6865 2054 7265  ctory in the Tre
+000018c0: 6174 6564 2044 6174 6120 7461 6220 7769  ated Data tab wi
+000018d0: 7468 2057 5249 5445 2070 6572 6d69 7373  th WRITE permiss
+000018e0: 696f 6e22 0a20 2020 2020 2020 2020 2020  ion".           
+000018f0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00001900: 6966 2064 696d 7320 6973 204e 6f6e 653a  if dims is None:
+00001910: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00001920: 662e 5f5f 6469 6d73 203d 2041 6371 7569  f.__dims = Acqui
+00001930: 7369 7469 6f6e 4469 6d73 2829 0a20 2020  sitionDims().   
+00001940: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00001950: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+00001960: 696e 7374 616e 6365 280a 2020 2020 2020  instance(.      
+00001970: 2020 2020 2020 2020 2020 6469 6d73 2c20            dims, 
+00001980: 4163 7175 6973 6974 696f 6e44 696d 730a  AcquisitionDims.
+00001990: 2020 2020 2020 2020 2020 2020 292c 2022              ), "
+000019a0: 4174 7472 6962 7574 6520 6469 6d73 2068  Attribute dims h
+000019b0: 6173 2074 6f20 6265 206f 6620 636c 6173  as to be of clas
+000019c0: 7320 4163 7175 6973 6974 696f 6e44 696d  s AcquisitionDim
+000019d0: 7322 0a20 2020 2020 2020 2020 2020 2073  s".            s
+000019e0: 656c 662e 5f5f 6469 6d73 203d 2064 696d  elf.__dims = dim
+000019f0: 730a 2020 2020 2020 2020 2320 4b65 7973  s.        # Keys
+00001a00: 3a20 6469 6d65 6e73 696f 6e73 206e 616d  : dimensions nam
+00001a10: 6573 2c20 7661 6c75 6573 3a20 6469 6d65  es, values: dime
+00001a20: 6e73 696f 6e73 2076 616c 7565 730a 2020  nsions values.  
+00001a30: 2020 2020 2020 7365 6c66 2e5f 6469 6d65        self._dime
+00001a40: 6e73 696f 6e73 5f76 616c 7565 7320 3d20  nsions_values = 
+00001a50: 7b7d 0a0a 2020 2020 2020 2020 7365 6c66  {}..        self
+00001a60: 2e5f 696e 5f6d 656d 6f72 7920 3d20 696e  ._in_memory = in
+00001a70: 5f6d 656d 6f72 790a 2020 2020 2020 2020  _memory.        
+00001a80: 7365 6c66 2e5f 6973 4835 203d 2069 7348  self._isH5 = isH
+00001a90: 350a 0a20 2020 2020 2020 2069 6620 6461  5..        if da
+00001aa0: 7461 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ta is not None:.
+00001ab0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00001ac0: 2e5f 6461 7461 203d 2064 6174 610a 2020  ._data = data.  
+00001ad0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00001ae0: 2020 2020 2020 2020 6966 2066 696c 656e          if filen
+00001af0: 616d 6573 2069 7320 4e6f 6e65 2061 6e64  ames is None and
+00001b00: 2066 6972 7374 5f66 696c 656e 616d 6520   first_filename 
+00001b10: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00001b20: 2020 2020 2020 2020 2073 6561 7263 685f           search_
+00001b30: 6469 7220 3d20 5f64 6972 2069 6620 7261  dir = _dir if ra
+00001b40: 775f 666f 6c64 6572 2069 7320 4e6f 6e65  w_folder is None
+00001b50: 2065 6c73 6520 7261 775f 666f 6c64 6572   else raw_folder
+00001b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001b70: 2070 6174 6873 203d 2067 6c6f 622e 676c   paths = glob.gl
+00001b80: 6f62 286f 732e 7061 7468 2e6a 6f69 6e28  ob(os.path.join(
+00001b90: 7365 6172 6368 5f64 6972 2c20 222a 2229  search_dir, "*")
+00001ba0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00001bb0: 2020 6669 6c65 6e61 6d65 7320 3d20 736f    filenames = so
+00001bc0: 7274 6564 285b 7061 7468 2066 6f72 2070  rted([path for p
+00001bd0: 6174 6820 696e 2070 6174 6873 2069 6620  ath in paths if 
+00001be0: 6f73 2e70 6174 682e 6973 6669 6c65 2870  os.path.isfile(p
+00001bf0: 6174 6829 5d29 0a20 2020 2020 2020 2020  ath)]).         
+00001c00: 2020 2073 656c 662e 6669 6c65 6e61 6d65     self.filename
+00001c10: 7320 3d20 6669 6c65 6e61 6d65 730a 2020  s = filenames.  
+00001c20: 2020 2020 2020 2020 2020 7365 6c66 2e66            self.f
+00001c30: 6972 7374 5f66 696c 656e 616d 6520 3d20  irst_filename = 
+00001c40: 6669 7273 745f 6669 6c65 6e61 6d65 0a0a  first_filename..
+00001c50: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00001c60: 656c 662e 5f69 7348 353a 0a20 2020 2020  elf._isH5:.     
+00001c70: 2020 2020 2020 2020 2020 2064 6174 615f             data_
+00001c80: 7572 6c73 2c20 6d65 7461 6461 7461 5f72  urls, metadata_r
+00001c90: 6561 6465 7273 203d 2073 656c 662e 5f69  eaders = self._i
+00001ca0: 6e69 745f 6864 6635 5f64 6174 615f 7572  nit_hdf5_data_ur
+00001cb0: 6c73 280a 2020 2020 2020 2020 2020 2020  ls(.            
+00001cc0: 2020 2020 2020 2020 6669 7273 745f 6669          first_fi
+00001cd0: 6c65 6e61 6d65 2c20 6d65 7461 6461 7461  lename, metadata
+00001ce0: 5f75 726c 0a20 2020 2020 2020 2020 2020  _url.           
+00001cf0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00001d00: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00001d10: 2020 2020 2020 2020 2064 6174 615f 7572           data_ur
+00001d20: 6c73 2c20 6d65 7461 6461 7461 5f72 6561  ls, metadata_rea
+00001d30: 6465 7273 203d 2073 656c 662e 5f69 6e69  ders = self._ini
+00001d40: 745f 696d 6167 655f 6461 7461 5f75 726c  t_image_data_url
+00001d50: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
+00001d60: 2020 2020 2020 2066 6972 7374 5f66 696c         first_fil
+00001d70: 656e 616d 652c 2066 696c 656e 616d 6573  ename, filenames
+00001d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001d90: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+00001da0: 7365 6c66 2e5f 6461 7461 203d 2044 6174  self._data = Dat
+00001db0: 6128 0a20 2020 2020 2020 2020 2020 2020  a(.             
+00001dc0: 2020 206e 756d 7079 2e61 7272 6179 2864     numpy.array(d
+00001dd0: 6174 615f 7572 6c73 292c 0a20 2020 2020  ata_urls),.     
+00001de0: 2020 2020 2020 2020 2020 206d 6574 6164             metad
+00001df0: 6174 613d 6d65 7461 6461 7461 5f72 6561  ata=metadata_rea
+00001e00: 6465 7273 2c0a 2020 2020 2020 2020 2020  ders,.          
+00001e10: 2020 2020 2020 696e 5f6d 656d 6f72 793d        in_memory=
+00001e20: 7365 6c66 2e5f 696e 5f6d 656d 6f72 792c  self._in_memory,
+00001e30: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+00001e40: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
+00001e50: 640a 2020 2020 6465 6620 5f69 6e69 745f  d.    def _init_
+00001e60: 696d 6167 655f 6461 7461 5f75 726c 7328  image_data_urls(
+00001e70: 6669 7273 745f 6669 6c65 6e61 6d65 2c20  first_filename, 
+00001e80: 6669 6c65 6e61 6d65 7329 3a0a 2020 2020  filenames):.    
+00001e90: 2020 2020 2222 2244 6174 6120 5552 4c20      """Data URL 
+00001ea0: 616e 6420 6d65 7461 6461 7461 2072 6561  and metadata rea
+00001eb0: 6465 7220 666f 7220 6561 6368 2069 6d61  der for each ima
+00001ec0: 6765 2069 6e20 6120 6c69 7374 206f 6620  ge in a list of 
+00001ed0: 6669 6c65 7320 286d 6f73 7420 6c69 6b65  files (most like
+00001ee0: 6c79 2045 4446 2922 2222 0a20 2020 2020  ly EDF)""".     
+00001ef0: 2020 206d 6574 6164 6174 615f 7265 6164     metadata_read
+00001f00: 6572 7320 3d20 5b5d 0a20 2020 2020 2020  ers = [].       
+00001f10: 2064 6174 615f 7572 6c73 203d 205b 5d0a   data_urls = [].
+00001f20: 0a20 2020 2020 2020 2077 6974 6820 6661  .        with fa
+00001f30: 6269 6f2e 6f70 656e 5f73 6572 6965 7328  bio.open_series(
+00001f40: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
+00001f50: 656e 616d 6573 3d66 696c 656e 616d 6573  enames=filenames
+00001f60: 2c20 6669 7273 745f 6669 6c65 6e61 6d65  , first_filename
+00001f70: 3d66 6972 7374 5f66 696c 656e 616d 650a  =first_filename.
+00001f80: 2020 2020 2020 2020 2920 6173 2073 6572          ) as ser
+00001f90: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
+00001fa0: 2066 6f72 2066 7261 6d65 2069 6e20 7365   for frame in se
+00001fb0: 7269 6573 2e66 7261 6d65 7328 293a 0a20  ries.frames():. 
+00001fc0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00001fd0: 696c 656e 616d 6520 3d20 6672 616d 652e  ilename = frame.
+00001fe0: 6669 6c65 5f63 6f6e 7461 696e 6572 2e66  file_container.f
+00001ff0: 696c 656e 616d 650a 2020 2020 2020 2020  ilename.        
+00002000: 2020 2020 2020 2020 6461 7461 5f75 726c          data_url
+00002010: 732e 6170 7065 6e64 2844 6174 6155 726c  s.append(DataUrl
+00002020: 2866 696c 655f 7061 7468 3d66 696c 656e  (file_path=filen
+00002030: 616d 652c 2073 6368 656d 653d 2266 6162  ame, scheme="fab
+00002040: 696f 2229 290a 2020 2020 2020 2020 2020  io")).          
+00002050: 2020 2020 2020 6661 6269 6f5f 7265 6164        fabio_read
+00002060: 6572 203d 2066 6162 696f 6835 2e45 6466  er = fabioh5.Edf
+00002070: 4661 6269 6f52 6561 6465 7228 6669 6c65  FabioReader(file
+00002080: 5f6e 616d 653d 6669 6c65 6e61 6d65 290a  _name=filename).
+00002090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000020a0: 6d65 7461 6461 7461 5f72 6561 6465 7273  metadata_readers
+000020b0: 2e61 7070 656e 6428 6661 6269 6f5f 7265  .append(fabio_re
+000020c0: 6164 6572 290a 2020 2020 2020 2020 2020  ader).          
+000020d0: 2020 2020 2020 6661 6269 6f5f 7265 6164        fabio_read
+000020e0: 6572 2e63 6c6f 7365 2829 0a0a 2020 2020  er.close()..    
+000020f0: 2020 2020 7265 7475 726e 2064 6174 615f      return data_
+00002100: 7572 6c73 2c20 6d65 7461 6461 7461 5f72  urls, metadata_r
+00002110: 6561 6465 7273 0a0a 2020 2020 6465 6620  eaders..    def 
+00002120: 5f69 6e69 745f 6864 6635 5f64 6174 615f  _init_hdf5_data_
+00002130: 7572 6c73 280a 2020 2020 2020 2020 7365  urls(.        se
+00002140: 6c66 2c20 6461 7461 5f75 726c 3a20 556e  lf, data_url: Un
+00002150: 696f 6e5b 7374 722c 2044 6174 6155 726c  ion[str, DataUrl
+00002160: 5d2c 206d 6574 6164 6174 615f 7572 6c3a  ], metadata_url:
+00002170: 2055 6e69 6f6e 5b73 7472 2c20 4461 7461   Union[str, Data
+00002180: 5572 6c5d 0a20 2020 2029 3a0a 2020 2020  Url].    ):.    
+00002190: 2020 2020 2222 2244 6174 6120 5552 4c20      """Data URL 
+000021a0: 616e 6420 6d65 7461 6461 7461 2072 6561  and metadata rea
+000021b0: 6465 7220 666f 7220 6561 6368 2069 6d61  der for each ima
+000021c0: 6765 2069 6e20 6120 3344 2048 4446 3520  ge in a 3D HDF5 
+000021d0: 6461 7461 7365 7422 2222 0a20 2020 2020  dataset""".     
+000021e0: 2020 2023 2044 6174 6120 5552 4c20 666f     # Data URL fo
+000021f0: 7220 6561 6368 2069 6d61 6765 0a20 2020  r each image.   
+00002200: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
+00002210: 7374 616e 6365 2864 6174 615f 7572 6c2c  stance(data_url,
+00002220: 2044 6174 6155 726c 293a 0a20 2020 2020   DataUrl):.     
+00002230: 2020 2020 2020 2064 6174 615f 7572 6c20         data_url 
+00002240: 3d20 4461 7461 5572 6c28 6461 7461 5f75  = DataUrl(data_u
+00002250: 726c 290a 0a20 2020 2020 2020 2077 6974  rl)..        wit
+00002260: 6820 7369 6c78 2e69 6f2e 6f70 656e 2864  h silx.io.open(d
+00002270: 6174 615f 7572 6c2e 6669 6c65 5f70 6174  ata_url.file_pat
+00002280: 6828 2929 2061 7320 6835 3a0a 2020 2020  h()) as h5:.    
+00002290: 2020 2020 2020 2020 6864 6635 5f69 7465          hdf5_ite
+000022a0: 6d20 3d20 6835 5b64 6174 615f 7572 6c2e  m = h5[data_url.
+000022b0: 6461 7461 5f70 6174 6828 295d 0a20 2020  data_path()].   
+000022c0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+000022d0: 6973 696e 7374 616e 6365 2868 6466 355f  isinstance(hdf5_
+000022e0: 6974 656d 2c20 6835 7079 2e44 6174 6173  item, h5py.Datas
+000022f0: 6574 293a 0a20 2020 2020 2020 2020 2020  et):.           
+00002300: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00002310: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00002320: 2020 2020 2020 2020 2020 2066 2275 726c             f"url
+00002330: 2064 6174 6120 7061 7468 2069 7320 6e6f   data path is no
+00002340: 7420 706f 696e 7469 6e67 2074 6f20 6120  t pointing to a 
+00002350: 4844 4635 2064 6174 6173 6574 2062 7574  HDF5 dataset but
+00002360: 2074 6f20 7b74 7970 6528 6864 6635 5f69   to {type(hdf5_i
+00002370: 7465 6d29 7d22 0a20 2020 2020 2020 2020  tem)}".         
+00002380: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00002390: 2020 2020 206e 5f66 7261 6d65 7320 3d20       n_frames = 
+000023a0: 6864 6635 5f69 7465 6d2e 7368 6170 655b  hdf5_item.shape[
+000023b0: 305d 0a0a 2020 2020 2020 2020 6461 7461  0]..        data
+000023c0: 5f75 726c 7320 3d20 5b0a 2020 2020 2020  _urls = [.      
+000023d0: 2020 2020 2020 4461 7461 5572 6c28 0a20        DataUrl(. 
+000023e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000023f0: 696c 655f 7061 7468 3d64 6174 615f 7572  ile_path=data_ur
+00002400: 6c2e 6669 6c65 5f70 6174 6828 292c 0a20  l.file_path(),. 
+00002410: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00002420: 6174 615f 7061 7468 3d64 6174 615f 7572  ata_path=data_ur
+00002430: 6c2e 6461 7461 5f70 6174 6828 292c 0a20  l.data_path(),. 
+00002440: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00002450: 6174 615f 736c 6963 653d 692c 0a20 2020  ata_slice=i,.   
+00002460: 2020 2020 2020 2020 2020 2020 2073 6368               sch
+00002470: 656d 653d 2273 696c 7822 2c0a 2020 2020  eme="silx",.    
+00002480: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00002490: 2020 2020 2020 666f 7220 6920 696e 2072        for i in r
+000024a0: 616e 6765 286e 5f66 7261 6d65 7329 0a20  ange(n_frames). 
+000024b0: 2020 2020 2020 205d 0a0a 2020 2020 2020         ]..      
+000024c0: 2020 2320 4d65 7461 6461 7461 2064 6963    # Metadata dic
+000024d0: 7420 6173 736f 6369 6174 6564 2074 6f20  t associated to 
+000024e0: 6561 6368 2069 6d61 6765 0a20 2020 2020  each image.     
+000024f0: 2020 2069 6620 6d65 7461 6461 7461 5f75     if metadata_u
+00002500: 726c 2069 7320 4e6f 6e65 3a0a 2020 2020  rl is None:.    
+00002510: 2020 2020 2020 2020 6672 616d 655f 6d65          frame_me
+00002520: 7461 6461 7461 203d 205b 7b7d 2066 6f72  tadata = [{} for
+00002530: 205f 2069 6e20 7261 6e67 6528 6e5f 6672   _ in range(n_fr
+00002540: 616d 6573 295d 0a20 2020 2020 2020 2065  ames)].        e
+00002550: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00002560: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
+00002570: 6365 286d 6574 6164 6174 615f 7572 6c2c  ce(metadata_url,
+00002580: 2044 6174 6155 726c 293a 0a20 2020 2020   DataUrl):.     
+00002590: 2020 2020 2020 2020 2020 206d 6574 6164             metad
+000025a0: 6174 615f 7572 6c20 3d20 4461 7461 5572  ata_url = DataUr
+000025b0: 6c28 6d65 7461 6461 7461 5f75 726c 290a  l(metadata_url).
+000025c0: 2020 2020 2020 2020 2020 2020 7769 7468              with
+000025d0: 2073 696c 782e 696f 2e6f 7065 6e28 6d65   silx.io.open(me
+000025e0: 7461 6461 7461 5f75 726c 2e66 696c 655f  tadata_url.file_
+000025f0: 7061 7468 2829 2920 6173 2068 353a 0a20  path()) as h5:. 
+00002600: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00002610: 6574 6164 6174 615f 7061 7468 203d 206d  etadata_path = m
+00002620: 6574 6164 6174 615f 7572 6c2e 6461 7461  etadata_url.data
+00002630: 5f70 6174 6828 290a 2020 2020 2020 2020  _path().        
+00002640: 2020 2020 2020 2020 6966 206d 6574 6164          if metad
+00002650: 6174 615f 7061 7468 206e 6f74 2069 6e20  ata_path not in 
+00002660: 6835 3a0a 2020 2020 2020 2020 2020 2020  h5:.            
+00002670: 2020 2020 2020 2020 7261 6973 6520 4b65          raise Ke
+00002680: 7945 7272 6f72 280a 2020 2020 2020 2020  yError(.        
+00002690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000026a0: 6622 556e 6162 6c65 2074 6f20 6669 6e64  f"Unable to find
+000026b0: 206d 6574 6164 6174 6120 7061 7468 207b   metadata path {
+000026c0: 6d65 7461 6461 7461 5f70 6174 687d 2069  metadata_path} i
+000026d0: 6e20 7b6d 6574 6164 6174 615f 7572 6c2e  n {metadata_url.
+000026e0: 6669 6c65 5f70 6174 6828 297d 220a 2020  file_path()}".  
+000026f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002700: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+00002710: 2020 2020 206d 6574 6164 6174 615f 6772       metadata_gr
+00002720: 6f75 7020 3d20 6835 5b6d 6574 6164 6174  oup = h5[metadat
+00002730: 615f 7061 7468 5d0a 2020 2020 2020 2020  a_path].        
+00002740: 2020 2020 2020 2020 6461 7461 7365 7473          datasets
+00002750: 203d 2064 6963 7428 290a 2020 2020 2020   = dict().      
+00002760: 2020 2020 2020 2020 2020 666f 7220 6e61            for na
+00002770: 6d65 2069 6e20 6d65 7461 6461 7461 5f67  me in metadata_g
+00002780: 726f 7570 2e6b 6579 7328 293a 0a20 2020  roup.keys():.   
 00002790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000027a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000027b0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000027c0: 2020 2020 2020 2020 2020 2020 6d65 7461              meta
-000027d0: 6461 7461 2e61 7070 656e 6428 6765 745f  data.append(get_
-000027e0: 6d65 7461 6461 7461 2864 6174 615f 736c  metadata(data_sl
-000027f0: 6963 653d 6929 290a 2020 2020 2020 2020  ice=i)).        
-00002800: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00002810: 2020 2020 2020 2020 2020 7769 7468 2066            with f
-00002820: 6162 696f 2e6f 7065 6e5f 7365 7269 6573  abio.open_series
-00002830: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00002840: 2020 2020 2020 6669 6c65 6e61 6d65 733d        filenames=
-00002850: 6669 6c65 6e61 6d65 732c 2066 6972 7374  filenames, first
-00002860: 5f66 696c 656e 616d 653d 6669 7273 745f  _filename=first_
-00002870: 6669 6c65 6e61 6d65 0a20 2020 2020 2020  filename.       
-00002880: 2020 2020 2020 2020 2029 2061 7320 7365           ) as se
-00002890: 7269 6573 3a0a 2020 2020 2020 2020 2020  ries:.          
-000028a0: 2020 2020 2020 2020 2020 666f 7220 6672            for fr
-000028b0: 616d 6520 696e 2073 6572 6965 732e 6672  ame in series.fr
-000028c0: 616d 6573 2829 3a0a 2020 2020 2020 2020  ames():.        
-000028d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000028e0: 6669 6c65 6e61 6d65 203d 2066 7261 6d65  filename = frame
-000028f0: 2e66 696c 655f 636f 6e74 6169 6e65 722e  .file_container.
-00002900: 6669 6c65 6e61 6d65 0a20 2020 2020 2020  filename.       
-00002910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002920: 2064 6174 615f 7572 6c73 2e61 7070 656e   data_urls.appen
-00002930: 6428 4461 7461 5572 6c28 6669 6c65 5f70  d(DataUrl(file_p
-00002940: 6174 683d 6669 6c65 6e61 6d65 2c20 7363  ath=filename, sc
-00002950: 6865 6d65 3d22 6661 6269 6f22 2929 0a20  heme="fabio")). 
-00002960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002970: 2020 2020 2020 2066 6162 696f 5f72 6561         fabio_rea
-00002980: 6465 7220 3d20 6661 6269 6f68 352e 4564  der = fabioh5.Ed
-00002990: 6646 6162 696f 5265 6164 6572 2866 696c  fFabioReader(fil
-000029a0: 655f 6e61 6d65 3d66 696c 656e 616d 6529  e_name=filename)
-000029b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000029c0: 2020 2020 2020 2020 206d 6574 6164 6174           metadat
-000029d0: 612e 6170 7065 6e64 2866 6162 696f 5f72  a.append(fabio_r
-000029e0: 6561 6465 7229 0a20 2020 2020 2020 2020  eader).         
-000029f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00002a00: 6162 696f 5f72 6561 6465 722e 636c 6f73  abio_reader.clos
-00002a10: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
-00002a20: 7365 6c66 2e5f 6461 7461 203d 2044 6174  self._data = Dat
-00002a30: 6128 0a20 2020 2020 2020 2020 2020 2020  a(.             
-00002a40: 2020 206e 756d 7079 2e61 7272 6179 2864     numpy.array(d
-00002a50: 6174 615f 7572 6c73 292c 206d 6574 6164  ata_urls), metad
-00002a60: 6174 613d 6d65 7461 6461 7461 2c20 696e  ata=metadata, in
-00002a70: 5f6d 656d 6f72 793d 7365 6c66 2e5f 696e  _memory=self._in
-00002a80: 5f6d 656d 6f72 790a 2020 2020 2020 2020  _memory.        
-00002a90: 2020 2020 290a 0a20 2020 2064 6566 2073      )..    def s
-00002aa0: 746f 705f 6f70 6572 6174 696f 6e28 7365  top_operation(se
-00002ab0: 6c66 2c20 6f70 6572 6174 696f 6e29 3a0a  lf, operation):.
-00002ac0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00002ad0: 2020 2020 4d65 7468 6f64 2075 7365 6420      Method used 
-00002ae0: 666f 7220 6361 7365 7320 7768 6572 6520  for cases where 
-00002af0: 7468 7265 6164 7320 6172 6520 6372 6561  threads are crea
-00002b00: 7465 6420 746f 2061 7070 6c79 2066 756e  ted to apply fun
-00002b10: 6374 696f 6e73 2074 6f20 7468 6520 6461  ctions to the da
-00002b20: 7461 7365 742e 0a20 2020 2020 2020 2049  taset..        I
-00002b30: 6620 6d65 7468 6f64 2069 7320 6361 6c6c  f method is call
-00002b40: 6564 2c20 7468 6520 666c 6167 2063 6f6e  ed, the flag con
-00002b50: 6365 726e 696e 6720 7468 6520 7374 6f70  cerning the stop
-00002b60: 2069 7320 7365 7420 746f 2030 2073 6f20   is set to 0 so 
-00002b70: 7468 6174 2069 6620 7468 6520 636f 6e63  that if the conc
-00002b80: 6572 6e65 640a 2020 2020 2020 2020 6f70  erned.        op
-00002b90: 6572 6174 696f 6e20 6973 2072 756e 6e69  eration is runni
-00002ba0: 6e67 2069 6e20 616e 6f74 6865 7220 7468  ng in another th
-00002bb0: 7265 6164 2069 7420 6b6e 6f77 7320 746f  read it knows to
-00002bc0: 2073 746f 702e 0a0a 2020 2020 2020 2020   stop...        
-00002bd0: 3a70 6172 616d 2069 6e74 206f 7065 7261  :param int opera
-00002be0: 7469 6f6e 3a20 6f70 6572 6174 696f 6e20  tion: operation 
-00002bf0: 746f 2073 746f 700a 2020 2020 2020 2020  to stop.        
-00002c00: 3a74 7970 6520 696e 743a 2055 6e69 6f6e  :type int: Union
-00002c10: 5b69 6e74 2c20 604f 7065 7261 7469 6f6e  [int, `Operation
-00002c20: 605d 0a20 2020 2020 2020 2022 2222 0a20  `].        """. 
-00002c30: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
-00002c40: 7461 7465 5f6f 665f 6f70 6572 6174 696f  tate_of_operatio
-00002c50: 6e73 2e69 735f 7275 6e6e 696e 6728 6f70  ns.is_running(op
-00002c60: 6572 6174 696f 6e29 3a0a 2020 2020 2020  eration):.      
-00002c70: 2020 2020 2020 7365 6c66 2e73 7461 7465        self.state
-00002c80: 5f6f 665f 6f70 6572 6174 696f 6e73 2e73  _of_operations.s
-00002c90: 746f 7028 6f70 6572 6174 696f 6e29 0a20  top(operation). 
-00002ca0: 2020 2020 2020 2069 6620 7365 6c66 2e72         if self.r
-00002cb0: 756e 6e69 6e67 5f64 6174 6120 6973 206e  unning_data is n
-00002cc0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00002cd0: 2020 2020 2073 656c 662e 7275 6e6e 696e       self.runnin
-00002ce0: 675f 6461 7461 2e73 746f 705f 6f70 6572  g_data.stop_oper
-00002cf0: 6174 696f 6e28 6f70 6572 6174 696f 6e29  ation(operation)
-00002d00: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-00002d10: 2020 2020 6465 6620 7472 616e 7366 6f72      def transfor
-00002d20: 6d61 7469 6f6e 2873 656c 6629 3a0a 2020  mation(self):.  
-00002d30: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00002d40: 662e 5f74 7261 6e73 666f 726d 6174 696f  f._transformatio
-00002d50: 6e0a 0a20 2020 2040 7472 616e 7366 6f72  n..    @transfor
-00002d60: 6d61 7469 6f6e 2e73 6574 7465 720a 2020  mation.setter.  
-00002d70: 2020 6465 6620 7472 616e 7366 6f72 6d61    def transforma
-00002d80: 7469 6f6e 2873 656c 662c 2076 616c 7565  tion(self, value
-00002d90: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00002da0: 5f74 7261 6e73 666f 726d 6174 696f 6e20  _transformation 
-00002db0: 3d20 7661 6c75 650a 0a20 2020 2040 7072  = value..    @pr
-00002dc0: 6f70 6572 7479 0a20 2020 2064 6566 2074  operty.    def t
-00002dd0: 6974 6c65 2873 656c 6629 3a0a 2020 2020  itle(self):.    
-00002de0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-00002df0: 5f74 6974 6c65 0a0a 2020 2020 4070 726f  _title..    @pro
-00002e00: 7065 7274 790a 2020 2020 6465 6620 6469  perty.    def di
-00002e10: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
-00002e20: 2072 6574 7572 6e20 7365 6c66 2e5f 6469   return self._di
-00002e30: 720a 0a20 2020 2040 7072 6f70 6572 7479  r..    @property
-00002e40: 0a20 2020 2064 6566 2069 735f 6835 2873  .    def is_h5(s
-00002e50: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
-00002e60: 7475 726e 2073 656c 662e 5f69 7348 350a  turn self._isH5.
-00002e70: 0a20 2020 2064 6566 2063 6f6d 7075 7465  .    def compute
-00002e80: 5f66 7261 6d65 735f 696e 7465 6e73 6974  _frames_intensit
-00002e90: 7928 7365 6c66 2c20 6b65 726e 656c 3d28  y(self, kernel=(
-00002ea0: 332c 2033 292c 2073 6967 6d61 3d32 3029  3, 3), sigma=20)
-00002eb0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00002ec0: 2020 2020 2020 5265 7475 726e 7320 666f        Returns fo
-00002ed0: 7220 6576 6572 7920 696d 6167 6520 6120  r every image a 
-00002ee0: 6e75 6d62 6572 2072 6570 7265 7365 6e74  number represent
-00002ef0: 696e 6720 6974 7320 696e 7465 6e73 6974  ing its intensit
-00002f00: 792e 2054 6869 7320 6e75 6d62 6572 0a20  y. This number. 
-00002f10: 2020 2020 2020 2069 7320 6f62 7461 696e         is obtain
-00002f20: 6564 2062 7920 6669 7273 7420 626c 7572  ed by first blur
-00002f30: 7269 6e67 2074 6865 2069 6d61 6765 2061  ring the image a
-00002f40: 6e64 2074 6865 6e20 636f 6d70 7574 696e  nd then computin
-00002f50: 6720 6974 7320 7661 7269 616e 6365 2e0a  g its variance..
-00002f60: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00002f70: 2020 2020 5f6c 6f67 6765 722e 696e 666f      _logger.info
-00002f80: 2822 436f 6d70 7574 696e 6720 696e 7465  ("Computing inte
-00002f90: 6e73 6974 7920 7065 7220 6672 616d 6522  nsity per frame"
-00002fa0: 290a 2020 2020 2020 2020 696f 5f75 7469  ).        io_uti
-00002fb0: 6c73 2e61 6476 616e 6365 6d65 6e74 5f64  ls.advancement_d
-00002fc0: 6973 706c 6179 2830 2c20 7365 6c66 2e6e  isplay(0, self.n
-00002fd0: 6672 616d 6573 2c20 2243 6f6d 7075 7469  frames, "Computi
-00002fe0: 6e67 2069 6e74 656e 7369 7479 2229 0a20  ng intensity"). 
-00002ff0: 2020 2020 2020 2066 7261 6d65 735f 696e         frames_in
-00003000: 7465 6e73 6974 7920 3d20 5b5d 0a20 2020  tensity = [].   
-00003010: 2020 2020 2077 6974 6820 7365 6c66 2e73       with self.s
-00003020: 7461 7465 5f6f 665f 6f70 6572 6174 696f  tate_of_operatio
-00003030: 6e73 2e72 756e 5f63 6f6e 7465 7874 284f  ns.run_context(O
-00003040: 7065 7261 7469 6f6e 2e50 4152 5449 5449  peration.PARTITI
-00003050: 4f4e 293a 0a20 2020 2020 2020 2020 2020  ON):.           
-00003060: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-00003070: 7365 6c66 2e6e 6672 616d 6573 293a 0a20  self.nframes):. 
-00003080: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00003090: 6d70 6f72 7420 6376 320a 0a20 2020 2020  mport cv2..     
-000030a0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-000030b0: 7420 7365 6c66 2e73 7461 7465 5f6f 665f  t self.state_of_
-000030c0: 6f70 6572 6174 696f 6e73 2e69 735f 7275  operations.is_ru
-000030d0: 6e6e 696e 6728 4f70 6572 6174 696f 6e2e  nning(Operation.
-000030e0: 5041 5254 4954 494f 4e29 3a0a 2020 2020  PARTITION):.    
-000030f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003100: 7265 7475 726e 0a20 2020 2020 2020 2020  return.         
-00003110: 2020 2020 2020 2066 7261 6d65 735f 696e         frames_in
-00003120: 7465 6e73 6974 7920 2b3d 205b 0a20 2020  tensity += [.   
-00003130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003140: 2063 7632 2e47 6175 7373 6961 6e42 6c75   cv2.GaussianBlu
-00003150: 7228 7365 6c66 2e67 6574 5f64 6174 6128  r(self.get_data(
-00003160: 6929 2c20 6b65 726e 656c 2c20 7369 676d  i), kernel, sigm
-00003170: 6129 2e76 6172 2829 0a20 2020 2020 2020  a).var().       
-00003180: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
-00003190: 2020 2020 2020 2020 2020 2069 6f5f 7574             io_ut
-000031a0: 696c 732e 6164 7661 6e63 656d 656e 745f  ils.advancement_
-000031b0: 6469 7370 6c61 7928 6920 2b20 312c 2073  display(i + 1, s
-000031c0: 656c 662e 6e66 7261 6d65 732c 2022 436f  elf.nframes, "Co
-000031d0: 6d70 7574 696e 6720 696e 7465 6e73 6974  mputing intensit
-000031e0: 7922 290a 2020 2020 2020 2020 2020 2020  y").            
-000031f0: 7365 6c66 2e5f 6672 616d 6573 5f69 6e74  self._frames_int
-00003200: 656e 7369 7479 203d 2066 7261 6d65 735f  ensity = frames_
-00003210: 696e 7465 6e73 6974 790a 2020 2020 2020  intensity.      
-00003220: 2020 2020 2020 7265 7475 726e 2066 7261        return fra
-00003230: 6d65 735f 696e 7465 6e73 6974 790a 0a20  mes_intensity.. 
-00003240: 2020 2064 6566 2070 6172 7469 7469 6f6e     def partition
-00003250: 5f62 795f 696e 7465 6e73 6974 7928 7365  _by_intensity(se
-00003260: 6c66 2c20 6269 6e73 3d4e 6f6e 652c 2062  lf, bins=None, b
-00003270: 6f74 746f 6d5f 6269 6e3d 4e6f 6e65 2c20  ottom_bin=None, 
-00003280: 746f 705f 6269 6e3d 4e6f 6e65 293a 0a20  top_bin=None):. 
-00003290: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000032a0: 2020 2046 756e 6374 696f 6e20 7468 6174     Function that
-000032b0: 2063 6f6d 7075 7465 7320 7468 6520 6461   computes the da
-000032c0: 7461 2066 726f 6d20 7468 6520 7365 7420  ta from the set 
-000032d0: 6f66 2075 726c 732e 0a20 2020 2020 2020  of urls..       
-000032e0: 2049 6620 7468 6520 6669 6c74 6572 5f64   If the filter_d
-000032f0: 6174 6120 666c 6167 2069 7320 6163 7469  ata flag is acti
-00003300: 7661 7465 6420 6974 2066 696c 7465 7273  vated it filters
-00003310: 2074 6865 2064 6174 6120 666f 6c6c 6f77   the data follow
-00003320: 696e 6720 7468 6520 6e65 7874 3a0a 2020  ing the next:.  
-00003330: 2020 2020 2020 2d2d 2046 6972 7374 2c20        -- First, 
-00003340: 6974 2063 6f6d 7075 7465 7320 7468 6520  it computes the 
-00003350: 696e 7465 6e73 6974 7920 666f 7220 6561  intensity for ea
-00003360: 6368 2066 7261 6d65 2c20 6279 2063 616c  ch frame, by cal
-00003370: 6375 6c61 7469 6e67 2074 6865 2076 6172  culating the var
-00003380: 6961 6e63 6520 6166 7465 720a 2020 2020  iance after.    
-00003390: 2020 2020 7061 7373 696e 6720 6120 6761      passing a ga
-000033a0: 7573 7369 616e 2066 696c 7465 722e 0a20  ussian filter.. 
-000033b0: 2020 2020 2020 202d 2d20 5365 636f 6e64         -- Second
-000033c0: 2c20 636f 6d70 7574 6573 2074 6865 2068  , computes the h
-000033d0: 6973 746f 6772 616d 206f 6620 7468 6520  istogram of the 
-000033e0: 696e 7465 6e73 6974 792e 0a20 2020 2020  intensity..     
-000033f0: 2020 202d 2d20 4669 6e61 6c6c 792c 2073     -- Finally, s
-00003400: 6176 6573 2074 6865 2064 6174 6120 6f66  aves the data of
-00003410: 2074 6865 2066 7261 6d65 7320 7769 7468   the frames with
-00003420: 2061 6e20 696e 7465 6e73 6974 7920 6269   an intensity bi
-00003430: 6767 6572 2074 6861 6e20 6120 7468 7265  gger than a thre
-00003440: 7368 6f6c 642e 0a20 2020 2020 2020 2054  shold..        T
-00003450: 6865 2074 6872 6573 686f 6c64 2069 7320  he threshold is 
-00003460: 7365 7420 746f 2062 6520 7468 6520 7365  set to be the se
-00003470: 636f 6e64 2062 696e 206f 6620 7468 6520  cond bin of the 
-00003480: 6869 7374 6f67 7261 6d2e 0a0a 2020 2020  histogram...    
-00003490: 2020 2020 3a70 6172 616d 2069 6e74 206e      :param int n
-000034a0: 756d 5f62 696e 733a 204e 756d 6265 7220  um_bins: Number 
-000034b0: 6f66 2062 696e 7320 746f 2075 7365 2061  of bins to use a
-000034c0: 7320 7468 7265 7368 6f6c 642e 0a20 2020  s threshold..   
-000034d0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000034e0: 2066 7261 6d65 735f 696e 7465 6e73 6974   frames_intensit
-000034f0: 7920 3d20 280a 2020 2020 2020 2020 2020  y = (.          
-00003500: 2020 7365 6c66 2e5f 6672 616d 6573 5f69    self._frames_i
-00003510: 6e74 656e 7369 7479 0a20 2020 2020 2020  ntensity.       
-00003520: 2020 2020 2069 6620 7365 6c66 2e5f 6672       if self._fr
-00003530: 616d 6573 5f69 6e74 656e 7369 7479 0a20  ames_intensity. 
-00003540: 2020 2020 2020 2020 2020 2065 6c73 6520             else 
-00003550: 7365 6c66 2e63 6f6d 7075 7465 5f66 7261  self.compute_fra
-00003560: 6d65 735f 696e 7465 6e73 6974 7928 290a  mes_intensity().
-00003570: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00003580: 2020 6966 2066 7261 6d65 735f 696e 7465    if frames_inte
-00003590: 6e73 6974 7920 6973 204e 6f6e 653a 0a20  nsity is None:. 
-000035a0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000035b0: 6e0a 2020 2020 2020 2020 7661 6c75 6573  n.        values
-000035c0: 2c20 6269 6e73 203d 206e 756d 7079 2e68  , bins = numpy.h
-000035d0: 6973 746f 6772 616d 280a 2020 2020 2020  istogram(.      
-000035e0: 2020 2020 2020 6672 616d 6573 5f69 6e74        frames_int
-000035f0: 656e 7369 7479 2c20 7365 6c66 2e6e 6672  ensity, self.nfr
-00003600: 616d 6573 2069 6620 6269 6e73 2069 7320  ames if bins is 
-00003610: 4e6f 6e65 2065 6c73 6520 6269 6e73 0a20  None else bins. 
-00003620: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00003630: 2066 7261 6d65 735f 696e 7465 6e73 6974   frames_intensit
-00003640: 7920 3d20 6e75 6d70 792e 6173 616e 7961  y = numpy.asanya
-00003650: 7272 6179 2866 7261 6d65 735f 696e 7465  rray(frames_inte
-00003660: 6e73 6974 7929 0a20 2020 2020 2020 2069  nsity).        i
-00003670: 6620 746f 705f 6269 6e20 6973 204e 6f6e  f top_bin is Non
-00003680: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
-00003690: 6f70 5f62 696e 203d 206c 656e 2862 696e  op_bin = len(bin
-000036a0: 7329 202d 2031 0a20 2020 2020 2020 2069  s) - 1.        i
-000036b0: 6620 626f 7474 6f6d 5f62 696e 2069 7320  f bottom_bin is 
-000036c0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000036d0: 2020 626f 7474 6f6d 5f62 696e 203d 2030    bottom_bin = 0
-000036e0: 0a0a 2020 2020 2020 2020 626f 7474 6f6d  ..        bottom
-000036f0: 5f74 6872 6573 686f 6c64 203d 2066 7261  _threshold = fra
-00003700: 6d65 735f 696e 7465 6e73 6974 7920 3e3d  mes_intensity >=
-00003710: 2062 696e 735b 626f 7474 6f6d 5f62 696e   bins[bottom_bin
-00003720: 5d0a 2020 2020 2020 2020 746f 705f 7468  ].        top_th
-00003730: 7265 7368 6f6c 6420 3d20 6672 616d 6573  reshold = frames
-00003740: 5f69 6e74 656e 7369 7479 203c 3d20 6269  _intensity <= bi
-00003750: 6e73 5b74 6f70 5f62 696e 5d0a 2020 2020  ns[top_bin].    
-00003760: 2020 2020 7468 7265 7368 6f6c 6420 3d20      threshold = 
-00003770: 6e75 6d70 792e 6172 7261 7928 0a20 2020  numpy.array(.   
-00003780: 2020 2020 2020 2020 205b 6120 616e 6420           [a and 
-00003790: 6220 666f 7220 612c 2062 2069 6e20 7a69  b for a, b in zi
-000037a0: 7028 626f 7474 6f6d 5f74 6872 6573 686f  p(bottom_thresho
-000037b0: 6c64 2c20 746f 705f 7468 7265 7368 6f6c  ld, top_threshol
-000037c0: 6429 5d0a 2020 2020 2020 2020 290a 2020  d)].        ).  
-000037d0: 2020 2020 2020 7265 7475 726e 206e 756d        return num
-000037e0: 7079 2e66 6c61 746e 6f6e 7a65 726f 2874  py.flatnonzero(t
-000037f0: 6872 6573 686f 6c64 292c 206e 756d 7079  hreshold), numpy
-00003800: 2e66 6c61 746e 6f6e 7a65 726f 287e 7468  .flatnonzero(~th
-00003810: 7265 7368 6f6c 6429 0a0a 2020 2020 4070  reshold)..    @p
-00003820: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-00003830: 696e 5f6d 656d 6f72 7928 7365 6c66 293a  in_memory(self):
-00003840: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00003850: 7365 6c66 2e5f 696e 5f6d 656d 6f72 790a  self._in_memory.
-00003860: 0a20 2020 2040 696e 5f6d 656d 6f72 792e  .    @in_memory.
-00003870: 7365 7474 6572 0a20 2020 2064 6566 2069  setter.    def i
-00003880: 6e5f 6d65 6d6f 7279 2873 656c 662c 2069  n_memory(self, i
-00003890: 6e5f 6d65 6d6f 7279 293a 0a20 2020 2020  n_memory):.     
-000038a0: 2020 2022 2222 0a20 2020 2020 2020 2052     """.        R
-000038b0: 656d 6f76 6573 2064 6174 6120 6672 6f6d  emoves data from
-000038c0: 206d 656d 6f72 7920 616e 6420 7365 7473   memory and sets
-000038d0: 2074 6861 7420 6672 6f6d 206e 6f77 206f   that from now o
-000038e0: 6e20 6461 7461 2077 696c 6c20 6265 2072  n data will be r
-000038f0: 6561 6420 6672 6f6d 2064 6973 6b2e 0a20  ead from disk.. 
-00003900: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00003910: 2020 2069 6620 7365 6c66 2e5f 696e 5f6d     if self._in_m
-00003920: 656d 6f72 7920 6973 206e 6f74 2069 6e5f  emory is not in_
-00003930: 6d65 6d6f 7279 3a0a 2020 2020 2020 2020  memory:.        
-00003940: 2020 2020 7365 6c66 2e5f 696e 5f6d 656d      self._in_mem
-00003950: 6f72 7920 3d20 696e 5f6d 656d 6f72 790a  ory = in_memory.
-00003960: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00003970: 2e5f 6461 7461 203d 2044 6174 6128 7365  ._data = Data(se
-00003980: 6c66 2e64 6174 612e 7572 6c73 2c20 7365  lf.data.urls, se
-00003990: 6c66 2e64 6174 612e 6d65 7461 6461 7461  lf.data.metadata
-000039a0: 2c20 7365 6c66 2e5f 696e 5f6d 656d 6f72  , self._in_memor
-000039b0: 7929 0a0a 2020 2020 4070 726f 7065 7274  y)..    @propert
-000039c0: 790a 2020 2020 6465 6620 6461 7461 2873  y.    def data(s
-000039d0: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
-000039e0: 7475 726e 2073 656c 662e 5f64 6174 610a  turn self._data.
-000039f0: 0a20 2020 2064 6566 2067 6574 5f64 6174  .    def get_dat
-00003a00: 6128 7365 6c66 2c20 696e 6469 6365 733d  a(self, indices=
-00003a10: 4e6f 6e65 2c20 6469 6d65 6e73 696f 6e3d  None, dimension=
-00003a20: 4e6f 6e65 2c20 7265 7475 726e 5f69 6e64  None, return_ind
-00003a30: 6963 6573 3d46 616c 7365 293a 0a20 2020  ices=False):.   
-00003a40: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00003a50: 2052 6574 7572 6e73 2074 6865 2064 6174   Returns the dat
-00003a60: 6120 636f 7272 6573 706f 6e64 696e 6720  a corresponding 
-00003a70: 746f 2063 6572 7461 696e 7320 696e 6469  to certains indi
-00003a80: 6365 7320 616e 6420 6769 7665 6e20 736f  ces and given so
-00003a90: 6d65 2064 696d 656e 7369 6f6e 7320 7661  me dimensions va
-00003aa0: 6c75 6573 2e0a 2020 2020 2020 2020 5468  lues..        Th
-00003ab0: 6520 6461 7461 2069 7320 616c 7761 7973  e data is always
-00003ac0: 2066 6c61 7474 656e 6564 2074 6f20 6265   flattened to be
-00003ad0: 2061 2073 7461 636b 206f 6620 696d 6167   a stack of imag
-00003ae0: 6573 2e0a 0a20 2020 2020 2020 203a 7061  es...        :pa
-00003af0: 7261 6d20 6172 7261 795f 6c69 6b65 2069  ram array_like i
-00003b00: 6e64 6963 6573 3a20 4966 206e 6f74 204e  ndices: If not N
-00003b10: 6f6e 652c 2064 6174 6120 6973 2066 696c  one, data is fil
-00003b20: 7465 7265 6420 7573 696e 6720 7468 6973  tered using this
-00003b30: 2061 7272 6179 2e0a 2020 2020 2020 2020   array..        
-00003b40: 3a70 6172 616d 2061 7272 6179 5f6c 696b  :param array_lik
-00003b50: 6520 6469 6d65 6e73 696f 6e3a 2049 6620  e dimension: If 
-00003b60: 6e6f 7420 4e6f 6e65 2c20 7265 7475 726e  not None, return
-00003b70: 206f 6e6c 7920 7468 6520 6461 7461 2063   only the data c
-00003b80: 6f72 7265 7370 6f6e 6469 6e67 2074 6f0a  orresponding to.
-00003b90: 2020 2020 2020 2020 2020 2020 7468 6520              the 
-00003ba0: 6769 7665 6e20 6469 6d65 6e73 696f 6e2e  given dimension.
-00003bb0: 2044 696d 656e 7369 6f6e 2069 7320 6120   Dimension is a 
-00003bc0: 3264 2076 6563 746f 722c 2077 6865 7265  2d vector, where
-00003bd0: 2074 6865 2066 6972 7374 2063 6f6d 706f   the first compo
-00003be0: 6e65 6e74 2069 730a 2020 2020 2020 2020  nent is.        
-00003bf0: 2020 2020 6120 6c69 7374 206f 6620 7468      a list of th
-00003c00: 6520 6178 6973 2061 6e64 2074 6865 2073  e axis and the s
-00003c10: 6563 6f6e 6420 6973 2061 206c 6973 7420  econd is a list 
-00003c20: 6f66 2074 6865 2069 6e64 6963 6573 206f  of the indices o
-00003c30: 6620 7468 6520 7661 6c75 6573 2074 6f20  f the values to 
-00003c40: 6578 7472 6163 742e 0a20 2020 2020 2020  extract..       
-00003c50: 2020 2020 2054 6865 2064 696d 656e 7369       The dimensi
-00003c60: 6f6e 2061 6e64 2076 616c 7565 206c 6973  on and value lis
-00003c70: 7420 6c65 6e67 7468 2063 616e 2062 6520  t length can be 
-00003c80: 7570 2074 6f20 7468 6520 6e75 6d62 6572  up to the number
-00003c90: 206f 6620 6469 6d65 6e73 696f 6e73 202d   of dimensions -
-00003ca0: 2031 2e0a 2020 2020 2020 2020 2020 2020   1..            
-00003cb0: 5468 6520 6361 6c6c 2067 6574 5f64 6174  The call get_dat
-00003cc0: 6128 6469 6d65 6e73 696f 6e3d 5b5b 312c  a(dimension=[[1,
-00003cd0: 2032 5d2c 205b 322c 2033 5d5d 2920 6973   2], [2, 3]]) is
-00003ce0: 2065 7175 6976 616c 656e 7420 746f 2064   equivalent to d
-00003cf0: 6174 615b 3a2c 2032 2c20 335d 2077 6865  ata[:, 2, 3] whe
-00003d00: 6e20 6461 7461 0a20 2020 2020 2020 2020  n data.         
-00003d10: 2020 2069 7320 696e 206d 656d 6f72 792e     is in memory.
-00003d20: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
-00003d30: 2061 7869 7320 6f66 2074 6865 2064 696d   axis of the dim
-00003d40: 656e 7369 6f6e 2069 7320 736f 2074 6861  ension is so tha
-00003d50: 7420 6c6f 7765 7220 7468 6520 6178 6973  t lower the axis
-00003d60: 2c20 6661 7374 6573 7420 7468 6520 6469  , fastest the di
-00003d70: 6d65 6e73 696f 6e20 2868 6967 6865 7220  mension (higher 
-00003d80: 6368 616e 6769 6e67 0a20 2020 2020 2020  changing.       
-00003d90: 2020 2020 2076 616c 7565 292e 0a0a 2020       value)...  
-00003da0: 2020 2020 2020 3a72 6574 7572 6e3a 2041        :return: A
-00003db0: 7272 6179 2077 6974 6820 7468 6520 6e65  rray with the ne
-00003dc0: 7720 6461 7461 2e0a 2020 2020 2020 2020  w data..        
-00003dd0: 2222 220a 2020 2020 2020 2020 6966 2064  """.        if d
-00003de0: 696d 656e 7369 6f6e 2069 7320 6e6f 7420  imension is not 
-00003df0: 4e6f 6e65 2061 6e64 206c 656e 2873 656c  None and len(sel
-00003e00: 662e 5f64 6174 612e 7368 6170 6529 203e  f._data.shape) >
-00003e10: 2033 3a0a 2020 2020 2020 2020 2020 2020   3:.            
-00003e20: 2320 4d61 6b65 2073 7572 6520 6469 6d65  # Make sure dime
-00003e30: 6e73 696f 6e20 616e 6420 7661 6c75 6520  nsion and value 
-00003e40: 6172 6520 6c69 7374 730a 2020 2020 2020  are lists.      
-00003e50: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00003e60: 6e63 6528 6469 6d65 6e73 696f 6e5b 305d  nce(dimension[0]
-00003e70: 2c20 696e 7429 3a0a 2020 2020 2020 2020  , int):.        
-00003e80: 2020 2020 2020 2020 6469 6d65 6e73 696f          dimensio
-00003e90: 6e5b 305d 203d 205b 6469 6d65 6e73 696f  n[0] = [dimensio
-00003ea0: 6e5b 305d 5d0a 2020 2020 2020 2020 2020  n[0]].          
-00003eb0: 2020 2020 2020 6469 6d65 6e73 696f 6e5b        dimension[
-00003ec0: 315d 203d 205b 6469 6d65 6e73 696f 6e5b  1] = [dimension[
-00003ed0: 315d 5d0a 2020 2020 2020 2020 2020 2020  1]].            
-00003ee0: 6461 7461 203d 2073 656c 662e 6461 7461  data = self.data
-00003ef0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00003f00: 496e 6974 206c 6973 7420 6f66 2062 6f6f  Init list of boo
-00003f10: 6c20 696e 6469 6365 730a 2020 2020 2020  l indices.      
-00003f20: 2020 2020 2020 626f 6f6c 5f69 6e64 6963        bool_indic
-00003f30: 6573 203d 206e 756d 7079 2e7a 6572 6f73  es = numpy.zeros
-00003f40: 2873 656c 662e 6461 7461 2e6e 6672 616d  (self.data.nfram
-00003f50: 6573 2c20 6474 7970 653d 626f 6f6c 290a  es, dtype=bool).
-00003f60: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00003f70: 6e64 6963 6573 2069 7320 4e6f 6e65 3a0a  ndices is None:.
-00003f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003f90: 696e 6469 6365 7320 3d20 6e75 6d70 792e  indices = numpy.
-00003fa0: 6172 616e 6765 2873 656c 662e 6e66 7261  arange(self.nfra
-00003fb0: 6d65 7329 0a20 2020 2020 2020 2020 2020  mes).           
-00003fc0: 2062 6f6f 6c5f 696e 6469 6365 735b 696e   bool_indices[in
-00003fd0: 6469 6365 735d 203d 2054 7275 650a 2020  dices] = True.  
-00003fe0: 2020 2020 2020 2020 2020 626f 6f6c 5f69            bool_i
-00003ff0: 6e64 6963 6573 203d 2062 6f6f 6c5f 696e  ndices = bool_in
-00004000: 6469 6365 732e 7265 7368 6170 6528 7365  dices.reshape(se
-00004010: 6c66 2e64 6174 612e 7363 616e 5f73 6861  lf.data.scan_sha
-00004020: 7065 290a 2020 2020 2020 2020 2020 2020  pe).            
-00004030: 696e 6478 203d 206e 756d 7079 2e61 7261  indx = numpy.ara
-00004040: 6e67 6528 7365 6c66 2e6e 6672 616d 6573  nge(self.nframes
-00004050: 292e 7265 7368 6170 6528 7365 6c66 2e64  ).reshape(self.d
-00004060: 6174 612e 7363 616e 5f73 6861 7065 290a  ata.scan_shape).
-00004070: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
-00004080: 6f72 2065 7665 7279 2061 7869 732c 2067  or every axis, g
-00004090: 6574 2063 6f72 7265 7370 6f6e 6469 6e67  et corresponding
-000040a0: 2065 6c65 6d65 6e74 730a 2020 2020 2020   elements.      
-000040b0: 2020 2020 2020 666f 7220 692c 2064 696d        for i, dim
-000040c0: 2069 6e20 656e 756d 6572 6174 6528 736f   in enumerate(so
-000040d0: 7274 6564 2864 696d 656e 7369 6f6e 5b30  rted(dimension[0
-000040e0: 5d29 293a 0a20 2020 2020 2020 2020 2020  ])):.           
-000040f0: 2020 2020 2023 2046 6c69 7020 6178 6973       # Flip axis
-00004100: 2074 6f20 6265 2063 6f6e 7369 7374 656e   to be consisten
-00004110: 7420 7769 7468 2074 6865 2064 6174 6120  t with the data 
-00004120: 7368 6170 650a 2020 2020 2020 2020 2020  shape.          
-00004130: 2020 2020 2020 6178 6973 203d 2073 656c        axis = sel
-00004140: 662e 6469 6d73 2e6e 6469 6d20 2d20 6469  f.dims.ndim - di
-00004150: 6d20 2d20 310a 2020 2020 2020 2020 2020  m - 1.          
-00004160: 2020 2020 2020 6461 7461 203d 2064 6174        data = dat
-00004170: 612e 7461 6b65 2869 6e64 6963 6573 3d64  a.take(indices=d
-00004180: 696d 656e 7369 6f6e 5b31 5d5b 695d 2c20  imension[1][i], 
-00004190: 6178 6973 3d61 7869 7329 0a20 2020 2020  axis=axis).     
-000041a0: 2020 2020 2020 2020 2020 2062 6f6f 6c5f             bool_
-000041b0: 696e 6469 6365 7320 3d20 626f 6f6c 5f69  indices = bool_i
-000041c0: 6e64 6963 6573 2e74 616b 6528 696e 6469  ndices.take(indi
-000041d0: 6365 733d 6469 6d65 6e73 696f 6e5b 315d  ces=dimension[1]
-000041e0: 5b69 5d2c 2061 7869 733d 6178 6973 290a  [i], axis=axis).
-000041f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004200: 696e 6478 203d 2069 6e64 782e 7461 6b65  indx = indx.take
-00004210: 2869 6e64 6963 6573 3d64 696d 656e 7369  (indices=dimensi
-00004220: 6f6e 5b31 5d5b 695d 2c20 6178 6973 3d61  on[1][i], axis=a
-00004230: 7869 7329 0a0a 2020 2020 2020 2020 2020  xis)..          
-00004240: 2020 6461 7461 203d 2064 6174 615b 626f    data = data[bo
-00004250: 6f6c 5f69 6e64 6963 6573 5d0a 2020 2020  ol_indices].    
-00004260: 2020 2020 2020 2020 696e 6478 203d 2069          indx = i
-00004270: 6e64 785b 626f 6f6c 5f69 6e64 6963 6573  ndx[bool_indices
-00004280: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
-00004290: 2072 6574 7572 6e5f 696e 6469 6365 733a   return_indices:
-000042a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000042b0: 2072 6574 7572 6e20 6461 7461 2e66 6c61   return data.fla
-000042c0: 7474 656e 2829 2c20 696e 6478 2e66 6c61  tten(), indx.fla
-000042d0: 7474 656e 2829 0a20 2020 2020 2020 2020  tten().         
-000042e0: 2020 2072 6574 7572 6e20 6461 7461 2e66     return data.f
-000042f0: 6c61 7474 656e 2829 0a0a 2020 2020 2020  latten()..      
-00004300: 2020 6461 7461 203d 2073 656c 662e 6461    data = self.da
-00004310: 7461 2e66 6c61 7474 656e 2829 0a20 2020  ta.flatten().   
-00004320: 2020 2020 2069 6620 7265 7475 726e 5f69       if return_i
-00004330: 6e64 6963 6573 3a0a 2020 2020 2020 2020  ndices:.        
-00004340: 2020 2020 6966 2069 6e64 6963 6573 2069      if indices i
-00004350: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00004360: 2020 2020 2020 2020 696e 6469 6365 7320          indices 
-00004370: 3d20 6e75 6d70 792e 6172 616e 6765 2873  = numpy.arange(s
-00004380: 656c 662e 6e66 7261 6d65 7329 0a20 2020  elf.nframes).   
-00004390: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000043a0: 6461 7461 5b69 6e64 6963 6573 5d2c 2069  data[indices], i
-000043b0: 6e64 6963 6573 0a20 2020 2020 2020 2069  ndices.        i
-000043c0: 6620 696e 6469 6365 7320 6973 204e 6f6e  f indices is Non
-000043d0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-000043e0: 6574 7572 6e20 6461 7461 0a20 2020 2020  eturn data.     
-000043f0: 2020 2072 6574 7572 6e20 6461 7461 5b69     return data[i
-00004400: 6e64 6963 6573 5d0a 0a20 2020 2040 7072  ndices]..    @pr
-00004410: 6f70 6572 7479 0a20 2020 2064 6566 206e  operty.    def n
-00004420: 6672 616d 6573 2873 656c 6629 3a0a 2020  frames(self):.  
-00004430: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00004440: 2020 5265 7475 726e 206e 756d 6265 7220    Return number 
-00004450: 6f66 2066 7261 6d65 730a 2020 2020 2020  of frames.      
-00004460: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
-00004470: 2073 656c 662e 6461 7461 2069 7320 4e6f   self.data is No
-00004480: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00004490: 7265 7475 726e 2030 0a20 2020 2020 2020  return 0.       
-000044a0: 2072 6574 7572 6e20 7365 6c66 2e64 6174   return self.dat
-000044b0: 612e 6e66 7261 6d65 730a 0a20 2020 2064  a.nframes..    d
-000044c0: 6566 2074 6f5f 6d65 6d6f 7279 2873 656c  ef to_memory(sel
-000044d0: 662c 2069 6e64 6963 6573 293a 0a20 2020  f, indices):.   
-000044e0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000044f0: 204d 6574 686f 6420 746f 206c 6f61 6420   Method to load 
-00004500: 6f6e 6c79 2070 6172 7420 6f66 2074 6865  only part of the
-00004510: 2064 6174 6120 696e 746f 206d 656d 6f72   data into memor
-00004520: 792e 0a20 2020 2020 2020 2052 6574 7572  y..        Retur
-00004530: 6e73 2061 206e 6577 2064 6174 6173 6574  ns a new dataset
-00004540: 2077 6974 6820 7468 6520 6461 7461 2063   with the data c
-00004550: 6f72 7265 7370 6f6e 6469 6e67 2074 6f20  orresponding to 
-00004560: 6769 7665 6e20 696e 6469 6365 7320 696e  given indices in
-00004570: 746f 206d 656d 6f72 792e 0a20 2020 2020  to memory..     
-00004580: 2020 2054 6865 206e 6577 2069 6e64 6963     The new indic
-00004590: 6573 2061 7272 6179 2068 6173 2074 6f20  es array has to 
-000045a0: 6265 2067 6976 656e 2c20 6966 2061 6c6c  be given, if all
-000045b0: 2074 6865 2064 6174 6120 6861 7320 746f   the data has to
-000045c0: 2062 6520 7365 7420 696e 746f 0a20 2020   be set into.   
-000045d0: 2020 2020 206d 656d 6f72 7920 706c 6561       memory plea
-000045e0: 7365 2073 6574 2060 696e 5f6d 656d 6f72  se set `in_memor
-000045f0: 7960 2074 6f20 5472 7565 2069 6e73 7465  y` to True inste
-00004600: 6164 2c20 7468 6973 2077 6179 206e 6f20  ad, this way no 
-00004610: 6e65 7720 6461 7461 7365 7420 7769 6c6c  new dataset will
-00004620: 2062 650a 2020 2020 2020 2020 6372 6561   be.        crea
-00004630: 7465 642e 0a0a 2020 2020 2020 2020 3a70  ted...        :p
-00004640: 6172 616d 2061 7272 6179 5f6c 696b 6520  aram array_like 
-00004650: 696e 6469 6365 733a 2049 6e64 6963 6573  indices: Indices
-00004660: 206f 6620 7468 6520 6e65 7720 6461 7461   of the new data
-00004670: 7365 742e 0a20 2020 2020 2020 2022 2222  set..        """
-00004680: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00004690: 7365 6c66 2e5f 696e 5f6d 656d 6f72 793a  self._in_memory:
-000046a0: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-000046b0: 6120 3d20 7365 6c66 2e67 6574 5f64 6174  a = self.get_dat
-000046c0: 6128 696e 6469 6365 7329 0a20 2020 2020  a(indices).     
-000046d0: 2020 2020 2020 206e 6577 5f64 6174 6120         new_data 
-000046e0: 3d20 4461 7461 2864 6174 612e 7572 6c73  = Data(data.urls
-000046f0: 2c20 6461 7461 2e6d 6574 6164 6174 612c  , data.metadata,
-00004700: 2054 7275 6529 0a20 2020 2020 2020 2065   True).        e
-00004710: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00004720: 206e 6577 5f64 6174 6120 3d20 7365 6c66   new_data = self
-00004730: 2e67 6574 5f64 6174 6128 696e 6469 6365  .get_data(indice
-00004740: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
-00004750: 6e20 4461 7461 7365 7428 0a20 2020 2020  n Dataset(.     
-00004760: 2020 2020 2020 205f 6469 723d 7365 6c66         _dir=self
-00004770: 2e5f 6469 722c 0a20 2020 2020 2020 2020  ._dir,.         
-00004780: 2020 2064 6174 613d 6e65 775f 6461 7461     data=new_data
-00004790: 2c0a 2020 2020 2020 2020 2020 2020 6469  ,.            di
-000047a0: 6d73 3d73 656c 662e 5f5f 6469 6d73 2c0a  ms=self.__dims,.
-000047b0: 2020 2020 2020 2020 2020 2020 696e 5f6d              in_m
-000047c0: 656d 6f72 793d 5472 7565 2c0a 2020 2020  emory=True,.    
-000047d0: 2020 2020 2020 2020 7469 746c 653d 7365          title=se
-000047e0: 6c66 2e74 6974 6c65 2c0a 2020 2020 2020  lf.title,.      
-000047f0: 2020 290a 0a20 2020 2040 7072 6f70 6572    )..    @proper
-00004800: 7479 0a20 2020 2064 6566 2064 696d 7328  ty.    def dims(
-00004810: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
-00004820: 6574 7572 6e20 7365 6c66 2e5f 5f64 696d  eturn self.__dim
-00004830: 730a 0a20 2020 2040 6469 6d73 2e73 6574  s..    @dims.set
-00004840: 7465 720a 2020 2020 6465 6620 6469 6d73  ter.    def dims
-00004850: 2873 656c 662c 205f 6469 6d73 293a 0a20  (self, _dims):. 
-00004860: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-00004870: 696e 7374 616e 6365 285f 6469 6d73 2c20  instance(_dims, 
-00004880: 4163 7175 6973 6974 696f 6e44 696d 7329  AcquisitionDims)
-00004890: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-000048a0: 2244 696d 656e 7369 6f6e 7320 6469 6374  "Dimensions dict
-000048b0: 696f 6e61 7279 2068 6173 2022 2022 746f  ionary has " "to
-000048c0: 2062 6520 6f66 2063 6c61 7373 2060 4163   be of class `Ac
-000048d0: 7175 6973 6974 696f 6e44 696d 7360 220a  quisitionDims`".
-000048e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000048f0: 2020 7365 6c66 2e5f 5f64 696d 7320 3d20    self.__dims = 
-00004900: 5f64 696d 730a 0a20 2020 2064 6566 2063  _dims..    def c
-00004910: 6c65 6172 5f64 696d 7328 7365 6c66 293a  lear_dims(self):
-00004920: 0a20 2020 2020 2020 2073 656c 662e 5f5f  .        self.__
-00004930: 6469 6d73 203d 2041 6371 7569 7369 7469  dims = Acquisiti
-00004940: 6f6e 4469 6d73 2829 0a0a 2020 2020 6465  onDims()..    de
-00004950: 6620 6164 645f 6469 6d28 7365 6c66 2c20  f add_dim(self, 
-00004960: 6178 6973 2c20 6469 6d29 3a0a 2020 2020  axis, dim):.    
-00004970: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00004980: 4164 6473 2061 2064 696d 656e 7369 6f6e  Adds a dimension
-00004990: 2074 6f20 7468 6520 6469 6d65 6e73 696f   to the dimensio
-000049a0: 6e27 7320 6469 6374 696f 6e61 7279 2e0a  n's dictionary..
-000049b0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-000049c0: 696e 7420 6178 6973 3a20 6178 6973 206f  int axis: axis o
-000049d0: 6620 7468 6520 6469 6d65 6e73 696f 6e2e  f the dimension.
-000049e0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-000049f0: 6044 696d 656e 7369 6f6e 6020 6469 6d3a  `Dimension` dim:
-00004a00: 2064 696d 656e 7369 6f6e 2074 6f20 6265   dimension to be
-00004a10: 2061 6464 6564 2e0a 2020 2020 2020 2020   added..        
-00004a20: 2222 220a 2020 2020 2020 2020 7365 6c66  """.        self
-00004a30: 2e5f 5f64 696d 732e 6164 645f 6469 6d28  .__dims.add_dim(
-00004a40: 6178 6973 2c20 6469 6d29 0a0a 2020 2020  axis, dim)..    
-00004a50: 6465 6620 7265 6d6f 7665 5f64 696d 2873  def remove_dim(s
-00004a60: 656c 662c 2061 7869 7329 3a0a 2020 2020  elf, axis):.    
-00004a70: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00004a80: 5265 6d6f 7665 7320 6120 6469 6d65 6e73  Removes a dimens
-00004a90: 696f 6e20 6672 6f6d 2074 6865 2064 696d  ion from the dim
-00004aa0: 656e 7369 6f6e 2773 2064 6963 7469 6f6e  ension's diction
-00004ab0: 6172 792e 0a0a 2020 2020 2020 2020 3a70  ary...        :p
-00004ac0: 6172 616d 2069 6e74 2061 7869 733a 2061  aram int axis: a
-00004ad0: 7869 7320 6f66 2074 6865 2064 696d 656e  xis of the dimen
-00004ae0: 7369 6f6e 2e0a 2020 2020 2020 2020 2222  sion..        ""
-00004af0: 220a 2020 2020 2020 2020 7365 6c66 2e5f  ".        self._
-00004b00: 5f64 696d 732e 7265 6d6f 7665 5f64 696d  _dims.remove_dim
-00004b10: 2861 7869 7329 0a0a 2020 2020 6465 6620  (axis)..    def 
-00004b20: 7a73 756d 2873 656c 662c 2069 6e64 6963  zsum(self, indic
-00004b30: 6573 3d4e 6f6e 652c 2064 696d 656e 7369  es=None, dimensi
-00004b40: 6f6e 3d4e 6f6e 6529 3a0a 2020 2020 2020  on=None):.      
-00004b50: 2020 6461 7461 203d 2073 656c 662e 6765    data = self.ge
-00004b60: 745f 6461 7461 2869 6e64 6963 6573 2c20  t_data(indices, 
-00004b70: 6469 6d65 6e73 696f 6e29 0a20 2020 2020  dimension).     
-00004b80: 2020 2072 6574 7572 6e20 6461 7461 2e73     return data.s
-00004b90: 756d 2861 7869 733d 3029 0a0a 2020 2020  um(axis=0)..    
-00004ba0: 6465 6620 7265 7368 6170 655f 6461 7461  def reshape_data
-00004bb0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00004bc0: 2222 220a 2020 2020 2020 2020 4675 6e63  """.        Func
-00004bd0: 7469 6f6e 2074 6861 7420 7265 7368 6170  tion that reshap
-00004be0: 6573 2074 6865 2064 6174 6120 746f 2066  es the data to f
-00004bf0: 6974 2074 6865 2064 696d 656e 7369 6f6e  it the dimension
-00004c00: 732e 0a20 2020 2020 2020 2022 2222 0a20  s..        """. 
-00004c10: 2020 2020 2020 206e 6469 6d20 3d20 7365         ndim = se
-00004c20: 6c66 2e5f 5f64 696d 732e 6e64 696d 0a20  lf.__dims.ndim. 
-00004c30: 2020 2020 2020 2069 6620 6e64 696d 203d         if ndim =
-00004c40: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-00004c50: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00004c60: 7228 224e 6f20 6469 6d65 6e73 696f 6e73  r("No dimensions
-00004c70: 2061 7265 206c 6973 7465 6422 290a 0a20   are listed").. 
-00004c80: 2020 2020 2020 2069 6620 6e64 696d 203d         if ndim =
-00004c90: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
-00004ca0: 206e 6672 616d 6573 5f65 7870 6563 7465   nframes_expecte
-00004cb0: 6420 3d20 7365 6c66 2e5f 5f64 696d 732e  d = self.__dims.
-00004cc0: 6765 7428 3029 2e73 697a 650a 2020 2020  get(0).size.    
-00004cd0: 2020 2020 2020 2020 6966 206e 6672 616d          if nfram
-00004ce0: 6573 5f65 7870 6563 7465 6420 213d 2073  es_expected != s
-00004cf0: 656c 662e 6e66 7261 6d65 733a 0a20 2020  elf.nframes:.   
-00004d00: 2020 2020 2020 2020 2020 2020 2064 696d               dim
-00004d10: 656e 7369 6f6e 203d 2022 2022 2e6a 6f69  ension = " ".joi
-00004d20: 6e28 7365 6c66 2e5f 5f64 696d 732e 6765  n(self.__dims.ge
-00004d30: 745f 6e61 6d65 7328 2929 0a20 2020 2020  t_names()).     
-00004d40: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00004d50: 2056 616c 7565 4572 726f 7228 0a20 2020   ValueError(.   
-00004d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004d70: 2066 2244 696d 656e 7369 6f6e 207b 6469   f"Dimension {di
-00004d80: 6d65 6e73 696f 6e7d 2068 6173 207b 6e66  mension} has {nf
-00004d90: 7261 6d65 735f 6578 7065 6374 6564 7d20  rames_expected} 
-00004da0: 706f 696e 7473 2077 6869 6c65 2074 6865  points while the
-00004db0: 7265 2061 7265 207b 7365 6c66 2e6e 6672  re are {self.nfr
-00004dc0: 616d 6573 7d20 696d 6167 6573 2e20 5472  ames} images. Tr
-00004dd0: 7920 7573 696e 6720 6f74 6865 7220 746f  y using other to
-00004de0: 6c65 7261 6e63 6520 6f72 2073 7465 7020  lerance or step 
-00004df0: 7661 6c75 6573 2e22 0a20 2020 2020 2020  values.".       
-00004e00: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00004e10: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00004e20: 6c66 0a0a 2020 2020 2020 2020 6469 6d73  lf..        dims
-00004e30: 5f73 6861 7065 203d 2073 656c 662e 5f5f  _shape = self.__
-00004e40: 6469 6d73 2e73 6861 7065 0a20 2020 2020  dims.shape.     
-00004e50: 2020 206f 7267 5f64 6174 6120 3d20 7365     org_data = se
-00004e60: 6c66 2e67 6574 5f64 6174 6128 290a 2020  lf.get_data().  
-00004e70: 2020 2020 2020 6f72 675f 7368 6170 6520        org_shape 
-00004e80: 3d20 6f72 675f 6461 7461 2e73 6861 7065  = org_data.shape
-00004e90: 0a20 2020 2020 2020 2069 6d67 5f73 6861  .        img_sha
-00004ea0: 7065 203d 2028 6f72 675f 7368 6170 655b  pe = (org_shape[
-00004eb0: 2d32 5d2c 206f 7267 5f73 6861 7065 5b2d  -2], org_shape[-
-00004ec0: 315d 290a 2020 2020 2020 2020 6e65 775f  1]).        new_
-00004ed0: 7368 6170 6520 3d20 6469 6d73 5f73 6861  shape = dims_sha
-00004ee0: 7065 202b 2069 6d67 5f73 6861 7065 0a20  pe + img_shape. 
-00004ef0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00004f00: 2020 2020 2020 2020 6461 7461 203d 206f          data = o
-00004f10: 7267 5f64 6174 612e 7265 7368 6170 6528  rg_data.reshape(
-00004f20: 6e65 775f 7368 6170 6529 0a20 2020 2020  new_shape).     
-00004f30: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-00004f40: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
-00004f50: 2064 696d 656e 7369 6f6e 7320 3d20 2220   dimensions = " 
-00004f60: 222e 6a6f 696e 2873 656c 662e 5f5f 6469  ".join(self.__di
-00004f70: 6d73 2e67 6574 5f6e 616d 6573 2829 290a  ms.get_names()).
-00004f80: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00004f90: 6520 5661 6c75 6545 7272 6f72 280a 2020  e ValueError(.  
-00004fa0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00004fb0: 4469 6d65 6e73 696f 6e73 207b 6469 6d65  Dimensions {dime
-00004fc0: 6e73 696f 6e73 7d20 6861 7665 207b 6469  nsions} have {di
-00004fd0: 6d73 5f73 6861 7065 7d20 706f 696e 7473  ms_shape} points
-00004fe0: 2077 6869 6c65 2074 6865 7265 2061 7265   while there are
-00004ff0: 207b 6f72 675f 7368 6170 655b 3a2d 325d   {org_shape[:-2]
-00005000: 7d20 696d 6167 6573 2e20 5472 7920 7573  } images. Try us
-00005010: 696e 6720 6f74 6865 7220 746f 6c65 7261  ing other tolera
-00005020: 6e63 6520 6f72 2073 7465 7020 7661 6c75  nce or step valu
-00005030: 6573 2e22 0a20 2020 2020 2020 2020 2020  es.".           
-00005040: 2029 0a0a 2020 2020 2020 2020 7265 7475   )..        retu
-00005050: 726e 2044 6174 6173 6574 280a 2020 2020  rn Dataset(.    
-00005060: 2020 2020 2020 2020 5f64 6972 3d73 656c          _dir=sel
-00005070: 662e 6469 722c 0a20 2020 2020 2020 2020  f.dir,.         
-00005080: 2020 2064 6174 613d 6461 7461 2c0a 2020     data=data,.  
-00005090: 2020 2020 2020 2020 2020 6469 6d73 3d73            dims=s
-000050a0: 656c 662e 5f5f 6469 6d73 2c0a 2020 2020  elf.__dims,.    
-000050b0: 2020 2020 2020 2020 696e 5f6d 656d 6f72          in_memor
-000050c0: 793d 7365 6c66 2e5f 696e 5f6d 656d 6f72  y=self._in_memor
-000050d0: 792c 0a20 2020 2020 2020 2020 2020 2074  y,.            t
-000050e0: 6974 6c65 3d73 656c 662e 7469 746c 652c  itle=self.title,
-000050f0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00005100: 6465 6620 6669 6e64 5f64 696d 656e 7369  def find_dimensi
-00005110: 6f6e 7328 7365 6c66 2c20 6b69 6e64 2c20  ons(self, kind, 
-00005120: 746f 6c65 7261 6e63 653d 3165 2d39 2920  tolerance=1e-9) 
-00005130: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00005140: 2022 2222 0a20 2020 2020 2020 2047 6f65   """.        Goe
-00005150: 7320 6f76 6572 2061 6c6c 2074 6865 2068  s over all the h
-00005160: 6561 6465 7273 2066 726f 6d20 6120 6769  eaders from a gi
-00005170: 7665 6e20 6b69 6e64 2061 6e64 2066 696e  ven kind and fin
-00005180: 6473 2074 6865 2064 696d 656e 7369 6f6e  ds the dimension
-00005190: 730a 2020 2020 2020 2020 7468 6174 206d  s.        that m
-000051a0: 6f76 6520 2868 6176 6520 6d6f 7265 2074  ove (have more t
-000051b0: 6861 6e20 6f6e 6520 7661 6c75 6529 2061  han one value) a
-000051c0: 6c6f 6e67 2074 6865 2064 6174 612e 0a0a  long the data...
-000051d0: 2020 2020 2020 2020 4e6f 7465 3a20 4265          Note: Be
-000051e0: 666f 7265 2c20 6f6e 6c79 2074 6865 2064  fore, only the d
-000051f0: 696d 656e 7369 6f6e 7320 7468 6174 2063  imensions that c
-00005200: 6f75 6c64 2066 6974 2077 6865 7265 2073  ould fit where s
-00005210: 686f 776e 2c20 6e6f 7720 6974 0a20 2020  hown, now it.   
-00005220: 2020 2020 2073 686f 7773 2061 6c6c 2074       shows all t
-00005230: 6865 2064 696d 656e 7369 6f6e 7320 616e  he dimensions an
-00005240: 6420 6c65 7420 7468 6520 7573 6572 2063  d let the user c
-00005250: 686f 6f73 6520 7468 6520 7661 6c69 6420  hoose the valid 
-00005260: 6f6e 6573 2e0a 0a20 2020 2020 2020 203a  ones...        :
-00005270: 7061 7261 6d20 696e 7420 6b69 6e64 3a20  param int kind: 
-00005280: 5479 7065 206f 6620 6d65 7461 6461 7461  Type of metadata
-00005290: 2074 6f20 6669 6e64 2074 6865 2064 696d   to find the dim
-000052a0: 656e 7369 6f6e 732e 0a20 2020 2020 2020  ensions..       
-000052b0: 203a 7061 7261 6d20 666c 6f61 7420 746f   :param float to
-000052c0: 6c65 7261 6e63 653a 2054 6f6c 6572 616e  lerance: Toleran
-000052d0: 6365 2074 6861 7420 7769 6c6c 2062 6520  ce that will be 
-000052e0: 7573 6564 2074 6f20 636f 6d70 7574 6520  used to compute 
-000052f0: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
-00005300: 756e 6971 7565 2076 616c 7565 732e 0a20  unique values.. 
-00005310: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00005320: 2020 2073 656c 662e 5f5f 6469 6d73 2e63     self.__dims.c
-00005330: 6c65 6172 2829 0a20 2020 2020 2020 2073  lear().        s
-00005340: 656c 662e 5f64 696d 656e 7369 6f6e 735f  elf._dimensions_
-00005350: 7661 6c75 6573 203d 207b 7d0a 0a20 2020  values = {}..   
-00005360: 2020 2020 206b 6579 7320 3d20 6e75 6d70       keys = nump
-00005370: 792e 6172 7261 7928 6c69 7374 2873 656c  y.array(list(sel
-00005380: 662e 6461 7461 2e6d 6574 6164 6174 615b  f.data.metadata[
-00005390: 305d 2e67 6574 5f6b 6579 7328 6b69 6e64  0].get_keys(kind
-000053a0: 2929 290a 2020 2020 2020 2020 7661 6c75  ))).        valu
-000053b0: 6573 203d 206e 756d 7079 2e61 7361 7272  es = numpy.asarr
-000053c0: 6179 280a 2020 2020 2020 2020 2020 2020  ay(.            
-000053d0: 5b73 656c 662e 6765 745f 6d65 7461 6461  [self.get_metada
-000053e0: 7461 5f76 616c 7565 7328 6b69 6e64 3d6b  ta_values(kind=k
-000053f0: 696e 642c 206b 6579 3d6b 6579 2920 666f  ind, key=key) fo
-00005400: 7220 6b65 7920 696e 206b 6579 735d 0a20  r key in keys]. 
-00005410: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00005420: 2023 2055 6e69 7175 6520 7661 6c75 6573   # Unique values
-00005430: 2066 6f72 2065 6163 6820 6b65 792e 0a20   for each key.. 
-00005440: 2020 2020 2020 2075 6e69 7175 655f 7661         unique_va
-00005450: 6c75 6573 203d 205b 0a20 2020 2020 2020  lues = [.       
-00005460: 2020 2020 206e 756d 7079 2e75 6e69 7175       numpy.uniqu
-00005470: 6528 7661 6c75 652c 2072 6574 7572 6e5f  e(value, return_
-00005480: 696e 6465 783d 5472 7565 2c20 7265 7475  index=True, retu
-00005490: 726e 5f63 6f75 6e74 733d 5472 7565 290a  rn_counts=True).
-000054a0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000054b0: 7661 6c75 6520 696e 2076 616c 7565 730a  value in values.
-000054c0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-000054d0: 2020 6469 6d65 6e73 696f 6e73 203d 205b    dimensions = [
-000054e0: 5d0a 2020 2020 2020 2020 6461 7461 7365  ].        datase
-000054f0: 745f 7369 7a65 203d 206c 656e 2873 656c  t_size = len(sel
-00005500: 662e 6461 7461 2e6d 6574 6164 6174 6129  f.data.metadata)
-00005510: 0a20 2020 2020 2020 2023 2046 6f72 2065  .        # For e
-00005520: 7665 7279 206b 6579 2074 6861 7420 6861  very key that ha
-00005530: 7320 6d6f 7265 2074 6861 6e20 6f6e 6520  s more than one 
-00005540: 6469 6666 6572 656e 7420 7661 6c75 652c  different value,
-00005550: 2063 7265 6174 6573 2061 206e 6577 2044   creates a new D
-00005560: 696d 656e 7369 6f6e 2e0a 2020 2020 2020  imension..      
-00005570: 2020 666f 7220 692c 2076 616c 7565 2069    for i, value i
-00005580: 6e20 656e 756d 6572 6174 6528 756e 6971  n enumerate(uniq
-00005590: 7565 5f76 616c 7565 7329 3a0a 2020 2020  ue_values):.    
-000055a0: 2020 2020 2020 2020 6966 2076 616c 7565          if value
-000055b0: 5b32 5d5b 305d 2021 3d20 6461 7461 7365  [2][0] != datase
-000055c0: 745f 7369 7a65 3a0a 2020 2020 2020 2020  t_size:.        
-000055d0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-000055e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000055f0: 2064 696d 656e 7369 6f6e 203d 2044 696d   dimension = Dim
-00005600: 656e 7369 6f6e 286b 696e 642c 206b 6579  ension(kind, key
-00005610: 735b 695d 2c20 746f 6c65 7261 6e63 653d  s[i], tolerance=
-00005620: 746f 6c65 7261 6e63 6529 0a20 2020 2020  tolerance).     
-00005630: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00005640: 696d 656e 7369 6f6e 2e73 6574 5f75 6e69  imension.set_uni
-00005650: 7175 655f 7661 6c75 6573 280a 2020 2020  que_values(.    
-00005660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005670: 2020 2020 6e75 6d70 792e 6172 7261 7928      numpy.array(
-00005680: 7661 6c75 6573 5b69 5d5b 6e75 6d70 792e  values[i][numpy.
-00005690: 736f 7274 2876 616c 7565 5b31 5d29 5d2c  sort(value[1])],
-000056a0: 2064 7479 7065 3d66 6c6f 6174 290a 2020   dtype=float).  
-000056b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000056c0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-000056d0: 2020 2020 2020 2020 2320 5661 6c75 6520          # Value 
-000056e0: 7468 6174 2074 656c 6c73 2077 6865 6e20  that tells when 
-000056f0: 646f 6573 2074 6865 2063 6861 6e67 6520  does the change 
-00005700: 6f66 2076 616c 7565 206f 6363 7572 2e20  of value occur. 
-00005710: 4974 2069 7320 7573 6564 2074 6f20 6b6e  It is used to kn
-00005720: 6f77 2074 6865 206f 7264 6572 0a20 2020  ow the order.   
-00005730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005740: 2023 206f 6620 7468 6520 7265 7368 6170   # of the reshap
-00005750: 696e 672e 0a20 2020 2020 2020 2020 2020  ing..           
-00005760: 2020 2020 2020 2020 2064 696d 656e 7369           dimensi
-00005770: 6f6e 2e63 6861 6e67 696e 675f 7661 6c75  on.changing_valu
-00005780: 6520 3d20 7365 6c66 2e5f 5f63 6f6d 7075  e = self.__compu
-00005790: 7465 5f63 6861 6e67 696e 675f 7661 6c75  te_changing_valu
-000057a0: 6528 7661 6c75 6573 5b69 5d29 0a20 2020  e(values[i]).   
-000057b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000057c0: 2064 696d 656e 7369 6f6e 732e 6170 7065   dimensions.appe
-000057d0: 6e64 2864 696d 656e 7369 6f6e 290a 2020  nd(dimension).  
-000057e0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-000057f0: 6365 7074 2056 616c 7565 4572 726f 723a  cept ValueError:
-00005800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005810: 2020 2020 205f 6c6f 6767 6572 2e77 6172       _logger.war
-00005820: 6e69 6e67 2822 436f 756c 646e 2774 2063  ning("Couldn't c
-00005830: 6f6e 7665 7274 2074 6f20 666c 6f61 7422  onvert to float"
-00005840: 290a 0a20 2020 2020 2020 2066 6f72 2064  )..        for d
-00005850: 696d 656e 7369 6f6e 2069 6e20 736f 7274  imension in sort
-00005860: 6564 280a 2020 2020 2020 2020 2020 2020  ed(.            
-00005870: 6469 6d65 6e73 696f 6e73 2c20 6b65 793d  dimensions, key=
-00005880: 6c61 6d62 6461 2078 3a20 782e 6368 616e  lambda x: x.chan
-00005890: 6769 6e67 5f76 616c 7565 2c20 7265 7665  ging_value, reve
-000058a0: 7273 653d 5472 7565 0a20 2020 2020 2020  rse=True.       
-000058b0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-000058c0: 7365 6c66 2e5f 5f64 696d 732e 6164 645f  self.__dims.add_
-000058d0: 6469 6d28 6178 6973 3d73 656c 662e 5f5f  dim(axis=self.__
-000058e0: 6469 6d73 2e6e 6469 6d2c 2064 696d 3d64  dims.ndim, dim=d
-000058f0: 696d 656e 7369 6f6e 290a 2020 2020 2020  imension).      
-00005900: 2020 2020 2020 5f6c 6f67 6765 722e 696e        _logger.in
-00005910: 666f 280a 2020 2020 2020 2020 2020 2020  fo(.            
-00005920: 2020 2020 2244 696d 656e 7369 6f6e 207b      "Dimension {
-00005930: 7d20 6f66 2073 697a 6520 7b7d 2068 6173  } of size {} has
-00005940: 2062 6565 6e20 6164 6465 6420 666f 7220   been added for 
-00005950: 7265 7368 6170 696e 6722 2e66 6f72 6d61  reshaping".forma
-00005960: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-00005970: 2020 2020 2020 2064 696d 656e 7369 6f6e         dimension
-00005980: 2e6e 616d 652c 2064 696d 656e 7369 6f6e  .name, dimension
-00005990: 2e73 697a 650a 2020 2020 2020 2020 2020  .size.          
-000059a0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000059b0: 2020 2020 290a 0a20 2020 2064 6566 2067      )..    def g
-000059c0: 6574 5f6d 6574 6164 6174 615f 7661 6c75  et_metadata_valu
-000059d0: 6573 280a 2020 2020 2020 2020 7365 6c66  es(.        self
-000059e0: 2c20 6b69 6e64 2c20 6b65 792c 2069 6e64  , kind, key, ind
-000059f0: 6963 6573 3d4e 6f6e 652c 2064 696d 656e  ices=None, dimen
-00005a00: 7369 6f6e 3d4e 6f6e 650a 2020 2020 2920  sion=None.    ) 
-00005a10: 2d3e 206e 756d 7079 2e6e 6461 7272 6179  -> numpy.ndarray
-00005a20: 3a0a 2020 2020 2020 2020 7661 6c75 6573  :.        values
-00005a30: 203d 205b 5d0a 2020 2020 2020 2020 6d69   = [].        mi
-00005a40: 7373 696e 675f 7661 6c75 6520 3d20 4661  ssing_value = Fa
-00005a50: 6c73 650a 2020 2020 2020 2020 666f 7220  lse.        for 
-00005a60: 6461 7461 2069 6e20 7365 6c66 2e67 6574  data in self.get
-00005a70: 5f64 6174 6128 696e 6469 6365 732c 2064  _data(indices, d
-00005a80: 696d 656e 7369 6f6e 292e 6d65 7461 6461  imension).metada
-00005a90: 7461 3a0a 2020 2020 2020 2020 2020 2020  ta:.            
-00005aa0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00005ab0: 2020 2020 2076 616c 7565 203d 2064 6174       value = dat
-00005ac0: 612e 6765 745f 7661 6c75 6528 6b69 6e64  a.get_value(kind
-00005ad0: 3d6b 696e 642c 206e 616d 653d 6b65 7929  =kind, name=key)
-00005ae0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-00005af0: 6570 7420 4b65 7945 7272 6f72 3a0a 2020  ept KeyError:.  
-00005b00: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
-00005b10: 7373 696e 675f 7661 6c75 6520 3d20 5472  ssing_value = Tr
-00005b20: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
-00005b30: 2020 2069 6620 6c65 6e28 7661 6c75 6573     if len(values
-00005b40: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00005b50: 2020 2020 2020 2076 616c 7565 732e 6170         values.ap
-00005b60: 7065 6e64 2876 616c 7565 735b 2d31 5d29  pend(values[-1])
-00005b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005b80: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00005b90: 2020 2020 2020 2020 2020 2076 616c 7565             value
-00005ba0: 732e 6170 7065 6e64 286e 756d 7079 2e6e  s.append(numpy.n
-00005bb0: 616e 290a 2020 2020 2020 2020 2020 2020  an).            
-00005bc0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00005bd0: 2020 2020 2020 6966 206e 6f74 2069 7369        if not isi
-00005be0: 6e73 7461 6e63 6528 6461 7461 2c20 5f48  nstance(data, _H
-00005bf0: 4446 354d 6574 6164 6174 6152 6561 6465  DF5MetadataReade
-00005c00: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00005c10: 2020 2020 2020 2020 2320 5f48 4446 354d          # _HDF5M
-00005c20: 6574 6164 6174 6152 6561 6465 7220 616c  etadataReader al
-00005c30: 7265 6164 7920 7265 7475 726e 2061 2073  ready return a s
-00005c40: 6361 6c61 7220 7768 656e 2073 696c 7820  calar when silx 
-00005c50: 4661 6269 6f52 6561 6465 7220 7265 7475  FabioReader retu
-00005c60: 726e 2061 6e20 6172 7261 7920 6f66 2061  rn an array of a
-00005c70: 2073 696e 676c 6520 656c 656d 656e 740a   single element.
-00005c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005c90: 2020 2020 7661 6c75 6520 3d20 7661 6c75      value = valu
-00005ca0: 655b 305d 0a20 2020 2020 2020 2020 2020  e[0].           
-00005cb0: 2020 2020 2076 616c 7565 732e 6170 7065       values.appe
-00005cc0: 6e64 2876 616c 7565 290a 0a20 2020 2020  nd(value)..     
-00005cd0: 2020 2069 6620 6d69 7373 696e 675f 7661     if missing_va
-00005ce0: 6c75 6520 6f72 2054 7275 653a 0a20 2020  lue or True:.   
-00005cf0: 2020 2020 2020 2020 205f 6c6f 6767 6572           _logger
-00005d00: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
-00005d10: 2020 2020 2020 2020 2020 224d 6973 7369            "Missi
-00005d20: 6e67 2076 616c 7565 2873 2920 6669 6c6c  ng value(s) fill
-00005d30: 6564 2074 6f20 7072 6576 696f 7573 2076  ed to previous v
-00005d40: 616c 7565 2066 6f72 206b 696e 6420 2725  alue for kind '%
-00005d50: 7327 2061 6e64 206b 6579 2027 2573 2722  s' and key '%s'"
-00005d60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00005d70: 2020 6b69 6e64 2c0a 2020 2020 2020 2020    kind,.        
-00005d80: 2020 2020 2020 2020 6b65 792c 0a20 2020          key,.   
-00005d90: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00005da0: 2020 2020 7265 7475 726e 206e 756d 7079      return numpy
-00005db0: 2e61 7361 7272 6179 2876 616c 7565 7329  .asarray(values)
-00005dc0: 2020 2320 6d61 6b65 7320 7375 7265 2074    # makes sure t
-00005dd0: 6865 7920 616c 6c20 6861 7665 2074 6865  hey all have the
-00005de0: 2073 616d 6520 6474 7970 650a 0a20 2020   same dtype..   
-00005df0: 2064 6566 205f 5f63 6f6d 7075 7465 5f63   def __compute_c
-00005e00: 6861 6e67 696e 675f 7661 6c75 6528 7365  hanging_value(se
-00005e10: 6c66 2c20 7661 6c75 6573 2c20 6368 616e  lf, values, chan
-00005e20: 6769 6e67 5f76 616c 7565 3d31 293a 0a20  ging_value=1):. 
-00005e30: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00005e40: 2020 2052 6563 7572 7369 7665 206d 6574     Recursive met
-00005e50: 686f 6420 7573 6564 2074 6f20 6361 6c63  hod used to calc
-00005e60: 756c 6174 6520 686f 7720 6661 7374 2069  ulate how fast i
-00005e70: 7320 6120 6469 6d65 6e73 696f 6e2e 2054  s a dimension. T
-00005e80: 6865 2073 7065 6564 206f 6620 6120 6469  he speed of a di
-00005e90: 6d65 6e73 696f 6e20 6973 2074 6865 206e  mension is the n
-00005ea0: 756d 6265 7220 6f66 0a20 2020 2020 2020  umber of.       
-00005eb0: 2074 696d 6573 2074 6865 2064 696d 656e   times the dimen
-00005ec0: 7369 6f6e 2063 6861 6e67 6573 206f 6620  sion changes of 
-00005ed0: 7661 6c75 6520 7768 696c 6520 6d6f 7669  value while movi
-00005ee0: 6e67 2074 6872 6f75 6768 2074 6865 2064  ng through the d
-00005ef0: 6174 6173 6574 2e0a 2020 2020 2020 2020  ataset..        
-00005f00: 2222 220a 2020 2020 2020 2020 6966 206c  """.        if l
-00005f10: 656e 286e 756d 7079 2e75 6e69 7175 6528  en(numpy.unique(
-00005f20: 7661 6c75 6573 2929 203e 2031 3a0a 2020  values)) > 1:.  
-00005f30: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00005f40: 2073 656c 662e 5f5f 636f 6d70 7574 655f   self.__compute_
-00005f50: 6368 616e 6769 6e67 5f76 616c 7565 280a  changing_value(.
-00005f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005f70: 7661 6c75 6573 5b3a 2069 6e74 286c 656e  values[: int(len
-00005f80: 2876 616c 7565 7329 202f 2032 295d 2c20  (values) / 2)], 
-00005f90: 6368 616e 6769 6e67 5f76 616c 7565 202b  changing_value +
-00005fa0: 2031 0a20 2020 2020 2020 2020 2020 2029   1.            )
-00005fb0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00005fc0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00005fd0: 6e20 6368 616e 6769 6e67 5f76 616c 7565  n changing_value
-00005fe0: 0a0a 2020 2020 6465 6620 6765 745f 6469  ..    def get_di
-00005ff0: 6d65 6e73 696f 6e73 5f76 616c 7565 7328  mensions_values(
-00006000: 7365 6c66 2c20 696e 6469 6365 733d 4e6f  self, indices=No
-00006010: 6e65 293a 0a20 2020 2020 2020 2022 2222  ne):.        """
-00006020: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-00006030: 2061 6c6c 2074 6865 206d 6574 6164 6174   all the metadat
-00006040: 6120 7661 6c75 6573 206f 6620 7468 6520  a values of the 
-00006050: 6469 6d65 6e73 696f 6e73 2e0a 2020 2020  dimensions..    
-00006060: 2020 2020 5468 6520 7661 6c75 6573 2061      The values a
-00006070: 7265 2061 7373 756d 6564 2074 6f20 6265  re assumed to be
-00006080: 206e 756d 6265 7273 2e0a 0a20 2020 2020   numbers...     
-00006090: 2020 203a 7265 7475 726e 733a 2061 7272     :returns: arr
-000060a0: 6179 5f6c 696b 650a 2020 2020 2020 2020  ay_like.        
-000060b0: 2222 220a 2020 2020 2020 2020 6966 206e  """.        if n
-000060c0: 6f74 2073 656c 662e 5f64 696d 656e 7369  ot self._dimensi
-000060d0: 6f6e 735f 7661 6c75 6573 206f 7220 696e  ons_values or in
-000060e0: 6469 6365 7320 6973 206e 6f74 204e 6f6e  dices is not Non
-000060f0: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
-00006100: 6f72 2064 696d 656e 7369 6f6e 2069 6e20  or dimension in 
-00006110: 7365 6c66 2e5f 5f64 696d 733a 0a20 2020  self.__dims:.   
-00006120: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00006130: 662e 5f64 696d 656e 7369 6f6e 735f 7661  f._dimensions_va
-00006140: 6c75 6573 5b64 696d 656e 7369 6f6e 5b31  lues[dimension[1
-00006150: 5d2e 6e61 6d65 5d20 3d20 7365 6c66 2e67  ].name] = self.g
-00006160: 6574 5f6d 6574 6164 6174 615f 7661 6c75  et_metadata_valu
-00006170: 6573 280a 2020 2020 2020 2020 2020 2020  es(.            
-00006180: 2020 2020 2020 2020 6b69 6e64 3d64 696d          kind=dim
-00006190: 656e 7369 6f6e 5b31 5d2e 6b69 6e64 2c20  ension[1].kind, 
-000061a0: 6b65 793d 6469 6d65 6e73 696f 6e5b 315d  key=dimension[1]
-000061b0: 2e6e 616d 652c 2069 6e64 6963 6573 3d69  .name, indices=i
-000061c0: 6e64 6963 6573 0a20 2020 2020 2020 2020  ndices.         
-000061d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000061e0: 2072 6574 7572 6e20 7365 6c66 2e5f 6469   return self._di
-000061f0: 6d65 6e73 696f 6e73 5f76 616c 7565 730a  mensions_values.
-00006200: 0a20 2020 2064 6566 2063 6f6d 7075 7465  .    def compute
-00006210: 5f6d 6f73 6169 6369 7479 5f63 6f6c 6f72  _mosaicity_color
-00006220: 6b65 7928 0a20 2020 2020 2020 2073 656c  key(.        sel
-00006230: 662c 2064 696d 656e 7369 6f6e 733d 5b30  f, dimensions=[0
-00006240: 2c20 315d 2c20 7363 616c 653d 3130 302c  , 1], scale=100,
-00006250: 2069 6e64 6963 6573 3d4e 6f6e 652c 2074   indices=None, t
-00006260: 6869 7264 5f6d 6f74 6f72 3d4e 6f6e 650a  hird_motor=None.
-00006270: 2020 2020 293a 0a20 2020 2020 2020 2022      ):.        "
-00006280: 2222 0a20 2020 2020 2020 2043 6f6d 7075  "".        Compu
-00006290: 7465 7320 6120 6d6f 7361 6963 6974 7920  tes a mosaicity 
-000062a0: 636f 6c6f 726b 6579 2066 726f 6d20 7468  colorkey from th
-000062b0: 6520 6469 6d65 6e73 696f 6e73 2c20 616e  e dimensions, an
-000062c0: 6420 7265 7475 726e 7320 616c 736f 2074  d returns also t
-000062d0: 6865 0a20 2020 2020 2020 206f 7269 656e  he.        orien
-000062e0: 7461 7469 6f6e 2064 6973 7472 6962 7574  tation distribut
-000062f0: 696f 6e20 696d 6167 652e 0a20 2020 2020  ion image..     
-00006300: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
-00006310: 206f 6e6c 7920 776f 726b 2077 6974 6820   only work with 
-00006320: 3220 6469 6d65 6e73 696f 6e73 0a20 2020  2 dimensions.   
-00006330: 2020 2020 2061 7373 6572 7420 6c65 6e28       assert len(
-00006340: 6469 6d65 6e73 696f 6e73 2920 3d3d 2032  dimensions) == 2
-00006350: 2c20 224f 6e6c 7920 776f 726b 7320 7769  , "Only works wi
-00006360: 7468 2074 776f 206d 6f74 6f72 7322 0a20  th two motors". 
-00006370: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
-00006380: 5f64 696d 7320 616e 6420 7365 6c66 2e5f  _dims and self._
-00006390: 5f64 696d 732e 6e64 696d 203e 2031 3a0a  _dims.ndim > 1:.
-000063a0: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
-000063b0: 7368 6170 6520 3d20 5b5d 0a20 2020 2020  shape = [].     
+000027a0: 2064 7365 7420 3d20 6d65 7461 6461 7461   dset = metadata
+000027b0: 5f67 726f 7570 5b6e 616d 655d 0a20 2020  _group[name].   
+000027c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000027d0: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
+000027e0: 6365 2864 7365 742c 2068 3570 792e 4461  ce(dset, h5py.Da
+000027f0: 7461 7365 7429 206f 7220 6e6f 7420 6473  taset) or not ds
+00002800: 6574 2e6e 6469 6d20 3d3d 2031 3a0a 2020  et.ndim == 1:.  
+00002810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002820: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+00002830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002840: 2020 2064 6174 6173 6574 735b 6e61 6d65     datasets[name
+00002850: 5d20 3d20 6473 6574 0a0a 2020 2020 2020  ] = dset..      
+00002860: 2020 2020 2020 2020 2020 6672 616d 655f            frame_
+00002870: 6d65 7461 6461 7461 203d 205b 0a20 2020  metadata = [.   
+00002880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002890: 2073 656c 662e 5f65 7874 7261 6374 5f68   self._extract_h
+000028a0: 6466 355f 6d65 7461 6461 7461 2864 6174  df5_metadata(dat
+000028b0: 6173 6574 732c 2066 7261 6d65 5f69 6e64  asets, frame_ind
+000028c0: 6578 290a 2020 2020 2020 2020 2020 2020  ex).            
+000028d0: 2020 2020 2020 2020 666f 7220 6672 616d          for fram
+000028e0: 655f 696e 6465 7820 696e 2072 616e 6765  e_index in range
+000028f0: 286e 5f66 7261 6d65 7329 0a20 2020 2020  (n_frames).     
+00002900: 2020 2020 2020 2020 2020 205d 0a0a 2020             ]..  
+00002910: 2020 2020 2020 6d65 7461 6461 7461 5f72        metadata_r
+00002920: 6561 6465 7273 203d 205b 0a20 2020 2020  eaders = [.     
+00002930: 2020 2020 2020 205f 4844 4635 4d65 7461         _HDF5Meta
+00002940: 6461 7461 5265 6164 6572 286d 6574 6164  dataReader(metad
+00002950: 6174 613d 6d64 6174 6129 2066 6f72 206d  ata=mdata) for m
+00002960: 6461 7461 2069 6e20 6672 616d 655f 6d65  data in frame_me
+00002970: 7461 6461 7461 0a20 2020 2020 2020 205d  tadata.        ]
+00002980: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00002990: 2064 6174 615f 7572 6c73 2c20 6d65 7461   data_urls, meta
+000029a0: 6461 7461 5f72 6561 6465 7273 0a0a 2020  data_readers..  
+000029b0: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
+000029c0: 2020 2020 6465 6620 5f65 7874 7261 6374      def _extract
+000029d0: 5f68 6466 355f 6d65 7461 6461 7461 280a  _hdf5_metadata(.
+000029e0: 2020 2020 2020 2020 6461 7461 7365 7473          datasets
+000029f0: 3a20 4469 6374 5b73 7472 2c20 6835 7079  : Dict[str, h5py
+00002a00: 2e44 6174 6173 6574 5d2c 2066 7261 6d65  .Dataset], frame
+00002a10: 5f69 6e64 6578 3a20 696e 740a 2020 2020  _index: int.    
+00002a20: 2920 2d3e 2064 6963 743a 0a20 2020 2020  ) -> dict:.     
+00002a30: 2020 206d 6574 6164 6174 6120 3d20 7b7d     metadata = {}
+00002a40: 0a20 2020 2020 2020 2066 6f72 206e 616d  .        for nam
+00002a50: 652c 2064 7365 7420 696e 2064 6174 6173  e, dset in datas
+00002a60: 6574 732e 6974 656d 7328 293a 0a20 2020  ets.items():.   
+00002a70: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+00002a80: 6473 6574 2920 3c3d 2066 7261 6d65 5f69  dset) <= frame_i
+00002a90: 6e64 6578 3a0a 2020 2020 2020 2020 2020  ndex:.          
+00002aa0: 2020 2020 2020 2320 544f 444f 3a20 6973        # TODO: is
+00002ab0: 2074 6869 7320 7761 726e 696e 6720 616c   this warning al
+00002ac0: 7761 7973 2063 6f72 7265 6374 2061 6e64  ways correct and
+00002ad0: 2072 656c 6576 616e 7420 3f0a 2020 2020   relevant ?.    
+00002ae0: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
+00002af0: 6973 2068 6170 7065 6e73 2077 6865 6e20  is happens when 
+00002b00: 7468 6520 3144 2064 6174 6173 6574 7320  the 1D datasets 
+00002b10: 6861 7665 206c 6573 7320 706f 696e 7473  have less points
+00002b20: 2074 6861 6e20 7468 6572 6520 6172 6520   than there are 
+00002b30: 696d 6167 6573 2028 4354 524c 2d43 206f  images (CTRL-C o
+00002b40: 6620 7363 616e 290a 2020 2020 2020 2020  f scan).        
+00002b50: 2020 2020 2020 2020 5f6c 6f67 6765 722e          _logger.
+00002b60: 7761 726e 696e 6728 0a20 2020 2020 2020  warning(.       
+00002b70: 2020 2020 2020 2020 2020 2020 2066 2255               f"U
+00002b80: 6e61 626c 6520 746f 2061 6363 6573 7320  nable to access 
+00002b90: 696e 6465 7820 7b66 7261 6d65 5f69 6e64  index {frame_ind
+00002ba0: 6578 7d20 6f66 2074 6865 2064 6174 6173  ex} of the datas
+00002bb0: 6574 207b 6473 6574 2e6e 616d 657d 220a  et {dset.name}".
+00002bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002bd0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00002be0: 2020 6d65 7461 6461 7461 5b6e 616d 655d    metadata[name]
+00002bf0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+00002c00: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00002c10: 2020 2020 2020 2020 2020 6d65 7461 6461            metada
+00002c20: 7461 5b6e 616d 655d 203d 2064 7365 745b  ta[name] = dset[
+00002c30: 6672 616d 655f 696e 6465 785d 0a20 2020  frame_index].   
+00002c40: 2020 2020 2072 6574 7572 6e20 6d65 7461       return meta
+00002c50: 6461 7461 0a0a 2020 2020 6465 6620 7374  data..    def st
+00002c60: 6f70 5f6f 7065 7261 7469 6f6e 2873 656c  op_operation(sel
+00002c70: 662c 206f 7065 7261 7469 6f6e 293a 0a20  f, operation):. 
+00002c80: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00002c90: 2020 204d 6574 686f 6420 7573 6564 2066     Method used f
+00002ca0: 6f72 2063 6173 6573 2077 6865 7265 2074  or cases where t
+00002cb0: 6872 6561 6473 2061 7265 2063 7265 6174  hreads are creat
+00002cc0: 6564 2074 6f20 6170 706c 7920 6675 6e63  ed to apply func
+00002cd0: 7469 6f6e 7320 746f 2074 6865 2064 6174  tions to the dat
+00002ce0: 6173 6574 2e0a 2020 2020 2020 2020 4966  aset..        If
+00002cf0: 206d 6574 686f 6420 6973 2063 616c 6c65   method is calle
+00002d00: 642c 2074 6865 2066 6c61 6720 636f 6e63  d, the flag conc
+00002d10: 6572 6e69 6e67 2074 6865 2073 746f 7020  erning the stop 
+00002d20: 6973 2073 6574 2074 6f20 3020 736f 2074  is set to 0 so t
+00002d30: 6861 7420 6966 2074 6865 2063 6f6e 6365  hat if the conce
+00002d40: 726e 6564 0a20 2020 2020 2020 206f 7065  rned.        ope
+00002d50: 7261 7469 6f6e 2069 7320 7275 6e6e 696e  ration is runnin
+00002d60: 6720 696e 2061 6e6f 7468 6572 2074 6872  g in another thr
+00002d70: 6561 6420 6974 206b 6e6f 7773 2074 6f20  ead it knows to 
+00002d80: 7374 6f70 2e0a 0a20 2020 2020 2020 203a  stop...        :
+00002d90: 7061 7261 6d20 696e 7420 6f70 6572 6174  param int operat
+00002da0: 696f 6e3a 206f 7065 7261 7469 6f6e 2074  ion: operation t
+00002db0: 6f20 7374 6f70 0a20 2020 2020 2020 203a  o stop.        :
+00002dc0: 7479 7065 2069 6e74 3a20 556e 696f 6e5b  type int: Union[
+00002dd0: 696e 742c 2060 4f70 6572 6174 696f 6e60  int, `Operation`
+00002de0: 5d0a 2020 2020 2020 2020 2222 220a 2020  ].        """.  
+00002df0: 2020 2020 2020 6966 2073 656c 662e 7374        if self.st
+00002e00: 6174 655f 6f66 5f6f 7065 7261 7469 6f6e  ate_of_operation
+00002e10: 732e 6973 5f72 756e 6e69 6e67 286f 7065  s.is_running(ope
+00002e20: 7261 7469 6f6e 293a 0a20 2020 2020 2020  ration):.       
+00002e30: 2020 2020 2073 656c 662e 7374 6174 655f       self.state_
+00002e40: 6f66 5f6f 7065 7261 7469 6f6e 732e 7374  of_operations.st
+00002e50: 6f70 286f 7065 7261 7469 6f6e 290a 2020  op(operation).  
+00002e60: 2020 2020 2020 6966 2073 656c 662e 7275        if self.ru
+00002e70: 6e6e 696e 675f 6461 7461 2069 7320 6e6f  nning_data is no
+00002e80: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00002e90: 2020 2020 7365 6c66 2e72 756e 6e69 6e67      self.running
+00002ea0: 5f64 6174 612e 7374 6f70 5f6f 7065 7261  _data.stop_opera
+00002eb0: 7469 6f6e 286f 7065 7261 7469 6f6e 290a  tion(operation).
+00002ec0: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+00002ed0: 2020 2064 6566 2074 7261 6e73 666f 726d     def transform
+00002ee0: 6174 696f 6e28 7365 6c66 293a 0a20 2020  ation(self):.   
+00002ef0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00002f00: 2e5f 7472 616e 7366 6f72 6d61 7469 6f6e  ._transformation
+00002f10: 0a0a 2020 2020 4074 7261 6e73 666f 726d  ..    @transform
+00002f20: 6174 696f 6e2e 7365 7474 6572 0a20 2020  ation.setter.   
+00002f30: 2064 6566 2074 7261 6e73 666f 726d 6174   def transformat
+00002f40: 696f 6e28 7365 6c66 2c20 7661 6c75 6529  ion(self, value)
+00002f50: 3a0a 2020 2020 2020 2020 7365 6c66 2e5f  :.        self._
+00002f60: 7472 616e 7366 6f72 6d61 7469 6f6e 203d  transformation =
+00002f70: 2076 616c 7565 0a0a 2020 2020 4070 726f   value..    @pro
+00002f80: 7065 7274 790a 2020 2020 6465 6620 7469  perty.    def ti
+00002f90: 746c 6528 7365 6c66 293a 0a20 2020 2020  tle(self):.     
+00002fa0: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+00002fb0: 7469 746c 650a 0a20 2020 2040 7072 6f70  title..    @prop
+00002fc0: 6572 7479 0a20 2020 2064 6566 2064 6972  erty.    def dir
+00002fd0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00002fe0: 7265 7475 726e 2073 656c 662e 5f64 6972  return self._dir
+00002ff0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+00003000: 2020 2020 6465 6620 6973 5f68 3528 7365      def is_h5(se
+00003010: 6c66 293a 0a20 2020 2020 2020 2072 6574  lf):.        ret
+00003020: 7572 6e20 7365 6c66 2e5f 6973 4835 0a0a  urn self._isH5..
+00003030: 2020 2020 6465 6620 636f 6d70 7574 655f      def compute_
+00003040: 6672 616d 6573 5f69 6e74 656e 7369 7479  frames_intensity
+00003050: 2873 656c 662c 206b 6572 6e65 6c3d 2833  (self, kernel=(3
+00003060: 2c20 3329 2c20 7369 676d 613d 3230 293a  , 3), sigma=20):
+00003070: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00003080: 2020 2020 2052 6574 7572 6e73 2066 6f72       Returns for
+00003090: 2065 7665 7279 2069 6d61 6765 2061 206e   every image a n
+000030a0: 756d 6265 7220 7265 7072 6573 656e 7469  umber representi
+000030b0: 6e67 2069 7473 2069 6e74 656e 7369 7479  ng its intensity
+000030c0: 2e20 5468 6973 206e 756d 6265 720a 2020  . This number.  
+000030d0: 2020 2020 2020 6973 206f 6274 6169 6e65        is obtaine
+000030e0: 6420 6279 2066 6972 7374 2062 6c75 7272  d by first blurr
+000030f0: 696e 6720 7468 6520 696d 6167 6520 616e  ing the image an
+00003100: 6420 7468 656e 2063 6f6d 7075 7469 6e67  d then computing
+00003110: 2069 7473 2076 6172 6961 6e63 652e 0a20   its variance.. 
+00003120: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00003130: 2020 205f 6c6f 6767 6572 2e69 6e66 6f28     _logger.info(
+00003140: 2243 6f6d 7075 7469 6e67 2069 6e74 656e  "Computing inten
+00003150: 7369 7479 2070 6572 2066 7261 6d65 2229  sity per frame")
+00003160: 0a20 2020 2020 2020 2069 6f5f 7574 696c  .        io_util
+00003170: 732e 6164 7661 6e63 656d 656e 745f 6469  s.advancement_di
+00003180: 7370 6c61 7928 302c 2073 656c 662e 6e66  splay(0, self.nf
+00003190: 7261 6d65 732c 2022 436f 6d70 7574 696e  rames, "Computin
+000031a0: 6720 696e 7465 6e73 6974 7922 290a 2020  g intensity").  
+000031b0: 2020 2020 2020 6672 616d 6573 5f69 6e74        frames_int
+000031c0: 656e 7369 7479 203d 205b 5d0a 2020 2020  ensity = [].    
+000031d0: 2020 2020 7769 7468 2073 656c 662e 7374      with self.st
+000031e0: 6174 655f 6f66 5f6f 7065 7261 7469 6f6e  ate_of_operation
+000031f0: 732e 7275 6e5f 636f 6e74 6578 7428 4f70  s.run_context(Op
+00003200: 6572 6174 696f 6e2e 5041 5254 4954 494f  eration.PARTITIO
+00003210: 4e29 3a0a 2020 2020 2020 2020 2020 2020  N):.            
+00003220: 666f 7220 6920 696e 2072 616e 6765 2873  for i in range(s
+00003230: 656c 662e 6e66 7261 6d65 7329 3a0a 2020  elf.nframes):.  
+00003240: 2020 2020 2020 2020 2020 2020 2020 696d                im
+00003250: 706f 7274 2063 7632 0a0a 2020 2020 2020  port cv2..      
+00003260: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00003270: 2073 656c 662e 7374 6174 655f 6f66 5f6f   self.state_of_o
+00003280: 7065 7261 7469 6f6e 732e 6973 5f72 756e  perations.is_run
+00003290: 6e69 6e67 284f 7065 7261 7469 6f6e 2e50  ning(Operation.P
+000032a0: 4152 5449 5449 4f4e 293a 0a20 2020 2020  ARTITION):.     
+000032b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000032c0: 6574 7572 6e0a 2020 2020 2020 2020 2020  eturn.          
+000032d0: 2020 2020 2020 6672 616d 6573 5f69 6e74        frames_int
+000032e0: 656e 7369 7479 202b 3d20 5b0a 2020 2020  ensity += [.    
+000032f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003300: 6376 322e 4761 7573 7369 616e 426c 7572  cv2.GaussianBlur
+00003310: 2873 656c 662e 6765 745f 6461 7461 2869  (self.get_data(i
+00003320: 292c 206b 6572 6e65 6c2c 2073 6967 6d61  ), kernel, sigma
+00003330: 292e 7661 7228 290a 2020 2020 2020 2020  ).var().        
+00003340: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+00003350: 2020 2020 2020 2020 2020 696f 5f75 7469            io_uti
+00003360: 6c73 2e61 6476 616e 6365 6d65 6e74 5f64  ls.advancement_d
+00003370: 6973 706c 6179 2869 202b 2031 2c20 7365  isplay(i + 1, se
+00003380: 6c66 2e6e 6672 616d 6573 2c20 2243 6f6d  lf.nframes, "Com
+00003390: 7075 7469 6e67 2069 6e74 656e 7369 7479  puting intensity
+000033a0: 2229 0a20 2020 2020 2020 2020 2020 2073  ").            s
+000033b0: 656c 662e 5f66 7261 6d65 735f 696e 7465  elf._frames_inte
+000033c0: 6e73 6974 7920 3d20 6672 616d 6573 5f69  nsity = frames_i
+000033d0: 6e74 656e 7369 7479 0a20 2020 2020 2020  ntensity.       
+000033e0: 2020 2020 2072 6574 7572 6e20 6672 616d       return fram
+000033f0: 6573 5f69 6e74 656e 7369 7479 0a0a 2020  es_intensity..  
+00003400: 2020 6465 6620 7061 7274 6974 696f 6e5f    def partition_
+00003410: 6279 5f69 6e74 656e 7369 7479 2873 656c  by_intensity(sel
+00003420: 662c 2062 696e 733d 4e6f 6e65 2c20 626f  f, bins=None, bo
+00003430: 7474 6f6d 5f62 696e 3d4e 6f6e 652c 2074  ttom_bin=None, t
+00003440: 6f70 5f62 696e 3d4e 6f6e 6529 3a0a 2020  op_bin=None):.  
+00003450: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00003460: 2020 4675 6e63 7469 6f6e 2074 6861 7420    Function that 
+00003470: 636f 6d70 7574 6573 2074 6865 2064 6174  computes the dat
+00003480: 6120 6672 6f6d 2074 6865 2073 6574 206f  a from the set o
+00003490: 6620 7572 6c73 2e0a 2020 2020 2020 2020  f urls..        
+000034a0: 4966 2074 6865 2066 696c 7465 725f 6461  If the filter_da
+000034b0: 7461 2066 6c61 6720 6973 2061 6374 6976  ta flag is activ
+000034c0: 6174 6564 2069 7420 6669 6c74 6572 7320  ated it filters 
+000034d0: 7468 6520 6461 7461 2066 6f6c 6c6f 7769  the data followi
+000034e0: 6e67 2074 6865 206e 6578 743a 0a20 2020  ng the next:.   
+000034f0: 2020 2020 202d 2d20 4669 7273 742c 2069       -- First, i
+00003500: 7420 636f 6d70 7574 6573 2074 6865 2069  t computes the i
+00003510: 6e74 656e 7369 7479 2066 6f72 2065 6163  ntensity for eac
+00003520: 6820 6672 616d 652c 2062 7920 6361 6c63  h frame, by calc
+00003530: 756c 6174 696e 6720 7468 6520 7661 7269  ulating the vari
+00003540: 616e 6365 2061 6674 6572 0a20 2020 2020  ance after.     
+00003550: 2020 2070 6173 7369 6e67 2061 2067 6175     passing a gau
+00003560: 7373 6961 6e20 6669 6c74 6572 2e0a 2020  ssian filter..  
+00003570: 2020 2020 2020 2d2d 2053 6563 6f6e 642c        -- Second,
+00003580: 2063 6f6d 7075 7465 7320 7468 6520 6869   computes the hi
+00003590: 7374 6f67 7261 6d20 6f66 2074 6865 2069  stogram of the i
+000035a0: 6e74 656e 7369 7479 2e0a 2020 2020 2020  ntensity..      
+000035b0: 2020 2d2d 2046 696e 616c 6c79 2c20 7361    -- Finally, sa
+000035c0: 7665 7320 7468 6520 6461 7461 206f 6620  ves the data of 
+000035d0: 7468 6520 6672 616d 6573 2077 6974 6820  the frames with 
+000035e0: 616e 2069 6e74 656e 7369 7479 2062 6967  an intensity big
+000035f0: 6765 7220 7468 616e 2061 2074 6872 6573  ger than a thres
+00003600: 686f 6c64 2e0a 2020 2020 2020 2020 5468  hold..        Th
+00003610: 6520 7468 7265 7368 6f6c 6420 6973 2073  e threshold is s
+00003620: 6574 2074 6f20 6265 2074 6865 2073 6563  et to be the sec
+00003630: 6f6e 6420 6269 6e20 6f66 2074 6865 2068  ond bin of the h
+00003640: 6973 746f 6772 616d 2e0a 0a20 2020 2020  istogram...     
+00003650: 2020 203a 7061 7261 6d20 696e 7420 6e75     :param int nu
+00003660: 6d5f 6269 6e73 3a20 4e75 6d62 6572 206f  m_bins: Number o
+00003670: 6620 6269 6e73 2074 6f20 7573 6520 6173  f bins to use as
+00003680: 2074 6872 6573 686f 6c64 2e0a 2020 2020   threshold..    
+00003690: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+000036a0: 6672 616d 6573 5f69 6e74 656e 7369 7479  frames_intensity
+000036b0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+000036c0: 2073 656c 662e 5f66 7261 6d65 735f 696e   self._frames_in
+000036d0: 7465 6e73 6974 790a 2020 2020 2020 2020  tensity.        
+000036e0: 2020 2020 6966 2073 656c 662e 5f66 7261      if self._fra
+000036f0: 6d65 735f 696e 7465 6e73 6974 790a 2020  mes_intensity.  
+00003700: 2020 2020 2020 2020 2020 656c 7365 2073            else s
+00003710: 656c 662e 636f 6d70 7574 655f 6672 616d  elf.compute_fram
+00003720: 6573 5f69 6e74 656e 7369 7479 2829 0a20  es_intensity(). 
+00003730: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00003740: 2069 6620 6672 616d 6573 5f69 6e74 656e   if frames_inten
+00003750: 7369 7479 2069 7320 4e6f 6e65 3a0a 2020  sity is None:.  
+00003760: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00003770: 0a20 2020 2020 2020 2076 616c 7565 732c  .        values,
+00003780: 2062 696e 7320 3d20 6e75 6d70 792e 6869   bins = numpy.hi
+00003790: 7374 6f67 7261 6d28 0a20 2020 2020 2020  stogram(.       
+000037a0: 2020 2020 2066 7261 6d65 735f 696e 7465       frames_inte
+000037b0: 6e73 6974 792c 2073 656c 662e 6e66 7261  nsity, self.nfra
+000037c0: 6d65 7320 6966 2062 696e 7320 6973 204e  mes if bins is N
+000037d0: 6f6e 6520 656c 7365 2062 696e 730a 2020  one else bins.  
+000037e0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000037f0: 6672 616d 6573 5f69 6e74 656e 7369 7479  frames_intensity
+00003800: 203d 206e 756d 7079 2e61 7361 6e79 6172   = numpy.asanyar
+00003810: 7261 7928 6672 616d 6573 5f69 6e74 656e  ray(frames_inten
+00003820: 7369 7479 290a 2020 2020 2020 2020 6966  sity).        if
+00003830: 2074 6f70 5f62 696e 2069 7320 4e6f 6e65   top_bin is None
+00003840: 3a0a 2020 2020 2020 2020 2020 2020 746f  :.            to
+00003850: 705f 6269 6e20 3d20 6c65 6e28 6269 6e73  p_bin = len(bins
+00003860: 2920 2d20 310a 2020 2020 2020 2020 6966  ) - 1.        if
+00003870: 2062 6f74 746f 6d5f 6269 6e20 6973 204e   bottom_bin is N
+00003880: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00003890: 2062 6f74 746f 6d5f 6269 6e20 3d20 300a   bottom_bin = 0.
+000038a0: 0a20 2020 2020 2020 2062 6f74 746f 6d5f  .        bottom_
+000038b0: 7468 7265 7368 6f6c 6420 3d20 6672 616d  threshold = fram
+000038c0: 6573 5f69 6e74 656e 7369 7479 203e 3d20  es_intensity >= 
+000038d0: 6269 6e73 5b62 6f74 746f 6d5f 6269 6e5d  bins[bottom_bin]
+000038e0: 0a20 2020 2020 2020 2074 6f70 5f74 6872  .        top_thr
+000038f0: 6573 686f 6c64 203d 2066 7261 6d65 735f  eshold = frames_
+00003900: 696e 7465 6e73 6974 7920 3c3d 2062 696e  intensity <= bin
+00003910: 735b 746f 705f 6269 6e5d 0a20 2020 2020  s[top_bin].     
+00003920: 2020 2074 6872 6573 686f 6c64 203d 206e     threshold = n
+00003930: 756d 7079 2e61 7272 6179 280a 2020 2020  umpy.array(.    
+00003940: 2020 2020 2020 2020 5b61 2061 6e64 2062          [a and b
+00003950: 2066 6f72 2061 2c20 6220 696e 207a 6970   for a, b in zip
+00003960: 2862 6f74 746f 6d5f 7468 7265 7368 6f6c  (bottom_threshol
+00003970: 642c 2074 6f70 5f74 6872 6573 686f 6c64  d, top_threshold
+00003980: 295d 0a20 2020 2020 2020 2029 0a20 2020  )].        ).   
+00003990: 2020 2020 2072 6574 7572 6e20 6e75 6d70       return nump
+000039a0: 792e 666c 6174 6e6f 6e7a 6572 6f28 7468  y.flatnonzero(th
+000039b0: 7265 7368 6f6c 6429 2c20 6e75 6d70 792e  reshold), numpy.
+000039c0: 666c 6174 6e6f 6e7a 6572 6f28 7e74 6872  flatnonzero(~thr
+000039d0: 6573 686f 6c64 290a 0a20 2020 2040 7072  eshold)..    @pr
+000039e0: 6f70 6572 7479 0a20 2020 2064 6566 2069  operty.    def i
+000039f0: 6e5f 6d65 6d6f 7279 2873 656c 6629 3a0a  n_memory(self):.
+00003a00: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00003a10: 656c 662e 5f69 6e5f 6d65 6d6f 7279 0a0a  elf._in_memory..
+00003a20: 2020 2020 4069 6e5f 6d65 6d6f 7279 2e73      @in_memory.s
+00003a30: 6574 7465 720a 2020 2020 6465 6620 696e  etter.    def in
+00003a40: 5f6d 656d 6f72 7928 7365 6c66 2c20 696e  _memory(self, in
+00003a50: 5f6d 656d 6f72 7929 3a0a 2020 2020 2020  _memory):.      
+00003a60: 2020 2222 220a 2020 2020 2020 2020 5265    """.        Re
+00003a70: 6d6f 7665 7320 6461 7461 2066 726f 6d20  moves data from 
+00003a80: 6d65 6d6f 7279 2061 6e64 2073 6574 7320  memory and sets 
+00003a90: 7468 6174 2066 726f 6d20 6e6f 7720 6f6e  that from now on
+00003aa0: 2064 6174 6120 7769 6c6c 2062 6520 7265   data will be re
+00003ab0: 6164 2066 726f 6d20 6469 736b 2e0a 2020  ad from disk..  
+00003ac0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00003ad0: 2020 6966 2073 656c 662e 5f69 6e5f 6d65    if self._in_me
+00003ae0: 6d6f 7279 2069 7320 6e6f 7420 696e 5f6d  mory is not in_m
+00003af0: 656d 6f72 793a 0a20 2020 2020 2020 2020  emory:.         
+00003b00: 2020 2073 656c 662e 5f69 6e5f 6d65 6d6f     self._in_memo
+00003b10: 7279 203d 2069 6e5f 6d65 6d6f 7279 0a20  ry = in_memory. 
+00003b20: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00003b30: 5f64 6174 6120 3d20 4461 7461 2873 656c  _data = Data(sel
+00003b40: 662e 6461 7461 2e75 726c 732c 2073 656c  f.data.urls, sel
+00003b50: 662e 6461 7461 2e6d 6574 6164 6174 612c  f.data.metadata,
+00003b60: 2073 656c 662e 5f69 6e5f 6d65 6d6f 7279   self._in_memory
+00003b70: 290a 0a20 2020 2040 7072 6f70 6572 7479  )..    @property
+00003b80: 0a20 2020 2064 6566 2064 6174 6128 7365  .    def data(se
+00003b90: 6c66 293a 0a20 2020 2020 2020 2072 6574  lf):.        ret
+00003ba0: 7572 6e20 7365 6c66 2e5f 6461 7461 0a0a  urn self._data..
+00003bb0: 2020 2020 6465 6620 6765 745f 6461 7461      def get_data
+00003bc0: 2873 656c 662c 2069 6e64 6963 6573 3d4e  (self, indices=N
+00003bd0: 6f6e 652c 2064 696d 656e 7369 6f6e 3d4e  one, dimension=N
+00003be0: 6f6e 652c 2072 6574 7572 6e5f 696e 6469  one, return_indi
+00003bf0: 6365 733d 4661 6c73 6529 3a0a 2020 2020  ces=False):.    
+00003c00: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00003c10: 5265 7475 726e 7320 7468 6520 6461 7461  Returns the data
+00003c20: 2063 6f72 7265 7370 6f6e 6469 6e67 2074   corresponding t
+00003c30: 6f20 6365 7274 6169 6e73 2069 6e64 6963  o certains indic
+00003c40: 6573 2061 6e64 2067 6976 656e 2073 6f6d  es and given som
+00003c50: 6520 6469 6d65 6e73 696f 6e73 2076 616c  e dimensions val
+00003c60: 7565 732e 0a20 2020 2020 2020 2054 6865  ues..        The
+00003c70: 2064 6174 6120 6973 2061 6c77 6179 7320   data is always 
+00003c80: 666c 6174 7465 6e65 6420 746f 2062 6520  flattened to be 
+00003c90: 6120 7374 6163 6b20 6f66 2069 6d61 6765  a stack of image
+00003ca0: 732e 0a0a 2020 2020 2020 2020 3a70 6172  s...        :par
+00003cb0: 616d 2061 7272 6179 5f6c 696b 6520 696e  am array_like in
+00003cc0: 6469 6365 733a 2049 6620 6e6f 7420 4e6f  dices: If not No
+00003cd0: 6e65 2c20 6461 7461 2069 7320 6669 6c74  ne, data is filt
+00003ce0: 6572 6564 2075 7369 6e67 2074 6869 7320  ered using this 
+00003cf0: 6172 7261 792e 0a20 2020 2020 2020 203a  array..        :
+00003d00: 7061 7261 6d20 6172 7261 795f 6c69 6b65  param array_like
+00003d10: 2064 696d 656e 7369 6f6e 3a20 4966 206e   dimension: If n
+00003d20: 6f74 204e 6f6e 652c 2072 6574 7572 6e20  ot None, return 
+00003d30: 6f6e 6c79 2074 6865 2064 6174 6120 636f  only the data co
+00003d40: 7272 6573 706f 6e64 696e 6720 746f 0a20  rresponding to. 
+00003d50: 2020 2020 2020 2020 2020 2074 6865 2067             the g
+00003d60: 6976 656e 2064 696d 656e 7369 6f6e 2e20  iven dimension. 
+00003d70: 4469 6d65 6e73 696f 6e20 6973 2061 2032  Dimension is a 2
+00003d80: 6420 7665 6374 6f72 2c20 7768 6572 6520  d vector, where 
+00003d90: 7468 6520 6669 7273 7420 636f 6d70 6f6e  the first compon
+00003da0: 656e 7420 6973 0a20 2020 2020 2020 2020  ent is.         
+00003db0: 2020 2061 206c 6973 7420 6f66 2074 6865     a list of the
+00003dc0: 2061 7869 7320 616e 6420 7468 6520 7365   axis and the se
+00003dd0: 636f 6e64 2069 7320 6120 6c69 7374 206f  cond is a list o
+00003de0: 6620 7468 6520 696e 6469 6365 7320 6f66  f the indices of
+00003df0: 2074 6865 2076 616c 7565 7320 746f 2065   the values to e
+00003e00: 7874 7261 6374 2e0a 2020 2020 2020 2020  xtract..        
+00003e10: 2020 2020 5468 6520 6469 6d65 6e73 696f      The dimensio
+00003e20: 6e20 616e 6420 7661 6c75 6520 6c69 7374  n and value list
+00003e30: 206c 656e 6774 6820 6361 6e20 6265 2075   length can be u
+00003e40: 7020 746f 2074 6865 206e 756d 6265 7220  p to the number 
+00003e50: 6f66 2064 696d 656e 7369 6f6e 7320 2d20  of dimensions - 
+00003e60: 312e 0a20 2020 2020 2020 2020 2020 2054  1..            T
+00003e70: 6865 2063 616c 6c20 6765 745f 6461 7461  he call get_data
+00003e80: 2864 696d 656e 7369 6f6e 3d5b 5b31 2c20  (dimension=[[1, 
+00003e90: 325d 2c20 5b32 2c20 335d 5d29 2069 7320  2], [2, 3]]) is 
+00003ea0: 6571 7569 7661 6c65 6e74 2074 6f20 6461  equivalent to da
+00003eb0: 7461 5b3a 2c20 322c 2033 5d20 7768 656e  ta[:, 2, 3] when
+00003ec0: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
+00003ed0: 2020 6973 2069 6e20 6d65 6d6f 7279 2e0a    is in memory..
+00003ee0: 2020 2020 2020 2020 2020 2020 5468 6520              The 
+00003ef0: 6178 6973 206f 6620 7468 6520 6469 6d65  axis of the dime
+00003f00: 6e73 696f 6e20 6973 2073 6f20 7468 6174  nsion is so that
+00003f10: 206c 6f77 6572 2074 6865 2061 7869 732c   lower the axis,
+00003f20: 2066 6173 7465 7374 2074 6865 2064 696d   fastest the dim
+00003f30: 656e 7369 6f6e 2028 6869 6768 6572 2063  ension (higher c
+00003f40: 6861 6e67 696e 670a 2020 2020 2020 2020  hanging.        
+00003f50: 2020 2020 7661 6c75 6529 2e0a 0a20 2020      value)...   
+00003f60: 2020 2020 203a 7265 7475 726e 3a20 4172       :return: Ar
+00003f70: 7261 7920 7769 7468 2074 6865 206e 6577  ray with the new
+00003f80: 2064 6174 612e 0a20 2020 2020 2020 2022   data..        "
+00003f90: 2222 0a20 2020 2020 2020 2069 6620 6469  "".        if di
+00003fa0: 6d65 6e73 696f 6e20 6973 206e 6f74 204e  mension is not N
+00003fb0: 6f6e 6520 616e 6420 6c65 6e28 7365 6c66  one and len(self
+00003fc0: 2e5f 6461 7461 2e73 6861 7065 2920 3e20  ._data.shape) > 
+00003fd0: 333a 0a20 2020 2020 2020 2020 2020 2023  3:.            #
+00003fe0: 204d 616b 6520 7375 7265 2064 696d 656e   Make sure dimen
+00003ff0: 7369 6f6e 2061 6e64 2076 616c 7565 2061  sion and value a
+00004000: 7265 206c 6973 7473 0a20 2020 2020 2020  re lists.       
+00004010: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00004020: 6365 2864 696d 656e 7369 6f6e 5b30 5d2c  ce(dimension[0],
+00004030: 2069 6e74 293a 0a20 2020 2020 2020 2020   int):.         
+00004040: 2020 2020 2020 2064 696d 656e 7369 6f6e         dimension
+00004050: 5b30 5d20 3d20 5b64 696d 656e 7369 6f6e  [0] = [dimension
+00004060: 5b30 5d5d 0a20 2020 2020 2020 2020 2020  [0]].           
+00004070: 2020 2020 2064 696d 656e 7369 6f6e 5b31       dimension[1
+00004080: 5d20 3d20 5b64 696d 656e 7369 6f6e 5b31  ] = [dimension[1
+00004090: 5d5d 0a20 2020 2020 2020 2020 2020 2064  ]].            d
+000040a0: 6174 6120 3d20 7365 6c66 2e64 6174 610a  ata = self.data.
+000040b0: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
+000040c0: 6e69 7420 6c69 7374 206f 6620 626f 6f6c  nit list of bool
+000040d0: 2069 6e64 6963 6573 0a20 2020 2020 2020   indices.       
+000040e0: 2020 2020 2062 6f6f 6c5f 696e 6469 6365       bool_indice
+000040f0: 7320 3d20 6e75 6d70 792e 7a65 726f 7328  s = numpy.zeros(
+00004100: 7365 6c66 2e64 6174 612e 6e66 7261 6d65  self.data.nframe
+00004110: 732c 2064 7479 7065 3d62 6f6f 6c29 0a20  s, dtype=bool). 
+00004120: 2020 2020 2020 2020 2020 2069 6620 696e             if in
+00004130: 6469 6365 7320 6973 204e 6f6e 653a 0a20  dices is None:. 
+00004140: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00004150: 6e64 6963 6573 203d 206e 756d 7079 2e61  ndices = numpy.a
+00004160: 7261 6e67 6528 7365 6c66 2e6e 6672 616d  range(self.nfram
+00004170: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
+00004180: 626f 6f6c 5f69 6e64 6963 6573 5b69 6e64  bool_indices[ind
+00004190: 6963 6573 5d20 3d20 5472 7565 0a20 2020  ices] = True.   
+000041a0: 2020 2020 2020 2020 2062 6f6f 6c5f 696e           bool_in
+000041b0: 6469 6365 7320 3d20 626f 6f6c 5f69 6e64  dices = bool_ind
+000041c0: 6963 6573 2e72 6573 6861 7065 2873 656c  ices.reshape(sel
+000041d0: 662e 6461 7461 2e73 6361 6e5f 7368 6170  f.data.scan_shap
+000041e0: 6529 0a20 2020 2020 2020 2020 2020 2069  e).            i
+000041f0: 6e64 7820 3d20 6e75 6d70 792e 6172 616e  ndx = numpy.aran
+00004200: 6765 2873 656c 662e 6e66 7261 6d65 7329  ge(self.nframes)
+00004210: 2e72 6573 6861 7065 2873 656c 662e 6461  .reshape(self.da
+00004220: 7461 2e73 6361 6e5f 7368 6170 6529 0a0a  ta.scan_shape)..
+00004230: 2020 2020 2020 2020 2020 2020 2320 466f              # Fo
+00004240: 7220 6576 6572 7920 6178 6973 2c20 6765  r every axis, ge
+00004250: 7420 636f 7272 6573 706f 6e64 696e 6720  t corresponding 
+00004260: 656c 656d 656e 7473 0a20 2020 2020 2020  elements.       
+00004270: 2020 2020 2066 6f72 2069 2c20 6469 6d20       for i, dim 
+00004280: 696e 2065 6e75 6d65 7261 7465 2873 6f72  in enumerate(sor
+00004290: 7465 6428 6469 6d65 6e73 696f 6e5b 305d  ted(dimension[0]
+000042a0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+000042b0: 2020 2020 2320 466c 6970 2061 7869 7320      # Flip axis 
+000042c0: 746f 2062 6520 636f 6e73 6973 7465 6e74  to be consistent
+000042d0: 2077 6974 6820 7468 6520 6461 7461 2073   with the data s
+000042e0: 6861 7065 0a20 2020 2020 2020 2020 2020  hape.           
+000042f0: 2020 2020 2061 7869 7320 3d20 7365 6c66       axis = self
+00004300: 2e64 696d 732e 6e64 696d 202d 2064 696d  .dims.ndim - dim
+00004310: 202d 2031 0a20 2020 2020 2020 2020 2020   - 1.           
+00004320: 2020 2020 2064 6174 6120 3d20 6461 7461       data = data
+00004330: 2e74 616b 6528 696e 6469 6365 733d 6469  .take(indices=di
+00004340: 6d65 6e73 696f 6e5b 315d 5b69 5d2c 2061  mension[1][i], a
+00004350: 7869 733d 6178 6973 290a 2020 2020 2020  xis=axis).      
+00004360: 2020 2020 2020 2020 2020 626f 6f6c 5f69            bool_i
+00004370: 6e64 6963 6573 203d 2062 6f6f 6c5f 696e  ndices = bool_in
+00004380: 6469 6365 732e 7461 6b65 2869 6e64 6963  dices.take(indic
+00004390: 6573 3d64 696d 656e 7369 6f6e 5b31 5d5b  es=dimension[1][
+000043a0: 695d 2c20 6178 6973 3d61 7869 7329 0a20  i], axis=axis). 
+000043b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000043c0: 6e64 7820 3d20 696e 6478 2e74 616b 6528  ndx = indx.take(
+000043d0: 696e 6469 6365 733d 6469 6d65 6e73 696f  indices=dimensio
+000043e0: 6e5b 315d 5b69 5d2c 2061 7869 733d 6178  n[1][i], axis=ax
+000043f0: 6973 290a 0a20 2020 2020 2020 2020 2020  is)..           
+00004400: 2064 6174 6120 3d20 6461 7461 5b62 6f6f   data = data[boo
+00004410: 6c5f 696e 6469 6365 735d 0a20 2020 2020  l_indices].     
+00004420: 2020 2020 2020 2069 6e64 7820 3d20 696e         indx = in
+00004430: 6478 5b62 6f6f 6c5f 696e 6469 6365 735d  dx[bool_indices]
+00004440: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00004450: 7265 7475 726e 5f69 6e64 6963 6573 3a0a  return_indices:.
+00004460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004470: 7265 7475 726e 2064 6174 612e 666c 6174  return data.flat
+00004480: 7465 6e28 292c 2069 6e64 782e 666c 6174  ten(), indx.flat
+00004490: 7465 6e28 290a 2020 2020 2020 2020 2020  ten().          
+000044a0: 2020 7265 7475 726e 2064 6174 612e 666c    return data.fl
+000044b0: 6174 7465 6e28 290a 0a20 2020 2020 2020  atten()..       
+000044c0: 2064 6174 6120 3d20 7365 6c66 2e64 6174   data = self.dat
+000044d0: 612e 666c 6174 7465 6e28 290a 2020 2020  a.flatten().    
+000044e0: 2020 2020 6966 2072 6574 7572 6e5f 696e      if return_in
+000044f0: 6469 6365 733a 0a20 2020 2020 2020 2020  dices:.         
+00004500: 2020 2069 6620 696e 6469 6365 7320 6973     if indices is
+00004510: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00004520: 2020 2020 2020 2069 6e64 6963 6573 203d         indices =
+00004530: 206e 756d 7079 2e61 7261 6e67 6528 7365   numpy.arange(se
+00004540: 6c66 2e6e 6672 616d 6573 290a 2020 2020  lf.nframes).    
+00004550: 2020 2020 2020 2020 7265 7475 726e 2064          return d
+00004560: 6174 615b 696e 6469 6365 735d 2c20 696e  ata[indices], in
+00004570: 6469 6365 730a 2020 2020 2020 2020 6966  dices.        if
+00004580: 2069 6e64 6963 6573 2069 7320 4e6f 6e65   indices is None
+00004590: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+000045a0: 7475 726e 2064 6174 610a 2020 2020 2020  turn data.      
+000045b0: 2020 7265 7475 726e 2064 6174 615b 696e    return data[in
+000045c0: 6469 6365 735d 0a0a 2020 2020 4070 726f  dices]..    @pro
+000045d0: 7065 7274 790a 2020 2020 6465 6620 6e66  perty.    def nf
+000045e0: 7261 6d65 7328 7365 6c66 293a 0a20 2020  rames(self):.   
+000045f0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00004600: 2052 6574 7572 6e20 6e75 6d62 6572 206f   Return number o
+00004610: 6620 6672 616d 6573 0a20 2020 2020 2020  f frames.       
+00004620: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
+00004630: 7365 6c66 2e64 6174 6120 6973 204e 6f6e  self.data is Non
+00004640: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00004650: 6574 7572 6e20 300a 2020 2020 2020 2020  eturn 0.        
+00004660: 7265 7475 726e 2073 656c 662e 6461 7461  return self.data
+00004670: 2e6e 6672 616d 6573 0a0a 2020 2020 6465  .nframes..    de
+00004680: 6620 746f 5f6d 656d 6f72 7928 7365 6c66  f to_memory(self
+00004690: 2c20 696e 6469 6365 7329 3a0a 2020 2020  , indices):.    
+000046a0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+000046b0: 4d65 7468 6f64 2074 6f20 6c6f 6164 206f  Method to load o
+000046c0: 6e6c 7920 7061 7274 206f 6620 7468 6520  nly part of the 
+000046d0: 6461 7461 2069 6e74 6f20 6d65 6d6f 7279  data into memory
+000046e0: 2e0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+000046f0: 7320 6120 6e65 7720 6461 7461 7365 7420  s a new dataset 
+00004700: 7769 7468 2074 6865 2064 6174 6120 636f  with the data co
+00004710: 7272 6573 706f 6e64 696e 6720 746f 2067  rresponding to g
+00004720: 6976 656e 2069 6e64 6963 6573 2069 6e74  iven indices int
+00004730: 6f20 6d65 6d6f 7279 2e0a 2020 2020 2020  o memory..      
+00004740: 2020 5468 6520 6e65 7720 696e 6469 6365    The new indice
+00004750: 7320 6172 7261 7920 6861 7320 746f 2062  s array has to b
+00004760: 6520 6769 7665 6e2c 2069 6620 616c 6c20  e given, if all 
+00004770: 7468 6520 6461 7461 2068 6173 2074 6f20  the data has to 
+00004780: 6265 2073 6574 2069 6e74 6f0a 2020 2020  be set into.    
+00004790: 2020 2020 6d65 6d6f 7279 2070 6c65 6173      memory pleas
+000047a0: 6520 7365 7420 6069 6e5f 6d65 6d6f 7279  e set `in_memory
+000047b0: 6020 746f 2054 7275 6520 696e 7374 6561  ` to True instea
+000047c0: 642c 2074 6869 7320 7761 7920 6e6f 206e  d, this way no n
+000047d0: 6577 2064 6174 6173 6574 2077 696c 6c20  ew dataset will 
+000047e0: 6265 0a20 2020 2020 2020 2063 7265 6174  be.        creat
+000047f0: 6564 2e0a 0a20 2020 2020 2020 203a 7061  ed...        :pa
+00004800: 7261 6d20 6172 7261 795f 6c69 6b65 2069  ram array_like i
+00004810: 6e64 6963 6573 3a20 496e 6469 6365 7320  ndices: Indices 
+00004820: 6f66 2074 6865 206e 6577 2064 6174 6173  of the new datas
+00004830: 6574 2e0a 2020 2020 2020 2020 2222 220a  et..        """.
+00004840: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+00004850: 656c 662e 5f69 6e5f 6d65 6d6f 7279 3a0a  elf._in_memory:.
+00004860: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00004870: 203d 2073 656c 662e 6765 745f 6461 7461   = self.get_data
+00004880: 2869 6e64 6963 6573 290a 2020 2020 2020  (indices).      
+00004890: 2020 2020 2020 6e65 775f 6461 7461 203d        new_data =
+000048a0: 2044 6174 6128 6461 7461 2e75 726c 732c   Data(data.urls,
+000048b0: 2064 6174 612e 6d65 7461 6461 7461 2c20   data.metadata, 
+000048c0: 5472 7565 290a 2020 2020 2020 2020 656c  True).        el
+000048d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000048e0: 6e65 775f 6461 7461 203d 2073 656c 662e  new_data = self.
+000048f0: 6765 745f 6461 7461 2869 6e64 6963 6573  get_data(indices
+00004900: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00004910: 2044 6174 6173 6574 280a 2020 2020 2020   Dataset(.      
+00004920: 2020 2020 2020 5f64 6972 3d73 656c 662e        _dir=self.
+00004930: 5f64 6972 2c0a 2020 2020 2020 2020 2020  _dir,.          
+00004940: 2020 6461 7461 3d6e 6577 5f64 6174 612c    data=new_data,
+00004950: 0a20 2020 2020 2020 2020 2020 2064 696d  .            dim
+00004960: 733d 7365 6c66 2e5f 5f64 696d 732c 0a20  s=self.__dims,. 
+00004970: 2020 2020 2020 2020 2020 2069 6e5f 6d65             in_me
+00004980: 6d6f 7279 3d54 7275 652c 0a20 2020 2020  mory=True,.     
+00004990: 2020 2020 2020 2074 6974 6c65 3d73 656c         title=sel
+000049a0: 662e 7469 746c 652c 0a20 2020 2020 2020  f.title,.       
+000049b0: 2029 0a0a 2020 2020 4070 726f 7065 7274   )..    @propert
+000049c0: 790a 2020 2020 6465 6620 6469 6d73 2873  y.    def dims(s
+000049d0: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
+000049e0: 7475 726e 2073 656c 662e 5f5f 6469 6d73  turn self.__dims
+000049f0: 0a0a 2020 2020 4064 696d 732e 7365 7474  ..    @dims.sett
+00004a00: 6572 0a20 2020 2064 6566 2064 696d 7328  er.    def dims(
+00004a10: 7365 6c66 2c20 5f64 696d 7329 3a0a 2020  self, _dims):.  
+00004a20: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+00004a30: 6e73 7461 6e63 6528 5f64 696d 732c 2041  nstance(_dims, A
+00004a40: 6371 7569 7369 7469 6f6e 4469 6d73 292c  cquisitionDims),
+00004a50: 2028 0a20 2020 2020 2020 2020 2020 2022   (.            "
+00004a60: 4469 6d65 6e73 696f 6e73 2064 6963 7469  Dimensions dicti
+00004a70: 6f6e 6172 7920 6861 7320 2220 2274 6f20  onary has " "to 
+00004a80: 6265 206f 6620 636c 6173 7320 6041 6371  be of class `Acq
+00004a90: 7569 7369 7469 6f6e 4469 6d73 6022 0a20  uisitionDims`". 
+00004aa0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00004ab0: 2073 656c 662e 5f5f 6469 6d73 203d 205f   self.__dims = _
+00004ac0: 6469 6d73 0a0a 2020 2020 6465 6620 636c  dims..    def cl
+00004ad0: 6561 725f 6469 6d73 2873 656c 6629 3a0a  ear_dims(self):.
+00004ae0: 2020 2020 2020 2020 7365 6c66 2e5f 5f64          self.__d
+00004af0: 696d 7320 3d20 4163 7175 6973 6974 696f  ims = Acquisitio
+00004b00: 6e44 696d 7328 290a 0a20 2020 2064 6566  nDims()..    def
+00004b10: 2061 6464 5f64 696d 2873 656c 662c 2061   add_dim(self, a
+00004b20: 7869 732c 2064 696d 293a 0a20 2020 2020  xis, dim):.     
+00004b30: 2020 2022 2222 0a20 2020 2020 2020 2041     """.        A
+00004b40: 6464 7320 6120 6469 6d65 6e73 696f 6e20  dds a dimension 
+00004b50: 746f 2074 6865 2064 696d 656e 7369 6f6e  to the dimension
+00004b60: 2773 2064 6963 7469 6f6e 6172 792e 0a0a  's dictionary...
+00004b70: 2020 2020 2020 2020 3a70 6172 616d 2069          :param i
+00004b80: 6e74 2061 7869 733a 2061 7869 7320 6f66  nt axis: axis of
+00004b90: 2074 6865 2064 696d 656e 7369 6f6e 2e0a   the dimension..
+00004ba0: 2020 2020 2020 2020 3a70 6172 616d 2060          :param `
+00004bb0: 4469 6d65 6e73 696f 6e60 2064 696d 3a20  Dimension` dim: 
+00004bc0: 6469 6d65 6e73 696f 6e20 746f 2062 6520  dimension to be 
+00004bd0: 6164 6465 642e 0a20 2020 2020 2020 2022  added..        "
+00004be0: 2222 0a20 2020 2020 2020 2073 656c 662e  "".        self.
+00004bf0: 5f5f 6469 6d73 2e61 6464 5f64 696d 2861  __dims.add_dim(a
+00004c00: 7869 732c 2064 696d 290a 0a20 2020 2064  xis, dim)..    d
+00004c10: 6566 2072 656d 6f76 655f 6469 6d28 7365  ef remove_dim(se
+00004c20: 6c66 2c20 6178 6973 293a 0a20 2020 2020  lf, axis):.     
+00004c30: 2020 2022 2222 0a20 2020 2020 2020 2052     """.        R
+00004c40: 656d 6f76 6573 2061 2064 696d 656e 7369  emoves a dimensi
+00004c50: 6f6e 2066 726f 6d20 7468 6520 6469 6d65  on from the dime
+00004c60: 6e73 696f 6e27 7320 6469 6374 696f 6e61  nsion's dictiona
+00004c70: 7279 2e0a 0a20 2020 2020 2020 203a 7061  ry...        :pa
+00004c80: 7261 6d20 696e 7420 6178 6973 3a20 6178  ram int axis: ax
+00004c90: 6973 206f 6620 7468 6520 6469 6d65 6e73  is of the dimens
+00004ca0: 696f 6e2e 0a20 2020 2020 2020 2022 2222  ion..        """
+00004cb0: 0a20 2020 2020 2020 2073 656c 662e 5f5f  .        self.__
+00004cc0: 6469 6d73 2e72 656d 6f76 655f 6469 6d28  dims.remove_dim(
+00004cd0: 6178 6973 290a 0a20 2020 2064 6566 207a  axis)..    def z
+00004ce0: 7375 6d28 7365 6c66 2c20 696e 6469 6365  sum(self, indice
+00004cf0: 733d 4e6f 6e65 2c20 6469 6d65 6e73 696f  s=None, dimensio
+00004d00: 6e3d 4e6f 6e65 293a 0a20 2020 2020 2020  n=None):.       
+00004d10: 2064 6174 6120 3d20 7365 6c66 2e67 6574   data = self.get
+00004d20: 5f64 6174 6128 696e 6469 6365 732c 2064  _data(indices, d
+00004d30: 696d 656e 7369 6f6e 290a 2020 2020 2020  imension).      
+00004d40: 2020 7265 7475 726e 2064 6174 612e 7375    return data.su
+00004d50: 6d28 6178 6973 3d30 290a 0a20 2020 2064  m(axis=0)..    d
+00004d60: 6566 2072 6573 6861 7065 5f64 6174 6128  ef reshape_data(
+00004d70: 7365 6c66 293a 0a20 2020 2020 2020 2022  self):.        "
+00004d80: 2222 0a20 2020 2020 2020 2046 756e 6374  "".        Funct
+00004d90: 696f 6e20 7468 6174 2072 6573 6861 7065  ion that reshape
+00004da0: 7320 7468 6520 6461 7461 2074 6f20 6669  s the data to fi
+00004db0: 7420 7468 6520 6469 6d65 6e73 696f 6e73  t the dimensions
+00004dc0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00004dd0: 2020 2020 2020 6e64 696d 203d 2073 656c        ndim = sel
+00004de0: 662e 5f5f 6469 6d73 2e6e 6469 6d0a 2020  f.__dims.ndim.  
+00004df0: 2020 2020 2020 6966 206e 6469 6d20 3d3d        if ndim ==
+00004e00: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00004e10: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00004e20: 2822 4e6f 2064 696d 656e 7369 6f6e 7320  ("No dimensions 
+00004e30: 6172 6520 6c69 7374 6564 2229 0a0a 2020  are listed")..  
+00004e40: 2020 2020 2020 6966 206e 6469 6d20 3d3d        if ndim ==
+00004e50: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+00004e60: 6e66 7261 6d65 735f 6578 7065 6374 6564  nframes_expected
+00004e70: 203d 2073 656c 662e 5f5f 6469 6d73 2e67   = self.__dims.g
+00004e80: 6574 2830 292e 7369 7a65 0a20 2020 2020  et(0).size.     
+00004e90: 2020 2020 2020 2069 6620 6e66 7261 6d65         if nframe
+00004ea0: 735f 6578 7065 6374 6564 2021 3d20 7365  s_expected != se
+00004eb0: 6c66 2e6e 6672 616d 6573 3a0a 2020 2020  lf.nframes:.    
+00004ec0: 2020 2020 2020 2020 2020 2020 6469 6d65              dime
+00004ed0: 6e73 696f 6e20 3d20 2220 222e 6a6f 696e  nsion = " ".join
+00004ee0: 2873 656c 662e 5f5f 6469 6d73 2e67 6574  (self.__dims.get
+00004ef0: 5f6e 616d 6573 2829 290a 2020 2020 2020  _names()).      
+00004f00: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00004f10: 5661 6c75 6545 7272 6f72 280a 2020 2020  ValueError(.    
+00004f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004f30: 6622 4469 6d65 6e73 696f 6e20 7b64 696d  f"Dimension {dim
+00004f40: 656e 7369 6f6e 7d20 6861 7320 7b6e 6672  ension} has {nfr
+00004f50: 616d 6573 5f65 7870 6563 7465 647d 2070  ames_expected} p
+00004f60: 6f69 6e74 7320 7768 696c 6520 7468 6572  oints while ther
+00004f70: 6520 6172 6520 7b73 656c 662e 6e66 7261  e are {self.nfra
+00004f80: 6d65 737d 2069 6d61 6765 732e 2054 7279  mes} images. Try
+00004f90: 2075 7369 6e67 206f 7468 6572 2074 6f6c   using other tol
+00004fa0: 6572 616e 6365 206f 7220 7374 6570 2076  erance or step v
+00004fb0: 616c 7565 732e 220a 2020 2020 2020 2020  alues.".        
+00004fc0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00004fd0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00004fe0: 660a 0a20 2020 2020 2020 2064 696d 735f  f..        dims_
+00004ff0: 7368 6170 6520 3d20 7365 6c66 2e5f 5f64  shape = self.__d
+00005000: 696d 732e 7368 6170 650a 2020 2020 2020  ims.shape.      
+00005010: 2020 6f72 675f 6461 7461 203d 2073 656c    org_data = sel
+00005020: 662e 6765 745f 6461 7461 2829 0a20 2020  f.get_data().   
+00005030: 2020 2020 206f 7267 5f73 6861 7065 203d       org_shape =
+00005040: 206f 7267 5f64 6174 612e 7368 6170 650a   org_data.shape.
+00005050: 2020 2020 2020 2020 696d 675f 7368 6170          img_shap
+00005060: 6520 3d20 286f 7267 5f73 6861 7065 5b2d  e = (org_shape[-
+00005070: 325d 2c20 6f72 675f 7368 6170 655b 2d31  2], org_shape[-1
+00005080: 5d29 0a20 2020 2020 2020 206e 6577 5f73  ]).        new_s
+00005090: 6861 7065 203d 2064 696d 735f 7368 6170  hape = dims_shap
+000050a0: 6520 2b20 696d 675f 7368 6170 650a 2020  e + img_shape.  
+000050b0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+000050c0: 2020 2020 2020 2064 6174 6120 3d20 6f72         data = or
+000050d0: 675f 6461 7461 2e72 6573 6861 7065 286e  g_data.reshape(n
+000050e0: 6577 5f73 6861 7065 290a 2020 2020 2020  ew_shape).      
+000050f0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+00005100: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
+00005110: 6469 6d65 6e73 696f 6e73 203d 2022 2022  dimensions = " "
+00005120: 2e6a 6f69 6e28 7365 6c66 2e5f 5f64 696d  .join(self.__dim
+00005130: 732e 6765 745f 6e61 6d65 7328 2929 0a20  s.get_names()). 
+00005140: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00005150: 2056 616c 7565 4572 726f 7228 0a20 2020   ValueError(.   
+00005160: 2020 2020 2020 2020 2020 2020 2066 2244               f"D
+00005170: 696d 656e 7369 6f6e 7320 7b64 696d 656e  imensions {dimen
+00005180: 7369 6f6e 737d 2068 6176 6520 7b64 696d  sions} have {dim
+00005190: 735f 7368 6170 657d 2070 6f69 6e74 7320  s_shape} points 
+000051a0: 7768 696c 6520 7468 6572 6520 6172 6520  while there are 
+000051b0: 7b6f 7267 5f73 6861 7065 5b3a 2d32 5d7d  {org_shape[:-2]}
+000051c0: 2069 6d61 6765 732e 2054 7279 2075 7369   images. Try usi
+000051d0: 6e67 206f 7468 6572 2074 6f6c 6572 616e  ng other toleran
+000051e0: 6365 206f 7220 7374 6570 2076 616c 7565  ce or step value
+000051f0: 732e 220a 2020 2020 2020 2020 2020 2020  s.".            
+00005200: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00005210: 6e20 4461 7461 7365 7428 0a20 2020 2020  n Dataset(.     
+00005220: 2020 2020 2020 205f 6469 723d 7365 6c66         _dir=self
+00005230: 2e64 6972 2c0a 2020 2020 2020 2020 2020  .dir,.          
+00005240: 2020 6461 7461 3d64 6174 612c 0a20 2020    data=data,.   
+00005250: 2020 2020 2020 2020 2064 696d 733d 7365           dims=se
+00005260: 6c66 2e5f 5f64 696d 732c 0a20 2020 2020  lf.__dims,.     
+00005270: 2020 2020 2020 2069 6e5f 6d65 6d6f 7279         in_memory
+00005280: 3d73 656c 662e 5f69 6e5f 6d65 6d6f 7279  =self._in_memory
+00005290: 2c0a 2020 2020 2020 2020 2020 2020 7469  ,.            ti
+000052a0: 746c 653d 7365 6c66 2e74 6974 6c65 2c0a  tle=self.title,.
+000052b0: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
+000052c0: 6566 2066 696e 645f 6469 6d65 6e73 696f  ef find_dimensio
+000052d0: 6e73 2873 656c 662c 206b 696e 642c 2074  ns(self, kind, t
+000052e0: 6f6c 6572 616e 6365 3d31 652d 3929 202d  olerance=1e-9) -
+000052f0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00005300: 2222 220a 2020 2020 2020 2020 476f 6573  """.        Goes
+00005310: 206f 7665 7220 616c 6c20 7468 6520 6865   over all the he
+00005320: 6164 6572 7320 6672 6f6d 2061 2067 6976  aders from a giv
+00005330: 656e 206b 696e 6420 616e 6420 6669 6e64  en kind and find
+00005340: 7320 7468 6520 6469 6d65 6e73 696f 6e73  s the dimensions
+00005350: 0a20 2020 2020 2020 2074 6861 7420 6d6f  .        that mo
+00005360: 7665 2028 6861 7665 206d 6f72 6520 7468  ve (have more th
+00005370: 616e 206f 6e65 2076 616c 7565 2920 616c  an one value) al
+00005380: 6f6e 6720 7468 6520 6461 7461 2e0a 0a20  ong the data... 
+00005390: 2020 2020 2020 204e 6f74 653a 2042 6566         Note: Bef
+000053a0: 6f72 652c 206f 6e6c 7920 7468 6520 6469  ore, only the di
+000053b0: 6d65 6e73 696f 6e73 2074 6861 7420 636f  mensions that co
+000053c0: 756c 6420 6669 7420 7768 6572 6520 7368  uld fit where sh
+000053d0: 6f77 6e2c 206e 6f77 2069 740a 2020 2020  own, now it.    
+000053e0: 2020 2020 7368 6f77 7320 616c 6c20 7468      shows all th
+000053f0: 6520 6469 6d65 6e73 696f 6e73 2061 6e64  e dimensions and
+00005400: 206c 6574 2074 6865 2075 7365 7220 6368   let the user ch
+00005410: 6f6f 7365 2074 6865 2076 616c 6964 206f  oose the valid o
+00005420: 6e65 732e 0a0a 2020 2020 2020 2020 3a70  nes...        :p
+00005430: 6172 616d 2069 6e74 206b 696e 643a 2054  aram int kind: T
+00005440: 7970 6520 6f66 206d 6574 6164 6174 6120  ype of metadata 
+00005450: 746f 2066 696e 6420 7468 6520 6469 6d65  to find the dime
+00005460: 6e73 696f 6e73 2e0a 2020 2020 2020 2020  nsions..        
+00005470: 3a70 6172 616d 2066 6c6f 6174 2074 6f6c  :param float tol
+00005480: 6572 616e 6365 3a20 546f 6c65 7261 6e63  erance: Toleranc
+00005490: 6520 7468 6174 2077 696c 6c20 6265 2075  e that will be u
+000054a0: 7365 6420 746f 2063 6f6d 7075 7465 2074  sed to compute t
+000054b0: 6865 0a20 2020 2020 2020 2020 2020 2075  he.            u
+000054c0: 6e69 7175 6520 7661 6c75 6573 2e0a 2020  nique values..  
+000054d0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000054e0: 2020 7365 6c66 2e5f 5f64 696d 732e 636c    self.__dims.cl
+000054f0: 6561 7228 290a 2020 2020 2020 2020 7365  ear().        se
+00005500: 6c66 2e5f 6469 6d65 6e73 696f 6e73 5f76  lf._dimensions_v
+00005510: 616c 7565 7320 3d20 7b7d 0a0a 2020 2020  alues = {}..    
+00005520: 2020 2020 6b65 7973 203d 206e 756d 7079      keys = numpy
+00005530: 2e61 7272 6179 286c 6973 7428 7365 6c66  .array(list(self
+00005540: 2e64 6174 612e 6d65 7461 6461 7461 5b30  .data.metadata[0
+00005550: 5d2e 6765 745f 6b65 7973 286b 696e 6429  ].get_keys(kind)
+00005560: 2929 0a20 2020 2020 2020 2061 6c6c 5f76  )).        all_v
+00005570: 616c 7565 7320 3d20 6e75 6d70 792e 6173  alues = numpy.as
+00005580: 6172 7261 7928 0a20 2020 2020 2020 2020  array(.         
+00005590: 2020 205b 7365 6c66 2e67 6574 5f6d 6574     [self.get_met
+000055a0: 6164 6174 615f 7661 6c75 6573 286b 696e  adata_values(kin
+000055b0: 643d 6b69 6e64 2c20 6b65 793d 6b65 7929  d=kind, key=key)
+000055c0: 2066 6f72 206b 6579 2069 6e20 6b65 7973   for key in keys
+000055d0: 5d0a 2020 2020 2020 2020 290a 0a20 2020  ].        )..   
+000055e0: 2020 2020 2064 696d 656e 7369 6f6e 7320       dimensions 
+000055f0: 3d20 5b5d 0a20 2020 2020 2020 2064 6174  = [].        dat
+00005600: 6173 6574 5f73 697a 6520 3d20 6c65 6e28  aset_size = len(
+00005610: 7365 6c66 2e64 6174 612e 6d65 7461 6461  self.data.metada
+00005620: 7461 290a 2020 2020 2020 2020 2320 466f  ta).        # Fo
+00005630: 7220 6576 6572 7920 6b65 7920 7468 6174  r every key that
+00005640: 2068 6173 206d 6f72 6520 7468 616e 206f   has more than o
+00005650: 6e65 2064 6966 6665 7265 6e74 2076 616c  ne different val
+00005660: 7565 2c20 6372 6561 7465 2061 206e 6577  ue, create a new
+00005670: 2044 696d 656e 7369 6f6e 2e0a 2020 2020   Dimension..    
+00005680: 2020 2020 666f 7220 6b65 792c 2076 616c      for key, val
+00005690: 7565 7320 696e 207a 6970 286b 6579 732c  ues in zip(keys,
+000056a0: 2061 6c6c 5f76 616c 7565 7329 3a0a 2020   all_values):.  
+000056b0: 2020 2020 2020 2020 2020 756e 6971 7565            unique
+000056c0: 5f76 616c 7565 732c 2075 6e69 7175 655f  _values, unique_
+000056d0: 636f 756e 7473 203d 2061 7272 6179 5f75  counts = array_u
+000056e0: 7469 6c73 2e75 6e69 7175 6528 0a20 2020  tils.unique(.   
+000056f0: 2020 2020 2020 2020 2020 2020 2076 616c               val
+00005700: 7565 732c 2072 6574 7572 6e5f 636f 756e  ues, return_coun
+00005710: 7473 3d54 7275 650a 2020 2020 2020 2020  ts=True.        
+00005720: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00005730: 2020 6966 2075 6e69 7175 655f 636f 756e    if unique_coun
+00005740: 7473 5b30 5d20 3d3d 2064 6174 6173 6574  ts[0] == dataset
+00005750: 5f73 697a 653a 0a20 2020 2020 2020 2020  _size:.         
+00005760: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+00005770: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00005780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005790: 2064 696d 656e 7369 6f6e 203d 2044 696d   dimension = Dim
+000057a0: 656e 7369 6f6e 286b 696e 642c 206b 6579  ension(kind, key
+000057b0: 2c20 746f 6c65 7261 6e63 653d 746f 6c65  , tolerance=tole
+000057c0: 7261 6e63 6529 0a20 2020 2020 2020 2020  rance).         
+000057d0: 2020 2020 2020 2064 696d 656e 7369 6f6e         dimension
+000057e0: 2e73 6574 5f75 6e69 7175 655f 7661 6c75  .set_unique_valu
+000057f0: 6573 286e 756d 7079 2e61 7272 6179 2875  es(numpy.array(u
+00005800: 6e69 7175 655f 7661 6c75 6573 2c20 6474  nique_values, dt
+00005810: 7970 653d 666c 6f61 7429 290a 2020 2020  ype=float)).    
+00005820: 2020 2020 2020 2020 2020 2020 5f6c 6f67              _log
+00005830: 6765 722e 696e 666f 280a 2020 2020 2020  ger.info(.      
+00005840: 2020 2020 2020 2020 2020 2020 2020 2241                "A
+00005850: 7869 7320 2564 3a20 6469 6d65 6e73 696f  xis %d: dimensio
+00005860: 6e20 2725 7327 2077 6974 6820 2564 2075  n '%s' with %d u
+00005870: 6e69 7175 6520 7661 6c75 6573 222c 0a20  nique values",. 
+00005880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005890: 2020 206c 656e 2864 696d 656e 7369 6f6e     len(dimension
+000058a0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+000058b0: 2020 2020 2020 2020 6b65 792c 0a20 2020          key,.   
+000058c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000058d0: 206c 656e 2875 6e69 7175 655f 7661 6c75   len(unique_valu
+000058e0: 6573 292c 0a20 2020 2020 2020 2020 2020  es),.           
+000058f0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00005900: 2020 2020 2020 2020 2320 5661 6c75 6520          # Value 
+00005910: 7468 6174 2074 656c 6c73 2077 6865 6e20  that tells when 
+00005920: 646f 6573 2074 6865 2063 6861 6e67 6520  does the change 
+00005930: 6f66 2076 616c 7565 206f 6363 7572 2e20  of value occur. 
+00005940: 4974 2069 7320 7573 6564 2074 6f20 6b6e  It is used to kn
+00005950: 6f77 2074 6865 206f 7264 6572 0a20 2020  ow the order.   
+00005960: 2020 2020 2020 2020 2020 2020 2023 206f               # o
+00005970: 6620 7468 6520 7265 7368 6170 696e 672e  f the reshaping.
+00005980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005990: 2064 696d 656e 7369 6f6e 2e63 6861 6e67   dimension.chang
+000059a0: 696e 675f 7661 6c75 6520 3d20 7365 6c66  ing_value = self
+000059b0: 2e5f 5f63 6f6d 7075 7465 5f63 6861 6e67  .__compute_chang
+000059c0: 696e 675f 7661 6c75 6528 7661 6c75 6573  ing_value(values
+000059d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000059e0: 2020 6469 6d65 6e73 696f 6e73 2e61 7070    dimensions.app
+000059f0: 656e 6428 6469 6d65 6e73 696f 6e29 0a20  end(dimension). 
+00005a00: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00005a10: 7420 5661 6c75 6545 7272 6f72 3a0a 2020  t ValueError:.  
+00005a20: 2020 2020 2020 2020 2020 2020 2020 5f6c                _l
+00005a30: 6f67 6765 722e 7761 726e 696e 6728 2243  ogger.warning("C
+00005a40: 6f75 6c64 6e27 7420 636f 6e76 6572 7420  ouldn't convert 
+00005a50: 746f 2066 6c6f 6174 2229 0a0a 2020 2020  to float")..    
+00005a60: 2020 2020 666f 7220 6469 6d65 6e73 696f      for dimensio
+00005a70: 6e20 696e 2073 6f72 7465 6428 0a20 2020  n in sorted(.   
+00005a80: 2020 2020 2020 2020 2064 696d 656e 7369           dimensi
+00005a90: 6f6e 732c 206b 6579 3d6c 616d 6264 6120  ons, key=lambda 
+00005aa0: 783a 2078 2e63 6861 6e67 696e 675f 7661  x: x.changing_va
+00005ab0: 6c75 652c 2072 6576 6572 7365 3d54 7275  lue, reverse=Tru
+00005ac0: 650a 2020 2020 2020 2020 293a 0a20 2020  e.        ):.   
+00005ad0: 2020 2020 2020 2020 2073 656c 662e 5f5f           self.__
+00005ae0: 6469 6d73 2e61 6464 5f64 696d 2861 7869  dims.add_dim(axi
+00005af0: 733d 7365 6c66 2e5f 5f64 696d 732e 6e64  s=self.__dims.nd
+00005b00: 696d 2c20 6469 6d3d 6469 6d65 6e73 696f  im, dim=dimensio
+00005b10: 6e29 0a20 2020 2020 2020 2020 2020 205f  n).            _
+00005b20: 6c6f 6767 6572 2e69 6e66 6f28 0a20 2020  logger.info(.   
+00005b30: 2020 2020 2020 2020 2020 2020 2022 4469               "Di
+00005b40: 6d65 6e73 696f 6e20 2573 206f 6620 7369  mension %s of si
+00005b50: 7a65 2025 6420 6861 7320 6265 656e 2061  ze %d has been a
+00005b60: 6464 6564 2066 6f72 2072 6573 6861 7069  dded for reshapi
+00005b70: 6e67 222c 0a20 2020 2020 2020 2020 2020  ng",.           
+00005b80: 2020 2020 2064 696d 656e 7369 6f6e 2e6e       dimension.n
+00005b90: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+00005ba0: 2020 2020 2064 696d 656e 7369 6f6e 2e73       dimension.s
+00005bb0: 697a 652c 0a20 2020 2020 2020 2020 2020  ize,.           
+00005bc0: 2029 0a0a 2020 2020 6465 6620 6765 745f   )..    def get_
+00005bd0: 6d65 7461 6461 7461 5f76 616c 7565 7328  metadata_values(
+00005be0: 0a20 2020 2020 2020 2073 656c 662c 206b  .        self, k
+00005bf0: 696e 642c 206b 6579 2c20 696e 6469 6365  ind, key, indice
+00005c00: 733d 4e6f 6e65 2c20 6469 6d65 6e73 696f  s=None, dimensio
+00005c10: 6e3d 4e6f 6e65 0a20 2020 2029 202d 3e20  n=None.    ) -> 
+00005c20: 6e75 6d70 792e 6e64 6172 7261 793a 0a20  numpy.ndarray:. 
+00005c30: 2020 2020 2020 206d 6574 6164 6174 6120         metadata 
+00005c40: 3d20 7365 6c66 2e67 6574 5f64 6174 6128  = self.get_data(
+00005c50: 696e 6469 6365 732c 2064 696d 656e 7369  indices, dimensi
+00005c60: 6f6e 292e 6d65 7461 6461 7461 0a20 2020  on).metadata.   
+00005c70: 2020 2020 2076 616c 7565 7320 3d20 5f65       values = _e
+00005c80: 7874 7261 6374 5f6d 6574 6164 6174 615f  xtract_metadata_
+00005c90: 7661 6c75 6573 280a 2020 2020 2020 2020  values(.        
+00005ca0: 2020 2020 6d65 7461 6461 7461 2c0a 2020      metadata,.  
+00005cb0: 2020 2020 2020 2020 2020 6b69 6e64 2c0a            kind,.
+00005cc0: 2020 2020 2020 2020 2020 2020 6b65 792c              key,
+00005cd0: 0a20 2020 2020 2020 2020 2020 206d 6973  .            mis
+00005ce0: 7369 6e67 5f76 616c 7565 3d6e 756d 7079  sing_value=numpy
+00005cf0: 2e6e 616e 2c0a 2020 2020 2020 2020 2020  .nan,.          
+00005d00: 2020 7461 6b65 5f70 7265 7669 6f75 735f    take_previous_
+00005d10: 7768 656e 5f6d 6973 7369 6e67 3d54 7275  when_missing=Tru
+00005d20: 652c 0a20 2020 2020 2020 2029 0a20 2020  e,.        ).   
+00005d30: 2020 2020 2072 6574 7572 6e20 6e75 6d70       return nump
+00005d40: 792e 6173 6172 7261 7928 7661 6c75 6573  y.asarray(values
+00005d50: 2920 2023 206d 616b 6573 2073 7572 6520  )  # makes sure 
+00005d60: 7468 6579 2061 6c6c 2068 6176 6520 7468  they all have th
+00005d70: 6520 7361 6d65 2064 7479 7065 0a0a 2020  e same dtype..  
+00005d80: 2020 6465 6620 5f5f 636f 6d70 7574 655f    def __compute_
+00005d90: 6368 616e 6769 6e67 5f76 616c 7565 2873  changing_value(s
+00005da0: 656c 662c 2076 616c 7565 732c 2063 6861  elf, values, cha
+00005db0: 6e67 696e 675f 7661 6c75 653d 3129 3a0a  nging_value=1):.
+00005dc0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00005dd0: 2020 2020 5265 6375 7273 6976 6520 6d65      Recursive me
+00005de0: 7468 6f64 2075 7365 6420 746f 2063 616c  thod used to cal
+00005df0: 6375 6c61 7465 2068 6f77 2066 6173 7420  culate how fast 
+00005e00: 6973 2061 2064 696d 656e 7369 6f6e 2e20  is a dimension. 
+00005e10: 5468 6520 7370 6565 6420 6f66 2061 2064  The speed of a d
+00005e20: 696d 656e 7369 6f6e 2069 7320 7468 6520  imension is the 
+00005e30: 6e75 6d62 6572 206f 660a 2020 2020 2020  number of.      
+00005e40: 2020 7469 6d65 7320 7468 6520 6469 6d65    times the dime
+00005e50: 6e73 696f 6e20 6368 616e 6765 7320 6f66  nsion changes of
+00005e60: 2076 616c 7565 2077 6869 6c65 206d 6f76   value while mov
+00005e70: 696e 6720 7468 726f 7567 6820 7468 6520  ing through the 
+00005e80: 6461 7461 7365 742e 0a20 2020 2020 2020  dataset..       
+00005e90: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
+00005ea0: 6c65 6e28 6e75 6d70 792e 756e 6971 7565  len(numpy.unique
+00005eb0: 2876 616c 7565 7329 2920 3e20 313a 0a20  (values)) > 1:. 
+00005ec0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00005ed0: 6e20 7365 6c66 2e5f 5f63 6f6d 7075 7465  n self.__compute
+00005ee0: 5f63 6861 6e67 696e 675f 7661 6c75 6528  _changing_value(
+00005ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005f00: 2076 616c 7565 735b 3a20 696e 7428 6c65   values[: int(le
+00005f10: 6e28 7661 6c75 6573 2920 2f20 3229 5d2c  n(values) / 2)],
+00005f20: 2063 6861 6e67 696e 675f 7661 6c75 6520   changing_value 
+00005f30: 2b20 310a 2020 2020 2020 2020 2020 2020  + 1.            
+00005f40: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00005f50: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00005f60: 726e 2063 6861 6e67 696e 675f 7661 6c75  rn changing_valu
+00005f70: 650a 0a20 2020 2064 6566 2067 6574 5f64  e..    def get_d
+00005f80: 696d 656e 7369 6f6e 735f 7661 6c75 6573  imensions_values
+00005f90: 2873 656c 662c 2069 6e64 6963 6573 3d4e  (self, indices=N
+00005fa0: 6f6e 6529 3a0a 2020 2020 2020 2020 2222  one):.        ""
+00005fb0: 220a 2020 2020 2020 2020 5265 7475 726e  ".        Return
+00005fc0: 7320 616c 6c20 7468 6520 6d65 7461 6461  s all the metada
+00005fd0: 7461 2076 616c 7565 7320 6f66 2074 6865  ta values of the
+00005fe0: 2064 696d 656e 7369 6f6e 732e 0a20 2020   dimensions..   
+00005ff0: 2020 2020 2054 6865 2076 616c 7565 7320       The values 
+00006000: 6172 6520 6173 7375 6d65 6420 746f 2062  are assumed to b
+00006010: 6520 6e75 6d62 6572 732e 0a0a 2020 2020  e numbers...    
+00006020: 2020 2020 3a72 6574 7572 6e73 3a20 6172      :returns: ar
+00006030: 7261 795f 6c69 6b65 0a20 2020 2020 2020  ray_like.       
+00006040: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
+00006050: 6e6f 7420 7365 6c66 2e5f 6469 6d65 6e73  not self._dimens
+00006060: 696f 6e73 5f76 616c 7565 7320 6f72 2069  ions_values or i
+00006070: 6e64 6963 6573 2069 7320 6e6f 7420 4e6f  ndices is not No
+00006080: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00006090: 666f 7220 6469 6d65 6e73 696f 6e20 696e  for dimension in
+000060a0: 2073 656c 662e 5f5f 6469 6d73 3a0a 2020   self.__dims:.  
+000060b0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000060c0: 6c66 2e5f 6469 6d65 6e73 696f 6e73 5f76  lf._dimensions_v
+000060d0: 616c 7565 735b 6469 6d65 6e73 696f 6e5b  alues[dimension[
+000060e0: 315d 2e6e 616d 655d 203d 2073 656c 662e  1].name] = self.
+000060f0: 6765 745f 6d65 7461 6461 7461 5f76 616c  get_metadata_val
+00006100: 7565 7328 0a20 2020 2020 2020 2020 2020  ues(.           
+00006110: 2020 2020 2020 2020 206b 696e 643d 6469           kind=di
+00006120: 6d65 6e73 696f 6e5b 315d 2e6b 696e 642c  mension[1].kind,
+00006130: 206b 6579 3d64 696d 656e 7369 6f6e 5b31   key=dimension[1
+00006140: 5d2e 6e61 6d65 2c20 696e 6469 6365 733d  ].name, indices=
+00006150: 696e 6469 6365 730a 2020 2020 2020 2020  indices.        
+00006160: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00006170: 2020 7265 7475 726e 2073 656c 662e 5f64    return self._d
+00006180: 696d 656e 7369 6f6e 735f 7661 6c75 6573  imensions_values
+00006190: 0a0a 2020 2020 6465 6620 636f 6d70 7574  ..    def comput
+000061a0: 655f 6d6f 7361 6963 6974 795f 636f 6c6f  e_mosaicity_colo
+000061b0: 726b 6579 280a 2020 2020 2020 2020 7365  rkey(.        se
+000061c0: 6c66 2c20 6469 6d65 6e73 696f 6e73 3d5b  lf, dimensions=[
+000061d0: 302c 2031 5d2c 2073 6361 6c65 3d31 3030  0, 1], scale=100
+000061e0: 2c20 696e 6469 6365 733d 4e6f 6e65 2c20  , indices=None, 
+000061f0: 7468 6972 645f 6d6f 746f 723d 4e6f 6e65  third_motor=None
+00006200: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+00006210: 2222 220a 2020 2020 2020 2020 436f 6d70  """.        Comp
+00006220: 7574 6573 2061 206d 6f73 6169 6369 7479  utes a mosaicity
+00006230: 2063 6f6c 6f72 6b65 7920 6672 6f6d 2074   colorkey from t
+00006240: 6865 2064 696d 656e 7369 6f6e 732c 2061  he dimensions, a
+00006250: 6e64 2072 6574 7572 6e73 2061 6c73 6f20  nd returns also 
+00006260: 7468 650a 2020 2020 2020 2020 6f72 6965  the.        orie
+00006270: 6e74 6174 696f 6e20 6469 7374 7269 6275  ntation distribu
+00006280: 7469 6f6e 2069 6d61 6765 2e0a 2020 2020  tion image..    
+00006290: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+000062a0: 2320 6f6e 6c79 2077 6f72 6b20 7769 7468  # only work with
+000062b0: 2032 2064 696d 656e 7369 6f6e 730a 2020   2 dimensions.  
+000062c0: 2020 2020 2020 6173 7365 7274 206c 656e        assert len
+000062d0: 2864 696d 656e 7369 6f6e 7329 203d 3d20  (dimensions) == 
+000062e0: 322c 2022 4f6e 6c79 2077 6f72 6b73 2077  2, "Only works w
+000062f0: 6974 6820 7477 6f20 6d6f 746f 7273 220a  ith two motors".
+00006300: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00006310: 5f5f 6469 6d73 2061 6e64 2073 656c 662e  __dims and self.
+00006320: 5f5f 6469 6d73 2e6e 6469 6d20 3e20 313a  __dims.ndim > 1:
+00006330: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
+00006340: 5f73 6861 7065 203d 205b 5d0a 2020 2020  _shape = [].    
+00006350: 2020 2020 2020 2020 6469 6d73 5f6c 6973          dims_lis
+00006360: 7420 3d20 5b5d 0a20 2020 2020 2020 2020  t = [].         
+00006370: 2020 2066 6f72 2061 7869 7320 696e 2064     for axis in d
+00006380: 696d 656e 7369 6f6e 733a 0a20 2020 2020  imensions:.     
+00006390: 2020 2020 2020 2020 2020 2064 696d 203d             dim =
+000063a0: 2073 656c 662e 5f5f 6469 6d73 2e67 6574   self.__dims.get
+000063b0: 2861 7869 7329 0a20 2020 2020 2020 2020  (axis).         
 000063c0: 2020 2020 2020 2064 696d 735f 6c69 7374         dims_list
-000063d0: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
-000063e0: 2020 666f 7220 6178 6973 2069 6e20 6469    for axis in di
-000063f0: 6d65 6e73 696f 6e73 3a0a 2020 2020 2020  mensions:.      
-00006400: 2020 2020 2020 2020 2020 6469 6d20 3d20            dim = 
-00006410: 7365 6c66 2e5f 5f64 696d 732e 6765 7428  self.__dims.get(
-00006420: 6178 6973 290a 2020 2020 2020 2020 2020  axis).          
-00006430: 2020 2020 2020 6469 6d73 5f6c 6973 7420        dims_list 
-00006440: 2b3d 205b 6e75 6d70 792e 6c69 6e73 7061  += [numpy.linspa
-00006450: 6365 282d 312c 2031 2c20 6469 6d2e 7369  ce(-1, 1, dim.si
-00006460: 7a65 202a 2073 6361 6c65 295d 0a20 2020  ze * scale)].   
-00006470: 2020 2020 2020 2020 2020 2020 206e 6577               new
-00006480: 5f73 6861 7065 202b 3d20 5b64 696d 2e73  _shape += [dim.s
-00006490: 697a 655d 0a20 2020 2020 2020 2020 2020  ize].           
-000064a0: 2064 696d 735f 6c69 7374 2e72 6576 6572   dims_list.rever
-000064b0: 7365 2829 0a20 2020 2020 2020 2020 2020  se().           
-000064c0: 206d 6573 6820 3d20 6e75 6d70 792e 6d65   mesh = numpy.me
-000064d0: 7368 6772 6964 282a 6469 6d73 5f6c 6973  shgrid(*dims_lis
-000064e0: 7429 0a20 2020 2020 2020 2020 2020 2064  t).            d
-000064f0: 6174 6120 3d20 6e75 6d70 792e 6172 6374  ata = numpy.arct
-00006500: 616e 3228 6d65 7368 5b30 5d2c 206d 6573  an2(mesh[0], mes
-00006510: 685b 315d 290a 2020 2020 2020 2020 2020  h[1]).          
-00006520: 2020 6e6f 726d 616c 697a 6564 5f64 6174    normalized_dat
-00006530: 6120 3d20 7772 6170 546f 3270 6928 6461  a = wrapTo2pi(da
-00006540: 7461 2920 2f20 6e75 6d70 792e 7069 202f  ta) / numpy.pi /
-00006550: 2032 0a20 2020 2020 2020 2020 2020 2073   2.            s
-00006560: 7172 203d 206e 756d 7079 2e73 7172 7428  qr = numpy.sqrt(
-00006570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006580: 206e 756d 7079 2e70 6f77 6572 286d 6573   numpy.power(mes
-00006590: 685b 305d 2c20 3229 202b 206e 756d 7079  h[0], 2) + numpy
-000065a0: 2e70 6f77 6572 286d 6573 685b 315d 2c20  .power(mesh[1], 
-000065b0: 3229 0a20 2020 2020 2020 2020 2020 2029  2).            )
-000065c0: 202f 206e 756d 7079 2e73 7172 7428 3229   / numpy.sqrt(2)
-000065d0: 0a20 2020 2020 2020 2020 2020 2068 7376  .            hsv
-000065e0: 5f6b 6579 203d 206e 756d 7079 2e73 7461  _key = numpy.sta
-000065f0: 636b 280a 2020 2020 2020 2020 2020 2020  ck(.            
-00006600: 2020 2020 280a 2020 2020 2020 2020 2020      (.          
-00006610: 2020 2020 2020 2020 2020 6e6f 726d 616c            normal
-00006620: 697a 6564 5f64 6174 612c 0a20 2020 2020  ized_data,.     
-00006630: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00006640: 7172 2c0a 2020 2020 2020 2020 2020 2020  qr,.            
-00006650: 2020 2020 2020 2020 6e75 6d70 792e 6f6e          numpy.on
-00006660: 6573 2828 6c65 6e28 6469 6d73 5f6c 6973  es((len(dims_lis
-00006670: 745b 315d 292c 206c 656e 2864 696d 735f  t[1]), len(dims_
-00006680: 6c69 7374 5b30 5d29 2929 2c0a 2020 2020  list[0]))),.    
-00006690: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
-000066a0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-000066b0: 7869 733d 322c 0a20 2020 2020 2020 2020  xis=2,.         
-000066c0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-000066d0: 2020 6f72 695f 6469 7374 203d 206e 756d    ori_dist = num
-000066e0: 7079 2e7a 6572 6f73 286e 6577 5f73 6861  py.zeros(new_sha
-000066f0: 7065 5b30 5d20 2a20 6e65 775f 7368 6170  pe[0] * new_shap
-00006700: 655b 315d 290a 2020 2020 2020 2020 2020  e[1]).          
-00006710: 2020 5f73 6c69 6365 3120 3d20 6f72 695f    _slice1 = ori_
-00006720: 6469 7374 2e73 6861 7065 5b30 5d20 2a20  dist.shape[0] * 
-00006730: 7468 6972 645f 6d6f 746f 720a 2020 2020  third_motor.    
-00006740: 2020 2020 2020 2020 5f73 6c69 6365 3220          _slice2 
-00006750: 3d20 6f72 695f 6469 7374 2e73 6861 7065  = ori_dist.shape
-00006760: 5b30 5d20 2a20 2874 6869 7264 5f6d 6f74  [0] * (third_mot
-00006770: 6f72 202b 2031 290a 2020 2020 2020 2020  or + 1).        
-00006780: 2020 2020 6f72 695f 6469 7374 5b69 6e64      ori_dist[ind
-00006790: 6963 6573 5d20 3d20 7365 6c66 2e67 6574  ices] = self.get
-000067a0: 5f64 6174 6128 696e 6469 6365 7329 2e73  _data(indices).s
-000067b0: 756d 2861 7869 733d 3129 5b5f 736c 6963  um(axis=1)[_slic
-000067c0: 6531 3a5f 736c 6963 6532 5d0a 2020 2020  e1:_slice2].    
-000067d0: 2020 2020 2020 2020 7265 7475 726e 206f          return o
-000067e0: 7269 5f64 6973 742e 7265 7368 6170 6528  ri_dist.reshape(
-000067f0: 6e75 6d70 792e 666c 6970 286e 6577 5f73  numpy.flip(new_s
-00006800: 6861 7065 2929 2e54 2c20 6873 765f 6b65  hape)).T, hsv_ke
-00006810: 790a 2020 2020 2020 2020 7265 7475 726e  y.        return
-00006820: 204e 6f6e 652c 204e 6f6e 650a 0a20 2020   None, None..   
-00006830: 2064 6566 2061 7070 6c79 5f62 6163 6b67   def apply_backg
-00006840: 726f 756e 645f 7375 6274 7261 6374 696f  round_subtractio
-00006850: 6e28 0a20 2020 2020 2020 2073 656c 662c  n(.        self,
-00006860: 0a20 2020 2020 2020 2062 6163 6b67 726f  .        backgro
-00006870: 756e 643d 4e6f 6e65 2c0a 2020 2020 2020  und=None,.      
-00006880: 2020 6d65 7468 6f64 3d22 6d65 6469 616e    method="median
-00006890: 222c 0a20 2020 2020 2020 2069 6e64 6963  ",.        indic
-000068a0: 6573 3d4e 6f6e 652c 0a20 2020 2020 2020  es=None,.       
-000068b0: 2073 7465 703d 4e6f 6e65 2c0a 2020 2020   step=None,.    
-000068c0: 2020 2020 6368 756e 6b5f 7368 6170 653d      chunk_shape=
-000068d0: 5b31 3030 2c20 3130 305d 2c0a 2020 2020  [100, 100],.    
-000068e0: 2020 2020 5f64 6972 3d4e 6f6e 652c 0a20      _dir=None,. 
-000068f0: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
-00006900: 220a 2020 2020 2020 2020 4170 706c 6965  ".        Applie
-00006910: 7320 6261 636b 6772 6f75 6e64 2073 7562  s background sub
-00006920: 7472 6163 7469 6f6e 2074 6f20 7468 6520  traction to the 
-00006930: 6461 7461 2061 6e64 2073 6176 6573 2074  data and saves t
-00006940: 6865 206e 6577 2064 6174 610a 2020 2020  he new data.    
-00006950: 2020 2020 696e 746f 2064 6973 6b2e 0a0a      into disk...
-00006960: 2020 2020 2020 2020 3a70 6172 616d 2062          :param b
-00006970: 6163 6b67 726f 756e 643a 2044 6174 6120  ackground: Data 
-00006980: 746f 2062 6520 7573 6564 2061 7320 6261  to be used as ba
-00006990: 636b 6772 6f75 6e64 2e20 4966 204e 6f6e  ckground. If Non
-000069a0: 652c 2064 6174 6120 7769 7468 2069 6e64  e, data with ind
-000069b0: 6963 6573 2060 696e 6469 6365 7360 2069  ices `indices` i
-000069c0: 7320 7573 6564 2e0a 2020 2020 2020 2020  s used..        
-000069d0: 2020 2020 4966 2044 6174 6173 6574 2c20      If Dataset, 
-000069e0: 6461 7461 206f 6620 7468 6520 6461 7461  data of the data
-000069f0: 7365 7420 6973 2075 7365 642e 2049 6620  set is used. If 
-00006a00: 6172 7261 792c 2075 7365 2064 6174 6120  array, use data 
-00006a10: 7769 7468 2069 6e64 6963 6573 2069 6e20  with indices in 
-00006a20: 7468 6520 6172 7261 792e 0a20 2020 2020  the array..     
-00006a30: 2020 203a 7479 7065 2062 6163 6b67 726f     :type backgro
-00006a40: 756e 643a 2055 6e69 6f6e 5b4e 6f6e 652c  und: Union[None,
-00006a50: 2061 7272 6179 5f6c 696b 652c 2044 6174   array_like, Dat
-00006a60: 6173 6574 5d0a 2020 2020 2020 2020 3a70  aset].        :p
-00006a70: 6172 616d 206d 6574 686f 643a 204d 6574  aram method: Met
-00006a80: 686f 6420 746f 2075 7365 2074 6f20 636f  hod to use to co
-00006a90: 6d70 7574 6520 7468 6520 6261 636b 6772  mpute the backgr
-00006aa0: 6f75 6e64 2e0a 2020 2020 2020 2020 3a74  ound..        :t
-00006ab0: 7970 6520 6d65 7468 6f64 3a20 4d65 7468  ype method: Meth
-00006ac0: 6f64 0a20 2020 2020 2020 203a 7061 7261  od.        :para
-00006ad0: 6d20 696e 6469 6365 733a 2049 6e64 6963  m indices: Indic
-00006ae0: 6573 206f 6620 7468 6520 696d 6167 6573  es of the images
-00006af0: 2074 6f20 6170 706c 7920 6261 636b 6772   to apply backgr
-00006b00: 6f75 6e64 2073 7562 7472 6163 7469 6f6e  ound subtraction
-00006b10: 2e0a 2020 2020 2020 2020 2020 2020 4966  ..            If
-00006b20: 204e 6f6e 652c 2074 6865 2062 6163 6b67   None, the backg
-00006b30: 726f 756e 6420 7375 6274 7261 6374 696f  round subtractio
-00006b40: 6e20 6973 2061 7070 6c69 6564 2074 6f20  n is applied to 
-00006b50: 616c 6c20 7468 6520 6461 7461 2e0a 2020  all the data..  
-00006b60: 2020 2020 2020 3a74 7970 6520 696e 6469        :type indi
-00006b70: 6365 733a 2055 6e69 6f6e 5b4e 6f6e 652c  ces: Union[None,
-00006b80: 2061 7272 6179 5f6c 696b 655d 0a20 2020   array_like].   
-00006b90: 2020 2020 203a 7061 7261 6d20 696e 7420       :param int 
-00006ba0: 7374 6570 3a20 4469 7374 616e 6365 2062  step: Distance b
-00006bb0: 6574 7765 656e 2069 6d61 6765 7320 746f  etween images to
-00006bc0: 2062 6520 7573 6564 2077 6865 6e20 636f   be used when co
-00006bd0: 6d70 7574 696e 6720 7468 6520 6d65 6469  mputing the medi
-00006be0: 616e 2e0a 2020 2020 2020 2020 2020 2020  an..            
-00006bf0: 5061 7261 6d65 7465 7220 7573 6564 206f  Parameter used o
-00006c00: 6e6c 7920 7768 656e 2066 6c61 6720 696e  nly when flag in
-00006c10: 5f6d 656d 6f72 7920 6973 2046 616c 7365  _memory is False
-00006c20: 2061 6e64 206d 6574 686f 6420 6973 2060   and method is `
-00006c30: 4d65 7468 6f64 2e6d 6564 6961 6e60 2e0a  Method.median`..
-00006c40: 2020 2020 2020 2020 2020 2020 4966 2060              If `
-00006c50: 7374 6570 6020 6973 206e 6f74 204e 6f6e  step` is not Non
-00006c60: 652c 2061 6c6c 2069 6d61 6765 7320 7769  e, all images wi
-00006c70: 7468 2064 6973 7461 6e63 6520 6f66 2060  th distance of `
-00006c80: 7374 6570 602c 2073 7461 7274 696e 6720  step`, starting 
-00006c90: 6174 2030 2c0a 2020 2020 2020 2020 2020  at 0,.          
-00006ca0: 2020 7769 6c6c 2062 6520 6c6f 6164 6564    will be loaded
-00006cb0: 2069 6e74 6f20 6d65 6d6f 7279 2066 6f72   into memory for
-00006cc0: 2063 6f6d 7075 7469 6e67 2074 6865 206d   computing the m
-00006cd0: 6564 6961 6e2c 2069 6620 7468 6520 6461  edian, if the da
-00006ce0: 7461 206c 6f61 6469 6e67 2074 6872 6f77  ta loading throw
-00006cf0: 730a 2020 2020 2020 2020 2020 2020 6120  s.            a 
-00006d00: 4d65 6d6f 7279 4572 726f 722c 2074 6865  MemoryError, the
-00006d10: 206d 6564 6961 6e20 636f 6d70 7574 6174   median computat
-00006d20: 696f 6e20 6973 2074 7269 6564 2077 6974  ion is tried wit
-00006d30: 6820 6073 7465 7020 2b3d 2031 602e 0a20  h `step += 1`.. 
-00006d40: 2020 2020 2020 203a 7061 7261 6d20 6368         :param ch
-00006d50: 756e 6b5f 7368 6170 653a 2053 6861 7065  unk_shape: Shape
-00006d60: 206f 6620 7468 6520 6368 756e 6b20 696d   of the chunk im
-00006d70: 6167 6520 746f 2075 7365 2070 6572 2069  age to use per i
-00006d80: 7465 7261 7469 6f6e 2e0a 2020 2020 2020  teration..      
-00006d90: 2020 2020 2020 5061 7261 6d65 7465 7220        Parameter 
-00006da0: 7573 6564 206f 6e6c 7920 7768 656e 2066  used only when f
-00006db0: 6c61 6720 696e 5f6d 656d 6f72 7920 6973  lag in_memory is
-00006dc0: 2046 616c 7365 2061 6e64 206d 6574 686f   False and metho
-00006dd0: 6420 6973 2060 4d65 7468 6f64 2e6d 6564  d is `Method.med
-00006de0: 6961 6e60 2e0a 2020 2020 2020 2020 3a74  ian`..        :t
-00006df0: 7970 6520 6368 756e 6b5f 7368 6170 653a  ype chunk_shape:
-00006e00: 2061 7272 6179 5f6c 696b 650a 2020 2020   array_like.    
-00006e10: 2020 2020 3a72 6574 7572 6e73 3a20 6461      :returns: da
-00006e20: 7461 7365 7420 7769 7468 2064 6174 6120  taset with data 
-00006e30: 6f66 2073 616d 6520 7369 7a65 2061 7320  of same size as 
-00006e40: 6073 656c 662e 6461 7461 6020 6275 7420  `self.data` but 
-00006e50: 7769 7468 2074 6865 0a20 2020 2020 2020  with the.       
-00006e60: 2020 2020 206d 6f64 6966 6965 6420 696d       modified im
-00006e70: 6167 6573 2e20 5468 6520 7572 6c73 206f  ages. The urls o
-00006e80: 6620 7468 6520 6d6f 6469 6669 6564 2069  f the modified i
-00006e90: 6d61 6765 7320 6172 6520 7265 706c 6163  mages are replac
-00006ea0: 6564 2077 6974 680a 2020 2020 2020 2020  ed with.        
-00006eb0: 2020 2020 7468 6520 6e65 7720 7572 6c73      the new urls
-00006ec0: 2e0a 2020 2020 2020 2020 3a72 7479 7065  ..        :rtype
-00006ed0: 3a20 4461 7461 7365 740a 2020 2020 2020  : Dataset.      
-00006ee0: 2020 2222 220a 0a20 2020 2020 2020 205f    """..        _
-00006ef0: 6469 7220 3d20 7365 6c66 2e64 6972 2069  dir = self.dir i
-00006f00: 6620 5f64 6972 2069 7320 4e6f 6e65 2065  f _dir is None e
-00006f10: 6c73 6520 5f64 6972 0a0a 2020 2020 2020  lse _dir..      
-00006f20: 2020 6f73 2e6d 616b 6564 6972 7328 5f64    os.makedirs(_d
-00006f30: 6972 2c20 6578 6973 745f 6f6b 3d54 7275  ir, exist_ok=Tru
-00006f40: 6529 0a0a 2020 2020 2020 2020 7465 6d70  e)..        temp
-00006f50: 5f64 6972 203d 206f 732e 7061 7468 2e6a  _dir = os.path.j
-00006f60: 6f69 6e28 5f64 6972 2c20 2274 656d 705f  oin(_dir, "temp_
-00006f70: 6469 7222 290a 0a20 2020 2020 2020 206f  dir")..        o
-00006f80: 732e 6d61 6b65 6469 7273 2874 656d 705f  s.makedirs(temp_
-00006f90: 6469 722c 2065 7869 7374 5f6f 6b3d 5472  dir, exist_ok=Tr
-00006fa0: 7565 290a 0a20 2020 2020 2020 206d 6574  ue)..        met
-00006fb0: 686f 6420 3d20 4d65 7468 6f64 2e66 726f  hod = Method.fro
-00006fc0: 6d5f 7661 6c75 6528 6d65 7468 6f64 290a  m_value(method).
-00006fd0: 0a20 2020 2020 2020 2073 656c 662e 7275  .        self.ru
-00006fe0: 6e6e 696e 675f 6461 7461 203d 2073 656c  nning_data = sel
-00006ff0: 662e 6765 745f 6461 7461 2869 6e64 6963  f.get_data(indic
-00007000: 6573 290a 0a20 2020 2020 2020 2077 6974  es)..        wit
-00007010: 6820 7365 6c66 2e73 7461 7465 5f6f 665f  h self.state_of_
-00007020: 6f70 6572 6174 696f 6e73 2e72 756e 5f63  operations.run_c
-00007030: 6f6e 7465 7874 284f 7065 7261 7469 6f6e  ontext(Operation
-00007040: 2e42 5329 3a0a 2020 2020 2020 2020 2020  .BS):.          
-00007050: 2020 6966 2062 6163 6b67 726f 756e 6420    if background 
-00007060: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00007070: 2020 2020 2020 2020 2062 675f 6461 7461           bg_data
-00007080: 203d 2073 656c 662e 7275 6e6e 696e 675f   = self.running_
-00007090: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
-000070a0: 2020 2020 2069 6620 696e 6469 6365 7320       if indices 
-000070b0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-000070c0: 2020 2020 2020 2020 2020 2020 205f 6c6f               _lo
-000070d0: 6767 6572 2e69 6e66 6f28 0a20 2020 2020  gger.info(.     
-000070e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000070f0: 2020 2022 436f 6d70 7574 696e 6720 6261     "Computing ba
-00007100: 636b 6772 6f75 6e64 2066 726f 6d20 2573  ckground from %s
-00007110: 206f 6620 7261 7720 6461 7461 222c 206d   of raw data", m
-00007120: 6574 686f 642e 6e61 6d65 0a20 2020 2020  ethod.name.     
-00007130: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00007140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007150: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00007160: 2020 2020 2020 2020 2020 205f 6c6f 6767             _logg
-00007170: 6572 2e69 6e66 6f28 0a20 2020 2020 2020  er.info(.       
+000063d0: 202b 3d20 5b6e 756d 7079 2e6c 696e 7370   += [numpy.linsp
+000063e0: 6163 6528 2d31 2c20 312c 2064 696d 2e73  ace(-1, 1, dim.s
+000063f0: 697a 6520 2a20 7363 616c 6529 5d0a 2020  ize * scale)].  
+00006400: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+00006410: 775f 7368 6170 6520 2b3d 205b 6469 6d2e  w_shape += [dim.
+00006420: 7369 7a65 5d0a 2020 2020 2020 2020 2020  size].          
+00006430: 2020 6469 6d73 5f6c 6973 742e 7265 7665    dims_list.reve
+00006440: 7273 6528 290a 2020 2020 2020 2020 2020  rse().          
+00006450: 2020 6d65 7368 203d 206e 756d 7079 2e6d    mesh = numpy.m
+00006460: 6573 6867 7269 6428 2a64 696d 735f 6c69  eshgrid(*dims_li
+00006470: 7374 290a 2020 2020 2020 2020 2020 2020  st).            
+00006480: 6461 7461 203d 206e 756d 7079 2e61 7263  data = numpy.arc
+00006490: 7461 6e32 286d 6573 685b 305d 2c20 6d65  tan2(mesh[0], me
+000064a0: 7368 5b31 5d29 0a20 2020 2020 2020 2020  sh[1]).         
+000064b0: 2020 206e 6f72 6d61 6c69 7a65 645f 6461     normalized_da
+000064c0: 7461 203d 2077 7261 7054 6f32 7069 2864  ta = wrapTo2pi(d
+000064d0: 6174 6129 202f 206e 756d 7079 2e70 6920  ata) / numpy.pi 
+000064e0: 2f20 320a 2020 2020 2020 2020 2020 2020  / 2.            
+000064f0: 7371 7220 3d20 6e75 6d70 792e 7371 7274  sqr = numpy.sqrt
+00006500: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00006510: 2020 6e75 6d70 792e 706f 7765 7228 6d65    numpy.power(me
+00006520: 7368 5b30 5d2c 2032 2920 2b20 6e75 6d70  sh[0], 2) + nump
+00006530: 792e 706f 7765 7228 6d65 7368 5b31 5d2c  y.power(mesh[1],
+00006540: 2032 290a 2020 2020 2020 2020 2020 2020   2).            
+00006550: 2920 2f20 6e75 6d70 792e 7371 7274 2832  ) / numpy.sqrt(2
+00006560: 290a 2020 2020 2020 2020 2020 2020 6873  ).            hs
+00006570: 765f 6b65 7920 3d20 6e75 6d70 792e 7374  v_key = numpy.st
+00006580: 6163 6b28 0a20 2020 2020 2020 2020 2020  ack(.           
+00006590: 2020 2020 2028 0a20 2020 2020 2020 2020       (.         
+000065a0: 2020 2020 2020 2020 2020 206e 6f72 6d61             norma
+000065b0: 6c69 7a65 645f 6461 7461 2c0a 2020 2020  lized_data,.    
+000065c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000065d0: 7371 722c 0a20 2020 2020 2020 2020 2020  sqr,.           
+000065e0: 2020 2020 2020 2020 206e 756d 7079 2e6f           numpy.o
+000065f0: 6e65 7328 286c 656e 2864 696d 735f 6c69  nes((len(dims_li
+00006600: 7374 5b31 5d29 2c20 6c65 6e28 6469 6d73  st[1]), len(dims
+00006610: 5f6c 6973 745b 305d 2929 292c 0a20 2020  _list[0]))),.   
+00006620: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
+00006630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006640: 6178 6973 3d32 2c0a 2020 2020 2020 2020  axis=2,.        
+00006650: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+00006660: 2020 206f 7269 5f64 6973 7420 3d20 6e75     ori_dist = nu
+00006670: 6d70 792e 7a65 726f 7328 6e65 775f 7368  mpy.zeros(new_sh
+00006680: 6170 655b 305d 202a 206e 6577 5f73 6861  ape[0] * new_sha
+00006690: 7065 5b31 5d29 0a20 2020 2020 2020 2020  pe[1]).         
+000066a0: 2020 205f 736c 6963 6531 203d 206f 7269     _slice1 = ori
+000066b0: 5f64 6973 742e 7368 6170 655b 305d 202a  _dist.shape[0] *
+000066c0: 2074 6869 7264 5f6d 6f74 6f72 0a20 2020   third_motor.   
+000066d0: 2020 2020 2020 2020 205f 736c 6963 6532           _slice2
+000066e0: 203d 206f 7269 5f64 6973 742e 7368 6170   = ori_dist.shap
+000066f0: 655b 305d 202a 2028 7468 6972 645f 6d6f  e[0] * (third_mo
+00006700: 746f 7220 2b20 3129 0a20 2020 2020 2020  tor + 1).       
+00006710: 2020 2020 206f 7269 5f64 6973 745b 696e       ori_dist[in
+00006720: 6469 6365 735d 203d 2073 656c 662e 6765  dices] = self.ge
+00006730: 745f 6461 7461 2869 6e64 6963 6573 292e  t_data(indices).
+00006740: 7375 6d28 6178 6973 3d31 295b 5f73 6c69  sum(axis=1)[_sli
+00006750: 6365 313a 5f73 6c69 6365 325d 0a20 2020  ce1:_slice2].   
+00006760: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00006770: 6f72 695f 6469 7374 2e72 6573 6861 7065  ori_dist.reshape
+00006780: 286e 756d 7079 2e66 6c69 7028 6e65 775f  (numpy.flip(new_
+00006790: 7368 6170 6529 292e 542c 2068 7376 5f6b  shape)).T, hsv_k
+000067a0: 6579 0a20 2020 2020 2020 2072 6574 7572  ey.        retur
+000067b0: 6e20 4e6f 6e65 2c20 4e6f 6e65 0a0a 2020  n None, None..  
+000067c0: 2020 6465 6620 6170 706c 795f 6261 636b    def apply_back
+000067d0: 6772 6f75 6e64 5f73 7562 7472 6163 7469  ground_subtracti
+000067e0: 6f6e 280a 2020 2020 2020 2020 7365 6c66  on(.        self
+000067f0: 2c0a 2020 2020 2020 2020 6261 636b 6772  ,.        backgr
+00006800: 6f75 6e64 3d4e 6f6e 652c 0a20 2020 2020  ound=None,.     
+00006810: 2020 206d 6574 686f 643d 226d 6564 6961     method="media
+00006820: 6e22 2c0a 2020 2020 2020 2020 696e 6469  n",.        indi
+00006830: 6365 733d 4e6f 6e65 2c0a 2020 2020 2020  ces=None,.      
+00006840: 2020 7374 6570 3d4e 6f6e 652c 0a20 2020    step=None,.   
+00006850: 2020 2020 2063 6875 6e6b 5f73 6861 7065       chunk_shape
+00006860: 3d5b 3130 302c 2031 3030 5d2c 0a20 2020  =[100, 100],.   
+00006870: 2020 2020 205f 6469 723d 4e6f 6e65 2c0a       _dir=None,.
+00006880: 2020 2020 293a 0a20 2020 2020 2020 2022      ):.        "
+00006890: 2222 0a20 2020 2020 2020 2041 7070 6c69  "".        Appli
+000068a0: 6573 2062 6163 6b67 726f 756e 6420 7375  es background su
+000068b0: 6274 7261 6374 696f 6e20 746f 2074 6865  btraction to the
+000068c0: 2064 6174 6120 616e 6420 7361 7665 7320   data and saves 
+000068d0: 7468 6520 6e65 7720 6461 7461 0a20 2020  the new data.   
+000068e0: 2020 2020 2069 6e74 6f20 6469 736b 2e0a       into disk..
+000068f0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+00006900: 6261 636b 6772 6f75 6e64 3a20 4461 7461  background: Data
+00006910: 2074 6f20 6265 2075 7365 6420 6173 2062   to be used as b
+00006920: 6163 6b67 726f 756e 642e 2049 6620 4e6f  ackground. If No
+00006930: 6e65 2c20 6461 7461 2077 6974 6820 696e  ne, data with in
+00006940: 6469 6365 7320 6069 6e64 6963 6573 6020  dices `indices` 
+00006950: 6973 2075 7365 642e 0a20 2020 2020 2020  is used..       
+00006960: 2020 2020 2049 6620 4461 7461 7365 742c       If Dataset,
+00006970: 2064 6174 6120 6f66 2074 6865 2064 6174   data of the dat
+00006980: 6173 6574 2069 7320 7573 6564 2e20 4966  aset is used. If
+00006990: 2061 7272 6179 2c20 7573 6520 6461 7461   array, use data
+000069a0: 2077 6974 6820 696e 6469 6365 7320 696e   with indices in
+000069b0: 2074 6865 2061 7272 6179 2e0a 2020 2020   the array..    
+000069c0: 2020 2020 3a74 7970 6520 6261 636b 6772      :type backgr
+000069d0: 6f75 6e64 3a20 556e 696f 6e5b 4e6f 6e65  ound: Union[None
+000069e0: 2c20 6172 7261 795f 6c69 6b65 2c20 4461  , array_like, Da
+000069f0: 7461 7365 745d 0a20 2020 2020 2020 203a  taset].        :
+00006a00: 7061 7261 6d20 6d65 7468 6f64 3a20 4d65  param method: Me
+00006a10: 7468 6f64 2074 6f20 7573 6520 746f 2063  thod to use to c
+00006a20: 6f6d 7075 7465 2074 6865 2062 6163 6b67  ompute the backg
+00006a30: 726f 756e 642e 0a20 2020 2020 2020 203a  round..        :
+00006a40: 7479 7065 206d 6574 686f 643a 204d 6574  type method: Met
+00006a50: 686f 640a 2020 2020 2020 2020 3a70 6172  hod.        :par
+00006a60: 616d 2069 6e64 6963 6573 3a20 496e 6469  am indices: Indi
+00006a70: 6365 7320 6f66 2074 6865 2069 6d61 6765  ces of the image
+00006a80: 7320 746f 2061 7070 6c79 2062 6163 6b67  s to apply backg
+00006a90: 726f 756e 6420 7375 6274 7261 6374 696f  round subtractio
+00006aa0: 6e2e 0a20 2020 2020 2020 2020 2020 2049  n..            I
+00006ab0: 6620 4e6f 6e65 2c20 7468 6520 6261 636b  f None, the back
+00006ac0: 6772 6f75 6e64 2073 7562 7472 6163 7469  ground subtracti
+00006ad0: 6f6e 2069 7320 6170 706c 6965 6420 746f  on is applied to
+00006ae0: 2061 6c6c 2074 6865 2064 6174 612e 0a20   all the data.. 
+00006af0: 2020 2020 2020 203a 7479 7065 2069 6e64         :type ind
+00006b00: 6963 6573 3a20 556e 696f 6e5b 4e6f 6e65  ices: Union[None
+00006b10: 2c20 6172 7261 795f 6c69 6b65 5d0a 2020  , array_like].  
+00006b20: 2020 2020 2020 3a70 6172 616d 2069 6e74        :param int
+00006b30: 2073 7465 703a 2044 6973 7461 6e63 6520   step: Distance 
+00006b40: 6265 7477 6565 6e20 696d 6167 6573 2074  between images t
+00006b50: 6f20 6265 2075 7365 6420 7768 656e 2063  o be used when c
+00006b60: 6f6d 7075 7469 6e67 2074 6865 206d 6564  omputing the med
+00006b70: 6961 6e2e 0a20 2020 2020 2020 2020 2020  ian..           
+00006b80: 2050 6172 616d 6574 6572 2075 7365 6420   Parameter used 
+00006b90: 6f6e 6c79 2077 6865 6e20 666c 6167 2069  only when flag i
+00006ba0: 6e5f 6d65 6d6f 7279 2069 7320 4661 6c73  n_memory is Fals
+00006bb0: 6520 616e 6420 6d65 7468 6f64 2069 7320  e and method is 
+00006bc0: 604d 6574 686f 642e 6d65 6469 616e 602e  `Method.median`.
+00006bd0: 0a20 2020 2020 2020 2020 2020 2049 6620  .            If 
+00006be0: 6073 7465 7060 2069 7320 6e6f 7420 4e6f  `step` is not No
+00006bf0: 6e65 2c20 616c 6c20 696d 6167 6573 2077  ne, all images w
+00006c00: 6974 6820 6469 7374 616e 6365 206f 6620  ith distance of 
+00006c10: 6073 7465 7060 2c20 7374 6172 7469 6e67  `step`, starting
+00006c20: 2061 7420 302c 0a20 2020 2020 2020 2020   at 0,.         
+00006c30: 2020 2077 696c 6c20 6265 206c 6f61 6465     will be loade
+00006c40: 6420 696e 746f 206d 656d 6f72 7920 666f  d into memory fo
+00006c50: 7220 636f 6d70 7574 696e 6720 7468 6520  r computing the 
+00006c60: 6d65 6469 616e 2c20 6966 2074 6865 2064  median, if the d
+00006c70: 6174 6120 6c6f 6164 696e 6720 7468 726f  ata loading thro
+00006c80: 7773 0a20 2020 2020 2020 2020 2020 2061  ws.            a
+00006c90: 204d 656d 6f72 7945 7272 6f72 2c20 7468   MemoryError, th
+00006ca0: 6520 6d65 6469 616e 2063 6f6d 7075 7461  e median computa
+00006cb0: 7469 6f6e 2069 7320 7472 6965 6420 7769  tion is tried wi
+00006cc0: 7468 2060 7374 6570 202b 3d20 3160 2e0a  th `step += 1`..
+00006cd0: 2020 2020 2020 2020 3a70 6172 616d 2063          :param c
+00006ce0: 6875 6e6b 5f73 6861 7065 3a20 5368 6170  hunk_shape: Shap
+00006cf0: 6520 6f66 2074 6865 2063 6875 6e6b 2069  e of the chunk i
+00006d00: 6d61 6765 2074 6f20 7573 6520 7065 7220  mage to use per 
+00006d10: 6974 6572 6174 696f 6e2e 0a20 2020 2020  iteration..     
+00006d20: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
+00006d30: 2075 7365 6420 6f6e 6c79 2077 6865 6e20   used only when 
+00006d40: 666c 6167 2069 6e5f 6d65 6d6f 7279 2069  flag in_memory i
+00006d50: 7320 4661 6c73 6520 616e 6420 6d65 7468  s False and meth
+00006d60: 6f64 2069 7320 604d 6574 686f 642e 6d65  od is `Method.me
+00006d70: 6469 616e 602e 0a20 2020 2020 2020 203a  dian`..        :
+00006d80: 7479 7065 2063 6875 6e6b 5f73 6861 7065  type chunk_shape
+00006d90: 3a20 6172 7261 795f 6c69 6b65 0a20 2020  : array_like.   
+00006da0: 2020 2020 203a 7265 7475 726e 733a 2064       :returns: d
+00006db0: 6174 6173 6574 2077 6974 6820 6461 7461  ataset with data
+00006dc0: 206f 6620 7361 6d65 2073 697a 6520 6173   of same size as
+00006dd0: 2060 7365 6c66 2e64 6174 6160 2062 7574   `self.data` but
+00006de0: 2077 6974 6820 7468 650a 2020 2020 2020   with the.      
+00006df0: 2020 2020 2020 6d6f 6469 6669 6564 2069        modified i
+00006e00: 6d61 6765 732e 2054 6865 2075 726c 7320  mages. The urls 
+00006e10: 6f66 2074 6865 206d 6f64 6966 6965 6420  of the modified 
+00006e20: 696d 6167 6573 2061 7265 2072 6570 6c61  images are repla
+00006e30: 6365 6420 7769 7468 0a20 2020 2020 2020  ced with.       
+00006e40: 2020 2020 2074 6865 206e 6577 2075 726c       the new url
+00006e50: 732e 0a20 2020 2020 2020 203a 7274 7970  s..        :rtyp
+00006e60: 653a 2044 6174 6173 6574 0a20 2020 2020  e: Dataset.     
+00006e70: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
+00006e80: 5f64 6972 203d 2073 656c 662e 6469 7220  _dir = self.dir 
+00006e90: 6966 205f 6469 7220 6973 204e 6f6e 6520  if _dir is None 
+00006ea0: 656c 7365 205f 6469 720a 0a20 2020 2020  else _dir..     
+00006eb0: 2020 206f 732e 6d61 6b65 6469 7273 285f     os.makedirs(_
+00006ec0: 6469 722c 2065 7869 7374 5f6f 6b3d 5472  dir, exist_ok=Tr
+00006ed0: 7565 290a 0a20 2020 2020 2020 2074 656d  ue)..        tem
+00006ee0: 705f 6469 7220 3d20 6f73 2e70 6174 682e  p_dir = os.path.
+00006ef0: 6a6f 696e 285f 6469 722c 2022 7465 6d70  join(_dir, "temp
+00006f00: 5f64 6972 2229 0a0a 2020 2020 2020 2020  _dir")..        
+00006f10: 6f73 2e6d 616b 6564 6972 7328 7465 6d70  os.makedirs(temp
+00006f20: 5f64 6972 2c20 6578 6973 745f 6f6b 3d54  _dir, exist_ok=T
+00006f30: 7275 6529 0a0a 2020 2020 2020 2020 6d65  rue)..        me
+00006f40: 7468 6f64 203d 204d 6574 686f 642e 6672  thod = Method.fr
+00006f50: 6f6d 5f76 616c 7565 286d 6574 686f 6429  om_value(method)
+00006f60: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
+00006f70: 756e 6e69 6e67 5f64 6174 6120 3d20 7365  unning_data = se
+00006f80: 6c66 2e67 6574 5f64 6174 6128 696e 6469  lf.get_data(indi
+00006f90: 6365 7329 0a0a 2020 2020 2020 2020 7769  ces)..        wi
+00006fa0: 7468 2073 656c 662e 7374 6174 655f 6f66  th self.state_of
+00006fb0: 5f6f 7065 7261 7469 6f6e 732e 7275 6e5f  _operations.run_
+00006fc0: 636f 6e74 6578 7428 4f70 6572 6174 696f  context(Operatio
+00006fd0: 6e2e 4253 293a 0a20 2020 2020 2020 2020  n.BS):.         
+00006fe0: 2020 2069 6620 6261 636b 6772 6f75 6e64     if background
+00006ff0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00007000: 2020 2020 2020 2020 2020 6267 5f64 6174            bg_dat
+00007010: 6120 3d20 7365 6c66 2e72 756e 6e69 6e67  a = self.running
+00007020: 5f64 6174 610a 2020 2020 2020 2020 2020  _data.          
+00007030: 2020 2020 2020 6966 2069 6e64 6963 6573        if indices
+00007040: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00007050: 2020 2020 2020 2020 2020 2020 2020 5f6c                _l
+00007060: 6f67 6765 722e 696e 666f 280a 2020 2020  ogger.info(.    
+00007070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007080: 2020 2020 2243 6f6d 7075 7469 6e67 2062      "Computing b
+00007090: 6163 6b67 726f 756e 6420 6672 6f6d 2025  ackground from %
+000070a0: 7320 6f66 2072 6177 2064 6174 6122 2c20  s of raw data", 
+000070b0: 6d65 7468 6f64 2e6e 616d 650a 2020 2020  method.name.    
+000070c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000070d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000070e0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000070f0: 2020 2020 2020 2020 2020 2020 5f6c 6f67              _log
+00007100: 6765 722e 696e 666f 280a 2020 2020 2020  ger.info(.      
+00007110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007120: 2020 2243 6f6d 7075 7469 6e67 2062 6163    "Computing bac
+00007130: 6b67 726f 756e 6420 6672 6f6d 2025 7320  kground from %s 
+00007140: 6f66 2068 6967 6820 696e 7465 6e73 6974  of high intensit
+00007150: 7920 6461 7461 222c 0a20 2020 2020 2020  y data",.       
+00007160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007170: 206d 6574 686f 642e 6e61 6d65 2c0a 2020   method.name,.  
 00007180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007190: 2022 436f 6d70 7574 696e 6720 6261 636b   "Computing back
-000071a0: 6772 6f75 6e64 2066 726f 6d20 2573 206f  ground from %s o
-000071b0: 6620 6869 6768 2069 6e74 656e 7369 7479  f high intensity
-000071c0: 2064 6174 6122 2c0a 2020 2020 2020 2020   data",.        
-000071d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000071e0: 6d65 7468 6f64 2e6e 616d 652c 0a20 2020  method.name,.   
+00007190: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+000071a0: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+000071b0: 6261 636b 6772 6f75 6e64 2c20 4461 7461  background, Data
+000071c0: 7365 7429 3a0a 2020 2020 2020 2020 2020  set):.          
+000071d0: 2020 2020 2020 6267 5f64 6174 6120 3d20        bg_data = 
+000071e0: 6261 636b 6772 6f75 6e64 2e64 6174 610a  background.data.
 000071f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007200: 2029 0a20 2020 2020 2020 2020 2020 2065   ).            e
-00007210: 6c69 6620 6973 696e 7374 616e 6365 2862  lif isinstance(b
-00007220: 6163 6b67 726f 756e 642c 2044 6174 6173  ackground, Datas
-00007230: 6574 293a 0a20 2020 2020 2020 2020 2020  et):.           
-00007240: 2020 2020 2062 675f 6461 7461 203d 2062       bg_data = b
-00007250: 6163 6b67 726f 756e 642e 6461 7461 0a20  ackground.data. 
-00007260: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-00007270: 6c6f 6767 6572 2e69 6e66 6f28 0a20 2020  logger.info(.   
-00007280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007290: 2022 436f 6d70 7574 696e 6720 6261 636b   "Computing back
-000072a0: 6772 6f75 6e64 2066 726f 6d20 2573 206f  ground from %s o
-000072b0: 6620 6062 6163 6b67 726f 756e 6460 2073  f `background` s
-000072c0: 6574 222c 206d 6574 686f 642e 6e61 6d65  et", method.name
-000072d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000072e0: 2029 0a20 2020 2020 2020 2020 2020 2065   ).            e
-000072f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00007300: 2020 2020 2062 675f 6461 7461 203d 2073       bg_data = s
-00007310: 656c 662e 6765 745f 6461 7461 2862 6163  elf.get_data(bac
-00007320: 6b67 726f 756e 6429 0a20 2020 2020 2020  kground).       
-00007330: 2020 2020 2020 2020 205f 6c6f 6767 6572           _logger
-00007340: 2e69 6e66 6f28 0a20 2020 2020 2020 2020  .info(.         
-00007350: 2020 2020 2020 2020 2020 2022 436f 6d70             "Comp
-00007360: 7574 696e 6720 6261 636b 6772 6f75 6e64  uting background
-00007370: 2066 726f 6d20 2573 206f 6620 6c6f 7720   from %s of low 
-00007380: 696e 7465 6e73 6974 7920 6461 7461 222c  intensity data",
-00007390: 206d 6574 686f 642e 6e61 6d65 0a20 2020   method.name.   
-000073a0: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-000073b0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-000073c0: 656c 662e 5f69 6e5f 6d65 6d6f 7279 3a0a  elf._in_memory:.
-000073d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000073e0: 6e65 775f 6461 7461 203d 2062 6163 6b67  new_data = backg
-000073f0: 726f 756e 645f 7375 6274 7261 6374 696f  round_subtractio
-00007400: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-00007410: 2020 2020 2020 2073 656c 662e 7275 6e6e         self.runn
-00007420: 696e 675f 6461 7461 2c20 6267 5f64 6174  ing_data, bg_dat
-00007430: 612c 206d 6574 686f 640a 2020 2020 2020  a, method.      
-00007440: 2020 2020 2020 2020 2020 292e 7669 6577            ).view
-00007450: 2844 6174 6129 0a20 2020 2020 2020 2020  (Data).         
-00007460: 2020 2020 2020 206e 6577 5f64 6174 612e         new_data.
-00007470: 7361 7665 286f 732e 7061 7468 2e6a 6f69  save(os.path.joi
-00007480: 6e28 7465 6d70 5f64 6972 2c20 2264 6174  n(temp_dir, "dat
-00007490: 612e 6864 6635 2229 290a 2020 2020 2020  a.hdf5")).      
-000074a0: 2020 2020 2020 2020 2020 7572 6c73 203d            urls =
-000074b0: 206e 6577 5f64 6174 612e 7572 6c73 0a20   new_data.urls. 
-000074c0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-000074d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000074e0: 2062 6720 3d20 6e75 6d70 792e 7a65 726f   bg = numpy.zero
-000074f0: 7328 7365 6c66 2e72 756e 6e69 6e67 5f64  s(self.running_d
-00007500: 6174 615b 305d 2e73 6861 7065 2c20 7365  ata[0].shape, se
-00007510: 6c66 2e72 756e 6e69 6e67 5f64 6174 612e  lf.running_data.
-00007520: 6474 7970 6529 0a20 2020 2020 2020 2020  dtype).         
-00007530: 2020 2020 2020 2069 6620 6d65 7468 6f64         if method
-00007540: 203d 3d20 4d65 7468 6f64 2e6d 6561 6e3a   == Method.mean:
-00007550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007560: 2020 2020 2069 6620 6267 5f64 6174 612e       if bg_data.
-00007570: 696e 5f6d 656d 6f72 793a 0a20 2020 2020  in_memory:.     
-00007580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007590: 2020 206e 756d 7079 2e6d 6561 6e28 6267     numpy.mean(bg
-000075a0: 5f64 6174 612c 206f 7574 3d62 672c 2061  _data, out=bg, a
-000075b0: 7869 733d 3029 0a20 2020 2020 2020 2020  xis=0).         
-000075c0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-000075d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000075e0: 2020 2020 2020 2020 2069 6f5f 7574 696c           io_util
-000075f0: 732e 6164 7661 6e63 656d 656e 745f 6469  s.advancement_di
-00007600: 7370 6c61 7928 0a20 2020 2020 2020 2020  splay(.         
-00007610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007620: 2020 2030 2c20 6c65 6e28 6267 5f64 6174     0, len(bg_dat
-00007630: 6129 2c20 2243 6f6d 7075 7469 6e67 206d  a), "Computing m
-00007640: 6561 6e20 696d 6167 6522 0a20 2020 2020  ean image".     
-00007650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007660: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00007670: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00007680: 2069 2069 6e20 7261 6e67 6528 6c65 6e28   i in range(len(
-00007690: 6267 5f64 6174 6129 293a 0a20 2020 2020  bg_data)):.     
-000076a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000076b0: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
-000076c0: 6c66 2e73 7461 7465 5f6f 665f 6f70 6572  lf.state_of_oper
-000076d0: 6174 696f 6e73 2e69 735f 7275 6e6e 696e  ations.is_runnin
-000076e0: 6728 4f70 6572 6174 696f 6e2e 4253 293a  g(Operation.BS):
-000076f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007710: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-00007720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007730: 2020 2020 6267 203d 2069 6d67 3269 6d67      bg = img2img
-00007740: 5f6d 6561 6e28 6267 5f64 6174 615b 695d  _mean(bg_data[i]
-00007750: 2c20 6267 2c20 6929 0a20 2020 2020 2020  , bg, i).       
-00007760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007770: 2020 2020 2069 6f5f 7574 696c 732e 6164       io_utils.ad
-00007780: 7661 6e63 656d 656e 745f 6469 7370 6c61  vancement_displa
-00007790: 7928 0a20 2020 2020 2020 2020 2020 2020  y(.             
-000077a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000077b0: 2020 2069 202b 2031 2c20 6c65 6e28 6267     i + 1, len(bg
-000077c0: 5f64 6174 6129 2c20 2243 6f6d 7075 7469  _data), "Computi
-000077d0: 6e67 206d 6561 6e20 696d 6167 6522 0a20  ng mean image". 
-000077e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000077f0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00007800: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-00007810: 6620 6d65 7468 6f64 203d 3d20 4d65 7468  f method == Meth
-00007820: 6f64 2e6d 6564 6961 6e3a 0a20 2020 2020  od.median:.     
-00007830: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00007840: 6620 6267 5f64 6174 612e 696e 5f6d 656d  f bg_data.in_mem
-00007850: 6f72 793a 0a20 2020 2020 2020 2020 2020  ory:.           
-00007860: 2020 2020 2020 2020 2020 2020 206e 756d               num
-00007870: 7079 2e6d 6564 6961 6e28 6267 5f64 6174  py.median(bg_dat
-00007880: 612c 206f 7574 3d62 672c 2061 7869 733d  a, out=bg, axis=
-00007890: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
-000078a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000078b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000078c0: 2020 2020 2069 6620 7374 6570 2069 7320       if step is 
-000078d0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00007200: 5f6c 6f67 6765 722e 696e 666f 280a 2020  _logger.info(.  
+00007210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007220: 2020 2243 6f6d 7075 7469 6e67 2062 6163    "Computing bac
+00007230: 6b67 726f 756e 6420 6672 6f6d 2025 7320  kground from %s 
+00007240: 6f66 2060 6261 636b 6772 6f75 6e64 6020  of `background` 
+00007250: 7365 7422 2c20 6d65 7468 6f64 2e6e 616d  set", method.nam
+00007260: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00007270: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00007280: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00007290: 2020 2020 2020 6267 5f64 6174 6120 3d20        bg_data = 
+000072a0: 7365 6c66 2e67 6574 5f64 6174 6128 6261  self.get_data(ba
+000072b0: 636b 6772 6f75 6e64 290a 2020 2020 2020  ckground).      
+000072c0: 2020 2020 2020 2020 2020 5f6c 6f67 6765            _logge
+000072d0: 722e 696e 666f 280a 2020 2020 2020 2020  r.info(.        
+000072e0: 2020 2020 2020 2020 2020 2020 2243 6f6d              "Com
+000072f0: 7075 7469 6e67 2062 6163 6b67 726f 756e  puting backgroun
+00007300: 6420 6672 6f6d 2025 7320 6f66 206c 6f77  d from %s of low
+00007310: 2069 6e74 656e 7369 7479 2064 6174 6122   intensity data"
+00007320: 2c20 6d65 7468 6f64 2e6e 616d 650a 2020  , method.name.  
+00007330: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00007340: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00007350: 7365 6c66 2e5f 696e 5f6d 656d 6f72 793a  self._in_memory:
+00007360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007370: 206e 6577 5f64 6174 6120 3d20 6261 636b   new_data = back
+00007380: 6772 6f75 6e64 5f73 7562 7472 6163 7469  ground_subtracti
+00007390: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+000073a0: 2020 2020 2020 2020 7365 6c66 2e72 756e          self.run
+000073b0: 6e69 6e67 5f64 6174 612c 2062 675f 6461  ning_data, bg_da
+000073c0: 7461 2c20 6d65 7468 6f64 0a20 2020 2020  ta, method.     
+000073d0: 2020 2020 2020 2020 2020 2029 2e76 6965             ).vie
+000073e0: 7728 4461 7461 290a 2020 2020 2020 2020  w(Data).        
+000073f0: 2020 2020 2020 2020 6e65 775f 6461 7461          new_data
+00007400: 2e73 6176 6528 6f73 2e70 6174 682e 6a6f  .save(os.path.jo
+00007410: 696e 2874 656d 705f 6469 722c 2022 6461  in(temp_dir, "da
+00007420: 7461 2e68 6466 3522 2929 0a20 2020 2020  ta.hdf5")).     
+00007430: 2020 2020 2020 2020 2020 2075 726c 7320             urls 
+00007440: 3d20 6e65 775f 6461 7461 2e75 726c 730a  = new_data.urls.
+00007450: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00007460: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00007470: 2020 6267 203d 206e 756d 7079 2e7a 6572    bg = numpy.zer
+00007480: 6f73 2873 656c 662e 7275 6e6e 696e 675f  os(self.running_
+00007490: 6461 7461 5b30 5d2e 7368 6170 652c 2073  data[0].shape, s
+000074a0: 656c 662e 7275 6e6e 696e 675f 6461 7461  elf.running_data
+000074b0: 2e64 7479 7065 290a 2020 2020 2020 2020  .dtype).        
+000074c0: 2020 2020 2020 2020 6966 206d 6574 686f          if metho
+000074d0: 6420 3d3d 204d 6574 686f 642e 6d65 616e  d == Method.mean
+000074e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000074f0: 2020 2020 2020 6966 2062 675f 6461 7461        if bg_data
+00007500: 2e69 6e5f 6d65 6d6f 7279 3a0a 2020 2020  .in_memory:.    
+00007510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007520: 2020 2020 6e75 6d70 792e 6d65 616e 2862      numpy.mean(b
+00007530: 675f 6461 7461 2c20 6f75 743d 6267 2c20  g_data, out=bg, 
+00007540: 6178 6973 3d30 290a 2020 2020 2020 2020  axis=0).        
+00007550: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00007560: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00007570: 2020 2020 2020 2020 2020 696f 5f75 7469            io_uti
+00007580: 6c73 2e61 6476 616e 6365 6d65 6e74 5f64  ls.advancement_d
+00007590: 6973 706c 6179 280a 2020 2020 2020 2020  isplay(.        
+000075a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000075b0: 2020 2020 302c 206c 656e 2862 675f 6461      0, len(bg_da
+000075c0: 7461 292c 2022 436f 6d70 7574 696e 6720  ta), "Computing 
+000075d0: 6d65 616e 2069 6d61 6765 220a 2020 2020  mean image".    
+000075e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000075f0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00007600: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00007610: 7220 6920 696e 2072 616e 6765 286c 656e  r i in range(len
+00007620: 2862 675f 6461 7461 2929 3a0a 2020 2020  (bg_data)):.    
+00007630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007640: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+00007650: 656c 662e 7374 6174 655f 6f66 5f6f 7065  elf.state_of_ope
+00007660: 7261 7469 6f6e 732e 6973 5f72 756e 6e69  rations.is_runni
+00007670: 6e67 284f 7065 7261 7469 6f6e 2e42 5329  ng(Operation.BS)
+00007680: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00007690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000076a0: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
+000076b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000076c0: 2020 2020 2062 6720 3d20 696d 6732 696d       bg = img2im
+000076d0: 675f 6d65 616e 2862 675f 6461 7461 5b69  g_mean(bg_data[i
+000076e0: 5d2c 2062 672c 2069 290a 2020 2020 2020  ], bg, i).      
+000076f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007700: 2020 2020 2020 696f 5f75 7469 6c73 2e61        io_utils.a
+00007710: 6476 616e 6365 6d65 6e74 5f64 6973 706c  dvancement_displ
+00007720: 6179 280a 2020 2020 2020 2020 2020 2020  ay(.            
+00007730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007740: 2020 2020 6920 2b20 312c 206c 656e 2862      i + 1, len(b
+00007750: 675f 6461 7461 292c 2022 436f 6d70 7574  g_data), "Comput
+00007760: 696e 6720 6d65 616e 2069 6d61 6765 220a  ing mean image".
+00007770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007780: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00007790: 2020 2020 2020 2020 2020 2020 2020 656c                el
+000077a0: 6966 206d 6574 686f 6420 3d3d 204d 6574  if method == Met
+000077b0: 686f 642e 6d65 6469 616e 3a0a 2020 2020  hod.median:.    
+000077c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000077d0: 6966 2062 675f 6461 7461 2e69 6e5f 6d65  if bg_data.in_me
+000077e0: 6d6f 7279 3a0a 2020 2020 2020 2020 2020  mory:.          
+000077f0: 2020 2020 2020 2020 2020 2020 2020 6e75                nu
+00007800: 6d70 792e 6d65 6469 616e 2862 675f 6461  mpy.median(bg_da
+00007810: 7461 2c20 6f75 743d 6267 2c20 6178 6973  ta, out=bg, axis
+00007820: 3d30 290a 2020 2020 2020 2020 2020 2020  =0).            
+00007830: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00007840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007850: 2020 2020 2020 6966 2073 7465 7020 6973        if step is
+00007860: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00007870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007880: 2020 2020 2020 2062 675f 696e 6469 6365         bg_indice
+00007890: 7320 3d20 6e75 6d70 792e 6172 616e 6765  s = numpy.arange
+000078a0: 2830 2c20 6c65 6e28 6267 5f64 6174 6129  (0, len(bg_data)
+000078b0: 2c20 7374 6570 290a 2020 2020 2020 2020  , step).        
+000078c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000078d0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
 000078e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000078f0: 2020 2020 2020 6267 5f69 6e64 6963 6573        bg_indices
-00007900: 203d 206e 756d 7079 2e61 7261 6e67 6528   = numpy.arange(
-00007910: 302c 206c 656e 2862 675f 6461 7461 292c  0, len(bg_data),
-00007920: 2073 7465 7029 0a20 2020 2020 2020 2020   step).         
-00007930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007940: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00007950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007960: 2020 2020 2020 2020 6e75 6d70 792e 6d65          numpy.me
-00007970: 6469 616e 280a 2020 2020 2020 2020 2020  dian(.          
+000078f0: 2020 2020 2020 2020 206e 756d 7079 2e6d           numpy.m
+00007900: 6564 6961 6e28 0a20 2020 2020 2020 2020  edian(.         
+00007910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007920: 2020 2020 2020 2020 2020 2044 6174 6128             Data(
+00007930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007950: 2020 2020 2020 2020 2062 675f 6461 7461           bg_data
+00007960: 2e75 726c 735b 6267 5f69 6e64 6963 6573  .urls[bg_indices
+00007970: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
 00007980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007990: 2020 2020 2020 2020 2020 4461 7461 280a            Data(.
-000079a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000079b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000079c0: 2020 2020 2020 2020 6267 5f64 6174 612e          bg_data.
-000079d0: 7572 6c73 5b62 675f 696e 6469 6365 735d  urls[bg_indices]
-000079e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00007990: 2020 2020 2020 2020 2020 2062 675f 6461             bg_da
+000079a0: 7461 2e6d 6574 6164 6174 615b 6267 5f69  ta.metadata[bg_i
+000079b0: 6e64 6963 6573 5d2c 0a20 2020 2020 2020  ndices],.       
+000079c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000079d0: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
+000079e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000079f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007a00: 2020 2020 2020 2020 2020 6267 5f64 6174            bg_dat
-00007a10: 612e 6d65 7461 6461 7461 5b62 675f 696e  a.metadata[bg_in
-00007a20: 6469 6365 735d 2c0a 2020 2020 2020 2020  dices],.        
-00007a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007a40: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
-00007a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007a00: 2020 2020 6f75 743d 6267 2c0a 2020 2020      out=bg,.    
+00007a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007a30: 6178 6973 3d30 2c0a 2020 2020 2020 2020  axis=0,.        
+00007a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007a50: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
 00007a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007a70: 2020 206f 7574 3d62 672c 0a20 2020 2020     out=bg,.     
-00007a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007a90: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00007aa0: 7869 733d 302c 0a20 2020 2020 2020 2020  xis=0,.         
-00007ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007ac0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00007ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007ae0: 2020 2020 2065 7863 6570 7420 4d65 6d6f       except Memo
-00007af0: 7279 4572 726f 723a 0a20 2020 2020 2020  ryError:.       
-00007b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007b10: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-00007b20: 7365 6c66 2e73 7461 7465 5f6f 665f 6f70  self.state_of_op
-00007b30: 6572 6174 696f 6e73 2e69 735f 7275 6e6e  erations.is_runn
-00007b40: 696e 6728 0a20 2020 2020 2020 2020 2020  ing(.           
-00007b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007b60: 2020 2020 2020 2020 204f 7065 7261 7469           Operati
-00007b70: 6f6e 2e42 530a 2020 2020 2020 2020 2020  on.BS.          
-00007b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007b90: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
-00007ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007bb0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00007bc0: 7572 6e0a 2020 2020 2020 2020 2020 2020  urn.            
-00007bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007be0: 2020 2020 5f6c 6f67 6765 722e 6572 726f      _logger.erro
-00007bf0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00007a70: 2020 2020 2020 6578 6365 7074 204d 656d        except Mem
+00007a80: 6f72 7945 7272 6f72 3a0a 2020 2020 2020  oryError:.      
+00007a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007aa0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00007ab0: 2073 656c 662e 7374 6174 655f 6f66 5f6f   self.state_of_o
+00007ac0: 7065 7261 7469 6f6e 732e 6973 5f72 756e  perations.is_run
+00007ad0: 6e69 6e67 280a 2020 2020 2020 2020 2020  ning(.          
+00007ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007af0: 2020 2020 2020 2020 2020 4f70 6572 6174            Operat
+00007b00: 696f 6e2e 4253 0a20 2020 2020 2020 2020  ion.BS.         
+00007b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007b20: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
+00007b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007b40: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00007b50: 7475 726e 0a20 2020 2020 2020 2020 2020  turn.           
+00007b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007b70: 2020 2020 205f 6c6f 6767 6572 2e65 7272       _logger.err
+00007b80: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00007b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ba0: 2020 2020 2020 2020 224d 656d 6f72 7945          "MemoryE
+00007bb0: 7272 6f72 2c20 7472 7969 6e67 2077 6974  rror, trying wit
+00007bc0: 6820 7374 6570 2025 7322 2c20 7374 6570  h step %s", step
+00007bd0: 202b 2031 0a20 2020 2020 2020 2020 2020   + 1.           
+00007be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007bf0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
 00007c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007c10: 2020 2020 2020 2022 4d65 6d6f 7279 4572         "MemoryEr
-00007c20: 726f 722c 2074 7279 696e 6720 7769 7468  ror, trying with
-00007c30: 2073 7465 7020 2573 222c 2073 7465 7020   step %s", step 
-00007c40: 2b20 310a 2020 2020 2020 2020 2020 2020  + 1.            
+00007c10: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00007c20: 6c66 2e61 7070 6c79 5f62 6163 6b67 726f  lf.apply_backgro
+00007c30: 756e 645f 7375 6274 7261 6374 696f 6e28  und_subtraction(
+00007c40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00007c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007c60: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00007c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007c80: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00007c90: 662e 6170 706c 795f 6261 636b 6772 6f75  f.apply_backgrou
-00007ca0: 6e64 5f73 7562 7472 6163 7469 6f6e 280a  nd_subtraction(.
+00007c60: 2020 2020 2062 6163 6b67 726f 756e 642c       background,
+00007c70: 206d 6574 686f 642c 2069 6e64 6963 6573   method, indices
+00007c80: 2c20 7374 6570 202b 2031 0a20 2020 2020  , step + 1.     
+00007c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ca0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
 00007cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007cd0: 2020 2020 6261 636b 6772 6f75 6e64 2c20      background, 
-00007ce0: 6d65 7468 6f64 2c20 696e 6469 6365 732c  method, indices,
-00007cf0: 2073 7465 7020 2b20 310a 2020 2020 2020   step + 1.      
+00007cc0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00007cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ce0: 2020 2020 2020 2073 7461 7274 203d 205b         start = [
+00007cf0: 302c 2030 5d0a 2020 2020 2020 2020 2020  0, 0].          
 00007d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007d10: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00007d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007d30: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00007d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007d50: 2020 2020 2020 7374 6172 7420 3d20 5b30        start = [0
-00007d60: 2c20 305d 0a20 2020 2020 2020 2020 2020  , 0].           
+00007d10: 2020 696d 6720 3d20 7365 6c66 2e72 756e    img = self.run
+00007d20: 6e69 6e67 5f64 6174 615b 305d 0a20 2020  ning_data[0].   
+00007d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007d40: 2020 2020 2020 2020 2062 6720 3d20 6e75           bg = nu
+00007d50: 6d70 792e 656d 7074 7928 696d 672e 7368  mpy.empty(img.sh
+00007d60: 6170 652c 2069 6d67 2e64 7479 7065 290a  ape, img.dtype).
 00007d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007d80: 2069 6d67 203d 2073 656c 662e 7275 6e6e   img = self.runn
-00007d90: 696e 675f 6461 7461 5b30 5d0a 2020 2020  ing_data[0].    
-00007da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007db0: 2020 2020 2020 2020 6267 203d 206e 756d          bg = num
-00007dc0: 7079 2e65 6d70 7479 2869 6d67 2e73 6861  py.empty(img.sha
-00007dd0: 7065 2c20 696d 672e 6474 7970 6529 0a20  pe, img.dtype). 
-00007de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007df0: 2020 2020 2020 2020 2020 2063 6875 6e6b             chunk
-00007e00: 735f 3120 3d20 696e 7428 6e75 6d70 792e  s_1 = int(numpy.
-00007e10: 6365 696c 2869 6d67 2e73 6861 7065 5b30  ceil(img.shape[0
-00007e20: 5d20 2f20 6368 756e 6b5f 7368 6170 655b  ] / chunk_shape[
-00007e30: 305d 2929 0a20 2020 2020 2020 2020 2020  0])).           
-00007e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007e50: 2063 6875 6e6b 735f 3220 3d20 696e 7428   chunks_2 = int(
-00007e60: 6e75 6d70 792e 6365 696c 2869 6d67 2e73  numpy.ceil(img.s
-00007e70: 6861 7065 5b31 5d20 2f20 6368 756e 6b5f  hape[1] / chunk_
-00007e80: 7368 6170 655b 315d 2929 0a20 2020 2020  shape[1])).     
-00007e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007ea0: 2020 2020 2020 2069 6f5f 7574 696c 732e         io_utils.
-00007eb0: 6164 7661 6e63 656d 656e 745f 6469 7370  advancement_disp
-00007ec0: 6c61 7928 0a20 2020 2020 2020 2020 2020  lay(.           
-00007ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007ee0: 2020 2020 2030 2c0a 2020 2020 2020 2020       0,.        
-00007ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007f00: 2020 2020 2020 2020 6368 756e 6b73 5f31          chunks_1
-00007f10: 202a 2063 6875 6e6b 735f 3220 2a20 6c65   * chunks_2 * le
-00007f20: 6e28 6267 5f64 6174 6129 2c0a 2020 2020  n(bg_data),.    
-00007f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007f40: 2020 2020 2020 2020 2020 2020 2243 6f6d              "Com
-00007f50: 7075 7469 6e67 206d 6564 6961 6e20 696d  puting median im
-00007f60: 6167 6522 2c0a 2020 2020 2020 2020 2020  age",.          
-00007f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007f80: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00007d80: 2020 2020 2020 2020 2020 2020 6368 756e              chun
+00007d90: 6b73 5f31 203d 2069 6e74 286e 756d 7079  ks_1 = int(numpy
+00007da0: 2e63 6569 6c28 696d 672e 7368 6170 655b  .ceil(img.shape[
+00007db0: 305d 202f 2063 6875 6e6b 5f73 6861 7065  0] / chunk_shape
+00007dc0: 5b30 5d29 290a 2020 2020 2020 2020 2020  [0])).          
+00007dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007de0: 2020 6368 756e 6b73 5f32 203d 2069 6e74    chunks_2 = int
+00007df0: 286e 756d 7079 2e63 6569 6c28 696d 672e  (numpy.ceil(img.
+00007e00: 7368 6170 655b 315d 202f 2063 6875 6e6b  shape[1] / chunk
+00007e10: 5f73 6861 7065 5b31 5d29 290a 2020 2020  _shape[1])).    
+00007e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007e30: 2020 2020 2020 2020 696f 5f75 7469 6c73          io_utils
+00007e40: 2e61 6476 616e 6365 6d65 6e74 5f64 6973  .advancement_dis
+00007e50: 706c 6179 280a 2020 2020 2020 2020 2020  play(.          
+00007e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007e70: 2020 2020 2020 302c 0a20 2020 2020 2020        0,.       
+00007e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007e90: 2020 2020 2020 2020 2063 6875 6e6b 735f           chunks_
+00007ea0: 3120 2a20 6368 756e 6b73 5f32 202a 206c  1 * chunks_2 * l
+00007eb0: 656e 2862 675f 6461 7461 292c 0a20 2020  en(bg_data),.   
+00007ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ed0: 2020 2020 2020 2020 2020 2020 2022 436f               "Co
+00007ee0: 6d70 7574 696e 6720 6d65 6469 616e 2069  mputing median i
+00007ef0: 6d61 6765 222c 0a20 2020 2020 2020 2020  mage",.         
+00007f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007f10: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00007f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007f30: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+00007f40: 6368 756e 6b73 5f31 293a 0a20 2020 2020  chunks_1):.     
+00007f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007f60: 2020 2020 2020 2020 2020 2066 6f72 206a             for j
+00007f70: 2069 6e20 7261 6e67 6528 6368 756e 6b73   in range(chunks
+00007f80: 5f32 293a 0a20 2020 2020 2020 2020 2020  _2):.           
 00007f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007fa0: 666f 7220 6920 696e 2072 616e 6765 2863  for i in range(c
-00007fb0: 6875 6e6b 735f 3129 3a0a 2020 2020 2020  hunks_1):.      
-00007fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007fd0: 2020 2020 2020 2020 2020 666f 7220 6a20            for j 
-00007fe0: 696e 2072 616e 6765 2863 6875 6e6b 735f  in range(chunks_
-00007ff0: 3229 3a0a 2020 2020 2020 2020 2020 2020  2):.            
-00008000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008010: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-00008020: 656c 662e 7374 6174 655f 6f66 5f6f 7065  elf.state_of_ope
-00008030: 7261 7469 6f6e 732e 6973 5f72 756e 6e69  rations.is_runni
-00008040: 6e67 280a 2020 2020 2020 2020 2020 2020  ng(.            
-00008050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008060: 2020 2020 2020 2020 2020 2020 4f70 6572              Oper
-00008070: 6174 696f 6e2e 4253 0a20 2020 2020 2020  ation.BS.       
-00008080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008090: 2020 2020 2020 2020 2020 2020 2029 3a0a               ):.
+00007fa0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00007fb0: 7365 6c66 2e73 7461 7465 5f6f 665f 6f70  self.state_of_op
+00007fc0: 6572 6174 696f 6e73 2e69 735f 7275 6e6e  erations.is_runn
+00007fd0: 696e 6728 0a20 2020 2020 2020 2020 2020  ing(.           
+00007fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ff0: 2020 2020 2020 2020 2020 2020 204f 7065               Ope
+00008000: 7261 7469 6f6e 2e42 530a 2020 2020 2020  ration.BS.      
+00008010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008020: 2020 2020 2020 2020 2020 2020 2020 293a                ):
+00008030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008050: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+00008060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008080: 2020 2020 635f 696d 6167 6573 203d 205b      c_images = [
+00008090: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
 000080a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000080b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000080c0: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-000080d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000080b0: 2020 2020 2020 6370 7573 203d 206d 756c        cpus = mul
+000080c0: 7469 7072 6f63 6573 7369 6e67 2e63 7075  tiprocessing.cpu
+000080d0: 5f63 6f75 6e74 2829 0a20 2020 2020 2020  _count().       
 000080e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000080f0: 2020 2063 5f69 6d61 6765 7320 3d20 5b5d     c_images = []
-00008100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008120: 2020 2020 2063 7075 7320 3d20 6d75 6c74       cpus = mult
-00008130: 6970 726f 6365 7373 696e 672e 6370 755f  iprocessing.cpu_
-00008140: 636f 756e 7428 290a 2020 2020 2020 2020  count().        
-00008150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008160: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00008170: 2050 6f6f 6c28 6370 7573 202d 2031 2920   Pool(cpus - 1) 
-00008180: 6173 2070 3a0a 2020 2020 2020 2020 2020  as p:.          
-00008190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000081a0: 2020 2020 2020 2020 2020 2020 2020 635f                c_
-000081b0: 696d 6167 6573 203d 2070 2e6d 6170 280a  images = p.map(.
+000080f0: 2020 2020 2020 2020 2020 2020 2077 6974               wit
+00008100: 6820 506f 6f6c 2863 7075 7320 2d20 3129  h Pool(cpus - 1)
+00008110: 2061 7320 703a 0a20 2020 2020 2020 2020   as p:.         
+00008120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008130: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00008140: 5f69 6d61 6765 7320 3d20 702e 6d61 7028  _images = p.map(
+00008150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008170: 2020 2020 2020 2020 2020 2020 2070 6172               par
+00008180: 7469 616c 2863 6875 6e6b 5f69 6d61 6765  tial(chunk_image
+00008190: 2c20 7374 6172 742c 2063 6875 6e6b 5f73  , start, chunk_s
+000081a0: 6861 7065 292c 0a20 2020 2020 2020 2020  hape),.         
+000081b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000081c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000081d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000081e0: 2020 2020 2020 2020 2020 2020 7061 7274              part
-000081f0: 6961 6c28 6368 756e 6b5f 696d 6167 652c  ial(chunk_image,
-00008200: 2073 7461 7274 2c20 6368 756e 6b5f 7368   start, chunk_sh
-00008210: 6170 6529 2c0a 2020 2020 2020 2020 2020  ape),.          
-00008220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008240: 2020 6267 5f64 6174 612c 0a20 2020 2020    bg_data,.     
+000081d0: 2020 2062 675f 6461 7461 2c0a 2020 2020     bg_data,.    
+000081e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000081f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008200: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00008210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008220: 2020 2020 2020 2020 2020 696f 5f75 7469            io_uti
+00008230: 6c73 2e61 6476 616e 6365 6d65 6e74 5f64  ls.advancement_d
+00008240: 6973 706c 6179 280a 2020 2020 2020 2020  isplay(.        
 00008250: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00008260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008270: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00008280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008290: 2020 2020 2020 2020 2069 6f5f 7574 696c           io_util
-000082a0: 732e 6164 7661 6e63 656d 656e 745f 6469  s.advancement_di
-000082b0: 7370 6c61 7928 0a20 2020 2020 2020 2020  splay(.         
-000082c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000082d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000082e0: 202a 2063 6875 6e6b 735f 3220 2b20 6a20   * chunks_2 + j 
-000082f0: 2b20 312c 0a20 2020 2020 2020 2020 2020  + 1,.           
-00008300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008310: 2020 2020 2020 2020 2020 2020 2063 6875               chu
-00008320: 6e6b 735f 3120 2a20 6368 756e 6b73 5f32  nks_1 * chunks_2
-00008330: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00008340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008350: 2020 2020 2020 2020 2020 2243 6f6d 7075            "Compu
-00008360: 7469 6e67 206d 6564 6961 6e20 696d 6167  ting median imag
-00008370: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-00008380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008390: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00008270: 6920 2a20 6368 756e 6b73 5f32 202b 206a  i * chunks_2 + j
+00008280: 202b 2031 2c0a 2020 2020 2020 2020 2020   + 1,.          
+00008290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000082a0: 2020 2020 2020 2020 2020 2020 2020 6368                ch
+000082b0: 756e 6b73 5f31 202a 2063 6875 6e6b 735f  unks_1 * chunks_
+000082c0: 322c 0a20 2020 2020 2020 2020 2020 2020  2,.             
+000082d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000082e0: 2020 2020 2020 2020 2020 2022 436f 6d70             "Comp
+000082f0: 7574 696e 6720 6d65 6469 616e 2069 6d61  uting median ima
+00008300: 6765 222c 0a20 2020 2020 2020 2020 2020  ge",.           
+00008310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008320: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00008330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008340: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00008350: 756d 7079 2e6d 6564 6961 6e28 0a20 2020  umpy.median(.   
+00008360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008380: 2020 2020 2063 5f69 6d61 6765 732c 0a20       c_images,. 
+00008390: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000083a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000083b0: 2020 2020 2020 2020 2020 2020 2020 6e75                nu
-000083c0: 6d70 792e 6d65 6469 616e 280a 2020 2020  mpy.median(.    
+000083b0: 2020 2020 2020 206f 7574 3d62 675b 0a20         out=bg[. 
+000083c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000083d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000083e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000083f0: 2020 2020 635f 696d 6167 6573 2c0a 2020      c_images,.  
-00008400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008420: 2020 2020 2020 6f75 743d 6267 5b0a 2020        out=bg[.  
-00008430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008450: 2020 2020 2020 2020 2020 7374 6172 745b            start[
-00008460: 305d 203a 2073 7461 7274 5b30 5d20 2b20  0] : start[0] + 
-00008470: 6368 756e 6b5f 7368 6170 655b 305d 2c0a  chunk_shape[0],.
-00008480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000083e0: 2020 2020 2020 2020 2020 2073 7461 7274             start
+000083f0: 5b30 5d20 3a20 7374 6172 745b 305d 202b  [0] : start[0] +
+00008400: 2063 6875 6e6b 5f73 6861 7065 5b30 5d2c   chunk_shape[0],
+00008410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008430: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+00008440: 7274 5b31 5d20 3a20 7374 6172 745b 315d  rt[1] : start[1]
+00008450: 202b 2063 6875 6e6b 5f73 6861 7065 5b31   + chunk_shape[1
+00008460: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00008470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008480: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
 00008490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000084a0: 2020 2020 2020 2020 2020 2020 7374 6172              star
-000084b0: 745b 315d 203a 2073 7461 7274 5b31 5d20  t[1] : start[1] 
-000084c0: 2b20 6368 756e 6b5f 7368 6170 655b 315d  + chunk_shape[1]
-000084d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000084e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000084f0: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
-00008500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008520: 2020 2020 2061 7869 733d 302c 0a20 2020       axis=0,.   
+000084a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000084b0: 2020 2020 2020 6178 6973 3d30 2c0a 2020        axis=0,.  
+000084c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000084d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000084e0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+000084f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008500: 2020 2020 2020 2020 7374 6172 745b 315d          start[1]
+00008510: 203d 2063 6875 6e6b 5f73 6861 7065 5b31   = chunk_shape[1
+00008520: 5d20 2a20 286a 202b 2031 290a 2020 2020  ] * (j + 1).    
 00008530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008550: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00008560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008570: 2020 2020 2020 2073 7461 7274 5b31 5d20         start[1] 
-00008580: 3d20 6368 756e 6b5f 7368 6170 655b 315d  = chunk_shape[1]
-00008590: 202a 2028 6a20 2b20 3129 0a20 2020 2020   * (j + 1).     
-000085a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000085b0: 2020 2020 2020 2020 2020 2073 7461 7274             start
-000085c0: 5b30 5d20 3d20 6368 756e 6b5f 7368 6170  [0] = chunk_shap
-000085d0: 655b 305d 202a 2028 6920 2b20 3129 0a20  e[0] * (i + 1). 
-000085e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000085f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00008600: 7461 7274 5b31 5d20 3d20 300a 0a20 2020  tart[1] = 0..   
-00008610: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00008620: 6e6f 7420 7365 6c66 2e73 7461 7465 5f6f  not self.state_o
-00008630: 665f 6f70 6572 6174 696f 6e73 2e69 735f  f_operations.is_
-00008640: 7275 6e6e 696e 6728 4f70 6572 6174 696f  running(Operatio
-00008650: 6e2e 4253 293a 0a20 2020 2020 2020 2020  n.BS):.         
-00008660: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00008670: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-00008680: 2020 7572 6c73 203d 2073 656c 662e 7275    urls = self.ru
-00008690: 6e6e 696e 675f 6461 7461 2e61 7070 6c79  nning_data.apply
-000086a0: 5f66 756e 6373 280a 2020 2020 2020 2020  _funcs(.        
-000086b0: 2020 2020 2020 2020 2020 2020 5b28 6261              [(ba
-000086c0: 636b 6772 6f75 6e64 5f73 7562 7472 6163  ckground_subtrac
-000086d0: 7469 6f6e 5f32 442c 205b 6267 5d29 5d2c  tion_2D, [bg])],
-000086e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000086f0: 2020 2020 2073 6176 653d 6f73 2e70 6174       save=os.pat
-00008700: 682e 6a6f 696e 2874 656d 705f 6469 722c  h.join(temp_dir,
-00008710: 2022 6461 7461 2e68 6466 3522 292c 0a20   "data.hdf5"),. 
-00008720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008730: 2020 2074 6578 743d 2241 7070 6c79 696e     text="Applyin
-00008740: 6720 6261 636b 6772 6f75 6e64 2073 7562  g background sub
-00008750: 7472 6163 7469 6f6e 222c 0a20 2020 2020  traction",.     
-00008760: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00008770: 7065 7261 7469 6f6e 3d4f 7065 7261 7469  peration=Operati
-00008780: 6f6e 2e42 532c 0a20 2020 2020 2020 2020  on.BS,.         
-00008790: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000087a0: 2020 2020 2020 2020 2069 6620 7572 6c73           if urls
-000087b0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-000087c0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000087d0: 7475 726e 0a0a 2020 2020 2020 2020 2320  turn..        # 
-000087e0: 5365 7420 7572 6c73 2061 7320 7368 6170  Set urls as shap
-000087f0: 6520 616e 6420 6469 6d65 6e73 696f 6e20  e and dimension 
-00008800: 6f66 206f 7269 6769 6e61 6c20 7572 6c73  of original urls
-00008810: 2e0a 2020 2020 2020 2020 6966 2069 6e64  ..        if ind
-00008820: 6963 6573 2069 7320 6e6f 7420 4e6f 6e65  ices is not None
-00008830: 3a0a 2020 2020 2020 2020 2020 2020 6e65  :.            ne
-00008840: 775f 7572 6c73 203d 206e 756d 7079 2e61  w_urls = numpy.a
-00008850: 7272 6179 2873 656c 662e 6765 745f 6461  rray(self.get_da
-00008860: 7461 2829 2e75 726c 732c 2064 7479 7065  ta().urls, dtype
-00008870: 3d6f 626a 6563 7429 0a20 2020 2020 2020  =object).       
-00008880: 2020 2020 206e 6577 5f75 726c 735b 696e       new_urls[in
-00008890: 6469 6365 735d 203d 2075 726c 730a 2020  dices] = urls.  
-000088a0: 2020 2020 2020 2020 2020 6e65 775f 6461            new_da
-000088b0: 7461 203d 2044 6174 6128 0a20 2020 2020  ta = Data(.     
-000088c0: 2020 2020 2020 2020 2020 206e 6577 5f75             new_u
-000088d0: 726c 732e 7265 7368 6170 6528 7365 6c66  rls.reshape(self
-000088e0: 2e64 6174 612e 7572 6c73 2e73 6861 7065  .data.urls.shape
-000088f0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00008900: 2020 2073 656c 662e 6461 7461 2e6d 6574     self.data.met
-00008910: 6164 6174 612c 0a20 2020 2020 2020 2020  adata,.         
-00008920: 2020 2020 2020 2073 656c 662e 5f69 6e5f         self._in_
-00008930: 6d65 6d6f 7279 2c0a 2020 2020 2020 2020  memory,.        
-00008940: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
-00008950: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00008960: 6e65 775f 6461 7461 203d 2044 6174 6128  new_data = Data(
-00008970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008980: 2075 726c 732e 7265 7368 6170 6528 7365   urls.reshape(se
-00008990: 6c66 2e64 6174 612e 7572 6c73 2e73 6861  lf.data.urls.sha
-000089a0: 7065 292c 2073 656c 662e 6461 7461 2e6d  pe), self.data.m
-000089b0: 6574 6164 6174 612c 2073 656c 662e 5f69  etadata, self._i
-000089c0: 6e5f 6d65 6d6f 7279 0a20 2020 2020 2020  n_memory.       
-000089d0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-000089e0: 6e65 775f 6461 7461 2e73 6176 6528 6f73  new_data.save(os
-000089f0: 2e70 6174 682e 6a6f 696e 285f 6469 722c  .path.join(_dir,
-00008a00: 2022 6461 7461 2e68 6466 3522 292c 2069   "data.hdf5"), i
-00008a10: 6e64 6963 6573 3d69 6e64 6963 6573 290a  ndices=indices).
-00008a20: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-00008a30: 2020 2020 2020 2020 2020 6f73 2e72 656d            os.rem
-00008a40: 6f76 6528 6f73 2e70 6174 682e 6a6f 696e  ove(os.path.join
-00008a50: 2874 656d 705f 6469 722c 2022 6461 7461  (temp_dir, "data
-00008a60: 2e68 6466 3522 2929 0a20 2020 2020 2020  .hdf5")).       
-00008a70: 2020 2020 206f 732e 726d 6469 7228 7465       os.rmdir(te
-00008a80: 6d70 5f64 6972 290a 2020 2020 2020 2020  mp_dir).        
-00008a90: 6578 6365 7074 204f 5345 7272 6f72 2061  except OSError a
-00008aa0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-00008ab0: 205f 6c6f 6767 6572 2e77 6172 6e69 6e67   _logger.warning
-00008ac0: 2822 4572 726f 723a 2025 7322 2025 2028  ("Error: %s" % (
-00008ad0: 652e 7374 7265 7272 6f72 2929 0a0a 2020  e.strerror))..  
-00008ae0: 2020 2020 2020 7265 7475 726e 2044 6174        return Dat
-00008af0: 6173 6574 280a 2020 2020 2020 2020 2020  aset(.          
-00008b00: 2020 5f64 6972 3d5f 6469 722c 0a20 2020    _dir=_dir,.   
-00008b10: 2020 2020 2020 2020 2064 6174 613d 6e65           data=ne
-00008b20: 775f 6461 7461 2c0a 2020 2020 2020 2020  w_data,.        
-00008b30: 2020 2020 6469 6d73 3d73 656c 662e 5f5f      dims=self.__
-00008b40: 6469 6d73 2c0a 2020 2020 2020 2020 2020  dims,.          
-00008b50: 2020 7472 616e 7366 6f72 6d61 7469 6f6e    transformation
-00008b60: 3d73 656c 662e 7472 616e 7366 6f72 6d61  =self.transforma
-00008b70: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
-00008b80: 2020 696e 5f6d 656d 6f72 793d 7365 6c66    in_memory=self
-00008b90: 2e5f 696e 5f6d 656d 6f72 792c 0a20 2020  ._in_memory,.   
-00008ba0: 2020 2020 2020 2020 2074 6974 6c65 3d73           title=s
-00008bb0: 656c 662e 7469 746c 652c 0a20 2020 2020  elf.title,.     
-00008bc0: 2020 2029 0a0a 2020 2020 6465 6620 6170     )..    def ap
-00008bd0: 706c 795f 686f 745f 7069 7865 6c5f 7265  ply_hot_pixel_re
-00008be0: 6d6f 7661 6c28 7365 6c66 2c20 6b65 726e  moval(self, kern
-00008bf0: 656c 3d33 2c20 696e 6469 6365 733d 4e6f  el=3, indices=No
-00008c00: 6e65 2c20 5f64 6972 3d4e 6f6e 6529 3a0a  ne, _dir=None):.
-00008c10: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00008c20: 2020 2020 4170 706c 6965 7320 686f 7420      Applies hot 
-00008c30: 7069 7865 6c20 7265 6d6f 7661 6c20 746f  pixel removal to
-00008c40: 2044 6174 612c 2061 6e64 2073 6176 6573   Data, and saves
-00008c50: 2074 6865 206e 6577 2064 6174 610a 2020   the new data.  
-00008c60: 2020 2020 2020 696e 746f 2064 6973 6b2e        into disk.
-00008c70: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-00008c80: 2069 6e74 206b 6572 6e65 6c3a 2073 697a   int kernel: siz
-00008c90: 6520 6f66 2074 6865 206b 6572 6e65 6c20  e of the kernel 
-00008ca0: 7573 6564 2074 6f20 6669 6e64 2074 6865  used to find the
-00008cb0: 2068 6f74 0a20 2020 2020 2020 2020 2020   hot.           
-00008cc0: 2070 6978 656c 732e 0a20 2020 2020 2020   pixels..       
-00008cd0: 203a 7061 7261 6d20 696e 6469 6365 733a   :param indices:
-00008ce0: 2049 6e64 6963 6573 206f 6620 7468 6520   Indices of the 
-00008cf0: 696d 6167 6573 2074 6f20 6170 706c 7920  images to apply 
-00008d00: 6261 636b 6772 6f75 6e64 2073 7562 7472  background subtr
-00008d10: 6163 7469 6f6e 2e0a 2020 2020 2020 2020  action..        
-00008d20: 2020 2020 4966 204e 6f6e 652c 2074 6865      If None, the
-00008d30: 2068 6f74 2070 6978 656c 2072 656d 6f76   hot pixel remov
-00008d40: 616c 2069 7320 6170 706c 6965 6420 746f  al is applied to
-00008d50: 2061 6c6c 2074 6865 2064 6174 612e 0a20   all the data.. 
-00008d60: 2020 2020 2020 203a 7479 7065 2069 6e64         :type ind
-00008d70: 6963 6573 3a20 556e 696f 6e5b 4e6f 6e65  ices: Union[None
-00008d80: 2c20 6172 7261 795f 6c69 6b65 5d0a 2020  , array_like].  
-00008d90: 2020 2020 2020 3a72 6574 7572 6e3a 2064        :return: d
-00008da0: 6174 6173 6574 2077 6974 6820 6461 7461  ataset with data
-00008db0: 206f 6620 7361 6d65 2073 697a 6520 6173   of same size as
-00008dc0: 2060 7365 6c66 2e64 6174 6160 2062 7574   `self.data` but
-00008dd0: 2077 6974 6820 7468 650a 2020 2020 2020   with the.      
-00008de0: 2020 2020 2020 6d6f 6469 6669 6564 2069        modified i
-00008df0: 6d61 6765 732e 2054 6865 2075 726c 7320  mages. The urls 
-00008e00: 6f66 2074 6865 206d 6f64 6966 6965 6420  of the modified 
-00008e10: 696d 6167 6573 2061 7265 2072 6570 6c61  images are repla
-00008e20: 6365 6420 7769 7468 0a20 2020 2020 2020  ced with.       
-00008e30: 2020 2020 2074 6865 206e 6577 2075 726c       the new url
-00008e40: 732e 0a20 2020 2020 2020 203a 7274 7970  s..        :rtyp
-00008e50: 653a 2044 6174 6173 6574 0a20 2020 2020  e: Dataset.     
-00008e60: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
-00008e70: 7365 6c66 2e72 756e 6e69 6e67 5f64 6174  self.running_dat
-00008e80: 6120 3d20 7365 6c66 2e67 6574 5f64 6174  a = self.get_dat
-00008e90: 6128 696e 6469 6365 7329 0a0a 2020 2020  a(indices)..    
-00008ea0: 2020 2020 5f64 6972 203d 2073 656c 662e      _dir = self.
-00008eb0: 6469 7220 6966 205f 6469 7220 6973 204e  dir if _dir is N
-00008ec0: 6f6e 6520 656c 7365 205f 6469 720a 0a20  one else _dir.. 
-00008ed0: 2020 2020 2020 206f 732e 6d61 6b65 6469         os.makedi
-00008ee0: 7273 285f 6469 722c 2065 7869 7374 5f6f  rs(_dir, exist_o
-00008ef0: 6b3d 5472 7565 290a 0a20 2020 2020 2020  k=True)..       
-00008f00: 2074 656d 705f 6469 7220 3d20 6f73 2e70   temp_dir = os.p
-00008f10: 6174 682e 6a6f 696e 285f 6469 722c 2022  ath.join(_dir, "
-00008f20: 7465 6d70 5f64 6972 2229 0a0a 2020 2020  temp_dir")..    
-00008f30: 2020 2020 6f73 2e6d 616b 6564 6972 7328      os.makedirs(
-00008f40: 7465 6d70 5f64 6972 2c20 6578 6973 745f  temp_dir, exist_
-00008f50: 6f6b 3d54 7275 6529 0a0a 2020 2020 2020  ok=True)..      
-00008f60: 2020 6966 2073 656c 662e 5f69 6e5f 6d65    if self._in_me
-00008f70: 6d6f 7279 3a0a 2020 2020 2020 2020 2020  mory:.          
-00008f80: 2020 6e65 775f 6461 7461 203d 2068 6f74    new_data = hot
-00008f90: 5f70 6978 656c 5f72 656d 6f76 616c 5f33  _pixel_removal_3
-00008fa0: 4428 7365 6c66 2e72 756e 6e69 6e67 5f64  D(self.running_d
-00008fb0: 6174 612c 206b 6572 6e65 6c29 2e76 6965  ata, kernel).vie
-00008fc0: 7728 4461 7461 290a 2020 2020 2020 2020  w(Data).        
-00008fd0: 2020 2020 6e65 775f 6461 7461 2e73 6176      new_data.sav
-00008fe0: 6528 6f73 2e70 6174 682e 6a6f 696e 2874  e(os.path.join(t
-00008ff0: 656d 705f 6469 722c 2022 6461 7461 2e68  emp_dir, "data.h
-00009000: 6466 3522 2929 0a20 2020 2020 2020 2020  df5")).         
-00009010: 2020 2075 726c 7320 3d20 6e65 775f 6461     urls = new_da
-00009020: 7461 2e75 726c 730a 2020 2020 2020 2020  ta.urls.        
-00009030: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00009040: 2020 7572 6c73 203d 2073 656c 662e 7275    urls = self.ru
-00009050: 6e6e 696e 675f 6461 7461 2e61 7070 6c79  nning_data.apply
-00009060: 5f66 756e 6373 280a 2020 2020 2020 2020  _funcs(.        
-00009070: 2020 2020 2020 2020 5b28 686f 745f 7069          [(hot_pi
-00009080: 7865 6c5f 7265 6d6f 7661 6c5f 3244 2c20  xel_removal_2D, 
-00009090: 5b6b 6572 6e65 6c5d 295d 2c0a 2020 2020  [kernel])],.    
-000090a0: 2020 2020 2020 2020 2020 2020 7361 7665              save
-000090b0: 3d6f 732e 7061 7468 2e6a 6f69 6e28 7465  =os.path.join(te
-000090c0: 6d70 5f64 6972 2c20 2264 6174 612e 6864  mp_dir, "data.hd
-000090d0: 6635 2229 2c0a 2020 2020 2020 2020 2020  f5"),.          
-000090e0: 2020 2020 2020 7465 7874 3d22 4170 706c        text="Appl
-000090f0: 7969 6e67 2068 6f74 2070 6978 656c 2072  ying hot pixel r
-00009100: 656d 6f76 616c 222c 0a20 2020 2020 2020  emoval",.       
-00009110: 2020 2020 2020 2020 206f 7065 7261 7469           operati
-00009120: 6f6e 3d4f 7065 7261 7469 6f6e 2e48 502c  on=Operation.HP,
-00009130: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00009140: 2020 2020 2020 2020 2020 2069 6620 7572             if ur
-00009150: 6c73 2069 7320 4e6f 6e65 3a0a 2020 2020  ls is None:.    
-00009160: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00009170: 726e 0a0a 2020 2020 2020 2020 6966 2069  rn..        if i
-00009180: 6e64 6963 6573 2069 7320 6e6f 7420 4e6f  ndices is not No
-00009190: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000091a0: 6e65 775f 7572 6c73 203d 206e 756d 7079  new_urls = numpy
-000091b0: 2e61 7272 6179 2873 656c 662e 6765 745f  .array(self.get_
-000091c0: 6461 7461 2829 2e75 726c 732c 2064 7479  data().urls, dty
-000091d0: 7065 3d6f 626a 6563 7429 0a20 2020 2020  pe=object).     
-000091e0: 2020 2020 2020 206e 6577 5f75 726c 735b         new_urls[
-000091f0: 696e 6469 6365 735d 203d 2075 726c 730a  indices] = urls.
-00009200: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
-00009210: 6461 7461 203d 2044 6174 6128 0a20 2020  data = Data(.   
-00009220: 2020 2020 2020 2020 2020 2020 206e 6577               new
-00009230: 5f75 726c 732e 7265 7368 6170 6528 7365  _urls.reshape(se
-00009240: 6c66 2e64 6174 612e 7572 6c73 2e73 6861  lf.data.urls.sha
-00009250: 7065 292c 0a20 2020 2020 2020 2020 2020  pe),.           
-00009260: 2020 2020 2073 656c 662e 6461 7461 2e6d       self.data.m
-00009270: 6574 6164 6174 612c 0a20 2020 2020 2020  etadata,.       
-00009280: 2020 2020 2020 2020 2073 656c 662e 5f69           self._i
-00009290: 6e5f 6d65 6d6f 7279 2c0a 2020 2020 2020  n_memory,.      
-000092a0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000092b0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000092c0: 2020 6e65 775f 6461 7461 203d 2044 6174    new_data = Dat
-000092d0: 6128 0a20 2020 2020 2020 2020 2020 2020  a(.             
-000092e0: 2020 2075 726c 732e 7265 7368 6170 6528     urls.reshape(
-000092f0: 7365 6c66 2e64 6174 612e 7572 6c73 2e73  self.data.urls.s
-00009300: 6861 7065 292c 2073 656c 662e 6461 7461  hape), self.data
-00009310: 2e6d 6574 6164 6174 612c 2073 656c 662e  .metadata, self.
-00009320: 5f69 6e5f 6d65 6d6f 7279 0a20 2020 2020  _in_memory.     
-00009330: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00009340: 2020 6e65 775f 6461 7461 2e73 6176 6528    new_data.save(
-00009350: 6f73 2e70 6174 682e 6a6f 696e 285f 6469  os.path.join(_di
-00009360: 722c 2022 6461 7461 2e68 6466 3522 292c  r, "data.hdf5"),
-00009370: 2069 6e64 6963 6573 3d69 6e64 6963 6573   indices=indices
-00009380: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
-00009390: 2020 2020 2020 2020 2020 206f 732e 7265             os.re
-000093a0: 6d6f 7665 286f 732e 7061 7468 2e6a 6f69  move(os.path.joi
-000093b0: 6e28 7465 6d70 5f64 6972 2c20 2264 6174  n(temp_dir, "dat
-000093c0: 612e 6864 6635 2229 290a 2020 2020 2020  a.hdf5")).      
-000093d0: 2020 2020 2020 6f73 2e72 6d64 6972 2874        os.rmdir(t
-000093e0: 656d 705f 6469 7229 0a20 2020 2020 2020  emp_dir).       
-000093f0: 2065 7863 6570 7420 4f53 4572 726f 7220   except OSError 
-00009400: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-00009410: 2020 5f6c 6f67 6765 722e 7761 726e 696e    _logger.warnin
-00009420: 6728 2245 7272 6f72 3a20 2573 2220 2520  g("Error: %s" % 
-00009430: 2865 2e73 7472 6572 726f 7229 290a 0a20  (e.strerror)).. 
-00009440: 2020 2020 2020 2072 6574 7572 6e20 4461         return Da
-00009450: 7461 7365 7428 0a20 2020 2020 2020 2020  taset(.         
-00009460: 2020 205f 6469 723d 5f64 6972 2c0a 2020     _dir=_dir,.  
-00009470: 2020 2020 2020 2020 2020 6461 7461 3d6e            data=n
-00009480: 6577 5f64 6174 612c 0a20 2020 2020 2020  ew_data,.       
-00009490: 2020 2020 2064 696d 733d 7365 6c66 2e5f       dims=self._
-000094a0: 5f64 696d 732c 0a20 2020 2020 2020 2020  _dims,.         
-000094b0: 2020 2074 7261 6e73 666f 726d 6174 696f     transformatio
-000094c0: 6e3d 7365 6c66 2e74 7261 6e73 666f 726d  n=self.transform
-000094d0: 6174 696f 6e2c 0a20 2020 2020 2020 2020  ation,.         
-000094e0: 2020 2069 6e5f 6d65 6d6f 7279 3d73 656c     in_memory=sel
-000094f0: 662e 5f69 6e5f 6d65 6d6f 7279 2c0a 2020  f._in_memory,.  
-00009500: 2020 2020 2020 2020 2020 7469 746c 653d            title=
-00009510: 7365 6c66 2e74 6974 6c65 2c0a 2020 2020  self.title,.    
-00009520: 2020 2020 290a 0a20 2020 2064 6566 2061      )..    def a
-00009530: 7070 6c79 5f74 6872 6573 686f 6c64 5f72  pply_threshold_r
-00009540: 656d 6f76 616c 2873 656c 662c 2062 6f74  emoval(self, bot
-00009550: 746f 6d3d 4e6f 6e65 2c20 746f 703d 4e6f  tom=None, top=No
-00009560: 6e65 2c20 696e 6469 6365 733d 4e6f 6e65  ne, indices=None
-00009570: 2c20 5f64 6972 3d4e 6f6e 6529 3a0a 2020  , _dir=None):.  
-00009580: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00009590: 2020 4170 706c 6965 7320 626f 7474 6f6d    Applies bottom
-000095a0: 2074 6872 6573 686f 6c64 2074 6f20 4461   threshold to Da
-000095b0: 7461 2c20 616e 6420 7361 7665 7320 7468  ta, and saves th
-000095c0: 6520 6e65 7720 6461 7461 0a20 2020 2020  e new data.     
-000095d0: 2020 2069 6e74 6f20 6469 736b 2e0a 0a20     into disk... 
-000095e0: 2020 2020 2020 203a 7061 7261 6d20 696e         :param in
-000095f0: 7420 626f 7474 6f6d 3a20 626f 7474 6f6d  t bottom: bottom
-00009600: 2074 6872 6573 686f 6c64 2074 6f20 6170   threshold to ap
-00009610: 706c 792e 0a20 2020 2020 2020 203a 7061  ply..        :pa
-00009620: 7261 6d20 696e 7420 746f 703a 2074 6f70  ram int top: top
-00009630: 2074 6872 6573 686f 6c64 2074 6f20 6170   threshold to ap
-00009640: 706c 792e 0a20 2020 2020 2020 203a 7061  ply..        :pa
-00009650: 7261 6d20 696e 6469 6365 733a 2049 6e64  ram indices: Ind
-00009660: 6963 6573 206f 6620 7468 6520 696d 6167  ices of the imag
-00009670: 6573 2074 6f20 6170 706c 7920 6261 636b  es to apply back
-00009680: 6772 6f75 6e64 2073 7562 7472 6163 7469  ground subtracti
-00009690: 6f6e 2e0a 2020 2020 2020 2020 2020 2020  on..            
-000096a0: 4966 204e 6f6e 652c 2074 6865 2068 6f74  If None, the hot
-000096b0: 2070 6978 656c 2072 656d 6f76 616c 2069   pixel removal i
-000096c0: 7320 6170 706c 6965 6420 746f 2061 6c6c  s applied to all
-000096d0: 2074 6865 2064 6174 612e 0a20 2020 2020   the data..     
-000096e0: 2020 203a 7479 7065 2069 6e64 6963 6573     :type indices
-000096f0: 3a20 556e 696f 6e5b 4e6f 6e65 2c20 6172  : Union[None, ar
-00009700: 7261 795f 6c69 6b65 5d0a 2020 2020 2020  ray_like].      
-00009710: 2020 3a72 6574 7572 6e3a 2064 6174 6173    :return: datas
-00009720: 6574 2077 6974 6820 6461 7461 206f 6620  et with data of 
-00009730: 7361 6d65 2073 697a 6520 6173 2060 7365  same size as `se
-00009740: 6c66 2e64 6174 6160 2062 7574 2077 6974  lf.data` but wit
-00009750: 6820 7468 650a 2020 2020 2020 2020 2020  h the.          
-00009760: 2020 6d6f 6469 6669 6564 2069 6d61 6765    modified image
-00009770: 732e 2054 6865 2075 726c 7320 6f66 2074  s. The urls of t
-00009780: 6865 206d 6f64 6966 6965 6420 696d 6167  he modified imag
-00009790: 6573 2061 7265 2072 6570 6c61 6365 6420  es are replaced 
-000097a0: 7769 7468 0a20 2020 2020 2020 2020 2020  with.           
-000097b0: 2074 6865 206e 6577 2075 726c 732e 0a20   the new urls.. 
-000097c0: 2020 2020 2020 203a 7274 7970 653a 2044         :rtype: D
-000097d0: 6174 6173 6574 0a20 2020 2020 2020 2022  ataset.        "
-000097e0: 2222 0a0a 2020 2020 2020 2020 7365 6c66  ""..        self
-000097f0: 2e72 756e 6e69 6e67 5f64 6174 6120 3d20  .running_data = 
-00009800: 7365 6c66 2e67 6574 5f64 6174 6128 696e  self.get_data(in
-00009810: 6469 6365 7329 0a0a 2020 2020 2020 2020  dices)..        
-00009820: 5f64 6972 203d 2073 656c 662e 6469 7220  _dir = self.dir 
-00009830: 6966 205f 6469 7220 6973 204e 6f6e 6520  if _dir is None 
-00009840: 656c 7365 205f 6469 720a 0a20 2020 2020  else _dir..     
-00009850: 2020 206f 732e 6d61 6b65 6469 7273 285f     os.makedirs(_
-00009860: 6469 722c 2065 7869 7374 5f6f 6b3d 5472  dir, exist_ok=Tr
-00009870: 7565 290a 0a20 2020 2020 2020 2074 656d  ue)..        tem
-00009880: 705f 6469 7220 3d20 6f73 2e70 6174 682e  p_dir = os.path.
-00009890: 6a6f 696e 285f 6469 722c 2022 7465 6d70  join(_dir, "temp
-000098a0: 5f64 6972 2229 0a0a 2020 2020 2020 2020  _dir")..        
-000098b0: 6f73 2e6d 616b 6564 6972 7328 7465 6d70  os.makedirs(temp
-000098c0: 5f64 6972 2c20 6578 6973 745f 6f6b 3d54  _dir, exist_ok=T
-000098d0: 7275 6529 0a0a 2020 2020 2020 2020 6966  rue)..        if
-000098e0: 2073 656c 662e 5f69 6e5f 6d65 6d6f 7279   self._in_memory
-000098f0: 3a0a 2020 2020 2020 2020 2020 2020 6e65  :.            ne
-00009900: 775f 6461 7461 203d 2074 6872 6573 686f  w_data = thresho
-00009910: 6c64 5f72 656d 6f76 616c 2873 656c 662e  ld_removal(self.
-00009920: 7275 6e6e 696e 675f 6461 7461 2c20 626f  running_data, bo
-00009930: 7474 6f6d 2c20 746f 7029 2e76 6965 7728  ttom, top).view(
-00009940: 4461 7461 290a 2020 2020 2020 2020 2020  Data).          
-00009950: 2020 6e65 775f 6461 7461 2e73 6176 6528    new_data.save(
-00009960: 6f73 2e70 6174 682e 6a6f 696e 2874 656d  os.path.join(tem
-00009970: 705f 6469 722c 2022 6461 7461 2e68 6466  p_dir, "data.hdf
-00009980: 3522 2929 0a20 2020 2020 2020 2020 2020  5")).           
-00009990: 2075 726c 7320 3d20 6e65 775f 6461 7461   urls = new_data
-000099a0: 2e75 726c 730a 2020 2020 2020 2020 656c  .urls.        el
-000099b0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000099c0: 7572 6c73 203d 2073 656c 662e 7275 6e6e  urls = self.runn
-000099d0: 696e 675f 6461 7461 2e61 7070 6c79 5f66  ing_data.apply_f
-000099e0: 756e 6373 280a 2020 2020 2020 2020 2020  uncs(.          
-000099f0: 2020 2020 2020 5b28 7468 7265 7368 6f6c        [(threshol
-00009a00: 645f 7265 6d6f 7661 6c2c 205b 626f 7474  d_removal, [bott
-00009a10: 6f6d 2c20 746f 705d 295d 2c0a 2020 2020  om, top])],.    
-00009a20: 2020 2020 2020 2020 2020 2020 7361 7665              save
-00009a30: 3d6f 732e 7061 7468 2e6a 6f69 6e28 7465  =os.path.join(te
-00009a40: 6d70 5f64 6972 2c20 2264 6174 612e 6864  mp_dir, "data.hd
-00009a50: 6635 2229 2c0a 2020 2020 2020 2020 2020  f5"),.          
-00009a60: 2020 2020 2020 7465 7874 3d22 4170 706c        text="Appl
-00009a70: 7969 6e67 2074 6872 6573 686f 6c64 222c  ying threshold",
-00009a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009a90: 206f 7065 7261 7469 6f6e 3d4f 7065 7261   operation=Opera
-00009aa0: 7469 6f6e 2e54 4852 4553 484f 4c44 2c0a  tion.THRESHOLD,.
-00009ab0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00009ac0: 2020 2020 2020 2020 2020 6966 2075 726c            if url
-00009ad0: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-00009ae0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00009af0: 6e0a 2020 2020 2020 2020 6966 2069 6e64  n.        if ind
-00009b00: 6963 6573 2069 7320 6e6f 7420 4e6f 6e65  ices is not None
-00009b10: 3a0a 2020 2020 2020 2020 2020 2020 6e65  :.            ne
-00009b20: 775f 7572 6c73 203d 206e 756d 7079 2e61  w_urls = numpy.a
-00009b30: 7272 6179 2873 656c 662e 6765 745f 6461  rray(self.get_da
-00009b40: 7461 2829 2e75 726c 732c 2064 7479 7065  ta().urls, dtype
-00009b50: 3d6f 626a 6563 7429 0a20 2020 2020 2020  =object).       
-00009b60: 2020 2020 206e 6577 5f75 726c 735b 696e       new_urls[in
-00009b70: 6469 6365 735d 203d 2075 726c 730a 2020  dices] = urls.  
-00009b80: 2020 2020 2020 2020 2020 6e65 775f 6461            new_da
-00009b90: 7461 203d 2044 6174 6128 0a20 2020 2020  ta = Data(.     
-00009ba0: 2020 2020 2020 2020 2020 206e 6577 5f75             new_u
-00009bb0: 726c 732e 7265 7368 6170 6528 7365 6c66  rls.reshape(self
-00009bc0: 2e64 6174 612e 7572 6c73 2e73 6861 7065  .data.urls.shape
-00009bd0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00009be0: 2020 2073 656c 662e 6461 7461 2e6d 6574     self.data.met
-00009bf0: 6164 6174 612c 0a20 2020 2020 2020 2020  adata,.         
-00009c00: 2020 2020 2020 2073 656c 662e 5f69 6e5f         self._in_
-00009c10: 6d65 6d6f 7279 2c0a 2020 2020 2020 2020  memory,.        
-00009c20: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
-00009c30: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00009c40: 6e65 775f 6461 7461 203d 2044 6174 6128  new_data = Data(
-00009c50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009c60: 2075 726c 732e 7265 7368 6170 6528 7365   urls.reshape(se
-00009c70: 6c66 2e64 6174 612e 7572 6c73 2e73 6861  lf.data.urls.sha
-00009c80: 7065 292c 2073 656c 662e 6461 7461 2e6d  pe), self.data.m
-00009c90: 6574 6164 6174 612c 2073 656c 662e 5f69  etadata, self._i
-00009ca0: 6e5f 6d65 6d6f 7279 0a20 2020 2020 2020  n_memory.       
-00009cb0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00009cc0: 6e65 775f 6461 7461 2e73 6176 6528 6f73  new_data.save(os
-00009cd0: 2e70 6174 682e 6a6f 696e 285f 6469 722c  .path.join(_dir,
-00009ce0: 2022 6461 7461 2e68 6466 3522 292c 2069   "data.hdf5"), i
-00009cf0: 6e64 6963 6573 3d69 6e64 6963 6573 290a  ndices=indices).
-00009d00: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00009d10: 2020 2020 2020 2020 206f 732e 7265 6d6f           os.remo
-00009d20: 7665 286f 732e 7061 7468 2e6a 6f69 6e28  ve(os.path.join(
-00009d30: 7465 6d70 5f64 6972 2c20 2264 6174 612e  temp_dir, "data.
-00009d40: 6864 6635 2229 290a 2020 2020 2020 2020  hdf5")).        
-00009d50: 2020 2020 6f73 2e72 6d64 6972 2874 656d      os.rmdir(tem
-00009d60: 705f 6469 7229 0a20 2020 2020 2020 2065  p_dir).        e
-00009d70: 7863 6570 7420 4f53 4572 726f 7220 6173  xcept OSError as
-00009d80: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00009d90: 5f6c 6f67 6765 722e 7761 726e 696e 6728  _logger.warning(
-00009da0: 2245 7272 6f72 3a20 2573 2220 2520 2865  "Error: %s" % (e
-00009db0: 2e73 7472 6572 726f 7229 290a 0a20 2020  .strerror))..   
-00009dc0: 2020 2020 2072 6574 7572 6e20 4461 7461       return Data
-00009dd0: 7365 7428 0a20 2020 2020 2020 2020 2020  set(.           
-00009de0: 205f 6469 723d 5f64 6972 2c0a 2020 2020   _dir=_dir,.    
-00009df0: 2020 2020 2020 2020 6461 7461 3d6e 6577          data=new
-00009e00: 5f64 6174 612c 0a20 2020 2020 2020 2020  _data,.         
-00009e10: 2020 2064 696d 733d 7365 6c66 2e5f 5f64     dims=self.__d
-00009e20: 696d 732c 0a20 2020 2020 2020 2020 2020  ims,.           
-00009e30: 2074 7261 6e73 666f 726d 6174 696f 6e3d   transformation=
-00009e40: 7365 6c66 2e74 7261 6e73 666f 726d 6174  self.transformat
-00009e50: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
-00009e60: 2069 6e5f 6d65 6d6f 7279 3d73 656c 662e   in_memory=self.
-00009e70: 5f69 6e5f 6d65 6d6f 7279 2c0a 2020 2020  _in_memory,.    
-00009e80: 2020 2020 2020 2020 7469 746c 653d 7365          title=se
-00009e90: 6c66 2e74 6974 6c65 2c0a 2020 2020 2020  lf.title,.      
-00009ea0: 2020 290a 0a20 2020 2064 6566 2061 7070    )..    def app
-00009eb0: 6c79 5f6d 6173 6b5f 7265 6d6f 7661 6c28  ly_mask_removal(
-00009ec0: 7365 6c66 2c20 6d61 736b 2c20 696e 6469  self, mask, indi
-00009ed0: 6365 733d 4e6f 6e65 2c20 5f64 6972 3d4e  ces=None, _dir=N
-00009ee0: 6f6e 6529 3a0a 2020 2020 2020 2020 2222  one):.        ""
-00009ef0: 220a 2020 2020 2020 2020 4170 706c 6965  ".        Applie
-00009f00: 7320 6d61 736b 2074 6f20 4461 7461 2c20  s mask to Data, 
-00009f10: 616e 6420 7361 7665 7320 7468 6520 6e65  and saves the ne
-00009f20: 7720 6461 7461 2069 6e74 6f20 6469 736b  w data into disk
-00009f30: 2e0a 0a20 2020 2020 2020 203a 7061 7261  ...        :para
-00009f40: 6d20 6e64 2e61 7272 6179 206d 6173 6b3a  m nd.array mask:
-00009f50: 204d 6173 6b20 746f 2061 7070 6c79 2077   Mask to apply w
-00009f60: 6974 6820 3027 7320 6f6e 2074 6865 206d  ith 0's on the m
-00009f70: 6173 6b2e 0a20 2020 2020 2020 203a 7061  ask..        :pa
-00009f80: 7261 6d20 696e 6469 6365 733a 2049 6e64  ram indices: Ind
-00009f90: 6963 6573 206f 6620 7468 6520 696d 6167  ices of the imag
-00009fa0: 6573 2074 6f20 6170 706c 7920 6261 636b  es to apply back
-00009fb0: 6772 6f75 6e64 2073 7562 7472 6163 7469  ground subtracti
-00009fc0: 6f6e 2e0a 2020 2020 2020 2020 2020 2020  on..            
-00009fd0: 4966 204e 6f6e 652c 2074 6865 2068 6f74  If None, the hot
-00009fe0: 2070 6978 656c 2072 656d 6f76 616c 2069   pixel removal i
-00009ff0: 7320 6170 706c 6965 6420 746f 2061 6c6c  s applied to all
-0000a000: 2074 6865 2064 6174 612e 0a20 2020 2020   the data..     
-0000a010: 2020 203a 7479 7065 2069 6e64 6963 6573     :type indices
-0000a020: 3a20 556e 696f 6e5b 4e6f 6e65 2c20 6172  : Union[None, ar
-0000a030: 7261 795f 6c69 6b65 5d0a 2020 2020 2020  ray_like].      
-0000a040: 2020 3a72 6574 7572 6e3a 2064 6174 6173    :return: datas
-0000a050: 6574 2077 6974 6820 6461 7461 206f 6620  et with data of 
-0000a060: 7361 6d65 2073 697a 6520 6173 2060 7365  same size as `se
-0000a070: 6c66 2e64 6174 6160 2062 7574 2077 6974  lf.data` but wit
-0000a080: 6820 7468 650a 2020 2020 2020 2020 2020  h the.          
-0000a090: 2020 6d6f 6469 6669 6564 2069 6d61 6765    modified image
-0000a0a0: 732e 2054 6865 2075 726c 7320 6f66 2074  s. The urls of t
-0000a0b0: 6865 206d 6f64 6966 6965 6420 696d 6167  he modified imag
-0000a0c0: 6573 2061 7265 2072 6570 6c61 6365 6420  es are replaced 
-0000a0d0: 7769 7468 0a20 2020 2020 2020 2020 2020  with.           
-0000a0e0: 2074 6865 206e 6577 2075 726c 732e 0a20   the new urls.. 
-0000a0f0: 2020 2020 2020 203a 7274 7970 653a 2044         :rtype: D
-0000a100: 6174 6173 6574 0a20 2020 2020 2020 2022  ataset.        "
-0000a110: 2222 0a0a 2020 2020 2020 2020 6966 206e  ""..        if n
-0000a120: 6f74 206e 756d 7079 2e61 6e79 286d 6173  ot numpy.any(mas
-0000a130: 6b29 3a0a 2020 2020 2020 2020 2020 2020  k):.            
-0000a140: 7265 7475 726e 2073 656c 660a 0a20 2020  return self..   
-0000a150: 2020 2020 2073 656c 662e 7275 6e6e 696e       self.runnin
-0000a160: 675f 6461 7461 203d 2073 656c 662e 6765  g_data = self.ge
-0000a170: 745f 6461 7461 2869 6e64 6963 6573 290a  t_data(indices).
-0000a180: 0a20 2020 2020 2020 205f 6469 7220 3d20  .        _dir = 
-0000a190: 7365 6c66 2e64 6972 2069 6620 5f64 6972  self.dir if _dir
-0000a1a0: 2069 7320 4e6f 6e65 2065 6c73 6520 5f64   is None else _d
-0000a1b0: 6972 0a0a 2020 2020 2020 2020 6f73 2e6d  ir..        os.m
-0000a1c0: 616b 6564 6972 7328 5f64 6972 2c20 6578  akedirs(_dir, ex
-0000a1d0: 6973 745f 6f6b 3d54 7275 6529 0a0a 2020  ist_ok=True)..  
-0000a1e0: 2020 2020 2020 7465 6d70 5f64 6972 203d        temp_dir =
-0000a1f0: 206f 732e 7061 7468 2e6a 6f69 6e28 5f64   os.path.join(_d
-0000a200: 6972 2c20 2274 656d 705f 6469 7222 290a  ir, "temp_dir").
-0000a210: 0a20 2020 2020 2020 206f 732e 6d61 6b65  .        os.make
-0000a220: 6469 7273 2874 656d 705f 6469 722c 2065  dirs(temp_dir, e
-0000a230: 7869 7374 5f6f 6b3d 5472 7565 290a 0a20  xist_ok=True).. 
-0000a240: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
-0000a250: 696e 5f6d 656d 6f72 793a 0a20 2020 2020  in_memory:.     
-0000a260: 2020 2020 2020 206e 6577 5f64 6174 6120         new_data 
-0000a270: 3d20 6d61 736b 5f72 656d 6f76 616c 2873  = mask_removal(s
-0000a280: 656c 662e 7275 6e6e 696e 675f 6461 7461  elf.running_data
-0000a290: 2c20 6d61 736b 292e 7669 6577 2844 6174  , mask).view(Dat
-0000a2a0: 6129 0a20 2020 2020 2020 2020 2020 206e  a).            n
-0000a2b0: 6577 5f64 6174 612e 7361 7665 286f 732e  ew_data.save(os.
-0000a2c0: 7061 7468 2e6a 6f69 6e28 7465 6d70 5f64  path.join(temp_d
-0000a2d0: 6972 2c20 2264 6174 612e 6864 6635 2229  ir, "data.hdf5")
-0000a2e0: 290a 2020 2020 2020 2020 2020 2020 7572  ).            ur
-0000a2f0: 6c73 203d 206e 6577 5f64 6174 612e 7572  ls = new_data.ur
-0000a300: 6c73 0a20 2020 2020 2020 2065 6c73 653a  ls.        else:
-0000a310: 0a20 2020 2020 2020 2020 2020 2075 726c  .            url
-0000a320: 7320 3d20 7365 6c66 2e72 756e 6e69 6e67  s = self.running
-0000a330: 5f64 6174 612e 6170 706c 795f 6675 6e63  _data.apply_func
-0000a340: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-0000a350: 2020 205b 286d 6173 6b5f 7265 6d6f 7661     [(mask_remova
-0000a360: 6c2c 205b 6d61 736b 5d29 5d2c 0a20 2020  l, [mask])],.   
-0000a370: 2020 2020 2020 2020 2020 2020 2073 6176               sav
-0000a380: 653d 6f73 2e70 6174 682e 6a6f 696e 2874  e=os.path.join(t
-0000a390: 656d 705f 6469 722c 2022 6461 7461 2e68  emp_dir, "data.h
-0000a3a0: 6466 3522 292c 0a20 2020 2020 2020 2020  df5"),.         
-0000a3b0: 2020 2020 2020 2074 6578 743d 2252 656d         text="Rem
-0000a3c0: 6f76 696e 6720 6d61 736b 222c 0a20 2020  oving mask",.   
-0000a3d0: 2020 2020 2020 2020 2020 2020 206f 7065               ope
-0000a3e0: 7261 7469 6f6e 3d4f 7065 7261 7469 6f6e  ration=Operation
-0000a3f0: 2e4d 4153 4b2c 0a20 2020 2020 2020 2020  .MASK,.         
-0000a400: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0000a410: 2069 6620 7572 6c73 2069 7320 4e6f 6e65   if urls is None
-0000a420: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000a430: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
-0000a440: 2069 6620 696e 6469 6365 7320 6973 206e   if indices is n
-0000a450: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0000a460: 2020 2020 206e 6577 5f75 726c 7320 3d20       new_urls = 
-0000a470: 6e75 6d70 792e 6172 7261 7928 7365 6c66  numpy.array(self
-0000a480: 2e67 6574 5f64 6174 6128 292e 7572 6c73  .get_data().urls
-0000a490: 2c20 6474 7970 653d 6f62 6a65 6374 290a  , dtype=object).
-0000a4a0: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
-0000a4b0: 7572 6c73 5b69 6e64 6963 6573 5d20 3d20  urls[indices] = 
-0000a4c0: 7572 6c73 0a20 2020 2020 2020 2020 2020  urls.           
-0000a4d0: 206e 6577 5f64 6174 6120 3d20 4461 7461   new_data = Data
-0000a4e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000a4f0: 2020 6e65 775f 7572 6c73 2e72 6573 6861    new_urls.resha
-0000a500: 7065 2873 656c 662e 6461 7461 2e75 726c  pe(self.data.url
-0000a510: 732e 7368 6170 6529 2c0a 2020 2020 2020  s.shape),.      
-0000a520: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
-0000a530: 6174 612e 6d65 7461 6461 7461 2c0a 2020  ata.metadata,.  
-0000a540: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0000a550: 6c66 2e5f 696e 5f6d 656d 6f72 792c 0a20  lf._in_memory,. 
-0000a560: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0000a570: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000a580: 2020 2020 2020 206e 6577 5f64 6174 6120         new_data 
-0000a590: 3d20 4461 7461 280a 2020 2020 2020 2020  = Data(.        
-0000a5a0: 2020 2020 2020 2020 7572 6c73 2e72 6573          urls.res
-0000a5b0: 6861 7065 2873 656c 662e 6461 7461 2e75  hape(self.data.u
-0000a5c0: 726c 732e 7368 6170 6529 2c20 7365 6c66  rls.shape), self
-0000a5d0: 2e64 6174 612e 6d65 7461 6461 7461 2c20  .data.metadata, 
-0000a5e0: 7365 6c66 2e5f 696e 5f6d 656d 6f72 790a  self._in_memory.
-0000a5f0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0000a600: 2020 2020 2020 206e 6577 5f64 6174 612e         new_data.
-0000a610: 7361 7665 286f 732e 7061 7468 2e6a 6f69  save(os.path.joi
-0000a620: 6e28 5f64 6972 2c20 2264 6174 612e 6864  n(_dir, "data.hd
-0000a630: 6635 2229 2c20 696e 6469 6365 733d 696e  f5"), indices=in
-0000a640: 6469 6365 7329 0a20 2020 2020 2020 2074  dices).        t
-0000a650: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000a660: 6f73 2e72 656d 6f76 6528 6f73 2e70 6174  os.remove(os.pat
-0000a670: 682e 6a6f 696e 2874 656d 705f 6469 722c  h.join(temp_dir,
-0000a680: 2022 6461 7461 2e68 6466 3522 2929 0a20   "data.hdf5")). 
-0000a690: 2020 2020 2020 2020 2020 206f 732e 726d             os.rm
-0000a6a0: 6469 7228 7465 6d70 5f64 6972 290a 2020  dir(temp_dir).  
-0000a6b0: 2020 2020 2020 6578 6365 7074 204f 5345        except OSE
-0000a6c0: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
-0000a6d0: 2020 2020 2020 205f 6c6f 6767 6572 2e77         _logger.w
-0000a6e0: 6172 6e69 6e67 2822 4572 726f 723a 2025  arning("Error: %
-0000a6f0: 7322 2025 2028 652e 7374 7265 7272 6f72  s" % (e.strerror
-0000a700: 2929 0a0a 2020 2020 2020 2020 7265 7475  ))..        retu
-0000a710: 726e 2044 6174 6173 6574 280a 2020 2020  rn Dataset(.    
-0000a720: 2020 2020 2020 2020 5f64 6972 3d5f 6469          _dir=_di
-0000a730: 722c 0a20 2020 2020 2020 2020 2020 2064  r,.            d
-0000a740: 6174 613d 6e65 775f 6461 7461 2c0a 2020  ata=new_data,.  
-0000a750: 2020 2020 2020 2020 2020 6469 6d73 3d73            dims=s
-0000a760: 656c 662e 5f5f 6469 6d73 2c0a 2020 2020  elf.__dims,.    
-0000a770: 2020 2020 2020 2020 7472 616e 7366 6f72          transfor
-0000a780: 6d61 7469 6f6e 3d73 656c 662e 7472 616e  mation=self.tran
-0000a790: 7366 6f72 6d61 7469 6f6e 2c0a 2020 2020  sformation,.    
-0000a7a0: 2020 2020 2020 2020 696e 5f6d 656d 6f72          in_memor
-0000a7b0: 793d 7365 6c66 2e5f 696e 5f6d 656d 6f72  y=self._in_memor
-0000a7c0: 792c 0a20 2020 2020 2020 2020 2020 2074  y,.            t
-0000a7d0: 6974 6c65 3d73 656c 662e 7469 746c 652c  itle=self.title,
-0000a7e0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0000a7f0: 6465 6620 6170 706c 795f 726f 6928 0a20  def apply_roi(. 
-0000a800: 2020 2020 2020 2073 656c 662c 206f 7269         self, ori
-0000a810: 6769 6e3d 4e6f 6e65 2c20 7369 7a65 3d4e  gin=None, size=N
-0000a820: 6f6e 652c 2063 656e 7465 723d 4e6f 6e65  one, center=None
-0000a830: 2c20 696e 6469 6365 733d 4e6f 6e65 2c20  , indices=None, 
-0000a840: 726f 695f 6469 723d 4e6f 6e65 0a20 2020  roi_dir=None.   
-0000a850: 2029 3a0a 2020 2020 2020 2020 2222 220a   ):.        """.
-0000a860: 2020 2020 2020 2020 4170 706c 6965 7320          Applies 
-0000a870: 6120 7265 6769 6f6e 206f 6620 696e 7465  a region of inte
-0000a880: 7265 7374 2074 6f20 7468 6520 6461 7461  rest to the data
-0000a890: 2e0a 0a20 2020 2020 2020 203a 7061 7261  ...        :para
-0000a8a0: 6d20 6f72 6967 696e 3a20 4f72 6967 696e  m origin: Origin
-0000a8b0: 206f 6620 7468 6520 726f 690a 2020 2020   of the roi.    
-0000a8c0: 2020 2020 3a70 6172 616d 2073 697a 653a      :param size:
-0000a8d0: 205b 4865 6967 6874 2c20 5769 6474 685d   [Height, Width]
-0000a8e0: 206f 6620 7468 6520 726f 692e 0a20 2020   of the roi..   
-0000a8f0: 2020 2020 203a 7061 7261 6d20 6365 6e74       :param cent
-0000a900: 6572 3a20 4365 6e74 6572 206f 6620 7468  er: Center of th
-0000a910: 6520 726f 690a 2020 2020 2020 2020 3a74  e roi.        :t
-0000a920: 7970 6520 6f72 6967 696e 3a20 556e 696f  ype origin: Unio
-0000a930: 6e5b 3264 2076 6563 746f 722c 204e 6f6e  n[2d vector, Non
-0000a940: 655d 0a20 2020 2020 2020 203a 7479 7065  e].        :type
-0000a950: 2063 656e 7465 723a 2055 6e69 6f6e 5b32   center: Union[2
-0000a960: 6420 7665 6374 6f72 2c20 4e6f 6e65 5d0a  d vector, None].
-0000a970: 2020 2020 2020 2020 3a74 7970 6520 7369          :type si
-0000a980: 7a65 3a20 556e 696f 6e5b 3264 2076 6563  ze: Union[2d vec
-0000a990: 746f 722c 204e 6f6e 655d 0a20 2020 2020  tor, None].     
-0000a9a0: 2020 203a 7061 7261 6d20 696e 6469 6365     :param indice
-0000a9b0: 733a 2049 6e64 6963 6573 206f 6620 7468  s: Indices of th
-0000a9c0: 6520 696d 6167 6573 2074 6f20 6170 706c  e images to appl
-0000a9d0: 7920 6261 636b 6772 6f75 6e64 2073 7562  y background sub
-0000a9e0: 7472 6163 7469 6f6e 2e0a 2020 2020 2020  traction..      
-0000a9f0: 2020 2020 2020 4966 204e 6f6e 652c 2074        If None, t
-0000aa00: 6865 2072 6f69 2069 7320 6170 706c 6965  he roi is applie
-0000aa10: 6420 746f 2061 6c6c 2074 6865 2064 6174  d to all the dat
-0000aa20: 612e 0a20 2020 2020 2020 203a 7479 7065  a..        :type
-0000aa30: 2069 6e64 6963 6573 3a20 556e 696f 6e5b   indices: Union[
-0000aa40: 4e6f 6e65 2c20 6172 7261 795f 6c69 6b65  None, array_like
-0000aa50: 5d0a 2020 2020 2020 2020 3a70 6172 616d  ].        :param
-0000aa60: 2072 6f69 5f64 6972 3a20 4469 7265 6374   roi_dir: Direct
-0000aa70: 6f72 7920 7061 7468 2066 6f72 2074 6865  ory path for the
-0000aa80: 206e 6577 2064 6174 6173 6574 0a20 2020   new dataset.   
-0000aa90: 2020 2020 203a 7479 7065 2072 6f69 5f64       :type roi_d
-0000aaa0: 6972 3a20 7374 720a 2020 2020 2020 2020  ir: str.        
-0000aab0: 3a72 6574 7572 6e73 3a20 6461 7461 7365  :returns: datase
-0000aac0: 7420 7769 7468 2064 6174 6120 7769 7468  t with data with
-0000aad0: 2072 6f69 2061 7070 6c69 6564 2e0a 2020   roi applied..  
-0000aae0: 2020 2020 2020 2020 2020 4e6f 7465 3a20            Note: 
-0000aaf0: 546f 2070 7265 7365 7276 6520 636f 6e73  To preserve cons
-0000ab00: 6973 7465 6e63 6520 6f66 2073 6861 7065  istence of shape
-0000ab10: 2062 6574 7765 656e 2069 6d61 6765 732c   between images,
-0000ab20: 2069 6620 6069 6e64 6963 6573 600a 2020   if `indices`.  
-0000ab30: 2020 2020 2020 2020 2020 6973 206e 6f74            is not
-0000ab40: 204e 6f6e 652c 206f 6e6c 7920 7468 6520   None, only the 
-0000ab50: 6461 7461 206d 6f64 6966 6965 6420 6973  data modified is
-0000ab60: 2072 6574 7572 6e65 642e 0a20 2020 2020   returned..     
-0000ab70: 2020 203a 7274 7970 653a 2044 6174 6173     :rtype: Datas
-0000ab80: 6574 0a20 2020 2020 2020 2022 2222 0a0a  et.        """..
-0000ab90: 2020 2020 2020 2020 726f 695f 6469 7220          roi_dir 
-0000aba0: 3d20 7365 6c66 2e64 6972 2069 6620 726f  = self.dir if ro
-0000abb0: 695f 6469 7220 6973 204e 6f6e 6520 656c  i_dir is None el
-0000abc0: 7365 2072 6f69 5f64 6972 0a20 2020 2020  se roi_dir.     
-0000abd0: 2020 206f 732e 6d61 6b65 6469 7273 2872     os.makedirs(r
-0000abe0: 6f69 5f64 6972 2c20 6578 6973 745f 6f6b  oi_dir, exist_ok
-0000abf0: 3d54 7275 6529 0a0a 2020 2020 2020 2020  =True)..        
-0000ac00: 7365 6c66 2e72 756e 6e69 6e67 5f64 6174  self.running_dat
-0000ac10: 6120 3d20 7365 6c66 2e67 6574 5f64 6174  a = self.get_dat
-0000ac20: 6128 696e 6469 6365 7329 0a20 2020 2020  a(indices).     
-0000ac30: 2020 2069 6620 7365 6c66 2e5f 696e 5f6d     if self._in_m
-0000ac40: 656d 6f72 793a 0a20 2020 2020 2020 2020  emory:.         
-0000ac50: 2020 206e 6577 5f64 6174 6120 3d20 280a     new_data = (.
-0000ac60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac70: 6170 706c 795f 3344 5f52 4f49 2873 656c  apply_3D_ROI(sel
-0000ac80: 662e 7275 6e6e 696e 675f 6461 7461 2c20  f.running_data, 
-0000ac90: 6f72 6967 696e 2c20 7369 7a65 2c20 6365  origin, size, ce
-0000aca0: 6e74 6572 292e 7669 6577 2844 6174 6129  nter).view(Data)
-0000acb0: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
-0000acc0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0000acd0: 2020 6e65 775f 6461 7461 2e73 6176 6528    new_data.save(
-0000ace0: 6f73 2e70 6174 682e 6a6f 696e 2872 6f69  os.path.join(roi
-0000acf0: 5f64 6972 2c20 2264 6174 612e 6864 6635  _dir, "data.hdf5
-0000ad00: 2229 2c20 6e65 775f 7368 6170 653d 6e65  "), new_shape=ne
-0000ad10: 775f 6461 7461 2e73 6861 7065 290a 2020  w_data.shape).  
-0000ad20: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0000ad30: 2020 2020 2020 2020 7368 6170 6520 3d20          shape = 
-0000ad40: 6e75 6d70 792e 6170 7065 6e64 280a 2020  numpy.append(.  
-0000ad50: 2020 2020 2020 2020 2020 2020 2020 5b73                [s
-0000ad60: 656c 662e 7275 6e6e 696e 675f 6461 7461  elf.running_data
-0000ad70: 2e73 6861 7065 5b30 5d5d 2c0a 2020 2020  .shape[0]],.    
-0000ad80: 2020 2020 2020 2020 2020 2020 6170 706c              appl
-0000ad90: 795f 3244 5f52 4f49 2873 656c 662e 7275  y_2D_ROI(self.ru
-0000ada0: 6e6e 696e 675f 6461 7461 5b30 5d2c 206f  nning_data[0], o
-0000adb0: 7269 6769 6e2c 2073 697a 652c 2063 656e  rigin, size, cen
-0000adc0: 7465 7229 2e73 6861 7065 2c0a 2020 2020  ter).shape,.    
-0000add0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000ade0: 2020 2020 2020 7572 6c73 203d 2073 656c        urls = sel
-0000adf0: 662e 7275 6e6e 696e 675f 6461 7461 2e61  f.running_data.a
-0000ae00: 7070 6c79 5f66 756e 6373 280a 2020 2020  pply_funcs(.    
-0000ae10: 2020 2020 2020 2020 2020 2020 5b28 6170              [(ap
-0000ae20: 706c 795f 3244 5f52 4f49 2c20 5b6f 7269  ply_2D_ROI, [ori
-0000ae30: 6769 6e2c 2073 697a 652c 2063 656e 7465  gin, size, cente
-0000ae40: 725d 295d 2c0a 2020 2020 2020 2020 2020  r])],.          
-0000ae50: 2020 2020 2020 7361 7665 3d6f 732e 7061        save=os.pa
-0000ae60: 7468 2e6a 6f69 6e28 726f 695f 6469 722c  th.join(roi_dir,
-0000ae70: 2022 6461 7461 2e68 6466 3522 292c 0a20   "data.hdf5"),. 
-0000ae80: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000ae90: 6578 743d 2241 7070 6c79 696e 6720 726f  ext="Applying ro
-0000aea0: 6922 2c0a 2020 2020 2020 2020 2020 2020  i",.            
-0000aeb0: 2020 2020 6f70 6572 6174 696f 6e3d 4f70      operation=Op
-0000aec0: 6572 6174 696f 6e2e 524f 492c 0a20 2020  eration.ROI,.   
-0000aed0: 2020 2020 2020 2020 2020 2020 206e 6577               new
-0000aee0: 5f73 6861 7065 3d73 6861 7065 2c0a 2020  _shape=shape,.  
-0000aef0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000af00: 2020 2020 2020 2020 6966 2075 726c 7320          if urls 
-0000af10: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0000af20: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-0000af30: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
-0000af40: 6461 7461 203d 2044 6174 6128 7572 6c73  data = Data(urls
-0000af50: 2c20 7365 6c66 2e72 756e 6e69 6e67 5f64  , self.running_d
-0000af60: 6174 612e 6d65 7461 6461 7461 2c20 7365  ata.metadata, se
-0000af70: 6c66 2e5f 696e 5f6d 656d 6f72 7929 0a0a  lf._in_memory)..
-0000af80: 2020 2020 2020 2020 7472 616e 7366 6f72          transfor
-0000af90: 6d61 7469 6f6e 203d 2073 656c 662e 7472  mation = self.tr
-0000afa0: 616e 7366 6f72 6d61 7469 6f6e 0a20 2020  ansformation.   
-0000afb0: 2020 2020 2069 6620 7472 616e 7366 6f72       if transfor
-0000afc0: 6d61 7469 6f6e 2069 7320 6e6f 7420 4e6f  mation is not No
-0000afd0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0000afe0: 7472 616e 7366 6f72 6d61 7469 6f6e 203d  transformation =
-0000aff0: 2054 7261 6e73 666f 726d 6174 696f 6e28   Transformation(
-0000b000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b010: 2074 7261 6e73 666f 726d 6174 696f 6e2e   transformation.
-0000b020: 6b69 6e64 2c0a 2020 2020 2020 2020 2020  kind,.          
-0000b030: 2020 2020 2020 6170 706c 795f 3244 5f52        apply_2D_R
-0000b040: 4f49 2874 7261 6e73 666f 726d 6174 696f  OI(transformatio
-0000b050: 6e2e 782c 206f 7269 6769 6e2c 2073 697a  n.x, origin, siz
-0000b060: 652c 2063 656e 7465 7229 2c0a 2020 2020  e, center),.    
-0000b070: 2020 2020 2020 2020 2020 2020 6170 706c              appl
-0000b080: 795f 3244 5f52 4f49 2874 7261 6e73 666f  y_2D_ROI(transfo
-0000b090: 726d 6174 696f 6e2e 792c 206f 7269 6769  rmation.y, origi
-0000b0a0: 6e2c 2073 697a 652c 2063 656e 7465 7229  n, size, center)
-0000b0b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000b0c0: 2020 7472 616e 7366 6f72 6d61 7469 6f6e    transformation
-0000b0d0: 2e72 6f74 6174 652c 0a20 2020 2020 2020  .rotate,.       
-0000b0e0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0000b0f0: 6966 2069 6e64 6963 6573 2069 7320 4e6f  if indices is No
-0000b100: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0000b110: 7368 6170 6520 3d20 6c69 7374 2873 656c  shape = list(sel
-0000b120: 662e 6461 7461 2e73 6861 7065 295b 3a2d  f.data.shape)[:-
-0000b130: 325d 0a20 2020 2020 2020 2020 2020 2073  2].            s
-0000b140: 6861 7065 2e61 7070 656e 6428 6e65 775f  hape.append(new_
-0000b150: 6461 7461 2e73 6861 7065 5b2d 325d 290a  data.shape[-2]).
-0000b160: 2020 2020 2020 2020 2020 2020 7368 6170              shap
-0000b170: 652e 6170 7065 6e64 286e 6577 5f64 6174  e.append(new_dat
-0000b180: 612e 7368 6170 655b 2d31 5d29 0a20 2020  a.shape[-1]).   
-0000b190: 2020 2020 2020 2020 206e 6577 5f64 6174           new_dat
-0000b1a0: 6120 3d20 6e65 775f 6461 7461 2e72 6573  a = new_data.res
-0000b1b0: 6861 7065 2873 6861 7065 290a 2020 2020  hape(shape).    
-0000b1c0: 2020 2020 7265 7475 726e 2044 6174 6173      return Datas
-0000b1d0: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
-0000b1e0: 5f64 6972 3d72 6f69 5f64 6972 2c0a 2020  _dir=roi_dir,.  
-0000b1f0: 2020 2020 2020 2020 2020 6461 7461 3d6e            data=n
-0000b200: 6577 5f64 6174 612c 0a20 2020 2020 2020  ew_data,.       
-0000b210: 2020 2020 2064 696d 733d 7365 6c66 2e5f       dims=self._
-0000b220: 5f64 696d 732c 0a20 2020 2020 2020 2020  _dims,.         
-0000b230: 2020 2074 7261 6e73 666f 726d 6174 696f     transformatio
-0000b240: 6e3d 7472 616e 7366 6f72 6d61 7469 6f6e  n=transformation
-0000b250: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
-0000b260: 5f6d 656d 6f72 793d 7365 6c66 2e5f 696e  _memory=self._in
-0000b270: 5f6d 656d 6f72 792c 0a20 2020 2020 2020  _memory,.       
-0000b280: 2020 2020 2074 6974 6c65 3d73 656c 662e       title=self.
-0000b290: 7469 746c 652c 0a20 2020 2020 2020 2029  title,.        )
-0000b2a0: 0a0a 2020 2020 6465 6620 6669 6e64 5f73  ..    def find_s
-0000b2b0: 6869 6674 2873 656c 662c 2064 696d 656e  hift(self, dimen
-0000b2c0: 7369 6f6e 3d4e 6f6e 652c 2073 7465 7073  sion=None, steps
-0000b2d0: 3d35 302c 2069 6e64 6963 6573 3d4e 6f6e  =50, indices=Non
-0000b2e0: 6529 3a0a 2020 2020 2020 2020 2222 220a  e):.        """.
-0000b2f0: 2020 2020 2020 2020 4669 6e64 2073 6869          Find shi
-0000b300: 6674 206f 6620 7468 6520 6461 7461 206f  ft of the data o
-0000b310: 7220 7061 7274 206f 6620 6974 2e0a 0a20  r part of it... 
-0000b320: 2020 2020 2020 203a 7061 7261 6d20 6469         :param di
-0000b330: 6d65 6e73 696f 6e3a 2050 6172 616d 6574  mension: Paramet
-0000b340: 6572 7320 7769 7468 2074 6865 2070 6f73  ers with the pos
-0000b350: 6974 696f 6e20 6f66 2074 6865 2064 6174  ition of the dat
-0000b360: 6120 696e 2074 6865 2072 6573 6861 7065  a in the reshape
-0000b370: 640a 2020 2020 2020 2020 2020 2020 6172  d.            ar
-0000b380: 7261 792e 0a20 2020 2020 2020 203a 7479  ray..        :ty
-0000b390: 7065 2064 696d 656e 7369 6f6e 3a20 556e  pe dimension: Un
-0000b3a0: 696f 6e5b 4e6f 6e65 2c20 7475 706c 652c  ion[None, tuple,
-0000b3b0: 2061 7272 6179 5f6c 696b 655d 0a20 2020   array_like].   
-0000b3c0: 2020 2020 203a 7061 7261 6d20 666c 6f61       :param floa
-0000b3d0: 7420 685f 6d61 783a 2053 6565 2060 636f  t h_max: See `co
-0000b3e0: 7265 2e69 6d61 6765 5265 6769 7374 7261  re.imageRegistra
-0000b3f0: 7469 6f6e 2e73 6869 6674 5f64 6574 6563  tion.shift_detec
-0000b400: 7469 6f6e 600a 2020 2020 2020 2020 3a70  tion`.        :p
-0000b410: 6172 616d 2066 6c6f 6174 2068 5f73 7465  aram float h_ste
-0000b420: 703a 2053 6565 2060 636f 7265 2e69 6d61  p: See `core.ima
-0000b430: 6765 5265 6769 7374 7261 7469 6f6e 2e73  geRegistration.s
-0000b440: 6869 6674 5f64 6574 6563 7469 6f6e 600a  hift_detection`.
-0000b450: 2020 2020 2020 2020 3a70 6172 616d 2069          :param i
-0000b460: 6e64 6963 6573 3a20 426f 6f6c 6561 6e20  ndices: Boolean 
-0000b470: 696e 6465 7820 6c69 7374 2077 6974 6820  index list with 
-0000b480: 5472 7565 2069 6e20 7468 6520 696d 6167  True in the imag
-0000b490: 6573 2074 6f20 6170 706c 7920 7468 6520  es to apply the 
-0000b4a0: 7368 6966 7420 746f 2e0a 2020 2020 2020  shift to..      
-0000b4b0: 2020 2020 2020 4966 204e 6f6e 652c 2074        If None, t
-0000b4c0: 6865 2068 6f74 2070 6978 656c 2072 656d  he hot pixel rem
-0000b4d0: 6f76 616c 2069 7320 6170 706c 6965 6420  oval is applied 
-0000b4e0: 746f 2061 6c6c 2074 6865 2064 6174 612e  to all the data.
-0000b4f0: 0a20 2020 2020 2020 203a 7479 7065 2069  .        :type i
-0000b500: 6e64 6963 6573 3a20 556e 696f 6e5b 4e6f  ndices: Union[No
-0000b510: 6e65 2c20 6172 7261 795f 6c69 6b65 5d0a  ne, array_like].
-0000b520: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
-0000b530: 3a20 4172 7261 7920 7769 7468 2073 6869  : Array with shi
-0000b540: 6674 2070 6572 2066 7261 6d65 2e0a 2020  ft per frame..  
-0000b550: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0000b560: 2020 6461 7461 203d 2073 656c 662e 6765    data = self.ge
-0000b570: 745f 6461 7461 2869 6e64 6963 6573 3d69  t_data(indices=i
-0000b580: 6e64 6963 6573 2c20 6469 6d65 6e73 696f  ndices, dimensio
-0000b590: 6e3d 6469 6d65 6e73 696f 6e29 0a20 2020  n=dimension).   
-0000b5a0: 2020 2020 2072 6574 7572 6e20 7368 6966       return shif
-0000b5b0: 745f 6465 7465 6374 696f 6e28 6461 7461  t_detection(data
-0000b5c0: 2c20 7374 6570 7329 0a0a 2020 2020 6465  , steps)..    de
-0000b5d0: 6620 6669 6e64 5f73 6869 6674 5f61 6c6f  f find_shift_alo
-0000b5e0: 6e67 5f64 696d 656e 7369 6f6e 2873 656c  ng_dimension(sel
-0000b5f0: 662c 2064 696d 656e 7369 6f6e 2c20 7374  f, dimension, st
-0000b600: 6570 733d 3530 2c20 696e 6469 6365 733d  eps=50, indices=
-0000b610: 4e6f 6e65 293a 0a20 2020 2020 2020 2073  None):.        s
-0000b620: 6869 6674 203d 205b 5d0a 2020 2020 2020  hift = [].      
-0000b630: 2020 666f 7220 7661 6c75 6520 696e 2072    for value in r
-0000b640: 616e 6765 2873 656c 662e 6469 6d73 2e67  ange(self.dims.g
-0000b650: 6574 2864 696d 656e 7369 6f6e 5b30 5d29  et(dimension[0])
-0000b660: 2e73 697a 6529 3a0a 2020 2020 2020 2020  .size):.        
-0000b670: 2020 2020 7368 6966 742e 6170 7065 6e64      shift.append
-0000b680: 2873 656c 662e 6669 6e64 5f73 6869 6674  (self.find_shift
-0000b690: 285b 6469 6d65 6e73 696f 6e5b 305d 2c20  ([dimension[0], 
-0000b6a0: 7661 6c75 655d 2c20 7374 6570 732c 2069  value], steps, i
-0000b6b0: 6e64 6963 6573 2929 0a20 2020 2020 2020  ndices)).       
-0000b6c0: 2072 6574 7572 6e20 6e75 6d70 792e 6172   return numpy.ar
-0000b6d0: 7261 7928 7368 6966 7429 0a0a 2020 2020  ray(shift)..    
-0000b6e0: 6465 6620 6170 706c 795f 7368 6966 745f  def apply_shift_
-0000b6f0: 616c 6f6e 675f 6469 6d65 6e73 696f 6e28  along_dimension(
-0000b700: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-0000b710: 2020 2020 2020 2073 6869 6674 2c0a 2020         shift,.  
-0000b720: 2020 2020 2020 6469 6d65 6e73 696f 6e2c        dimension,
-0000b730: 0a20 2020 2020 2020 2073 6869 6674 5f61  .        shift_a
-0000b740: 7070 726f 6163 683d 2266 6674 222c 0a20  pproach="fft",. 
-0000b750: 2020 2020 2020 2069 6e64 6963 6573 3d4e         indices=N
-0000b760: 6f6e 652c 0a20 2020 2020 2020 2063 616c  one,.        cal
-0000b770: 6c62 6163 6b3d 4e6f 6e65 2c0a 2020 2020  lback=None,.    
-0000b780: 2020 2020 5f64 6972 3d4e 6f6e 652c 0a20      _dir=None,. 
-0000b790: 2020 2029 3a0a 2020 2020 2020 2020 6461     ):.        da
-0000b7a0: 7461 7365 7420 3d20 7365 6c66 0a20 2020  taset = self.   
-0000b7b0: 2020 2020 2066 6f72 2076 616c 7565 2069       for value i
-0000b7c0: 6e20 7261 6e67 6528 7365 6c66 2e64 696d  n range(self.dim
-0000b7d0: 732e 6765 7428 6469 6d65 6e73 696f 6e5b  s.get(dimension[
-0000b7e0: 305d 292e 7369 7a65 293a 0a20 2020 2020  0]).size):.     
-0000b7f0: 2020 2020 2020 2064 6174 612c 2072 696e         data, rin
-0000b800: 6469 6365 7320 3d20 7365 6c66 2e67 6574  dices = self.get
-0000b810: 5f64 6174 6128 0a20 2020 2020 2020 2020  _data(.         
-0000b820: 2020 2020 2020 2069 6e64 6963 6573 3d69         indices=i
-0000b830: 6e64 6963 6573 2c20 6469 6d65 6e73 696f  ndices, dimensio
-0000b840: 6e3d 5b64 696d 656e 7369 6f6e 5b30 5d2c  n=[dimension[0],
-0000b850: 2076 616c 7565 5d2c 2072 6574 7572 6e5f   value], return_
-0000b860: 696e 6469 6365 733d 5472 7565 0a20 2020  indices=True.   
-0000b870: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0000b880: 2020 2020 2020 2066 7261 6d65 7320 3d20         frames = 
-0000b890: 6e75 6d70 792e 6172 616e 6765 280a 2020  numpy.arange(.  
-0000b8a0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0000b8b0: 6c66 2e67 6574 5f64 6174 6128 696e 6469  lf.get_data(indi
-0000b8c0: 6365 733d 696e 6469 6365 732c 2064 696d  ces=indices, dim
-0000b8d0: 656e 7369 6f6e 3d5b 6469 6d65 6e73 696f  ension=[dimensio
-0000b8e0: 6e5b 305d 2c20 7661 6c75 655d 292e 7368  n[0], value]).sh
-0000b8f0: 6170 655b 305d 0a20 2020 2020 2020 2020  ape[0].         
-0000b900: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0000b910: 2064 6174 6173 6574 203d 2064 6174 6173   dataset = datas
-0000b920: 6574 2e61 7070 6c79 5f73 6869 6674 280a  et.apply_shift(.
-0000b930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b940: 6e75 6d70 792e 6f75 7465 7228 7368 6966  numpy.outer(shif
-0000b950: 745b 7661 6c75 655d 2c20 6672 616d 6573  t[value], frames
-0000b960: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0000b970: 2020 205b 6469 6d65 6e73 696f 6e5b 305d     [dimension[0]
-0000b980: 2c20 7661 6c75 655d 2c0a 2020 2020 2020  , value],.      
-0000b990: 2020 2020 2020 2020 2020 7368 6966 745f            shift_
-0000b9a0: 6170 7072 6f61 6368 2c0a 2020 2020 2020  approach,.      
-0000b9b0: 2020 2020 2020 2020 2020 696e 6469 6365            indice
-0000b9c0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-0000b9d0: 2020 2063 616c 6c62 6163 6b2c 0a20 2020     callback,.   
-0000b9e0: 2020 2020 2020 2020 2020 2020 205f 6469               _di
-0000b9f0: 722c 0a20 2020 2020 2020 2020 2020 2029  r,.            )
-0000ba00: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-0000ba10: 2064 6174 6173 6574 0a0a 2020 2020 6465   dataset..    de
-0000ba20: 6620 6170 706c 795f 7368 6966 7428 0a20  f apply_shift(. 
-0000ba30: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-0000ba40: 2020 2020 2073 6869 6674 2c0a 2020 2020       shift,.    
-0000ba50: 2020 2020 6469 6d65 6e73 696f 6e3d 4e6f      dimension=No
-0000ba60: 6e65 2c0a 2020 2020 2020 2020 7368 6966  ne,.        shif
-0000ba70: 745f 6170 7072 6f61 6368 3d22 6666 7422  t_approach="fft"
-0000ba80: 2c0a 2020 2020 2020 2020 696e 6469 6365  ,.        indice
-0000ba90: 733d 4e6f 6e65 2c0a 2020 2020 2020 2020  s=None,.        
-0000baa0: 6361 6c6c 6261 636b 3d4e 6f6e 652c 0a20  callback=None,. 
-0000bab0: 2020 2020 2020 205f 6469 723d 4e6f 6e65         _dir=None
-0000bac0: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
-0000bad0: 2022 2222 0a20 2020 2020 2020 2041 7070   """.        App
-0000bae0: 6c79 2073 6869 6674 206f 6620 7468 6520  ly shift of the 
-0000baf0: 6461 7461 206f 7220 7061 7274 206f 6620  data or part of 
-0000bb00: 6974 2061 6e64 2073 6176 6520 6e65 7720  it and save new 
-0000bb10: 6461 7461 2069 6e74 6f20 6469 736b 2e0a  data into disk..
-0000bb20: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0000bb30: 6172 7261 795f 6c69 6b65 2073 6869 6674  array_like shift
-0000bb40: 3a20 5368 6966 7420 7065 7220 6672 616d  : Shift per fram
-0000bb50: 652e 0a20 2020 2020 2020 203a 7061 7261  e..        :para
-0000bb60: 6d20 6469 6d65 6e73 696f 6e3a 2050 6172  m dimension: Par
-0000bb70: 616d 6574 6573 2077 6974 6820 7468 6520  ametes with the 
-0000bb80: 706f 7369 7469 6f6e 206f 6620 7468 6520  position of the 
-0000bb90: 6461 7461 2069 6e20 7468 6520 7265 7368  data in the resh
-0000bba0: 6170 6564 0a20 2020 2020 2020 2020 2020  aped.           
-0000bbb0: 2061 7272 6179 2e0a 2020 2020 2020 2020   array..        
-0000bbc0: 3a74 7970 6520 6469 6d65 6e73 696f 6e3a  :type dimension:
-0000bbd0: 2055 6e69 6f6e 5b4e 6f6e 652c 2074 7570   Union[None, tup
-0000bbe0: 6c65 2c20 6172 7261 795f 6c69 6b65 5d0a  le, array_like].
-0000bbf0: 2020 2020 2020 2020 3a70 6172 616d 2055          :param U
-0000bc00: 6e69 6f6e 5b27 6666 7427 2c20 276c 696e  nion['fft', 'lin
-0000bc10: 6561 7227 5d20 7368 6966 745f 6170 7072  ear'] shift_appr
-0000bc20: 6f61 6368 3a20 4d65 7468 6f64 2074 6f20  oach: Method to 
-0000bc30: 7573 6520 746f 2061 7070 6c79 2074 6865  use to apply the
-0000bc40: 2073 6869 6674 2e0a 2020 2020 2020 2020   shift..        
-0000bc50: 3a70 6172 616d 2069 6e64 6963 6573 3a20  :param indices: 
-0000bc60: 426f 6f6c 6561 6e20 696e 6465 7820 6c69  Boolean index li
-0000bc70: 7374 2077 6974 6820 5472 7565 2069 6e20  st with True in 
-0000bc80: 7468 6520 696d 6167 6573 2074 6f20 6170  the images to ap
-0000bc90: 706c 7920 7468 6520 7368 6966 7420 746f  ply the shift to
-0000bca0: 2e0a 2020 2020 2020 2020 2020 2020 4966  ..            If
-0000bcb0: 204e 6f6e 652c 2074 6865 2068 6f74 2070   None, the hot p
-0000bcc0: 6978 656c 2072 656d 6f76 616c 2069 7320  ixel removal is 
-0000bcd0: 6170 706c 6965 6420 746f 2061 6c6c 2074  applied to all t
-0000bce0: 6865 2064 6174 612e 0a20 2020 2020 2020  he data..       
-0000bcf0: 203a 7479 7065 2069 6e64 6963 6573 3a20   :type indices: 
-0000bd00: 556e 696f 6e5b 4e6f 6e65 2c20 6172 7261  Union[None, arra
-0000bd10: 795f 6c69 6b65 5d0a 2020 2020 2020 2020  y_like].        
-0000bd20: 3a70 6172 616d 2055 6e69 6f6e 5b66 756e  :param Union[fun
-0000bd30: 6374 696f 6e2c 204e 6f6e 655d 2063 616c  ction, None] cal
-0000bd40: 6c62 6163 6b3a 2043 616c 6c62 6163 6b0a  lback: Callback.
-0000bd50: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
-0000bd60: 3a20 6461 7461 7365 7420 7769 7468 2064  : dataset with d
-0000bd70: 6174 6120 6f66 2073 616d 6520 7369 7a65  ata of same size
-0000bd80: 2061 7320 6073 656c 662e 6461 7461 6020   as `self.data` 
-0000bd90: 6275 7420 7769 7468 2074 6865 0a20 2020  but with the.   
-0000bda0: 2020 2020 2020 2020 206d 6f64 6966 6965           modifie
-0000bdb0: 6420 696d 6167 6573 2e20 5468 6520 7572  d images. The ur
-0000bdc0: 6c73 206f 6620 7468 6520 6d6f 6469 6669  ls of the modifi
-0000bdd0: 6564 2069 6d61 6765 7320 6172 6520 7265  ed images are re
-0000bde0: 706c 6163 6564 2077 6974 680a 2020 2020  placed with.    
-0000bdf0: 2020 2020 2020 2020 7468 6520 6e65 7720          the new 
-0000be00: 7572 6c73 2e0a 2020 2020 2020 2020 2222  urls..        ""
-0000be10: 220a 2020 2020 2020 2020 6173 7365 7274  ".        assert
-0000be20: 206c 656e 2873 6869 6674 2920 3e20 302c   len(shift) > 0,
-0000be30: 2022 5368 6966 7420 6c69 7374 2063 616e   "Shift list can
-0000be40: 2774 2062 6520 656d 7074 7922 0a0a 2020  't be empty"..  
-0000be50: 2020 2020 2020 6966 206e 6f74 206e 756d        if not num
-0000be60: 7079 2e61 6e79 2873 6869 6674 293a 0a20  py.any(shift):. 
-0000be70: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000be80: 6e20 7365 6c66 0a0a 2020 2020 2020 2020  n self..        
-0000be90: 5f64 6972 203d 2073 656c 662e 6469 7220  _dir = self.dir 
-0000bea0: 6966 205f 6469 7220 6973 204e 6f6e 6520  if _dir is None 
-0000beb0: 656c 7365 205f 6469 720a 0a20 2020 2020  else _dir..     
-0000bec0: 2020 206f 732e 6d61 6b65 6469 7273 285f     os.makedirs(_
-0000bed0: 6469 722c 2065 7869 7374 5f6f 6b3d 5472  dir, exist_ok=Tr
-0000bee0: 7565 290a 0a20 2020 2020 2020 2064 6174  ue)..        dat
-0000bef0: 612c 2072 696e 6469 6365 7320 3d20 7365  a, rindices = se
-0000bf00: 6c66 2e67 6574 5f64 6174 6128 696e 6469  lf.get_data(indi
-0000bf10: 6365 732c 2064 696d 656e 7369 6f6e 2c20  ces, dimension, 
-0000bf20: 7265 7475 726e 5f69 6e64 6963 6573 3d54  return_indices=T
-0000bf30: 7275 6529 0a0a 2020 2020 2020 2020 7769  rue)..        wi
-0000bf40: 7468 2073 656c 662e 7374 6174 655f 6f66  th self.state_of
-0000bf50: 5f6f 7065 7261 7469 6f6e 732e 7275 6e5f  _operations.run_
-0000bf60: 636f 6e74 6578 7428 4f70 6572 6174 696f  context(Operatio
-0000bf70: 6e2e 5348 4946 5429 3a0a 2020 2020 2020  n.SHIFT):.      
-0000bf80: 2020 2020 2020 5f66 696c 6520 3d20 4e6f        _file = No
-0000bf90: 6e65 0a20 2020 2020 2020 2020 2020 2074  ne.            t
-0000bfa0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000bfb0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0000bfc0: 2020 2020 2020 2020 2020 2020 2066 696c               fil
-0000bfd0: 656e 616d 6520 3d20 6f73 2e70 6174 682e  ename = os.path.
-0000bfe0: 6a6f 696e 285f 6469 722c 2022 6461 7461  join(_dir, "data
-0000bff0: 2e68 6466 3522 290a 2020 2020 2020 2020  .hdf5").        
-0000c000: 2020 2020 2020 2020 2020 2020 5f66 696c              _fil
-0000c010: 6520 3d20 6835 7079 2e46 696c 6528 6669  e = h5py.File(fi
-0000c020: 6c65 6e61 6d65 2c20 2261 2229 0a20 2020  lename, "a").   
-0000c030: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-0000c040: 6570 7420 4f53 4572 726f 723a 0a20 2020  ept OSError:.   
-0000c050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c060: 2069 6620 6f73 2e70 6174 682e 6578 6973   if os.path.exis
-0000c070: 7473 2866 696c 656e 616d 6529 3a0a 2020  ts(filename):.  
-0000c080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c090: 2020 2020 2020 6f73 2e72 656d 6f76 6528        os.remove(
-0000c0a0: 6669 6c65 6e61 6d65 290a 2020 2020 2020  filename).      
-0000c0b0: 2020 2020 2020 2020 2020 2020 2020 5f66                _f
-0000c0c0: 696c 6520 3d20 6835 7079 2e46 696c 6528  ile = h5py.File(
-0000c0d0: 6669 6c65 6e61 6d65 2c20 2277 2229 0a20  filename, "w"). 
-0000c0e0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0000c0f0: 6174 6173 6574 5f6e 616d 6520 3d20 2264  ataset_name = "d
-0000c100: 6174 6173 6574 220a 2020 2020 2020 2020  ataset".        
-0000c110: 2020 2020 2020 2020 6966 2022 6461 7461          if "data
-0000c120: 7365 7422 206e 6f74 2069 6e20 5f66 696c  set" not in _fil
-0000c130: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000c140: 2020 2020 2020 205f 6669 6c65 2e63 7265         _file.cre
-0000c150: 6174 655f 6461 7461 7365 7428 0a20 2020  ate_dataset(.   
-0000c160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c170: 2020 2020 2022 6461 7461 7365 7422 2c20       "dataset", 
-0000c180: 7365 6c66 2e67 6574 5f64 6174 6128 292e  self.get_data().
-0000c190: 7368 6170 652c 2064 7479 7065 3d73 656c  shape, dtype=sel
-0000c1a0: 662e 6461 7461 2e64 7479 7065 0a20 2020  f.data.dtype.   
-0000c1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c1c0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0000c1d0: 2020 2065 6c69 6620 7365 6c66 2e67 6574     elif self.get
-0000c1e0: 5f64 6174 6128 292e 7368 6170 6520 213d  _data().shape !=
-0000c1f0: 205f 6669 6c65 5b22 6461 7461 7365 7422   _file["dataset"
-0000c200: 5d2e 7368 6170 653a 0a20 2020 2020 2020  ].shape:.       
-0000c210: 2020 2020 2020 2020 2020 2020 2064 656c               del
-0000c220: 205f 6669 6c65 5b22 6461 7461 7365 7422   _file["dataset"
-0000c230: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0000c240: 2020 2020 2020 5f66 696c 652e 6372 6561        _file.crea
-0000c250: 7465 5f64 6174 6173 6574 280a 2020 2020  te_dataset(.    
-0000c260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c270: 2020 2020 2264 6174 6173 6574 222c 2073      "dataset", s
-0000c280: 656c 662e 6765 745f 6461 7461 2829 2e73  elf.get_data().s
-0000c290: 6861 7065 2c20 6474 7970 653d 7365 6c66  hape, dtype=self
-0000c2a0: 2e64 6174 612e 6474 7970 650a 2020 2020  .data.dtype.    
-0000c2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000c2d0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000c2e0: 2020 2020 2020 2020 2020 2020 6461 7461              data
-0000c2f0: 7365 745f 6e61 6d65 203d 2022 7570 6461  set_name = "upda
-0000c300: 7465 5f64 6174 6173 6574 220a 2020 2020  te_dataset".    
-0000c310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c320: 5f66 696c 652e 636f 7079 2822 6461 7461  _file.copy("data
-0000c330: 7365 7422 2c20 2275 7064 6174 655f 6461  set", "update_da
-0000c340: 7461 7365 7422 290a 0a20 2020 2020 2020  taset")..       
-0000c350: 2020 2020 2020 2020 2069 6f5f 7574 696c           io_util
-0000c360: 732e 6164 7661 6e63 656d 656e 745f 6469  s.advancement_di
-0000c370: 7370 6c61 7928 302c 206c 656e 2864 6174  splay(0, len(dat
-0000c380: 6129 2c20 2241 7070 6c79 696e 6720 7368  a), "Applying sh
-0000c390: 6966 7422 290a 2020 2020 2020 2020 2020  ift").          
-0000c3a0: 2020 2020 2020 6966 2064 696d 656e 7369        if dimensi
-0000c3b0: 6f6e 2069 7320 6e6f 7420 4e6f 6e65 3a0a  on is not None:.
+00008540: 2020 2020 2020 2020 2020 2020 7374 6172              star
+00008550: 745b 305d 203d 2063 6875 6e6b 5f73 6861  t[0] = chunk_sha
+00008560: 7065 5b30 5d20 2a20 2869 202b 2031 290a  pe[0] * (i + 1).
+00008570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008590: 7374 6172 745b 315d 203d 2030 0a0a 2020  start[1] = 0..  
+000085a0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000085b0: 206e 6f74 2073 656c 662e 7374 6174 655f   not self.state_
+000085c0: 6f66 5f6f 7065 7261 7469 6f6e 732e 6973  of_operations.is
+000085d0: 5f72 756e 6e69 6e67 284f 7065 7261 7469  _running(Operati
+000085e0: 6f6e 2e42 5329 3a0a 2020 2020 2020 2020  on.BS):.        
+000085f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00008600: 726e 0a20 2020 2020 2020 2020 2020 2020  rn.             
+00008610: 2020 2075 726c 7320 3d20 7365 6c66 2e72     urls = self.r
+00008620: 756e 6e69 6e67 5f64 6174 612e 6170 706c  unning_data.appl
+00008630: 795f 6675 6e63 7328 0a20 2020 2020 2020  y_funcs(.       
+00008640: 2020 2020 2020 2020 2020 2020 205b 2862               [(b
+00008650: 6163 6b67 726f 756e 645f 7375 6274 7261  ackground_subtra
+00008660: 6374 696f 6e5f 3244 2c20 5b62 675d 295d  ction_2D, [bg])]
+00008670: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00008680: 2020 2020 2020 7361 7665 3d6f 732e 7061        save=os.pa
+00008690: 7468 2e6a 6f69 6e28 7465 6d70 5f64 6972  th.join(temp_dir
+000086a0: 2c20 2264 6174 612e 6864 6635 2229 2c0a  , "data.hdf5"),.
+000086b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000086c0: 2020 2020 7465 7874 3d22 4170 706c 7969      text="Applyi
+000086d0: 6e67 2062 6163 6b67 726f 756e 6420 7375  ng background su
+000086e0: 6274 7261 6374 696f 6e22 2c0a 2020 2020  btraction",.    
+000086f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008700: 6f70 6572 6174 696f 6e3d 4f70 6572 6174  operation=Operat
+00008710: 696f 6e2e 4253 2c0a 2020 2020 2020 2020  ion.BS,.        
+00008720: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00008730: 2020 2020 2020 2020 2020 6966 2075 726c            if url
+00008740: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+00008750: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00008760: 6574 7572 6e0a 0a20 2020 2020 2020 2023  eturn..        #
+00008770: 2053 6574 2075 726c 7320 6173 2073 6861   Set urls as sha
+00008780: 7065 2061 6e64 2064 696d 656e 7369 6f6e  pe and dimension
+00008790: 206f 6620 6f72 6967 696e 616c 2075 726c   of original url
+000087a0: 732e 0a20 2020 2020 2020 2069 6620 696e  s..        if in
+000087b0: 6469 6365 7320 6973 206e 6f74 204e 6f6e  dices is not Non
+000087c0: 653a 0a20 2020 2020 2020 2020 2020 206e  e:.            n
+000087d0: 6577 5f75 726c 7320 3d20 6e75 6d70 792e  ew_urls = numpy.
+000087e0: 6172 7261 7928 7365 6c66 2e67 6574 5f64  array(self.get_d
+000087f0: 6174 6128 292e 7572 6c73 2c20 6474 7970  ata().urls, dtyp
+00008800: 653d 6f62 6a65 6374 290a 2020 2020 2020  e=object).      
+00008810: 2020 2020 2020 6e65 775f 7572 6c73 5b69        new_urls[i
+00008820: 6e64 6963 6573 5d20 3d20 7572 6c73 0a20  ndices] = urls. 
+00008830: 2020 2020 2020 2020 2020 206e 6577 5f64             new_d
+00008840: 6174 6120 3d20 4461 7461 280a 2020 2020  ata = Data(.    
+00008850: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
+00008860: 7572 6c73 2e72 6573 6861 7065 2873 656c  urls.reshape(sel
+00008870: 662e 6461 7461 2e75 726c 732e 7368 6170  f.data.urls.shap
+00008880: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00008890: 2020 2020 7365 6c66 2e64 6174 612e 6d65      self.data.me
+000088a0: 7461 6461 7461 2c0a 2020 2020 2020 2020  tadata,.        
+000088b0: 2020 2020 2020 2020 7365 6c66 2e5f 696e          self._in
+000088c0: 5f6d 656d 6f72 792c 0a20 2020 2020 2020  _memory,.       
+000088d0: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
+000088e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000088f0: 206e 6577 5f64 6174 6120 3d20 4461 7461   new_data = Data
+00008900: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00008910: 2020 7572 6c73 2e72 6573 6861 7065 2873    urls.reshape(s
+00008920: 656c 662e 6461 7461 2e75 726c 732e 7368  elf.data.urls.sh
+00008930: 6170 6529 2c20 7365 6c66 2e64 6174 612e  ape), self.data.
+00008940: 6d65 7461 6461 7461 2c20 7365 6c66 2e5f  metadata, self._
+00008950: 696e 5f6d 656d 6f72 790a 2020 2020 2020  in_memory.      
+00008960: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00008970: 206e 6577 5f64 6174 612e 7361 7665 286f   new_data.save(o
+00008980: 732e 7061 7468 2e6a 6f69 6e28 5f64 6972  s.path.join(_dir
+00008990: 2c20 2264 6174 612e 6864 6635 2229 2c20  , "data.hdf5"), 
+000089a0: 696e 6469 6365 733d 696e 6469 6365 7329  indices=indices)
+000089b0: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
+000089c0: 2020 2020 2020 2020 2020 206f 732e 7265             os.re
+000089d0: 6d6f 7665 286f 732e 7061 7468 2e6a 6f69  move(os.path.joi
+000089e0: 6e28 7465 6d70 5f64 6972 2c20 2264 6174  n(temp_dir, "dat
+000089f0: 612e 6864 6635 2229 290a 2020 2020 2020  a.hdf5")).      
+00008a00: 2020 2020 2020 6f73 2e72 6d64 6972 2874        os.rmdir(t
+00008a10: 656d 705f 6469 7229 0a20 2020 2020 2020  emp_dir).       
+00008a20: 2065 7863 6570 7420 4f53 4572 726f 7220   except OSError 
+00008a30: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+00008a40: 2020 5f6c 6f67 6765 722e 7761 726e 696e    _logger.warnin
+00008a50: 6728 2245 7272 6f72 3a20 2573 2220 2520  g("Error: %s" % 
+00008a60: 2865 2e73 7472 6572 726f 7229 290a 0a20  (e.strerror)).. 
+00008a70: 2020 2020 2020 2072 6574 7572 6e20 4461         return Da
+00008a80: 7461 7365 7428 0a20 2020 2020 2020 2020  taset(.         
+00008a90: 2020 205f 6469 723d 5f64 6972 2c0a 2020     _dir=_dir,.  
+00008aa0: 2020 2020 2020 2020 2020 6461 7461 3d6e            data=n
+00008ab0: 6577 5f64 6174 612c 0a20 2020 2020 2020  ew_data,.       
+00008ac0: 2020 2020 2064 696d 733d 7365 6c66 2e5f       dims=self._
+00008ad0: 5f64 696d 732c 0a20 2020 2020 2020 2020  _dims,.         
+00008ae0: 2020 2074 7261 6e73 666f 726d 6174 696f     transformatio
+00008af0: 6e3d 7365 6c66 2e74 7261 6e73 666f 726d  n=self.transform
+00008b00: 6174 696f 6e2c 0a20 2020 2020 2020 2020  ation,.         
+00008b10: 2020 2069 6e5f 6d65 6d6f 7279 3d73 656c     in_memory=sel
+00008b20: 662e 5f69 6e5f 6d65 6d6f 7279 2c0a 2020  f._in_memory,.  
+00008b30: 2020 2020 2020 2020 2020 7469 746c 653d            title=
+00008b40: 7365 6c66 2e74 6974 6c65 2c0a 2020 2020  self.title,.    
+00008b50: 2020 2020 290a 0a20 2020 2064 6566 2061      )..    def a
+00008b60: 7070 6c79 5f68 6f74 5f70 6978 656c 5f72  pply_hot_pixel_r
+00008b70: 656d 6f76 616c 2873 656c 662c 206b 6572  emoval(self, ker
+00008b80: 6e65 6c3d 332c 2069 6e64 6963 6573 3d4e  nel=3, indices=N
+00008b90: 6f6e 652c 205f 6469 723d 4e6f 6e65 293a  one, _dir=None):
+00008ba0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00008bb0: 2020 2020 2041 7070 6c69 6573 2068 6f74       Applies hot
+00008bc0: 2070 6978 656c 2072 656d 6f76 616c 2074   pixel removal t
+00008bd0: 6f20 4461 7461 2c20 616e 6420 7361 7665  o Data, and save
+00008be0: 7320 7468 6520 6e65 7720 6461 7461 0a20  s the new data. 
+00008bf0: 2020 2020 2020 2069 6e74 6f20 6469 736b         into disk
+00008c00: 2e0a 0a20 2020 2020 2020 203a 7061 7261  ...        :para
+00008c10: 6d20 696e 7420 6b65 726e 656c 3a20 7369  m int kernel: si
+00008c20: 7a65 206f 6620 7468 6520 6b65 726e 656c  ze of the kernel
+00008c30: 2075 7365 6420 746f 2066 696e 6420 7468   used to find th
+00008c40: 6520 686f 740a 2020 2020 2020 2020 2020  e hot.          
+00008c50: 2020 7069 7865 6c73 2e0a 2020 2020 2020    pixels..      
+00008c60: 2020 3a70 6172 616d 2069 6e64 6963 6573    :param indices
+00008c70: 3a20 496e 6469 6365 7320 6f66 2074 6865  : Indices of the
+00008c80: 2069 6d61 6765 7320 746f 2061 7070 6c79   images to apply
+00008c90: 2062 6163 6b67 726f 756e 6420 7375 6274   background subt
+00008ca0: 7261 6374 696f 6e2e 0a20 2020 2020 2020  raction..       
+00008cb0: 2020 2020 2049 6620 4e6f 6e65 2c20 7468       If None, th
+00008cc0: 6520 686f 7420 7069 7865 6c20 7265 6d6f  e hot pixel remo
+00008cd0: 7661 6c20 6973 2061 7070 6c69 6564 2074  val is applied t
+00008ce0: 6f20 616c 6c20 7468 6520 6461 7461 2e0a  o all the data..
+00008cf0: 2020 2020 2020 2020 3a74 7970 6520 696e          :type in
+00008d00: 6469 6365 733a 2055 6e69 6f6e 5b4e 6f6e  dices: Union[Non
+00008d10: 652c 2061 7272 6179 5f6c 696b 655d 0a20  e, array_like]. 
+00008d20: 2020 2020 2020 203a 7265 7475 726e 3a20         :return: 
+00008d30: 6461 7461 7365 7420 7769 7468 2064 6174  dataset with dat
+00008d40: 6120 6f66 2073 616d 6520 7369 7a65 2061  a of same size a
+00008d50: 7320 6073 656c 662e 6461 7461 6020 6275  s `self.data` bu
+00008d60: 7420 7769 7468 2074 6865 0a20 2020 2020  t with the.     
+00008d70: 2020 2020 2020 206d 6f64 6966 6965 6420         modified 
+00008d80: 696d 6167 6573 2e20 5468 6520 7572 6c73  images. The urls
+00008d90: 206f 6620 7468 6520 6d6f 6469 6669 6564   of the modified
+00008da0: 2069 6d61 6765 7320 6172 6520 7265 706c   images are repl
+00008db0: 6163 6564 2077 6974 680a 2020 2020 2020  aced with.      
+00008dc0: 2020 2020 2020 7468 6520 6e65 7720 7572        the new ur
+00008dd0: 6c73 2e0a 2020 2020 2020 2020 3a72 7479  ls..        :rty
+00008de0: 7065 3a20 4461 7461 7365 740a 2020 2020  pe: Dataset.    
+00008df0: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
+00008e00: 2073 656c 662e 7275 6e6e 696e 675f 6461   self.running_da
+00008e10: 7461 203d 2073 656c 662e 6765 745f 6461  ta = self.get_da
+00008e20: 7461 2869 6e64 6963 6573 290a 0a20 2020  ta(indices)..   
+00008e30: 2020 2020 205f 6469 7220 3d20 7365 6c66       _dir = self
+00008e40: 2e64 6972 2069 6620 5f64 6972 2069 7320  .dir if _dir is 
+00008e50: 4e6f 6e65 2065 6c73 6520 5f64 6972 0a0a  None else _dir..
+00008e60: 2020 2020 2020 2020 6f73 2e6d 616b 6564          os.maked
+00008e70: 6972 7328 5f64 6972 2c20 6578 6973 745f  irs(_dir, exist_
+00008e80: 6f6b 3d54 7275 6529 0a0a 2020 2020 2020  ok=True)..      
+00008e90: 2020 7465 6d70 5f64 6972 203d 206f 732e    temp_dir = os.
+00008ea0: 7061 7468 2e6a 6f69 6e28 5f64 6972 2c20  path.join(_dir, 
+00008eb0: 2274 656d 705f 6469 7222 290a 0a20 2020  "temp_dir")..   
+00008ec0: 2020 2020 206f 732e 6d61 6b65 6469 7273       os.makedirs
+00008ed0: 2874 656d 705f 6469 722c 2065 7869 7374  (temp_dir, exist
+00008ee0: 5f6f 6b3d 5472 7565 290a 0a20 2020 2020  _ok=True)..     
+00008ef0: 2020 2069 6620 7365 6c66 2e5f 696e 5f6d     if self._in_m
+00008f00: 656d 6f72 793a 0a20 2020 2020 2020 2020  emory:.         
+00008f10: 2020 206e 6577 5f64 6174 6120 3d20 686f     new_data = ho
+00008f20: 745f 7069 7865 6c5f 7265 6d6f 7661 6c5f  t_pixel_removal_
+00008f30: 3344 2873 656c 662e 7275 6e6e 696e 675f  3D(self.running_
+00008f40: 6461 7461 2c20 6b65 726e 656c 292e 7669  data, kernel).vi
+00008f50: 6577 2844 6174 6129 0a20 2020 2020 2020  ew(Data).       
+00008f60: 2020 2020 206e 6577 5f64 6174 612e 7361       new_data.sa
+00008f70: 7665 286f 732e 7061 7468 2e6a 6f69 6e28  ve(os.path.join(
+00008f80: 7465 6d70 5f64 6972 2c20 2264 6174 612e  temp_dir, "data.
+00008f90: 6864 6635 2229 290a 2020 2020 2020 2020  hdf5")).        
+00008fa0: 2020 2020 7572 6c73 203d 206e 6577 5f64      urls = new_d
+00008fb0: 6174 612e 7572 6c73 0a20 2020 2020 2020  ata.urls.       
+00008fc0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00008fd0: 2020 2075 726c 7320 3d20 7365 6c66 2e72     urls = self.r
+00008fe0: 756e 6e69 6e67 5f64 6174 612e 6170 706c  unning_data.appl
+00008ff0: 795f 6675 6e63 7328 0a20 2020 2020 2020  y_funcs(.       
+00009000: 2020 2020 2020 2020 205b 2868 6f74 5f70           [(hot_p
+00009010: 6978 656c 5f72 656d 6f76 616c 5f32 442c  ixel_removal_2D,
+00009020: 205b 6b65 726e 656c 5d29 5d2c 0a20 2020   [kernel])],.   
+00009030: 2020 2020 2020 2020 2020 2020 2073 6176               sav
+00009040: 653d 6f73 2e70 6174 682e 6a6f 696e 2874  e=os.path.join(t
+00009050: 656d 705f 6469 722c 2022 6461 7461 2e68  emp_dir, "data.h
+00009060: 6466 3522 292c 0a20 2020 2020 2020 2020  df5"),.         
+00009070: 2020 2020 2020 2074 6578 743d 2241 7070         text="App
+00009080: 6c79 696e 6720 686f 7420 7069 7865 6c20  lying hot pixel 
+00009090: 7265 6d6f 7661 6c22 2c0a 2020 2020 2020  removal",.      
+000090a0: 2020 2020 2020 2020 2020 6f70 6572 6174            operat
+000090b0: 696f 6e3d 4f70 6572 6174 696f 6e2e 4850  ion=Operation.HP
+000090c0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+000090d0: 2020 2020 2020 2020 2020 2020 6966 2075              if u
+000090e0: 726c 7320 6973 204e 6f6e 653a 0a20 2020  rls is None:.   
+000090f0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00009100: 7572 6e0a 0a20 2020 2020 2020 2069 6620  urn..        if 
+00009110: 696e 6469 6365 7320 6973 206e 6f74 204e  indices is not N
+00009120: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00009130: 206e 6577 5f75 726c 7320 3d20 6e75 6d70   new_urls = nump
+00009140: 792e 6172 7261 7928 7365 6c66 2e67 6574  y.array(self.get
+00009150: 5f64 6174 6128 292e 7572 6c73 2c20 6474  _data().urls, dt
+00009160: 7970 653d 6f62 6a65 6374 290a 2020 2020  ype=object).    
+00009170: 2020 2020 2020 2020 6e65 775f 7572 6c73          new_urls
+00009180: 5b69 6e64 6963 6573 5d20 3d20 7572 6c73  [indices] = urls
+00009190: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
+000091a0: 5f64 6174 6120 3d20 4461 7461 280a 2020  _data = Data(.  
+000091b0: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+000091c0: 775f 7572 6c73 2e72 6573 6861 7065 2873  w_urls.reshape(s
+000091d0: 656c 662e 6461 7461 2e75 726c 732e 7368  elf.data.urls.sh
+000091e0: 6170 6529 2c0a 2020 2020 2020 2020 2020  ape),.          
+000091f0: 2020 2020 2020 7365 6c66 2e64 6174 612e        self.data.
+00009200: 6d65 7461 6461 7461 2c0a 2020 2020 2020  metadata,.      
+00009210: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00009220: 696e 5f6d 656d 6f72 792c 0a20 2020 2020  in_memory,.     
+00009230: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00009240: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00009250: 2020 206e 6577 5f64 6174 6120 3d20 4461     new_data = Da
+00009260: 7461 280a 2020 2020 2020 2020 2020 2020  ta(.            
+00009270: 2020 2020 7572 6c73 2e72 6573 6861 7065      urls.reshape
+00009280: 2873 656c 662e 6461 7461 2e75 726c 732e  (self.data.urls.
+00009290: 7368 6170 6529 2c20 7365 6c66 2e64 6174  shape), self.dat
+000092a0: 612e 6d65 7461 6461 7461 2c20 7365 6c66  a.metadata, self
+000092b0: 2e5f 696e 5f6d 656d 6f72 790a 2020 2020  ._in_memory.    
+000092c0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+000092d0: 2020 206e 6577 5f64 6174 612e 7361 7665     new_data.save
+000092e0: 286f 732e 7061 7468 2e6a 6f69 6e28 5f64  (os.path.join(_d
+000092f0: 6972 2c20 2264 6174 612e 6864 6635 2229  ir, "data.hdf5")
+00009300: 2c20 696e 6469 6365 733d 696e 6469 6365  , indices=indice
+00009310: 7329 0a20 2020 2020 2020 2074 7279 3a0a  s).        try:.
+00009320: 2020 2020 2020 2020 2020 2020 6f73 2e72              os.r
+00009330: 656d 6f76 6528 6f73 2e70 6174 682e 6a6f  emove(os.path.jo
+00009340: 696e 2874 656d 705f 6469 722c 2022 6461  in(temp_dir, "da
+00009350: 7461 2e68 6466 3522 2929 0a20 2020 2020  ta.hdf5")).     
+00009360: 2020 2020 2020 206f 732e 726d 6469 7228         os.rmdir(
+00009370: 7465 6d70 5f64 6972 290a 2020 2020 2020  temp_dir).      
+00009380: 2020 6578 6365 7074 204f 5345 7272 6f72    except OSError
+00009390: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+000093a0: 2020 205f 6c6f 6767 6572 2e77 6172 6e69     _logger.warni
+000093b0: 6e67 2822 4572 726f 723a 2025 7322 2025  ng("Error: %s" %
+000093c0: 2028 652e 7374 7265 7272 6f72 2929 0a0a   (e.strerror))..
+000093d0: 2020 2020 2020 2020 7265 7475 726e 2044          return D
+000093e0: 6174 6173 6574 280a 2020 2020 2020 2020  ataset(.        
+000093f0: 2020 2020 5f64 6972 3d5f 6469 722c 0a20      _dir=_dir,. 
+00009400: 2020 2020 2020 2020 2020 2064 6174 613d             data=
+00009410: 6e65 775f 6461 7461 2c0a 2020 2020 2020  new_data,.      
+00009420: 2020 2020 2020 6469 6d73 3d73 656c 662e        dims=self.
+00009430: 5f5f 6469 6d73 2c0a 2020 2020 2020 2020  __dims,.        
+00009440: 2020 2020 7472 616e 7366 6f72 6d61 7469      transformati
+00009450: 6f6e 3d73 656c 662e 7472 616e 7366 6f72  on=self.transfor
+00009460: 6d61 7469 6f6e 2c0a 2020 2020 2020 2020  mation,.        
+00009470: 2020 2020 696e 5f6d 656d 6f72 793d 7365      in_memory=se
+00009480: 6c66 2e5f 696e 5f6d 656d 6f72 792c 0a20  lf._in_memory,. 
+00009490: 2020 2020 2020 2020 2020 2074 6974 6c65             title
+000094a0: 3d73 656c 662e 7469 746c 652c 0a20 2020  =self.title,.   
+000094b0: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+000094c0: 6170 706c 795f 7468 7265 7368 6f6c 645f  apply_threshold_
+000094d0: 7265 6d6f 7661 6c28 7365 6c66 2c20 626f  removal(self, bo
+000094e0: 7474 6f6d 3d4e 6f6e 652c 2074 6f70 3d4e  ttom=None, top=N
+000094f0: 6f6e 652c 2069 6e64 6963 6573 3d4e 6f6e  one, indices=Non
+00009500: 652c 205f 6469 723d 4e6f 6e65 293a 0a20  e, _dir=None):. 
+00009510: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00009520: 2020 2041 7070 6c69 6573 2062 6f74 746f     Applies botto
+00009530: 6d20 7468 7265 7368 6f6c 6420 746f 2044  m threshold to D
+00009540: 6174 612c 2061 6e64 2073 6176 6573 2074  ata, and saves t
+00009550: 6865 206e 6577 2064 6174 610a 2020 2020  he new data.    
+00009560: 2020 2020 696e 746f 2064 6973 6b2e 0a0a      into disk...
+00009570: 2020 2020 2020 2020 3a70 6172 616d 2069          :param i
+00009580: 6e74 2062 6f74 746f 6d3a 2062 6f74 746f  nt bottom: botto
+00009590: 6d20 7468 7265 7368 6f6c 6420 746f 2061  m threshold to a
+000095a0: 7070 6c79 2e0a 2020 2020 2020 2020 3a70  pply..        :p
+000095b0: 6172 616d 2069 6e74 2074 6f70 3a20 746f  aram int top: to
+000095c0: 7020 7468 7265 7368 6f6c 6420 746f 2061  p threshold to a
+000095d0: 7070 6c79 2e0a 2020 2020 2020 2020 3a70  pply..        :p
+000095e0: 6172 616d 2069 6e64 6963 6573 3a20 496e  aram indices: In
+000095f0: 6469 6365 7320 6f66 2074 6865 2069 6d61  dices of the ima
+00009600: 6765 7320 746f 2061 7070 6c79 2062 6163  ges to apply bac
+00009610: 6b67 726f 756e 6420 7375 6274 7261 6374  kground subtract
+00009620: 696f 6e2e 0a20 2020 2020 2020 2020 2020  ion..           
+00009630: 2049 6620 4e6f 6e65 2c20 7468 6520 686f   If None, the ho
+00009640: 7420 7069 7865 6c20 7265 6d6f 7661 6c20  t pixel removal 
+00009650: 6973 2061 7070 6c69 6564 2074 6f20 616c  is applied to al
+00009660: 6c20 7468 6520 6461 7461 2e0a 2020 2020  l the data..    
+00009670: 2020 2020 3a74 7970 6520 696e 6469 6365      :type indice
+00009680: 733a 2055 6e69 6f6e 5b4e 6f6e 652c 2061  s: Union[None, a
+00009690: 7272 6179 5f6c 696b 655d 0a20 2020 2020  rray_like].     
+000096a0: 2020 203a 7265 7475 726e 3a20 6461 7461     :return: data
+000096b0: 7365 7420 7769 7468 2064 6174 6120 6f66  set with data of
+000096c0: 2073 616d 6520 7369 7a65 2061 7320 6073   same size as `s
+000096d0: 656c 662e 6461 7461 6020 6275 7420 7769  elf.data` but wi
+000096e0: 7468 2074 6865 0a20 2020 2020 2020 2020  th the.         
+000096f0: 2020 206d 6f64 6966 6965 6420 696d 6167     modified imag
+00009700: 6573 2e20 5468 6520 7572 6c73 206f 6620  es. The urls of 
+00009710: 7468 6520 6d6f 6469 6669 6564 2069 6d61  the modified ima
+00009720: 6765 7320 6172 6520 7265 706c 6163 6564  ges are replaced
+00009730: 2077 6974 680a 2020 2020 2020 2020 2020   with.          
+00009740: 2020 7468 6520 6e65 7720 7572 6c73 2e0a    the new urls..
+00009750: 2020 2020 2020 2020 3a72 7479 7065 3a20          :rtype: 
+00009760: 4461 7461 7365 740a 2020 2020 2020 2020  Dataset.        
+00009770: 2222 220a 0a20 2020 2020 2020 2073 656c  """..        sel
+00009780: 662e 7275 6e6e 696e 675f 6461 7461 203d  f.running_data =
+00009790: 2073 656c 662e 6765 745f 6461 7461 2869   self.get_data(i
+000097a0: 6e64 6963 6573 290a 0a20 2020 2020 2020  ndices)..       
+000097b0: 205f 6469 7220 3d20 7365 6c66 2e64 6972   _dir = self.dir
+000097c0: 2069 6620 5f64 6972 2069 7320 4e6f 6e65   if _dir is None
+000097d0: 2065 6c73 6520 5f64 6972 0a0a 2020 2020   else _dir..    
+000097e0: 2020 2020 6f73 2e6d 616b 6564 6972 7328      os.makedirs(
+000097f0: 5f64 6972 2c20 6578 6973 745f 6f6b 3d54  _dir, exist_ok=T
+00009800: 7275 6529 0a0a 2020 2020 2020 2020 7465  rue)..        te
+00009810: 6d70 5f64 6972 203d 206f 732e 7061 7468  mp_dir = os.path
+00009820: 2e6a 6f69 6e28 5f64 6972 2c20 2274 656d  .join(_dir, "tem
+00009830: 705f 6469 7222 290a 0a20 2020 2020 2020  p_dir")..       
+00009840: 206f 732e 6d61 6b65 6469 7273 2874 656d   os.makedirs(tem
+00009850: 705f 6469 722c 2065 7869 7374 5f6f 6b3d  p_dir, exist_ok=
+00009860: 5472 7565 290a 0a20 2020 2020 2020 2069  True)..        i
+00009870: 6620 7365 6c66 2e5f 696e 5f6d 656d 6f72  f self._in_memor
+00009880: 793a 0a20 2020 2020 2020 2020 2020 206e  y:.            n
+00009890: 6577 5f64 6174 6120 3d20 7468 7265 7368  ew_data = thresh
+000098a0: 6f6c 645f 7265 6d6f 7661 6c28 7365 6c66  old_removal(self
+000098b0: 2e72 756e 6e69 6e67 5f64 6174 612c 2062  .running_data, b
+000098c0: 6f74 746f 6d2c 2074 6f70 292e 7669 6577  ottom, top).view
+000098d0: 2844 6174 6129 0a20 2020 2020 2020 2020  (Data).         
+000098e0: 2020 206e 6577 5f64 6174 612e 7361 7665     new_data.save
+000098f0: 286f 732e 7061 7468 2e6a 6f69 6e28 7465  (os.path.join(te
+00009900: 6d70 5f64 6972 2c20 2264 6174 612e 6864  mp_dir, "data.hd
+00009910: 6635 2229 290a 2020 2020 2020 2020 2020  f5")).          
+00009920: 2020 7572 6c73 203d 206e 6577 5f64 6174    urls = new_dat
+00009930: 612e 7572 6c73 0a20 2020 2020 2020 2065  a.urls.        e
+00009940: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00009950: 2075 726c 7320 3d20 7365 6c66 2e72 756e   urls = self.run
+00009960: 6e69 6e67 5f64 6174 612e 6170 706c 795f  ning_data.apply_
+00009970: 6675 6e63 7328 0a20 2020 2020 2020 2020  funcs(.         
+00009980: 2020 2020 2020 205b 2874 6872 6573 686f         [(thresho
+00009990: 6c64 5f72 656d 6f76 616c 2c20 5b62 6f74  ld_removal, [bot
+000099a0: 746f 6d2c 2074 6f70 5d29 5d2c 0a20 2020  tom, top])],.   
+000099b0: 2020 2020 2020 2020 2020 2020 2073 6176               sav
+000099c0: 653d 6f73 2e70 6174 682e 6a6f 696e 2874  e=os.path.join(t
+000099d0: 656d 705f 6469 722c 2022 6461 7461 2e68  emp_dir, "data.h
+000099e0: 6466 3522 292c 0a20 2020 2020 2020 2020  df5"),.         
+000099f0: 2020 2020 2020 2074 6578 743d 2241 7070         text="App
+00009a00: 6c79 696e 6720 7468 7265 7368 6f6c 6422  lying threshold"
+00009a10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009a20: 2020 6f70 6572 6174 696f 6e3d 4f70 6572    operation=Oper
+00009a30: 6174 696f 6e2e 5448 5245 5348 4f4c 442c  ation.THRESHOLD,
+00009a40: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00009a50: 2020 2020 2020 2020 2020 2069 6620 7572             if ur
+00009a60: 6c73 2069 7320 4e6f 6e65 3a0a 2020 2020  ls is None:.    
+00009a70: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00009a80: 726e 0a20 2020 2020 2020 2069 6620 696e  rn.        if in
+00009a90: 6469 6365 7320 6973 206e 6f74 204e 6f6e  dices is not Non
+00009aa0: 653a 0a20 2020 2020 2020 2020 2020 206e  e:.            n
+00009ab0: 6577 5f75 726c 7320 3d20 6e75 6d70 792e  ew_urls = numpy.
+00009ac0: 6172 7261 7928 7365 6c66 2e67 6574 5f64  array(self.get_d
+00009ad0: 6174 6128 292e 7572 6c73 2c20 6474 7970  ata().urls, dtyp
+00009ae0: 653d 6f62 6a65 6374 290a 2020 2020 2020  e=object).      
+00009af0: 2020 2020 2020 6e65 775f 7572 6c73 5b69        new_urls[i
+00009b00: 6e64 6963 6573 5d20 3d20 7572 6c73 0a20  ndices] = urls. 
+00009b10: 2020 2020 2020 2020 2020 206e 6577 5f64             new_d
+00009b20: 6174 6120 3d20 4461 7461 280a 2020 2020  ata = Data(.    
+00009b30: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
+00009b40: 7572 6c73 2e72 6573 6861 7065 2873 656c  urls.reshape(sel
+00009b50: 662e 6461 7461 2e75 726c 732e 7368 6170  f.data.urls.shap
+00009b60: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00009b70: 2020 2020 7365 6c66 2e64 6174 612e 6d65      self.data.me
+00009b80: 7461 6461 7461 2c0a 2020 2020 2020 2020  tadata,.        
+00009b90: 2020 2020 2020 2020 7365 6c66 2e5f 696e          self._in
+00009ba0: 5f6d 656d 6f72 792c 0a20 2020 2020 2020  _memory,.       
+00009bb0: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
+00009bc0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00009bd0: 206e 6577 5f64 6174 6120 3d20 4461 7461   new_data = Data
+00009be0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00009bf0: 2020 7572 6c73 2e72 6573 6861 7065 2873    urls.reshape(s
+00009c00: 656c 662e 6461 7461 2e75 726c 732e 7368  elf.data.urls.sh
+00009c10: 6170 6529 2c20 7365 6c66 2e64 6174 612e  ape), self.data.
+00009c20: 6d65 7461 6461 7461 2c20 7365 6c66 2e5f  metadata, self._
+00009c30: 696e 5f6d 656d 6f72 790a 2020 2020 2020  in_memory.      
+00009c40: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00009c50: 206e 6577 5f64 6174 612e 7361 7665 286f   new_data.save(o
+00009c60: 732e 7061 7468 2e6a 6f69 6e28 5f64 6972  s.path.join(_dir
+00009c70: 2c20 2264 6174 612e 6864 6635 2229 2c20  , "data.hdf5"), 
+00009c80: 696e 6469 6365 733d 696e 6469 6365 7329  indices=indices)
+00009c90: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+00009ca0: 2020 2020 2020 2020 2020 6f73 2e72 656d            os.rem
+00009cb0: 6f76 6528 6f73 2e70 6174 682e 6a6f 696e  ove(os.path.join
+00009cc0: 2874 656d 705f 6469 722c 2022 6461 7461  (temp_dir, "data
+00009cd0: 2e68 6466 3522 2929 0a20 2020 2020 2020  .hdf5")).       
+00009ce0: 2020 2020 206f 732e 726d 6469 7228 7465       os.rmdir(te
+00009cf0: 6d70 5f64 6972 290a 2020 2020 2020 2020  mp_dir).        
+00009d00: 6578 6365 7074 204f 5345 7272 6f72 2061  except OSError a
+00009d10: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+00009d20: 205f 6c6f 6767 6572 2e77 6172 6e69 6e67   _logger.warning
+00009d30: 2822 4572 726f 723a 2025 7322 2025 2028  ("Error: %s" % (
+00009d40: 652e 7374 7265 7272 6f72 2929 0a0a 2020  e.strerror))..  
+00009d50: 2020 2020 2020 7265 7475 726e 2044 6174        return Dat
+00009d60: 6173 6574 280a 2020 2020 2020 2020 2020  aset(.          
+00009d70: 2020 5f64 6972 3d5f 6469 722c 0a20 2020    _dir=_dir,.   
+00009d80: 2020 2020 2020 2020 2064 6174 613d 6e65           data=ne
+00009d90: 775f 6461 7461 2c0a 2020 2020 2020 2020  w_data,.        
+00009da0: 2020 2020 6469 6d73 3d73 656c 662e 5f5f      dims=self.__
+00009db0: 6469 6d73 2c0a 2020 2020 2020 2020 2020  dims,.          
+00009dc0: 2020 7472 616e 7366 6f72 6d61 7469 6f6e    transformation
+00009dd0: 3d73 656c 662e 7472 616e 7366 6f72 6d61  =self.transforma
+00009de0: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
+00009df0: 2020 696e 5f6d 656d 6f72 793d 7365 6c66    in_memory=self
+00009e00: 2e5f 696e 5f6d 656d 6f72 792c 0a20 2020  ._in_memory,.   
+00009e10: 2020 2020 2020 2020 2074 6974 6c65 3d73           title=s
+00009e20: 656c 662e 7469 746c 652c 0a20 2020 2020  elf.title,.     
+00009e30: 2020 2029 0a0a 2020 2020 6465 6620 6170     )..    def ap
+00009e40: 706c 795f 6d61 736b 5f72 656d 6f76 616c  ply_mask_removal
+00009e50: 2873 656c 662c 206d 6173 6b2c 2069 6e64  (self, mask, ind
+00009e60: 6963 6573 3d4e 6f6e 652c 205f 6469 723d  ices=None, _dir=
+00009e70: 4e6f 6e65 293a 0a20 2020 2020 2020 2022  None):.        "
+00009e80: 2222 0a20 2020 2020 2020 2041 7070 6c69  "".        Appli
+00009e90: 6573 206d 6173 6b20 746f 2044 6174 612c  es mask to Data,
+00009ea0: 2061 6e64 2073 6176 6573 2074 6865 206e   and saves the n
+00009eb0: 6577 2064 6174 6120 696e 746f 2064 6973  ew data into dis
+00009ec0: 6b2e 0a0a 2020 2020 2020 2020 3a70 6172  k...        :par
+00009ed0: 616d 206e 642e 6172 7261 7920 6d61 736b  am nd.array mask
+00009ee0: 3a20 4d61 736b 2074 6f20 6170 706c 7920  : Mask to apply 
+00009ef0: 7769 7468 2030 2773 206f 6e20 7468 6520  with 0's on the 
+00009f00: 6d61 736b 2e0a 2020 2020 2020 2020 3a70  mask..        :p
+00009f10: 6172 616d 2069 6e64 6963 6573 3a20 496e  aram indices: In
+00009f20: 6469 6365 7320 6f66 2074 6865 2069 6d61  dices of the ima
+00009f30: 6765 7320 746f 2061 7070 6c79 2062 6163  ges to apply bac
+00009f40: 6b67 726f 756e 6420 7375 6274 7261 6374  kground subtract
+00009f50: 696f 6e2e 0a20 2020 2020 2020 2020 2020  ion..           
+00009f60: 2049 6620 4e6f 6e65 2c20 7468 6520 686f   If None, the ho
+00009f70: 7420 7069 7865 6c20 7265 6d6f 7661 6c20  t pixel removal 
+00009f80: 6973 2061 7070 6c69 6564 2074 6f20 616c  is applied to al
+00009f90: 6c20 7468 6520 6461 7461 2e0a 2020 2020  l the data..    
+00009fa0: 2020 2020 3a74 7970 6520 696e 6469 6365      :type indice
+00009fb0: 733a 2055 6e69 6f6e 5b4e 6f6e 652c 2061  s: Union[None, a
+00009fc0: 7272 6179 5f6c 696b 655d 0a20 2020 2020  rray_like].     
+00009fd0: 2020 203a 7265 7475 726e 3a20 6461 7461     :return: data
+00009fe0: 7365 7420 7769 7468 2064 6174 6120 6f66  set with data of
+00009ff0: 2073 616d 6520 7369 7a65 2061 7320 6073   same size as `s
+0000a000: 656c 662e 6461 7461 6020 6275 7420 7769  elf.data` but wi
+0000a010: 7468 2074 6865 0a20 2020 2020 2020 2020  th the.         
+0000a020: 2020 206d 6f64 6966 6965 6420 696d 6167     modified imag
+0000a030: 6573 2e20 5468 6520 7572 6c73 206f 6620  es. The urls of 
+0000a040: 7468 6520 6d6f 6469 6669 6564 2069 6d61  the modified ima
+0000a050: 6765 7320 6172 6520 7265 706c 6163 6564  ges are replaced
+0000a060: 2077 6974 680a 2020 2020 2020 2020 2020   with.          
+0000a070: 2020 7468 6520 6e65 7720 7572 6c73 2e0a    the new urls..
+0000a080: 2020 2020 2020 2020 3a72 7479 7065 3a20          :rtype: 
+0000a090: 4461 7461 7365 740a 2020 2020 2020 2020  Dataset.        
+0000a0a0: 2222 220a 0a20 2020 2020 2020 2069 6620  """..        if 
+0000a0b0: 6e6f 7420 6e75 6d70 792e 616e 7928 6d61  not numpy.any(ma
+0000a0c0: 736b 293a 0a20 2020 2020 2020 2020 2020  sk):.           
+0000a0d0: 2072 6574 7572 6e20 7365 6c66 0a0a 2020   return self..  
+0000a0e0: 2020 2020 2020 7365 6c66 2e72 756e 6e69        self.runni
+0000a0f0: 6e67 5f64 6174 6120 3d20 7365 6c66 2e67  ng_data = self.g
+0000a100: 6574 5f64 6174 6128 696e 6469 6365 7329  et_data(indices)
+0000a110: 0a0a 2020 2020 2020 2020 5f64 6972 203d  ..        _dir =
+0000a120: 2073 656c 662e 6469 7220 6966 205f 6469   self.dir if _di
+0000a130: 7220 6973 204e 6f6e 6520 656c 7365 205f  r is None else _
+0000a140: 6469 720a 0a20 2020 2020 2020 206f 732e  dir..        os.
+0000a150: 6d61 6b65 6469 7273 285f 6469 722c 2065  makedirs(_dir, e
+0000a160: 7869 7374 5f6f 6b3d 5472 7565 290a 0a20  xist_ok=True).. 
+0000a170: 2020 2020 2020 2074 656d 705f 6469 7220         temp_dir 
+0000a180: 3d20 6f73 2e70 6174 682e 6a6f 696e 285f  = os.path.join(_
+0000a190: 6469 722c 2022 7465 6d70 5f64 6972 2229  dir, "temp_dir")
+0000a1a0: 0a0a 2020 2020 2020 2020 6f73 2e6d 616b  ..        os.mak
+0000a1b0: 6564 6972 7328 7465 6d70 5f64 6972 2c20  edirs(temp_dir, 
+0000a1c0: 6578 6973 745f 6f6b 3d54 7275 6529 0a0a  exist_ok=True)..
+0000a1d0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0000a1e0: 5f69 6e5f 6d65 6d6f 7279 3a0a 2020 2020  _in_memory:.    
+0000a1f0: 2020 2020 2020 2020 6e65 775f 6461 7461          new_data
+0000a200: 203d 206d 6173 6b5f 7265 6d6f 7661 6c28   = mask_removal(
+0000a210: 7365 6c66 2e72 756e 6e69 6e67 5f64 6174  self.running_dat
+0000a220: 612c 206d 6173 6b29 2e76 6965 7728 4461  a, mask).view(Da
+0000a230: 7461 290a 2020 2020 2020 2020 2020 2020  ta).            
+0000a240: 6e65 775f 6461 7461 2e73 6176 6528 6f73  new_data.save(os
+0000a250: 2e70 6174 682e 6a6f 696e 2874 656d 705f  .path.join(temp_
+0000a260: 6469 722c 2022 6461 7461 2e68 6466 3522  dir, "data.hdf5"
+0000a270: 2929 0a20 2020 2020 2020 2020 2020 2075  )).            u
+0000a280: 726c 7320 3d20 6e65 775f 6461 7461 2e75  rls = new_data.u
+0000a290: 726c 730a 2020 2020 2020 2020 656c 7365  rls.        else
+0000a2a0: 3a0a 2020 2020 2020 2020 2020 2020 7572  :.            ur
+0000a2b0: 6c73 203d 2073 656c 662e 7275 6e6e 696e  ls = self.runnin
+0000a2c0: 675f 6461 7461 2e61 7070 6c79 5f66 756e  g_data.apply_fun
+0000a2d0: 6373 280a 2020 2020 2020 2020 2020 2020  cs(.            
+0000a2e0: 2020 2020 5b28 6d61 736b 5f72 656d 6f76      [(mask_remov
+0000a2f0: 616c 2c20 5b6d 6173 6b5d 295d 2c0a 2020  al, [mask])],.  
+0000a300: 2020 2020 2020 2020 2020 2020 2020 7361                sa
+0000a310: 7665 3d6f 732e 7061 7468 2e6a 6f69 6e28  ve=os.path.join(
+0000a320: 7465 6d70 5f64 6972 2c20 2264 6174 612e  temp_dir, "data.
+0000a330: 6864 6635 2229 2c0a 2020 2020 2020 2020  hdf5"),.        
+0000a340: 2020 2020 2020 2020 7465 7874 3d22 5265          text="Re
+0000a350: 6d6f 7669 6e67 206d 6173 6b22 2c0a 2020  moving mask",.  
+0000a360: 2020 2020 2020 2020 2020 2020 2020 6f70                op
+0000a370: 6572 6174 696f 6e3d 4f70 6572 6174 696f  eration=Operatio
+0000a380: 6e2e 4d41 534b 2c0a 2020 2020 2020 2020  n.MASK,.        
+0000a390: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0000a3a0: 2020 6966 2075 726c 7320 6973 204e 6f6e    if urls is Non
+0000a3b0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000a3c0: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
+0000a3d0: 2020 6966 2069 6e64 6963 6573 2069 7320    if indices is 
+0000a3e0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0000a3f0: 2020 2020 2020 6e65 775f 7572 6c73 203d        new_urls =
+0000a400: 206e 756d 7079 2e61 7272 6179 2873 656c   numpy.array(sel
+0000a410: 662e 6765 745f 6461 7461 2829 2e75 726c  f.get_data().url
+0000a420: 732c 2064 7479 7065 3d6f 626a 6563 7429  s, dtype=object)
+0000a430: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
+0000a440: 5f75 726c 735b 696e 6469 6365 735d 203d  _urls[indices] =
+0000a450: 2075 726c 730a 2020 2020 2020 2020 2020   urls.          
+0000a460: 2020 6e65 775f 6461 7461 203d 2044 6174    new_data = Dat
+0000a470: 6128 0a20 2020 2020 2020 2020 2020 2020  a(.             
+0000a480: 2020 206e 6577 5f75 726c 732e 7265 7368     new_urls.resh
+0000a490: 6170 6528 7365 6c66 2e64 6174 612e 7572  ape(self.data.ur
+0000a4a0: 6c73 2e73 6861 7065 292c 0a20 2020 2020  ls.shape),.     
+0000a4b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000a4c0: 6461 7461 2e6d 6574 6164 6174 612c 0a20  data.metadata,. 
+0000a4d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000a4e0: 656c 662e 5f69 6e5f 6d65 6d6f 7279 2c0a  elf._in_memory,.
+0000a4f0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0000a500: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000a510: 2020 2020 2020 2020 6e65 775f 6461 7461          new_data
+0000a520: 203d 2044 6174 6128 0a20 2020 2020 2020   = Data(.       
+0000a530: 2020 2020 2020 2020 2075 726c 732e 7265           urls.re
+0000a540: 7368 6170 6528 7365 6c66 2e64 6174 612e  shape(self.data.
+0000a550: 7572 6c73 2e73 6861 7065 292c 2073 656c  urls.shape), sel
+0000a560: 662e 6461 7461 2e6d 6574 6164 6174 612c  f.data.metadata,
+0000a570: 2073 656c 662e 5f69 6e5f 6d65 6d6f 7279   self._in_memory
+0000a580: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+0000a590: 2020 2020 2020 2020 6e65 775f 6461 7461          new_data
+0000a5a0: 2e73 6176 6528 6f73 2e70 6174 682e 6a6f  .save(os.path.jo
+0000a5b0: 696e 285f 6469 722c 2022 6461 7461 2e68  in(_dir, "data.h
+0000a5c0: 6466 3522 292c 2069 6e64 6963 6573 3d69  df5"), indices=i
+0000a5d0: 6e64 6963 6573 290a 2020 2020 2020 2020  ndices).        
+0000a5e0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000a5f0: 206f 732e 7265 6d6f 7665 286f 732e 7061   os.remove(os.pa
+0000a600: 7468 2e6a 6f69 6e28 7465 6d70 5f64 6972  th.join(temp_dir
+0000a610: 2c20 2264 6174 612e 6864 6635 2229 290a  , "data.hdf5")).
+0000a620: 2020 2020 2020 2020 2020 2020 6f73 2e72              os.r
+0000a630: 6d64 6972 2874 656d 705f 6469 7229 0a20  mdir(temp_dir). 
+0000a640: 2020 2020 2020 2065 7863 6570 7420 4f53         except OS
+0000a650: 4572 726f 7220 6173 2065 3a0a 2020 2020  Error as e:.    
+0000a660: 2020 2020 2020 2020 5f6c 6f67 6765 722e          _logger.
+0000a670: 7761 726e 696e 6728 2245 7272 6f72 3a20  warning("Error: 
+0000a680: 2573 2220 2520 2865 2e73 7472 6572 726f  %s" % (e.strerro
+0000a690: 7229 290a 0a20 2020 2020 2020 2072 6574  r))..        ret
+0000a6a0: 7572 6e20 4461 7461 7365 7428 0a20 2020  urn Dataset(.   
+0000a6b0: 2020 2020 2020 2020 205f 6469 723d 5f64           _dir=_d
+0000a6c0: 6972 2c0a 2020 2020 2020 2020 2020 2020  ir,.            
+0000a6d0: 6461 7461 3d6e 6577 5f64 6174 612c 0a20  data=new_data,. 
+0000a6e0: 2020 2020 2020 2020 2020 2064 696d 733d             dims=
+0000a6f0: 7365 6c66 2e5f 5f64 696d 732c 0a20 2020  self.__dims,.   
+0000a700: 2020 2020 2020 2020 2074 7261 6e73 666f           transfo
+0000a710: 726d 6174 696f 6e3d 7365 6c66 2e74 7261  rmation=self.tra
+0000a720: 6e73 666f 726d 6174 696f 6e2c 0a20 2020  nsformation,.   
+0000a730: 2020 2020 2020 2020 2069 6e5f 6d65 6d6f           in_memo
+0000a740: 7279 3d73 656c 662e 5f69 6e5f 6d65 6d6f  ry=self._in_memo
+0000a750: 7279 2c0a 2020 2020 2020 2020 2020 2020  ry,.            
+0000a760: 7469 746c 653d 7365 6c66 2e74 6974 6c65  title=self.title
+0000a770: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+0000a780: 2064 6566 2061 7070 6c79 5f72 6f69 280a   def apply_roi(.
+0000a790: 2020 2020 2020 2020 7365 6c66 2c20 6f72          self, or
+0000a7a0: 6967 696e 3d4e 6f6e 652c 2073 697a 653d  igin=None, size=
+0000a7b0: 4e6f 6e65 2c20 6365 6e74 6572 3d4e 6f6e  None, center=Non
+0000a7c0: 652c 2069 6e64 6963 6573 3d4e 6f6e 652c  e, indices=None,
+0000a7d0: 2072 6f69 5f64 6972 3d4e 6f6e 650a 2020   roi_dir=None.  
+0000a7e0: 2020 293a 0a20 2020 2020 2020 2022 2222    ):.        """
+0000a7f0: 0a20 2020 2020 2020 2041 7070 6c69 6573  .        Applies
+0000a800: 2061 2072 6567 696f 6e20 6f66 2069 6e74   a region of int
+0000a810: 6572 6573 7420 746f 2074 6865 2064 6174  erest to the dat
+0000a820: 612e 0a0a 2020 2020 2020 2020 3a70 6172  a...        :par
+0000a830: 616d 206f 7269 6769 6e3a 204f 7269 6769  am origin: Origi
+0000a840: 6e20 6f66 2074 6865 2072 6f69 0a20 2020  n of the roi.   
+0000a850: 2020 2020 203a 7061 7261 6d20 7369 7a65       :param size
+0000a860: 3a20 5b48 6569 6768 742c 2057 6964 7468  : [Height, Width
+0000a870: 5d20 6f66 2074 6865 2072 6f69 2e0a 2020  ] of the roi..  
+0000a880: 2020 2020 2020 3a70 6172 616d 2063 656e        :param cen
+0000a890: 7465 723a 2043 656e 7465 7220 6f66 2074  ter: Center of t
+0000a8a0: 6865 2072 6f69 0a20 2020 2020 2020 203a  he roi.        :
+0000a8b0: 7479 7065 206f 7269 6769 6e3a 2055 6e69  type origin: Uni
+0000a8c0: 6f6e 5b32 6420 7665 6374 6f72 2c20 4e6f  on[2d vector, No
+0000a8d0: 6e65 5d0a 2020 2020 2020 2020 3a74 7970  ne].        :typ
+0000a8e0: 6520 6365 6e74 6572 3a20 556e 696f 6e5b  e center: Union[
+0000a8f0: 3264 2076 6563 746f 722c 204e 6f6e 655d  2d vector, None]
+0000a900: 0a20 2020 2020 2020 203a 7479 7065 2073  .        :type s
+0000a910: 697a 653a 2055 6e69 6f6e 5b32 6420 7665  ize: Union[2d ve
+0000a920: 6374 6f72 2c20 4e6f 6e65 5d0a 2020 2020  ctor, None].    
+0000a930: 2020 2020 3a70 6172 616d 2069 6e64 6963      :param indic
+0000a940: 6573 3a20 496e 6469 6365 7320 6f66 2074  es: Indices of t
+0000a950: 6865 2069 6d61 6765 7320 746f 2061 7070  he images to app
+0000a960: 6c79 2062 6163 6b67 726f 756e 6420 7375  ly background su
+0000a970: 6274 7261 6374 696f 6e2e 0a20 2020 2020  btraction..     
+0000a980: 2020 2020 2020 2049 6620 4e6f 6e65 2c20         If None, 
+0000a990: 7468 6520 726f 6920 6973 2061 7070 6c69  the roi is appli
+0000a9a0: 6564 2074 6f20 616c 6c20 7468 6520 6461  ed to all the da
+0000a9b0: 7461 2e0a 2020 2020 2020 2020 3a74 7970  ta..        :typ
+0000a9c0: 6520 696e 6469 6365 733a 2055 6e69 6f6e  e indices: Union
+0000a9d0: 5b4e 6f6e 652c 2061 7272 6179 5f6c 696b  [None, array_lik
+0000a9e0: 655d 0a20 2020 2020 2020 203a 7061 7261  e].        :para
+0000a9f0: 6d20 726f 695f 6469 723a 2044 6972 6563  m roi_dir: Direc
+0000aa00: 746f 7279 2070 6174 6820 666f 7220 7468  tory path for th
+0000aa10: 6520 6e65 7720 6461 7461 7365 740a 2020  e new dataset.  
+0000aa20: 2020 2020 2020 3a74 7970 6520 726f 695f        :type roi_
+0000aa30: 6469 723a 2073 7472 0a20 2020 2020 2020  dir: str.       
+0000aa40: 203a 7265 7475 726e 733a 2064 6174 6173   :returns: datas
+0000aa50: 6574 2077 6974 6820 6461 7461 2077 6974  et with data wit
+0000aa60: 6820 726f 6920 6170 706c 6965 642e 0a20  h roi applied.. 
+0000aa70: 2020 2020 2020 2020 2020 204e 6f74 653a             Note:
+0000aa80: 2054 6f20 7072 6573 6572 7665 2063 6f6e   To preserve con
+0000aa90: 7369 7374 656e 6365 206f 6620 7368 6170  sistence of shap
+0000aaa0: 6520 6265 7477 6565 6e20 696d 6167 6573  e between images
+0000aab0: 2c20 6966 2060 696e 6469 6365 7360 0a20  , if `indices`. 
+0000aac0: 2020 2020 2020 2020 2020 2069 7320 6e6f             is no
+0000aad0: 7420 4e6f 6e65 2c20 6f6e 6c79 2074 6865  t None, only the
+0000aae0: 2064 6174 6120 6d6f 6469 6669 6564 2069   data modified i
+0000aaf0: 7320 7265 7475 726e 6564 2e0a 2020 2020  s returned..    
+0000ab00: 2020 2020 3a72 7479 7065 3a20 4461 7461      :rtype: Data
+0000ab10: 7365 740a 2020 2020 2020 2020 2222 220a  set.        """.
+0000ab20: 0a20 2020 2020 2020 2072 6f69 5f64 6972  .        roi_dir
+0000ab30: 203d 2073 656c 662e 6469 7220 6966 2072   = self.dir if r
+0000ab40: 6f69 5f64 6972 2069 7320 4e6f 6e65 2065  oi_dir is None e
+0000ab50: 6c73 6520 726f 695f 6469 720a 2020 2020  lse roi_dir.    
+0000ab60: 2020 2020 6f73 2e6d 616b 6564 6972 7328      os.makedirs(
+0000ab70: 726f 695f 6469 722c 2065 7869 7374 5f6f  roi_dir, exist_o
+0000ab80: 6b3d 5472 7565 290a 0a20 2020 2020 2020  k=True)..       
+0000ab90: 2073 656c 662e 7275 6e6e 696e 675f 6461   self.running_da
+0000aba0: 7461 203d 2073 656c 662e 6765 745f 6461  ta = self.get_da
+0000abb0: 7461 2869 6e64 6963 6573 290a 2020 2020  ta(indices).    
+0000abc0: 2020 2020 6966 2073 656c 662e 5f69 6e5f      if self._in_
+0000abd0: 6d65 6d6f 7279 3a0a 2020 2020 2020 2020  memory:.        
+0000abe0: 2020 2020 6e65 775f 6461 7461 203d 2028      new_data = (
+0000abf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ac00: 2061 7070 6c79 5f33 445f 524f 4928 7365   apply_3D_ROI(se
+0000ac10: 6c66 2e72 756e 6e69 6e67 5f64 6174 612c  lf.running_data,
+0000ac20: 206f 7269 6769 6e2c 2073 697a 652c 2063   origin, size, c
+0000ac30: 656e 7465 7229 2e76 6965 7728 4461 7461  enter).view(Data
+0000ac40: 292e 636f 7079 2829 0a20 2020 2020 2020  ).copy().       
+0000ac50: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0000ac60: 2020 206e 6577 5f64 6174 612e 7361 7665     new_data.save
+0000ac70: 286f 732e 7061 7468 2e6a 6f69 6e28 726f  (os.path.join(ro
+0000ac80: 695f 6469 722c 2022 6461 7461 2e68 6466  i_dir, "data.hdf
+0000ac90: 3522 292c 206e 6577 5f73 6861 7065 3d6e  5"), new_shape=n
+0000aca0: 6577 5f64 6174 612e 7368 6170 6529 0a20  ew_data.shape). 
+0000acb0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000acc0: 2020 2020 2020 2020 2073 6861 7065 203d           shape =
+0000acd0: 206e 756d 7079 2e61 7070 656e 6428 0a20   numpy.append(. 
+0000ace0: 2020 2020 2020 2020 2020 2020 2020 205b                 [
+0000acf0: 7365 6c66 2e72 756e 6e69 6e67 5f64 6174  self.running_dat
+0000ad00: 612e 7368 6170 655b 305d 5d2c 0a20 2020  a.shape[0]],.   
+0000ad10: 2020 2020 2020 2020 2020 2020 2061 7070               app
+0000ad20: 6c79 5f32 445f 524f 4928 7365 6c66 2e72  ly_2D_ROI(self.r
+0000ad30: 756e 6e69 6e67 5f64 6174 615b 305d 2c20  unning_data[0], 
+0000ad40: 6f72 6967 696e 2c20 7369 7a65 2c20 6365  origin, size, ce
+0000ad50: 6e74 6572 292e 7368 6170 652c 0a20 2020  nter).shape,.   
+0000ad60: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000ad70: 2020 2020 2020 2075 726c 7320 3d20 7365         urls = se
+0000ad80: 6c66 2e72 756e 6e69 6e67 5f64 6174 612e  lf.running_data.
+0000ad90: 6170 706c 795f 6675 6e63 7328 0a20 2020  apply_funcs(.   
+0000ada0: 2020 2020 2020 2020 2020 2020 205b 2861               [(a
+0000adb0: 7070 6c79 5f32 445f 524f 492c 205b 6f72  pply_2D_ROI, [or
+0000adc0: 6967 696e 2c20 7369 7a65 2c20 6365 6e74  igin, size, cent
+0000add0: 6572 5d29 5d2c 0a20 2020 2020 2020 2020  er])],.         
+0000ade0: 2020 2020 2020 2073 6176 653d 6f73 2e70         save=os.p
+0000adf0: 6174 682e 6a6f 696e 2872 6f69 5f64 6972  ath.join(roi_dir
+0000ae00: 2c20 2264 6174 612e 6864 6635 2229 2c0a  , "data.hdf5"),.
+0000ae10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ae20: 7465 7874 3d22 4170 706c 7969 6e67 2072  text="Applying r
+0000ae30: 6f69 222c 0a20 2020 2020 2020 2020 2020  oi",.           
+0000ae40: 2020 2020 206f 7065 7261 7469 6f6e 3d4f       operation=O
+0000ae50: 7065 7261 7469 6f6e 2e52 4f49 2c0a 2020  peration.ROI,.  
+0000ae60: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+0000ae70: 775f 7368 6170 653d 7368 6170 652c 0a20  w_shape=shape,. 
+0000ae80: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0000ae90: 2020 2020 2020 2020 2069 6620 7572 6c73           if urls
+0000aea0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0000aeb0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000aec0: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
+0000aed0: 5f64 6174 6120 3d20 4461 7461 2875 726c  _data = Data(url
+0000aee0: 732c 2073 656c 662e 7275 6e6e 696e 675f  s, self.running_
+0000aef0: 6461 7461 2e6d 6574 6164 6174 612c 2073  data.metadata, s
+0000af00: 656c 662e 5f69 6e5f 6d65 6d6f 7279 290a  elf._in_memory).
+0000af10: 0a20 2020 2020 2020 2074 7261 6e73 666f  .        transfo
+0000af20: 726d 6174 696f 6e20 3d20 7365 6c66 2e74  rmation = self.t
+0000af30: 7261 6e73 666f 726d 6174 696f 6e0a 2020  ransformation.  
+0000af40: 2020 2020 2020 6966 2074 7261 6e73 666f        if transfo
+0000af50: 726d 6174 696f 6e20 6973 206e 6f74 204e  rmation is not N
+0000af60: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000af70: 2074 7261 6e73 666f 726d 6174 696f 6e20   transformation 
+0000af80: 3d20 5472 616e 7366 6f72 6d61 7469 6f6e  = Transformation
+0000af90: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000afa0: 2020 7472 616e 7366 6f72 6d61 7469 6f6e    transformation
+0000afb0: 2e6b 696e 642c 0a20 2020 2020 2020 2020  .kind,.         
+0000afc0: 2020 2020 2020 2061 7070 6c79 5f32 445f         apply_2D_
+0000afd0: 524f 4928 7472 616e 7366 6f72 6d61 7469  ROI(transformati
+0000afe0: 6f6e 2e78 2c20 6f72 6967 696e 2c20 7369  on.x, origin, si
+0000aff0: 7a65 2c20 6365 6e74 6572 292c 0a20 2020  ze, center),.   
+0000b000: 2020 2020 2020 2020 2020 2020 2061 7070               app
+0000b010: 6c79 5f32 445f 524f 4928 7472 616e 7366  ly_2D_ROI(transf
+0000b020: 6f72 6d61 7469 6f6e 2e79 2c20 6f72 6967  ormation.y, orig
+0000b030: 696e 2c20 7369 7a65 2c20 6365 6e74 6572  in, size, center
+0000b040: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0000b050: 2020 2074 7261 6e73 666f 726d 6174 696f     transformatio
+0000b060: 6e2e 726f 7461 7465 2c0a 2020 2020 2020  n.rotate,.      
+0000b070: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000b080: 2069 6620 696e 6469 6365 7320 6973 204e   if indices is N
+0000b090: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000b0a0: 2073 6861 7065 203d 206c 6973 7428 7365   shape = list(se
+0000b0b0: 6c66 2e64 6174 612e 7368 6170 6529 5b3a  lf.data.shape)[:
+0000b0c0: 2d32 5d0a 2020 2020 2020 2020 2020 2020  -2].            
+0000b0d0: 7368 6170 652e 6170 7065 6e64 286e 6577  shape.append(new
+0000b0e0: 5f64 6174 612e 7368 6170 655b 2d32 5d29  _data.shape[-2])
+0000b0f0: 0a20 2020 2020 2020 2020 2020 2073 6861  .            sha
+0000b100: 7065 2e61 7070 656e 6428 6e65 775f 6461  pe.append(new_da
+0000b110: 7461 2e73 6861 7065 5b2d 315d 290a 2020  ta.shape[-1]).  
+0000b120: 2020 2020 2020 2020 2020 6e65 775f 6461            new_da
+0000b130: 7461 203d 206e 6577 5f64 6174 612e 7265  ta = new_data.re
+0000b140: 7368 6170 6528 7368 6170 6529 0a20 2020  shape(shape).   
+0000b150: 2020 2020 2072 6574 7572 6e20 4461 7461       return Data
+0000b160: 7365 7428 0a20 2020 2020 2020 2020 2020  set(.           
+0000b170: 205f 6469 723d 726f 695f 6469 722c 0a20   _dir=roi_dir,. 
+0000b180: 2020 2020 2020 2020 2020 2064 6174 613d             data=
+0000b190: 6e65 775f 6461 7461 2c0a 2020 2020 2020  new_data,.      
+0000b1a0: 2020 2020 2020 6469 6d73 3d73 656c 662e        dims=self.
+0000b1b0: 5f5f 6469 6d73 2c0a 2020 2020 2020 2020  __dims,.        
+0000b1c0: 2020 2020 7472 616e 7366 6f72 6d61 7469      transformati
+0000b1d0: 6f6e 3d74 7261 6e73 666f 726d 6174 696f  on=transformatio
+0000b1e0: 6e2c 0a20 2020 2020 2020 2020 2020 2069  n,.            i
+0000b1f0: 6e5f 6d65 6d6f 7279 3d73 656c 662e 5f69  n_memory=self._i
+0000b200: 6e5f 6d65 6d6f 7279 2c0a 2020 2020 2020  n_memory,.      
+0000b210: 2020 2020 2020 7469 746c 653d 7365 6c66        title=self
+0000b220: 2e74 6974 6c65 2c0a 2020 2020 2020 2020  .title,.        
+0000b230: 290a 0a20 2020 2064 6566 2066 696e 645f  )..    def find_
+0000b240: 7368 6966 7428 7365 6c66 2c20 6469 6d65  shift(self, dime
+0000b250: 6e73 696f 6e3d 4e6f 6e65 2c20 7374 6570  nsion=None, step
+0000b260: 733d 3530 2c20 696e 6469 6365 733d 4e6f  s=50, indices=No
+0000b270: 6e65 293a 0a20 2020 2020 2020 2022 2222  ne):.        """
+0000b280: 0a20 2020 2020 2020 2046 696e 6420 7368  .        Find sh
+0000b290: 6966 7420 6f66 2074 6865 2064 6174 6120  ift of the data 
+0000b2a0: 6f72 2070 6172 7420 6f66 2069 742e 0a0a  or part of it...
+0000b2b0: 2020 2020 2020 2020 3a70 6172 616d 2064          :param d
+0000b2c0: 696d 656e 7369 6f6e 3a20 5061 7261 6d65  imension: Parame
+0000b2d0: 7465 7273 2077 6974 6820 7468 6520 706f  ters with the po
+0000b2e0: 7369 7469 6f6e 206f 6620 7468 6520 6461  sition of the da
+0000b2f0: 7461 2069 6e20 7468 6520 7265 7368 6170  ta in the reshap
+0000b300: 6564 0a20 2020 2020 2020 2020 2020 2061  ed.            a
+0000b310: 7272 6179 2e0a 2020 2020 2020 2020 3a74  rray..        :t
+0000b320: 7970 6520 6469 6d65 6e73 696f 6e3a 2055  ype dimension: U
+0000b330: 6e69 6f6e 5b4e 6f6e 652c 2074 7570 6c65  nion[None, tuple
+0000b340: 2c20 6172 7261 795f 6c69 6b65 5d0a 2020  , array_like].  
+0000b350: 2020 2020 2020 3a70 6172 616d 2066 6c6f        :param flo
+0000b360: 6174 2068 5f6d 6178 3a20 5365 6520 6063  at h_max: See `c
+0000b370: 6f72 652e 696d 6167 6552 6567 6973 7472  ore.imageRegistr
+0000b380: 6174 696f 6e2e 7368 6966 745f 6465 7465  ation.shift_dete
+0000b390: 6374 696f 6e60 0a20 2020 2020 2020 203a  ction`.        :
+0000b3a0: 7061 7261 6d20 666c 6f61 7420 685f 7374  param float h_st
+0000b3b0: 6570 3a20 5365 6520 6063 6f72 652e 696d  ep: See `core.im
+0000b3c0: 6167 6552 6567 6973 7472 6174 696f 6e2e  ageRegistration.
+0000b3d0: 7368 6966 745f 6465 7465 6374 696f 6e60  shift_detection`
+0000b3e0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0000b3f0: 696e 6469 6365 733a 2042 6f6f 6c65 616e  indices: Boolean
+0000b400: 2069 6e64 6578 206c 6973 7420 7769 7468   index list with
+0000b410: 2054 7275 6520 696e 2074 6865 2069 6d61   True in the ima
+0000b420: 6765 7320 746f 2061 7070 6c79 2074 6865  ges to apply the
+0000b430: 2073 6869 6674 2074 6f2e 0a20 2020 2020   shift to..     
+0000b440: 2020 2020 2020 2049 6620 4e6f 6e65 2c20         If None, 
+0000b450: 7468 6520 686f 7420 7069 7865 6c20 7265  the hot pixel re
+0000b460: 6d6f 7661 6c20 6973 2061 7070 6c69 6564  moval is applied
+0000b470: 2074 6f20 616c 6c20 7468 6520 6461 7461   to all the data
+0000b480: 2e0a 2020 2020 2020 2020 3a74 7970 6520  ..        :type 
+0000b490: 696e 6469 6365 733a 2055 6e69 6f6e 5b4e  indices: Union[N
+0000b4a0: 6f6e 652c 2061 7272 6179 5f6c 696b 655d  one, array_like]
+0000b4b0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+0000b4c0: 733a 2041 7272 6179 2077 6974 6820 7368  s: Array with sh
+0000b4d0: 6966 7420 7065 7220 6672 616d 652e 0a20  ift per frame.. 
+0000b4e0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0000b4f0: 2020 2064 6174 6120 3d20 7365 6c66 2e67     data = self.g
+0000b500: 6574 5f64 6174 6128 696e 6469 6365 733d  et_data(indices=
+0000b510: 696e 6469 6365 732c 2064 696d 656e 7369  indices, dimensi
+0000b520: 6f6e 3d64 696d 656e 7369 6f6e 290a 2020  on=dimension).  
+0000b530: 2020 2020 2020 7265 7475 726e 2073 6869        return shi
+0000b540: 6674 5f64 6574 6563 7469 6f6e 2864 6174  ft_detection(dat
+0000b550: 612c 2073 7465 7073 290a 0a20 2020 2064  a, steps)..    d
+0000b560: 6566 2066 696e 645f 7368 6966 745f 616c  ef find_shift_al
+0000b570: 6f6e 675f 6469 6d65 6e73 696f 6e28 7365  ong_dimension(se
+0000b580: 6c66 2c20 6469 6d65 6e73 696f 6e2c 2073  lf, dimension, s
+0000b590: 7465 7073 3d35 302c 2069 6e64 6963 6573  teps=50, indices
+0000b5a0: 3d4e 6f6e 6529 3a0a 2020 2020 2020 2020  =None):.        
+0000b5b0: 7368 6966 7420 3d20 5b5d 0a20 2020 2020  shift = [].     
+0000b5c0: 2020 2066 6f72 2076 616c 7565 2069 6e20     for value in 
+0000b5d0: 7261 6e67 6528 7365 6c66 2e64 696d 732e  range(self.dims.
+0000b5e0: 6765 7428 6469 6d65 6e73 696f 6e5b 305d  get(dimension[0]
+0000b5f0: 292e 7369 7a65 293a 0a20 2020 2020 2020  ).size):.       
+0000b600: 2020 2020 2073 6869 6674 2e61 7070 656e       shift.appen
+0000b610: 6428 7365 6c66 2e66 696e 645f 7368 6966  d(self.find_shif
+0000b620: 7428 5b64 696d 656e 7369 6f6e 5b30 5d2c  t([dimension[0],
+0000b630: 2076 616c 7565 5d2c 2073 7465 7073 2c20   value], steps, 
+0000b640: 696e 6469 6365 7329 290a 2020 2020 2020  indices)).      
+0000b650: 2020 7265 7475 726e 206e 756d 7079 2e61    return numpy.a
+0000b660: 7272 6179 2873 6869 6674 290a 0a20 2020  rray(shift)..   
+0000b670: 2064 6566 2061 7070 6c79 5f73 6869 6674   def apply_shift
+0000b680: 5f61 6c6f 6e67 5f64 696d 656e 7369 6f6e  _along_dimension
+0000b690: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+0000b6a0: 2020 2020 2020 2020 7368 6966 742c 0a20          shift,. 
+0000b6b0: 2020 2020 2020 2064 696d 656e 7369 6f6e         dimension
+0000b6c0: 2c0a 2020 2020 2020 2020 7368 6966 745f  ,.        shift_
+0000b6d0: 6170 7072 6f61 6368 3d22 6666 7422 2c0a  approach="fft",.
+0000b6e0: 2020 2020 2020 2020 696e 6469 6365 733d          indices=
+0000b6f0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6361  None,.        ca
+0000b700: 6c6c 6261 636b 3d4e 6f6e 652c 0a20 2020  llback=None,.   
+0000b710: 2020 2020 205f 6469 723d 4e6f 6e65 2c0a       _dir=None,.
+0000b720: 2020 2020 293a 0a20 2020 2020 2020 2064      ):.        d
+0000b730: 6174 6173 6574 203d 2073 656c 660a 2020  ataset = self.  
+0000b740: 2020 2020 2020 666f 7220 7661 6c75 6520        for value 
+0000b750: 696e 2072 616e 6765 2873 656c 662e 6469  in range(self.di
+0000b760: 6d73 2e67 6574 2864 696d 656e 7369 6f6e  ms.get(dimension
+0000b770: 5b30 5d29 2e73 697a 6529 3a0a 2020 2020  [0]).size):.    
+0000b780: 2020 2020 2020 2020 6461 7461 2c20 7269          data, ri
+0000b790: 6e64 6963 6573 203d 2073 656c 662e 6765  ndices = self.ge
+0000b7a0: 745f 6461 7461 280a 2020 2020 2020 2020  t_data(.        
+0000b7b0: 2020 2020 2020 2020 696e 6469 6365 733d          indices=
+0000b7c0: 696e 6469 6365 732c 2064 696d 656e 7369  indices, dimensi
+0000b7d0: 6f6e 3d5b 6469 6d65 6e73 696f 6e5b 305d  on=[dimension[0]
+0000b7e0: 2c20 7661 6c75 655d 2c20 7265 7475 726e  , value], return
+0000b7f0: 5f69 6e64 6963 6573 3d54 7275 650a 2020  _indices=True.  
+0000b800: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000b810: 2020 2020 2020 2020 6672 616d 6573 203d          frames =
+0000b820: 206e 756d 7079 2e61 7261 6e67 6528 0a20   numpy.arange(. 
+0000b830: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000b840: 656c 662e 6765 745f 6461 7461 2869 6e64  elf.get_data(ind
+0000b850: 6963 6573 3d69 6e64 6963 6573 2c20 6469  ices=indices, di
+0000b860: 6d65 6e73 696f 6e3d 5b64 696d 656e 7369  mension=[dimensi
+0000b870: 6f6e 5b30 5d2c 2076 616c 7565 5d29 2e73  on[0], value]).s
+0000b880: 6861 7065 5b30 5d0a 2020 2020 2020 2020  hape[0].        
+0000b890: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0000b8a0: 2020 6461 7461 7365 7420 3d20 6461 7461    dataset = data
+0000b8b0: 7365 742e 6170 706c 795f 7368 6966 7428  set.apply_shift(
+0000b8c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b8d0: 206e 756d 7079 2e6f 7574 6572 2873 6869   numpy.outer(shi
+0000b8e0: 6674 5b76 616c 7565 5d2c 2066 7261 6d65  ft[value], frame
+0000b8f0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+0000b900: 2020 2020 5b64 696d 656e 7369 6f6e 5b30      [dimension[0
+0000b910: 5d2c 2076 616c 7565 5d2c 0a20 2020 2020  ], value],.     
+0000b920: 2020 2020 2020 2020 2020 2073 6869 6674             shift
+0000b930: 5f61 7070 726f 6163 682c 0a20 2020 2020  _approach,.     
+0000b940: 2020 2020 2020 2020 2020 2069 6e64 6963             indic
+0000b950: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+0000b960: 2020 2020 6361 6c6c 6261 636b 2c0a 2020      callback,.  
+0000b970: 2020 2020 2020 2020 2020 2020 2020 5f64                _d
+0000b980: 6972 2c0a 2020 2020 2020 2020 2020 2020  ir,.            
+0000b990: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+0000b9a0: 6e20 6461 7461 7365 740a 0a20 2020 2064  n dataset..    d
+0000b9b0: 6566 2061 7070 6c79 5f73 6869 6674 280a  ef apply_shift(.
+0000b9c0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+0000b9d0: 2020 2020 2020 7368 6966 742c 0a20 2020        shift,.   
+0000b9e0: 2020 2020 2064 696d 656e 7369 6f6e 3d4e       dimension=N
+0000b9f0: 6f6e 652c 0a20 2020 2020 2020 2073 6869  one,.        shi
+0000ba00: 6674 5f61 7070 726f 6163 683d 2266 6674  ft_approach="fft
+0000ba10: 222c 0a20 2020 2020 2020 2069 6e64 6963  ",.        indic
+0000ba20: 6573 3d4e 6f6e 652c 0a20 2020 2020 2020  es=None,.       
+0000ba30: 2063 616c 6c62 6163 6b3d 4e6f 6e65 2c0a   callback=None,.
+0000ba40: 2020 2020 2020 2020 5f64 6972 3d4e 6f6e          _dir=Non
+0000ba50: 652c 0a20 2020 2029 3a0a 2020 2020 2020  e,.    ):.      
+0000ba60: 2020 2222 220a 2020 2020 2020 2020 4170    """.        Ap
+0000ba70: 706c 7920 7368 6966 7420 6f66 2074 6865  ply shift of the
+0000ba80: 2064 6174 6120 6f72 2070 6172 7420 6f66   data or part of
+0000ba90: 2069 7420 616e 6420 7361 7665 206e 6577   it and save new
+0000baa0: 2064 6174 6120 696e 746f 2064 6973 6b2e   data into disk.
+0000bab0: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+0000bac0: 2061 7272 6179 5f6c 696b 6520 7368 6966   array_like shif
+0000bad0: 743a 2053 6869 6674 2070 6572 2066 7261  t: Shift per fra
+0000bae0: 6d65 2e0a 2020 2020 2020 2020 3a70 6172  me..        :par
+0000baf0: 616d 2064 696d 656e 7369 6f6e 3a20 5061  am dimension: Pa
+0000bb00: 7261 6d65 7465 7320 7769 7468 2074 6865  rametes with the
+0000bb10: 2070 6f73 6974 696f 6e20 6f66 2074 6865   position of the
+0000bb20: 2064 6174 6120 696e 2074 6865 2072 6573   data in the res
+0000bb30: 6861 7065 640a 2020 2020 2020 2020 2020  haped.          
+0000bb40: 2020 6172 7261 792e 0a20 2020 2020 2020    array..       
+0000bb50: 203a 7479 7065 2064 696d 656e 7369 6f6e   :type dimension
+0000bb60: 3a20 556e 696f 6e5b 4e6f 6e65 2c20 7475  : Union[None, tu
+0000bb70: 706c 652c 2061 7272 6179 5f6c 696b 655d  ple, array_like]
+0000bb80: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0000bb90: 556e 696f 6e5b 2766 6674 272c 2027 6c69  Union['fft', 'li
+0000bba0: 6e65 6172 275d 2073 6869 6674 5f61 7070  near'] shift_app
+0000bbb0: 726f 6163 683a 204d 6574 686f 6420 746f  roach: Method to
+0000bbc0: 2075 7365 2074 6f20 6170 706c 7920 7468   use to apply th
+0000bbd0: 6520 7368 6966 742e 0a20 2020 2020 2020  e shift..       
+0000bbe0: 203a 7061 7261 6d20 696e 6469 6365 733a   :param indices:
+0000bbf0: 2042 6f6f 6c65 616e 2069 6e64 6578 206c   Boolean index l
+0000bc00: 6973 7420 7769 7468 2054 7275 6520 696e  ist with True in
+0000bc10: 2074 6865 2069 6d61 6765 7320 746f 2061   the images to a
+0000bc20: 7070 6c79 2074 6865 2073 6869 6674 2074  pply the shift t
+0000bc30: 6f2e 0a20 2020 2020 2020 2020 2020 2049  o..            I
+0000bc40: 6620 4e6f 6e65 2c20 7468 6520 686f 7420  f None, the hot 
+0000bc50: 7069 7865 6c20 7265 6d6f 7661 6c20 6973  pixel removal is
+0000bc60: 2061 7070 6c69 6564 2074 6f20 616c 6c20   applied to all 
+0000bc70: 7468 6520 6461 7461 2e0a 2020 2020 2020  the data..      
+0000bc80: 2020 3a74 7970 6520 696e 6469 6365 733a    :type indices:
+0000bc90: 2055 6e69 6f6e 5b4e 6f6e 652c 2061 7272   Union[None, arr
+0000bca0: 6179 5f6c 696b 655d 0a20 2020 2020 2020  ay_like].       
+0000bcb0: 203a 7061 7261 6d20 556e 696f 6e5b 6675   :param Union[fu
+0000bcc0: 6e63 7469 6f6e 2c20 4e6f 6e65 5d20 6361  nction, None] ca
+0000bcd0: 6c6c 6261 636b 3a20 4361 6c6c 6261 636b  llback: Callback
+0000bce0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+0000bcf0: 733a 2064 6174 6173 6574 2077 6974 6820  s: dataset with 
+0000bd00: 6461 7461 206f 6620 7361 6d65 2073 697a  data of same siz
+0000bd10: 6520 6173 2060 7365 6c66 2e64 6174 6160  e as `self.data`
+0000bd20: 2062 7574 2077 6974 6820 7468 650a 2020   but with the.  
+0000bd30: 2020 2020 2020 2020 2020 6d6f 6469 6669            modifi
+0000bd40: 6564 2069 6d61 6765 732e 2054 6865 2075  ed images. The u
+0000bd50: 726c 7320 6f66 2074 6865 206d 6f64 6966  rls of the modif
+0000bd60: 6965 6420 696d 6167 6573 2061 7265 2072  ied images are r
+0000bd70: 6570 6c61 6365 6420 7769 7468 0a20 2020  eplaced with.   
+0000bd80: 2020 2020 2020 2020 2074 6865 206e 6577           the new
+0000bd90: 2075 726c 732e 0a20 2020 2020 2020 2022   urls..        "
+0000bda0: 2222 0a20 2020 2020 2020 2061 7373 6572  "".        asser
+0000bdb0: 7420 6c65 6e28 7368 6966 7429 203e 2030  t len(shift) > 0
+0000bdc0: 2c20 2253 6869 6674 206c 6973 7420 6361  , "Shift list ca
+0000bdd0: 6e27 7420 6265 2065 6d70 7479 220a 0a20  n't be empty".. 
+0000bde0: 2020 2020 2020 2069 6620 6e6f 7420 6e75         if not nu
+0000bdf0: 6d70 792e 616e 7928 7368 6966 7429 3a0a  mpy.any(shift):.
+0000be00: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000be10: 726e 2073 656c 660a 0a20 2020 2020 2020  rn self..       
+0000be20: 205f 6469 7220 3d20 7365 6c66 2e64 6972   _dir = self.dir
+0000be30: 2069 6620 5f64 6972 2069 7320 4e6f 6e65   if _dir is None
+0000be40: 2065 6c73 6520 5f64 6972 0a0a 2020 2020   else _dir..    
+0000be50: 2020 2020 6f73 2e6d 616b 6564 6972 7328      os.makedirs(
+0000be60: 5f64 6972 2c20 6578 6973 745f 6f6b 3d54  _dir, exist_ok=T
+0000be70: 7275 6529 0a0a 2020 2020 2020 2020 6461  rue)..        da
+0000be80: 7461 2c20 7269 6e64 6963 6573 203d 2073  ta, rindices = s
+0000be90: 656c 662e 6765 745f 6461 7461 2869 6e64  elf.get_data(ind
+0000bea0: 6963 6573 2c20 6469 6d65 6e73 696f 6e2c  ices, dimension,
+0000beb0: 2072 6574 7572 6e5f 696e 6469 6365 733d   return_indices=
+0000bec0: 5472 7565 290a 0a20 2020 2020 2020 2077  True)..        w
+0000bed0: 6974 6820 7365 6c66 2e73 7461 7465 5f6f  ith self.state_o
+0000bee0: 665f 6f70 6572 6174 696f 6e73 2e72 756e  f_operations.run
+0000bef0: 5f63 6f6e 7465 7874 284f 7065 7261 7469  _context(Operati
+0000bf00: 6f6e 2e53 4849 4654 293a 0a20 2020 2020  on.SHIFT):.     
+0000bf10: 2020 2020 2020 205f 6669 6c65 203d 204e         _file = N
+0000bf20: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+0000bf30: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000bf40: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0000bf50: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+0000bf60: 6c65 6e61 6d65 203d 206f 732e 7061 7468  lename = os.path
+0000bf70: 2e6a 6f69 6e28 5f64 6972 2c20 2264 6174  .join(_dir, "dat
+0000bf80: 612e 6864 6635 2229 0a20 2020 2020 2020  a.hdf5").       
+0000bf90: 2020 2020 2020 2020 2020 2020 205f 6669               _fi
+0000bfa0: 6c65 203d 2068 3570 792e 4669 6c65 2866  le = h5py.File(f
+0000bfb0: 696c 656e 616d 652c 2022 6122 290a 2020  ilename, "a").  
+0000bfc0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+0000bfd0: 6365 7074 204f 5345 7272 6f72 3a0a 2020  cept OSError:.  
+0000bfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bff0: 2020 6966 206f 732e 7061 7468 2e65 7869    if os.path.exi
+0000c000: 7374 7328 6669 6c65 6e61 6d65 293a 0a20  sts(filename):. 
+0000c010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c020: 2020 2020 2020 206f 732e 7265 6d6f 7665         os.remove
+0000c030: 2866 696c 656e 616d 6529 0a20 2020 2020  (filename).     
+0000c040: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+0000c050: 6669 6c65 203d 2068 3570 792e 4669 6c65  file = h5py.File
+0000c060: 2866 696c 656e 616d 652c 2022 7722 290a  (filename, "w").
+0000c070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c080: 6461 7461 7365 745f 6e61 6d65 203d 2022  dataset_name = "
+0000c090: 6461 7461 7365 7422 0a20 2020 2020 2020  dataset".       
+0000c0a0: 2020 2020 2020 2020 2069 6620 2264 6174           if "dat
+0000c0b0: 6173 6574 2220 6e6f 7420 696e 205f 6669  aset" not in _fi
+0000c0c0: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
+0000c0d0: 2020 2020 2020 2020 5f66 696c 652e 6372          _file.cr
+0000c0e0: 6561 7465 5f64 6174 6173 6574 280a 2020  eate_dataset(.  
+0000c0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c100: 2020 2020 2020 2264 6174 6173 6574 222c        "dataset",
+0000c110: 2073 656c 662e 6765 745f 6461 7461 2829   self.get_data()
+0000c120: 2e73 6861 7065 2c20 6474 7970 653d 7365  .shape, dtype=se
+0000c130: 6c66 2e64 6174 612e 6474 7970 650a 2020  lf.data.dtype.  
+0000c140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c150: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0000c160: 2020 2020 656c 6966 2073 656c 662e 6765      elif self.ge
+0000c170: 745f 6461 7461 2829 2e73 6861 7065 2021  t_data().shape !
+0000c180: 3d20 5f66 696c 655b 2264 6174 6173 6574  = _file["dataset
+0000c190: 225d 2e73 6861 7065 3a0a 2020 2020 2020  "].shape:.      
+0000c1a0: 2020 2020 2020 2020 2020 2020 2020 6465                de
+0000c1b0: 6c20 5f66 696c 655b 2264 6174 6173 6574  l _file["dataset
+0000c1c0: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
+0000c1d0: 2020 2020 2020 205f 6669 6c65 2e63 7265         _file.cre
+0000c1e0: 6174 655f 6461 7461 7365 7428 0a20 2020  ate_dataset(.   
+0000c1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c200: 2020 2020 2022 6461 7461 7365 7422 2c20       "dataset", 
+0000c210: 7365 6c66 2e67 6574 5f64 6174 6128 292e  self.get_data().
+0000c220: 7368 6170 652c 2064 7479 7065 3d73 656c  shape, dtype=sel
+0000c230: 662e 6461 7461 2e64 7479 7065 0a20 2020  f.data.dtype.   
+0000c240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c250: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0000c260: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000c270: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+0000c280: 6173 6574 5f6e 616d 6520 3d20 2275 7064  aset_name = "upd
+0000c290: 6174 655f 6461 7461 7365 7422 0a20 2020  ate_dataset".   
+0000c2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c2b0: 205f 6669 6c65 2e63 6f70 7928 2264 6174   _file.copy("dat
+0000c2c0: 6173 6574 222c 2022 7570 6461 7465 5f64  aset", "update_d
+0000c2d0: 6174 6173 6574 2229 0a0a 2020 2020 2020  ataset")..      
+0000c2e0: 2020 2020 2020 2020 2020 696f 5f75 7469            io_uti
+0000c2f0: 6c73 2e61 6476 616e 6365 6d65 6e74 5f64  ls.advancement_d
+0000c300: 6973 706c 6179 2830 2c20 6c65 6e28 6461  isplay(0, len(da
+0000c310: 7461 292c 2022 4170 706c 7969 6e67 2073  ta), "Applying s
+0000c320: 6869 6674 2229 0a20 2020 2020 2020 2020  hift").         
+0000c330: 2020 2020 2020 2069 6620 6469 6d65 6e73         if dimens
+0000c340: 696f 6e20 6973 206e 6f74 204e 6f6e 653a  ion is not None:
+0000c350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c360: 2020 2020 2023 2043 6f6e 7665 7274 2064       # Convert d
+0000c370: 696d 656e 7369 6f6e 2061 6e64 2076 616c  imension and val
+0000c380: 7565 2069 6e74 6f20 6c69 7374 0a20 2020  ue into list.   
+0000c390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c3a0: 2069 6620 7479 7065 2864 696d 656e 7369   if type(dimensi
+0000c3b0: 6f6e 5b30 5d29 2069 7320 696e 743a 0a20  on[0]) is int:. 
 0000c3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c3d0: 2020 2020 2320 436f 6e76 6572 7420 6469      # Convert di
-0000c3e0: 6d65 6e73 696f 6e20 616e 6420 7661 6c75  mension and valu
-0000c3f0: 6520 696e 746f 206c 6973 740a 2020 2020  e into list.    
-0000c400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c410: 6966 2074 7970 6528 6469 6d65 6e73 696f  if type(dimensio
-0000c420: 6e5b 305d 2920 6973 2069 6e74 3a0a 2020  n[0]) is int:.  
-0000c430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c440: 2020 2020 2020 6469 6d65 6e73 696f 6e5b        dimension[
-0000c450: 305d 203d 205b 6469 6d65 6e73 696f 6e5b  0] = [dimension[
-0000c460: 305d 5d0a 2020 2020 2020 2020 2020 2020  0]].            
-0000c470: 2020 2020 2020 2020 2020 2020 6469 6d65              dime
-0000c480: 6e73 696f 6e5b 315d 203d 205b 6469 6d65  nsion[1] = [dime
-0000c490: 6e73 696f 6e5b 315d 5d0a 2020 2020 2020  nsion[1]].      
-0000c4a0: 2020 2020 2020 2020 2020 2020 2020 7572                ur
-0000c4b0: 6c73 203d 205b 5d0a 2020 2020 2020 2020  ls = [].        
-0000c4c0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000c4d0: 692c 2069 6478 2069 6e20 656e 756d 6572  i, idx in enumer
-0000c4e0: 6174 6528 7269 6e64 6963 6573 293a 0a20  ate(rindices):. 
-0000c4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c500: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
-0000c510: 6c66 2e73 7461 7465 5f6f 665f 6f70 6572  lf.state_of_oper
-0000c520: 6174 696f 6e73 2e69 735f 7275 6e6e 696e  ations.is_runnin
-0000c530: 6728 4f70 6572 6174 696f 6e2e 5348 4946  g(Operation.SHIF
-0000c540: 5429 3a0a 2020 2020 2020 2020 2020 2020  T):.            
+0000c3d0: 2020 2020 2020 2064 696d 656e 7369 6f6e         dimension
+0000c3e0: 5b30 5d20 3d20 5b64 696d 656e 7369 6f6e  [0] = [dimension
+0000c3f0: 5b30 5d5d 0a20 2020 2020 2020 2020 2020  [0]].           
+0000c400: 2020 2020 2020 2020 2020 2020 2064 696d               dim
+0000c410: 656e 7369 6f6e 5b31 5d20 3d20 5b64 696d  ension[1] = [dim
+0000c420: 656e 7369 6f6e 5b31 5d5d 0a20 2020 2020  ension[1]].     
+0000c430: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+0000c440: 726c 7320 3d20 5b5d 0a20 2020 2020 2020  rls = [].       
+0000c450: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0000c460: 2069 2c20 6964 7820 696e 2065 6e75 6d65   i, idx in enume
+0000c470: 7261 7465 2872 696e 6469 6365 7329 3a0a  rate(rindices):.
+0000c480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c490: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+0000c4a0: 656c 662e 7374 6174 655f 6f66 5f6f 7065  elf.state_of_ope
+0000c4b0: 7261 7469 6f6e 732e 6973 5f72 756e 6e69  rations.is_runni
+0000c4c0: 6e67 284f 7065 7261 7469 6f6e 2e53 4849  ng(Operation.SHI
+0000c4d0: 4654 293a 0a20 2020 2020 2020 2020 2020  FT):.           
+0000c4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c4f0: 2069 6620 2275 7064 6174 655f 6461 7461   if "update_data
+0000c500: 7365 7422 2069 6e20 5f66 696c 653a 0a20  set" in _file:. 
+0000c510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c520: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0000c530: 656c 205f 6669 6c65 5b22 7570 6461 7465  el _file["update
+0000c540: 5f64 6174 6173 6574 225d 0a20 2020 2020  _dataset"].     
 0000c550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c560: 6966 2022 7570 6461 7465 5f64 6174 6173  if "update_datas
-0000c570: 6574 2220 696e 205f 6669 6c65 3a0a 2020  et" in _file:.  
-0000c580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c590: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0000c5a0: 6c20 5f66 696c 655b 2275 7064 6174 655f  l _file["update_
-0000c5b0: 6461 7461 7365 7422 5d0a 2020 2020 2020  dataset"].      
+0000c560: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+0000c570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c580: 2020 2020 2020 696d 6720 3d20 6170 706c        img = appl
+0000c590: 795f 7368 6966 7428 6461 7461 5b69 5d2c  y_shift(data[i],
+0000c5a0: 2073 6869 6674 5b3a 2c20 695d 2c20 7368   shift[:, i], sh
+0000c5b0: 6966 745f 6170 7072 6f61 6368 290a 2020  ift_approach).  
 0000c5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5d0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-0000c5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5f0: 2020 2020 2069 6d67 203d 2061 7070 6c79       img = apply
-0000c600: 5f73 6869 6674 2864 6174 615b 695d 2c20  _shift(data[i], 
-0000c610: 7368 6966 745b 3a2c 2069 5d2c 2073 6869  shift[:, i], shi
-0000c620: 6674 5f61 7070 726f 6163 6829 0a20 2020  ft_approach).   
-0000c630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c640: 2020 2020 2069 6620 7368 6966 745b 3a2c       if shift[:,
-0000c650: 2069 5d2e 616c 6c28 2920 3e20 313a 0a20   i].all() > 1:. 
+0000c5d0: 2020 2020 2020 6966 2073 6869 6674 5b3a        if shift[:
+0000c5e0: 2c20 695d 2e61 6c6c 2829 203e 2031 3a0a  , i].all() > 1:.
+0000c5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c600: 2020 2020 2020 2020 2020 2020 7368 6966              shif
+0000c610: 745f 6170 7072 6f61 6368 203d 2022 6c69  t_approach = "li
+0000c620: 6e65 6172 220a 2020 2020 2020 2020 2020  near".          
+0000c630: 2020 2020 2020 2020 2020 2020 2020 5f66                _f
+0000c640: 696c 655b 6461 7461 7365 745f 6e61 6d65  ile[dataset_name
+0000c650: 5d5b 6964 785d 203d 2069 6d67 0a20 2020  ][idx] = img.   
 0000c660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c670: 2020 2020 2020 2020 2020 2073 6869 6674             shift
-0000c680: 5f61 7070 726f 6163 6820 3d20 226c 696e  _approach = "lin
-0000c690: 6561 7222 0a20 2020 2020 2020 2020 2020  ear".           
-0000c6a0: 2020 2020 2020 2020 2020 2020 205f 6669               _fi
-0000c6b0: 6c65 5b64 6174 6173 6574 5f6e 616d 655d  le[dataset_name]
-0000c6c0: 5b69 6478 5d20 3d20 696d 670a 2020 2020  [idx] = img.    
-0000c6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c6e0: 2020 2020 7572 6c73 2e61 7070 656e 6428      urls.append(
-0000c6f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c700: 2020 2020 2020 2020 2020 2020 2044 6174               Dat
-0000c710: 6155 726c 280a 2020 2020 2020 2020 2020  aUrl(.          
+0000c670: 2020 2020 2075 726c 732e 6170 7065 6e64       urls.append
+0000c680: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000c690: 2020 2020 2020 2020 2020 2020 2020 4461                Da
+0000c6a0: 7461 5572 6c28 0a20 2020 2020 2020 2020  taUrl(.         
+0000c6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c6c0: 2020 2020 2020 2066 696c 655f 7061 7468         file_path
+0000c6d0: 3d5f 6469 7220 2b20 222f 6461 7461 2e68  =_dir + "/data.h
+0000c6e0: 6466 3522 2c0a 2020 2020 2020 2020 2020  df5",.          
+0000c6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c700: 2020 2020 2020 6461 7461 5f70 6174 683d        data_path=
+0000c710: 222f 6461 7461 7365 7422 2c0a 2020 2020  "/dataset",.    
 0000c720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c730: 2020 2020 2020 6669 6c65 5f70 6174 683d        file_path=
-0000c740: 5f64 6972 202b 2022 2f64 6174 612e 6864  _dir + "/data.hd
-0000c750: 6635 222c 0a20 2020 2020 2020 2020 2020  f5",.           
-0000c760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c770: 2020 2020 2064 6174 615f 7061 7468 3d22       data_path="
-0000c780: 2f64 6174 6173 6574 222c 0a20 2020 2020  /dataset",.     
-0000c790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c7a0: 2020 2020 2020 2020 2020 2064 6174 615f             data_
-0000c7b0: 736c 6963 653d 6964 782c 0a20 2020 2020  slice=idx,.     
-0000c7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c7d0: 2020 2020 2020 2020 2020 2073 6368 656d             schem
-0000c7e0: 653d 2273 696c 7822 2c0a 2020 2020 2020  e="silx",.      
+0000c730: 2020 2020 2020 2020 2020 2020 6461 7461              data
+0000c740: 5f73 6c69 6365 3d69 6478 2c0a 2020 2020  _slice=idx,.    
+0000c750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c760: 2020 2020 2020 2020 2020 2020 7363 6865              sche
+0000c770: 6d65 3d22 7369 6c78 222c 0a20 2020 2020  me="silx",.     
+0000c780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c790: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000c7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c7b0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0000c7c0: 2020 2020 2020 2020 2020 2069 6f5f 7574             io_ut
+0000c7d0: 696c 732e 6164 7661 6e63 656d 656e 745f  ils.advancement_
+0000c7e0: 6469 7370 6c61 7928 0a20 2020 2020 2020  display(.       
 0000c7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c800: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000c810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c820: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000c830: 2020 2020 2020 2020 2020 696f 5f75 7469            io_uti
-0000c840: 6c73 2e61 6476 616e 6365 6d65 6e74 5f64  ls.advancement_d
-0000c850: 6973 706c 6179 280a 2020 2020 2020 2020  isplay(.        
-0000c860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c870: 2020 2020 6920 2b20 312c 206c 656e 2872      i + 1, len(r
-0000c880: 696e 6469 6365 7329 2c20 2241 7070 6c79  indices), "Apply
-0000c890: 696e 6720 7368 6966 7422 0a20 2020 2020  ing shift".     
-0000c8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c8b0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-0000c8c0: 2020 2020 2020 2020 2020 2320 5265 706c            # Repl
-0000c8d0: 6163 6520 7370 6563 6966 6963 2075 726c  ace specific url
-0000c8e0: 7320 7468 6174 2063 6f72 7265 7370 6f6e  s that correspon
-0000c8f0: 6420 746f 2074 6865 206d 6f64 6966 6965  d to the modifie
-0000c900: 6420 6461 7461 0a20 2020 2020 2020 2020  d data.         
-0000c910: 2020 2020 2020 2020 2020 206e 6577 5f75             new_u
-0000c920: 726c 7320 3d20 6e75 6d70 792e 6172 7261  rls = numpy.arra
-0000c930: 7928 7365 6c66 2e64 6174 612e 7572 6c73  y(self.data.urls
-0000c940: 2c20 6474 7970 653d 6f62 6a65 6374 290a  , dtype=object).
-0000c950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c960: 2020 2020 636f 7079 5f75 726c 7320 3d20      copy_urls = 
-0000c970: 6e65 775f 7572 6c73 0a20 2020 2020 2020  new_urls.       
-0000c980: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000c990: 696e 6469 6365 7320 6973 206e 6f74 204e  indices is not N
-0000c9a0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000c9b0: 2020 2020 2020 2020 2020 2020 2023 2043               # C
-0000c9c0: 7265 6174 6520 6172 7261 7920 6f66 2062  reate array of b
-0000c9d0: 6f6f 6c65 616e 7320 746f 206b 6e6f 7720  ooleans to know 
-0000c9e0: 7768 6963 6820 696e 6469 6365 7320 7765  which indices we
-0000c9f0: 2068 6176 650a 2020 2020 2020 2020 2020   have.          
-0000ca00: 2020 2020 2020 2020 2020 2020 2020 626f                bo
-0000ca10: 6f6c 5f69 6e64 6963 6573 203d 206e 756d  ol_indices = num
-0000ca20: 7079 2e7a 6572 6f73 280a 2020 2020 2020  py.zeros(.      
-0000ca30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ca40: 2020 2020 2020 7365 6c66 2e67 6574 5f64        self.get_d
-0000ca50: 6174 6128 292e 7368 6170 655b 3a2d 325d  ata().shape[:-2]
-0000ca60: 2c20 6474 7970 653d 626f 6f6c 0a20 2020  , dtype=bool.   
-0000ca70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ca80: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0000ca90: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0000caa0: 6f6f 6c5f 696e 6469 6365 735b 696e 6469  ool_indices[indi
-0000cab0: 6365 735d 203d 2054 7275 650a 2020 2020  ces] = True.    
-0000cac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cad0: 2020 2020 626f 6f6c 5f69 6e64 6963 6573      bool_indices
-0000cae0: 203d 2062 6f6f 6c5f 696e 6469 6365 732e   = bool_indices.
-0000caf0: 7265 7368 6170 6528 7365 6c66 2e64 6174  reshape(self.dat
-0000cb00: 612e 7363 616e 5f73 6861 7065 290a 2020  a.scan_shape).  
-0000cb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cb20: 2020 2020 2020 666f 7220 692c 2064 696d        for i, dim
-0000cb30: 2069 6e20 656e 756d 6572 6174 6528 736f   in enumerate(so
-0000cb40: 7274 6564 2864 696d 656e 7369 6f6e 5b30  rted(dimension[0
-0000cb50: 5d29 293a 0a20 2020 2020 2020 2020 2020  ])):.           
-0000cb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cb70: 2023 2046 6c69 7020 6178 6973 2074 6f20   # Flip axis to 
-0000cb80: 6265 2063 6f6e 7369 7374 656e 7420 7769  be consistent wi
-0000cb90: 7468 2074 6865 2064 6174 6120 7368 6170  th the data shap
-0000cba0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0000cbb0: 2020 2020 2020 2020 2020 2020 2020 6178                ax
-0000cbc0: 6973 203d 2073 656c 662e 6469 6d73 2e6e  is = self.dims.n
-0000cbd0: 6469 6d20 2d20 6469 6d20 2d20 310a 2020  dim - dim - 1.  
-0000cbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cbf0: 2020 2020 2020 2020 2020 636f 7079 5f75            copy_u
-0000cc00: 726c 7320 3d20 6e75 6d70 792e 7377 6170  rls = numpy.swap
-0000cc10: 6178 6573 2863 6f70 795f 7572 6c73 2c20  axes(copy_urls, 
-0000cc20: 302c 2061 7869 7329 5b0a 2020 2020 2020  0, axis)[.      
-0000cc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cc40: 2020 2020 2020 2020 2020 6469 6d65 6e73            dimens
-0000cc50: 696f 6e5b 315d 5b69 5d2c 203a 0a20 2020  ion[1][i], :.   
+0000c800: 2020 2020 2069 202b 2031 2c20 6c65 6e28       i + 1, len(
+0000c810: 7269 6e64 6963 6573 292c 2022 4170 706c  rindices), "Appl
+0000c820: 7969 6e67 2073 6869 6674 220a 2020 2020  ying shift".    
+0000c830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c840: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+0000c850: 2020 2020 2020 2020 2020 2023 2052 6570             # Rep
+0000c860: 6c61 6365 2073 7065 6369 6669 6320 7572  lace specific ur
+0000c870: 6c73 2074 6861 7420 636f 7272 6573 706f  ls that correspo
+0000c880: 6e64 2074 6f20 7468 6520 6d6f 6469 6669  nd to the modifi
+0000c890: 6564 2064 6174 610a 2020 2020 2020 2020  ed data.        
+0000c8a0: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
+0000c8b0: 7572 6c73 203d 206e 756d 7079 2e61 7272  urls = numpy.arr
+0000c8c0: 6179 2873 656c 662e 6461 7461 2e75 726c  ay(self.data.url
+0000c8d0: 732c 2064 7479 7065 3d6f 626a 6563 7429  s, dtype=object)
+0000c8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c8f0: 2020 2020 2063 6f70 795f 7572 6c73 203d       copy_urls =
+0000c900: 206e 6577 5f75 726c 730a 2020 2020 2020   new_urls.      
+0000c910: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000c920: 2069 6e64 6963 6573 2069 7320 6e6f 7420   indices is not 
+0000c930: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000c940: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000c950: 4372 6561 7465 2061 7272 6179 206f 6620  Create array of 
+0000c960: 626f 6f6c 6561 6e73 2074 6f20 6b6e 6f77  booleans to know
+0000c970: 2077 6869 6368 2069 6e64 6963 6573 2077   which indices w
+0000c980: 6520 6861 7665 0a20 2020 2020 2020 2020  e have.         
+0000c990: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0000c9a0: 6f6f 6c5f 696e 6469 6365 7320 3d20 6e75  ool_indices = nu
+0000c9b0: 6d70 792e 7a65 726f 7328 0a20 2020 2020  mpy.zeros(.     
+0000c9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c9d0: 2020 2020 2020 2073 656c 662e 6765 745f         self.get_
+0000c9e0: 6461 7461 2829 2e73 6861 7065 5b3a 2d32  data().shape[:-2
+0000c9f0: 5d2c 2064 7479 7065 3d62 6f6f 6c0a 2020  ], dtype=bool.  
+0000ca00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ca10: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000ca20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ca30: 626f 6f6c 5f69 6e64 6963 6573 5b69 6e64  bool_indices[ind
+0000ca40: 6963 6573 5d20 3d20 5472 7565 0a20 2020  ices] = True.   
+0000ca50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ca60: 2020 2020 2062 6f6f 6c5f 696e 6469 6365       bool_indice
+0000ca70: 7320 3d20 626f 6f6c 5f69 6e64 6963 6573  s = bool_indices
+0000ca80: 2e72 6573 6861 7065 2873 656c 662e 6461  .reshape(self.da
+0000ca90: 7461 2e73 6361 6e5f 7368 6170 6529 0a20  ta.scan_shape). 
+0000caa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cab0: 2020 2020 2020 2066 6f72 2069 2c20 6469         for i, di
+0000cac0: 6d20 696e 2065 6e75 6d65 7261 7465 2873  m in enumerate(s
+0000cad0: 6f72 7465 6428 6469 6d65 6e73 696f 6e5b  orted(dimension[
+0000cae0: 305d 2929 3a0a 2020 2020 2020 2020 2020  0])):.          
+0000caf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cb00: 2020 2320 466c 6970 2061 7869 7320 746f    # Flip axis to
+0000cb10: 2062 6520 636f 6e73 6973 7465 6e74 2077   be consistent w
+0000cb20: 6974 6820 7468 6520 6461 7461 2073 6861  ith the data sha
+0000cb30: 7065 0a20 2020 2020 2020 2020 2020 2020  pe.             
+0000cb40: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000cb50: 7869 7320 3d20 7365 6c66 2e64 696d 732e  xis = self.dims.
+0000cb60: 6e64 696d 202d 2064 696d 202d 2031 0a20  ndim - dim - 1. 
+0000cb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cb80: 2020 2020 2020 2020 2020 2063 6f70 795f             copy_
+0000cb90: 7572 6c73 203d 206e 756d 7079 2e73 7761  urls = numpy.swa
+0000cba0: 7061 7865 7328 636f 7079 5f75 726c 732c  paxes(copy_urls,
+0000cbb0: 2030 2c20 6178 6973 295b 0a20 2020 2020   0, axis)[.     
+0000cbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cbd0: 2020 2020 2020 2020 2020 2064 696d 656e             dimen
+0000cbe0: 7369 6f6e 5b31 5d5b 695d 2c20 3a0a 2020  sion[1][i], :.  
+0000cbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cc00: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
+0000cc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cc20: 2020 2020 2020 2020 626f 6f6c 5f69 6e64          bool_ind
+0000cc30: 6963 6573 203d 206e 756d 7079 2e73 7761  ices = numpy.swa
+0000cc40: 7061 7865 7328 626f 6f6c 5f69 6e64 6963  paxes(bool_indic
+0000cc50: 6573 2c20 302c 2061 7869 7329 5b0a 2020  es, 0, axis)[.  
 0000cc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cc70: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
-0000cc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cc90: 2020 2020 2020 2062 6f6f 6c5f 696e 6469         bool_indi
-0000cca0: 6365 7320 3d20 6e75 6d70 792e 7377 6170  ces = numpy.swap
-0000ccb0: 6178 6573 2862 6f6f 6c5f 696e 6469 6365  axes(bool_indice
-0000ccc0: 732c 2030 2c20 6178 6973 295b 0a20 2020  s, 0, axis)[.   
-0000ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cce0: 2020 2020 2020 2020 2020 2020 2064 696d               dim
-0000ccf0: 656e 7369 6f6e 5b31 5d5b 695d 2c20 3a0a  ension[1][i], :.
+0000cc70: 2020 2020 2020 2020 2020 2020 2020 6469                di
+0000cc80: 6d65 6e73 696f 6e5b 315d 5b69 5d2c 203a  mension[1][i], :
+0000cc90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cca0: 2020 2020 2020 2020 2020 2020 205d 0a20               ]. 
+0000ccb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ccc0: 2020 2020 2020 2063 6f70 795f 7572 6c73         copy_urls
+0000ccd0: 5b62 6f6f 6c5f 696e 6469 6365 735d 203d  [bool_indices] =
+0000cce0: 2075 726c 730a 2020 2020 2020 2020 2020   urls.          
+0000ccf0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
 0000cd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cd10: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-0000cd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cd30: 2020 2020 2020 636f 7079 5f75 726c 735b        copy_urls[
-0000cd40: 626f 6f6c 5f69 6e64 6963 6573 5d20 3d20  bool_indices] = 
-0000cd50: 7572 6c73 0a20 2020 2020 2020 2020 2020  urls.           
-0000cd60: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0000cd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cd80: 2020 2020 2020 2066 6f72 2069 2c20 6469         for i, di
-0000cd90: 6d20 696e 2065 6e75 6d65 7261 7465 2873  m in enumerate(s
-0000cda0: 6f72 7465 6428 6469 6d65 6e73 696f 6e5b  orted(dimension[
-0000cdb0: 305d 2929 3a0a 2020 2020 2020 2020 2020  0])):.          
-0000cdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cdd0: 2020 2320 466c 6970 2061 7869 7320 746f    # Flip axis to
-0000cde0: 2062 6520 636f 6e73 6973 7465 6e74 2077   be consistent w
-0000cdf0: 6974 6820 7468 6520 6461 7461 2073 6861  ith the data sha
-0000ce00: 7065 0a20 2020 2020 2020 2020 2020 2020  pe.             
-0000ce10: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0000ce20: 7869 7320 3d20 7365 6c66 2e64 696d 732e  xis = self.dims.
-0000ce30: 6e64 696d 202d 2064 696d 202d 2031 0a20  ndim - dim - 1. 
-0000ce40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ce50: 2020 2020 2020 2020 2020 2063 6f70 795f             copy_
-0000ce60: 7572 6c73 203d 206e 756d 7079 2e73 7761  urls = numpy.swa
-0000ce70: 7061 7865 7328 636f 7079 5f75 726c 732c  paxes(copy_urls,
-0000ce80: 2030 2c20 6178 6973 295b 0a20 2020 2020   0, axis)[.     
-0000ce90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cea0: 2020 2020 2020 2020 2020 2064 696d 656e             dimen
-0000ceb0: 7369 6f6e 5b31 5d5b 695d 2c20 3a0a 2020  sion[1][i], :.  
-0000cec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ced0: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
-0000cee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cef0: 2020 2020 636f 7079 5f75 726c 735b 3a5d      copy_urls[:]
-0000cf00: 203d 2075 726c 730a 2020 2020 2020 2020   = urls.        
-0000cf10: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000cf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cf30: 2020 7572 6c73 203d 205b 5d0a 2020 2020    urls = [].    
-0000cf40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cf50: 666f 7220 692c 2069 6478 2069 6e20 656e  for i, idx in en
-0000cf60: 756d 6572 6174 6528 7269 6e64 6963 6573  umerate(rindices
-0000cf70: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000cf80: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-0000cf90: 7420 7365 6c66 2e73 7461 7465 5f6f 665f  t self.state_of_
-0000cfa0: 6f70 6572 6174 696f 6e73 2e69 735f 7275  operations.is_ru
-0000cfb0: 6e6e 696e 6728 4f70 6572 6174 696f 6e2e  nning(Operation.
-0000cfc0: 5348 4946 5429 3a0a 2020 2020 2020 2020  SHIFT):.        
+0000cd10: 2020 2020 2020 2020 666f 7220 692c 2064          for i, d
+0000cd20: 696d 2069 6e20 656e 756d 6572 6174 6528  im in enumerate(
+0000cd30: 736f 7274 6564 2864 696d 656e 7369 6f6e  sorted(dimension
+0000cd40: 5b30 5d29 293a 0a20 2020 2020 2020 2020  [0])):.         
+0000cd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cd60: 2020 2023 2046 6c69 7020 6178 6973 2074     # Flip axis t
+0000cd70: 6f20 6265 2063 6f6e 7369 7374 656e 7420  o be consistent 
+0000cd80: 7769 7468 2074 6865 2064 6174 6120 7368  with the data sh
+0000cd90: 6170 650a 2020 2020 2020 2020 2020 2020  ape.            
+0000cda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cdb0: 6178 6973 203d 2073 656c 662e 6469 6d73  axis = self.dims
+0000cdc0: 2e6e 6469 6d20 2d20 6469 6d20 2d20 310a  .ndim - dim - 1.
+0000cdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cde0: 2020 2020 2020 2020 2020 2020 636f 7079              copy
+0000cdf0: 5f75 726c 7320 3d20 6e75 6d70 792e 7377  _urls = numpy.sw
+0000ce00: 6170 6178 6573 2863 6f70 795f 7572 6c73  apaxes(copy_urls
+0000ce10: 2c20 302c 2061 7869 7329 5b0a 2020 2020  , 0, axis)[.    
+0000ce20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ce30: 2020 2020 2020 2020 2020 2020 6469 6d65              dime
+0000ce40: 6e73 696f 6e5b 315d 5b69 5d2c 203a 0a20  nsion[1][i], :. 
+0000ce50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ce60: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
+0000ce70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ce80: 2020 2020 2063 6f70 795f 7572 6c73 5b3a       copy_urls[:
+0000ce90: 5d20 3d20 7572 6c73 0a20 2020 2020 2020  ] = urls.       
+0000cea0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0000ceb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cec0: 2020 2075 726c 7320 3d20 5b5d 0a20 2020     urls = [].   
+0000ced0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cee0: 2066 6f72 2069 2c20 6964 7820 696e 2065   for i, idx in e
+0000cef0: 6e75 6d65 7261 7465 2872 696e 6469 6365  numerate(rindice
+0000cf00: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+0000cf10: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0000cf20: 6f74 2073 656c 662e 7374 6174 655f 6f66  ot self.state_of
+0000cf30: 5f6f 7065 7261 7469 6f6e 732e 6973 5f72  _operations.is_r
+0000cf40: 756e 6e69 6e67 284f 7065 7261 7469 6f6e  unning(Operation
+0000cf50: 2e53 4849 4654 293a 0a20 2020 2020 2020  .SHIFT):.       
+0000cf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cf70: 2020 2020 2069 6620 2275 7064 6174 655f       if "update_
+0000cf80: 6461 7461 7365 7422 2069 6e20 5f66 696c  dataset" in _fil
+0000cf90: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000cfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cfb0: 2020 2064 656c 205f 6669 6c65 5b22 7570     del _file["up
+0000cfc0: 6461 7465 5f64 6174 6173 6574 225d 0a20  date_dataset"]. 
 0000cfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cfe0: 2020 2020 6966 2022 7570 6461 7465 5f64      if "update_d
-0000cff0: 6174 6173 6574 2220 696e 205f 6669 6c65  ataset" in _file
-0000d000: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000d010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d020: 2020 6465 6c20 5f66 696c 655b 2275 7064    del _file["upd
-0000d030: 6174 655f 6461 7461 7365 7422 5d0a 2020  ate_dataset"].  
-0000d040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d050: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000d060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d070: 2020 2020 2020 2020 2069 6620 7368 6966           if shif
-0000d080: 745b 3a2c 2069 5d2e 616c 6c28 2920 3e20  t[:, i].all() > 
-0000d090: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-0000d0a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000d0b0: 6869 6674 5f61 7070 726f 6163 6820 3d20  hift_approach = 
-0000d0c0: 226c 696e 6561 7222 0a20 2020 2020 2020  "linear".       
-0000d0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d0e0: 2069 6d67 203d 2061 7070 6c79 5f73 6869   img = apply_shi
-0000d0f0: 6674 2864 6174 615b 695d 2c20 7368 6966  ft(data[i], shif
-0000d100: 745b 3a2c 2069 5d2c 2073 6869 6674 5f61  t[:, i], shift_a
-0000d110: 7070 726f 6163 6829 0a20 2020 2020 2020  pproach).       
-0000d120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d130: 205f 6669 6c65 5b64 6174 6173 6574 5f6e   _file[dataset_n
-0000d140: 616d 655d 5b69 6478 5d20 3d20 696d 670a  ame][idx] = img.
-0000d150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d160: 2020 2020 2020 2020 7572 6c73 2e61 7070          urls.app
-0000d170: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
-0000d180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d190: 2044 6174 6155 726c 280a 2020 2020 2020   DataUrl(.      
+0000cfe0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000cff0: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+0000d000: 2020 2020 2020 2020 2020 6966 2073 6869            if shi
+0000d010: 6674 5b3a 2c20 695d 2e61 6c6c 2829 203e  ft[:, i].all() >
+0000d020: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+0000d030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d040: 7368 6966 745f 6170 7072 6f61 6368 203d  shift_approach =
+0000d050: 2022 6c69 6e65 6172 220a 2020 2020 2020   "linear".      
+0000d060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d070: 2020 696d 6720 3d20 6170 706c 795f 7368    img = apply_sh
+0000d080: 6966 7428 6461 7461 5b69 5d2c 2073 6869  ift(data[i], shi
+0000d090: 6674 5b3a 2c20 695d 2c20 7368 6966 745f  ft[:, i], shift_
+0000d0a0: 6170 7072 6f61 6368 290a 2020 2020 2020  approach).      
+0000d0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d0c0: 2020 5f66 696c 655b 6461 7461 7365 745f    _file[dataset_
+0000d0d0: 6e61 6d65 5d5b 6964 785d 203d 2069 6d67  name][idx] = img
+0000d0e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d0f0: 2020 2020 2020 2020 2075 726c 732e 6170           urls.ap
+0000d100: 7065 6e64 280a 2020 2020 2020 2020 2020  pend(.          
+0000d110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d120: 2020 4461 7461 5572 6c28 0a20 2020 2020    DataUrl(.     
+0000d130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d140: 2020 2020 2020 2020 2020 2066 696c 655f             file_
+0000d150: 7061 7468 3d5f 6469 7220 2b20 222f 6461  path=_dir + "/da
+0000d160: 7461 2e68 6466 3522 2c0a 2020 2020 2020  ta.hdf5",.      
+0000d170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d180: 2020 2020 2020 2020 2020 6461 7461 5f70            data_p
+0000d190: 6174 683d 222f 6461 7461 7365 7422 2c0a  ath="/dataset",.
 0000d1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d1b0: 2020 2020 2020 2020 2020 6669 6c65 5f70            file_p
-0000d1c0: 6174 683d 5f64 6972 202b 2022 2f64 6174  ath=_dir + "/dat
-0000d1d0: 612e 6864 6635 222c 0a20 2020 2020 2020  a.hdf5",.       
+0000d1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d1c0: 6461 7461 5f73 6c69 6365 3d69 6478 2c0a  data_slice=idx,.
+0000d1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000d1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d1f0: 2020 2020 2020 2020 2064 6174 615f 7061           data_pa
-0000d200: 7468 3d22 2f64 6174 6173 6574 222c 0a20  th="/dataset",. 
-0000d210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d220: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0000d230: 6174 615f 736c 6963 653d 6964 782c 0a20  ata_slice=idx,. 
-0000d240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d250: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000d260: 6368 656d 653d 2273 696c 7822 2c0a 2020  cheme="silx",.  
-0000d270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d280: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000d1f0: 7363 6865 6d65 3d22 7369 6c78 222c 0a20  scheme="silx",. 
+0000d200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d210: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0000d220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d230: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0000d240: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000d250: 6f5f 7574 696c 732e 6164 7661 6e63 656d  o_utils.advancem
+0000d260: 656e 745f 6469 7370 6c61 7928 6920 2b20  ent_display(i + 
+0000d270: 312c 206c 656e 2864 6174 6129 2c20 2241  1, len(data), "A
+0000d280: 7070 6c79 696e 6720 7368 6966 7422 290a  pplying shift").
 0000d290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d2a0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0000d2b0: 2020 2020 2020 2020 2020 2020 2020 696f                io
-0000d2c0: 5f75 7469 6c73 2e61 6476 616e 6365 6d65  _utils.advanceme
-0000d2d0: 6e74 5f64 6973 706c 6179 2869 202b 2031  nt_display(i + 1
-0000d2e0: 2c20 6c65 6e28 6461 7461 292c 2022 4170  , len(data), "Ap
-0000d2f0: 706c 7969 6e67 2073 6869 6674 2229 0a20  plying shift"). 
-0000d300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d310: 2020 2069 6620 696e 6469 6365 7320 6973     if indices is
-0000d320: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0000d330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d340: 2020 206e 6577 5f75 726c 7320 3d20 6e75     new_urls = nu
-0000d350: 6d70 792e 6172 7261 7928 7365 6c66 2e64  mpy.array(self.d
-0000d360: 6174 612e 7572 6c73 2c20 6474 7970 653d  ata.urls, dtype=
-0000d370: 6f62 6a65 6374 292e 666c 6174 7465 6e28  object).flatten(
-0000d380: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000d390: 2020 2020 2020 2020 2020 6e75 6d70 792e            numpy.
-0000d3a0: 7075 7428 6e65 775f 7572 6c73 2c20 696e  put(new_urls, in
-0000d3b0: 6469 6365 732c 2075 726c 7329 0a20 2020  dices, urls).   
-0000d3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d3d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000d3e0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0000d3f0: 6577 5f75 726c 7320 3d20 6e75 6d70 792e  ew_urls = numpy.
-0000d400: 6172 7261 7928 7572 6c73 290a 0a20 2020  array(urls)..   
-0000d410: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000d420: 6461 7461 7365 745f 6e61 6d65 203d 3d20  dataset_name == 
-0000d430: 2275 7064 6174 655f 6461 7461 7365 7422  "update_dataset"
-0000d440: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000d450: 2020 2020 2020 6465 6c20 5f66 696c 655b        del _file[
-0000d460: 2264 6174 6173 6574 225d 0a20 2020 2020  "dataset"].     
-0000d470: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-0000d480: 6669 6c65 5b22 6461 7461 7365 7422 5d20  file["dataset"] 
-0000d490: 3d20 5f66 696c 655b 2275 7064 6174 655f  = _file["update_
-0000d4a0: 6461 7461 7365 7422 5d0a 2020 2020 2020  dataset"].      
-0000d4b0: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0000d4c0: 6c20 5f66 696c 655b 2275 7064 6174 655f  l _file["update_
-0000d4d0: 6461 7461 7365 7422 5d0a 2020 2020 2020  dataset"].      
-0000d4e0: 2020 2020 2020 6669 6e61 6c6c 793a 0a20        finally:. 
-0000d4f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000d500: 6620 5f66 696c 6520 6973 206e 6f74 204e  f _file is not N
-0000d510: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000d520: 2020 2020 2020 2020 205f 6669 6c65 2e63           _file.c
-0000d530: 6c6f 7365 2829 0a0a 2020 2020 2020 2020  lose()..        
-0000d540: 6461 7461 203d 2044 6174 6128 0a20 2020  data = Data(.   
-0000d550: 2020 2020 2020 2020 206e 6577 5f75 726c           new_url
-0000d560: 732e 7265 7368 6170 6528 7365 6c66 2e64  s.reshape(self.d
-0000d570: 6174 612e 7572 6c73 2e73 6861 7065 292c  ata.urls.shape),
-0000d580: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000d590: 662e 6461 7461 2e6d 6574 6164 6174 612c  f.data.metadata,
-0000d5a0: 0a20 2020 2020 2020 2020 2020 2069 6e5f  .            in_
-0000d5b0: 6d65 6d6f 7279 3d73 656c 662e 5f69 6e5f  memory=self._in_
-0000d5c0: 6d65 6d6f 7279 2c0a 2020 2020 2020 2020  memory,.        
-0000d5d0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-0000d5e0: 2044 6174 6173 6574 280a 2020 2020 2020   Dataset(.      
-0000d5f0: 2020 2020 2020 5f64 6972 3d5f 6469 722c        _dir=_dir,
-0000d600: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-0000d610: 613d 6461 7461 2c0a 2020 2020 2020 2020  a=data,.        
-0000d620: 2020 2020 6469 6d73 3d73 656c 662e 5f5f      dims=self.__
-0000d630: 6469 6d73 2c0a 2020 2020 2020 2020 2020  dims,.          
-0000d640: 2020 7472 616e 7366 6f72 6d61 7469 6f6e    transformation
-0000d650: 3d73 656c 662e 7472 616e 7366 6f72 6d61  =self.transforma
-0000d660: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
-0000d670: 2020 696e 5f6d 656d 6f72 793d 7365 6c66    in_memory=self
-0000d680: 2e5f 696e 5f6d 656d 6f72 792c 0a20 2020  ._in_memory,.   
-0000d690: 2020 2020 2020 2020 2074 6974 6c65 3d73           title=s
-0000d6a0: 656c 662e 7469 746c 652c 0a20 2020 2020  elf.title,.     
-0000d6b0: 2020 2029 0a0a 2020 2020 6465 6620 6669     )..    def fi
-0000d6c0: 6e64 5f61 6e64 5f61 7070 6c79 5f73 6869  nd_and_apply_shi
-0000d6d0: 6674 280a 2020 2020 2020 2020 7365 6c66  ft(.        self
-0000d6e0: 2c0a 2020 2020 2020 2020 6469 6d65 6e73  ,.        dimens
-0000d6f0: 696f 6e3d 4e6f 6e65 2c0a 2020 2020 2020  ion=None,.      
-0000d700: 2020 7374 6570 733d 3130 302c 0a20 2020    steps=100,.   
-0000d710: 2020 2020 2073 6869 6674 5f61 7070 726f       shift_appro
-0000d720: 6163 683d 2266 6674 222c 0a20 2020 2020  ach="fft",.     
-0000d730: 2020 2069 6e64 6963 6573 3d4e 6f6e 652c     indices=None,
-0000d740: 0a20 2020 2020 2020 2063 616c 6c62 6163  .        callbac
-0000d750: 6b3d 4e6f 6e65 2c0a 2020 2020 293a 0a20  k=None,.    ):. 
-0000d760: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0000d770: 2020 2046 696e 6420 7468 6520 7368 6966     Find the shif
-0000d780: 7420 6f66 2074 6865 2064 6174 6120 6f72  t of the data or
-0000d790: 2070 6172 7420 6f66 2069 7420 616e 6420   part of it and 
-0000d7a0: 6170 706c 7920 6974 2e0a 0a20 2020 2020  apply it...     
-0000d7b0: 2020 203a 7061 7261 6d20 6469 6d65 6e73     :param dimens
-0000d7c0: 696f 6e3a 2050 6172 616d 6574 6573 2077  ion: Parametes w
-0000d7d0: 6974 6820 7468 6520 706f 7369 7469 6f6e  ith the position
-0000d7e0: 206f 6620 7468 6520 6461 7461 2069 6e20   of the data in 
-0000d7f0: 7468 6520 7265 7368 6170 6564 0a20 2020  the reshaped.   
-0000d800: 2020 2020 2020 2020 2061 7272 6179 2e0a           array..
-0000d810: 2020 2020 2020 2020 3a74 7970 6520 6469          :type di
-0000d820: 6d65 6e73 696f 6e3a 2055 6e69 6f6e 5b4e  mension: Union[N
-0000d830: 6f6e 652c 2074 7570 6c65 2c20 6172 7261  one, tuple, arra
-0000d840: 795f 6c69 6b65 5d0a 2020 2020 2020 2020  y_like].        
-0000d850: 3a70 6172 616d 2066 6c6f 6174 2068 5f6d  :param float h_m
-0000d860: 6178 3a20 5365 6520 6063 6f72 652e 696d  ax: See `core.im
-0000d870: 6167 6552 6567 6973 7472 6174 696f 6e2e  ageRegistration.
-0000d880: 7368 6966 745f 6465 7465 6374 696f 6e60  shift_detection`
-0000d890: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0000d8a0: 666c 6f61 7420 685f 7374 6570 3a20 5365  float h_step: Se
-0000d8b0: 6520 6063 6f72 652e 696d 6167 6552 6567  e `core.imageReg
-0000d8c0: 6973 7472 6174 696f 6e2e 7368 6966 745f  istration.shift_
-0000d8d0: 6465 7465 6374 696f 6e60 0a20 2020 2020  detection`.     
-0000d8e0: 2020 203a 7061 7261 6d20 556e 696f 6e5b     :param Union[
-0000d8f0: 2766 6674 272c 2027 6c69 6e65 6172 275d  'fft', 'linear']
-0000d900: 2073 6869 6674 5f61 7070 726f 6163 683a   shift_approach:
-0000d910: 204d 6574 686f 6420 746f 2075 7365 2074   Method to use t
-0000d920: 6f20 6170 706c 7920 7468 6520 7368 6966  o apply the shif
-0000d930: 742e 0a20 2020 2020 2020 203a 7061 7261  t..        :para
-0000d940: 6d20 696e 6469 6365 733a 2049 6e64 6963  m indices: Indic
-0000d950: 6573 206f 6620 7468 6520 696d 6167 6573  es of the images
-0000d960: 2074 6f20 6669 6e64 2061 6e64 2061 7070   to find and app
-0000d970: 6c79 2074 6865 2073 6869 6674 2074 6f2e  ly the shift to.
-0000d980: 0a20 2020 2020 2020 2020 2020 2049 6620  .            If 
-0000d990: 4e6f 6e65 2c20 7468 6520 686f 7420 7069  None, the hot pi
-0000d9a0: 7865 6c20 7265 6d6f 7661 6c20 6973 2061  xel removal is a
-0000d9b0: 7070 6c69 6564 2074 6f20 616c 6c20 7468  pplied to all th
-0000d9c0: 6520 6461 7461 2e0a 2020 2020 2020 2020  e data..        
-0000d9d0: 3a74 7970 6520 696e 6469 6365 733a 2055  :type indices: U
-0000d9e0: 6e69 6f6e 5b4e 6f6e 652c 2061 7272 6179  nion[None, array
-0000d9f0: 5f6c 696b 655d 0a20 2020 2020 2020 203a  _like].        :
-0000da00: 7061 7261 6d20 556e 696f 6e5b 6675 6e63  param Union[func
-0000da10: 7469 6f6e 2c20 4e6f 6e65 5d20 6361 6c6c  tion, None] call
-0000da20: 6261 636b 3a20 4361 6c6c 6261 636b 0a20  back: Callback. 
-0000da30: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
-0000da40: 2044 6174 6173 6574 2077 6974 6820 7468   Dataset with th
-0000da50: 6520 6e65 7720 6461 7461 2e0a 2020 2020  e new data..    
-0000da60: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000da70: 7368 6966 7420 3d20 7365 6c66 2e66 696e  shift = self.fin
-0000da80: 645f 7368 6966 7428 6469 6d65 6e73 696f  d_shift(dimensio
-0000da90: 6e2c 2073 7465 7073 2c20 696e 6469 6365  n, steps, indice
-0000daa0: 733d 696e 6469 6365 7329 0a20 2020 2020  s=indices).     
-0000dab0: 2020 2072 6574 7572 6e20 7365 6c66 2e61     return self.a
-0000dac0: 7070 6c79 5f73 6869 6674 2873 6869 6674  pply_shift(shift
-0000dad0: 2c20 6469 6d65 6e73 696f 6e2c 2069 6e64  , dimension, ind
-0000dae0: 6963 6573 3d69 6e64 6963 6573 290a 0a20  ices=indices).. 
-0000daf0: 2020 2064 6566 205f 7761 7465 7266 616c     def _waterfal
-0000db00: 6c5f 6e6d 6628 0a20 2020 2020 2020 2073  l_nmf(.        s
-0000db10: 656c 662c 206e 756d 5f63 6f6d 706f 6e65  elf, num_compone
-0000db20: 6e74 732c 2069 7465 7261 7469 6f6e 732c  nts, iterations,
-0000db30: 2076 7374 6570 3d4e 6f6e 652c 2068 7374   vstep=None, hst
-0000db40: 6570 3d4e 6f6e 652c 2069 6e64 6963 6573  ep=None, indices
-0000db50: 3d4e 6f6e 650a 2020 2020 293a 0a20 2020  =None.    ):.   
-0000db60: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0000db70: 2054 6869 7320 6d65 7468 6f64 2069 7320   This method is 
-0000db80: 7573 6564 2061 7320 6120 7761 7920 746f  used as a way to
-0000db90: 2069 6d70 726f 7665 2074 6865 2073 7065   improve the spe
-0000dba0: 6564 206f 6620 636f 6e76 6572 6765 6e63  ed of convergenc
-0000dbb0: 6520 6f66 0a20 2020 2020 2020 2074 6865  e of.        the
-0000dbc0: 204e 4d46 206d 6574 686f 642e 2046 6f72   NMF method. For
-0000dbd0: 2074 6869 732c 2069 7420 7573 6573 2061   this, it uses a
-0000dbe0: 2077 6174 6572 6661 6c6c 206d 6f64 656c   waterfall model
-0000dbf0: 2077 6865 7265 2061 7420 6576 6572 7920   where at every 
-0000dc00: 7374 6570 0a20 2020 2020 2020 2074 6865  step.        the
-0000dc10: 206f 7574 7075 7420 6d61 7472 6963 6573   output matrices
-0000dc20: 2073 6572 7665 2061 7320 696e 7075 7420   serve as input 
-0000dc30: 666f 7220 7468 6520 6e65 7874 2e0a 2020  for the next..  
-0000dc40: 2020 2020 2020 5468 6174 2069 732c 2074        That is, t
-0000dc50: 6865 206d 6574 686f 6420 7374 6172 7473  he method starts
-0000dc60: 2077 6974 6820 6120 736d 616c 6c65 7220   with a smaller 
-0000dc70: 7265 7369 7a65 6420 696d 6167 6573 206f  resized images o
-0000dc80: 6620 7468 6520 6461 7461 2c0a 2020 2020  f the data,.    
-0000dc90: 2020 2020 616e 6420 636f 6d70 7574 6573      and computes
-0000dca0: 2074 6865 204e 4d46 2064 6563 6f6d 706f   the NMF decompo
-0000dcb0: 7369 7469 6f6e 2e20 5468 6520 6e65 7874  sition. The next
-0000dcc0: 2073 7465 7020 6973 2074 6865 2073 616d   step is the sam
-0000dcd0: 6520 6275 7420 7769 7468 0a20 2020 2020  e but with.     
-0000dce0: 2020 2062 6967 6765 7220 696d 6167 6573     bigger images
-0000dcf0: 2c20 616e 6420 7573 696e 6720 6173 2069  , and using as i
-0000dd00: 6e69 7469 616c 2048 2061 6e64 2057 2074  nitial H and W t
-0000dd10: 6865 2070 7265 636f 6d70 7574 6564 206d  he precomputed m
-0000dd20: 6174 7269 6365 732e 0a20 2020 2020 2020  atrices..       
-0000dd30: 2054 6865 206c 6173 7420 7374 6570 2069   The last step i
-0000dd40: 7320 646f 6e65 2075 7369 6e67 2074 6865  s done using the
-0000dd50: 2061 6374 7561 6c20 7369 7a65 206f 6620   actual size of 
-0000dd60: 7468 6520 696d 6167 6573 2e0a 2020 2020  the images..    
-0000dd70: 2020 2020 5468 6973 2077 6179 2c20 7468      This way, th
-0000dd80: 6520 6e75 6d62 6572 206f 6620 6974 6572  e number of iter
-0000dd90: 6174 696f 6e73 2077 6974 6820 6269 6720  ations with big 
-0000dda0: 696d 6167 6573 2063 616e 2062 6520 6469  images can be di
-0000ddb0: 6d69 6e69 7368 6564 2c20 616e 640a 2020  minished, and.  
-0000ddc0: 2020 2020 2020 7468 6520 6d65 7468 6f64        the method
-0000ddd0: 2063 6f6e 7665 7267 6573 2066 6173 7465   converges faste
-0000dde0: 722e 0a0a 2020 2020 2020 2020 3a70 6172  r...        :par
-0000ddf0: 616d 2069 6e74 206e 756d 5f63 6f6d 706f  am int num_compo
-0000de00: 6e65 6e74 733a 204e 756d 6265 7220 6f66  nents: Number of
-0000de10: 2063 6f6d 706f 6e65 6e74 7320 746f 2066   components to f
-0000de20: 696e 642e 0a20 2020 2020 2020 203a 7061  ind..        :pa
-0000de30: 7261 6d20 6172 7261 795f 6c69 6b65 2069  ram array_like i
-0000de40: 7465 7261 7469 6f6e 733a 2041 7272 6179  terations: Array
-0000de50: 2077 6974 6820 6e75 6d62 6572 206f 6620   with number of 
-0000de60: 6974 6572 6174 696f 6e73 2070 6572 2073  iterations per s
-0000de70: 7465 7020 6f66 2074 6865 2077 6174 6572  tep of the water
-0000de80: 6661 6c6c 2e0a 2020 2020 2020 2020 2020  fall..          
-0000de90: 2020 5468 6520 7369 7a65 206f 6620 7468    The size of th
-0000dea0: 6520 6172 7261 7920 7365 7473 2074 6865  e array sets the
-0000deb0: 2073 697a 6520 6f66 2074 6865 2077 6174   size of the wat
-0000dec0: 6572 6661 6c6c 2e0a 2020 2020 2020 2020  erfall..        
-0000ded0: 3a70 6172 616d 2055 6e69 6f6e 5b4e 6f6e  :param Union[Non
-0000dee0: 652c 2061 7272 6179 5f6c 696b 655d 2069  e, array_like] i
-0000def0: 6e64 6963 6573 3a20 4966 206e 6f74 204e  ndices: If not N
-0000df00: 6f6e 652c 2061 7070 6c79 206d 6574 686f  one, apply metho
-0000df10: 6420 6f6e 6c79 2074 6f20 696e 6469 6365  d only to indice
-0000df20: 7320 6f66 2064 6174 612e 0a20 2020 2020  s of data..     
-0000df30: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
-0000df40: 6672 6f6d 2073 6b69 6d61 6765 2e74 7261  from skimage.tra
-0000df50: 6e73 666f 726d 2069 6d70 6f72 7420 7265  nsform import re
-0000df60: 7369 7a65 0a20 2020 2020 2020 2069 6d70  size.        imp
-0000df70: 6f72 7420 7368 7574 696c 0a0a 2020 2020  ort shutil..    
-0000df80: 2020 2020 5720 3d20 4e6f 6e65 0a20 2020      W = None.   
-0000df90: 2020 2020 2048 203d 204e 6f6e 650a 2020       H = None.  
-0000dfa0: 2020 2020 2020 7368 6170 6520 3d20 6e75        shape = nu
-0000dfb0: 6d70 792e 6173 6172 7261 7928 7365 6c66  mpy.asarray(self
-0000dfc0: 2e67 6574 5f64 6174 6128 3029 2e73 6861  .get_data(0).sha
-0000dfd0: 7065 290a 2020 2020 2020 2020 6669 7273  pe).        firs
-0000dfe0: 745f 7369 7a65 203d 2028 7368 6170 6520  t_size = (shape 
-0000dff0: 2f20 286c 656e 2869 7465 7261 7469 6f6e  / (len(iteration
-0000e000: 7329 202b 2031 2929 2e61 7374 7970 6528  s) + 1)).astype(
-0000e010: 696e 7429 0a20 2020 2020 2020 2073 697a  int).        siz
-0000e020: 6520 3d20 6669 7273 745f 7369 7a65 0a0a  e = first_size..
-0000e030: 2020 2020 2020 2020 6f73 2e6d 616b 6564          os.maked
-0000e040: 6972 7328 6f73 2e70 6174 682e 6a6f 696e  irs(os.path.join
-0000e050: 2873 656c 662e 6469 722c 2022 7761 7465  (self.dir, "wate
-0000e060: 7266 616c 6c22 292c 2065 7869 7374 5f6f  rfall"), exist_o
-0000e070: 6b3d 5472 7565 290a 0a20 2020 2020 2020  k=True)..       
-0000e080: 205f 6c6f 6767 6572 2e69 6e66 6f28 2253   _logger.info("S
-0000e090: 7461 7274 696e 6720 7761 7465 7266 616c  tarting waterfal
-0000e0a0: 6c20 4e4d 4622 290a 0a20 2020 2020 2020  l NMF")..       
-0000e0b0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-0000e0c0: 6c65 6e28 6974 6572 6174 696f 6e73 2929  len(iterations))
-0000e0d0: 3a0a 2020 2020 2020 2020 2020 2020 6e65  :.            ne
-0000e0e0: 775f 7572 6c73 203d 205b 5d0a 2020 2020  w_urls = [].    
-0000e0f0: 2020 2020 2020 2020 6966 2069 6e64 6963          if indic
-0000e100: 6573 2069 7320 4e6f 6e65 3a0a 2020 2020  es is None:.    
-0000e110: 2020 2020 2020 2020 2020 2020 696e 6469              indi
-0000e120: 6365 7320 3d20 7261 6e67 6528 7365 6c66  ces = range(self
-0000e130: 2e6e 6672 616d 6573 290a 2020 2020 2020  .nframes).      
-0000e140: 2020 2020 2020 666f 7220 6a20 696e 2069        for j in i
-0000e150: 6e64 6963 6573 3a0a 2020 2020 2020 2020  ndices:.        
-0000e160: 2020 2020 2020 2020 6669 6c65 6e61 6d65          filename
-0000e170: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
-0000e180: 7365 6c66 2e64 6972 2c20 2277 6174 6572  self.dir, "water
-0000e190: 6661 6c6c 222c 2073 7472 286a 2920 2b20  fall", str(j) + 
-0000e1a0: 222e 6e70 7922 290a 2020 2020 2020 2020  ".npy").        
-0000e1b0: 2020 2020 2020 2020 6e75 6d70 792e 7361          numpy.sa
-0000e1c0: 7665 2866 696c 656e 616d 652c 2072 6573  ve(filename, res
-0000e1d0: 697a 6528 7365 6c66 2e67 6574 5f64 6174  ize(self.get_dat
-0000e1e0: 6128 6a29 2c20 7369 7a65 2929 0a20 2020  a(j), size)).   
-0000e1f0: 2020 2020 2020 2020 2020 2020 206e 6577               new
-0000e200: 5f75 726c 732e 6170 7065 6e64 2844 6174  _urls.append(Dat
-0000e210: 6155 726c 2866 696c 655f 7061 7468 3d66  aUrl(file_path=f
-0000e220: 696c 656e 616d 652c 2073 6368 656d 653d  ilename, scheme=
-0000e230: 2266 6162 696f 2229 290a 2020 2020 2020  "fabio")).      
-0000e240: 2020 2020 2020 6461 7461 203d 2044 6174        data = Dat
-0000e250: 6128 6e65 775f 7572 6c73 2c20 7365 6c66  a(new_urls, self
-0000e260: 2e67 6574 5f64 6174 6128 696e 6469 6365  .get_data(indice
-0000e270: 7329 2e6d 6574 6164 6174 612c 2073 656c  s).metadata, sel
-0000e280: 662e 5f69 6e5f 6d65 6d6f 7279 290a 2020  f._in_memory).  
-0000e290: 2020 2020 2020 2020 2020 6461 7461 7365            datase
-0000e2a0: 7420 3d20 4461 7461 7365 7428 0a20 2020  t = Dataset(.   
-0000e2b0: 2020 2020 2020 2020 2020 2020 205f 6469               _di
-0000e2c0: 723d 6f73 2e70 6174 682e 6a6f 696e 2873  r=os.path.join(s
-0000e2d0: 656c 662e 6469 722c 2022 7761 7465 7266  elf.dir, "waterf
-0000e2e0: 616c 6c22 292c 0a20 2020 2020 2020 2020  all"),.         
-0000e2f0: 2020 2020 2020 2064 6174 613d 6461 7461         data=data
-0000e300: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000e310: 2020 696e 5f6d 656d 6f72 793d 7365 6c66    in_memory=self
-0000e320: 2e5f 696e 5f6d 656d 6f72 792c 0a20 2020  ._in_memory,.   
-0000e330: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0000e340: 2020 2020 2020 2069 6620 7673 7465 703a         if vstep:
-0000e350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e360: 2076 5f73 7465 7020 3d20 7673 7465 7020   v_step = vstep 
-0000e370: 2a20 286c 656e 2869 7465 7261 7469 6f6e  * (len(iteration
-0000e380: 7329 202d 2069 290a 2020 2020 2020 2020  s) - i).        
-0000e390: 2020 2020 6966 2068 7374 6570 3a0a 2020      if hstep:.  
-0000e3a0: 2020 2020 2020 2020 2020 2020 2020 685f                h_
-0000e3b0: 7374 6570 203d 2068 7374 6570 202a 2028  step = hstep * (
-0000e3c0: 6c65 6e28 6974 6572 6174 696f 6e73 2920  len(iterations) 
-0000e3d0: 2d20 6929 0a20 2020 2020 2020 2020 2020  - i).           
-0000e3e0: 2048 2c20 5720 3d20 6461 7461 7365 742e   H, W = dataset.
-0000e3f0: 6e6d 6628 0a20 2020 2020 2020 2020 2020  nmf(.           
-0000e400: 2020 2020 206e 756d 5f63 6f6d 706f 6e65       num_compone
-0000e410: 6e74 732c 2069 7465 7261 7469 6f6e 735b  nts, iterations[
-0000e420: 695d 2c20 573d 572c 2048 3d48 2c20 7673  i], W=W, H=H, vs
-0000e430: 7465 703d 765f 7374 6570 2c20 6873 7465  tep=v_step, hste
-0000e440: 703d 685f 7374 6570 0a20 2020 2020 2020  p=h_step.       
-0000e450: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0000e460: 2020 2073 697a 6520 3d20 6669 7273 745f     size = first_
-0000e470: 7369 7a65 202a 2028 6920 2b20 3229 0a20  size * (i + 2). 
-0000e480: 2020 2020 2020 2020 2020 2048 3220 3d20             H2 = 
-0000e490: 6e75 6d70 792e 656d 7074 7928 2848 2e73  numpy.empty((H.s
-0000e4a0: 6861 7065 5b30 5d2c 2073 697a 655b 305d  hape[0], size[0]
-0000e4b0: 202a 2073 697a 655b 315d 2929 0a20 2020   * size[1])).   
-0000e4c0: 2020 2020 2020 2020 2066 6f72 2072 6f77           for row
-0000e4d0: 2069 6e20 7261 6e67 6528 482e 7368 6170   in range(H.shap
-0000e4e0: 655b 305d 293a 0a20 2020 2020 2020 2020  e[0]):.         
-0000e4f0: 2020 2020 2020 2048 325b 726f 775d 203d         H2[row] =
-0000e500: 2072 6573 697a 6528 485b 726f 775d 2e72   resize(H[row].r
-0000e510: 6573 6861 7065 2828 6920 2b20 3129 202a  eshape((i + 1) *
-0000e520: 2066 6972 7374 5f73 697a 6529 2c20 7369   first_size), si
-0000e530: 7a65 292e 666c 6174 7465 6e28 290a 2020  ze).flatten().  
-0000e540: 2020 2020 2020 2020 2020 4820 3d20 4832            H = H2
-0000e550: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
-0000e560: 2020 2020 2020 2020 2020 2073 6875 7469             shuti
-0000e570: 6c2e 726d 7472 6565 286f 732e 7061 7468  l.rmtree(os.path
-0000e580: 2e6a 6f69 6e28 7365 6c66 2e64 6972 2c20  .join(self.dir, 
-0000e590: 2277 6174 6572 6661 6c6c 2229 290a 2020  "waterfall")).  
-0000e5a0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-0000e5b0: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
-0000e5c0: 2020 2020 2020 2020 2070 7269 6e74 280a           print(.
-0000e5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e5e0: 2246 6169 6c65 6420 746f 2064 656c 6574  "Failed to delet
-0000e5f0: 6520 2573 2e20 5265 6173 6f6e 3a20 2573  e %s. Reason: %s
-0000e600: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0000e610: 2020 2520 286f 732e 7061 7468 2e6a 6f69    % (os.path.joi
-0000e620: 6e28 7365 6c66 2e64 6972 2c20 2277 6174  n(self.dir, "wat
-0000e630: 6572 6661 6c6c 2229 2c20 6529 0a20 2020  erfall"), e).   
-0000e640: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0000e650: 2020 2020 4820 3d20 7265 7369 7a65 2848      H = resize(H
-0000e660: 2c20 286e 756d 5f63 6f6d 706f 6e65 6e74  , (num_component
-0000e670: 732c 2073 6861 7065 5b30 5d20 2a20 7368  s, shape[0] * sh
-0000e680: 6170 655b 315d 2929 0a0a 2020 2020 2020  ape[1]))..      
-0000e690: 2020 7265 7475 726e 2048 2c20 570a 0a20    return H, W.. 
-0000e6a0: 2020 2064 6566 2070 6361 2873 656c 662c     def pca(self,
-0000e6b0: 206e 756d 5f63 6f6d 706f 6e65 6e74 733d   num_components=
-0000e6c0: 4e6f 6e65 2c20 6368 756e 6b5f 7369 7a65  None, chunk_size
-0000e6d0: 3d35 3030 2c20 696e 6469 6365 733d 4e6f  =500, indices=No
-0000e6e0: 6e65 2c20 7265 7475 726e 5f76 616c 733d  ne, return_vals=
-0000e6f0: 4661 6c73 6529 3a0a 2020 2020 2020 2020  False):.        
-0000e700: 2222 220a 2020 2020 2020 2020 436f 6d70  """.        Comp
-0000e710: 7574 6520 5072 696e 6369 7061 6c20 436f  ute Principal Co
-0000e720: 6d70 6f6e 656e 7420 416e 616c 7973 6973  mponent Analysis
-0000e730: 206f 6e20 7468 6520 6461 7461 2e0a 2020   on the data..  
-0000e740: 2020 2020 2020 5468 6520 6d65 7468 6f64        The method
-0000e750: 2c20 6669 7273 7420 636f 6e76 6572 7473  , first converts
-0000e760: 2c20 6966 206e 6f74 2061 6c72 6561 6479  , if not already
-0000e770: 2c20 7468 6520 6461 7461 2069 6e74 6f20  , the data into 
-0000e780: 616e 2068 6466 3520 6669 6c65 206f 626a  an hdf5 file obj
-0000e790: 6563 740a 2020 2020 2020 2020 7769 7468  ect.        with
-0000e7a0: 2074 6865 2069 6d61 6765 7320 666c 6174   the images flat
-0000e7b0: 7465 6e65 6420 696e 2074 6865 2072 6f77  tened in the row
-0000e7c0: 732e 0a0a 2020 2020 2020 2020 3a70 6172  s...        :par
-0000e7d0: 616d 206e 756d 5f63 6f6d 706f 6e65 6e74  am num_component
-0000e7e0: 733a 204e 756d 6265 7220 6f66 2063 6f6d  s: Number of com
-0000e7f0: 706f 6e65 6e74 7320 746f 2066 696e 642e  ponents to find.
-0000e800: 0a20 2020 2020 2020 2020 2020 2049 6620  .            If 
-0000e810: 4e6f 6e65 2c20 6974 2075 7365 7320 7468  None, it uses th
-0000e820: 6520 6d69 6e69 6d75 6d20 6265 7477 6565  e minimum betwee
-0000e830: 6e20 7468 6520 6e75 6d62 6572 206f 6620  n the number of 
-0000e840: 696d 6167 6573 2061 6e64 2074 6865 0a20  images and the. 
-0000e850: 2020 2020 2020 2020 2020 206e 756d 6265             numbe
-0000e860: 7220 6f66 2070 6978 656c 732e 0a20 2020  r of pixels..   
-0000e870: 2020 2020 203a 7479 7065 206e 756d 5f63       :type num_c
-0000e880: 6f6d 706f 6e65 6e74 733a 2055 6e69 6f6e  omponents: Union
-0000e890: 5b4e 6f6e 652c 2069 6e74 5d0a 2020 2020  [None, int].    
-0000e8a0: 2020 2020 3a70 6172 616d 2063 6875 6e6b      :param chunk
-0000e8b0: 5f73 697a 653a 204e 756d 6265 7220 6f66  _size: Number of
-0000e8c0: 2063 6875 6e6b 7320 666f 7220 7768 6963   chunks for whic
-0000e8d0: 6820 7468 6520 7768 6974 656e 696e 6720  h the whitening 
-0000e8e0: 6d75 7374 2062 6520 636f 6d70 7574 6564  must be computed
-0000e8f0: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
-0000e900: 6372 656d 656e 7461 6c6c 792c 2064 6566  crementally, def
-0000e910: 6175 6c74 7320 746f 204e 6f6e 650a 2020  aults to None.  
-0000e920: 2020 2020 2020 3a74 7970 6520 6368 756e        :type chun
-0000e930: 6b73 697a 653a 2055 6e69 6f6e 5b4e 6f6e  ksize: Union[Non
-0000e940: 652c 2069 6e74 5d2c 206f 7074 696f 6e61  e, int], optiona
-0000e950: 6c0a 2020 2020 2020 2020 3a70 6172 616d  l.        :param
-0000e960: 2069 6e64 6963 6573 3a20 4966 206e 6f74   indices: If not
-0000e970: 204e 6f6e 652c 2061 7070 6c79 206d 6574   None, apply met
-0000e980: 686f 6420 6f6e 6c79 2074 6f20 696e 6469  hod only to indi
-0000e990: 6365 7320 6f66 2064 6174 612c 2064 6566  ces of data, def
-0000e9a0: 6175 6c74 7320 746f 204e 6f6e 650a 2020  aults to None.  
-0000e9b0: 2020 2020 2020 3a74 7970 6520 696e 6469        :type indi
-0000e9c0: 6365 733a 2055 6e69 6f6e 5b4e 6f6e 652c  ces: Union[None,
-0000e9d0: 2061 7272 6179 5f6c 696b 655d 2c20 6f70   array_like], op
-0000e9e0: 7469 6f6e 616c 0a20 2020 2020 2020 203a  tional.        :
-0000e9f0: 7061 7261 6d20 7265 7475 726e 5f76 616c  param return_val
-0000ea00: 733a 2049 6620 5472 7565 2c20 7265 7475  s: If True, retu
-0000ea10: 726e 7320 6f6e 6c79 2074 6865 2073 696e  rns only the sin
-0000ea20: 6775 6c61 7220 7661 6c75 6573 206f 6620  gular values of 
-0000ea30: 5043 412c 2065 6c73 6520 7265 7475 726e  PCA, else return
-0000ea40: 730a 2020 2020 2020 2020 2020 2020 7468  s.            th
-0000ea50: 6520 636f 6d70 6f6e 656e 7473 2061 6e64  e components and
-0000ea60: 2074 6865 206d 6978 696e 6720 6d61 7472   the mixing matr
-0000ea70: 6978 2c20 6465 6661 756c 7473 2074 6f20  ix, defaults to 
-0000ea80: 4661 6c73 650a 2020 2020 2020 2020 3a74  False.        :t
-0000ea90: 7970 6520 7265 7475 726e 5f76 616c 733a  ype return_vals:
-0000eaa0: 2062 6f6f 6c2c 206f 7074 696f 6e61 6c0a   bool, optional.
-0000eab0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-0000eac0: 3a20 2848 2c20 5729 3a20 5468 6520 636f  : (H, W): The co
-0000ead0: 6d70 6f6e 656e 7473 206d 6174 7269 7820  mponents matrix 
-0000eae0: 616e 6420 7468 6520 6d69 7869 6e67 206d  and the mixing m
-0000eaf0: 6174 7269 782e 0a20 2020 2020 2020 2022  atrix..        "
-0000eb00: 2222 0a20 2020 2020 2020 2062 7373 5f64  "".        bss_d
-0000eb10: 6972 203d 206f 732e 7061 7468 2e6a 6f69  ir = os.path.joi
-0000eb20: 6e28 7365 6c66 2e64 6972 2c20 2262 7373  n(self.dir, "bss
-0000eb30: 2229 0a20 2020 2020 2020 206f 732e 6d61  ").        os.ma
-0000eb40: 6b65 6469 7273 2862 7373 5f64 6972 2c20  kedirs(bss_dir, 
-0000eb50: 6578 6973 745f 6f6b 3d54 7275 6529 0a20  exist_ok=True). 
-0000eb60: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
-0000eb70: 696e 5f6d 656d 6f72 793a 0a20 2020 2020  in_memory:.     
-0000eb80: 2020 2020 2020 2066 726f 6d20 736b 6c65         from skle
-0000eb90: 6172 6e20 696d 706f 7274 2064 6563 6f6d  arn import decom
-0000eba0: 706f 7369 7469 6f6e 0a0a 2020 2020 2020  position..      
-0000ebb0: 2020 2020 2020 6d6f 6465 6c20 3d20 6465        model = de
-0000ebc0: 636f 6d70 6f73 6974 696f 6e2e 5043 4128  composition.PCA(
-0000ebd0: 6e5f 636f 6d70 6f6e 656e 7473 3d6e 756d  n_components=num
-0000ebe0: 5f63 6f6d 706f 6e65 6e74 7329 0a0a 2020  _components)..  
-0000ebf0: 2020 2020 2020 2020 2020 7769 7468 2073            with s
-0000ec00: 656c 662e 6461 7461 2e6f 7065 6e5f 6173  elf.data.open_as
-0000ec10: 5f68 6466 3528 6273 735f 6469 7229 2061  _hdf5(bss_dir) a
-0000ec20: 7320 6835 6473 6574 3a0a 2020 2020 2020  s h5dset:.      
-0000ec30: 2020 2020 2020 2020 2020 6966 2069 6e64            if ind
-0000ec40: 6963 6573 2069 7320 6e6f 7420 4e6f 6e65  ices is not None
-0000ec50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000ec60: 2020 2020 2020 5720 3d20 6d6f 6465 6c2e        W = model.
-0000ec70: 6669 745f 7472 616e 7366 6f72 6d28 6835  fit_transform(h5
-0000ec80: 6473 6574 5b69 6e64 6963 6573 5d29 0a20  dset[indices]). 
-0000ec90: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000eca0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000ecb0: 2020 2020 2020 2020 2057 203d 206d 6f64           W = mod
-0000ecc0: 656c 2e66 6974 5f74 7261 6e73 666f 726d  el.fit_transform
-0000ecd0: 2868 3564 7365 745b 3a2c 203a 5d29 0a0a  (h5dset[:, :])..
-0000ece0: 2020 2020 2020 2020 2020 2020 482c 2076              H, v
-0000ecf0: 616c 732c 2057 203d 206d 6f64 656c 2e63  als, W = model.c
-0000ed00: 6f6d 706f 6e65 6e74 735f 2c20 6d6f 6465  omponents_, mode
-0000ed10: 6c2e 7369 6e67 756c 6172 5f76 616c 7565  l.singular_value
-0000ed20: 735f 2c20 570a 2020 2020 2020 2020 656c  s_, W.        el
-0000ed30: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000ed40: 7769 7468 2073 656c 662e 6461 7461 2e6f  with self.data.o
-0000ed50: 7065 6e5f 6173 5f68 6466 3528 6273 735f  pen_as_hdf5(bss_
-0000ed60: 6469 7229 2061 7320 6835 6473 6574 3a0a  dir) as h5dset:.
-0000ed70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed80: 6d6f 6465 6c20 3d20 4950 4341 280a 2020  model = IPCA(.  
-0000ed90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eda0: 2020 6835 6473 6574 2c0a 2020 2020 2020    h5dset,.      
-0000edb0: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-0000edc0: 756e 6b5f 7369 7a65 2c0a 2020 2020 2020  unk_size,.      
-0000edd0: 2020 2020 2020 2020 2020 2020 2020 6e75                nu
-0000ede0: 6d5f 636f 6d70 6f6e 656e 7473 2c0a 2020  m_components,.  
-0000edf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee00: 2020 696e 6469 6365 733d 696e 6469 6365    indices=indice
-0000ee10: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-0000ee20: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0000ee30: 2020 2020 2077 6974 6820 6835 7079 2e46       with h5py.F
-0000ee40: 696c 6528 6f73 2e70 6174 682e 6a6f 696e  ile(os.path.join
-0000ee50: 2862 7373 5f64 6972 2c20 2269 7063 612e  (bss_dir, "ipca.
-0000ee60: 6864 6635 2229 2c20 2277 2229 2061 7320  hdf5"), "w") as 
-0000ee70: 6669 6c65 3a0a 2020 2020 2020 2020 2020  file:.          
-0000ee80: 2020 2020 2020 2020 2020 6669 6c65 5b22            file["
-0000ee90: 5722 5d20 3d20 6e75 6d70 792e 7261 6e64  W"] = numpy.rand
-0000eea0: 6f6d 2e72 616e 646f 6d28 0a20 2020 2020  om.random(.     
-0000eeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eec0: 2020 2028 6d6f 6465 6c2e 6e75 6d5f 7361     (model.num_sa
-0000eed0: 6d70 6c65 732c 206d 6f64 656c 2e6e 756d  mples, model.num
-0000eee0: 5f63 6f6d 706f 6e65 6e74 7329 0a20 2020  _components).   
-0000eef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ef00: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0000ef10: 2020 2020 2020 2066 696c 655b 2248 225d         file["H"]
-0000ef20: 203d 206e 756d 7079 2e72 616e 646f 6d2e   = numpy.random.
-0000ef30: 7261 6e64 6f6d 280a 2020 2020 2020 2020  random(.        
-0000ef40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ef50: 286d 6f64 656c 2e6e 756d 5f63 6f6d 706f  (model.num_compo
-0000ef60: 6e65 6e74 732c 206d 6f64 656c 2e6e 756d  nents, model.num
-0000ef70: 5f66 6561 7475 7265 7329 0a20 2020 2020  _features).     
-0000ef80: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0000ef90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000efa0: 2020 2020 2077 6974 6820 7761 726e 696e       with warnin
-0000efb0: 6773 2e63 6174 6368 5f77 6172 6e69 6e67  gs.catch_warning
-0000efc0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0000efd0: 2020 2020 2020 2020 2020 2020 2023 2073               # s
-0000efe0: 6369 6b69 745f 6c65 6172 6e3c 312e 312e  cikit_learn<1.1.
-0000eff0: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-0000f000: 2020 2020 2020 2020 2020 7761 726e 696e            warnin
-0000f010: 6773 2e66 696c 7465 7277 6172 6e69 6e67  gs.filterwarning
-0000f020: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-0000f030: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000f040: 616c 7761 7973 222c 2022 4d65 616e 206f  always", "Mean o
-0000f050: 6620 656d 7074 7920 736c 6963 652e 222c  f empty slice.",
-0000f060: 2052 756e 7469 6d65 5761 726e 696e 670a   RuntimeWarning.
+0000d2a0: 2020 2020 6966 2069 6e64 6963 6573 2069      if indices i
+0000d2b0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0000d2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d2d0: 2020 2020 6e65 775f 7572 6c73 203d 206e      new_urls = n
+0000d2e0: 756d 7079 2e61 7272 6179 2873 656c 662e  umpy.array(self.
+0000d2f0: 6461 7461 2e75 726c 732c 2064 7479 7065  data.urls, dtype
+0000d300: 3d6f 626a 6563 7429 2e66 6c61 7474 656e  =object).flatten
+0000d310: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0000d320: 2020 2020 2020 2020 2020 206e 756d 7079             numpy
+0000d330: 2e70 7574 286e 6577 5f75 726c 732c 2069  .put(new_urls, i
+0000d340: 6e64 6963 6573 2c20 7572 6c73 290a 2020  ndices, urls).  
+0000d350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d360: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000d370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d380: 6e65 775f 7572 6c73 203d 206e 756d 7079  new_urls = numpy
+0000d390: 2e61 7272 6179 2875 726c 7329 0a0a 2020  .array(urls)..  
+0000d3a0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000d3b0: 2064 6174 6173 6574 5f6e 616d 6520 3d3d   dataset_name ==
+0000d3c0: 2022 7570 6461 7465 5f64 6174 6173 6574   "update_dataset
+0000d3d0: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+0000d3e0: 2020 2020 2020 2064 656c 205f 6669 6c65         del _file
+0000d3f0: 5b22 6461 7461 7365 7422 5d0a 2020 2020  ["dataset"].    
+0000d400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d410: 5f66 696c 655b 2264 6174 6173 6574 225d  _file["dataset"]
+0000d420: 203d 205f 6669 6c65 5b22 7570 6461 7465   = _file["update
+0000d430: 5f64 6174 6173 6574 225d 0a20 2020 2020  _dataset"].     
+0000d440: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0000d450: 656c 205f 6669 6c65 5b22 7570 6461 7465  el _file["update
+0000d460: 5f64 6174 6173 6574 225d 0a20 2020 2020  _dataset"].     
+0000d470: 2020 2020 2020 2066 696e 616c 6c79 3a0a         finally:.
+0000d480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d490: 6966 205f 6669 6c65 2069 7320 6e6f 7420  if _file is not 
+0000d4a0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000d4b0: 2020 2020 2020 2020 2020 5f66 696c 652e            _file.
+0000d4c0: 636c 6f73 6528 290a 0a20 2020 2020 2020  close()..       
+0000d4d0: 2064 6174 6120 3d20 4461 7461 280a 2020   data = Data(.  
+0000d4e0: 2020 2020 2020 2020 2020 6e65 775f 7572            new_ur
+0000d4f0: 6c73 2e72 6573 6861 7065 2873 656c 662e  ls.reshape(self.
+0000d500: 6461 7461 2e75 726c 732e 7368 6170 6529  data.urls.shape)
+0000d510: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
+0000d520: 6c66 2e64 6174 612e 6d65 7461 6461 7461  lf.data.metadata
+0000d530: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
+0000d540: 5f6d 656d 6f72 793d 7365 6c66 2e5f 696e  _memory=self._in
+0000d550: 5f6d 656d 6f72 792c 0a20 2020 2020 2020  _memory,.       
+0000d560: 2029 0a20 2020 2020 2020 2072 6574 7572   ).        retur
+0000d570: 6e20 4461 7461 7365 7428 0a20 2020 2020  n Dataset(.     
+0000d580: 2020 2020 2020 205f 6469 723d 5f64 6972         _dir=_dir
+0000d590: 2c0a 2020 2020 2020 2020 2020 2020 6461  ,.            da
+0000d5a0: 7461 3d64 6174 612c 0a20 2020 2020 2020  ta=data,.       
+0000d5b0: 2020 2020 2064 696d 733d 7365 6c66 2e5f       dims=self._
+0000d5c0: 5f64 696d 732c 0a20 2020 2020 2020 2020  _dims,.         
+0000d5d0: 2020 2074 7261 6e73 666f 726d 6174 696f     transformatio
+0000d5e0: 6e3d 7365 6c66 2e74 7261 6e73 666f 726d  n=self.transform
+0000d5f0: 6174 696f 6e2c 0a20 2020 2020 2020 2020  ation,.         
+0000d600: 2020 2069 6e5f 6d65 6d6f 7279 3d73 656c     in_memory=sel
+0000d610: 662e 5f69 6e5f 6d65 6d6f 7279 2c0a 2020  f._in_memory,.  
+0000d620: 2020 2020 2020 2020 2020 7469 746c 653d            title=
+0000d630: 7365 6c66 2e74 6974 6c65 2c0a 2020 2020  self.title,.    
+0000d640: 2020 2020 290a 0a20 2020 2064 6566 2066      )..    def f
+0000d650: 696e 645f 616e 645f 6170 706c 795f 7368  ind_and_apply_sh
+0000d660: 6966 7428 0a20 2020 2020 2020 2073 656c  ift(.        sel
+0000d670: 662c 0a20 2020 2020 2020 2064 696d 656e  f,.        dimen
+0000d680: 7369 6f6e 3d4e 6f6e 652c 0a20 2020 2020  sion=None,.     
+0000d690: 2020 2073 7465 7073 3d31 3030 2c0a 2020     steps=100,.  
+0000d6a0: 2020 2020 2020 7368 6966 745f 6170 7072        shift_appr
+0000d6b0: 6f61 6368 3d22 6666 7422 2c0a 2020 2020  oach="fft",.    
+0000d6c0: 2020 2020 696e 6469 6365 733d 4e6f 6e65      indices=None
+0000d6d0: 2c0a 2020 2020 2020 2020 6361 6c6c 6261  ,.        callba
+0000d6e0: 636b 3d4e 6f6e 652c 0a20 2020 2029 3a0a  ck=None,.    ):.
+0000d6f0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000d700: 2020 2020 4669 6e64 2074 6865 2073 6869      Find the shi
+0000d710: 6674 206f 6620 7468 6520 6461 7461 206f  ft of the data o
+0000d720: 7220 7061 7274 206f 6620 6974 2061 6e64  r part of it and
+0000d730: 2061 7070 6c79 2069 742e 0a0a 2020 2020   apply it...    
+0000d740: 2020 2020 3a70 6172 616d 2064 696d 656e      :param dimen
+0000d750: 7369 6f6e 3a20 5061 7261 6d65 7465 7320  sion: Parametes 
+0000d760: 7769 7468 2074 6865 2070 6f73 6974 696f  with the positio
+0000d770: 6e20 6f66 2074 6865 2064 6174 6120 696e  n of the data in
+0000d780: 2074 6865 2072 6573 6861 7065 640a 2020   the reshaped.  
+0000d790: 2020 2020 2020 2020 2020 6172 7261 792e            array.
+0000d7a0: 0a20 2020 2020 2020 203a 7479 7065 2064  .        :type d
+0000d7b0: 696d 656e 7369 6f6e 3a20 556e 696f 6e5b  imension: Union[
+0000d7c0: 4e6f 6e65 2c20 7475 706c 652c 2061 7272  None, tuple, arr
+0000d7d0: 6179 5f6c 696b 655d 0a20 2020 2020 2020  ay_like].       
+0000d7e0: 203a 7061 7261 6d20 666c 6f61 7420 685f   :param float h_
+0000d7f0: 6d61 783a 2053 6565 2060 636f 7265 2e69  max: See `core.i
+0000d800: 6d61 6765 5265 6769 7374 7261 7469 6f6e  mageRegistration
+0000d810: 2e73 6869 6674 5f64 6574 6563 7469 6f6e  .shift_detection
+0000d820: 600a 2020 2020 2020 2020 3a70 6172 616d  `.        :param
+0000d830: 2066 6c6f 6174 2068 5f73 7465 703a 2053   float h_step: S
+0000d840: 6565 2060 636f 7265 2e69 6d61 6765 5265  ee `core.imageRe
+0000d850: 6769 7374 7261 7469 6f6e 2e73 6869 6674  gistration.shift
+0000d860: 5f64 6574 6563 7469 6f6e 600a 2020 2020  _detection`.    
+0000d870: 2020 2020 3a70 6172 616d 2055 6e69 6f6e      :param Union
+0000d880: 5b27 6666 7427 2c20 276c 696e 6561 7227  ['fft', 'linear'
+0000d890: 5d20 7368 6966 745f 6170 7072 6f61 6368  ] shift_approach
+0000d8a0: 3a20 4d65 7468 6f64 2074 6f20 7573 6520  : Method to use 
+0000d8b0: 746f 2061 7070 6c79 2074 6865 2073 6869  to apply the shi
+0000d8c0: 6674 2e0a 2020 2020 2020 2020 3a70 6172  ft..        :par
+0000d8d0: 616d 2069 6e64 6963 6573 3a20 496e 6469  am indices: Indi
+0000d8e0: 6365 7320 6f66 2074 6865 2069 6d61 6765  ces of the image
+0000d8f0: 7320 746f 2066 696e 6420 616e 6420 6170  s to find and ap
+0000d900: 706c 7920 7468 6520 7368 6966 7420 746f  ply the shift to
+0000d910: 2e0a 2020 2020 2020 2020 2020 2020 4966  ..            If
+0000d920: 204e 6f6e 652c 2074 6865 2068 6f74 2070   None, the hot p
+0000d930: 6978 656c 2072 656d 6f76 616c 2069 7320  ixel removal is 
+0000d940: 6170 706c 6965 6420 746f 2061 6c6c 2074  applied to all t
+0000d950: 6865 2064 6174 612e 0a20 2020 2020 2020  he data..       
+0000d960: 203a 7479 7065 2069 6e64 6963 6573 3a20   :type indices: 
+0000d970: 556e 696f 6e5b 4e6f 6e65 2c20 6172 7261  Union[None, arra
+0000d980: 795f 6c69 6b65 5d0a 2020 2020 2020 2020  y_like].        
+0000d990: 3a70 6172 616d 2055 6e69 6f6e 5b66 756e  :param Union[fun
+0000d9a0: 6374 696f 6e2c 204e 6f6e 655d 2063 616c  ction, None] cal
+0000d9b0: 6c62 6163 6b3a 2043 616c 6c62 6163 6b0a  lback: Callback.
+0000d9c0: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
+0000d9d0: 3a20 4461 7461 7365 7420 7769 7468 2074  : Dataset with t
+0000d9e0: 6865 206e 6577 2064 6174 612e 0a20 2020  he new data..   
+0000d9f0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0000da00: 2073 6869 6674 203d 2073 656c 662e 6669   shift = self.fi
+0000da10: 6e64 5f73 6869 6674 2864 696d 656e 7369  nd_shift(dimensi
+0000da20: 6f6e 2c20 7374 6570 732c 2069 6e64 6963  on, steps, indic
+0000da30: 6573 3d69 6e64 6963 6573 290a 2020 2020  es=indices).    
+0000da40: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0000da50: 6170 706c 795f 7368 6966 7428 7368 6966  apply_shift(shif
+0000da60: 742c 2064 696d 656e 7369 6f6e 2c20 696e  t, dimension, in
+0000da70: 6469 6365 733d 696e 6469 6365 7329 0a0a  dices=indices)..
+0000da80: 2020 2020 6465 6620 5f77 6174 6572 6661      def _waterfa
+0000da90: 6c6c 5f6e 6d66 280a 2020 2020 2020 2020  ll_nmf(.        
+0000daa0: 7365 6c66 2c20 6e75 6d5f 636f 6d70 6f6e  self, num_compon
+0000dab0: 656e 7473 2c20 6974 6572 6174 696f 6e73  ents, iterations
+0000dac0: 2c20 7673 7465 703d 4e6f 6e65 2c20 6873  , vstep=None, hs
+0000dad0: 7465 703d 4e6f 6e65 2c20 696e 6469 6365  tep=None, indice
+0000dae0: 733d 4e6f 6e65 0a20 2020 2029 3a0a 2020  s=None.    ):.  
+0000daf0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0000db00: 2020 5468 6973 206d 6574 686f 6420 6973    This method is
+0000db10: 2075 7365 6420 6173 2061 2077 6179 2074   used as a way t
+0000db20: 6f20 696d 7072 6f76 6520 7468 6520 7370  o improve the sp
+0000db30: 6565 6420 6f66 2063 6f6e 7665 7267 656e  eed of convergen
+0000db40: 6365 206f 660a 2020 2020 2020 2020 7468  ce of.        th
+0000db50: 6520 4e4d 4620 6d65 7468 6f64 2e20 466f  e NMF method. Fo
+0000db60: 7220 7468 6973 2c20 6974 2075 7365 7320  r this, it uses 
+0000db70: 6120 7761 7465 7266 616c 6c20 6d6f 6465  a waterfall mode
+0000db80: 6c20 7768 6572 6520 6174 2065 7665 7279  l where at every
+0000db90: 2073 7465 700a 2020 2020 2020 2020 7468   step.        th
+0000dba0: 6520 6f75 7470 7574 206d 6174 7269 6365  e output matrice
+0000dbb0: 7320 7365 7276 6520 6173 2069 6e70 7574  s serve as input
+0000dbc0: 2066 6f72 2074 6865 206e 6578 742e 0a20   for the next.. 
+0000dbd0: 2020 2020 2020 2054 6861 7420 6973 2c20         That is, 
+0000dbe0: 7468 6520 6d65 7468 6f64 2073 7461 7274  the method start
+0000dbf0: 7320 7769 7468 2061 2073 6d61 6c6c 6572  s with a smaller
+0000dc00: 2072 6573 697a 6564 2069 6d61 6765 7320   resized images 
+0000dc10: 6f66 2074 6865 2064 6174 612c 0a20 2020  of the data,.   
+0000dc20: 2020 2020 2061 6e64 2063 6f6d 7075 7465       and compute
+0000dc30: 7320 7468 6520 4e4d 4620 6465 636f 6d70  s the NMF decomp
+0000dc40: 6f73 6974 696f 6e2e 2054 6865 206e 6578  osition. The nex
+0000dc50: 7420 7374 6570 2069 7320 7468 6520 7361  t step is the sa
+0000dc60: 6d65 2062 7574 2077 6974 680a 2020 2020  me but with.    
+0000dc70: 2020 2020 6269 6767 6572 2069 6d61 6765      bigger image
+0000dc80: 732c 2061 6e64 2075 7369 6e67 2061 7320  s, and using as 
+0000dc90: 696e 6974 6961 6c20 4820 616e 6420 5720  initial H and W 
+0000dca0: 7468 6520 7072 6563 6f6d 7075 7465 6420  the precomputed 
+0000dcb0: 6d61 7472 6963 6573 2e0a 2020 2020 2020  matrices..      
+0000dcc0: 2020 5468 6520 6c61 7374 2073 7465 7020    The last step 
+0000dcd0: 6973 2064 6f6e 6520 7573 696e 6720 7468  is done using th
+0000dce0: 6520 6163 7475 616c 2073 697a 6520 6f66  e actual size of
+0000dcf0: 2074 6865 2069 6d61 6765 732e 0a20 2020   the images..   
+0000dd00: 2020 2020 2054 6869 7320 7761 792c 2074       This way, t
+0000dd10: 6865 206e 756d 6265 7220 6f66 2069 7465  he number of ite
+0000dd20: 7261 7469 6f6e 7320 7769 7468 2062 6967  rations with big
+0000dd30: 2069 6d61 6765 7320 6361 6e20 6265 2064   images can be d
+0000dd40: 696d 696e 6973 6865 642c 2061 6e64 0a20  iminished, and. 
+0000dd50: 2020 2020 2020 2074 6865 206d 6574 686f         the metho
+0000dd60: 6420 636f 6e76 6572 6765 7320 6661 7374  d converges fast
+0000dd70: 6572 2e0a 0a20 2020 2020 2020 203a 7061  er...        :pa
+0000dd80: 7261 6d20 696e 7420 6e75 6d5f 636f 6d70  ram int num_comp
+0000dd90: 6f6e 656e 7473 3a20 4e75 6d62 6572 206f  onents: Number o
+0000dda0: 6620 636f 6d70 6f6e 656e 7473 2074 6f20  f components to 
+0000ddb0: 6669 6e64 2e0a 2020 2020 2020 2020 3a70  find..        :p
+0000ddc0: 6172 616d 2061 7272 6179 5f6c 696b 6520  aram array_like 
+0000ddd0: 6974 6572 6174 696f 6e73 3a20 4172 7261  iterations: Arra
+0000dde0: 7920 7769 7468 206e 756d 6265 7220 6f66  y with number of
+0000ddf0: 2069 7465 7261 7469 6f6e 7320 7065 7220   iterations per 
+0000de00: 7374 6570 206f 6620 7468 6520 7761 7465  step of the wate
+0000de10: 7266 616c 6c2e 0a20 2020 2020 2020 2020  rfall..         
+0000de20: 2020 2054 6865 2073 697a 6520 6f66 2074     The size of t
+0000de30: 6865 2061 7272 6179 2073 6574 7320 7468  he array sets th
+0000de40: 6520 7369 7a65 206f 6620 7468 6520 7761  e size of the wa
+0000de50: 7465 7266 616c 6c2e 0a20 2020 2020 2020  terfall..       
+0000de60: 203a 7061 7261 6d20 556e 696f 6e5b 4e6f   :param Union[No
+0000de70: 6e65 2c20 6172 7261 795f 6c69 6b65 5d20  ne, array_like] 
+0000de80: 696e 6469 6365 733a 2049 6620 6e6f 7420  indices: If not 
+0000de90: 4e6f 6e65 2c20 6170 706c 7920 6d65 7468  None, apply meth
+0000dea0: 6f64 206f 6e6c 7920 746f 2069 6e64 6963  od only to indic
+0000deb0: 6573 206f 6620 6461 7461 2e0a 2020 2020  es of data..    
+0000dec0: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
+0000ded0: 2066 726f 6d20 736b 696d 6167 652e 7472   from skimage.tr
+0000dee0: 616e 7366 6f72 6d20 696d 706f 7274 2072  ansform import r
+0000def0: 6573 697a 650a 2020 2020 2020 2020 696d  esize.        im
+0000df00: 706f 7274 2073 6875 7469 6c0a 0a20 2020  port shutil..   
+0000df10: 2020 2020 2057 203d 204e 6f6e 650a 2020       W = None.  
+0000df20: 2020 2020 2020 4820 3d20 4e6f 6e65 0a20        H = None. 
+0000df30: 2020 2020 2020 2073 6861 7065 203d 206e         shape = n
+0000df40: 756d 7079 2e61 7361 7272 6179 2873 656c  umpy.asarray(sel
+0000df50: 662e 6765 745f 6461 7461 2830 292e 7368  f.get_data(0).sh
+0000df60: 6170 6529 0a20 2020 2020 2020 2066 6972  ape).        fir
+0000df70: 7374 5f73 697a 6520 3d20 2873 6861 7065  st_size = (shape
+0000df80: 202f 2028 6c65 6e28 6974 6572 6174 696f   / (len(iteratio
+0000df90: 6e73 2920 2b20 3129 292e 6173 7479 7065  ns) + 1)).astype
+0000dfa0: 2869 6e74 290a 2020 2020 2020 2020 7369  (int).        si
+0000dfb0: 7a65 203d 2066 6972 7374 5f73 697a 650a  ze = first_size.
+0000dfc0: 0a20 2020 2020 2020 206f 732e 6d61 6b65  .        os.make
+0000dfd0: 6469 7273 286f 732e 7061 7468 2e6a 6f69  dirs(os.path.joi
+0000dfe0: 6e28 7365 6c66 2e64 6972 2c20 2277 6174  n(self.dir, "wat
+0000dff0: 6572 6661 6c6c 2229 2c20 6578 6973 745f  erfall"), exist_
+0000e000: 6f6b 3d54 7275 6529 0a0a 2020 2020 2020  ok=True)..      
+0000e010: 2020 5f6c 6f67 6765 722e 696e 666f 2822    _logger.info("
+0000e020: 5374 6172 7469 6e67 2077 6174 6572 6661  Starting waterfa
+0000e030: 6c6c 204e 4d46 2229 0a0a 2020 2020 2020  ll NMF")..      
+0000e040: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
+0000e050: 286c 656e 2869 7465 7261 7469 6f6e 7329  (len(iterations)
+0000e060: 293a 0a20 2020 2020 2020 2020 2020 206e  ):.            n
+0000e070: 6577 5f75 726c 7320 3d20 5b5d 0a20 2020  ew_urls = [].   
+0000e080: 2020 2020 2020 2020 2069 6620 696e 6469           if indi
+0000e090: 6365 7320 6973 204e 6f6e 653a 0a20 2020  ces is None:.   
+0000e0a0: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
+0000e0b0: 6963 6573 203d 2072 616e 6765 2873 656c  ices = range(sel
+0000e0c0: 662e 6e66 7261 6d65 7329 0a20 2020 2020  f.nframes).     
+0000e0d0: 2020 2020 2020 2066 6f72 206a 2069 6e20         for j in 
+0000e0e0: 696e 6469 6365 733a 0a20 2020 2020 2020  indices:.       
+0000e0f0: 2020 2020 2020 2020 2066 696c 656e 616d           filenam
+0000e100: 6520 3d20 6f73 2e70 6174 682e 6a6f 696e  e = os.path.join
+0000e110: 2873 656c 662e 6469 722c 2022 7761 7465  (self.dir, "wate
+0000e120: 7266 616c 6c22 2c20 7374 7228 6a29 202b  rfall", str(j) +
+0000e130: 2022 2e6e 7079 2229 0a20 2020 2020 2020   ".npy").       
+0000e140: 2020 2020 2020 2020 206e 756d 7079 2e73           numpy.s
+0000e150: 6176 6528 6669 6c65 6e61 6d65 2c20 7265  ave(filename, re
+0000e160: 7369 7a65 2873 656c 662e 6765 745f 6461  size(self.get_da
+0000e170: 7461 286a 292c 2073 697a 6529 290a 2020  ta(j), size)).  
+0000e180: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+0000e190: 775f 7572 6c73 2e61 7070 656e 6428 4461  w_urls.append(Da
+0000e1a0: 7461 5572 6c28 6669 6c65 5f70 6174 683d  taUrl(file_path=
+0000e1b0: 6669 6c65 6e61 6d65 2c20 7363 6865 6d65  filename, scheme
+0000e1c0: 3d22 6661 6269 6f22 2929 0a20 2020 2020  ="fabio")).     
+0000e1d0: 2020 2020 2020 2064 6174 6120 3d20 4461         data = Da
+0000e1e0: 7461 286e 6577 5f75 726c 732c 2073 656c  ta(new_urls, sel
+0000e1f0: 662e 6765 745f 6461 7461 2869 6e64 6963  f.get_data(indic
+0000e200: 6573 292e 6d65 7461 6461 7461 2c20 7365  es).metadata, se
+0000e210: 6c66 2e5f 696e 5f6d 656d 6f72 7929 0a20  lf._in_memory). 
+0000e220: 2020 2020 2020 2020 2020 2064 6174 6173             datas
+0000e230: 6574 203d 2044 6174 6173 6574 280a 2020  et = Dataset(.  
+0000e240: 2020 2020 2020 2020 2020 2020 2020 5f64                _d
+0000e250: 6972 3d6f 732e 7061 7468 2e6a 6f69 6e28  ir=os.path.join(
+0000e260: 7365 6c66 2e64 6972 2c20 2277 6174 6572  self.dir, "water
+0000e270: 6661 6c6c 2229 2c0a 2020 2020 2020 2020  fall"),.        
+0000e280: 2020 2020 2020 2020 6461 7461 3d64 6174          data=dat
+0000e290: 612c 0a20 2020 2020 2020 2020 2020 2020  a,.             
+0000e2a0: 2020 2069 6e5f 6d65 6d6f 7279 3d73 656c     in_memory=sel
+0000e2b0: 662e 5f69 6e5f 6d65 6d6f 7279 2c0a 2020  f._in_memory,.  
+0000e2c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000e2d0: 2020 2020 2020 2020 6966 2076 7374 6570          if vstep
+0000e2e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000e2f0: 2020 765f 7374 6570 203d 2076 7374 6570    v_step = vstep
+0000e300: 202a 2028 6c65 6e28 6974 6572 6174 696f   * (len(iteratio
+0000e310: 6e73 2920 2d20 6929 0a20 2020 2020 2020  ns) - i).       
+0000e320: 2020 2020 2069 6620 6873 7465 703a 0a20       if hstep:. 
+0000e330: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+0000e340: 5f73 7465 7020 3d20 6873 7465 7020 2a20  _step = hstep * 
+0000e350: 286c 656e 2869 7465 7261 7469 6f6e 7329  (len(iterations)
+0000e360: 202d 2069 290a 2020 2020 2020 2020 2020   - i).          
+0000e370: 2020 482c 2057 203d 2064 6174 6173 6574    H, W = dataset
+0000e380: 2e6e 6d66 280a 2020 2020 2020 2020 2020  .nmf(.          
+0000e390: 2020 2020 2020 6e75 6d5f 636f 6d70 6f6e        num_compon
+0000e3a0: 656e 7473 2c20 6974 6572 6174 696f 6e73  ents, iterations
+0000e3b0: 5b69 5d2c 2057 3d57 2c20 483d 482c 2076  [i], W=W, H=H, v
+0000e3c0: 7374 6570 3d76 5f73 7465 702c 2068 7374  step=v_step, hst
+0000e3d0: 6570 3d68 5f73 7465 700a 2020 2020 2020  ep=h_step.      
+0000e3e0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000e3f0: 2020 2020 7369 7a65 203d 2066 6972 7374      size = first
+0000e400: 5f73 697a 6520 2a20 2869 202b 2032 290a  _size * (i + 2).
+0000e410: 2020 2020 2020 2020 2020 2020 4832 203d              H2 =
+0000e420: 206e 756d 7079 2e65 6d70 7479 2828 482e   numpy.empty((H.
+0000e430: 7368 6170 655b 305d 2c20 7369 7a65 5b30  shape[0], size[0
+0000e440: 5d20 2a20 7369 7a65 5b31 5d29 290a 2020  ] * size[1])).  
+0000e450: 2020 2020 2020 2020 2020 666f 7220 726f            for ro
+0000e460: 7720 696e 2072 616e 6765 2848 2e73 6861  w in range(H.sha
+0000e470: 7065 5b30 5d29 3a0a 2020 2020 2020 2020  pe[0]):.        
+0000e480: 2020 2020 2020 2020 4832 5b72 6f77 5d20          H2[row] 
+0000e490: 3d20 7265 7369 7a65 2848 5b72 6f77 5d2e  = resize(H[row].
+0000e4a0: 7265 7368 6170 6528 2869 202b 2031 2920  reshape((i + 1) 
+0000e4b0: 2a20 6669 7273 745f 7369 7a65 292c 2073  * first_size), s
+0000e4c0: 697a 6529 2e66 6c61 7474 656e 2829 0a20  ize).flatten(). 
+0000e4d0: 2020 2020 2020 2020 2020 2048 203d 2048             H = H
+0000e4e0: 320a 0a20 2020 2020 2020 2074 7279 3a0a  2..        try:.
+0000e4f0: 2020 2020 2020 2020 2020 2020 7368 7574              shut
+0000e500: 696c 2e72 6d74 7265 6528 6f73 2e70 6174  il.rmtree(os.pat
+0000e510: 682e 6a6f 696e 2873 656c 662e 6469 722c  h.join(self.dir,
+0000e520: 2022 7761 7465 7266 616c 6c22 2929 0a20   "waterfall")). 
+0000e530: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
+0000e540: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
+0000e550: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0000e560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e570: 2022 4661 696c 6564 2074 6f20 6465 6c65   "Failed to dele
+0000e580: 7465 2025 732e 2052 6561 736f 6e3a 2025  te %s. Reason: %
+0000e590: 7322 0a20 2020 2020 2020 2020 2020 2020  s".             
+0000e5a0: 2020 2025 2028 6f73 2e70 6174 682e 6a6f     % (os.path.jo
+0000e5b0: 696e 2873 656c 662e 6469 722c 2022 7761  in(self.dir, "wa
+0000e5c0: 7465 7266 616c 6c22 292c 2065 290a 2020  terfall"), e).  
+0000e5d0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0000e5e0: 2020 2020 2048 203d 2072 6573 697a 6528       H = resize(
+0000e5f0: 482c 2028 6e75 6d5f 636f 6d70 6f6e 656e  H, (num_componen
+0000e600: 7473 2c20 7368 6170 655b 305d 202a 2073  ts, shape[0] * s
+0000e610: 6861 7065 5b31 5d29 290a 0a20 2020 2020  hape[1]))..     
+0000e620: 2020 2072 6574 7572 6e20 482c 2057 0a0a     return H, W..
+0000e630: 2020 2020 6465 6620 7063 6128 7365 6c66      def pca(self
+0000e640: 2c20 6e75 6d5f 636f 6d70 6f6e 656e 7473  , num_components
+0000e650: 3d4e 6f6e 652c 2063 6875 6e6b 5f73 697a  =None, chunk_siz
+0000e660: 653d 3530 302c 2069 6e64 6963 6573 3d4e  e=500, indices=N
+0000e670: 6f6e 652c 2072 6574 7572 6e5f 7661 6c73  one, return_vals
+0000e680: 3d46 616c 7365 293a 0a20 2020 2020 2020  =False):.       
+0000e690: 2022 2222 0a20 2020 2020 2020 2043 6f6d   """.        Com
+0000e6a0: 7075 7465 2050 7269 6e63 6970 616c 2043  pute Principal C
+0000e6b0: 6f6d 706f 6e65 6e74 2041 6e61 6c79 7369  omponent Analysi
+0000e6c0: 7320 6f6e 2074 6865 2064 6174 612e 0a20  s on the data.. 
+0000e6d0: 2020 2020 2020 2054 6865 206d 6574 686f         The metho
+0000e6e0: 642c 2066 6972 7374 2063 6f6e 7665 7274  d, first convert
+0000e6f0: 732c 2069 6620 6e6f 7420 616c 7265 6164  s, if not alread
+0000e700: 792c 2074 6865 2064 6174 6120 696e 746f  y, the data into
+0000e710: 2061 6e20 6864 6635 2066 696c 6520 6f62   an hdf5 file ob
+0000e720: 6a65 6374 0a20 2020 2020 2020 2077 6974  ject.        wit
+0000e730: 6820 7468 6520 696d 6167 6573 2066 6c61  h the images fla
+0000e740: 7474 656e 6564 2069 6e20 7468 6520 726f  ttened in the ro
+0000e750: 7773 2e0a 0a20 2020 2020 2020 203a 7061  ws...        :pa
+0000e760: 7261 6d20 6e75 6d5f 636f 6d70 6f6e 656e  ram num_componen
+0000e770: 7473 3a20 4e75 6d62 6572 206f 6620 636f  ts: Number of co
+0000e780: 6d70 6f6e 656e 7473 2074 6f20 6669 6e64  mponents to find
+0000e790: 2e0a 2020 2020 2020 2020 2020 2020 4966  ..            If
+0000e7a0: 204e 6f6e 652c 2069 7420 7573 6573 2074   None, it uses t
+0000e7b0: 6865 206d 696e 696d 756d 2062 6574 7765  he minimum betwe
+0000e7c0: 656e 2074 6865 206e 756d 6265 7220 6f66  en the number of
+0000e7d0: 2069 6d61 6765 7320 616e 6420 7468 650a   images and the.
+0000e7e0: 2020 2020 2020 2020 2020 2020 6e75 6d62              numb
+0000e7f0: 6572 206f 6620 7069 7865 6c73 2e0a 2020  er of pixels..  
+0000e800: 2020 2020 2020 3a74 7970 6520 6e75 6d5f        :type num_
+0000e810: 636f 6d70 6f6e 656e 7473 3a20 556e 696f  components: Unio
+0000e820: 6e5b 4e6f 6e65 2c20 696e 745d 0a20 2020  n[None, int].   
+0000e830: 2020 2020 203a 7061 7261 6d20 6368 756e       :param chun
+0000e840: 6b5f 7369 7a65 3a20 4e75 6d62 6572 206f  k_size: Number o
+0000e850: 6620 6368 756e 6b73 2066 6f72 2077 6869  f chunks for whi
+0000e860: 6368 2074 6865 2077 6869 7465 6e69 6e67  ch the whitening
+0000e870: 206d 7573 7420 6265 2063 6f6d 7075 7465   must be compute
+0000e880: 642c 0a20 2020 2020 2020 2020 2020 2069  d,.            i
+0000e890: 6e63 7265 6d65 6e74 616c 6c79 2c20 6465  ncrementally, de
+0000e8a0: 6661 756c 7473 2074 6f20 4e6f 6e65 0a20  faults to None. 
+0000e8b0: 2020 2020 2020 203a 7479 7065 2063 6875         :type chu
+0000e8c0: 6e6b 7369 7a65 3a20 556e 696f 6e5b 4e6f  nksize: Union[No
+0000e8d0: 6e65 2c20 696e 745d 2c20 6f70 7469 6f6e  ne, int], option
+0000e8e0: 616c 0a20 2020 2020 2020 203a 7061 7261  al.        :para
+0000e8f0: 6d20 696e 6469 6365 733a 2049 6620 6e6f  m indices: If no
+0000e900: 7420 4e6f 6e65 2c20 6170 706c 7920 6d65  t None, apply me
+0000e910: 7468 6f64 206f 6e6c 7920 746f 2069 6e64  thod only to ind
+0000e920: 6963 6573 206f 6620 6461 7461 2c20 6465  ices of data, de
+0000e930: 6661 756c 7473 2074 6f20 4e6f 6e65 0a20  faults to None. 
+0000e940: 2020 2020 2020 203a 7479 7065 2069 6e64         :type ind
+0000e950: 6963 6573 3a20 556e 696f 6e5b 4e6f 6e65  ices: Union[None
+0000e960: 2c20 6172 7261 795f 6c69 6b65 5d2c 206f  , array_like], o
+0000e970: 7074 696f 6e61 6c0a 2020 2020 2020 2020  ptional.        
+0000e980: 3a70 6172 616d 2072 6574 7572 6e5f 7661  :param return_va
+0000e990: 6c73 3a20 4966 2054 7275 652c 2072 6574  ls: If True, ret
+0000e9a0: 7572 6e73 206f 6e6c 7920 7468 6520 7369  urns only the si
+0000e9b0: 6e67 756c 6172 2076 616c 7565 7320 6f66  ngular values of
+0000e9c0: 2050 4341 2c20 656c 7365 2072 6574 7572   PCA, else retur
+0000e9d0: 6e73 0a20 2020 2020 2020 2020 2020 2074  ns.            t
+0000e9e0: 6865 2063 6f6d 706f 6e65 6e74 7320 616e  he components an
+0000e9f0: 6420 7468 6520 6d69 7869 6e67 206d 6174  d the mixing mat
+0000ea00: 7269 782c 2064 6566 6175 6c74 7320 746f  rix, defaults to
+0000ea10: 2046 616c 7365 0a20 2020 2020 2020 203a   False.        :
+0000ea20: 7479 7065 2072 6574 7572 6e5f 7661 6c73  type return_vals
+0000ea30: 3a20 626f 6f6c 2c20 6f70 7469 6f6e 616c  : bool, optional
+0000ea40: 0a0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
+0000ea50: 6e3a 2028 482c 2057 293a 2054 6865 2063  n: (H, W): The c
+0000ea60: 6f6d 706f 6e65 6e74 7320 6d61 7472 6978  omponents matrix
+0000ea70: 2061 6e64 2074 6865 206d 6978 696e 6720   and the mixing 
+0000ea80: 6d61 7472 6978 2e0a 2020 2020 2020 2020  matrix..        
+0000ea90: 2222 220a 2020 2020 2020 2020 6273 735f  """.        bss_
+0000eaa0: 6469 7220 3d20 6f73 2e70 6174 682e 6a6f  dir = os.path.jo
+0000eab0: 696e 2873 656c 662e 6469 722c 2022 6273  in(self.dir, "bs
+0000eac0: 7322 290a 2020 2020 2020 2020 6f73 2e6d  s").        os.m
+0000ead0: 616b 6564 6972 7328 6273 735f 6469 722c  akedirs(bss_dir,
+0000eae0: 2065 7869 7374 5f6f 6b3d 5472 7565 290a   exist_ok=True).
+0000eaf0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0000eb00: 5f69 6e5f 6d65 6d6f 7279 3a0a 2020 2020  _in_memory:.    
+0000eb10: 2020 2020 2020 2020 6672 6f6d 2073 6b6c          from skl
+0000eb20: 6561 726e 2069 6d70 6f72 7420 6465 636f  earn import deco
+0000eb30: 6d70 6f73 6974 696f 6e0a 0a20 2020 2020  mposition..     
+0000eb40: 2020 2020 2020 206d 6f64 656c 203d 2064         model = d
+0000eb50: 6563 6f6d 706f 7369 7469 6f6e 2e50 4341  ecomposition.PCA
+0000eb60: 286e 5f63 6f6d 706f 6e65 6e74 733d 6e75  (n_components=nu
+0000eb70: 6d5f 636f 6d70 6f6e 656e 7473 290a 0a20  m_components).. 
+0000eb80: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+0000eb90: 7365 6c66 2e64 6174 612e 6f70 656e 5f61  self.data.open_a
+0000eba0: 735f 6864 6635 2862 7373 5f64 6972 2920  s_hdf5(bss_dir) 
+0000ebb0: 6173 2068 3564 7365 743a 0a20 2020 2020  as h5dset:.     
+0000ebc0: 2020 2020 2020 2020 2020 2069 6620 696e             if in
+0000ebd0: 6469 6365 7320 6973 206e 6f74 204e 6f6e  dices is not Non
+0000ebe0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000ebf0: 2020 2020 2020 2057 203d 206d 6f64 656c         W = model
+0000ec00: 2e66 6974 5f74 7261 6e73 666f 726d 2868  .fit_transform(h
+0000ec10: 3564 7365 745b 696e 6469 6365 735d 290a  5dset[indices]).
+0000ec20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec30: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000ec40: 2020 2020 2020 2020 2020 5720 3d20 6d6f            W = mo
+0000ec50: 6465 6c2e 6669 745f 7472 616e 7366 6f72  del.fit_transfor
+0000ec60: 6d28 6835 6473 6574 5b3a 2c20 3a5d 290a  m(h5dset[:, :]).
+0000ec70: 0a20 2020 2020 2020 2020 2020 2048 2c20  .            H, 
+0000ec80: 7661 6c73 2c20 5720 3d20 6d6f 6465 6c2e  vals, W = model.
+0000ec90: 636f 6d70 6f6e 656e 7473 5f2c 206d 6f64  components_, mod
+0000eca0: 656c 2e73 696e 6775 6c61 725f 7661 6c75  el.singular_valu
+0000ecb0: 6573 5f2c 2057 0a20 2020 2020 2020 2065  es_, W.        e
+0000ecc0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000ecd0: 2077 6974 6820 7365 6c66 2e64 6174 612e   with self.data.
+0000ece0: 6f70 656e 5f61 735f 6864 6635 2862 7373  open_as_hdf5(bss
+0000ecf0: 5f64 6972 2920 6173 2068 3564 7365 743a  _dir) as h5dset:
+0000ed00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ed10: 206d 6f64 656c 203d 2049 5043 4128 0a20   model = IPCA(. 
+0000ed20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed30: 2020 2068 3564 7365 742c 0a20 2020 2020     h5dset,.     
+0000ed40: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000ed50: 6875 6e6b 5f73 697a 652c 0a20 2020 2020  hunk_size,.     
+0000ed60: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0000ed70: 756d 5f63 6f6d 706f 6e65 6e74 732c 0a20  um_components,. 
+0000ed80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed90: 2020 2069 6e64 6963 6573 3d69 6e64 6963     indices=indic
+0000eda0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+0000edb0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0000edc0: 2020 2020 2020 7769 7468 2068 3570 792e        with h5py.
+0000edd0: 4669 6c65 286f 732e 7061 7468 2e6a 6f69  File(os.path.joi
+0000ede0: 6e28 6273 735f 6469 722c 2022 6970 6361  n(bss_dir, "ipca
+0000edf0: 2e68 6466 3522 292c 2022 7722 2920 6173  .hdf5"), "w") as
+0000ee00: 2066 696c 653a 0a20 2020 2020 2020 2020   file:.         
+0000ee10: 2020 2020 2020 2020 2020 2066 696c 655b             file[
+0000ee20: 2257 225d 203d 206e 756d 7079 2e72 616e  "W"] = numpy.ran
+0000ee30: 646f 6d2e 7261 6e64 6f6d 280a 2020 2020  dom.random(.    
+0000ee40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee50: 2020 2020 286d 6f64 656c 2e6e 756d 5f73      (model.num_s
+0000ee60: 616d 706c 6573 2c20 6d6f 6465 6c2e 6e75  amples, model.nu
+0000ee70: 6d5f 636f 6d70 6f6e 656e 7473 290a 2020  m_components).  
+0000ee80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee90: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0000eea0: 2020 2020 2020 2020 6669 6c65 5b22 4822          file["H"
+0000eeb0: 5d20 3d20 6e75 6d70 792e 7261 6e64 6f6d  ] = numpy.random
+0000eec0: 2e72 616e 646f 6d28 0a20 2020 2020 2020  .random(.       
+0000eed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eee0: 2028 6d6f 6465 6c2e 6e75 6d5f 636f 6d70   (model.num_comp
+0000eef0: 6f6e 656e 7473 2c20 6d6f 6465 6c2e 6e75  onents, model.nu
+0000ef00: 6d5f 6665 6174 7572 6573 290a 2020 2020  m_features).    
+0000ef10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ef20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000ef30: 2020 2020 2020 7769 7468 2077 6172 6e69        with warni
+0000ef40: 6e67 732e 6361 7463 685f 7761 726e 696e  ngs.catch_warnin
+0000ef50: 6773 2829 3a0a 2020 2020 2020 2020 2020  gs():.          
+0000ef60: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000ef70: 7363 696b 6974 5f6c 6561 726e 3c31 2e31  scikit_learn<1.1
+0000ef80: 2e31 0a20 2020 2020 2020 2020 2020 2020  .1.             
+0000ef90: 2020 2020 2020 2020 2020 2077 6172 6e69             warni
+0000efa0: 6e67 732e 6669 6c74 6572 7761 726e 696e  ngs.filterwarnin
+0000efb0: 6773 280a 2020 2020 2020 2020 2020 2020  gs(.            
+0000efc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000efd0: 2261 6c77 6179 7322 2c20 224d 6561 6e20  "always", "Mean 
+0000efe0: 6f66 2065 6d70 7479 2073 6c69 6365 2e22  of empty slice."
+0000eff0: 2c20 5275 6e74 696d 6557 6172 6e69 6e67  , RuntimeWarning
+0000f000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f010: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000f020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f030: 2020 2077 6974 6820 6e75 6d70 792e 6572     with numpy.er
+0000f040: 7273 7461 7465 2869 6e76 616c 6964 3d22  rstate(invalid="
+0000f050: 6967 6e6f 7265 222c 2064 6976 6964 653d  ignore", divide=
+0000f060: 2269 676e 6f72 6522 293a 0a20 2020 2020  "ignore"):.     
 0000f070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f080: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000f090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f0a0: 2020 7769 7468 206e 756d 7079 2e65 7272    with numpy.err
-0000f0b0: 7374 6174 6528 696e 7661 6c69 643d 2269  state(invalid="i
-0000f0c0: 676e 6f72 6522 2c20 6469 7669 6465 3d22  gnore", divide="
-0000f0d0: 6967 6e6f 7265 2229 3a0a 2020 2020 2020  ignore"):.      
-0000f0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f0f0: 2020 2020 2020 6d6f 6465 6c2e 6669 745f        model.fit_
-0000f100: 7472 616e 7366 6f72 6d28 573d 6669 6c65  transform(W=file
-0000f110: 5b22 5722 5d2c 2048 3d66 696c 655b 2248  ["W"], H=file["H
-0000f120: 225d 290a 0a20 2020 2020 2020 2020 2020  "])..           
-0000f130: 2048 2c20 7661 6c73 2c20 5720 3d20 6d6f   H, vals, W = mo
-0000f140: 6465 6c2e 482c 206d 6f64 656c 2e73 696e  del.H, model.sin
-0000f150: 6775 6c61 725f 7661 6c75 6573 2c20 6d6f  gular_values, mo
-0000f160: 6465 6c2e 570a 2020 2020 2020 2020 7265  del.W.        re
-0000f170: 7475 726e 2076 616c 7320 6966 2072 6574  turn vals if ret
-0000f180: 7572 6e5f 7661 6c73 2065 6c73 6520 2848  urn_vals else (H
-0000f190: 2c20 5729 0a0a 2020 2020 6465 6620 6e69  , W)..    def ni
-0000f1a0: 6361 280a 2020 2020 2020 2020 7365 6c66  ca(.        self
-0000f1b0: 2c0a 2020 2020 2020 2020 6e75 6d5f 636f  ,.        num_co
-0000f1c0: 6d70 6f6e 656e 7473 2c0a 2020 2020 2020  mponents,.      
-0000f1d0: 2020 6368 756e 6b73 697a 653d 4e6f 6e65    chunksize=None
-0000f1e0: 2c0a 2020 2020 2020 2020 6e75 6d5f 6974  ,.        num_it
-0000f1f0: 6572 3d35 3030 2c0a 2020 2020 2020 2020  er=500,.        
-0000f200: 6572 726f 725f 7374 6570 3d4e 6f6e 652c  error_step=None,
-0000f210: 0a20 2020 2020 2020 2069 6e64 6963 6573  .        indices
-0000f220: 3d4e 6f6e 652c 0a20 2020 2029 3a0a 2020  =None,.    ):.  
-0000f230: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0000f240: 2020 436f 6d70 7574 6520 4e6f 6e2d 6e65    Compute Non-ne
-0000f250: 6761 7469 7665 2049 6e64 6570 656e 6465  gative Independe
-0000f260: 6e74 2043 6f6d 706f 6e65 6e74 2041 6e61  nt Component Ana
-0000f270: 6c79 7369 7320 6f6e 2074 6865 2064 6174  lysis on the dat
-0000f280: 612e 0a20 2020 2020 2020 2054 6865 206d  a..        The m
-0000f290: 6574 686f 642c 2066 6972 7374 2063 6f6e  ethod, first con
-0000f2a0: 7665 7274 732c 2069 6620 6e6f 7420 616c  verts, if not al
-0000f2b0: 7265 6164 792c 2074 6865 2064 6174 6120  ready, the data 
-0000f2c0: 696e 746f 2061 6e20 6864 6635 2066 696c  into an hdf5 fil
-0000f2d0: 6520 6f62 6a65 6374 0a20 2020 2020 2020  e object.       
-0000f2e0: 2077 6974 6820 7468 6520 696d 6167 6573   with the images
-0000f2f0: 2066 6c61 7474 656e 6564 2069 6e20 7468   flattened in th
-0000f300: 6520 726f 7773 2e0a 0a20 2020 2020 2020  e rows...       
-0000f310: 203a 7061 7261 6d20 6e75 6d5f 636f 6d70   :param num_comp
-0000f320: 6f6e 656e 7473 3a20 4e75 6d62 6572 206f  onents: Number o
-0000f330: 6620 636f 6d70 6f6e 656e 7473 2074 6f20  f components to 
-0000f340: 6669 6e64 0a20 2020 2020 2020 203a 7479  find.        :ty
-0000f350: 7065 206e 756d 5f63 6f6d 706f 6e65 6e74  pe num_component
-0000f360: 733a 2055 6e69 6f6e 5b4e 6f6e 652c 2069  s: Union[None, i
-0000f370: 6e74 5d0a 2020 2020 2020 2020 3a70 6172  nt].        :par
-0000f380: 616d 2063 6875 6e6b 7369 7a65 3a20 4e75  am chunksize: Nu
-0000f390: 6d62 6572 206f 6620 6368 756e 6b73 2066  mber of chunks f
-0000f3a0: 6f72 2077 6869 6368 2074 6865 2077 6869  or which the whi
-0000f3b0: 7465 6e69 6e67 206d 7573 7420 6265 2063  tening must be c
-0000f3c0: 6f6d 7075 7465 642c 0a20 2020 2020 2020  omputed,.       
-0000f3d0: 2020 2020 2069 6e63 7265 6d65 6e74 616c       incremental
-0000f3e0: 6c79 2c20 6465 6661 756c 7473 2074 6f20  ly, defaults to 
-0000f3f0: 4e6f 6e65 0a20 2020 2020 2020 203a 7479  None.        :ty
-0000f400: 7065 2063 6875 6e6b 7369 7a65 3a20 556e  pe chunksize: Un
-0000f410: 696f 6e5b 4e6f 6e65 2c20 696e 745d 2c20  ion[None, int], 
-0000f420: 6f70 7469 6f6e 616c 0a20 2020 2020 2020  optional.       
-0000f430: 203a 7061 7261 6d20 6e75 6d5f 6974 6572   :param num_iter
-0000f440: 3a20 4e75 6d62 6572 206f 6620 6974 6572  : Number of iter
-0000f450: 6174 696f 6e73 2c20 6465 6661 756c 7473  ations, defaults
-0000f460: 2074 6f20 3530 300a 2020 2020 2020 2020   to 500.        
-0000f470: 3a74 7970 6520 6e75 6d5f 6974 6572 3a20  :type num_iter: 
-0000f480: 696e 742c 206f 7074 696f 6e61 6c0a 2020  int, optional.  
-0000f490: 2020 2020 2020 3a70 6172 616d 2065 7272        :param err
-0000f4a0: 6f72 5f73 7465 703a 2049 6620 6e6f 7420  or_step: If not 
-0000f4b0: 4e6f 6e65 2c20 6669 6e64 2074 6865 2065  None, find the e
-0000f4c0: 7272 6f72 2065 7665 7279 2065 7272 6f72  rror every error
-0000f4d0: 5f73 7465 7020 616e 6420 636f 6d70 6172  _step and compar
-0000f4e0: 6573 2069 740a 2020 2020 2020 2020 2020  es it.          
-0000f4f0: 2020 746f 2063 6865 636b 2066 6f72 2063    to check for c
-0000f500: 6f6e 7665 7267 656e 6365 2e20 544f 444f  onvergence. TODO
-0000f510: 3a20 6e6f 7420 6162 6c65 2066 6f72 2068  : not able for h
-0000f520: 7567 6520 6461 7461 7365 7473 2e0a 2020  uge datasets..  
-0000f530: 2020 2020 2020 3a70 6172 616d 2069 6e64        :param ind
-0000f540: 6963 6573 3a20 4966 206e 6f74 204e 6f6e  ices: If not Non
-0000f550: 652c 2061 7070 6c79 206d 6574 686f 6420  e, apply method 
-0000f560: 6f6e 6c79 2074 6f20 696e 6469 6365 7320  only to indices 
-0000f570: 6f66 2064 6174 612c 2064 6566 6175 6c74  of data, default
-0000f580: 7320 746f 204e 6f6e 650a 2020 2020 2020  s to None.      
-0000f590: 2020 3a74 7970 6520 696e 6469 6365 733a    :type indices:
-0000f5a0: 2055 6e69 6f6e 5b4e 6f6e 652c 2061 7272   Union[None, arr
-0000f5b0: 6179 5f6c 696b 655d 2c20 6f70 7469 6f6e  ay_like], option
-0000f5c0: 616c 0a0a 2020 2020 2020 2020 3a72 6574  al..        :ret
-0000f5d0: 7572 6e3a 2028 482c 2057 293a 2054 6865  urn: (H, W): The
-0000f5e0: 2063 6f6d 706f 6e65 6e74 7320 6d61 7472   components matr
-0000f5f0: 6978 2061 6e64 2074 6865 206d 6978 696e  ix and the mixin
-0000f600: 6720 6d61 7472 6978 2e0a 2020 2020 2020  g matrix..      
-0000f610: 2020 2222 220a 2020 2020 2020 2020 6273    """.        bs
-0000f620: 735f 6469 7220 3d20 6f73 2e70 6174 682e  s_dir = os.path.
-0000f630: 6a6f 696e 2873 656c 662e 6469 722c 2022  join(self.dir, "
-0000f640: 6273 7322 290a 2020 2020 2020 2020 6f73  bss").        os
-0000f650: 2e6d 616b 6564 6972 7328 6273 735f 6469  .makedirs(bss_di
-0000f660: 722c 2065 7869 7374 5f6f 6b3d 5472 7565  r, exist_ok=True
-0000f670: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
-0000f680: 6c66 2e5f 696e 5f6d 656d 6f72 793a 0a20  lf._in_memory:. 
-0000f690: 2020 2020 2020 2020 2020 2063 6875 6e6b             chunk
-0000f6a0: 7369 7a65 203d 204e 6f6e 650a 2020 2020  size = None.    
-0000f6b0: 2020 2020 7769 7468 2073 656c 662e 6461      with self.da
-0000f6c0: 7461 2e6f 7065 6e5f 6173 5f68 6466 3528  ta.open_as_hdf5(
-0000f6d0: 6273 735f 6469 7229 2061 7320 6835 6465  bss_dir) as h5de
-0000f6e0: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
-0000f6f0: 6d6f 6465 6c20 3d20 4e49 4341 280a 2020  model = NICA(.  
-0000f700: 2020 2020 2020 2020 2020 2020 2020 6835                h5
-0000f710: 6465 7374 2c0a 2020 2020 2020 2020 2020  dest,.          
-0000f720: 2020 2020 2020 6e75 6d5f 636f 6d70 6f6e        num_compon
-0000f730: 656e 7473 2c0a 2020 2020 2020 2020 2020  ents,.          
-0000f740: 2020 2020 2020 6368 756e 6b73 697a 652c        chunksize,
-0000f750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f760: 2069 6e64 6963 6573 3d69 6e64 6963 6573   indices=indices
-0000f770: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-0000f780: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-0000f790: 6c2e 6669 745f 7472 616e 7366 6f72 6d28  l.fit_transform(
-0000f7a0: 6d61 785f 6974 6572 3d6e 756d 5f69 7465  max_iter=num_ite
-0000f7b0: 722c 2065 7272 6f72 5f73 7465 703d 6572  r, error_step=er
-0000f7c0: 726f 725f 7374 6570 290a 2020 2020 2020  ror_step).      
-0000f7d0: 2020 2020 2020 7265 7475 726e 206e 756d        return num
-0000f7e0: 7079 2e61 6273 286d 6f64 656c 2e48 292c  py.abs(model.H),
-0000f7f0: 206e 756d 7079 2e61 6273 286d 6f64 656c   numpy.abs(model
-0000f800: 2e57 290a 0a20 2020 2064 6566 206e 6d66  .W)..    def nmf
-0000f810: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-0000f820: 2020 2020 2020 2020 6e75 6d5f 636f 6d70          num_comp
-0000f830: 6f6e 656e 7473 2c0a 2020 2020 2020 2020  onents,.        
-0000f840: 6e75 6d5f 6974 6572 3d31 3030 2c0a 2020  num_iter=100,.  
-0000f850: 2020 2020 2020 6572 726f 725f 7374 6570        error_step
-0000f860: 3d4e 6f6e 652c 0a20 2020 2020 2020 2077  =None,.        w
-0000f870: 6174 6572 6661 6c6c 3d4e 6f6e 652c 0a20  aterfall=None,. 
-0000f880: 2020 2020 2020 2048 3d4e 6f6e 652c 0a20         H=None,. 
-0000f890: 2020 2020 2020 2057 3d4e 6f6e 652c 0a20         W=None,. 
-0000f8a0: 2020 2020 2020 2076 7374 6570 3d31 3030         vstep=100
-0000f8b0: 2c0a 2020 2020 2020 2020 6873 7465 703d  ,.        hstep=
-0000f8c0: 3130 3030 2c0a 2020 2020 2020 2020 696e  1000,.        in
-0000f8d0: 6469 6365 733d 4e6f 6e65 2c0a 2020 2020  dices=None,.    
-0000f8e0: 2020 2020 696e 6974 3d4e 6f6e 652c 0a20      init=None,. 
-0000f8f0: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
-0000f900: 220a 2020 2020 2020 2020 436f 6d70 7574  ".        Comput
-0000f910: 6520 4e6f 6e2d 6e65 6761 7469 7665 204d  e Non-negative M
-0000f920: 6174 7269 7820 4661 6374 6f72 697a 6174  atrix Factorizat
-0000f930: 696f 6e20 6f6e 2074 6865 2064 6174 612e  ion on the data.
-0000f940: 0a20 2020 2020 2020 2054 6865 206d 6574  .        The met
-0000f950: 686f 642c 2066 6972 7374 2063 6f6e 7665  hod, first conve
-0000f960: 7274 732c 2069 6620 6e6f 7420 616c 7265  rts, if not alre
-0000f970: 6164 792c 2074 6865 2064 6174 6120 696e  ady, the data in
-0000f980: 746f 2061 6e20 6864 6635 2066 696c 6520  to an hdf5 file 
-0000f990: 6f62 6a65 6374 0a20 2020 2020 2020 2077  object.        w
-0000f9a0: 6974 6820 7468 6520 696d 6167 6573 2066  ith the images f
-0000f9b0: 6c61 7474 656e 6564 2069 6e20 7468 6520  lattened in the 
-0000f9c0: 726f 7773 2e0a 0a20 2020 2020 2020 203a  rows...        :
-0000f9d0: 7061 7261 6d20 6e75 6d5f 636f 6d70 6f6e  param num_compon
-0000f9e0: 656e 7473 3a20 4e75 6d62 6572 206f 6620  ents: Number of 
-0000f9f0: 636f 6d70 6f6e 656e 7473 2074 6f20 6669  components to fi
-0000fa00: 6e64 0a20 2020 2020 2020 203a 7479 7065  nd.        :type
-0000fa10: 206e 756d 5f63 6f6d 706f 6e65 6e74 733a   num_components:
-0000fa20: 2055 6e69 6f6e 5b4e 6f6e 652c 2069 6e74   Union[None, int
-0000fa30: 5d0a 2020 2020 2020 2020 3a70 6172 616d  ].        :param
-0000fa40: 206e 756d 5f69 7465 723a 204e 756d 6265   num_iter: Numbe
-0000fa50: 7220 6f66 2069 7465 7261 7469 6f6e 732c  r of iterations,
-0000fa60: 2064 6566 6175 6c74 7320 746f 2031 3030   defaults to 100
-0000fa70: 0a20 2020 2020 2020 203a 7479 7065 206e  .        :type n
-0000fa80: 756d 5f69 7465 723a 2069 6e74 2c20 6f70  um_iter: int, op
-0000fa90: 7469 6f6e 616c 0a20 2020 2020 2020 203a  tional.        :
-0000faa0: 7061 7261 6d20 6572 726f 725f 7374 6570  param error_step
-0000fab0: 3a20 4966 206e 6f74 204e 6f6e 652c 2066  : If not None, f
-0000fac0: 696e 6420 7468 6520 6572 726f 7220 6576  ind the error ev
-0000fad0: 6572 7920 6572 726f 725f 7374 6570 2061  ery error_step a
-0000fae0: 6e64 2063 6f6d 7061 7265 7320 6974 0a20  nd compares it. 
-0000faf0: 2020 2020 2020 2020 2020 2074 6f20 6368             to ch
-0000fb00: 6563 6b20 666f 7220 636f 6e76 6572 6765  eck for converge
-0000fb10: 6e63 652c 2064 6566 6175 6c74 7320 746f  nce, defaults to
-0000fb20: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-0000fb30: 2020 544f 444f 3a20 6e6f 7420 6162 6c65    TODO: not able
-0000fb40: 2066 6f72 2068 7567 6520 6461 7461 7365   for huge datase
-0000fb50: 7473 2e0a 2020 2020 2020 2020 3a74 7970  ts..        :typ
-0000fb60: 6520 6572 726f 725f 7374 6570 3a20 556e  e error_step: Un
-0000fb70: 696f 6e5b 4e6f 6e65 2c20 696e 745d 2c20  ion[None, int], 
-0000fb80: 6f70 7469 6f6e 616c 0a20 2020 2020 2020  optional.       
-0000fb90: 203a 7061 7261 6d20 7761 7465 7266 616c   :param waterfal
-0000fba0: 6c3a 2049 6620 6e6f 7420 4e6f 6e65 2c20  l: If not None, 
-0000fbb0: 4e4d 4620 6973 2063 6f6d 7075 7465 6420  NMF is computed 
-0000fbc0: 7573 696e 6720 7468 6520 7761 7465 7266  using the waterf
-0000fbd0: 616c 6c20 6d65 7468 6f64 2e0a 2020 2020  all method..    
-0000fbe0: 2020 2020 2020 2020 5468 6520 7061 7261          The para
-0000fbf0: 6d65 7465 7220 7368 6f75 6c64 2062 6520  meter should be 
-0000fc00: 616e 2061 7272 6179 2077 6974 6820 7468  an array with th
-0000fc10: 6520 6e75 6d62 6572 206f 6620 6974 6572  e number of iter
-0000fc20: 6174 696f 6e73 2070 6572 0a20 2020 2020  ations per.     
-0000fc30: 2020 2020 2020 2073 7562 2d63 6f6d 7075         sub-compu
-0000fc40: 7461 7469 6f6e 2c20 6465 6661 756c 7473  tation, defaults
-0000fc50: 2074 6f20 4e6f 6e65 0a20 2020 2020 2020   to None.       
-0000fc60: 203a 7479 7065 2077 6174 6572 6661 6c6c   :type waterfall
-0000fc70: 3a20 556e 696f 6e5b 4e6f 6e65 2c20 6172  : Union[None, ar
-0000fc80: 7261 795f 6c69 6b65 5d2c 206f 7074 696f  ray_like], optio
-0000fc90: 6e61 6c0a 2020 2020 2020 2020 3a70 6172  nal.        :par
-0000fca0: 616d 2048 3a20 496e 6974 206d 6174 7269  am H: Init matri
-0000fcb0: 7820 666f 7220 4820 6f66 2073 6861 7065  x for H of shape
-0000fcc0: 2028 6e5f 636f 6d70 6f6e 656e 7473 2c20   (n_components, 
-0000fcd0: 6e5f 7361 6d70 6c65 7329 2c20 6465 6661  n_samples), defa
-0000fce0: 756c 7473 2074 6f20 4e6f 6e65 0a20 2020  ults to None.   
-0000fcf0: 2020 2020 203a 7479 7065 2048 3a20 556e       :type H: Un
-0000fd00: 696f 6e5b 4e6f 6e65 2c20 6172 7261 795f  ion[None, array_
-0000fd10: 6c69 6b65 5d2c 206f 7074 696f 6e61 6c0a  like], optional.
-0000fd20: 2020 2020 2020 2020 3a70 6172 616d 2057          :param W
-0000fd30: 3a20 496e 6974 206d 6174 7269 7820 666f  : Init matrix fo
-0000fd40: 7220 5720 6f66 2073 6861 7065 2028 6e5f  r W of shape (n_
-0000fd50: 6665 6174 7572 6573 2c20 6e5f 636f 6d70  features, n_comp
-0000fd60: 6f6e 656e 7473 292c 2064 6566 6175 6c74  onents), default
-0000fd70: 7320 746f 204e 6f6e 650a 2020 2020 2020  s to None.      
-0000fd80: 2020 3a74 7970 6520 573a 2055 6e69 6f6e    :type W: Union
-0000fd90: 5b4e 6f6e 652c 2061 7272 6179 5f6c 696b  [None, array_lik
-0000fda0: 655d 2c20 6f70 7469 6f6e 616c 0a20 2020  e], optional.   
-0000fdb0: 2020 2020 203a 7061 7261 6d20 696e 6469       :param indi
-0000fdc0: 6365 733a 2049 6620 6e6f 7420 4e6f 6e65  ces: If not None
-0000fdd0: 2c20 6170 706c 7920 6d65 7468 6f64 206f  , apply method o
-0000fde0: 6e6c 7920 746f 2069 6e64 6963 6573 206f  nly to indices o
-0000fdf0: 6620 6461 7461 2c20 6465 6661 756c 7473  f data, defaults
-0000fe00: 2074 6f20 4e6f 6e65 0a20 2020 2020 2020   to None.       
-0000fe10: 203a 7479 7065 2069 6e64 6963 6573 3a20   :type indices: 
-0000fe20: 556e 696f 6e5b 4e6f 6e65 2c20 6172 7261  Union[None, arra
-0000fe30: 795f 6c69 6b65 5d2c 206f 7074 696f 6e61  y_like], optiona
-0000fe40: 6c0a 0a20 2020 2020 2020 203a 7265 7475  l..        :retu
-0000fe50: 726e 3a20 2848 2c20 5729 3a20 5468 6520  rn: (H, W): The 
-0000fe60: 636f 6d70 6f6e 656e 7473 206d 6174 7269  components matri
-0000fe70: 7820 616e 6420 7468 6520 6d69 7869 6e67  x and the mixing
-0000fe80: 206d 6174 7269 782e 0a20 2020 2020 2020   matrix..       
-0000fe90: 2022 2222 0a20 2020 2020 2020 2062 7373   """.        bss
-0000fea0: 5f64 6972 203d 206f 732e 7061 7468 2e6a  _dir = os.path.j
-0000feb0: 6f69 6e28 7365 6c66 2e64 6972 2c20 2262  oin(self.dir, "b
-0000fec0: 7373 2229 0a20 2020 2020 2020 206f 732e  ss").        os.
-0000fed0: 6d61 6b65 6469 7273 2862 7373 5f64 6972  makedirs(bss_dir
-0000fee0: 2c20 6578 6973 745f 6f6b 3d54 7275 6529  , exist_ok=True)
-0000fef0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-0000ff00: 662e 5f69 6e5f 6d65 6d6f 7279 3a0a 2020  f._in_memory:.  
-0000ff10: 2020 2020 2020 2020 2020 6672 6f6d 2073            from s
-0000ff20: 6b6c 6561 726e 2069 6d70 6f72 7420 6465  klearn import de
-0000ff30: 636f 6d70 6f73 6974 696f 6e0a 0a20 2020  composition..   
-0000ff40: 2020 2020 2020 2020 206d 6f64 656c 203d           model =
-0000ff50: 2064 6563 6f6d 706f 7369 7469 6f6e 2e4e   decomposition.N
-0000ff60: 4d46 280a 2020 2020 2020 2020 2020 2020  MF(.            
-0000ff70: 2020 2020 6e5f 636f 6d70 6f6e 656e 7473      n_components
-0000ff80: 3d6e 756d 5f63 6f6d 706f 6e65 6e74 732c  =num_components,
-0000ff90: 2069 6e69 743d 696e 6974 2c20 6d61 785f   init=init, max_
-0000ffa0: 6974 6572 3d6e 756d 5f69 7465 720a 2020  iter=num_iter.  
-0000ffb0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000ffc0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-0000ffd0: 662e 6461 7461 2e6f 7065 6e5f 6173 5f68  f.data.open_as_h
-0000ffe0: 6466 3528 6273 735f 6469 7229 2061 7320  df5(bss_dir) as 
-0000fff0: 6835 6465 7374 3a0a 2020 2020 2020 2020  h5dest:.        
-00010000: 2020 2020 2020 2020 6966 2069 6e64 6963          if indic
-00010010: 6573 2069 7320 6e6f 7420 4e6f 6e65 3a0a  es is not None:.
-00010020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010030: 2020 2020 5820 3d20 6835 6465 7374 5b69      X = h5dest[i
-00010040: 6e64 6963 6573 5d0a 2020 2020 2020 2020  ndices].        
-00010050: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00010060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010070: 2020 5820 3d20 6835 6465 7374 0a20 2020    X = h5dest.   
-00010080: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00010090: 6e75 6d70 792e 616e 7928 585b 3a2c 203a  numpy.any(X[:, :
-000100a0: 5d20 3c20 3029 3a0a 2020 2020 2020 2020  ] < 0):.        
-000100b0: 2020 2020 2020 2020 2020 2020 5f6c 6f67              _log
-000100c0: 6765 722e 7761 726e 696e 6728 2253 6574  ger.warning("Set
-000100d0: 7469 6e67 206e 6567 6174 6976 6520 7661  ting negative va
-000100e0: 6c75 6573 2074 6f20 3020 746f 2063 6f6d  lues to 0 to com
-000100f0: 7075 7465 204e 4d46 2229 0a20 2020 2020  pute NMF").     
-00010100: 2020 2020 2020 2020 2020 2020 2020 2058                 X
-00010110: 5b58 5b3a 2c20 3a5d 203c 2030 5d20 3d20  [X[:, :] < 0] = 
-00010120: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
-00010130: 2020 6966 2048 2069 7320 6e6f 7420 4e6f    if H is not No
-00010140: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00010150: 2020 2020 2020 2020 5820 3d20 582e 6173          X = X.as
-00010160: 7479 7065 2848 2e64 7479 7065 290a 2020  type(H.dtype).  
-00010170: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00010180: 6966 2057 2069 7320 6e6f 7420 4e6f 6e65  if W is not None
-00010190: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000101a0: 2020 2020 2020 5820 3d20 582e 6173 7479        X = X.asty
-000101b0: 7065 2857 2e64 7479 7065 290a 2020 2020  pe(W.dtype).    
-000101c0: 2020 2020 2020 2020 2020 2020 7769 7468              with
-000101d0: 2077 6172 6e69 6e67 732e 6361 7463 685f   warnings.catch_
-000101e0: 7761 726e 696e 6773 2829 3a0a 2020 2020  warnings():.    
-000101f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010200: 7761 726e 696e 6773 2e73 696d 706c 6566  warnings.simplef
-00010210: 696c 7465 7228 2261 6c77 6179 7322 2c20  ilter("always", 
-00010220: 436f 6e76 6572 6765 6e63 6557 6172 6e69  ConvergenceWarni
-00010230: 6e67 290a 2020 2020 2020 2020 2020 2020  ng).            
-00010240: 2020 2020 2020 2020 5720 3d20 6d6f 6465          W = mode
-00010250: 6c2e 6669 745f 7472 616e 7366 6f72 6d28  l.fit_transform(
-00010260: 582c 2057 3d57 2c20 483d 4829 0a20 2020  X, W=W, H=H).   
-00010270: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00010280: 7572 6e20 6d6f 6465 6c2e 636f 6d70 6f6e  urn model.compon
-00010290: 656e 7473 5f2c 2057 0a20 2020 2020 2020  ents_, W.       
-000102a0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000102b0: 2020 2069 6620 7761 7465 7266 616c 6c20     if waterfall 
-000102c0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-000102d0: 2020 2020 2020 2020 2020 2020 2048 2c20               H, 
-000102e0: 5720 3d20 7365 6c66 2e5f 7761 7465 7266  W = self._waterf
-000102f0: 616c 6c5f 6e6d 6628 0a20 2020 2020 2020  all_nmf(.       
-00010300: 2020 2020 2020 2020 2020 2020 206e 756d               num
-00010310: 5f63 6f6d 706f 6e65 6e74 732c 2077 6174  _components, wat
-00010320: 6572 6661 6c6c 2c20 7673 7465 702c 2068  erfall, vstep, h
-00010330: 7374 6570 2c20 696e 6469 6365 733d 696e  step, indices=in
-00010340: 6469 6365 730a 2020 2020 2020 2020 2020  dices.          
-00010350: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00010360: 2020 2020 2077 6974 6820 7365 6c66 2e64       with self.d
-00010370: 6174 612e 6f70 656e 5f61 735f 6864 6635  ata.open_as_hdf5
-00010380: 2862 7373 5f64 6972 2920 6173 2068 3564  (bss_dir) as h5d
-00010390: 6573 743a 0a20 2020 2020 2020 2020 2020  est:.           
-000103a0: 2020 2020 206d 6f64 656c 203d 204e 4d46       model = NMF
-000103b0: 2868 3564 6573 742c 206e 756d 5f63 6f6d  (h5dest, num_com
-000103c0: 706f 6e65 6e74 732c 2069 6e64 6963 6573  ponents, indices
-000103d0: 3d69 6e64 6963 6573 290a 2020 2020 2020  =indices).      
-000103e0: 2020 2020 2020 2020 2020 7769 7468 2077            with w
-000103f0: 6172 6e69 6e67 732e 6361 7463 685f 7761  arnings.catch_wa
-00010400: 726e 696e 6773 2829 3a0a 2020 2020 2020  rnings():.      
-00010410: 2020 2020 2020 2020 2020 2020 2020 7761                wa
-00010420: 726e 696e 6773 2e73 696d 706c 6566 696c  rnings.simplefil
-00010430: 7465 7228 2261 6c77 6179 7322 2c20 436f  ter("always", Co
-00010440: 6e76 6572 6765 6e63 6557 6172 6e69 6e67  nvergenceWarning
-00010450: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00010460: 2020 2020 2020 6d6f 6465 6c2e 6669 745f        model.fit_
-00010470: 7472 616e 7366 6f72 6d28 0a20 2020 2020  transform(.     
-00010480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010490: 2020 206d 6178 5f69 7465 723d 6e75 6d5f     max_iter=num_
-000104a0: 6974 6572 2c0a 2020 2020 2020 2020 2020  iter,.          
-000104b0: 2020 2020 2020 2020 2020 2020 2020 483d                H=
-000104c0: 482c 0a20 2020 2020 2020 2020 2020 2020  H,.             
-000104d0: 2020 2020 2020 2020 2020 2057 3d57 2c0a             W=W,.
-000104e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000104f0: 2020 2020 2020 2020 7673 7465 703d 7673          vstep=vs
-00010500: 7465 702c 0a20 2020 2020 2020 2020 2020  tep,.           
-00010510: 2020 2020 2020 2020 2020 2020 2068 7374               hst
-00010520: 6570 3d68 7374 6570 2c0a 2020 2020 2020  ep=hstep,.      
-00010530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010540: 2020 6572 726f 725f 7374 6570 3d65 7272    error_step=err
-00010550: 6f72 5f73 7465 702c 0a20 2020 2020 2020  or_step,.       
-00010560: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00010570: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00010580: 6574 7572 6e20 6d6f 6465 6c2e 482c 206d  eturn model.H, m
-00010590: 6f64 656c 2e57 0a0a 2020 2020 6465 6620  odel.W..    def 
-000105a0: 6e69 6361 5f6e 6d66 280a 2020 2020 2020  nica_nmf(.      
-000105b0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-000105c0: 6e75 6d5f 636f 6d70 6f6e 656e 7473 2c0a  num_components,.
-000105d0: 2020 2020 2020 2020 6368 756e 6b73 697a          chunksiz
-000105e0: 653d 4e6f 6e65 2c0a 2020 2020 2020 2020  e=None,.        
-000105f0: 6e75 6d5f 6974 6572 3d35 3030 2c0a 2020  num_iter=500,.  
-00010600: 2020 2020 2020 7761 7465 7266 616c 6c3d        waterfall=
-00010610: 4e6f 6e65 2c0a 2020 2020 2020 2020 6572  None,.        er
-00010620: 726f 725f 7374 6570 3d4e 6f6e 652c 0a20  ror_step=None,. 
-00010630: 2020 2020 2020 2076 7374 6570 3d31 3030         vstep=100
-00010640: 2c0a 2020 2020 2020 2020 6873 7465 703d  ,.        hstep=
-00010650: 3130 3030 2c0a 2020 2020 2020 2020 696e  1000,.        in
-00010660: 6469 6365 733d 4e6f 6e65 2c0a 2020 2020  dices=None,.    
-00010670: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-00010680: 2020 2020 2020 2041 7070 6c69 6573 2062         Applies b
-00010690: 6f74 6820 4e49 4341 2061 6e64 204e 4d46  oth NICA and NMF
-000106a0: 2074 6f20 7468 6520 6461 7461 2e20 5468   to the data. Th
-000106b0: 6520 696e 6974 2048 2061 6e64 2057 2066  e init H and W f
-000106c0: 6f72 204e 4d46 2061 7265 2074 6865 0a20  or NMF are the. 
-000106d0: 2020 2020 2020 2072 6573 756c 7420 6f66         result of
-000106e0: 204e 4943 412e 0a20 2020 2020 2020 2022   NICA..        "
-000106f0: 2222 0a20 2020 2020 2020 2048 2c20 5720  "".        H, W 
-00010700: 3d20 7365 6c66 2e6e 6963 6128 6e75 6d5f  = self.nica(num_
-00010710: 636f 6d70 6f6e 656e 7473 2c20 6368 756e  components, chun
-00010720: 6b73 697a 652c 206e 756d 5f69 7465 722c  ksize, num_iter,
-00010730: 2069 6e64 6963 6573 3d69 6e64 6963 6573   indices=indices
-00010740: 290a 0a20 2020 2020 2020 2023 2049 6e69  )..        # Ini
-00010750: 7469 616c 204e 4d46 2066 6163 746f 7269  tial NMF factori
-00010760: 7a61 7469 6f6e 3a20 5820 3d20 4630 202a  zation: X = F0 *
-00010770: 2047 300a 2020 2020 2020 2020 5720 3d20   G0.        W = 
-00010780: 6e75 6d70 792e 6162 7328 5729 0a20 2020  numpy.abs(W).   
-00010790: 2020 2020 2048 203d 206e 756d 7079 2e61       H = numpy.a
-000107a0: 6273 2848 290a 0a20 2020 2020 2020 2072  bs(H)..        r
-000107b0: 6574 7572 6e20 7365 6c66 2e6e 6d66 280a  eturn self.nmf(.
-000107c0: 2020 2020 2020 2020 2020 2020 6d69 6e28              min(
-000107d0: 6e75 6d5f 636f 6d70 6f6e 656e 7473 2c20  num_components, 
-000107e0: 482e 7368 6170 655b 305d 292c 0a20 2020  H.shape[0]),.   
-000107f0: 2020 2020 2020 2020 206e 756d 5f69 7465           num_ite
-00010800: 722c 0a20 2020 2020 2020 2020 2020 2065  r,.            e
-00010810: 7272 6f72 5f73 7465 702c 0a20 2020 2020  rror_step,.     
-00010820: 2020 2020 2020 2077 6174 6572 6661 6c6c         waterfall
-00010830: 2c0a 2020 2020 2020 2020 2020 2020 482c  ,.            H,
-00010840: 0a20 2020 2020 2020 2020 2020 2057 2c0a  .            W,.
-00010850: 2020 2020 2020 2020 2020 2020 7673 7465              vste
-00010860: 702c 0a20 2020 2020 2020 2020 2020 2068  p,.            h
-00010870: 7374 6570 2c0a 2020 2020 2020 2020 2020  step,.          
-00010880: 2020 696e 6469 6365 733d 696e 6469 6365    indices=indice
-00010890: 732c 0a20 2020 2020 2020 2020 2020 2069  s,.            i
-000108a0: 6e69 743d 2263 7573 746f 6d22 2c0a 2020  nit="custom",.  
-000108b0: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-000108c0: 2061 7070 6c79 5f6d 6f6d 656e 7473 2873   apply_moments(s
-000108d0: 656c 662c 2069 6e64 6963 6573 3d4e 6f6e  elf, indices=Non
-000108e0: 652c 2063 6875 6e6b 5f73 6861 7065 3d5b  e, chunk_shape=[
-000108f0: 3530 302c 2035 3030 5d29 3a0a 2020 2020  500, 500]):.    
-00010900: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00010910: 436f 6d70 7574 6520 7468 6520 434f 4d2c  Compute the COM,
-00010920: 2046 5748 4d2c 2073 6b65 776e 6573 7320   FWHM, skewness 
-00010930: 616e 6420 6b75 7274 6f73 6973 206f 6620  and kurtosis of 
-00010940: 7468 6520 6461 7461 2066 6f72 2076 6572  the data for ver
-00010950: 7920 6469 6d65 6e73 696f 6e2e 0a0a 2020  y dimension...  
-00010960: 2020 2020 2020 3a70 6172 616d 2069 6e64        :param ind
-00010970: 6963 6573 3a20 4966 206e 6f74 204e 6f6e  ices: If not Non
-00010980: 652c 2061 7070 6c79 206d 6574 686f 6420  e, apply method 
-00010990: 6f6e 6c79 2074 6f20 696e 6469 6365 7320  only to indices 
-000109a0: 6f66 2064 6174 612c 2064 6566 6175 6c74  of data, default
-000109b0: 7320 746f 204e 6f6e 650a 2020 2020 2020  s to None.      
-000109c0: 2020 3a74 7970 6520 696e 6469 6365 733a    :type indices:
-000109d0: 2055 6e69 6f6e 5b4e 6f6e 652c 2061 7272   Union[None, arr
-000109e0: 6179 5f6c 696b 655d 2c20 6f70 7469 6f6e  ay_like], option
-000109f0: 616c 0a20 2020 2020 2020 203a 7061 7261  al.        :para
-00010a00: 6d20 6368 756e 6b5f 7368 6170 653a 2053  m chunk_shape: S
-00010a10: 6861 7065 206f 6620 7468 6520 6368 756e  hape of the chun
-00010a20: 6b20 696d 6167 6520 746f 2075 7365 2070  k image to use p
-00010a30: 6572 2069 7465 7261 7469 6f6e 2e0a 2020  er iteration..  
-00010a40: 2020 2020 2020 2020 2020 5061 7261 6d65            Parame
-00010a50: 7465 7220 7573 6564 206f 6e6c 7920 7768  ter used only wh
-00010a60: 656e 2066 6c61 6720 696e 5f6d 656d 6f72  en flag in_memor
-00010a70: 7920 6973 2046 616c 7365 2e0a 2020 2020  y is False..    
-00010a80: 2020 2020 3a74 7970 6520 6368 756e 6b5f      :type chunk_
-00010a90: 7368 6170 653a 2061 7272 6179 5f6c 696b  shape: array_lik
-00010aa0: 652c 206f 7074 696f 6e61 6c0a 2020 2020  e, optional.    
-00010ab0: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
-00010ac0: 2069 6620 6e6f 7420 7365 6c66 2e64 696d   if not self.dim
-00010ad0: 732e 6e64 696d 3a0a 2020 2020 2020 2020  s.ndim:.        
-00010ae0: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
-00010af0: 2020 2020 2020 2020 7365 6c66 2e72 756e          self.run
-00010b00: 6e69 6e67 5f64 6174 6120 3d20 7365 6c66  ning_data = self
-00010b10: 2e67 6574 5f64 6174 6128 696e 6469 6365  .get_data(indice
-00010b20: 7329 0a20 2020 2020 2020 2069 6620 696e  s).        if in
-00010b30: 6469 6365 7320 6973 204e 6f6e 653a 0a20  dices is None:. 
-00010b40: 2020 2020 2020 2020 2020 2069 6e64 6963             indic
-00010b50: 6573 203d 2072 616e 6765 2873 656c 662e  es = range(self.
-00010b60: 6e66 7261 6d65 7329 0a20 2020 2020 2020  nframes).       
-00010b70: 2066 6f72 2061 7869 732c 2064 696d 2069   for axis, dim i
-00010b80: 6e20 7365 6c66 2e64 696d 733a 0a20 2020  n self.dims:.   
-00010b90: 2020 2020 2020 2020 2023 2047 6574 206d           # Get m
-00010ba0: 6f74 6f72 2076 616c 7565 7320 7065 7220  otor values per 
-00010bb0: 696d 6167 6520 6f66 2074 6865 2073 7461  image of the sta
-00010bc0: 636b 0a20 2020 2020 2020 2020 2020 2076  ck.            v
-00010bd0: 616c 7565 7320 3d20 7365 6c66 2e67 6574  alues = self.get
-00010be0: 5f64 696d 656e 7369 6f6e 735f 7661 6c75  _dimensions_valu
-00010bf0: 6573 2869 6e64 6963 6573 295b 6469 6d2e  es(indices)[dim.
-00010c00: 6e61 6d65 5d0a 2020 2020 2020 2020 2020  name].          
-00010c10: 2020 6966 2073 656c 662e 5f69 6e5f 6d65    if self._in_me
-00010c20: 6d6f 7279 3a0a 2020 2020 2020 2020 2020  mory:.          
-00010c30: 2020 2020 2020 2320 4461 7461 2069 6e20        # Data in 
-00010c40: 6d65 6d6f 7279 0a20 2020 2020 2020 2020  memory.         
-00010c50: 2020 2020 2020 206d 6f6d 656e 7473 203d         moments =
-00010c60: 206e 756d 7079 2e61 7361 7272 6179 280a   numpy.asarray(.
-00010c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c80: 2020 2020 636f 6d70 7574 655f 6d6f 6d65      compute_mome
-00010c90: 6e74 7328 7661 6c75 6573 2c20 7365 6c66  nts(values, self
-00010ca0: 2e72 756e 6e69 6e67 5f64 6174 6129 2c20  .running_data), 
-00010cb0: 6474 7970 653d 6e75 6d70 792e 666c 6f61  dtype=numpy.floa
-00010cc0: 7436 340a 2020 2020 2020 2020 2020 2020  t64.            
-00010cd0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00010ce0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00010cf0: 2020 2020 2020 2020 2320 4461 7461 206f          # Data o
-00010d00: 6e20 6469 736b 0a20 2020 2020 2020 2020  n disk.         
-00010d10: 2020 2020 2020 2073 7461 7274 203d 205b         start = [
-00010d20: 302c 2030 5d0a 2020 2020 2020 2020 2020  0, 0].          
-00010d30: 2020 2020 2020 696d 6720 3d20 7365 6c66        img = self
-00010d40: 2e72 756e 6e69 6e67 5f64 6174 615b 305d  .running_data[0]
-00010d50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010d60: 206d 6f6d 656e 7473 203d 206e 756d 7079   moments = numpy
-00010d70: 2e65 6d70 7479 280a 2020 2020 2020 2020  .empty(.        
-00010d80: 2020 2020 2020 2020 2020 2020 2834 2c20              (4, 
-00010d90: 696d 672e 7368 6170 655b 305d 2c20 696d  img.shape[0], im
-00010da0: 672e 7368 6170 655b 315d 292c 2064 7479  g.shape[1]), dty
-00010db0: 7065 3d6e 756d 7079 2e66 6c6f 6174 3634  pe=numpy.float64
-00010dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010dd0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00010de0: 2020 2063 6875 6e6b 735f 3120 3d20 696e     chunks_1 = in
-00010df0: 7428 6e75 6d70 792e 6365 696c 2869 6d67  t(numpy.ceil(img
-00010e00: 2e73 6861 7065 5b30 5d20 2f20 6368 756e  .shape[0] / chun
-00010e10: 6b5f 7368 6170 655b 305d 2929 0a20 2020  k_shape[0])).   
-00010e20: 2020 2020 2020 2020 2020 2020 2063 6875               chu
-00010e30: 6e6b 735f 3220 3d20 696e 7428 6e75 6d70  nks_2 = int(nump
-00010e40: 792e 6365 696c 2869 6d67 2e73 6861 7065  y.ceil(img.shape
-00010e50: 5b31 5d20 2f20 6368 756e 6b5f 7368 6170  [1] / chunk_shap
-00010e60: 655b 315d 2929 0a20 2020 2020 2020 2020  e[1])).         
-00010e70: 2020 2020 2020 2069 6f5f 7574 696c 732e         io_utils.
-00010e80: 6164 7661 6e63 656d 656e 745f 6469 7370  advancement_disp
-00010e90: 6c61 7928 0a20 2020 2020 2020 2020 2020  lay(.           
-00010ea0: 2020 2020 2020 2020 2030 2c20 6368 756e           0, chun
-00010eb0: 6b73 5f31 202a 2063 6875 6e6b 735f 3220  ks_1 * chunks_2 
-00010ec0: 2a20 6c65 6e28 7365 6c66 2e72 756e 6e69  * len(self.runni
-00010ed0: 6e67 5f64 6174 6129 2c20 2243 6f6d 7075  ng_data), "Compu
-00010ee0: 7469 6e67 206d 6f6d 656e 7473 220a 2020  ting moments".  
-00010ef0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00010f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f10: 666f 7220 6920 696e 2072 616e 6765 2863  for i in range(c
-00010f20: 6875 6e6b 735f 3129 3a0a 2020 2020 2020  hunks_1):.      
-00010f30: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00010f40: 7220 6a20 696e 2072 616e 6765 2863 6875  r j in range(chu
-00010f50: 6e6b 735f 3229 3a0a 2020 2020 2020 2020  nks_2):.        
-00010f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f70: 635f 696d 6167 6573 203d 205b 5d0a 2020  c_images = [].  
+0000f080: 2020 2020 2020 206d 6f64 656c 2e66 6974         model.fit
+0000f090: 5f74 7261 6e73 666f 726d 2857 3d66 696c  _transform(W=fil
+0000f0a0: 655b 2257 225d 2c20 483d 6669 6c65 5b22  e["W"], H=file["
+0000f0b0: 4822 5d29 0a0a 2020 2020 2020 2020 2020  H"])..          
+0000f0c0: 2020 482c 2076 616c 732c 2057 203d 206d    H, vals, W = m
+0000f0d0: 6f64 656c 2e48 2c20 6d6f 6465 6c2e 7369  odel.H, model.si
+0000f0e0: 6e67 756c 6172 5f76 616c 7565 732c 206d  ngular_values, m
+0000f0f0: 6f64 656c 2e57 0a20 2020 2020 2020 2072  odel.W.        r
+0000f100: 6574 7572 6e20 7661 6c73 2069 6620 7265  eturn vals if re
+0000f110: 7475 726e 5f76 616c 7320 656c 7365 2028  turn_vals else (
+0000f120: 482c 2057 290a 0a20 2020 2064 6566 206e  H, W)..    def n
+0000f130: 6963 6128 0a20 2020 2020 2020 2073 656c  ica(.        sel
+0000f140: 662c 0a20 2020 2020 2020 206e 756d 5f63  f,.        num_c
+0000f150: 6f6d 706f 6e65 6e74 732c 0a20 2020 2020  omponents,.     
+0000f160: 2020 2063 6875 6e6b 7369 7a65 3d4e 6f6e     chunksize=Non
+0000f170: 652c 0a20 2020 2020 2020 206e 756d 5f69  e,.        num_i
+0000f180: 7465 723d 3530 302c 0a20 2020 2020 2020  ter=500,.       
+0000f190: 2065 7272 6f72 5f73 7465 703d 4e6f 6e65   error_step=None
+0000f1a0: 2c0a 2020 2020 2020 2020 696e 6469 6365  ,.        indice
+0000f1b0: 733d 4e6f 6e65 2c0a 2020 2020 293a 0a20  s=None,.    ):. 
+0000f1c0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0000f1d0: 2020 2043 6f6d 7075 7465 204e 6f6e 2d6e     Compute Non-n
+0000f1e0: 6567 6174 6976 6520 496e 6465 7065 6e64  egative Independ
+0000f1f0: 656e 7420 436f 6d70 6f6e 656e 7420 416e  ent Component An
+0000f200: 616c 7973 6973 206f 6e20 7468 6520 6461  alysis on the da
+0000f210: 7461 2e0a 2020 2020 2020 2020 5468 6520  ta..        The 
+0000f220: 6d65 7468 6f64 2c20 6669 7273 7420 636f  method, first co
+0000f230: 6e76 6572 7473 2c20 6966 206e 6f74 2061  nverts, if not a
+0000f240: 6c72 6561 6479 2c20 7468 6520 6461 7461  lready, the data
+0000f250: 2069 6e74 6f20 616e 2068 6466 3520 6669   into an hdf5 fi
+0000f260: 6c65 206f 626a 6563 740a 2020 2020 2020  le object.      
+0000f270: 2020 7769 7468 2074 6865 2069 6d61 6765    with the image
+0000f280: 7320 666c 6174 7465 6e65 6420 696e 2074  s flattened in t
+0000f290: 6865 2072 6f77 732e 0a0a 2020 2020 2020  he rows...      
+0000f2a0: 2020 3a70 6172 616d 206e 756d 5f63 6f6d    :param num_com
+0000f2b0: 706f 6e65 6e74 733a 204e 756d 6265 7220  ponents: Number 
+0000f2c0: 6f66 2063 6f6d 706f 6e65 6e74 7320 746f  of components to
+0000f2d0: 2066 696e 640a 2020 2020 2020 2020 3a74   find.        :t
+0000f2e0: 7970 6520 6e75 6d5f 636f 6d70 6f6e 656e  ype num_componen
+0000f2f0: 7473 3a20 556e 696f 6e5b 4e6f 6e65 2c20  ts: Union[None, 
+0000f300: 696e 745d 0a20 2020 2020 2020 203a 7061  int].        :pa
+0000f310: 7261 6d20 6368 756e 6b73 697a 653a 204e  ram chunksize: N
+0000f320: 756d 6265 7220 6f66 2063 6875 6e6b 7320  umber of chunks 
+0000f330: 666f 7220 7768 6963 6820 7468 6520 7768  for which the wh
+0000f340: 6974 656e 696e 6720 6d75 7374 2062 6520  itening must be 
+0000f350: 636f 6d70 7574 6564 2c0a 2020 2020 2020  computed,.      
+0000f360: 2020 2020 2020 696e 6372 656d 656e 7461        incrementa
+0000f370: 6c6c 792c 2064 6566 6175 6c74 7320 746f  lly, defaults to
+0000f380: 204e 6f6e 650a 2020 2020 2020 2020 3a74   None.        :t
+0000f390: 7970 6520 6368 756e 6b73 697a 653a 2055  ype chunksize: U
+0000f3a0: 6e69 6f6e 5b4e 6f6e 652c 2069 6e74 5d2c  nion[None, int],
+0000f3b0: 206f 7074 696f 6e61 6c0a 2020 2020 2020   optional.      
+0000f3c0: 2020 3a70 6172 616d 206e 756d 5f69 7465    :param num_ite
+0000f3d0: 723a 204e 756d 6265 7220 6f66 2069 7465  r: Number of ite
+0000f3e0: 7261 7469 6f6e 732c 2064 6566 6175 6c74  rations, default
+0000f3f0: 7320 746f 2035 3030 0a20 2020 2020 2020  s to 500.       
+0000f400: 203a 7479 7065 206e 756d 5f69 7465 723a   :type num_iter:
+0000f410: 2069 6e74 2c20 6f70 7469 6f6e 616c 0a20   int, optional. 
+0000f420: 2020 2020 2020 203a 7061 7261 6d20 6572         :param er
+0000f430: 726f 725f 7374 6570 3a20 4966 206e 6f74  ror_step: If not
+0000f440: 204e 6f6e 652c 2066 696e 6420 7468 6520   None, find the 
+0000f450: 6572 726f 7220 6576 6572 7920 6572 726f  error every erro
+0000f460: 725f 7374 6570 2061 6e64 2063 6f6d 7061  r_step and compa
+0000f470: 7265 7320 6974 0a20 2020 2020 2020 2020  res it.         
+0000f480: 2020 2074 6f20 6368 6563 6b20 666f 7220     to check for 
+0000f490: 636f 6e76 6572 6765 6e63 652e 2054 4f44  convergence. TOD
+0000f4a0: 4f3a 206e 6f74 2061 626c 6520 666f 7220  O: not able for 
+0000f4b0: 6875 6765 2064 6174 6173 6574 732e 0a20  huge datasets.. 
+0000f4c0: 2020 2020 2020 203a 7061 7261 6d20 696e         :param in
+0000f4d0: 6469 6365 733a 2049 6620 6e6f 7420 4e6f  dices: If not No
+0000f4e0: 6e65 2c20 6170 706c 7920 6d65 7468 6f64  ne, apply method
+0000f4f0: 206f 6e6c 7920 746f 2069 6e64 6963 6573   only to indices
+0000f500: 206f 6620 6461 7461 2c20 6465 6661 756c   of data, defaul
+0000f510: 7473 2074 6f20 4e6f 6e65 0a20 2020 2020  ts to None.     
+0000f520: 2020 203a 7479 7065 2069 6e64 6963 6573     :type indices
+0000f530: 3a20 556e 696f 6e5b 4e6f 6e65 2c20 6172  : Union[None, ar
+0000f540: 7261 795f 6c69 6b65 5d2c 206f 7074 696f  ray_like], optio
+0000f550: 6e61 6c0a 0a20 2020 2020 2020 203a 7265  nal..        :re
+0000f560: 7475 726e 3a20 2848 2c20 5729 3a20 5468  turn: (H, W): Th
+0000f570: 6520 636f 6d70 6f6e 656e 7473 206d 6174  e components mat
+0000f580: 7269 7820 616e 6420 7468 6520 6d69 7869  rix and the mixi
+0000f590: 6e67 206d 6174 7269 782e 0a20 2020 2020  ng matrix..     
+0000f5a0: 2020 2022 2222 0a20 2020 2020 2020 2062     """.        b
+0000f5b0: 7373 5f64 6972 203d 206f 732e 7061 7468  ss_dir = os.path
+0000f5c0: 2e6a 6f69 6e28 7365 6c66 2e64 6972 2c20  .join(self.dir, 
+0000f5d0: 2262 7373 2229 0a20 2020 2020 2020 206f  "bss").        o
+0000f5e0: 732e 6d61 6b65 6469 7273 2862 7373 5f64  s.makedirs(bss_d
+0000f5f0: 6972 2c20 6578 6973 745f 6f6b 3d54 7275  ir, exist_ok=Tru
+0000f600: 6529 0a0a 2020 2020 2020 2020 6966 2073  e)..        if s
+0000f610: 656c 662e 5f69 6e5f 6d65 6d6f 7279 3a0a  elf._in_memory:.
+0000f620: 2020 2020 2020 2020 2020 2020 6368 756e              chun
+0000f630: 6b73 697a 6520 3d20 4e6f 6e65 0a20 2020  ksize = None.   
+0000f640: 2020 2020 2077 6974 6820 7365 6c66 2e64       with self.d
+0000f650: 6174 612e 6f70 656e 5f61 735f 6864 6635  ata.open_as_hdf5
+0000f660: 2862 7373 5f64 6972 2920 6173 2068 3564  (bss_dir) as h5d
+0000f670: 6573 743a 0a20 2020 2020 2020 2020 2020  est:.           
+0000f680: 206d 6f64 656c 203d 204e 4943 4128 0a20   model = NICA(. 
+0000f690: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+0000f6a0: 3564 6573 742c 0a20 2020 2020 2020 2020  5dest,.         
+0000f6b0: 2020 2020 2020 206e 756d 5f63 6f6d 706f         num_compo
+0000f6c0: 6e65 6e74 732c 0a20 2020 2020 2020 2020  nents,.         
+0000f6d0: 2020 2020 2020 2063 6875 6e6b 7369 7a65         chunksize
+0000f6e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000f6f0: 2020 696e 6469 6365 733d 696e 6469 6365    indices=indice
+0000f700: 732c 0a20 2020 2020 2020 2020 2020 2029  s,.            )
+0000f710: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
+0000f720: 656c 2e66 6974 5f74 7261 6e73 666f 726d  el.fit_transform
+0000f730: 286d 6178 5f69 7465 723d 6e75 6d5f 6974  (max_iter=num_it
+0000f740: 6572 2c20 6572 726f 725f 7374 6570 3d65  er, error_step=e
+0000f750: 7272 6f72 5f73 7465 7029 0a20 2020 2020  rror_step).     
+0000f760: 2020 2020 2020 2072 6574 7572 6e20 6e75         return nu
+0000f770: 6d70 792e 6162 7328 6d6f 6465 6c2e 4829  mpy.abs(model.H)
+0000f780: 2c20 6e75 6d70 792e 6162 7328 6d6f 6465  , numpy.abs(mode
+0000f790: 6c2e 5729 0a0a 2020 2020 6465 6620 6e6d  l.W)..    def nm
+0000f7a0: 6628 0a20 2020 2020 2020 2073 656c 662c  f(.        self,
+0000f7b0: 0a20 2020 2020 2020 206e 756d 5f63 6f6d  .        num_com
+0000f7c0: 706f 6e65 6e74 732c 0a20 2020 2020 2020  ponents,.       
+0000f7d0: 206e 756d 5f69 7465 723d 3130 302c 0a20   num_iter=100,. 
+0000f7e0: 2020 2020 2020 2065 7272 6f72 5f73 7465         error_ste
+0000f7f0: 703d 4e6f 6e65 2c0a 2020 2020 2020 2020  p=None,.        
+0000f800: 7761 7465 7266 616c 6c3d 4e6f 6e65 2c0a  waterfall=None,.
+0000f810: 2020 2020 2020 2020 483d 4e6f 6e65 2c0a          H=None,.
+0000f820: 2020 2020 2020 2020 573d 4e6f 6e65 2c0a          W=None,.
+0000f830: 2020 2020 2020 2020 7673 7465 703d 3130          vstep=10
+0000f840: 302c 0a20 2020 2020 2020 2068 7374 6570  0,.        hstep
+0000f850: 3d31 3030 302c 0a20 2020 2020 2020 2069  =1000,.        i
+0000f860: 6e64 6963 6573 3d4e 6f6e 652c 0a20 2020  ndices=None,.   
+0000f870: 2020 2020 2069 6e69 743d 4e6f 6e65 2c0a       init=None,.
+0000f880: 2020 2020 293a 0a20 2020 2020 2020 2022      ):.        "
+0000f890: 2222 0a20 2020 2020 2020 2043 6f6d 7075  "".        Compu
+0000f8a0: 7465 204e 6f6e 2d6e 6567 6174 6976 6520  te Non-negative 
+0000f8b0: 4d61 7472 6978 2046 6163 746f 7269 7a61  Matrix Factoriza
+0000f8c0: 7469 6f6e 206f 6e20 7468 6520 6461 7461  tion on the data
+0000f8d0: 2e0a 2020 2020 2020 2020 5468 6520 6d65  ..        The me
+0000f8e0: 7468 6f64 2c20 6669 7273 7420 636f 6e76  thod, first conv
+0000f8f0: 6572 7473 2c20 6966 206e 6f74 2061 6c72  erts, if not alr
+0000f900: 6561 6479 2c20 7468 6520 6461 7461 2069  eady, the data i
+0000f910: 6e74 6f20 616e 2068 6466 3520 6669 6c65  nto an hdf5 file
+0000f920: 206f 626a 6563 740a 2020 2020 2020 2020   object.        
+0000f930: 7769 7468 2074 6865 2069 6d61 6765 7320  with the images 
+0000f940: 666c 6174 7465 6e65 6420 696e 2074 6865  flattened in the
+0000f950: 2072 6f77 732e 0a0a 2020 2020 2020 2020   rows...        
+0000f960: 3a70 6172 616d 206e 756d 5f63 6f6d 706f  :param num_compo
+0000f970: 6e65 6e74 733a 204e 756d 6265 7220 6f66  nents: Number of
+0000f980: 2063 6f6d 706f 6e65 6e74 7320 746f 2066   components to f
+0000f990: 696e 640a 2020 2020 2020 2020 3a74 7970  ind.        :typ
+0000f9a0: 6520 6e75 6d5f 636f 6d70 6f6e 656e 7473  e num_components
+0000f9b0: 3a20 556e 696f 6e5b 4e6f 6e65 2c20 696e  : Union[None, in
+0000f9c0: 745d 0a20 2020 2020 2020 203a 7061 7261  t].        :para
+0000f9d0: 6d20 6e75 6d5f 6974 6572 3a20 4e75 6d62  m num_iter: Numb
+0000f9e0: 6572 206f 6620 6974 6572 6174 696f 6e73  er of iterations
+0000f9f0: 2c20 6465 6661 756c 7473 2074 6f20 3130  , defaults to 10
+0000fa00: 300a 2020 2020 2020 2020 3a74 7970 6520  0.        :type 
+0000fa10: 6e75 6d5f 6974 6572 3a20 696e 742c 206f  num_iter: int, o
+0000fa20: 7074 696f 6e61 6c0a 2020 2020 2020 2020  ptional.        
+0000fa30: 3a70 6172 616d 2065 7272 6f72 5f73 7465  :param error_ste
+0000fa40: 703a 2049 6620 6e6f 7420 4e6f 6e65 2c20  p: If not None, 
+0000fa50: 6669 6e64 2074 6865 2065 7272 6f72 2065  find the error e
+0000fa60: 7665 7279 2065 7272 6f72 5f73 7465 7020  very error_step 
+0000fa70: 616e 6420 636f 6d70 6172 6573 2069 740a  and compares it.
+0000fa80: 2020 2020 2020 2020 2020 2020 746f 2063              to c
+0000fa90: 6865 636b 2066 6f72 2063 6f6e 7665 7267  heck for converg
+0000faa0: 656e 6365 2c20 6465 6661 756c 7473 2074  ence, defaults t
+0000fab0: 6f20 4e6f 6e65 0a20 2020 2020 2020 2020  o None.         
+0000fac0: 2020 2054 4f44 4f3a 206e 6f74 2061 626c     TODO: not abl
+0000fad0: 6520 666f 7220 6875 6765 2064 6174 6173  e for huge datas
+0000fae0: 6574 732e 0a20 2020 2020 2020 203a 7479  ets..        :ty
+0000faf0: 7065 2065 7272 6f72 5f73 7465 703a 2055  pe error_step: U
+0000fb00: 6e69 6f6e 5b4e 6f6e 652c 2069 6e74 5d2c  nion[None, int],
+0000fb10: 206f 7074 696f 6e61 6c0a 2020 2020 2020   optional.      
+0000fb20: 2020 3a70 6172 616d 2077 6174 6572 6661    :param waterfa
+0000fb30: 6c6c 3a20 4966 206e 6f74 204e 6f6e 652c  ll: If not None,
+0000fb40: 204e 4d46 2069 7320 636f 6d70 7574 6564   NMF is computed
+0000fb50: 2075 7369 6e67 2074 6865 2077 6174 6572   using the water
+0000fb60: 6661 6c6c 206d 6574 686f 642e 0a20 2020  fall method..   
+0000fb70: 2020 2020 2020 2020 2054 6865 2070 6172           The par
+0000fb80: 616d 6574 6572 2073 686f 756c 6420 6265  ameter should be
+0000fb90: 2061 6e20 6172 7261 7920 7769 7468 2074   an array with t
+0000fba0: 6865 206e 756d 6265 7220 6f66 2069 7465  he number of ite
+0000fbb0: 7261 7469 6f6e 7320 7065 720a 2020 2020  rations per.    
+0000fbc0: 2020 2020 2020 2020 7375 622d 636f 6d70          sub-comp
+0000fbd0: 7574 6174 696f 6e2c 2064 6566 6175 6c74  utation, default
+0000fbe0: 7320 746f 204e 6f6e 650a 2020 2020 2020  s to None.      
+0000fbf0: 2020 3a74 7970 6520 7761 7465 7266 616c    :type waterfal
+0000fc00: 6c3a 2055 6e69 6f6e 5b4e 6f6e 652c 2061  l: Union[None, a
+0000fc10: 7272 6179 5f6c 696b 655d 2c20 6f70 7469  rray_like], opti
+0000fc20: 6f6e 616c 0a20 2020 2020 2020 203a 7061  onal.        :pa
+0000fc30: 7261 6d20 483a 2049 6e69 7420 6d61 7472  ram H: Init matr
+0000fc40: 6978 2066 6f72 2048 206f 6620 7368 6170  ix for H of shap
+0000fc50: 6520 286e 5f63 6f6d 706f 6e65 6e74 732c  e (n_components,
+0000fc60: 206e 5f73 616d 706c 6573 292c 2064 6566   n_samples), def
+0000fc70: 6175 6c74 7320 746f 204e 6f6e 650a 2020  aults to None.  
+0000fc80: 2020 2020 2020 3a74 7970 6520 483a 2055        :type H: U
+0000fc90: 6e69 6f6e 5b4e 6f6e 652c 2061 7272 6179  nion[None, array
+0000fca0: 5f6c 696b 655d 2c20 6f70 7469 6f6e 616c  _like], optional
+0000fcb0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0000fcc0: 573a 2049 6e69 7420 6d61 7472 6978 2066  W: Init matrix f
+0000fcd0: 6f72 2057 206f 6620 7368 6170 6520 286e  or W of shape (n
+0000fce0: 5f66 6561 7475 7265 732c 206e 5f63 6f6d  _features, n_com
+0000fcf0: 706f 6e65 6e74 7329 2c20 6465 6661 756c  ponents), defaul
+0000fd00: 7473 2074 6f20 4e6f 6e65 0a20 2020 2020  ts to None.     
+0000fd10: 2020 203a 7479 7065 2057 3a20 556e 696f     :type W: Unio
+0000fd20: 6e5b 4e6f 6e65 2c20 6172 7261 795f 6c69  n[None, array_li
+0000fd30: 6b65 5d2c 206f 7074 696f 6e61 6c0a 2020  ke], optional.  
+0000fd40: 2020 2020 2020 3a70 6172 616d 2069 6e64        :param ind
+0000fd50: 6963 6573 3a20 4966 206e 6f74 204e 6f6e  ices: If not Non
+0000fd60: 652c 2061 7070 6c79 206d 6574 686f 6420  e, apply method 
+0000fd70: 6f6e 6c79 2074 6f20 696e 6469 6365 7320  only to indices 
+0000fd80: 6f66 2064 6174 612c 2064 6566 6175 6c74  of data, default
+0000fd90: 7320 746f 204e 6f6e 650a 2020 2020 2020  s to None.      
+0000fda0: 2020 3a74 7970 6520 696e 6469 6365 733a    :type indices:
+0000fdb0: 2055 6e69 6f6e 5b4e 6f6e 652c 2061 7272   Union[None, arr
+0000fdc0: 6179 5f6c 696b 655d 2c20 6f70 7469 6f6e  ay_like], option
+0000fdd0: 616c 0a0a 2020 2020 2020 2020 3a72 6574  al..        :ret
+0000fde0: 7572 6e3a 2028 482c 2057 293a 2054 6865  urn: (H, W): The
+0000fdf0: 2063 6f6d 706f 6e65 6e74 7320 6d61 7472   components matr
+0000fe00: 6978 2061 6e64 2074 6865 206d 6978 696e  ix and the mixin
+0000fe10: 6720 6d61 7472 6978 2e0a 2020 2020 2020  g matrix..      
+0000fe20: 2020 2222 220a 2020 2020 2020 2020 6273    """.        bs
+0000fe30: 735f 6469 7220 3d20 6f73 2e70 6174 682e  s_dir = os.path.
+0000fe40: 6a6f 696e 2873 656c 662e 6469 722c 2022  join(self.dir, "
+0000fe50: 6273 7322 290a 2020 2020 2020 2020 6f73  bss").        os
+0000fe60: 2e6d 616b 6564 6972 7328 6273 735f 6469  .makedirs(bss_di
+0000fe70: 722c 2065 7869 7374 5f6f 6b3d 5472 7565  r, exist_ok=True
+0000fe80: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
+0000fe90: 6c66 2e5f 696e 5f6d 656d 6f72 793a 0a20  lf._in_memory:. 
+0000fea0: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
+0000feb0: 736b 6c65 6172 6e20 696d 706f 7274 2064  sklearn import d
+0000fec0: 6563 6f6d 706f 7369 7469 6f6e 0a0a 2020  ecomposition..  
+0000fed0: 2020 2020 2020 2020 2020 6d6f 6465 6c20            model 
+0000fee0: 3d20 6465 636f 6d70 6f73 6974 696f 6e2e  = decomposition.
+0000fef0: 4e4d 4628 0a20 2020 2020 2020 2020 2020  NMF(.           
+0000ff00: 2020 2020 206e 5f63 6f6d 706f 6e65 6e74       n_component
+0000ff10: 733d 6e75 6d5f 636f 6d70 6f6e 656e 7473  s=num_components
+0000ff20: 2c20 696e 6974 3d69 6e69 742c 206d 6178  , init=init, max
+0000ff30: 5f69 7465 723d 6e75 6d5f 6974 6572 0a20  _iter=num_iter. 
+0000ff40: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0000ff50: 2020 2020 2020 2020 2077 6974 6820 7365           with se
+0000ff60: 6c66 2e64 6174 612e 6f70 656e 5f61 735f  lf.data.open_as_
+0000ff70: 6864 6635 2862 7373 5f64 6972 2920 6173  hdf5(bss_dir) as
+0000ff80: 2068 3564 6573 743a 0a20 2020 2020 2020   h5dest:.       
+0000ff90: 2020 2020 2020 2020 2069 6620 696e 6469           if indi
+0000ffa0: 6365 7320 6973 206e 6f74 204e 6f6e 653a  ces is not None:
+0000ffb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ffc0: 2020 2020 2058 203d 2068 3564 6573 745b       X = h5dest[
+0000ffd0: 696e 6469 6365 735d 0a20 2020 2020 2020  indices].       
+0000ffe0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0000fff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010000: 2020 2058 203d 2068 3564 6573 740a 2020     X = h5dest.  
+00010010: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00010020: 206e 756d 7079 2e61 6e79 2858 5b3a 2c20   numpy.any(X[:, 
+00010030: 3a5d 203c 2030 293a 0a20 2020 2020 2020  :] < 0):.       
+00010040: 2020 2020 2020 2020 2020 2020 205f 6c6f               _lo
+00010050: 6767 6572 2e77 6172 6e69 6e67 2822 5365  gger.warning("Se
+00010060: 7474 696e 6720 6e65 6761 7469 7665 2076  tting negative v
+00010070: 616c 7565 7320 746f 2030 2074 6f20 636f  alues to 0 to co
+00010080: 6d70 7574 6520 4e4d 4622 290a 2020 2020  mpute NMF").    
+00010090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000100a0: 585b 585b 3a2c 203a 5d20 3c20 305d 203d  X[X[:, :] < 0] =
+000100b0: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
+000100c0: 2020 2069 6620 4820 6973 206e 6f74 204e     if H is not N
+000100d0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000100e0: 2020 2020 2020 2020 2058 203d 2058 2e61           X = X.a
+000100f0: 7374 7970 6528 482e 6474 7970 6529 0a20  stype(H.dtype). 
+00010100: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00010110: 6c69 6620 5720 6973 206e 6f74 204e 6f6e  lif W is not Non
+00010120: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00010130: 2020 2020 2020 2058 203d 2058 2e61 7374         X = X.ast
+00010140: 7970 6528 572e 6474 7970 6529 0a20 2020  ype(W.dtype).   
+00010150: 2020 2020 2020 2020 2020 2020 2077 6974               wit
+00010160: 6820 7761 726e 696e 6773 2e63 6174 6368  h warnings.catch
+00010170: 5f77 6172 6e69 6e67 7328 293a 0a20 2020  _warnings():.   
+00010180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010190: 2077 6172 6e69 6e67 732e 7369 6d70 6c65   warnings.simple
+000101a0: 6669 6c74 6572 2822 616c 7761 7973 222c  filter("always",
+000101b0: 2043 6f6e 7665 7267 656e 6365 5761 726e   ConvergenceWarn
+000101c0: 696e 6729 0a20 2020 2020 2020 2020 2020  ing).           
+000101d0: 2020 2020 2020 2020 2057 203d 206d 6f64           W = mod
+000101e0: 656c 2e66 6974 5f74 7261 6e73 666f 726d  el.fit_transform
+000101f0: 2858 2c20 573d 572c 2048 3d48 290a 2020  (X, W=W, H=H).  
+00010200: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00010210: 7475 726e 206d 6f64 656c 2e63 6f6d 706f  turn model.compo
+00010220: 6e65 6e74 735f 2c20 570a 2020 2020 2020  nents_, W.      
+00010230: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00010240: 2020 2020 6966 2077 6174 6572 6661 6c6c      if waterfall
+00010250: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00010260: 2020 2020 2020 2020 2020 2020 2020 482c                H,
+00010270: 2057 203d 2073 656c 662e 5f77 6174 6572   W = self._water
+00010280: 6661 6c6c 5f6e 6d66 280a 2020 2020 2020  fall_nmf(.      
+00010290: 2020 2020 2020 2020 2020 2020 2020 6e75                nu
+000102a0: 6d5f 636f 6d70 6f6e 656e 7473 2c20 7761  m_components, wa
+000102b0: 7465 7266 616c 6c2c 2076 7374 6570 2c20  terfall, vstep, 
+000102c0: 6873 7465 702c 2069 6e64 6963 6573 3d69  hstep, indices=i
+000102d0: 6e64 6963 6573 0a20 2020 2020 2020 2020  ndices.         
+000102e0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000102f0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00010300: 6461 7461 2e6f 7065 6e5f 6173 5f68 6466  data.open_as_hdf
+00010310: 3528 6273 735f 6469 7229 2061 7320 6835  5(bss_dir) as h5
+00010320: 6465 7374 3a0a 2020 2020 2020 2020 2020  dest:.          
+00010330: 2020 2020 2020 6d6f 6465 6c20 3d20 4e4d        model = NM
+00010340: 4628 6835 6465 7374 2c20 6e75 6d5f 636f  F(h5dest, num_co
+00010350: 6d70 6f6e 656e 7473 2c20 696e 6469 6365  mponents, indice
+00010360: 733d 696e 6469 6365 7329 0a20 2020 2020  s=indices).     
+00010370: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+00010380: 7761 726e 696e 6773 2e63 6174 6368 5f77  warnings.catch_w
+00010390: 6172 6e69 6e67 7328 293a 0a20 2020 2020  arnings():.     
+000103a0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+000103b0: 6172 6e69 6e67 732e 7369 6d70 6c65 6669  arnings.simplefi
+000103c0: 6c74 6572 2822 616c 7761 7973 222c 2043  lter("always", C
+000103d0: 6f6e 7665 7267 656e 6365 5761 726e 696e  onvergenceWarnin
+000103e0: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
+000103f0: 2020 2020 2020 206d 6f64 656c 2e66 6974         model.fit
+00010400: 5f74 7261 6e73 666f 726d 280a 2020 2020  _transform(.    
+00010410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010420: 2020 2020 6d61 785f 6974 6572 3d6e 756d      max_iter=num
+00010430: 5f69 7465 722c 0a20 2020 2020 2020 2020  _iter,.         
+00010440: 2020 2020 2020 2020 2020 2020 2020 2048                 H
+00010450: 3d48 2c0a 2020 2020 2020 2020 2020 2020  =H,.            
+00010460: 2020 2020 2020 2020 2020 2020 573d 572c              W=W,
+00010470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010480: 2020 2020 2020 2020 2076 7374 6570 3d76           vstep=v
+00010490: 7374 6570 2c0a 2020 2020 2020 2020 2020  step,.          
+000104a0: 2020 2020 2020 2020 2020 2020 2020 6873                hs
+000104b0: 7465 703d 6873 7465 702c 0a20 2020 2020  tep=hstep,.     
+000104c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000104d0: 2020 2065 7272 6f72 5f73 7465 703d 6572     error_step=er
+000104e0: 726f 725f 7374 6570 2c0a 2020 2020 2020  ror_step,.      
+000104f0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00010500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010510: 7265 7475 726e 206d 6f64 656c 2e48 2c20  return model.H, 
+00010520: 6d6f 6465 6c2e 570a 0a20 2020 2064 6566  model.W..    def
+00010530: 206e 6963 615f 6e6d 6628 0a20 2020 2020   nica_nmf(.     
+00010540: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00010550: 206e 756d 5f63 6f6d 706f 6e65 6e74 732c   num_components,
+00010560: 0a20 2020 2020 2020 2063 6875 6e6b 7369  .        chunksi
+00010570: 7a65 3d4e 6f6e 652c 0a20 2020 2020 2020  ze=None,.       
+00010580: 206e 756d 5f69 7465 723d 3530 302c 0a20   num_iter=500,. 
+00010590: 2020 2020 2020 2077 6174 6572 6661 6c6c         waterfall
+000105a0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2065  =None,.        e
+000105b0: 7272 6f72 5f73 7465 703d 4e6f 6e65 2c0a  rror_step=None,.
+000105c0: 2020 2020 2020 2020 7673 7465 703d 3130          vstep=10
+000105d0: 302c 0a20 2020 2020 2020 2068 7374 6570  0,.        hstep
+000105e0: 3d31 3030 302c 0a20 2020 2020 2020 2069  =1000,.        i
+000105f0: 6e64 6963 6573 3d4e 6f6e 652c 0a20 2020  ndices=None,.   
+00010600: 2029 3a0a 2020 2020 2020 2020 2222 220a   ):.        """.
+00010610: 2020 2020 2020 2020 4170 706c 6965 7320          Applies 
+00010620: 626f 7468 204e 4943 4120 616e 6420 4e4d  both NICA and NM
+00010630: 4620 746f 2074 6865 2064 6174 612e 2054  F to the data. T
+00010640: 6865 2069 6e69 7420 4820 616e 6420 5720  he init H and W 
+00010650: 666f 7220 4e4d 4620 6172 6520 7468 650a  for NMF are the.
+00010660: 2020 2020 2020 2020 7265 7375 6c74 206f          result o
+00010670: 6620 4e49 4341 2e0a 2020 2020 2020 2020  f NICA..        
+00010680: 2222 220a 2020 2020 2020 2020 482c 2057  """.        H, W
+00010690: 203d 2073 656c 662e 6e69 6361 286e 756d   = self.nica(num
+000106a0: 5f63 6f6d 706f 6e65 6e74 732c 2063 6875  _components, chu
+000106b0: 6e6b 7369 7a65 2c20 6e75 6d5f 6974 6572  nksize, num_iter
+000106c0: 2c20 696e 6469 6365 733d 696e 6469 6365  , indices=indice
+000106d0: 7329 0a0a 2020 2020 2020 2020 2320 496e  s)..        # In
+000106e0: 6974 6961 6c20 4e4d 4620 6661 6374 6f72  itial NMF factor
+000106f0: 697a 6174 696f 6e3a 2058 203d 2046 3020  ization: X = F0 
+00010700: 2a20 4730 0a20 2020 2020 2020 2057 203d  * G0.        W =
+00010710: 206e 756d 7079 2e61 6273 2857 290a 2020   numpy.abs(W).  
+00010720: 2020 2020 2020 4820 3d20 6e75 6d70 792e        H = numpy.
+00010730: 6162 7328 4829 0a0a 2020 2020 2020 2020  abs(H)..        
+00010740: 7265 7475 726e 2073 656c 662e 6e6d 6628  return self.nmf(
+00010750: 0a20 2020 2020 2020 2020 2020 206d 696e  .            min
+00010760: 286e 756d 5f63 6f6d 706f 6e65 6e74 732c  (num_components,
+00010770: 2048 2e73 6861 7065 5b30 5d29 2c0a 2020   H.shape[0]),.  
+00010780: 2020 2020 2020 2020 2020 6e75 6d5f 6974            num_it
+00010790: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+000107a0: 6572 726f 725f 7374 6570 2c0a 2020 2020  error_step,.    
+000107b0: 2020 2020 2020 2020 7761 7465 7266 616c          waterfal
+000107c0: 6c2c 0a20 2020 2020 2020 2020 2020 2048  l,.            H
+000107d0: 2c0a 2020 2020 2020 2020 2020 2020 572c  ,.            W,
+000107e0: 0a20 2020 2020 2020 2020 2020 2076 7374  .            vst
+000107f0: 6570 2c0a 2020 2020 2020 2020 2020 2020  ep,.            
+00010800: 6873 7465 702c 0a20 2020 2020 2020 2020  hstep,.         
+00010810: 2020 2069 6e64 6963 6573 3d69 6e64 6963     indices=indic
+00010820: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+00010830: 696e 6974 3d22 6375 7374 6f6d 222c 0a20  init="custom",. 
+00010840: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
+00010850: 6620 6170 706c 795f 6d6f 6d65 6e74 7328  f apply_moments(
+00010860: 7365 6c66 2c20 696e 6469 6365 733d 4e6f  self, indices=No
+00010870: 6e65 2c20 6368 756e 6b5f 7368 6170 653d  ne, chunk_shape=
+00010880: 5b35 3030 2c20 3530 305d 293a 0a20 2020  [500, 500]):.   
+00010890: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000108a0: 2043 6f6d 7075 7465 2074 6865 2043 4f4d   Compute the COM
+000108b0: 2c20 4657 484d 2c20 736b 6577 6e65 7373  , FWHM, skewness
+000108c0: 2061 6e64 206b 7572 746f 7369 7320 6f66   and kurtosis of
+000108d0: 2074 6865 2064 6174 6120 666f 7220 7665   the data for ve
+000108e0: 7279 2064 696d 656e 7369 6f6e 2e0a 0a20  ry dimension... 
+000108f0: 2020 2020 2020 203a 7061 7261 6d20 696e         :param in
+00010900: 6469 6365 733a 2049 6620 6e6f 7420 4e6f  dices: If not No
+00010910: 6e65 2c20 6170 706c 7920 6d65 7468 6f64  ne, apply method
+00010920: 206f 6e6c 7920 746f 2069 6e64 6963 6573   only to indices
+00010930: 206f 6620 6461 7461 2c20 6465 6661 756c   of data, defaul
+00010940: 7473 2074 6f20 4e6f 6e65 0a20 2020 2020  ts to None.     
+00010950: 2020 203a 7479 7065 2069 6e64 6963 6573     :type indices
+00010960: 3a20 556e 696f 6e5b 4e6f 6e65 2c20 6172  : Union[None, ar
+00010970: 7261 795f 6c69 6b65 5d2c 206f 7074 696f  ray_like], optio
+00010980: 6e61 6c0a 2020 2020 2020 2020 3a70 6172  nal.        :par
+00010990: 616d 2063 6875 6e6b 5f73 6861 7065 3a20  am chunk_shape: 
+000109a0: 5368 6170 6520 6f66 2074 6865 2063 6875  Shape of the chu
+000109b0: 6e6b 2069 6d61 6765 2074 6f20 7573 6520  nk image to use 
+000109c0: 7065 7220 6974 6572 6174 696f 6e2e 0a20  per iteration.. 
+000109d0: 2020 2020 2020 2020 2020 2050 6172 616d             Param
+000109e0: 6574 6572 2075 7365 6420 6f6e 6c79 2077  eter used only w
+000109f0: 6865 6e20 666c 6167 2069 6e5f 6d65 6d6f  hen flag in_memo
+00010a00: 7279 2069 7320 4661 6c73 652e 0a20 2020  ry is False..   
+00010a10: 2020 2020 203a 7479 7065 2063 6875 6e6b       :type chunk
+00010a20: 5f73 6861 7065 3a20 6172 7261 795f 6c69  _shape: array_li
+00010a30: 6b65 2c20 6f70 7469 6f6e 616c 0a20 2020  ke, optional.   
+00010a40: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+00010a50: 2020 6966 206e 6f74 2073 656c 662e 6469    if not self.di
+00010a60: 6d73 2e6e 6469 6d3a 0a20 2020 2020 2020  ms.ndim:.       
+00010a70: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
+00010a80: 0a20 2020 2020 2020 2073 656c 662e 7275  .        self.ru
+00010a90: 6e6e 696e 675f 6461 7461 203d 2073 656c  nning_data = sel
+00010aa0: 662e 6765 745f 6461 7461 2869 6e64 6963  f.get_data(indic
+00010ab0: 6573 290a 2020 2020 2020 2020 6966 2069  es).        if i
+00010ac0: 6e64 6963 6573 2069 7320 4e6f 6e65 3a0a  ndices is None:.
+00010ad0: 2020 2020 2020 2020 2020 2020 696e 6469              indi
+00010ae0: 6365 7320 3d20 7261 6e67 6528 7365 6c66  ces = range(self
+00010af0: 2e6e 6672 616d 6573 290a 2020 2020 2020  .nframes).      
+00010b00: 2020 666f 7220 6178 6973 2c20 6469 6d20    for axis, dim 
+00010b10: 696e 2073 656c 662e 6469 6d73 3a0a 2020  in self.dims:.  
+00010b20: 2020 2020 2020 2020 2020 2320 4765 7420            # Get 
+00010b30: 6d6f 746f 7220 7661 6c75 6573 2070 6572  motor values per
+00010b40: 2069 6d61 6765 206f 6620 7468 6520 7374   image of the st
+00010b50: 6163 6b0a 2020 2020 2020 2020 2020 2020  ack.            
+00010b60: 7661 6c75 6573 203d 2073 656c 662e 6765  values = self.ge
+00010b70: 745f 6469 6d65 6e73 696f 6e73 5f76 616c  t_dimensions_val
+00010b80: 7565 7328 696e 6469 6365 7329 5b64 696d  ues(indices)[dim
+00010b90: 2e6e 616d 655d 0a20 2020 2020 2020 2020  .name].         
+00010ba0: 2020 2069 6620 7365 6c66 2e5f 696e 5f6d     if self._in_m
+00010bb0: 656d 6f72 793a 0a20 2020 2020 2020 2020  emory:.         
+00010bc0: 2020 2020 2020 2023 2044 6174 6120 696e         # Data in
+00010bd0: 206d 656d 6f72 790a 2020 2020 2020 2020   memory.        
+00010be0: 2020 2020 2020 2020 6d6f 6d65 6e74 7320          moments 
+00010bf0: 3d20 6e75 6d70 792e 6173 6172 7261 7928  = numpy.asarray(
+00010c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010c10: 2020 2020 2063 6f6d 7075 7465 5f6d 6f6d       compute_mom
+00010c20: 656e 7473 2876 616c 7565 732c 2073 656c  ents(values, sel
+00010c30: 662e 7275 6e6e 696e 675f 6461 7461 292c  f.running_data),
+00010c40: 2064 7479 7065 3d6e 756d 7079 2e66 6c6f   dtype=numpy.flo
+00010c50: 6174 3634 0a20 2020 2020 2020 2020 2020  at64.           
+00010c60: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00010c70: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00010c80: 2020 2020 2020 2020 2023 2044 6174 6120           # Data 
+00010c90: 6f6e 2064 6973 6b0a 2020 2020 2020 2020  on disk.        
+00010ca0: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
+00010cb0: 5b30 2c20 305d 0a20 2020 2020 2020 2020  [0, 0].         
+00010cc0: 2020 2020 2020 2069 6d67 203d 2073 656c         img = sel
+00010cd0: 662e 7275 6e6e 696e 675f 6461 7461 5b30  f.running_data[0
+00010ce0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00010cf0: 2020 6d6f 6d65 6e74 7320 3d20 6e75 6d70    moments = nump
+00010d00: 792e 656d 7074 7928 0a20 2020 2020 2020  y.empty(.       
+00010d10: 2020 2020 2020 2020 2020 2020 2028 342c               (4,
+00010d20: 2069 6d67 2e73 6861 7065 5b30 5d2c 2069   img.shape[0], i
+00010d30: 6d67 2e73 6861 7065 5b31 5d29 2c20 6474  mg.shape[1]), dt
+00010d40: 7970 653d 6e75 6d70 792e 666c 6f61 7436  ype=numpy.float6
+00010d50: 340a 2020 2020 2020 2020 2020 2020 2020  4.              
+00010d60: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00010d70: 2020 2020 6368 756e 6b73 5f31 203d 2069      chunks_1 = i
+00010d80: 6e74 286e 756d 7079 2e63 6569 6c28 696d  nt(numpy.ceil(im
+00010d90: 672e 7368 6170 655b 305d 202f 2063 6875  g.shape[0] / chu
+00010da0: 6e6b 5f73 6861 7065 5b30 5d29 290a 2020  nk_shape[0])).  
+00010db0: 2020 2020 2020 2020 2020 2020 2020 6368                ch
+00010dc0: 756e 6b73 5f32 203d 2069 6e74 286e 756d  unks_2 = int(num
+00010dd0: 7079 2e63 6569 6c28 696d 672e 7368 6170  py.ceil(img.shap
+00010de0: 655b 315d 202f 2063 6875 6e6b 5f73 6861  e[1] / chunk_sha
+00010df0: 7065 5b31 5d29 290a 2020 2020 2020 2020  pe[1])).        
+00010e00: 2020 2020 2020 2020 696f 5f75 7469 6c73          io_utils
+00010e10: 2e61 6476 616e 6365 6d65 6e74 5f64 6973  .advancement_dis
+00010e20: 706c 6179 280a 2020 2020 2020 2020 2020  play(.          
+00010e30: 2020 2020 2020 2020 2020 302c 2063 6875            0, chu
+00010e40: 6e6b 735f 3120 2a20 6368 756e 6b73 5f32  nks_1 * chunks_2
+00010e50: 202a 206c 656e 2873 656c 662e 7275 6e6e   * len(self.runn
+00010e60: 696e 675f 6461 7461 292c 2022 436f 6d70  ing_data), "Comp
+00010e70: 7574 696e 6720 6d6f 6d65 6e74 7322 0a20  uting moments". 
+00010e80: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00010e90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010ea0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+00010eb0: 6368 756e 6b73 5f31 293a 0a20 2020 2020  chunks_1):.     
+00010ec0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00010ed0: 6f72 206a 2069 6e20 7261 6e67 6528 6368  or j in range(ch
+00010ee0: 756e 6b73 5f32 293a 0a20 2020 2020 2020  unks_2):.       
+00010ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f00: 2063 5f69 6d61 6765 7320 3d20 5b5d 0a20   c_images = []. 
+00010f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f20: 2020 2020 2020 2063 7075 7320 3d20 6d75         cpus = mu
+00010f30: 6c74 6970 726f 6365 7373 696e 672e 6370  ltiprocessing.cp
+00010f40: 755f 636f 756e 7428 290a 2020 2020 2020  u_count().      
+00010f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f60: 2020 7769 7468 2050 6f6f 6c28 6370 7573    with Pool(cpus
+00010f70: 202d 2031 2920 6173 2070 3a0a 2020 2020   - 1) as p:.    
 00010f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f90: 2020 2020 2020 6370 7573 203d 206d 756c        cpus = mul
-00010fa0: 7469 7072 6f63 6573 7369 6e67 2e63 7075  tiprocessing.cpu
-00010fb0: 5f63 6f75 6e74 2829 0a20 2020 2020 2020  _count().       
-00010fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010fd0: 2077 6974 6820 506f 6f6c 2863 7075 7320   with Pool(cpus 
-00010fe0: 2d20 3129 2061 7320 703a 0a20 2020 2020  - 1) as p:.     
-00010ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011000: 2020 2020 2020 2063 5f69 6d61 6765 7320         c_images 
-00011010: 3d20 702e 6d61 7028 0a20 2020 2020 2020  = p.map(.       
-00011020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011030: 2020 2020 2020 2020 2070 6172 7469 616c           partial
-00011040: 2863 6875 6e6b 5f69 6d61 6765 2c20 7374  (chunk_image, st
-00011050: 6172 742c 2063 6875 6e6b 5f73 6861 7065  art, chunk_shape
-00011060: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00011070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011080: 2020 2073 656c 662e 7275 6e6e 696e 675f     self.running_
-00011090: 6461 7461 2c0a 2020 2020 2020 2020 2020  data,.          
-000110a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110b0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-000110c0: 2020 2020 2020 2020 2020 2020 696f 5f75              io_u
-000110d0: 7469 6c73 2e61 6476 616e 6365 6d65 6e74  tils.advancement
-000110e0: 5f64 6973 706c 6179 280a 2020 2020 2020  _display(.      
-000110f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011100: 2020 2020 2020 6920 2a20 6368 756e 6b73        i * chunks
-00011110: 5f32 202b 206a 202b 2031 2c0a 2020 2020  _2 + j + 1,.    
-00011120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011130: 2020 2020 2020 2020 6368 756e 6b73 5f31          chunks_1
-00011140: 202a 2063 6875 6e6b 735f 322c 0a20 2020   * chunks_2,.   
-00011150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011160: 2020 2020 2020 2020 2022 436f 6d70 7574           "Comput
-00011170: 696e 6720 6d6f 6d65 6e74 7322 2c0a 2020  ing moments",.  
+00010f90: 2020 2020 2020 2020 635f 696d 6167 6573          c_images
+00010fa0: 203d 2070 2e6d 6170 280a 2020 2020 2020   = p.map(.      
+00010fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010fc0: 2020 2020 2020 2020 2020 7061 7274 6961            partia
+00010fd0: 6c28 6368 756e 6b5f 696d 6167 652c 2073  l(chunk_image, s
+00010fe0: 7461 7274 2c20 6368 756e 6b5f 7368 6170  tart, chunk_shap
+00010ff0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00011000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011010: 2020 2020 7365 6c66 2e72 756e 6e69 6e67      self.running
+00011020: 5f64 6174 612c 0a20 2020 2020 2020 2020  _data,.         
+00011030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011040: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00011050: 2020 2020 2020 2020 2020 2020 2069 6f5f               io_
+00011060: 7574 696c 732e 6164 7661 6e63 656d 656e  utils.advancemen
+00011070: 745f 6469 7370 6c61 7928 0a20 2020 2020  t_display(.     
+00011080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011090: 2020 2020 2020 2069 202a 2063 6875 6e6b         i * chunk
+000110a0: 735f 3220 2b20 6a20 2b20 312c 0a20 2020  s_2 + j + 1,.   
+000110b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000110c0: 2020 2020 2020 2020 2063 6875 6e6b 735f           chunks_
+000110d0: 3120 2a20 6368 756e 6b73 5f32 2c0a 2020  1 * chunks_2,.  
+000110e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000110f0: 2020 2020 2020 2020 2020 2243 6f6d 7075            "Compu
+00011100: 7469 6e67 206d 6f6d 656e 7473 222c 0a20  ting moments",. 
+00011110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011120: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00011130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011140: 2063 6f6d 2c20 7374 642c 2073 6b65 772c   com, std, skew,
+00011150: 206b 7572 7420 3d20 636f 6d70 7574 655f   kurt = compute_
+00011160: 6d6f 6d65 6e74 7328 7661 6c75 6573 2c20  moments(values, 
+00011170: 635f 696d 6167 6573 290a 2020 2020 2020  c_images).      
 00011180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011190: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00011190: 2020 6d6f 6d65 6e74 735b 305d 5b0a 2020    moments[0][.  
 000111a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000111b0: 636f 6d2c 2073 7464 2c20 736b 6577 2c20  com, std, skew, 
-000111c0: 6b75 7274 203d 2063 6f6d 7075 7465 5f6d  kurt = compute_m
-000111d0: 6f6d 656e 7473 2876 616c 7565 732c 2063  oments(values, c
-000111e0: 5f69 6d61 6765 7329 0a20 2020 2020 2020  _images).       
-000111f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011200: 206d 6f6d 656e 7473 5b30 5d5b 0a20 2020   moments[0][.   
-00011210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011220: 2020 2020 2020 2020 2073 7461 7274 5b30           start[0
-00011230: 5d20 3a20 7374 6172 745b 305d 202b 2063  ] : start[0] + c
-00011240: 6875 6e6b 5f73 6861 7065 5b30 5d2c 0a20  hunk_shape[0],. 
-00011250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011260: 2020 2020 2020 2020 2020 2073 7461 7274             start
-00011270: 5b31 5d20 3a20 7374 6172 745b 315d 202b  [1] : start[1] +
-00011280: 2063 6875 6e6b 5f73 6861 7065 5b31 5d2c   chunk_shape[1],
-00011290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000112a0: 2020 2020 2020 2020 205d 203d 2063 6f6d           ] = com
-000112b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000112c0: 2020 2020 2020 2020 206d 6f6d 656e 7473           moments
-000112d0: 5b31 5d5b 0a20 2020 2020 2020 2020 2020  [1][.           
-000112e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000112f0: 2073 7461 7274 5b30 5d20 3a20 7374 6172   start[0] : star
-00011300: 745b 305d 202b 2063 6875 6e6b 5f73 6861  t[0] + chunk_sha
-00011310: 7065 5b30 5d2c 0a20 2020 2020 2020 2020  pe[0],.         
-00011320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011330: 2020 2073 7461 7274 5b31 5d20 3a20 7374     start[1] : st
-00011340: 6172 745b 315d 202b 2063 6875 6e6b 5f73  art[1] + chunk_s
-00011350: 6861 7065 5b31 5d2c 0a20 2020 2020 2020  hape[1],.       
-00011360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011370: 205d 203d 2073 7464 0a20 2020 2020 2020   ] = std.       
-00011380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011390: 206d 6f6d 656e 7473 5b32 5d5b 0a20 2020   moments[2][.   
-000113a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000113b0: 2020 2020 2020 2020 2073 7461 7274 5b30           start[0
-000113c0: 5d20 3a20 7374 6172 745b 305d 202b 2063  ] : start[0] + c
-000113d0: 6875 6e6b 5f73 6861 7065 5b30 5d2c 0a20  hunk_shape[0],. 
-000113e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000113f0: 2020 2020 2020 2020 2020 2073 7461 7274             start
-00011400: 5b31 5d20 3a20 7374 6172 745b 315d 202b  [1] : start[1] +
-00011410: 2063 6875 6e6b 5f73 6861 7065 5b31 5d2c   chunk_shape[1],
-00011420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011430: 2020 2020 2020 2020 205d 203d 2073 6b65           ] = ske
-00011440: 770a 2020 2020 2020 2020 2020 2020 2020  w.              
-00011450: 2020 2020 2020 2020 2020 6d6f 6d65 6e74            moment
-00011460: 735b 335d 5b0a 2020 2020 2020 2020 2020  s[3][.          
-00011470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011480: 2020 7374 6172 745b 305d 203a 2073 7461    start[0] : sta
-00011490: 7274 5b30 5d20 2b20 6368 756e 6b5f 7368  rt[0] + chunk_sh
-000114a0: 6170 655b 305d 2c0a 2020 2020 2020 2020  ape[0],.        
-000114b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000114c0: 2020 2020 7374 6172 745b 315d 203a 2073      start[1] : s
-000114d0: 7461 7274 5b31 5d20 2b20 6368 756e 6b5f  tart[1] + chunk_
-000114e0: 7368 6170 655b 315d 2c0a 2020 2020 2020  shape[1],.      
-000114f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011500: 2020 5d20 3d20 6b75 7274 0a20 2020 2020    ] = kurt.     
+000111b0: 2020 2020 2020 2020 2020 7374 6172 745b            start[
+000111c0: 305d 203a 2073 7461 7274 5b30 5d20 2b20  0] : start[0] + 
+000111d0: 6368 756e 6b5f 7368 6170 655b 305d 2c0a  chunk_shape[0],.
+000111e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000111f0: 2020 2020 2020 2020 2020 2020 7374 6172              star
+00011200: 745b 315d 203a 2073 7461 7274 5b31 5d20  t[1] : start[1] 
+00011210: 2b20 6368 756e 6b5f 7368 6170 655b 315d  + chunk_shape[1]
+00011220: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00011230: 2020 2020 2020 2020 2020 5d20 3d20 636f            ] = co
+00011240: 6d0a 2020 2020 2020 2020 2020 2020 2020  m.              
+00011250: 2020 2020 2020 2020 2020 6d6f 6d65 6e74            moment
+00011260: 735b 315d 5b0a 2020 2020 2020 2020 2020  s[1][.          
+00011270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011280: 2020 7374 6172 745b 305d 203a 2073 7461    start[0] : sta
+00011290: 7274 5b30 5d20 2b20 6368 756e 6b5f 7368  rt[0] + chunk_sh
+000112a0: 6170 655b 305d 2c0a 2020 2020 2020 2020  ape[0],.        
+000112b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000112c0: 2020 2020 7374 6172 745b 315d 203a 2073      start[1] : s
+000112d0: 7461 7274 5b31 5d20 2b20 6368 756e 6b5f  tart[1] + chunk_
+000112e0: 7368 6170 655b 315d 2c0a 2020 2020 2020  shape[1],.      
+000112f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011300: 2020 5d20 3d20 7374 640a 2020 2020 2020    ] = std.      
+00011310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011320: 2020 6d6f 6d65 6e74 735b 325d 5b0a 2020    moments[2][.  
+00011330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011340: 2020 2020 2020 2020 2020 7374 6172 745b            start[
+00011350: 305d 203a 2073 7461 7274 5b30 5d20 2b20  0] : start[0] + 
+00011360: 6368 756e 6b5f 7368 6170 655b 305d 2c0a  chunk_shape[0],.
+00011370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011380: 2020 2020 2020 2020 2020 2020 7374 6172              star
+00011390: 745b 315d 203a 2073 7461 7274 5b31 5d20  t[1] : start[1] 
+000113a0: 2b20 6368 756e 6b5f 7368 6170 655b 315d  + chunk_shape[1]
+000113b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000113c0: 2020 2020 2020 2020 2020 5d20 3d20 736b            ] = sk
+000113d0: 6577 0a20 2020 2020 2020 2020 2020 2020  ew.             
+000113e0: 2020 2020 2020 2020 2020 206d 6f6d 656e             momen
+000113f0: 7473 5b33 5d5b 0a20 2020 2020 2020 2020  ts[3][.         
+00011400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011410: 2020 2073 7461 7274 5b30 5d20 3a20 7374     start[0] : st
+00011420: 6172 745b 305d 202b 2063 6875 6e6b 5f73  art[0] + chunk_s
+00011430: 6861 7065 5b30 5d2c 0a20 2020 2020 2020  hape[0],.       
+00011440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011450: 2020 2020 2073 7461 7274 5b31 5d20 3a20       start[1] : 
+00011460: 7374 6172 745b 315d 202b 2063 6875 6e6b  start[1] + chunk
+00011470: 5f73 6861 7065 5b31 5d2c 0a20 2020 2020  _shape[1],.     
+00011480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011490: 2020 205d 203d 206b 7572 740a 2020 2020     ] = kurt.    
+000114a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000114b0: 2020 2020 7374 6172 745b 315d 203d 2063      start[1] = c
+000114c0: 6875 6e6b 5f73 6861 7065 5b31 5d20 2a20  hunk_shape[1] * 
+000114d0: 286a 202b 2031 290a 2020 2020 2020 2020  (j + 1).        
+000114e0: 2020 2020 2020 2020 2020 2020 7374 6172              star
+000114f0: 745b 305d 203d 2063 6875 6e6b 5f73 6861  t[0] = chunk_sha
+00011500: 7065 5b30 5d20 2a20 2869 202b 2031 290a  pe[0] * (i + 1).
 00011510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011520: 2020 2073 7461 7274 5b31 5d20 3d20 6368     start[1] = ch
-00011530: 756e 6b5f 7368 6170 655b 315d 202a 2028  unk_shape[1] * (
-00011540: 6a20 2b20 3129 0a20 2020 2020 2020 2020  j + 1).         
-00011550: 2020 2020 2020 2020 2020 2073 7461 7274             start
-00011560: 5b30 5d20 3d20 6368 756e 6b5f 7368 6170  [0] = chunk_shap
-00011570: 655b 305d 202a 2028 6920 2b20 3129 0a20  e[0] * (i + 1). 
-00011580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011590: 2020 2073 7461 7274 5b31 5d20 3d20 300a     start[1] = 0.
-000115a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000115b0: 2e6d 6f6d 656e 7473 5f64 696d 735b 6178  .moments_dims[ax
-000115c0: 6973 5d20 3d20 6d6f 6d65 6e74 730a 0a20  is] = moments.. 
-000115d0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-000115e0: 6c66 2e6d 6f6d 656e 7473 5f64 696d 730a  lf.moments_dims.
-000115f0: 0a20 2020 2064 6566 2061 7070 6c79 5f66  .    def apply_f
-00011600: 6974 280a 2020 2020 2020 2020 7365 6c66  it(.        self
-00011610: 2c20 696e 6469 6365 733d 4e6f 6e65 2c20  , indices=None, 
-00011620: 696e 745f 7468 7265 7368 3d4e 6f6e 652c  int_thresh=None,
-00011630: 2063 6875 6e6b 5f73 6861 7065 3d5b 3130   chunk_shape=[10
-00011640: 302c 2031 3030 5d2c 205f 6469 723d 4e6f  0, 100], _dir=No
-00011650: 6e65 0a20 2020 2029 3a0a 2020 2020 2020  ne.    ):.      
-00011660: 2020 2222 220a 2020 2020 2020 2020 4669    """.        Fi
-00011670: 7473 2074 6865 2064 6174 6120 6172 6f75  ts the data arou
-00011680: 6e64 2061 7869 7320 3020 616e 6420 7361  nd axis 0 and sa
-00011690: 7665 7320 7468 6520 6e65 7720 6461 7461  ves the new data
-000116a0: 2069 6e74 6f20 6469 736b 2e0a 0a20 2020   into disk...   
-000116b0: 2020 2020 203a 7061 7261 6d20 696e 6469       :param indi
-000116c0: 6365 733a 2049 6e64 6963 6573 206f 6620  ces: Indices of 
-000116d0: 7468 6520 696d 6167 6573 2074 6f20 6669  the images to fi
-000116e0: 742e 0a20 2020 2020 2020 2020 2020 2049  t..            I
-000116f0: 6620 4e6f 6e65 2c20 7468 6520 6669 7420  f None, the fit 
-00011700: 6973 2064 6f6e 6520 746f 2061 6c6c 2074  is done to all t
-00011710: 6865 2064 6174 612e 0a20 2020 2020 2020  he data..       
-00011720: 203a 7479 7065 2069 6e64 6963 6573 3a20   :type indices: 
-00011730: 556e 696f 6e5b 4e6f 6e65 2c20 6172 7261  Union[None, arra
-00011740: 795f 6c69 6b65 5d0a 2020 2020 2020 2020  y_like].        
-00011750: 3a70 6172 616d 2069 6e74 5f74 6872 6573  :param int_thres
-00011760: 683a 2073 6565 2060 6d61 7070 696e 672e  h: see `mapping.
-00011770: 6669 745f 7069 7865 6c60 0a20 2020 2020  fit_pixel`.     
-00011780: 2020 203a 7479 7065 2069 6e74 5f74 6872     :type int_thr
-00011790: 6573 683a 2055 6e69 6f6e 5b4e 6f6e 652c  esh: Union[None,
-000117a0: 2066 6c6f 6174 5d0a 2020 2020 2020 2020   float].        
-000117b0: 3a70 6172 616d 2063 6875 6e6b 5f73 6861  :param chunk_sha
-000117c0: 7065 3a20 5368 6170 6520 6f66 2074 6865  pe: Shape of the
-000117d0: 2063 6875 6e6b 2069 6d61 6765 2074 6f20   chunk image to 
-000117e0: 7573 6520 7065 7220 6974 6572 6174 696f  use per iteratio
-000117f0: 6e2e 0a20 2020 2020 2020 2020 2020 2050  n..            P
-00011800: 6172 616d 6574 6572 2075 7365 6420 6f6e  arameter used on
-00011810: 6c79 2077 6865 6e20 666c 6167 2069 6e5f  ly when flag in_
-00011820: 6d65 6d6f 7279 2069 7320 4661 6c73 652e  memory is False.
-00011830: 0a20 2020 2020 2020 203a 7479 7065 2063  .        :type c
-00011840: 6875 6e6b 5f73 6861 7065 3a20 6172 7261  hunk_shape: arra
-00011850: 795f 6c69 6b65 0a20 2020 2020 2020 203a  y_like.        :
-00011860: 7265 7475 726e 733a 2064 6174 6173 6574  returns: dataset
-00011870: 2077 6974 6820 6461 7461 206f 6620 7361   with data of sa
-00011880: 6d65 2073 697a 6520 6173 2060 7365 6c66  me size as `self
-00011890: 2e64 6174 6160 2062 7574 2077 6974 6820  .data` but with 
-000118a0: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
-000118b0: 6d6f 6469 6669 6564 2069 6d61 6765 732e  modified images.
-000118c0: 2054 6865 2075 726c 7320 6f66 2074 6865   The urls of the
-000118d0: 206d 6f64 6966 6965 6420 696d 6167 6573   modified images
-000118e0: 2061 7265 2072 6570 6c61 6365 6420 7769   are replaced wi
-000118f0: 7468 0a20 2020 2020 2020 2020 2020 2074  th.            t
-00011900: 6865 206e 6577 2075 726c 732e 0a20 2020  he new urls..   
-00011910: 2020 2020 203a 7274 7970 653a 2044 6174       :rtype: Dat
-00011920: 6173 6574 0a20 2020 2020 2020 2022 2222  aset.        """
-00011930: 0a0a 2020 2020 2020 2020 5f64 6972 203d  ..        _dir =
-00011940: 2073 656c 662e 6469 7220 6966 205f 6469   self.dir if _di
-00011950: 7220 6973 204e 6f6e 6520 656c 7365 205f  r is None else _
-00011960: 6469 720a 2020 2020 2020 2020 5f64 6972  dir.        _dir
-00011970: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
-00011980: 5f64 6972 2c20 2266 6974 2229 0a0a 2020  _dir, "fit")..  
-00011990: 2020 2020 2020 6f73 2e6d 616b 6564 6972        os.makedir
-000119a0: 7328 5f64 6972 2c20 6578 6973 745f 6f6b  s(_dir, exist_ok
-000119b0: 3d54 7275 6529 0a0a 2020 2020 2020 2020  =True)..        
-000119c0: 7769 7468 2073 656c 662e 7374 6174 655f  with self.state_
-000119d0: 6f66 5f6f 7065 7261 7469 6f6e 732e 7275  of_operations.ru
-000119e0: 6e5f 636f 6e74 6578 7428 4f70 6572 6174  n_context(Operat
-000119f0: 696f 6e2e 4649 5429 3a0a 2020 2020 2020  ion.FIT):.      
-00011a00: 2020 2020 2020 7572 6c73 203d 205b 5d0a        urls = [].
-00011a10: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
-00011a20: 6573 203d 204e 6f6e 650a 2020 2020 2020  es = None.      
-00011a30: 2020 2020 2020 7368 6170 6520 3d20 4e6f        shape = No
-00011a40: 6e65 0a20 2020 2020 2020 2020 2020 2064  ne.            d
-00011a50: 6174 6120 3d20 7365 6c66 2e67 6574 5f64  ata = self.get_d
-00011a60: 6174 6128 696e 6469 6365 7329 0a20 2020  ata(indices).   
-00011a70: 2020 2020 2020 2020 2023 2046 6974 2063           # Fit c
-00011a80: 616e 206f 6e6c 7920 6265 2064 6f6e 6520  an only be done 
-00011a90: 6966 2072 6f63 6b69 6e67 2063 7572 7665  if rocking curve
-00011aa0: 7320 6172 6520 6174 206c 6561 7374 206f  s are at least o
-00011ab0: 6620 7369 7a65 2033 0a20 2020 2020 2020  f size 3.       
-00011ac0: 2020 2020 2069 6620 6c65 6e28 6461 7461       if len(data
-00011ad0: 2920 3c20 333a 0a20 2020 2020 2020 2020  ) < 3:.         
-00011ae0: 2020 2020 2020 205f 6c6f 6767 6572 2e77         _logger.w
-00011af0: 6172 6e69 6e67 2822 4e6f 7420 656e 6f75  arning("Not enou
-00011b00: 6768 2076 616c 7565 7320 666f 7220 6669  gh values for fi
-00011b10: 7474 696e 6722 290a 2020 2020 2020 2020  tting").        
-00011b20: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00011b30: 656c 660a 2020 2020 2020 2020 2020 2020  elf.            
-00011b40: 6966 2069 6e64 6963 6573 2069 7320 4e6f  if indices is No
-00011b50: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00011b60: 2020 2020 696e 6469 6365 7320 3d20 7261      indices = ra
-00011b70: 6e67 6528 6461 7461 2e73 6861 7065 5b30  nge(data.shape[0
-00011b80: 5d29 0a0a 2020 2020 2020 2020 2020 2020  ])..            
-00011b90: 6966 2073 656c 662e 6469 6d73 2e6e 6469  if self.dims.ndi
-00011ba0: 6d20 3d3d 2032 3a0a 2020 2020 2020 2020  m == 2:.        
-00011bb0: 2020 2020 2020 2020 7864 696d 203d 2073          xdim = s
-00011bc0: 656c 662e 6469 6d73 2e67 6574 2830 290a  elf.dims.get(0).
-00011bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011be0: 7964 696d 203d 2073 656c 662e 6469 6d73  ydim = self.dims
-00011bf0: 2e67 6574 2831 290a 2020 2020 2020 2020  .get(1).        
-00011c00: 2020 2020 2020 2020 7661 6c75 6573 203d          values =
-00011c10: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-00011c20: 2020 2020 2020 2073 656c 662e 6765 745f         self.get_
-00011c30: 6d65 7461 6461 7461 5f76 616c 7565 7328  metadata_values(
-00011c40: 6b69 6e64 3d78 6469 6d2e 6b69 6e64 2c20  kind=xdim.kind, 
-00011c50: 6b65 793d 7864 696d 2e6e 616d 6529 2c0a  key=xdim.name),.
-00011c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c70: 2020 2020 7365 6c66 2e67 6574 5f6d 6574      self.get_met
-00011c80: 6164 6174 615f 7661 6c75 6573 286b 696e  adata_values(kin
-00011c90: 643d 7964 696d 2e6b 696e 642c 206b 6579  d=ydim.kind, key
-00011ca0: 3d79 6469 6d2e 6e61 6d65 292c 0a20 2020  =ydim.name),.   
-00011cb0: 2020 2020 2020 2020 2020 2020 205d 0a20               ]. 
-00011cc0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00011cd0: 6861 7065 203d 205b 7864 696d 2e73 697a  hape = [xdim.siz
-00011ce0: 652c 2079 6469 6d2e 7369 7a65 5d0a 2020  e, ydim.size].  
-00011cf0: 2020 2020 2020 2020 2020 2020 2020 5f66                _f
-00011d00: 6974 203d 2066 6974 5f32 645f 6461 7461  it = fit_2d_data
-00011d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011d20: 2064 6174 6120 3d20 7365 6c66 2e67 6574   data = self.get
-00011d30: 5f64 6174 6128 290a 2020 2020 2020 2020  _data().        
-00011d40: 2020 2020 2020 2020 6d61 7073 203d 206e          maps = n
-00011d50: 756d 7079 2e65 6d70 7479 2828 372c 2920  umpy.empty((7,) 
-00011d60: 2b20 6461 7461 5b30 5d2e 7368 6170 6529  + data[0].shape)
-00011d70: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00011d80: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00011d90: 2020 2064 6174 6120 3d20 7365 6c66 2e67     data = self.g
-00011da0: 6574 5f64 6174 6128 696e 6469 6365 7329  et_data(indices)
-00011db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011dc0: 205f 6669 7420 3d20 6669 745f 6461 7461   _fit = fit_data
-00011dd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011de0: 2069 6620 7365 6c66 2e64 696d 732e 6e64   if self.dims.nd
-00011df0: 696d 203e 2030 3a0a 2020 2020 2020 2020  im > 0:.        
-00011e00: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
-00011e10: 6573 203d 2073 656c 662e 6765 745f 6d65  es = self.get_me
-00011e20: 7461 6461 7461 5f76 616c 7565 7328 0a20  tadata_values(. 
-00011e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011e40: 2020 2020 2020 206b 696e 643d 7365 6c66         kind=self
-00011e50: 2e64 696d 732e 6765 7428 3029 2e6b 696e  .dims.get(0).kin
-00011e60: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-00011e70: 2020 2020 2020 2020 2020 206b 6579 3d73             key=s
-00011e80: 656c 662e 6469 6d73 2e67 6574 2830 292e  elf.dims.get(0).
-00011e90: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-00011ea0: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00011eb0: 6469 6365 733d 696e 6469 6365 732c 0a20  dices=indices,. 
-00011ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011ed0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00011ee0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00011ef0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-00011f00: 616c 7565 7320 3d20 4e6f 6e65 0a20 2020  alues = None.   
-00011f10: 2020 2020 2020 2020 2020 2020 206d 6170               map
-00011f20: 7320 3d20 6e75 6d70 792e 656d 7074 7928  s = numpy.empty(
-00011f30: 2834 2c29 202b 2064 6174 615b 305d 2e73  (4,) + data[0].s
-00011f40: 6861 7065 290a 2020 2020 2020 2020 2020  hape).          
-00011f50: 2020 6966 206e 6f74 2064 6174 612e 696e    if not data.in
-00011f60: 5f6d 656d 6f72 793a 0a20 2020 2020 2020  _memory:.       
-00011f70: 2020 2020 2020 2020 2023 2055 7365 2063           # Use c
-00011f80: 6875 6e6b 7320 746f 206c 6f61 6420 7468  hunks to load th
-00011f90: 6520 6461 7461 2069 6e74 6f20 6d65 6d6f  e data into memo
-00011fa0: 7279 0a20 2020 2020 2020 2020 2020 2020  ry.             
-00011fb0: 2020 2073 7461 7274 203d 205b 302c 2030     start = [0, 0
-00011fc0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00011fd0: 2020 6368 756e 6b73 5f31 203d 2069 6e74    chunks_1 = int
-00011fe0: 286e 756d 7079 2e63 6569 6c28 6461 7461  (numpy.ceil(data
-00011ff0: 2e73 6861 7065 5b31 5d20 2f20 6368 756e  .shape[1] / chun
-00012000: 6b5f 7368 6170 655b 305d 2929 0a20 2020  k_shape[0])).   
-00012010: 2020 2020 2020 2020 2020 2020 2063 6875               chu
-00012020: 6e6b 735f 3220 3d20 696e 7428 6e75 6d70  nks_2 = int(nump
-00012030: 792e 6365 696c 2864 6174 612e 7368 6170  y.ceil(data.shap
-00012040: 655b 325d 202f 2063 6875 6e6b 5f73 6861  e[2] / chunk_sha
-00012050: 7065 5b31 5d29 290a 2020 2020 2020 2020  pe[1])).        
-00012060: 2020 2020 2020 2020 696d 6720 3d20 6e75          img = nu
-00012070: 6d70 792e 656d 7074 7928 2864 6174 612e  mpy.empty((data.
-00012080: 7368 6170 655b 315d 2c20 6461 7461 2e73  shape[1], data.s
-00012090: 6861 7065 5b32 5d29 290a 2020 2020 2020  hape[2])).      
-000120a0: 2020 2020 2020 2020 2020 696f 5f75 7469            io_uti
-000120b0: 6c73 2e61 6476 616e 6365 6d65 6e74 5f64  ls.advancement_d
-000120c0: 6973 706c 6179 280a 2020 2020 2020 2020  isplay(.        
-000120d0: 2020 2020 2020 2020 2020 2020 302c 2063              0, c
-000120e0: 6875 6e6b 735f 3120 2a20 6368 756e 6b73  hunks_1 * chunks
-000120f0: 5f32 202a 206c 656e 2864 6174 6129 2c20  _2 * len(data), 
-00012100: 2246 6974 7469 6e67 2072 6f63 6b69 6e67  "Fitting rocking
-00012110: 2063 7572 7665 7322 0a20 2020 2020 2020   curves".       
-00012120: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00012130: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-00012140: 2069 6e20 7261 6e67 6528 6368 756e 6b73   in range(chunks
-00012150: 5f31 293a 0a20 2020 2020 2020 2020 2020  _1):.           
-00012160: 2020 2020 2020 2020 2066 6f72 206a 2069           for j i
-00012170: 6e20 7261 6e67 6528 6368 756e 6b73 5f32  n range(chunks_2
-00012180: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00012190: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-000121a0: 7420 7365 6c66 2e73 7461 7465 5f6f 665f  t self.state_of_
-000121b0: 6f70 6572 6174 696f 6e73 2e69 735f 7275  operations.is_ru
-000121c0: 6e6e 696e 6728 4f70 6572 6174 696f 6e2e  nning(Operation.
-000121d0: 4649 5429 3a0a 2020 2020 2020 2020 2020  FIT):.          
-000121e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000121f0: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
-00012200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012210: 2023 2055 7365 206d 756c 7469 7072 6f63   # Use multiproc
-00012220: 6573 7369 6e67 2074 6f20 6368 756e 6b20  essing to chunk 
-00012230: 7468 6520 696d 6167 6573 0a20 2020 2020  the images.     
+00011520: 2020 2020 7374 6172 745b 315d 203d 2030      start[1] = 0
+00011530: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00011540: 662e 6d6f 6d65 6e74 735f 6469 6d73 5b61  f.moments_dims[a
+00011550: 7869 735d 203d 206d 6f6d 656e 7473 0a0a  xis] = moments..
+00011560: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00011570: 656c 662e 6d6f 6d65 6e74 735f 6469 6d73  elf.moments_dims
+00011580: 0a0a 2020 2020 6465 6620 6170 706c 795f  ..    def apply_
+00011590: 6669 7428 0a20 2020 2020 2020 2073 656c  fit(.        sel
+000115a0: 662c 2069 6e64 6963 6573 3d4e 6f6e 652c  f, indices=None,
+000115b0: 2069 6e74 5f74 6872 6573 683d 4e6f 6e65   int_thresh=None
+000115c0: 2c20 6368 756e 6b5f 7368 6170 653d 5b31  , chunk_shape=[1
+000115d0: 3030 2c20 3130 305d 2c20 5f64 6972 3d4e  00, 100], _dir=N
+000115e0: 6f6e 650a 2020 2020 293a 0a20 2020 2020  one.    ):.     
+000115f0: 2020 2022 2222 0a20 2020 2020 2020 2046     """.        F
+00011600: 6974 7320 7468 6520 6461 7461 2061 726f  its the data aro
+00011610: 756e 6420 6178 6973 2030 2061 6e64 2073  und axis 0 and s
+00011620: 6176 6573 2074 6865 206e 6577 2064 6174  aves the new dat
+00011630: 6120 696e 746f 2064 6973 6b2e 0a0a 2020  a into disk...  
+00011640: 2020 2020 2020 3a70 6172 616d 2069 6e64        :param ind
+00011650: 6963 6573 3a20 496e 6469 6365 7320 6f66  ices: Indices of
+00011660: 2074 6865 2069 6d61 6765 7320 746f 2066   the images to f
+00011670: 6974 2e0a 2020 2020 2020 2020 2020 2020  it..            
+00011680: 4966 204e 6f6e 652c 2074 6865 2066 6974  If None, the fit
+00011690: 2069 7320 646f 6e65 2074 6f20 616c 6c20   is done to all 
+000116a0: 7468 6520 6461 7461 2e0a 2020 2020 2020  the data..      
+000116b0: 2020 3a74 7970 6520 696e 6469 6365 733a    :type indices:
+000116c0: 2055 6e69 6f6e 5b4e 6f6e 652c 2061 7272   Union[None, arr
+000116d0: 6179 5f6c 696b 655d 0a20 2020 2020 2020  ay_like].       
+000116e0: 203a 7061 7261 6d20 696e 745f 7468 7265   :param int_thre
+000116f0: 7368 3a20 7365 6520 606d 6170 7069 6e67  sh: see `mapping
+00011700: 2e66 6974 5f70 6978 656c 600a 2020 2020  .fit_pixel`.    
+00011710: 2020 2020 3a74 7970 6520 696e 745f 7468      :type int_th
+00011720: 7265 7368 3a20 556e 696f 6e5b 4e6f 6e65  resh: Union[None
+00011730: 2c20 666c 6f61 745d 0a20 2020 2020 2020  , float].       
+00011740: 203a 7061 7261 6d20 6368 756e 6b5f 7368   :param chunk_sh
+00011750: 6170 653a 2053 6861 7065 206f 6620 7468  ape: Shape of th
+00011760: 6520 6368 756e 6b20 696d 6167 6520 746f  e chunk image to
+00011770: 2075 7365 2070 6572 2069 7465 7261 7469   use per iterati
+00011780: 6f6e 2e0a 2020 2020 2020 2020 2020 2020  on..            
+00011790: 5061 7261 6d65 7465 7220 7573 6564 206f  Parameter used o
+000117a0: 6e6c 7920 7768 656e 2066 6c61 6720 696e  nly when flag in
+000117b0: 5f6d 656d 6f72 7920 6973 2046 616c 7365  _memory is False
+000117c0: 2e0a 2020 2020 2020 2020 3a74 7970 6520  ..        :type 
+000117d0: 6368 756e 6b5f 7368 6170 653a 2061 7272  chunk_shape: arr
+000117e0: 6179 5f6c 696b 650a 2020 2020 2020 2020  ay_like.        
+000117f0: 3a72 6574 7572 6e73 3a20 6461 7461 7365  :returns: datase
+00011800: 7420 7769 7468 2064 6174 6120 6f66 2073  t with data of s
+00011810: 616d 6520 7369 7a65 2061 7320 6073 656c  ame size as `sel
+00011820: 662e 6461 7461 6020 6275 7420 7769 7468  f.data` but with
+00011830: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
+00011840: 206d 6f64 6966 6965 6420 696d 6167 6573   modified images
+00011850: 2e20 5468 6520 7572 6c73 206f 6620 7468  . The urls of th
+00011860: 6520 6d6f 6469 6669 6564 2069 6d61 6765  e modified image
+00011870: 7320 6172 6520 7265 706c 6163 6564 2077  s are replaced w
+00011880: 6974 680a 2020 2020 2020 2020 2020 2020  ith.            
+00011890: 7468 6520 6e65 7720 7572 6c73 2e0a 2020  the new urls..  
+000118a0: 2020 2020 2020 3a72 7479 7065 3a20 4461        :rtype: Da
+000118b0: 7461 7365 740a 2020 2020 2020 2020 2222  taset.        ""
+000118c0: 220a 0a20 2020 2020 2020 205f 6469 7220  "..        _dir 
+000118d0: 3d20 7365 6c66 2e64 6972 2069 6620 5f64  = self.dir if _d
+000118e0: 6972 2069 7320 4e6f 6e65 2065 6c73 6520  ir is None else 
+000118f0: 5f64 6972 0a20 2020 2020 2020 205f 6469  _dir.        _di
+00011900: 7220 3d20 6f73 2e70 6174 682e 6a6f 696e  r = os.path.join
+00011910: 285f 6469 722c 2022 6669 7422 290a 0a20  (_dir, "fit").. 
+00011920: 2020 2020 2020 206f 732e 6d61 6b65 6469         os.makedi
+00011930: 7273 285f 6469 722c 2065 7869 7374 5f6f  rs(_dir, exist_o
+00011940: 6b3d 5472 7565 290a 0a20 2020 2020 2020  k=True)..       
+00011950: 2077 6974 6820 7365 6c66 2e73 7461 7465   with self.state
+00011960: 5f6f 665f 6f70 6572 6174 696f 6e73 2e72  _of_operations.r
+00011970: 756e 5f63 6f6e 7465 7874 284f 7065 7261  un_context(Opera
+00011980: 7469 6f6e 2e46 4954 293a 0a20 2020 2020  tion.FIT):.     
+00011990: 2020 2020 2020 2075 726c 7320 3d20 5b5d         urls = []
+000119a0: 0a20 2020 2020 2020 2020 2020 2076 616c  .            val
+000119b0: 7565 7320 3d20 4e6f 6e65 0a20 2020 2020  ues = None.     
+000119c0: 2020 2020 2020 2073 6861 7065 203d 204e         shape = N
+000119d0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+000119e0: 6461 7461 203d 2073 656c 662e 6765 745f  data = self.get_
+000119f0: 6461 7461 2869 6e64 6963 6573 290a 2020  data(indices).  
+00011a00: 2020 2020 2020 2020 2020 2320 4669 7420            # Fit 
+00011a10: 6361 6e20 6f6e 6c79 2062 6520 646f 6e65  can only be done
+00011a20: 2069 6620 726f 636b 696e 6720 6375 7276   if rocking curv
+00011a30: 6573 2061 7265 2061 7420 6c65 6173 7420  es are at least 
+00011a40: 6f66 2073 697a 6520 330a 2020 2020 2020  of size 3.      
+00011a50: 2020 2020 2020 6966 206c 656e 2864 6174        if len(dat
+00011a60: 6129 203c 2033 3a0a 2020 2020 2020 2020  a) < 3:.        
+00011a70: 2020 2020 2020 2020 5f6c 6f67 6765 722e          _logger.
+00011a80: 7761 726e 696e 6728 224e 6f74 2065 6e6f  warning("Not eno
+00011a90: 7567 6820 7661 6c75 6573 2066 6f72 2066  ugh values for f
+00011aa0: 6974 7469 6e67 2229 0a20 2020 2020 2020  itting").       
+00011ab0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00011ac0: 7365 6c66 0a20 2020 2020 2020 2020 2020  self.           
+00011ad0: 2069 6620 696e 6469 6365 7320 6973 204e   if indices is N
+00011ae0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00011af0: 2020 2020 2069 6e64 6963 6573 203d 2072       indices = r
+00011b00: 616e 6765 2864 6174 612e 7368 6170 655b  ange(data.shape[
+00011b10: 305d 290a 0a20 2020 2020 2020 2020 2020  0])..           
+00011b20: 2069 6620 7365 6c66 2e64 696d 732e 6e64   if self.dims.nd
+00011b30: 696d 203d 3d20 323a 0a20 2020 2020 2020  im == 2:.       
+00011b40: 2020 2020 2020 2020 2078 6469 6d20 3d20           xdim = 
+00011b50: 7365 6c66 2e64 696d 732e 6765 7428 3029  self.dims.get(0)
+00011b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011b70: 2079 6469 6d20 3d20 7365 6c66 2e64 696d   ydim = self.dim
+00011b80: 732e 6765 7428 3129 0a20 2020 2020 2020  s.get(1).       
+00011b90: 2020 2020 2020 2020 2076 616c 7565 7320           values 
+00011ba0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+00011bb0: 2020 2020 2020 2020 7365 6c66 2e67 6574          self.get
+00011bc0: 5f6d 6574 6164 6174 615f 7661 6c75 6573  _metadata_values
+00011bd0: 286b 696e 643d 7864 696d 2e6b 696e 642c  (kind=xdim.kind,
+00011be0: 206b 6579 3d78 6469 6d2e 6e61 6d65 292c   key=xdim.name),
+00011bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011c00: 2020 2020 2073 656c 662e 6765 745f 6d65       self.get_me
+00011c10: 7461 6461 7461 5f76 616c 7565 7328 6b69  tadata_values(ki
+00011c20: 6e64 3d79 6469 6d2e 6b69 6e64 2c20 6b65  nd=ydim.kind, ke
+00011c30: 793d 7964 696d 2e6e 616d 6529 2c0a 2020  y=ydim.name),.  
+00011c40: 2020 2020 2020 2020 2020 2020 2020 5d0a                ].
+00011c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c60: 7368 6170 6520 3d20 5b78 6469 6d2e 7369  shape = [xdim.si
+00011c70: 7a65 2c20 7964 696d 2e73 697a 655d 0a20  ze, ydim.size]. 
+00011c80: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+00011c90: 6669 7420 3d20 6669 745f 3264 5f64 6174  fit = fit_2d_dat
+00011ca0: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
+00011cb0: 2020 6461 7461 203d 2073 656c 662e 6765    data = self.ge
+00011cc0: 745f 6461 7461 2829 0a20 2020 2020 2020  t_data().       
+00011cd0: 2020 2020 2020 2020 206d 6170 7320 3d20           maps = 
+00011ce0: 6e75 6d70 792e 656d 7074 7928 2837 2c29  numpy.empty((7,)
+00011cf0: 202b 2064 6174 615b 305d 2e73 6861 7065   + data[0].shape
+00011d00: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00011d10: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00011d20: 2020 2020 6461 7461 203d 2073 656c 662e      data = self.
+00011d30: 6765 745f 6461 7461 2869 6e64 6963 6573  get_data(indices
+00011d40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00011d50: 2020 5f66 6974 203d 2066 6974 5f64 6174    _fit = fit_dat
+00011d60: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
+00011d70: 2020 6966 2073 656c 662e 6469 6d73 2e6e    if self.dims.n
+00011d80: 6469 6d20 3e20 303a 0a20 2020 2020 2020  dim > 0:.       
+00011d90: 2020 2020 2020 2020 2020 2020 2076 616c               val
+00011da0: 7565 7320 3d20 7365 6c66 2e67 6574 5f6d  ues = self.get_m
+00011db0: 6574 6164 6174 615f 7661 6c75 6573 280a  etadata_values(.
+00011dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011dd0: 2020 2020 2020 2020 6b69 6e64 3d73 656c          kind=sel
+00011de0: 662e 6469 6d73 2e67 6574 2830 292e 6b69  f.dims.get(0).ki
+00011df0: 6e64 2c0a 2020 2020 2020 2020 2020 2020  nd,.            
+00011e00: 2020 2020 2020 2020 2020 2020 6b65 793d              key=
+00011e10: 7365 6c66 2e64 696d 732e 6765 7428 3029  self.dims.get(0)
+00011e20: 2e6e 616d 652c 0a20 2020 2020 2020 2020  .name,.         
+00011e30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00011e40: 6e64 6963 6573 3d69 6e64 6963 6573 2c0a  ndices=indices,.
+00011e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011e60: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00011e70: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00011e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011e90: 7661 6c75 6573 203d 204e 6f6e 650a 2020  values = None.  
+00011ea0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00011eb0: 7073 203d 206e 756d 7079 2e65 6d70 7479  ps = numpy.empty
+00011ec0: 2828 342c 2920 2b20 6461 7461 5b30 5d2e  ((4,) + data[0].
+00011ed0: 7368 6170 6529 0a20 2020 2020 2020 2020  shape).         
+00011ee0: 2020 2069 6620 6e6f 7420 6461 7461 2e69     if not data.i
+00011ef0: 6e5f 6d65 6d6f 7279 3a0a 2020 2020 2020  n_memory:.      
+00011f00: 2020 2020 2020 2020 2020 2320 5573 6520            # Use 
+00011f10: 6368 756e 6b73 2074 6f20 6c6f 6164 2074  chunks to load t
+00011f20: 6865 2064 6174 6120 696e 746f 206d 656d  he data into mem
+00011f30: 6f72 790a 2020 2020 2020 2020 2020 2020  ory.            
+00011f40: 2020 2020 7374 6172 7420 3d20 5b30 2c20      start = [0, 
+00011f50: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
+00011f60: 2020 2063 6875 6e6b 735f 3120 3d20 696e     chunks_1 = in
+00011f70: 7428 6e75 6d70 792e 6365 696c 2864 6174  t(numpy.ceil(dat
+00011f80: 612e 7368 6170 655b 315d 202f 2063 6875  a.shape[1] / chu
+00011f90: 6e6b 5f73 6861 7065 5b30 5d29 290a 2020  nk_shape[0])).  
+00011fa0: 2020 2020 2020 2020 2020 2020 2020 6368                ch
+00011fb0: 756e 6b73 5f32 203d 2069 6e74 286e 756d  unks_2 = int(num
+00011fc0: 7079 2e63 6569 6c28 6461 7461 2e73 6861  py.ceil(data.sha
+00011fd0: 7065 5b32 5d20 2f20 6368 756e 6b5f 7368  pe[2] / chunk_sh
+00011fe0: 6170 655b 315d 2929 0a20 2020 2020 2020  ape[1])).       
+00011ff0: 2020 2020 2020 2020 2069 6d67 203d 206e           img = n
+00012000: 756d 7079 2e65 6d70 7479 2828 6461 7461  umpy.empty((data
+00012010: 2e73 6861 7065 5b31 5d2c 2064 6174 612e  .shape[1], data.
+00012020: 7368 6170 655b 325d 2929 0a20 2020 2020  shape[2])).     
+00012030: 2020 2020 2020 2020 2020 2069 6f5f 7574             io_ut
+00012040: 696c 732e 6164 7661 6e63 656d 656e 745f  ils.advancement_
+00012050: 6469 7370 6c61 7928 0a20 2020 2020 2020  display(.       
+00012060: 2020 2020 2020 2020 2020 2020 2030 2c20               0, 
+00012070: 6368 756e 6b73 5f31 202a 2063 6875 6e6b  chunks_1 * chunk
+00012080: 735f 3220 2a20 6c65 6e28 6461 7461 292c  s_2 * len(data),
+00012090: 2022 4669 7474 696e 6720 726f 636b 696e   "Fitting rockin
+000120a0: 6720 6375 7276 6573 220a 2020 2020 2020  g curves".      
+000120b0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000120c0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000120d0: 6920 696e 2072 616e 6765 2863 6875 6e6b  i in range(chunk
+000120e0: 735f 3129 3a0a 2020 2020 2020 2020 2020  s_1):.          
+000120f0: 2020 2020 2020 2020 2020 666f 7220 6a20            for j 
+00012100: 696e 2072 616e 6765 2863 6875 6e6b 735f  in range(chunks_
+00012110: 3229 3a0a 2020 2020 2020 2020 2020 2020  2):.            
+00012120: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00012130: 6f74 2073 656c 662e 7374 6174 655f 6f66  ot self.state_of
+00012140: 5f6f 7065 7261 7469 6f6e 732e 6973 5f72  _operations.is_r
+00012150: 756e 6e69 6e67 284f 7065 7261 7469 6f6e  unning(Operation
+00012160: 2e46 4954 293a 0a20 2020 2020 2020 2020  .FIT):.         
+00012170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012180: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
+00012190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000121a0: 2020 2320 5573 6520 6d75 6c74 6970 726f    # Use multipro
+000121b0: 6365 7373 696e 6720 746f 2063 6875 6e6b  cessing to chunk
+000121c0: 2074 6865 2069 6d61 6765 730a 2020 2020   the images.    
+000121d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000121e0: 2020 2020 6370 7573 203d 206d 756c 7469      cpus = multi
+000121f0: 7072 6f63 6573 7369 6e67 2e63 7075 5f63  processing.cpu_c
+00012200: 6f75 6e74 2829 0a20 2020 2020 2020 2020  ount().         
+00012210: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00012220: 6974 6820 506f 6f6c 2863 7075 7320 2d20  ith Pool(cpus - 
+00012230: 3129 2061 7320 703a 0a20 2020 2020 2020  1) as p:.       
 00012240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012250: 2020 2063 7075 7320 3d20 6d75 6c74 6970     cpus = multip
-00012260: 726f 6365 7373 696e 672e 6370 755f 636f  rocessing.cpu_co
-00012270: 756e 7428 290a 2020 2020 2020 2020 2020  unt().          
-00012280: 2020 2020 2020 2020 2020 2020 2020 7769                wi
-00012290: 7468 2050 6f6f 6c28 6370 7573 202d 2031  th Pool(cpus - 1
-000122a0: 2920 6173 2070 3a0a 2020 2020 2020 2020  ) as p:.        
-000122b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000122c0: 2020 2020 635f 696d 6167 6573 203d 2070      c_images = p
-000122d0: 2e6d 6170 280a 2020 2020 2020 2020 2020  .map(.          
-000122e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000122f0: 2020 2020 2020 7061 7274 6961 6c28 6368        partial(ch
-00012300: 756e 6b5f 696d 6167 652c 2073 7461 7274  unk_image, start
-00012310: 2c20 6368 756e 6b5f 7368 6170 6529 2c20  , chunk_shape), 
-00012320: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
-00012330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012340: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00012350: 2020 2020 2020 2020 2020 2066 6974 7465             fitte
-00012360: 645f 6461 7461 2c20 6368 756e 6b65 645f  d_data, chunked_
-00012370: 6d61 7073 203d 205f 6669 7428 0a20 2020  maps = _fit(.   
-00012380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012390: 2020 2020 2020 2020 206e 756d 7079 2e61           numpy.a
-000123a0: 7361 7272 6179 2863 5f69 6d61 6765 7329  sarray(c_images)
-000123b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000123c0: 2020 2020 2020 2020 2020 2020 2020 7661                va
-000123d0: 6c75 6573 3d76 616c 7565 732c 0a20 2020  lues=values,.   
-000123e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000123f0: 2020 2020 2020 2020 2073 6861 7065 3d73           shape=s
-00012400: 6861 7065 2c0a 2020 2020 2020 2020 2020  hape,.          
-00012410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012420: 2020 696e 6469 6365 733d 696e 6469 6365    indices=indice
-00012430: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00012440: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00012450: 6e74 5f74 6872 6573 683d 696e 745f 7468  nt_thresh=int_th
-00012460: 7265 7368 2c0a 2020 2020 2020 2020 2020  resh,.          
-00012470: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00012250: 2020 2020 2063 5f69 6d61 6765 7320 3d20       c_images = 
+00012260: 702e 6d61 7028 0a20 2020 2020 2020 2020  p.map(.         
+00012270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012280: 2020 2020 2020 2070 6172 7469 616c 2863         partial(c
+00012290: 6875 6e6b 5f69 6d61 6765 2c20 7374 6172  hunk_image, star
+000122a0: 742c 2063 6875 6e6b 5f73 6861 7065 292c  t, chunk_shape),
+000122b0: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
+000122c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000122d0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+000122e0: 2020 2020 2020 2020 2020 2020 6669 7474              fitt
+000122f0: 6564 5f64 6174 612c 2063 6875 6e6b 6564  ed_data, chunked
+00012300: 5f6d 6170 7320 3d20 5f66 6974 280a 2020  _maps = _fit(.  
+00012310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012320: 2020 2020 2020 2020 2020 6e75 6d70 792e            numpy.
+00012330: 6173 6172 7261 7928 635f 696d 6167 6573  asarray(c_images
+00012340: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00012350: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+00012360: 616c 7565 733d 7661 6c75 6573 2c0a 2020  alues=values,.  
+00012370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012380: 2020 2020 2020 2020 2020 7368 6170 653d            shape=
+00012390: 7368 6170 652c 0a20 2020 2020 2020 2020  shape,.         
+000123a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000123b0: 2020 2069 6e64 6963 6573 3d69 6e64 6963     indices=indic
+000123c0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+000123d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000123e0: 696e 745f 7468 7265 7368 3d69 6e74 5f74  int_thresh=int_t
+000123f0: 6872 6573 682c 0a20 2020 2020 2020 2020  hresh,.         
+00012400: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00012410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012420: 2020 2020 2020 2020 2066 6f72 206b 2069           for k i
+00012430: 6e20 7261 6e67 6528 6c65 6e28 6669 7474  n range(len(fitt
+00012440: 6564 5f64 6174 6129 293a 0a20 2020 2020  ed_data)):.     
+00012450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012460: 2020 2020 2020 2066 696c 656e 616d 6520         filename 
+00012470: 3d20 6f73 2e70 6174 682e 6a6f 696e 280a  = os.path.join(.
 00012480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012490: 2020 2020 2020 2020 666f 7220 6b20 696e          for k in
-000124a0: 2072 616e 6765 286c 656e 2866 6974 7465   range(len(fitte
-000124b0: 645f 6461 7461 2929 3a0a 2020 2020 2020  d_data)):.      
-000124c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000124d0: 2020 2020 2020 6669 6c65 6e61 6d65 203d        filename =
-000124e0: 206f 732e 7061 7468 2e6a 6f69 6e28 0a20   os.path.join(. 
-000124f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012500: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-00012510: 6469 722c 2022 6461 7461 5f66 6974 5f22  dir, "data_fit_"
-00012520: 202b 2073 7472 2869 6e64 6963 6573 5b6b   + str(indices[k
-00012530: 5d29 2e7a 6669 6c6c 2834 2920 2b20 222e  ]).zfill(4) + ".
-00012540: 6e70 7922 0a20 2020 2020 2020 2020 2020  npy".           
-00012550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012560: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00012570: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00012580: 6620 2869 2c20 6a29 2021 3d20 2830 2c20  f (i, j) != (0, 
-00012590: 3029 3a0a 2020 2020 2020 2020 2020 2020  0):.            
-000125a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000125b0: 2020 2020 2320 4966 2063 6875 6e6b 2069      # If chunk i
-000125c0: 7320 6e6f 7420 7468 6520 6669 7273 742c  s not the first,
-000125d0: 206c 6f61 6420 696d 6167 6520 6672 6f6d   load image from
-000125e0: 2064 6973 6b0a 2020 2020 2020 2020 2020   disk.          
-000125f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012600: 2020 2020 2020 696d 6720 3d20 6e75 6d70        img = nump
-00012610: 792e 6c6f 6164 2866 696c 656e 616d 6529  y.load(filename)
-00012620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012630: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00012640: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00012490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000124a0: 5f64 6972 2c20 2264 6174 615f 6669 745f  _dir, "data_fit_
+000124b0: 2220 2b20 7374 7228 696e 6469 6365 735b  " + str(indices[
+000124c0: 6b5d 292e 7a66 696c 6c28 3429 202b 2022  k]).zfill(4) + "
+000124d0: 2e6e 7079 220a 2020 2020 2020 2020 2020  .npy".          
+000124e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000124f0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00012500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012510: 6966 2028 692c 206a 2920 213d 2028 302c  if (i, j) != (0,
+00012520: 2030 293a 0a20 2020 2020 2020 2020 2020   0):.           
+00012530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012540: 2020 2020 2023 2049 6620 6368 756e 6b20       # If chunk 
+00012550: 6973 206e 6f74 2074 6865 2066 6972 7374  is not the first
+00012560: 2c20 6c6f 6164 2069 6d61 6765 2066 726f  , load image fro
+00012570: 6d20 6469 736b 0a20 2020 2020 2020 2020  m disk.         
+00012580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012590: 2020 2020 2020 2069 6d67 203d 206e 756d         img = num
+000125a0: 7079 2e6c 6f61 6428 6669 6c65 6e61 6d65  py.load(filename
+000125b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000125c0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+000125d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000125e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000125f0: 2020 2020 7572 6c73 2e61 7070 656e 6428      urls.append(
+00012600: 4461 7461 5572 6c28 6669 6c65 5f70 6174  DataUrl(file_pat
+00012610: 683d 6669 6c65 6e61 6d65 2c20 7363 6865  h=filename, sche
+00012620: 6d65 3d22 6661 6269 6f22 2929 0a20 2020  me="fabio")).   
+00012630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012640: 2020 2020 2020 2020 2069 6d67 5b0a 2020           img[.  
 00012650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012660: 2020 2075 726c 732e 6170 7065 6e64 2844     urls.append(D
-00012670: 6174 6155 726c 2866 696c 655f 7061 7468  ataUrl(file_path
-00012680: 3d66 696c 656e 616d 652c 2073 6368 656d  =filename, schem
-00012690: 653d 2266 6162 696f 2229 290a 2020 2020  e="fabio")).    
+00012660: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00012670: 6172 745b 305d 203a 2073 7461 7274 5b30  art[0] : start[0
+00012680: 5d20 2b20 6368 756e 6b5f 7368 6170 655b  ] + chunk_shape[
+00012690: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
 000126a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000126b0: 2020 2020 2020 2020 696d 675b 0a20 2020          img[.   
-000126c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000126d0: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-000126e0: 7274 5b30 5d20 3a20 7374 6172 745b 305d  rt[0] : start[0]
-000126f0: 202b 2063 6875 6e6b 5f73 6861 7065 5b30   + chunk_shape[0
-00012700: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000126b0: 2020 2020 7374 6172 745b 315d 203a 2073      start[1] : s
+000126c0: 7461 7274 5b31 5d20 2b20 6368 756e 6b5f  tart[1] + chunk_
+000126d0: 7368 6170 655b 315d 2c0a 2020 2020 2020  shape[1],.      
+000126e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000126f0: 2020 2020 2020 5d20 3d20 6669 7474 6564        ] = fitted
+00012700: 5f64 6174 615b 6b5d 0a20 2020 2020 2020  _data[k].       
 00012710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012720: 2020 2073 7461 7274 5b31 5d20 3a20 7374     start[1] : st
-00012730: 6172 745b 315d 202b 2063 6875 6e6b 5f73  art[1] + chunk_s
-00012740: 6861 7065 5b31 5d2c 0a20 2020 2020 2020  hape[1],.       
-00012750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012760: 2020 2020 205d 203d 2066 6974 7465 645f       ] = fitted_
-00012770: 6461 7461 5b6b 5d0a 2020 2020 2020 2020  data[k].        
+00012720: 2020 2020 206e 756d 7079 2e73 6176 6528       numpy.save(
+00012730: 6669 6c65 6e61 6d65 2c20 696d 6729 0a20  filename, img). 
+00012740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012750: 2020 2020 2020 2020 2020 2069 6f5f 7574             io_ut
+00012760: 696c 732e 6164 7661 6e63 656d 656e 745f  ils.advancement_
+00012770: 6469 7370 6c61 7928 0a20 2020 2020 2020  display(.       
 00012780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012790: 2020 2020 6e75 6d70 792e 7361 7665 2866      numpy.save(f
-000127a0: 696c 656e 616d 652c 2069 6d67 290a 2020  ilename, img).  
-000127b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000127c0: 2020 2020 2020 2020 2020 696f 5f75 7469            io_uti
-000127d0: 6c73 2e61 6476 616e 6365 6d65 6e74 5f64  ls.advancement_d
-000127e0: 6973 706c 6179 280a 2020 2020 2020 2020  isplay(.        
-000127f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012800: 2020 2020 2020 2020 6920 2a20 6368 756e          i * chun
-00012810: 6b73 5f32 202a 206c 656e 2864 6174 6129  ks_2 * len(data)
-00012820: 202b 206a 202a 206c 656e 2864 6174 6129   + j * len(data)
-00012830: 202b 206b 202b 2031 2c0a 2020 2020 2020   + k + 1,.      
-00012840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012850: 2020 2020 2020 2020 2020 6368 756e 6b73            chunks
-00012860: 5f31 202a 2063 6875 6e6b 735f 3220 2a20  _1 * chunks_2 * 
-00012870: 6c65 6e28 6461 7461 292c 0a20 2020 2020  len(data),.     
-00012880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012890: 2020 2020 2020 2020 2020 2022 4669 7474             "Fitt
-000128a0: 696e 6720 726f 636b 696e 6720 6375 7276  ing rocking curv
-000128b0: 6573 222c 0a20 2020 2020 2020 2020 2020  es",.           
-000128c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000128d0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-000128e0: 2020 2020 2020 2020 2020 206d 6170 735b             maps[
-000128f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012900: 2020 2020 2020 2020 2020 2020 203a 2c0a               :,.
-00012910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012920: 2020 2020 2020 2020 2020 2020 7374 6172              star
-00012930: 745b 305d 203a 2073 7461 7274 5b30 5d20  t[0] : start[0] 
-00012940: 2b20 6368 756e 6b5f 7368 6170 655b 305d  + chunk_shape[0]
-00012950: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00012960: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00012970: 6172 745b 315d 203a 2073 7461 7274 5b31  art[1] : start[1
-00012980: 5d20 2b20 6368 756e 6b5f 7368 6170 655b  ] + chunk_shape[
-00012990: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
-000129a0: 2020 2020 2020 2020 2020 2020 5d20 3d20              ] = 
-000129b0: 6368 756e 6b65 645f 6d61 7073 0a20 2020  chunked_maps.   
-000129c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000129d0: 2020 2020 2073 7461 7274 5b31 5d20 3d20       start[1] = 
-000129e0: 6368 756e 6b5f 7368 6170 655b 315d 202a  chunk_shape[1] *
-000129f0: 2028 6a20 2b20 3129 0a20 2020 2020 2020   (j + 1).       
-00012a00: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-00012a10: 7274 5b30 5d20 3d20 6368 756e 6b5f 7368  rt[0] = chunk_sh
-00012a20: 6170 655b 305d 202a 2028 6920 2b20 3129  ape[0] * (i + 1)
-00012a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012a40: 2020 2020 2073 7461 7274 5b31 5d20 3d20       start[1] = 
-00012a50: 300a 2020 2020 2020 2020 2020 2020 656c  0.            el
-00012a60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00012a70: 2020 2020 6669 7474 6564 5f64 6174 612c      fitted_data,
-00012a80: 206d 6170 7320 3d20 5f66 6974 280a 2020   maps = _fit(.  
-00012a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012aa0: 2020 6461 7461 2c0a 2020 2020 2020 2020    data,.        
-00012ab0: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
-00012ac0: 6573 3d76 616c 7565 732c 0a20 2020 2020  es=values,.     
-00012ad0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00012ae0: 6861 7065 3d73 6861 7065 2c0a 2020 2020  hape=shape,.    
-00012af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012b00: 696e 745f 7468 7265 7368 3d69 6e74 5f74  int_thresh=int_t
-00012b10: 6872 6573 682c 0a20 2020 2020 2020 2020  hresh,.         
-00012b20: 2020 2020 2020 2020 2020 2069 6e64 6963             indic
-00012b30: 6573 3d69 6e64 6963 6573 2c0a 2020 2020  es=indices,.    
-00012b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012b50: 5f74 7164 6d3d 5472 7565 2c0a 2020 2020  _tqdm=True,.    
-00012b60: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00012b70: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00012b80: 7220 692c 2069 6d61 6765 2069 6e20 656e  r i, image in en
-00012b90: 756d 6572 6174 6528 6669 7474 6564 5f64  umerate(fitted_d
-00012ba0: 6174 6129 3a0a 2020 2020 2020 2020 2020  ata):.          
-00012bb0: 2020 2020 2020 2020 2020 6669 6c65 6e61            filena
-00012bc0: 6d65 203d 206f 732e 7061 7468 2e6a 6f69  me = os.path.joi
-00012bd0: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-00012be0: 2020 2020 2020 2020 2020 205f 6469 722c             _dir,
-00012bf0: 2022 6461 7461 5f66 6974 2220 2b20 7374   "data_fit" + st
-00012c00: 7228 696e 6469 6365 735b 695d 292e 7a66  r(indices[i]).zf
-00012c10: 696c 6c28 3429 202b 2022 2e6e 7079 220a  ill(4) + ".npy".
-00012c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012c30: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00012c40: 2020 2020 2020 2020 2020 6e75 6d70 792e            numpy.
-00012c50: 7361 7665 2866 696c 656e 616d 652c 2069  save(filename, i
-00012c60: 6d61 6765 290a 2020 2020 2020 2020 2020  mage).          
-00012c70: 2020 2020 2020 2020 2020 7572 6c73 2e61            urls.a
-00012c80: 7070 656e 6428 4461 7461 5572 6c28 6669  ppend(DataUrl(fi
-00012c90: 6c65 5f70 6174 683d 6669 6c65 6e61 6d65  le_path=filename
-00012ca0: 2c20 7363 6865 6d65 3d22 6661 6269 6f22  , scheme="fabio"
-00012cb0: 2929 0a0a 2020 2020 2020 2020 6966 2069  ))..        if i
-00012cc0: 6e64 6963 6573 2069 7320 6e6f 7420 4e6f  ndices is not No
-00012cd0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00012ce0: 2320 5265 706c 6163 6520 6f6e 6c79 2066  # Replace only f
-00012cf0: 6974 7465 6420 6461 7461 2075 726c 730a  itted data urls.
-00012d00: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
-00012d10: 7572 6c73 203d 206e 756d 7079 2e61 7272  urls = numpy.arr
-00012d20: 6179 2873 656c 662e 6461 7461 2e75 726c  ay(self.data.url
-00012d30: 732c 2064 7479 7065 3d6f 626a 6563 7429  s, dtype=object)
-00012d40: 2e66 6c61 7474 656e 2829 0a20 2020 2020  .flatten().     
-00012d50: 2020 2020 2020 206e 756d 7079 2e70 7574         numpy.put
-00012d60: 286e 6577 5f75 726c 732c 2069 6e64 6963  (new_urls, indic
-00012d70: 6573 2c20 7572 6c73 290a 2020 2020 2020  es, urls).      
-00012d80: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00012d90: 2020 2020 6e65 775f 7572 6c73 203d 206e      new_urls = n
-00012da0: 756d 7079 2e61 7272 6179 2875 726c 7329  umpy.array(urls)
-00012db0: 0a0a 2020 2020 2020 2020 6461 7461 203d  ..        data =
-00012dc0: 2044 6174 6128 0a20 2020 2020 2020 2020   Data(.         
-00012dd0: 2020 206e 6577 5f75 726c 732e 7265 7368     new_urls.resh
-00012de0: 6170 6528 7365 6c66 2e64 6174 612e 7572  ape(self.data.ur
-00012df0: 6c73 2e73 6861 7065 292c 0a20 2020 2020  ls.shape),.     
-00012e00: 2020 2020 2020 2073 656c 662e 6461 7461         self.data
-00012e10: 2e6d 6574 6164 6174 612c 0a20 2020 2020  .metadata,.     
-00012e20: 2020 2020 2020 2069 6e5f 6d65 6d6f 7279         in_memory
-00012e30: 3d73 656c 662e 5f69 6e5f 6d65 6d6f 7279  =self._in_memory
-00012e40: 2c0a 2020 2020 2020 2020 2920 2023 2074  ,.        )  # t
-00012e50: 6f20 6d6f 6469 6679 0a20 2020 2020 2020  o modify.       
-00012e60: 2072 6574 7572 6e20 280a 2020 2020 2020   return (.      
-00012e70: 2020 2020 2020 4461 7461 7365 7428 0a20        Dataset(. 
-00012e80: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-00012e90: 6469 723d 5f64 6972 2c0a 2020 2020 2020  dir=_dir,.      
-00012ea0: 2020 2020 2020 2020 2020 6461 7461 3d64            data=d
-00012eb0: 6174 612c 0a20 2020 2020 2020 2020 2020  ata,.           
-00012ec0: 2020 2020 2064 696d 733d 7365 6c66 2e5f       dims=self._
-00012ed0: 5f64 696d 732c 0a20 2020 2020 2020 2020  _dims,.         
-00012ee0: 2020 2020 2020 2074 7261 6e73 666f 726d         transform
-00012ef0: 6174 696f 6e3d 7365 6c66 2e74 7261 6e73  ation=self.trans
-00012f00: 666f 726d 6174 696f 6e2c 0a20 2020 2020  formation,.     
-00012f10: 2020 2020 2020 2020 2020 2069 6e5f 6d65             in_me
-00012f20: 6d6f 7279 3d73 656c 662e 5f69 6e5f 6d65  mory=self._in_me
-00012f30: 6d6f 7279 2c0a 2020 2020 2020 2020 2020  mory,.          
-00012f40: 2020 2020 2020 7469 746c 653d 7365 6c66        title=self
-00012f50: 2e74 6974 6c65 2c0a 2020 2020 2020 2020  .title,.        
-00012f60: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-00012f70: 2020 206d 6170 732c 0a20 2020 2020 2020     maps,.       
-00012f80: 2029 0a0a 2020 2020 6465 6620 636f 6d70   )..    def comp
-00012f90: 7574 655f 7472 616e 7366 6f72 6d61 7469  ute_transformati
-00012fa0: 6f6e 280a 2020 2020 2020 2020 7365 6c66  on(.        self
-00012fb0: 2c20 642c 206b 696e 643d 226d 6167 6e69  , d, kind="magni
-00012fc0: 6669 6361 7469 6f6e 222c 2072 6f74 6174  fication", rotat
-00012fd0: 653d 4661 6c73 652c 2074 6f70 6f67 7261  e=False, topogra
-00012fe0: 7068 793d 5b46 616c 7365 2c20 305d 2c20  phy=[False, 0], 
-00012ff0: 6365 6e74 6572 3d54 7275 650a 2020 2020  center=True.    
-00013000: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-00013010: 2020 2020 2020 2043 6f6d 7075 7465 7320         Computes 
-00013020: 7472 616e 7366 6f72 6d61 7469 6f6e 206d  transformation m
-00013030: 6174 7269 782e 0a20 2020 2020 2020 2044  atrix..        D
-00013040: 6570 656e 6469 6e67 206f 6e20 7468 6520  epending on the 
-00013050: 6b69 6e64 206f 6620 7472 616e 7366 6f72  kind of transfor
-00013060: 6d61 7469 6f6e 2c20 636f 6d70 7574 6573  mation, computes
-00013070: 2065 6974 6865 7220 5253 4d20 6f72 206d   either RSM or m
-00013080: 6167 6e69 6669 6361 7469 6f6e 0a20 2020  agnification.   
-00013090: 2020 2020 2061 7865 7320 746f 2062 6520       axes to be 
-000130a0: 7573 6564 206f 6e20 6675 7475 7265 2077  used on future w
-000130b0: 6964 6765 7473 2e0a 0a20 2020 2020 2020  idgets...       
-000130c0: 203a 7061 7261 6d20 643a 2053 697a 6520   :param d: Size 
-000130d0: 6f66 2074 6865 2070 6978 656c 0a20 2020  of the pixel.   
-000130e0: 2020 2020 203a 7479 7065 2064 3a20 666c       :type d: fl
-000130f0: 6f61 740a 2020 2020 2020 2020 3a70 6172  oat.        :par
-00013100: 616d 206b 696e 643a 2054 7261 6e73 666f  am kind: Transfo
-00013110: 726d 6174 696f 6e20 746f 2061 7070 6c79  rmation to apply
-00013120: 2c20 6569 7468 6572 2027 6d61 676e 6966  , either 'magnif
-00013130: 6963 6174 696f 6e27 206f 7220 2772 736d  ication' or 'rsm
-00013140: 270a 2020 2020 2020 2020 3a74 7970 6520  '.        :type 
-00013150: 6b69 6e64 3a20 7374 720a 2020 2020 2020  kind: str.      
-00013160: 2020 3a70 6172 616d 2072 6f74 6174 653a    :param rotate:
-00013170: 2054 6f20 6265 2075 7365 6420 6f6e 6c79   To be used only
-00013180: 2077 6974 6820 6b69 6e64 3d27 7273 6d27   with kind='rsm'
-00013190: 2c20 6966 2054 7275 6520 7468 6520 696d  , if True the im
-000131a0: 6167 6573 2077 6974 680a 2020 2020 2020  ages with.      
-000131b0: 2020 2020 2020 7472 616e 7366 6f72 6d61        transforma
-000131c0: 7469 6f6e 2061 7265 2072 6f74 6174 6564  tion are rotated
-000131d0: 2039 3020 6465 6772 6565 732e 0a20 2020   90 degrees..   
-000131e0: 2020 2020 203a 7479 7065 2072 6f74 6174       :type rotat
-000131f0: 653a 2062 6f6f 6c0a 2020 2020 2020 2020  e: bool.        
-00013200: 3a70 6172 616d 2074 6f70 6f67 7261 7068  :param topograph
-00013210: 793a 2054 6f20 6265 2075 7365 6420 6f6e  y: To be used on
-00013220: 6c79 2077 6974 6820 6b69 6e64 3d27 6d61  ly with kind='ma
-00013230: 676e 6966 6963 6174 696f 6e27 2c20 6966  gnification', if
-00013240: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
-00013250: 2020 6f62 7069 7463 6820 7661 6c75 6573    obpitch values
-00013260: 2061 7265 2064 6976 6964 6564 2062 7920   are divided by 
-00013270: 6974 7320 7369 6e65 2e0a 2020 2020 2020  its sine..      
-00013280: 2020 3a74 7970 6520 746f 706f 6772 6170    :type topograp
-00013290: 6879 3a20 626f 6f6c 0a20 2020 2020 2020  hy: bool.       
-000132a0: 2022 2222 0a0a 2020 2020 2020 2020 482c   """..        H,
-000132b0: 2057 203d 2073 656c 662e 6765 745f 6461   W = self.get_da
-000132c0: 7461 2830 292e 7368 6170 650a 2020 2020  ta(0).shape.    
-000132d0: 2020 2020 7365 6c66 2e72 6f74 6174 6520      self.rotate 
-000132e0: 3d20 726f 7461 7465 0a0a 2020 2020 2020  = rotate..      
-000132f0: 2020 6966 2073 656c 662e 6469 6d73 2e6e    if self.dims.n
-00013300: 6469 6d20 3d3d 2031 2061 6e64 206b 696e  dim == 1 and kin
-00013310: 6420 3d3d 2022 7273 6d22 3a0a 2020 2020  d == "rsm":.    
-00013320: 2020 2020 2020 2020 6666 7a20 3d20 7365          ffz = se
-00013330: 6c66 2e67 6574 5f6d 6574 6164 6174 615f  lf.get_metadata_
-00013340: 7661 6c75 6573 2850 4f53 4954 494f 4e45  values(POSITIONE
-00013350: 525f 4d45 5441 4441 5441 2c20 2266 667a  R_METADATA, "ffz
-00013360: 2229 5b30 5d0a 2020 2020 2020 2020 2020  ")[0].          
-00013370: 2020 6d61 696e 7820 3d20 2d73 656c 662e    mainx = -self.
-00013380: 6765 745f 6d65 7461 6461 7461 5f76 616c  get_metadata_val
-00013390: 7565 7328 504f 5349 5449 4f4e 4552 5f4d  ues(POSITIONER_M
-000133a0: 4554 4144 4154 412c 2022 6d61 696e 7822  ETADATA, "mainx"
-000133b0: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
-000133c0: 2078 2c20 7920 3d20 636f 6d70 7574 655f   x, y = compute_
-000133d0: 7273 6d28 482c 2057 2c20 642c 2066 667a  rsm(H, W, d, ffz
-000133e0: 2c20 6d61 696e 782c 2072 6f74 6174 6529  , mainx, rotate)
-000133f0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00013400: 2020 2020 2020 2020 2020 206f 6278 203d             obx =
-00013410: 2073 656c 662e 6765 745f 6d65 7461 6461   self.get_metada
-00013420: 7461 5f76 616c 7565 7328 504f 5349 5449  ta_values(POSITI
-00013430: 4f4e 4552 5f4d 4554 4144 4154 412c 2022  ONER_METADATA, "
-00013440: 6f62 7822 295b 305d 0a20 2020 2020 2020  obx")[0].       
-00013450: 2020 2020 206f 6270 6974 6368 203d 206e       obpitch = n
-00013460: 756d 7079 2e75 6e69 7175 6528 0a20 2020  umpy.unique(.   
-00013470: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00013480: 662e 6765 745f 6d65 7461 6461 7461 5f76  f.get_metadata_v
-00013490: 616c 7565 7328 504f 5349 5449 4f4e 4552  alues(POSITIONER
-000134a0: 5f4d 4554 4144 4154 412c 2022 6f62 7069  _METADATA, "obpi
-000134b0: 7463 6822 290a 2020 2020 2020 2020 2020  tch").          
-000134c0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-000134d0: 6f62 7069 7463 6820 3d20 6f62 7069 7463  obpitch = obpitc
-000134e0: 685b 6c65 6e28 6f62 7069 7463 6829 202f  h[len(obpitch) /
-000134f0: 2f20 325d 0a20 2020 2020 2020 2020 2020  / 2].           
-00013500: 206d 6169 6e78 203d 202d 7365 6c66 2e67   mainx = -self.g
-00013510: 6574 5f6d 6574 6164 6174 615f 7661 6c75  et_metadata_valu
-00013520: 6573 2850 4f53 4954 494f 4e45 525f 4d45  es(POSITIONER_ME
-00013530: 5441 4441 5441 2c20 226d 6169 6e78 2229  TADATA, "mainx")
-00013540: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-00013550: 782c 2079 203d 2063 6f6d 7075 7465 5f6d  x, y = compute_m
-00013560: 6167 6e69 6669 6361 7469 6f6e 280a 2020  agnification(.  
-00013570: 2020 2020 2020 2020 2020 2020 2020 482c                H,
-00013580: 2057 2c20 642c 206f 6278 2c20 6f62 7069   W, d, obx, obpi
-00013590: 7463 682c 206d 6169 6e78 2c20 746f 706f  tch, mainx, topo
-000135a0: 6772 6170 6879 2c20 6365 6e74 6572 0a20  graphy, center. 
-000135b0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000135c0: 2020 2020 2073 656c 662e 7472 616e 7366       self.transf
-000135d0: 6f72 6d61 7469 6f6e 203d 2054 7261 6e73  ormation = Trans
-000135e0: 666f 726d 6174 696f 6e28 6b69 6e64 2c20  formation(kind, 
-000135f0: 782c 2079 2c20 726f 7461 7465 290a 0a20  x, y, rotate).. 
-00013600: 2020 2064 6566 2070 726f 6a65 6374 5f64     def project_d
-00013610: 6174 6128 7365 6c66 2c20 6469 6d65 6e73  ata(self, dimens
-00013620: 696f 6e2c 2069 6e64 6963 6573 3d4e 6f6e  ion, indices=Non
-00013630: 652c 205f 6469 723d 4e6f 6e65 293a 0a20  e, _dir=None):. 
-00013640: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00013650: 2020 2041 7070 6c69 6573 2061 2070 726f     Applies a pro
-00013660: 6a65 6374 696f 6e20 746f 2074 6865 2064  jection to the d
-00013670: 6174 612e 0a20 2020 2020 2020 2054 6865  ata..        The
-00013680: 206e 6577 2044 6174 6173 6574 2077 696c   new Dataset wil
-00013690: 6c20 6861 7665 2074 6865 2073 616d 6520  l have the same 
-000136a0: 7369 7a65 2061 7320 7468 6520 6368 6f73  size as the chos
-000136b0: 656e 2064 696d 656e 7369 6f6e 2c20 7768  en dimension, wh
-000136c0: 6572 650a 2020 2020 2020 2020 7468 6520  ere.        the 
-000136d0: 6461 7461 2069 7320 7072 6f6a 6563 7465  data is projecte
-000136e0: 6420 6f6e 2e0a 0a20 2020 2020 2020 203a  d on...        :
-000136f0: 7061 7261 6d20 6469 6d65 6e73 696f 6e3a  param dimension:
-00013700: 2044 696d 656e 7369 6f6e 7320 746f 2070   Dimensions to p
-00013710: 726f 6a65 6374 2074 6865 2064 6174 6120  roject the data 
-00013720: 6f6e 746f 0a20 2020 2020 2020 203a 7479  onto.        :ty
-00013730: 7065 2064 696d 656e 7369 6f6e 3a20 6172  pe dimension: ar
-00013740: 7261 795f 6c69 6b65 0a20 2020 2020 2020  ray_like.       
-00013750: 203a 7061 7261 6d20 696e 6469 6365 733a   :param indices:
-00013760: 2049 6e64 6963 6573 206f 6620 7468 6520   Indices of the 
-00013770: 696d 6167 6573 2074 6f20 7573 6520 666f  images to use fo
-00013780: 7220 7468 6520 7072 6f6a 6563 7469 6f6e  r the projection
-00013790: 2e0a 2020 2020 2020 2020 2020 2020 4966  ..            If
-000137a0: 204e 6f6e 652c 2074 6865 2070 726f 6a65   None, the proje
-000137b0: 6374 696f 6e20 6973 2064 6f6e 6520 7573  ction is done us
-000137c0: 696e 6720 616c 6c20 6461 7461 2e0a 2020  ing all data..  
-000137d0: 2020 2020 2020 3a74 7970 6520 696e 6469        :type indi
-000137e0: 6365 733a 2055 6e69 6f6e 5b4e 6f6e 652c  ces: Union[None,
-000137f0: 2061 7272 6179 5f6c 696b 655d 0a20 2020   array_like].   
-00013800: 2020 2020 203a 7061 7261 6d20 7374 7220       :param str 
-00013810: 5f64 6972 3a20 4469 7265 6374 6f72 7920  _dir: Directory 
-00013820: 6669 6c65 6e61 6d65 2074 6f20 7361 7665  filename to save
-00013830: 2074 6865 206e 6577 2064 6174 610a 2020   the new data.  
-00013840: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
-00013850: 2020 205f 6469 7220 3d20 7365 6c66 2e64     _dir = self.d
-00013860: 6972 2069 6620 5f64 6972 2069 7320 4e6f  ir if _dir is No
-00013870: 6e65 2065 6c73 6520 5f64 6972 0a20 2020  ne else _dir.   
-00013880: 2020 2020 206f 732e 6d61 6b65 6469 7273       os.makedirs
-00013890: 285f 6469 722c 2065 7869 7374 5f6f 6b3d  (_dir, exist_ok=
-000138a0: 5472 7565 290a 0a20 2020 2020 2020 2064  True)..        d
-000138b0: 696d 7320 3d20 4163 7175 6973 6974 696f  ims = Acquisitio
-000138c0: 6e44 696d 7328 290a 2020 2020 2020 2020  nDims().        
-000138d0: 6966 206c 656e 2864 696d 656e 7369 6f6e  if len(dimension
-000138e0: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
-000138f0: 2020 2020 6178 6973 203d 2073 656c 662e      axis = self.
-00013900: 6469 6d73 2e6e 6469 6d20 2d20 6469 6d65  dims.ndim - dime
-00013910: 6e73 696f 6e5b 305d 202d 2031 0a20 2020  nsion[0] - 1.   
-00013920: 2020 2020 2020 2020 2064 696d 203d 2073           dim = s
-00013930: 656c 662e 6469 6d73 2e67 6574 2864 696d  elf.dims.get(dim
-00013940: 656e 7369 6f6e 5b30 5d29 0a20 2020 2020  ension[0]).     
-00013950: 2020 2020 2020 2064 6174 6120 3d20 5b5d         data = []
-00013960: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00013970: 2069 2069 6e20 7261 6e67 6528 6469 6d2e   i in range(dim.
-00013980: 7369 7a65 293a 0a20 2020 2020 2020 2020  size):.         
-00013990: 2020 2020 2020 205f 7375 6d20 3d20 7365         _sum = se
-000139a0: 6c66 2e7a 7375 6d28 696e 6469 6365 733d  lf.zsum(indices=
-000139b0: 696e 6469 6365 732c 2064 696d 656e 7369  indices, dimensi
-000139c0: 6f6e 3d5b 6469 6d65 6e73 696f 6e5b 305d  on=[dimension[0]
-000139d0: 2c20 695d 290a 2020 2020 2020 2020 2020  , i]).          
-000139e0: 2020 2020 2020 6966 206c 656e 285f 7375        if len(_su
-000139f0: 6d29 3a0a 2020 2020 2020 2020 2020 2020  m):.            
-00013a00: 2020 2020 2020 2020 6461 7461 202b 3d20          data += 
-00013a10: 5b5f 7375 6d5d 0a20 2020 2020 2020 2020  [_sum].         
-00013a20: 2020 2064 696d 732e 6164 645f 6469 6d28     dims.add_dim(
-00013a30: 302c 2064 696d 290a 2020 2020 2020 2020  0, dim).        
-00013a40: 656c 6966 206c 656e 2864 696d 656e 7369  elif len(dimensi
-00013a50: 6f6e 2920 3d3d 2032 3a0a 2020 2020 2020  on) == 2:.      
-00013a60: 2020 2020 2020 6178 6973 203d 2069 6e74        axis = int
-00013a70: 286e 756d 7079 2e73 6574 6469 6666 3164  (numpy.setdiff1d
-00013a80: 2872 616e 6765 2873 656c 662e 6469 6d73  (range(self.dims
-00013a90: 2e6e 6469 6d29 2c20 6469 6d65 6e73 696f  .ndim), dimensio
-00013aa0: 6e29 5b30 5d29 0a20 2020 2020 2020 2020  n)[0]).         
-00013ab0: 2020 2064 696d 3120 3d20 7365 6c66 2e64     dim1 = self.d
-00013ac0: 696d 732e 6765 7428 6469 6d65 6e73 696f  ims.get(dimensio
-00013ad0: 6e5b 305d 290a 2020 2020 2020 2020 2020  n[0]).          
-00013ae0: 2020 6469 6d32 203d 2073 656c 662e 6469    dim2 = self.di
-00013af0: 6d73 2e67 6574 2864 696d 656e 7369 6f6e  ms.get(dimension
-00013b00: 5b31 5d29 0a20 2020 2020 2020 2020 2020  [1]).           
-00013b10: 2064 696d 732e 6164 645f 6469 6d28 302c   dims.add_dim(0,
-00013b20: 2064 696d 3129 0a20 2020 2020 2020 2020   dim1).         
-00013b30: 2020 2064 696d 732e 6164 645f 6469 6d28     dims.add_dim(
-00013b40: 312c 2064 696d 3229 0a20 2020 2020 2020  1, dim2).       
-00013b50: 2020 2020 2064 6174 6120 3d20 5b5d 0a20       data = []. 
-00013b60: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-00013b70: 2069 6e20 7261 6e67 6528 6469 6d31 2e73   in range(dim1.s
-00013b80: 697a 6529 3a0a 2020 2020 2020 2020 2020  ize):.          
-00013b90: 2020 2020 2020 666f 7220 6a20 696e 2072        for j in r
-00013ba0: 616e 6765 2864 696d 322e 7369 7a65 293a  ange(dim2.size):
-00013bb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013bc0: 2020 2020 205f 7375 6d20 3d20 7365 6c66       _sum = self
-00013bd0: 2e7a 7375 6d28 696e 6469 6365 733d 696e  .zsum(indices=in
-00013be0: 6469 6365 732c 2064 696d 656e 7369 6f6e  dices, dimension
-00013bf0: 3d5b 6469 6d65 6e73 696f 6e2c 205b 692c  =[dimension, [i,
-00013c00: 206a 5d5d 290a 2020 2020 2020 2020 2020   j]]).          
-00013c10: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-00013c20: 285f 7375 6d29 3a0a 2020 2020 2020 2020  (_sum):.        
-00013c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013c40: 6461 7461 202b 3d20 5b5f 7375 6d5d 0a20  data += [_sum]. 
-00013c50: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00013c60: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00013c70: 5661 6c75 6545 7272 6f72 2822 4f6e 6c79  ValueError("Only
-00013c80: 2031 4420 616e 6420 3244 2070 726f 6a65   1D and 2D proje
-00013c90: 6374 696f 6e20 6973 2061 6c6c 6f77 6564  ction is allowed
-00013ca0: 2229 0a20 2020 2020 2020 2064 696d 203d  ").        dim =
-00013cb0: 2073 656c 662e 6469 6d73 2e67 6574 2861   self.dims.get(a
-00013cc0: 7869 7329 0a20 2020 2020 2020 2064 6174  xis).        dat
-00013cd0: 6120 3d20 6e75 6d70 792e 6172 7261 7928  a = numpy.array(
-00013ce0: 6461 7461 292e 7669 6577 2844 6174 6129  data).view(Data)
-00013cf0: 0a20 2020 2020 2020 206d 6574 6164 6174  .        metadat
-00013d00: 6120 3d20 6e75 6d70 792e 7377 6170 6178  a = numpy.swapax
-00013d10: 6573 2873 656c 662e 6461 7461 2e6d 6574  es(self.data.met
-00013d20: 6164 6174 612c 2073 656c 662e 6469 6d73  adata, self.dims
-00013d30: 2e6e 6469 6d20 2d20 312c 2061 7869 7329  .ndim - 1, axis)
-00013d40: 0a20 2020 2020 2020 2066 6f72 2069 2069  .        for i i
-00013d50: 6e20 7261 6e67 6528 7365 6c66 2e64 696d  n range(self.dim
-00013d60: 732e 6e64 696d 202d 206c 656e 2864 696d  s.ndim - len(dim
-00013d70: 656e 7369 6f6e 2929 3a0a 2020 2020 2020  ension)):.      
-00013d80: 2020 2020 2020 6d65 7461 6461 7461 203d        metadata =
-00013d90: 206d 6574 6164 6174 615b 305d 0a20 2020   metadata[0].   
-00013da0: 2020 2020 2064 6174 612e 7361 7665 280a       data.save(.
-00013db0: 2020 2020 2020 2020 2020 2020 6f73 2e70              os.p
-00013dc0: 6174 682e 6a6f 696e 285f 6469 722c 2022  ath.join(_dir, "
-00013dd0: 7072 6f6a 6563 745f 2220 2b20 6469 6d2e  project_" + dim.
-00013de0: 6e61 6d65 202b 2022 2e68 6466 3522 292c  name + ".hdf5"),
-00013df0: 0a20 2020 2020 2020 2020 2020 2069 6e5f  .            in_
-00013e00: 6d65 6d6f 7279 3d73 656c 662e 5f69 6e5f  memory=self._in_
-00013e10: 6d65 6d6f 7279 2c0a 2020 2020 2020 2020  memory,.        
-00013e20: 290a 2020 2020 2020 2020 6461 7461 2e6d  ).        data.m
-00013e30: 6574 6164 6174 6120 3d20 6d65 7461 6461  etadata = metada
-00013e40: 7461 0a0a 2020 2020 2020 2020 6461 7461  ta..        data
-00013e50: 7365 7420 3d20 4461 7461 7365 7428 0a20  set = Dataset(. 
-00013e60: 2020 2020 2020 2020 2020 205f 6469 723d             _dir=
-00013e70: 5f64 6972 2c0a 2020 2020 2020 2020 2020  _dir,.          
-00013e80: 2020 6461 7461 3d64 6174 612c 0a20 2020    data=data,.   
-00013e90: 2020 2020 2020 2020 2064 696d 733d 6469           dims=di
-00013ea0: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
-00013eb0: 7472 616e 7366 6f72 6d61 7469 6f6e 3d73  transformation=s
-00013ec0: 656c 662e 7472 616e 7366 6f72 6d61 7469  elf.transformati
-00013ed0: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
-00013ee0: 696e 5f6d 656d 6f72 793d 7365 6c66 2e5f  in_memory=self._
-00013ef0: 696e 5f6d 656d 6f72 792c 0a20 2020 2020  in_memory,.     
-00013f00: 2020 2020 2020 2074 6974 6c65 3d73 656c         title=sel
-00013f10: 662e 7469 746c 652c 0a20 2020 2020 2020  f.title,.       
-00013f20: 2029 0a0a 2020 2020 2020 2020 7265 7475   )..        retu
-00013f30: 726e 2064 6174 6173 6574 2e72 6573 6861  rn dataset.resha
-00013f40: 7065 5f64 6174 6128 290a 0a20 2020 2064  pe_data()..    d
-00013f50: 6566 2063 6f6d 7075 7465 5f72 736d 280a  ef compute_rsm(.
-00013f60: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00013f70: 2020 2020 2020 512c 0a20 2020 2020 2020        Q,.       
-00013f80: 2061 2c0a 2020 2020 2020 2020 6d61 705f   a,.        map_
-00013f90: 7261 6e67 652c 0a20 2020 2020 2020 2070  range,.        p
-00013fa0: 6978 656c 5f73 697a 652c 0a20 2020 2020  ixel_size,.     
-00013fb0: 2020 2075 6e69 7473 2c0a 2020 2020 2020     units,.      
-00013fc0: 2020 6e2c 0a20 2020 2020 2020 206d 6170    n,.        map
-00013fd0: 5f73 6861 7065 2c0a 2020 2020 2020 2020  _shape,.        
-00013fe0: 656e 6572 6779 3d31 372c 0a20 2020 2020  energy=17,.     
-00013ff0: 2020 2074 7261 6e73 666f 726d 6174 696f     transformatio
-00014000: 6e3d 4e6f 6e65 2c0a 2020 2020 293a 0a20  n=None,.    ):. 
-00014010: 2020 2020 2020 2064 6966 6672 7920 3d20         diffry = 
-00014020: 7365 6c66 2e67 6574 5f6d 6574 6164 6174  self.get_metadat
-00014030: 615f 7661 6c75 6573 2850 4f53 4954 494f  a_values(POSITIO
-00014040: 4e45 525f 4d45 5441 4441 5441 2c20 2264  NER_METADATA, "d
-00014050: 6966 6672 7922 290a 2020 2020 2020 2020  iffry").        
-00014060: 6966 2074 7261 6e73 666f 726d 6174 696f  if transformatio
-00014070: 6e20 6973 204e 6f6e 6520 616e 6420 7365  n is None and se
-00014080: 6c66 2e74 7261 6e73 666f 726d 6174 696f  lf.transformatio
-00014090: 6e20 6973 206e 6f74 204e 6f6e 653a 0a20  n is not None:. 
-000140a0: 2020 2020 2020 2020 2020 2074 7261 6e73             trans
-000140b0: 666f 726d 6174 696f 6e20 3d20 7365 6c66  formation = self
-000140c0: 2e74 7261 6e73 666f 726d 6174 696f 6e0a  .transformation.
-000140d0: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
-000140e0: 662e 7472 616e 7366 6f72 6d61 7469 6f6e  f.transformation
-000140f0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00014100: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00014110: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
-00014120: 2020 2020 2020 2020 2254 7261 6e73 666f          "Transfo
-00014130: 726d 6174 696f 6e20 6861 7320 746f 2066  rmation has to f
-00014140: 6972 7374 2062 6520 636f 6d70 7574 6564  irst be computed
-00014150: 2075 7369 6e67 2074 6865 2054 7261 6e73   using the Trans
-00014160: 666f 726d 6174 696f 6e20 5769 6467 6574  formation Widget
-00014170: 2028 6265 666f 7265 2061 6e79 2052 4f49   (before any ROI
-00014180: 2922 0a20 2020 2020 2020 2020 2020 2029  )".            )
-00014190: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-000141a0: 2063 616c 6375 6c61 7465 5f52 534d 5f68   calculate_RSM_h
-000141b0: 6973 746f 6772 616d 280a 2020 2020 2020  istogram(.      
-000141c0: 2020 2020 2020 6461 7461 3d73 656c 662e        data=self.
-000141d0: 6765 745f 6461 7461 2829 2c0a 2020 2020  get_data(),.    
-000141e0: 2020 2020 2020 2020 6469 6666 7279 5f76          diffry_v
-000141f0: 616c 7565 733d 6469 6666 7279 2c0a 2020  alues=diffry,.  
-00014200: 2020 2020 2020 2020 2020 7477 6f74 6865            twothe
-00014210: 7461 3d74 7261 6e73 666f 726d 6174 696f  ta=transformatio
-00014220: 6e2e 792c 0a20 2020 2020 2020 2020 2020  n.y,.           
-00014230: 2065 7461 3d74 7261 6e73 666f 726d 6174   eta=transformat
-00014240: 696f 6e2e 782c 0a20 2020 2020 2020 2020  ion.x,.         
-00014250: 2020 2051 3d51 2c0a 2020 2020 2020 2020     Q=Q,.        
-00014260: 2020 2020 613d 612c 0a20 2020 2020 2020      a=a,.       
-00014270: 2020 2020 206d 6170 5f72 616e 6765 3d6d       map_range=m
-00014280: 6170 5f72 616e 6765 2c0a 2020 2020 2020  ap_range,.      
-00014290: 2020 2020 2020 756e 6974 733d 756e 6974        units=unit
-000142a0: 732c 0a20 2020 2020 2020 2020 2020 206d  s,.            m
-000142b0: 6170 5f73 6861 7065 3d6d 6170 5f73 6861  ap_shape=map_sha
-000142c0: 7065 2c0a 2020 2020 2020 2020 2020 2020  pe,.            
-000142d0: 6e3d 6e2c 0a20 2020 2020 2020 2020 2020  n=n,.           
-000142e0: 2045 3d65 6e65 7267 792c 0a20 2020 2020   E=energy,.     
-000142f0: 2020 2029 0a0a 2020 2020 6465 6620 6170     )..    def ap
-00014300: 706c 795f 6269 6e6e 696e 6728 7365 6c66  ply_binning(self
-00014310: 2c20 7363 616c 652c 205f 6469 723d 4e6f  , scale, _dir=No
-00014320: 6e65 293a 0a20 2020 2020 2020 205f 6469  ne):.        _di
-00014330: 7220 3d20 7365 6c66 2e64 6972 2069 6620  r = self.dir if 
-00014340: 5f64 6972 2069 7320 4e6f 6e65 2065 6c73  _dir is None els
-00014350: 6520 5f64 6972 0a20 2020 2020 2020 206f  e _dir.        o
-00014360: 732e 6d61 6b65 6469 7273 285f 6469 722c  s.makedirs(_dir,
-00014370: 2065 7869 7374 5f6f 6b3d 5472 7565 290a   exist_ok=True).
-00014380: 0a20 2020 2020 2020 2064 6174 6120 3d20  .        data = 
-00014390: 7265 7363 616c 655f 6461 7461 2873 656c  rescale_data(sel
-000143a0: 662e 6765 745f 6461 7461 2829 2c20 7363  f.get_data(), sc
-000143b0: 616c 6529 0a20 2020 2020 2020 2073 6861  ale).        sha
-000143c0: 7065 203d 2064 6174 612e 7368 6170 650a  pe = data.shape.
-000143d0: 2020 2020 2020 2020 6461 7461 203d 2064          data = d
-000143e0: 6174 612e 7669 6577 2844 6174 6129 0a20  ata.view(Data). 
-000143f0: 2020 2020 2020 2064 6174 612e 7361 7665         data.save
-00014400: 280a 2020 2020 2020 2020 2020 2020 6f73  (.            os
-00014410: 2e70 6174 682e 6a6f 696e 285f 6469 722c  .path.join(_dir,
-00014420: 2022 6269 6e6e 6564 5f64 6174 612e 6864   "binned_data.hd
-00014430: 6635 2229 2c0a 2020 2020 2020 2020 2020  f5"),.          
-00014440: 2020 696e 5f6d 656d 6f72 793d 7365 6c66    in_memory=self
-00014450: 2e5f 696e 5f6d 656d 6f72 792c 0a20 2020  ._in_memory,.   
-00014460: 2020 2020 2020 2020 206e 6577 5f73 6861           new_sha
-00014470: 7065 3d73 6861 7065 2c0a 2020 2020 2020  pe=shape,.      
-00014480: 2020 290a 2020 2020 2020 2020 6461 7461    ).        data
-00014490: 2e6d 6574 6164 6174 6120 3d20 7365 6c66  .metadata = self
-000144a0: 2e64 6174 612e 6d65 7461 6461 7461 0a20  .data.metadata. 
-000144b0: 2020 2020 2020 2073 6861 7065 203d 206c         shape = l
-000144c0: 6973 7428 7365 6c66 2e64 6174 612e 7368  ist(self.data.sh
-000144d0: 6170 6529 5b3a 2d32 5d0a 2020 2020 2020  ape)[:-2].      
-000144e0: 2020 7368 6170 652e 6170 7065 6e64 2864    shape.append(d
-000144f0: 6174 612e 7368 6170 655b 2d32 5d29 0a20  ata.shape[-2]). 
-00014500: 2020 2020 2020 2073 6861 7065 2e61 7070         shape.app
-00014510: 656e 6428 6461 7461 2e73 6861 7065 5b2d  end(data.shape[-
-00014520: 315d 290a 2020 2020 2020 2020 6461 7461  1]).        data
-00014530: 203d 2064 6174 612e 7265 7368 6170 6528   = data.reshape(
-00014540: 7368 6170 6529 0a0a 2020 2020 2020 2020  shape)..        
-00014550: 7265 7475 726e 2044 6174 6173 6574 280a  return Dataset(.
-00014560: 2020 2020 2020 2020 2020 2020 5f64 6972              _dir
-00014570: 3d5f 6469 722c 0a20 2020 2020 2020 2020  =_dir,.         
-00014580: 2020 2064 6174 613d 6461 7461 2c0a 2020     data=data,.  
-00014590: 2020 2020 2020 2020 2020 6469 6d73 3d73            dims=s
-000145a0: 656c 662e 6469 6d73 2c0a 2020 2020 2020  elf.dims,.      
-000145b0: 2020 2020 2020 7472 616e 7366 6f72 6d61        transforma
-000145c0: 7469 6f6e 3d73 656c 662e 7472 616e 7366  tion=self.transf
-000145d0: 6f72 6d61 7469 6f6e 2c0a 2020 2020 2020  ormation,.      
-000145e0: 2020 2020 2020 696e 5f6d 656d 6f72 793d        in_memory=
-000145f0: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
-00014600: 2020 7469 746c 653d 7365 6c66 2e74 6974    title=self.tit
-00014610: 6c65 2c0a 2020 2020 2020 2020 290a 0a20  le,.        ).. 
-00014620: 2020 2064 6566 2072 6563 6f76 6572 5f77     def recover_w
-00014630: 6561 6b5f 6265 616d 2873 656c 662c 206e  eak_beam(self, n
-00014640: 2c20 696e 6469 6365 733d 4e6f 6e65 293a  , indices=None):
-00014650: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00014660: 2020 2020 2053 6574 2074 6f20 7a65 726f       Set to zero
-00014670: 2061 6c6c 2070 6978 656c 7320 6869 6768   all pixels high
-00014680: 6572 2074 6861 6e20 6e20 7469 6d65 7320  er than n times 
-00014690: 7468 6520 7374 616e 6461 7264 2064 6576  the standard dev
-000146a0: 6961 7469 6f6e 2061 6372 6f73 7320 7468  iation across th
-000146b0: 6520 7374 6163 6b20 6469 6d65 6e73 696f  e stack dimensio
-000146c0: 6e0a 0a20 2020 2020 2020 203a 7061 7261  n..        :para
-000146d0: 6d20 6e3a 2049 6e63 7265 6173 6520 6f72  m n: Increase or
-000146e0: 2064 6563 7265 6173 6520 7468 6520 746f   decrease the to
-000146f0: 7020 7468 7265 7368 6f6c 6420 6279 2074  p threshold by t
-00014700: 6869 7320 6669 7865 6420 7661 6c75 652e  his fixed value.
-00014710: 0a20 2020 2020 2020 203a 7479 7065 206e  .        :type n
-00014720: 3a20 666c 6f61 740a 2020 2020 2020 2020  : float.        
-00014730: 3a70 6172 616d 2069 6e64 6963 6573 3a20  :param indices: 
-00014740: 496e 6469 6365 7320 6f66 2074 6865 2069  Indices of the i
-00014750: 6d61 6765 7320 746f 2075 7365 2066 6f72  mages to use for
-00014760: 2074 6865 2066 696c 7465 7269 6e67 2e0a   the filtering..
-00014770: 2020 2020 2020 2020 2020 2020 4966 204e              If N
-00014780: 6f6e 652c 2074 6865 2066 696c 7465 7269  one, the filteri
-00014790: 6e67 2069 7320 646f 6e65 2075 7369 6e67  ng is done using
-000147a0: 2061 6c6c 2064 6174 612e 0a20 2020 2020   all data..     
-000147b0: 2020 203a 7479 7065 2069 6e64 6963 6573     :type indices
-000147c0: 3a20 556e 696f 6e5b 4e6f 6e65 2c20 6172  : Union[None, ar
-000147d0: 7261 795f 6c69 6b65 5d0a 2020 2020 2020  ray_like].      
-000147e0: 2020 2222 220a 2020 2020 2020 2020 7374    """.        st
-000147f0: 6420 3d20 6e75 6d70 792e 7374 6428 7365  d = numpy.std(se
-00014800: 6c66 2e67 6574 5f64 6174 6128 696e 6469  lf.get_data(indi
-00014810: 6365 7329 2e76 6965 7728 6e75 6d70 792e  ces).view(numpy.
-00014820: 6e64 6172 7261 7929 2c20 6178 6973 3d30  ndarray), axis=0
-00014830: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00014840: 6e20 7365 6c66 2e61 7070 6c79 5f74 6872  n self.apply_thr
-00014850: 6573 686f 6c64 5f72 656d 6f76 616c 2874  eshold_removal(t
-00014860: 6f70 3d6e 202a 2073 7464 2c20 696e 6469  op=n * std, indi
-00014870: 6365 733d 696e 6469 6365 7329 0a0a 2020  ces=indices)..  
-00014880: 2020 6465 6620 5f5f 6465 6570 636f 7079    def __deepcopy
-00014890: 5f5f 2873 656c 662c 206d 656d 6f29 3a0a  __(self, memo):.
-000148a0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000148b0: 2020 2020 4372 6561 7465 2063 6f70 7920      Create copy 
-000148c0: 6f66 2074 6865 2064 6174 6173 6574 2e20  of the dataset. 
-000148d0: 5468 6520 6461 7461 206e 756d 7079 2061  The data numpy a
-000148e0: 7272 6179 2069 7320 616c 736f 2063 6f70  rray is also cop
-000148f0: 6965 6420 7573 696e 670a 2020 2020 2020  ied using.      
-00014900: 2020 6465 6570 2063 6f70 792e 2054 6865    deep copy. The
-00014910: 2072 6573 7420 6f66 2074 6865 2061 7474   rest of the att
-00014920: 7269 6275 7465 7320 6172 6520 7468 6520  ributes are the 
-00014930: 7361 6d65 2e0a 2020 2020 2020 2020 2222  same..        ""
-00014940: 220a 2020 2020 2020 2020 6461 7461 7365  ".        datase
-00014950: 7420 3d20 7479 7065 2873 656c 6629 280a  t = type(self)(.
-00014960: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00014970: 2e64 6972 2c0a 2020 2020 2020 2020 2020  .dir,.          
-00014980: 2020 6461 7461 3d73 656c 662e 6461 7461    data=self.data
-00014990: 2c0a 2020 2020 2020 2020 2020 2020 6469  ,.            di
-000149a0: 6d73 3d73 656c 662e 5f5f 6469 6d73 2c0a  ms=self.__dims,.
-000149b0: 2020 2020 2020 2020 2020 2020 696e 5f6d              in_m
-000149c0: 656d 6f72 793d 7365 6c66 2e69 6e5f 6d65  emory=self.in_me
-000149d0: 6d6f 7279 2c0a 2020 2020 2020 2020 2020  mory,.          
-000149e0: 2020 636f 7079 5f66 696c 6573 3d54 7275    copy_files=Tru
-000149f0: 652c 0a20 2020 2020 2020 2029 0a20 2020  e,.        ).   
-00014a00: 2020 2020 2064 6174 6173 6574 2e64 696d       dataset.dim
-00014a10: 7320 3d20 636f 7079 2e64 6565 7063 6f70  s = copy.deepcop
-00014a20: 7928 7365 6c66 2e5f 5f64 696d 732c 206d  y(self.__dims, m
-00014a30: 656d 6f29 0a20 2020 2020 2020 2072 6574  emo).        ret
-00014a40: 7572 6e20 6461 7461 7365 740a 0a0a 636c  urn dataset...cl
-00014a50: 6173 7320 4461 7461 286e 756d 7079 2e6e  ass Data(numpy.n
-00014a60: 6461 7272 6179 293a 0a20 2020 2022 2222  darray):.    """
-00014a70: 0a20 2020 2043 6c61 7373 2074 6f20 7374  .    Class to st
-00014a80: 7275 6374 7572 6520 7468 6520 6461 7461  ructure the data
-00014a90: 2061 6e64 206c 696e 6b20 6576 6572 7920   and link every 
-00014aa0: 696d 6167 6520 7769 7468 2069 7473 2063  image with its c
-00014ab0: 6f72 7265 7370 6f6e 6469 6e67 2075 726c  orresponding url
-00014ac0: 2061 6e64 0a20 2020 206d 6574 6164 6174   and.    metadat
-00014ad0: 612e 2049 7420 696e 6865 7269 7473 2066  a. It inherits f
-00014ae0: 726f 6d20 6e75 6d70 792e 6e64 6172 7261  rom numpy.ndarra
-00014af0: 7920 616e 6420 4f76 6572 7269 6465 7320  y and Overrides 
-00014b00: 7468 6520 6e65 6365 7373 6172 7920 6d65  the necessary me
-00014b10: 7468 6f64 732c 0a20 2020 2074 616b 696e  thods,.    takin
-00014b20: 6720 696e 746f 2061 6363 6f75 6e74 2074  g into account t
-00014b30: 6865 2060 696e 5f6d 656d 6f72 7960 2061  he `in_memory` a
-00014b40: 7474 7269 6275 7465 2e0a 0a20 2020 203a  ttribute...    :
-00014b50: 7061 7261 6d20 7572 6c73 3a20 4172 7261  param urls: Arra
-00014b60: 7920 7769 7468 2074 6865 2075 726c 7320  y with the urls 
-00014b70: 6f66 2074 6865 2064 6174 610a 2020 2020  of the data.    
-00014b80: 3a74 7970 6520 7572 6c73 3a20 6172 7261  :type urls: arra
-00014b90: 795f 6c69 6b65 0a20 2020 203a 7061 7261  y_like.    :para
-00014ba0: 6d20 6d65 7461 6461 7461 3a20 4172 7261  m metadata: Arra
-00014bb0: 7920 7769 7468 2074 6865 206d 6574 6164  y with the metad
-00014bc0: 6174 6120 6f66 2074 6865 2064 6174 610a  ata of the data.
-00014bd0: 2020 2020 3a74 7970 6520 6d65 7461 6461      :type metada
-00014be0: 7461 3a20 6172 7261 795f 6c69 6b65 0a20  ta: array_like. 
-00014bf0: 2020 203a 7061 7261 6d20 696e 5f6d 656d     :param in_mem
-00014c00: 6f72 793a 2049 6620 5472 7565 2c20 7468  ory: If True, th
-00014c10: 6520 6461 7461 2069 7320 6c6f 6164 6564  e data is loaded
-00014c20: 2069 6e74 6f20 6d65 6d6f 7279 2c20 6465   into memory, de
-00014c30: 6661 756c 7420 5472 7565 0a20 2020 203a  fault True.    :
-00014c40: 7479 7065 2069 6e5f 6d65 6d6f 7279 3a20  type in_memory: 
-00014c50: 626f 6f6c 2c20 6f70 7469 6f6e 616c 0a20  bool, optional. 
-00014c60: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
-00014c70: 5f5f 6e65 775f 5f28 636c 732c 2075 726c  __new__(cls, url
-00014c80: 732c 206d 6574 6164 6174 612c 2069 6e5f  s, metadata, in_
-00014c90: 6d65 6d6f 7279 3d54 7275 652c 2064 6174  memory=True, dat
-00014ca0: 613d 4e6f 6e65 293a 0a20 2020 2020 2020  a=None):.       
-00014cb0: 2075 726c 7320 3d20 6e75 6d70 792e 6173   urls = numpy.as
-00014cc0: 6172 7261 7928 7572 6c73 290a 2020 2020  array(urls).    
-00014cd0: 2020 2020 696d 675f 7368 6170 6520 3d20      img_shape = 
-00014ce0: 4e6f 6e65 0a20 2020 2020 2020 2069 6620  None.        if 
-00014cf0: 696e 5f6d 656d 6f72 793a 0a20 2020 2020  in_memory:.     
-00014d00: 2020 2020 2020 2023 204c 6f61 6420 616c         # Load al
-00014d10: 6c20 696d 6167 6573 2069 6e20 6d65 6d6f  l images in memo
-00014d20: 7279 0a20 2020 2020 2020 2020 2020 2069  ry.            i
-00014d30: 6620 6461 7461 2069 7320 6e6f 7420 4e6f  f data is not No
-00014d40: 6e65 2061 6e64 2075 726c 732e 7368 6170  ne and urls.shap
-00014d50: 6520 213d 2064 6174 612e 7368 6170 655b  e != data.shape[
-00014d60: 3a2d 325d 3a0a 2020 2020 2020 2020 2020  :-2]:.          
-00014d70: 2020 2020 2020 6461 7461 203d 204e 6f6e        data = Non
-00014d80: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
-00014d90: 2064 6174 6120 6973 204e 6f6e 653a 0a20   data is None:. 
-00014da0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-00014db0: 726c 5f73 6861 7065 203d 2075 726c 732e  rl_shape = urls.
-00014dc0: 7368 6170 650a 2020 2020 2020 2020 2020  shape.          
-00014dd0: 2020 2020 2020 7572 6c5f 6964 7873 203d        url_idxs =
-00014de0: 206e 756d 7079 2e75 6e72 6176 656c 5f69   numpy.unravel_i
-00014df0: 6e64 6578 286e 756d 7079 2e61 7261 6e67  ndex(numpy.arang
-00014e00: 6528 7572 6c73 2e73 697a 6529 2c20 7572  e(urls.size), ur
-00014e10: 6c5f 7368 6170 6529 0a20 2020 2020 2020  l_shape).       
-00014e20: 2020 2020 2020 2020 2069 6620 7572 6c73           if urls
-00014e30: 2e73 697a 6520 3d3d 2030 3a0a 2020 2020  .size == 0:.    
-00014e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e50: 6461 7461 203d 206e 756d 7079 2e65 6d70  data = numpy.emp
-00014e60: 7479 2875 726c 5f73 6861 7065 202b 2028  ty(url_shape + (
-00014e70: 302c 2030 2929 0a20 2020 2020 2020 2020  0, 0)).         
-00014e80: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00014e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ea0: 2069 6d67 203d 2075 7469 6c73 2e67 6574   img = utils.get
-00014eb0: 5f64 6174 6128 6e65 7874 2875 726c 732e  _data(next(urls.
-00014ec0: 666c 6174 2929 0a20 2020 2020 2020 2020  flat)).         
-00014ed0: 2020 2020 2020 2020 2020 2064 6174 6120             data 
-00014ee0: 3d20 6e75 6d70 792e 656d 7074 7928 7572  = numpy.empty(ur
-00014ef0: 6c5f 7368 6170 6520 2b20 696d 672e 7368  l_shape + img.sh
-00014f00: 6170 652c 2069 6d67 2e64 7479 7065 290a  ape, img.dtype).
-00014f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f20: 2020 2020 666f 7220 7572 6c2c 202a 7572      for url, *ur
-00014f30: 6c5f 6964 7820 696e 207a 6970 2875 726c  l_idx in zip(url
-00014f40: 732e 666c 6174 2c20 2a75 726c 5f69 6478  s.flat, *url_idx
-00014f50: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-00014f60: 2020 2020 2020 2020 2020 2020 6461 7461              data
-00014f70: 5b74 7570 6c65 2875 726c 5f69 6478 295d  [tuple(url_idx)]
-00014f80: 203d 2075 7469 6c73 2e67 6574 5f64 6174   = utils.get_dat
-00014f90: 6128 7572 6c29 0a20 2020 2020 2020 2020  a(url).         
-00014fa0: 2020 206f 626a 203d 2064 6174 612e 7669     obj = data.vi
-00014fb0: 6577 2863 6c73 290a 2020 2020 2020 2020  ew(cls).        
-00014fc0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00014fd0: 2020 2320 4163 6365 7373 2069 6d61 6765    # Access image
-00014fe0: 206f 6e65 2061 7420 6120 7469 6d65 2075   one at a time u
-00014ff0: 7369 6e67 2075 726c 0a20 2020 2020 2020  sing url.       
-00015000: 2020 2020 206f 626a 203d 2073 7570 6572       obj = super
-00015010: 2829 2e5f 5f6e 6577 5f5f 2863 6c73 2c20  ().__new__(cls, 
-00015020: 7572 6c73 2e73 6861 7065 290a 0a20 2020  urls.shape)..   
-00015030: 2020 2020 206f 626a 2e69 6e5f 6d65 6d6f       obj.in_memo
-00015040: 7279 203d 2069 6e5f 6d65 6d6f 7279 0a20  ry = in_memory. 
-00015050: 2020 2020 2020 206f 626a 2e75 726c 7320         obj.urls 
-00015060: 3d20 7572 6c73 0a20 2020 2020 2020 206f  = urls.        o
-00015070: 626a 2e6d 6574 6164 6174 6120 3d20 6e75  bj.metadata = nu
-00015080: 6d70 792e 6173 6172 7261 7928 6d65 7461  mpy.asarray(meta
-00015090: 6461 7461 290a 2020 2020 2020 2020 6f62  data).        ob
-000150a0: 6a2e 5f66 696c 6520 3d20 4e6f 6e65 0a20  j._file = None. 
-000150b0: 2020 2020 2020 206f 626a 2e5f 696d 675f         obj._img_
-000150c0: 7368 6170 6520 3d20 696d 675f 7368 6170  shape = img_shap
-000150d0: 650a 2020 2020 2020 2020 6f62 6a2e 7374  e.        obj.st
-000150e0: 6174 655f 6f66 5f6f 7065 7261 7469 6f6e  ate_of_operation
-000150f0: 7320 3d20 5f53 7461 7465 4f66 4f70 6572  s = _StateOfOper
-00015100: 6174 696f 6e73 2829 0a0a 2020 2020 2020  ations()..      
-00015110: 2020 7265 7475 726e 206f 626a 0a0a 2020    return obj..  
-00015120: 2020 6465 6620 5f5f 6172 7261 795f 6669    def __array_fi
-00015130: 6e61 6c69 7a65 5f5f 2873 656c 662c 206f  nalize__(self, o
-00015140: 626a 293a 0a20 2020 2020 2020 2069 6620  bj):.        if 
-00015150: 6f62 6a20 6973 204e 6f6e 653a 0a20 2020  obj is None:.   
-00015160: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-00015170: 2020 2020 2020 2020 7365 6c66 2e75 726c          self.url
-00015180: 7320 3d20 6765 7461 7474 7228 6f62 6a2c  s = getattr(obj,
-00015190: 2022 7572 6c73 222c 204e 6f6e 6529 0a20   "urls", None). 
-000151a0: 2020 2020 2020 2073 656c 662e 6d65 7461         self.meta
-000151b0: 6461 7461 203d 2067 6574 6174 7472 286f  data = getattr(o
-000151c0: 626a 2c20 226d 6574 6164 6174 6122 2c20  bj, "metadata", 
-000151d0: 4e6f 6e65 290a 2020 2020 2020 2020 7365  None).        se
-000151e0: 6c66 2e69 6e5f 6d65 6d6f 7279 203d 2067  lf.in_memory = g
-000151f0: 6574 6174 7472 286f 626a 2c20 2269 6e5f  etattr(obj, "in_
-00015200: 6d65 6d6f 7279 222c 204e 6f6e 6529 0a0a  memory", None)..
-00015210: 2020 2020 6465 6620 5f5f 6765 7469 7465      def __getite
-00015220: 6d5f 5f28 7365 6c66 2c20 696e 6469 6365  m__(self, indice
-00015230: 7329 3a0a 2020 2020 2020 2020 2222 220a  s):.        """.
-00015240: 2020 2020 2020 2020 5265 7475 726e 2073          Return s
-00015250: 656c 665b 696e 6469 6365 735d 0a20 2020  elf[indices].   
-00015260: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00015270: 2069 6620 7365 6c66 2e69 6e5f 6d65 6d6f   if self.in_memo
-00015280: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00015290: 6461 7461 203d 2073 7570 6572 2829 2e5f  data = super()._
-000152a0: 5f67 6574 6974 656d 5f5f 2869 6e64 6963  _getitem__(indic
-000152b0: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
-000152c0: 6966 206c 656e 2864 6174 612e 7368 6170  if len(data.shap
-000152d0: 6529 203c 2033 3a0a 2020 2020 2020 2020  e) < 3:.        
-000152e0: 2020 2020 2020 2020 6461 7461 203d 2064          data = d
-000152f0: 6174 612e 7669 6577 286e 756d 7079 2e6e  ata.view(numpy.n
-00015300: 6461 7272 6179 290a 2020 2020 2020 2020  darray).        
-00015310: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00015320: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
-00015330: 6e73 7461 6e63 6528 696e 6469 6365 732c  nstance(indices,
-00015340: 2074 7570 6c65 293a 0a20 2020 2020 2020   tuple):.       
-00015350: 2020 2020 2020 2020 2020 2020 2064 6174               dat
-00015360: 612e 7572 6c73 203d 2073 656c 662e 7572  a.urls = self.ur
-00015370: 6c73 5b69 6e64 6963 6573 5b30 5d5d 0a20  ls[indices[0]]. 
-00015380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015390: 2020 2064 6174 612e 6d65 7461 6461 7461     data.metadata
-000153a0: 203d 2073 656c 662e 6d65 7461 6461 7461   = self.metadata
-000153b0: 5b69 6e64 6963 6573 5b30 5d5d 0a20 2020  [indices[0]].   
-000153c0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-000153d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000153e0: 2020 2020 2020 2064 6174 612e 7572 6c73         data.urls
-000153f0: 203d 2073 656c 662e 7572 6c73 5b69 6e64   = self.urls[ind
-00015400: 6963 6573 5d0a 2020 2020 2020 2020 2020  ices].          
-00015410: 2020 2020 2020 2020 2020 6461 7461 2e6d            data.m
-00015420: 6574 6164 6174 6120 3d20 7365 6c66 2e6d  etadata = self.m
-00015430: 6574 6164 6174 615b 696e 6469 6365 735d  etadata[indices]
-00015440: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00015450: 7572 6e20 6461 7461 0a20 2020 2020 2020  urn data.       
-00015460: 2069 6620 6973 696e 7374 616e 6365 2869   if isinstance(i
-00015470: 6e64 6963 6573 2c20 7475 706c 6529 3a0a  ndices, tuple):.
-00015480: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00015490: 6f74 2069 7369 6e73 7461 6e63 6528 7365  ot isinstance(se
-000154a0: 6c66 2e75 726c 735b 696e 6469 6365 735b  lf.urls[indices[
-000154b0: 305d 5d2c 206e 756d 7079 2e6e 6461 7272  0]], numpy.ndarr
-000154c0: 6179 293a 0a20 2020 2020 2020 2020 2020  ay):.           
-000154d0: 2020 2020 2072 6574 7572 6e20 7574 696c       return util
-000154e0: 732e 6765 745f 6461 7461 2873 656c 662e  s.get_data(self.
-000154f0: 7572 6c73 5b69 6e64 6963 6573 5b30 5d5d  urls[indices[0]]
-00015500: 295b 696e 6469 6365 735b 315d 2c20 696e  )[indices[1], in
-00015510: 6469 6365 735b 325d 5d0a 2020 2020 2020  dices[2]].      
-00015520: 2020 2020 2020 7265 7475 726e 2044 6174        return Dat
-00015530: 6128 7365 6c66 2e75 726c 735b 696e 6469  a(self.urls[indi
-00015540: 6365 735b 305d 5d2c 2073 656c 662e 6d65  ces[0]], self.me
-00015550: 7461 6461 7461 5b69 6e64 6963 6573 5d2c  tadata[indices],
-00015560: 2073 656c 662e 696e 5f6d 656d 6f72 7929   self.in_memory)
-00015570: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00015580: 6973 696e 7374 616e 6365 2873 656c 662e  isinstance(self.
-00015590: 7572 6c73 5b69 6e64 6963 6573 5d2c 206e  urls[indices], n
-000155a0: 756d 7079 2e6e 6461 7272 6179 293a 0a20  umpy.ndarray):. 
-000155b0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000155c0: 6e20 7574 696c 732e 6765 745f 6461 7461  n utils.get_data
-000155d0: 2873 656c 662e 7572 6c73 5b69 6e64 6963  (self.urls[indic
-000155e0: 6573 5d29 0a20 2020 2020 2020 2072 6574  es]).        ret
-000155f0: 7572 6e20 4461 7461 2873 656c 662e 7572  urn Data(self.ur
-00015600: 6c73 5b69 6e64 6963 6573 5d2c 2073 656c  ls[indices], sel
-00015610: 662e 6d65 7461 6461 7461 5b69 6e64 6963  f.metadata[indic
-00015620: 6573 5d2c 2073 656c 662e 696e 5f6d 656d  es], self.in_mem
-00015630: 6f72 7929 0a0a 2020 2020 6465 6620 5f69  ory)..    def _i
-00015640: 7465 725f 6672 616d 6573 2873 656c 6629  ter_frames(self)
-00015650: 202d 3e20 4765 6e65 7261 746f 725b 6e75   -> Generator[nu
-00015660: 6d70 792e 6e64 6172 7261 792c 204e 6f6e  mpy.ndarray, Non
-00015670: 652c 204e 6f6e 655d 3a0a 2020 2020 2020  e, None]:.      
-00015680: 2020 6966 2073 656c 662e 696e 5f6d 656d    if self.in_mem
-00015690: 6f72 793a 0a20 2020 2020 2020 2020 2020  ory:.           
-000156a0: 2066 7368 6170 6520 3d20 2873 656c 662e   fshape = (self.
-000156b0: 6e66 7261 6d65 732c 2920 2b20 7365 6c66  nframes,) + self
-000156c0: 2e66 7261 6d65 5f73 6861 7065 0a20 2020  .frame_shape.   
-000156d0: 2020 2020 2020 2020 2079 6965 6c64 2066           yield f
-000156e0: 726f 6d20 7375 7065 7228 292e 7265 7368  rom super().resh
-000156f0: 6170 6528 6673 6861 7065 290a 2020 2020  ape(fshape).    
-00015700: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00015710: 2020 2020 2020 666f 7220 7572 6c20 696e        for url in
-00015720: 2073 656c 662e 7572 6c73 2e66 6c61 7474   self.urls.flatt
-00015730: 656e 2829 3a0a 2020 2020 2020 2020 2020  en():.          
-00015740: 2020 2020 2020 7969 656c 6420 7574 696c        yield util
-00015750: 732e 6765 745f 6461 7461 2875 726c 290a  s.get_data(url).
-00015760: 0a20 2020 2064 6566 205f 5f72 6564 7563  .    def __reduc
-00015770: 655f 5f28 7365 6c66 293a 0a20 2020 2020  e__(self):.     
-00015780: 2020 2023 2047 6574 2074 6865 2070 6172     # Get the par
-00015790: 656e 7427 7320 5f5f 7265 6475 6365 5f5f  ent's __reduce__
-000157a0: 2074 7570 6c65 0a20 2020 2020 2020 2070   tuple.        p
-000157b0: 6963 6b6c 6564 5f73 7461 7465 203d 2073  ickled_state = s
-000157c0: 7570 6572 2829 2e5f 5f72 6564 7563 655f  uper().__reduce_
-000157d0: 5f28 290a 2020 2020 2020 2020 2320 4372  _().        # Cr
-000157e0: 6561 7465 206f 7572 206f 776e 2074 7570  eate our own tup
-000157f0: 6c65 2074 6f20 7061 7373 2074 6f20 5f5f  le to pass to __
-00015800: 7365 7473 7461 7465 5f5f 0a20 2020 2020  setstate__.     
-00015810: 2020 206e 6577 5f73 7461 7465 203d 2070     new_state = p
-00015820: 6963 6b6c 6564 5f73 7461 7465 5b32 5d20  ickled_state[2] 
-00015830: 2b20 2828 7365 6c66 2e75 726c 732c 2073  + ((self.urls, s
-00015840: 656c 662e 6d65 7461 6461 7461 2c20 7365  elf.metadata, se
-00015850: 6c66 2e69 6e5f 6d65 6d6f 7279 292c 290a  lf.in_memory),).
-00015860: 2020 2020 2020 2020 2320 5265 7475 726e          # Return
-00015870: 2061 2074 7570 6c65 2074 6861 7420 7265   a tuple that re
-00015880: 706c 6163 6573 2074 6865 2070 6172 656e  places the paren
-00015890: 7427 7320 5f5f 7365 7473 7461 7465 5f5f  t's __setstate__
-000158a0: 2074 7570 6c65 2077 6974 6820 6f75 7220   tuple with our 
-000158b0: 6f77 6e0a 2020 2020 2020 2020 7265 7475  own.        retu
-000158c0: 726e 2028 7069 636b 6c65 645f 7374 6174  rn (pickled_stat
-000158d0: 655b 305d 2c20 7069 636b 6c65 645f 7374  e[0], pickled_st
-000158e0: 6174 655b 315d 2c20 6e65 775f 7374 6174  ate[1], new_stat
-000158f0: 6529 0a0a 2020 2020 6465 6620 5f5f 7365  e)..    def __se
-00015900: 7473 7461 7465 5f5f 2873 656c 662c 2073  tstate__(self, s
-00015910: 7461 7465 293a 0a20 2020 2020 2020 2073  tate):.        s
-00015920: 656c 662e 7572 6c73 2c20 7365 6c66 2e6d  elf.urls, self.m
-00015930: 6574 6164 6174 612c 2073 656c 662e 696e  etadata, self.in
-00015940: 5f6d 656d 6f72 7920 3d20 7374 6174 655b  _memory = state[
-00015950: 2d31 5d20 2023 2053 6574 2074 6865 2061  -1]  # Set the a
-00015960: 7474 7269 6275 7465 730a 2020 2020 2020  ttributes.      
-00015970: 2020 7375 7065 7228 292e 5f5f 7365 7473    super().__sets
-00015980: 7461 7465 5f5f 2873 7461 7465 5b30 3a2d  tate__(state[0:-
-00015990: 315d 290a 0a20 2020 2064 6566 2073 746f  1])..    def sto
-000159a0: 705f 6f70 6572 6174 696f 6e28 7365 6c66  p_operation(self
-000159b0: 2c20 6f70 6572 6174 696f 6e3a 204f 7065  , operation: Ope
-000159c0: 7261 7469 6f6e 293a 0a20 2020 2020 2020  ration):.       
-000159d0: 2022 2222 0a20 2020 2020 2020 204d 6574   """.        Met
-000159e0: 686f 6420 7573 6564 2066 6f72 2063 6173  hod used for cas
-000159f0: 6573 2077 6865 7265 2074 6872 6561 6473  es where threads
-00015a00: 2061 7265 2063 7265 6174 6564 2074 6f20   are created to 
-00015a10: 6170 706c 7920 6675 6e63 7469 6f6e 7320  apply functions 
-00015a20: 746f 2074 6865 2064 6174 612e 0a20 2020  to the data..   
-00015a30: 2020 2020 2049 6620 6d65 7468 6f64 2069       If method i
-00015a40: 7320 6361 6c6c 6564 2c20 7468 6520 666c  s called, the fl
-00015a50: 6167 2063 6f6e 6365 726e 696e 6720 7468  ag concerning th
-00015a60: 6520 7374 6f70 2069 7320 7365 7420 746f  e stop is set to
-00015a70: 2030 2073 6f20 7468 6174 2069 6620 7468   0 so that if th
-00015a80: 6520 636f 6e63 6572 6e65 640a 2020 2020  e concerned.    
-00015a90: 2020 2020 6f70 6572 6174 696f 6e20 6973      operation is
-00015aa0: 2072 756e 6e69 6e67 2069 6e20 616e 6f74   running in anot
-00015ab0: 6865 7220 7468 7265 6164 2069 7420 6b6e  her thread it kn
-00015ac0: 6f77 7320 746f 2073 746f 702e 0a0a 2020  ows to stop...  
-00015ad0: 2020 2020 2020 3a70 6172 616d 2069 6e74        :param int
-00015ae0: 206f 7065 7261 7469 6f6e 3a20 6f70 6572   operation: oper
-00015af0: 6174 696f 6e20 746f 2073 746f 700a 2020  ation to stop.  
-00015b00: 2020 2020 2020 3a74 7970 6520 696e 743a        :type int:
-00015b10: 2055 6e69 6f6e 5b69 6e74 2c20 604f 7065   Union[int, `Ope
-00015b20: 7261 7469 6f6e 605d 0a20 2020 2020 2020  ration`].       
-00015b30: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
-00015b40: 6861 7361 7474 7228 7365 6c66 2c20 2273  hasattr(self, "s
-00015b50: 7461 7465 5f6f 665f 6f70 6572 6174 696f  tate_of_operatio
-00015b60: 6e73 2229 2061 6e64 2073 656c 662e 7374  ns") and self.st
-00015b70: 6174 655f 6f66 5f6f 7065 7261 7469 6f6e  ate_of_operation
-00015b80: 732e 6973 5f72 756e 6e69 6e67 280a 2020  s.is_running(.  
-00015b90: 2020 2020 2020 2020 2020 6f70 6572 6174            operat
-00015ba0: 696f 6e0a 2020 2020 2020 2020 293a 0a20  ion.        ):. 
-00015bb0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00015bc0: 7374 6174 655f 6f66 5f6f 7065 7261 7469  state_of_operati
-00015bd0: 6f6e 732e 7374 6f70 286f 7065 7261 7469  ons.stop(operati
-00015be0: 6f6e 290a 0a20 2020 2040 7072 6f70 6572  on)..    @proper
-00015bf0: 7479 0a20 2020 2064 6566 2073 6861 7065  ty.    def shape
-00015c00: 2873 656c 6629 202d 3e20 5475 706c 655b  (self) -> Tuple[
-00015c10: 696e 745d 3a0a 2020 2020 2020 2020 2222  int]:.        ""
-00015c20: 2254 6f74 616c 2073 6861 7065 203d 2073  "Total shape = s
-00015c30: 6361 6e20 7368 6170 6520 2b20 6672 616d  can shape + fram
-00015c40: 6520 7368 6170 6522 2222 0a20 2020 2020  e shape""".     
-00015c50: 2020 2073 6861 7065 203d 2073 7570 6572     shape = super
-00015c60: 2829 2e73 6861 7065 0a20 2020 2020 2020  ().shape.       
-00015c70: 2069 6620 7365 6c66 2e69 6e5f 6d65 6d6f   if self.in_memo
-00015c80: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00015c90: 7265 7475 726e 2073 6861 7065 0a20 2020  return shape.   
-00015ca0: 2020 2020 2072 6574 7572 6e20 7368 6170       return shap
-00015cb0: 6520 2b20 7365 6c66 2e66 7261 6d65 5f73  e + self.frame_s
-00015cc0: 6861 7065 0a0a 2020 2020 4070 726f 7065  hape..    @prope
-00015cd0: 7274 790a 2020 2020 6465 6620 7363 616e  rty.    def scan
-00015ce0: 5f73 6861 7065 2873 656c 6629 202d 3e20  _shape(self) -> 
-00015cf0: 5475 706c 655b 696e 745d 3a0a 2020 2020  Tuple[int]:.    
-00015d00: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-00015d10: 7368 6170 655b 3a2d 325d 0a0a 2020 2020  shape[:-2]..    
-00015d20: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
-00015d30: 6620 6672 616d 655f 7368 6170 6528 7365  f frame_shape(se
-00015d40: 6c66 2920 2d3e 2054 7570 6c65 5b69 6e74  lf) -> Tuple[int
-00015d50: 2c20 696e 745d 3a0a 2020 2020 2020 2020  , int]:.        
-00015d60: 6966 2073 656c 662e 696e 5f6d 656d 6f72  if self.in_memor
-00015d70: 793a 0a20 2020 2020 2020 2020 2020 2072  y:.            r
-00015d80: 6574 7572 6e20 7375 7065 7228 292e 7368  eturn super().sh
-00015d90: 6170 655b 2d32 3a5d 0a20 2020 2020 2020  ape[-2:].       
-00015da0: 2069 6620 7365 6c66 2e5f 696d 675f 7368   if self._img_sh
-00015db0: 6170 6520 6973 206e 6f74 204e 6f6e 653a  ape is not None:
-00015dc0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00015dd0: 7572 6e20 7365 6c66 2e5f 696d 675f 7368  urn self._img_sh
-00015de0: 6170 650a 2020 2020 2020 2020 6966 2073  ape.        if s
-00015df0: 656c 662e 6e66 7261 6d65 7320 3d3d 2030  elf.nframes == 0
-00015e00: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00015e10: 7475 726e 2030 2c20 300a 2020 2020 2020  turn 0, 0.      
-00015e20: 2020 696d 675f 7368 6170 6520 3d20 7574    img_shape = ut
-00015e30: 696c 732e 6765 745f 6461 7461 286e 6578  ils.get_data(nex
-00015e40: 7428 7365 6c66 2e75 726c 732e 666c 6174  t(self.urls.flat
-00015e50: 2929 2e73 6861 7065 0a20 2020 2020 2020  )).shape.       
-00015e60: 2073 656c 662e 5f69 6d67 5f73 6861 7065   self._img_shape
-00015e70: 203d 2069 6d67 5f73 6861 7065 0a20 2020   = img_shape.   
-00015e80: 2020 2020 2072 6574 7572 6e20 696d 675f       return img_
-00015e90: 7368 6170 650a 0a20 2020 2040 7072 6f70  shape..    @prop
-00015ea0: 6572 7479 0a20 2020 2064 6566 206e 6672  erty.    def nfr
-00015eb0: 616d 6573 2873 656c 6629 202d 3e20 696e  ames(self) -> in
-00015ec0: 743a 0a20 2020 2020 2020 2069 6620 7365  t:.        if se
-00015ed0: 6c66 2e75 726c 7320 6973 204e 6f6e 653a  lf.urls is None:
-00015ee0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00015ef0: 7572 6e20 300a 2020 2020 2020 2020 7265  urn 0.        re
-00015f00: 7475 726e 2073 656c 662e 7572 6c73 2e73  turn self.urls.s
-00015f10: 697a 650a 0a20 2020 2040 7072 6f70 6572  ize..    @proper
-00015f20: 7479 0a20 2020 2064 6566 206e 6469 6d28  ty.    def ndim(
-00015f30: 7365 6c66 2920 2d3e 2069 6e74 3a0a 2020  self) -> int:.  
-00015f40: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00015f50: 2020 4e75 6d62 6572 206f 6620 6172 7261    Number of arra
-00015f60: 7920 6469 6d65 6e73 696f 6e73 2e0a 2020  y dimensions..  
-00015f70: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00015f80: 2020 6966 2073 656c 662e 696e 5f6d 656d    if self.in_mem
-00015f90: 6f72 793a 0a20 2020 2020 2020 2020 2020  ory:.           
-00015fa0: 2072 6574 7572 6e20 7375 7065 7228 292e   return super().
-00015fb0: 6e64 696d 0a20 2020 2020 2020 2072 6574  ndim.        ret
-00015fc0: 7572 6e20 7375 7065 7228 292e 6e64 696d  urn super().ndim
-00015fd0: 202b 2032 0a0a 2020 2020 6465 6620 6170   + 2..    def ap
-00015fe0: 706c 795f 6675 6e63 7328 0a20 2020 2020  ply_funcs(.     
-00015ff0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00016000: 2066 756e 6373 3d5b 5d2c 0a20 2020 2020   funcs=[],.     
-00016010: 2020 2069 6e64 6963 6573 3d4e 6f6e 652c     indices=None,
-00016020: 0a20 2020 2020 2020 2073 6176 653d 4661  .        save=Fa
-00016030: 6c73 652c 0a20 2020 2020 2020 2074 6578  lse,.        tex
-00016040: 743d 2222 2c0a 2020 2020 2020 2020 6f70  t="",.        op
-00016050: 6572 6174 696f 6e3d 4e6f 6e65 2c0a 2020  eration=None,.  
-00016060: 2020 2020 2020 6e65 775f 7368 6170 653d        new_shape=
-00016070: 4e6f 6e65 2c0a 2020 2020 293a 0a20 2020  None,.    ):.   
-00016080: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00016090: 204d 6574 686f 6420 7468 6174 2061 7070   Method that app
-000160a0: 6c69 6573 2061 2073 6572 6965 7320 6f66  lies a series of
-000160b0: 2066 756e 6374 696f 6e73 2069 6e74 6f20   functions into 
-000160c0: 7468 6520 6461 7461 2e20 4974 2063 616e  the data. It can
-000160d0: 2073 6176 6520 7468 6520 696d 6167 6573   save the images
-000160e0: 0a20 2020 2020 2020 2069 6e74 6f20 6469  .        into di
-000160f0: 736b 206f 7220 7265 7475 726e 2074 6865  sk or return the
-00016100: 6d2e 0a0a 2020 2020 2020 2020 3a70 6172  m...        :par
-00016110: 616d 2066 756e 6373 3a20 4c69 7374 206f  am funcs: List o
-00016120: 6620 7475 7070 6c65 732e 2045 7665 7279  f tupples. Every
-00016130: 2074 7570 706c 6573 2063 6f6e 7461 696e   tupples contain
-00016140: 7320 7468 6520 6675 6e63 7469 6f6e 2074  s the function t
-00016150: 6f0a 2020 2020 2020 2020 2020 2020 6170  o.            ap
-00016160: 706c 7920 616e 6420 6974 7320 7061 7261  ply and its para
-00016170: 6d65 7465 7273 2c20 6465 6661 756c 7473  meters, defaults
-00016180: 2074 6f20 5b5d 0a20 2020 2020 2020 203a   to [].        :
-00016190: 7479 7065 2066 756e 6373 3a20 6172 7261  type funcs: arra
-000161a0: 795f 6c69 6b65 2c20 6f70 7469 6f6e 616c  y_like, optional
-000161b0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-000161c0: 696e 6469 6365 733a 2049 6e64 6963 6573  indices: Indices
-000161d0: 206f 6620 7468 6520 6461 7461 2074 6f20   of the data to 
-000161e0: 6170 706c 7920 7468 6520 6675 6e63 7469  apply the functi
-000161f0: 6f6e 7320 746f 2c0a 2020 2020 2020 2020  ons to,.        
-00016200: 2020 2020 6465 6661 756c 7473 2074 6f20      defaults to 
-00016210: 4e6f 6e65 0a20 2020 2020 2020 203a 7479  None.        :ty
-00016220: 7065 2069 6e64 6963 6573 3a20 556e 696f  pe indices: Unio
-00016230: 6e5b 4e6f 6e65 2c20 6172 7261 795f 6c69  n[None, array_li
-00016240: 6b65 5d2c 206f 7074 696f 6e61 6c0a 2020  ke], optional.  
-00016250: 2020 2020 2020 3a70 6172 616d 2073 6176        :param sav
-00016260: 653a 2049 6620 5472 7565 2c20 7361 7665  e: If True, save
-00016270: 7320 7468 6520 696d 6167 6573 2069 6e74  s the images int
-00016280: 6f20 6469 736b 2c20 6465 6661 756c 7473  o disk, defaults
-00016290: 2074 6f20 4661 6c73 650a 2020 2020 2020   to False.      
-000162a0: 2020 3a74 7970 6520 7361 7665 3a20 626f    :type save: bo
-000162b0: 6f6c 0a20 2020 2020 2020 203a 7061 7261  ol.        :para
-000162c0: 6d20 7374 7220 7465 7874 3a20 5465 7874  m str text: Text
-000162d0: 2074 6f20 7368 6f77 2069 6e20 7468 6520   to show in the 
-000162e0: 6164 7661 6e63 656d 656e 7420 6469 7370  advancement disp
-000162f0: 6c61 792e 0a20 2020 2020 2020 203a 7061  lay..        :pa
-00016300: 7261 6d20 696e 7420 6f70 6572 6174 696f  ram int operatio
-00016310: 6e3a 206f 7065 7261 7469 6f6e 2074 6f20  n: operation to 
-00016320: 7374 6f70 0a20 2020 2020 2020 203a 7479  stop.        :ty
-00016330: 7065 2069 6e74 3a20 556e 696f 6e5b 696e  pe int: Union[in
-00016340: 742c 2060 4f70 6572 6174 696f 6e60 5d0a  t, `Operation`].
-00016350: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-00016360: 733a 2041 7272 6179 2077 6974 6820 7468  s: Array with th
-00016370: 6520 6e65 7720 7572 6c73 2028 6966 2064  e new urls (if d
-00016380: 6174 6120 7761 7320 7361 7665 6429 0a20  ata was saved). 
-00016390: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000163a0: 2020 2069 6620 696e 6469 6365 7320 6973     if indices is
-000163b0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000163c0: 2020 2069 6e64 6963 6573 203d 2072 616e     indices = ran
-000163d0: 6765 286c 656e 2873 656c 6629 290a 2020  ge(len(self)).  
-000163e0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-000163f0: 6e63 6528 696e 6469 6365 732c 2069 6e74  nce(indices, int
-00016400: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-00016410: 6e64 6963 6573 203d 205b 696e 6469 6365  ndices = [indice
-00016420: 735d 0a20 2020 2020 2020 2075 726c 7320  s].        urls 
-00016430: 3d20 5b5d 0a20 2020 2020 2020 2069 6f5f  = [].        io_
-00016440: 7574 696c 732e 6164 7661 6e63 656d 656e  utils.advancemen
-00016450: 745f 6469 7370 6c61 7928 302c 2073 656c  t_display(0, sel
-00016460: 662e 6e66 7261 6d65 732c 2074 6578 7429  f.nframes, text)
-00016470: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-00016480: 2068 6173 6174 7472 2873 656c 662c 2022   hasattr(self, "
-00016490: 7374 6174 655f 6f66 5f6f 7065 7261 7469  state_of_operati
-000164a0: 6f6e 7322 293a 0a20 2020 2020 2020 2020  ons"):.         
-000164b0: 2020 2073 656c 662e 7374 6174 655f 6f66     self.state_of
-000164c0: 5f6f 7065 7261 7469 6f6e 7320 3d20 5f53  _operations = _S
-000164d0: 7461 7465 4f66 4f70 6572 6174 696f 6e73  tateOfOperations
-000164e0: 2829 0a0a 2020 2020 2020 2020 7769 7468  ()..        with
-000164f0: 2073 656c 662e 7374 6174 655f 6f66 5f6f   self.state_of_o
-00016500: 7065 7261 7469 6f6e 732e 7275 6e5f 636f  perations.run_co
-00016510: 6e74 6578 7428 6f70 6572 6174 696f 6e29  ntext(operation)
-00016520: 3a0a 2020 2020 2020 2020 2020 2020 5f66  :.            _f
-00016530: 696c 6520 3d20 4e6f 6e65 0a20 2020 2020  ile = None.     
-00016540: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00016550: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00016560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016570: 2020 2020 205f 6669 6c65 203d 2068 3570       _file = h5p
-00016580: 792e 4669 6c65 2873 6176 652c 2022 6122  y.File(save, "a"
-00016590: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000165a0: 2020 6578 6365 7074 204f 5345 7272 6f72    except OSError
-000165b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000165c0: 2020 2020 2020 6966 206f 732e 7061 7468        if os.path
-000165d0: 2e65 7869 7374 7328 7361 7665 293a 0a20  .exists(save):. 
-000165e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000165f0: 2020 2020 2020 206f 732e 7265 6d6f 7665         os.remove
-00016600: 2873 6176 6529 0a20 2020 2020 2020 2020  (save).         
-00016610: 2020 2020 2020 2020 2020 205f 6669 6c65             _file
-00016620: 203d 2068 3570 792e 4669 6c65 2873 6176   = h5py.File(sav
-00016630: 652c 2022 7722 290a 0a20 2020 2020 2020  e, "w")..       
-00016640: 2020 2020 2020 2020 2064 6174 6173 6574           dataset
-00016650: 5f6e 616d 6520 3d20 2264 6174 6173 6574  _name = "dataset
-00016660: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00016670: 2020 6e65 775f 7368 6170 6520 3d20 7365    new_shape = se
-00016680: 6c66 2e73 6861 7065 2069 6620 6e65 775f  lf.shape if new_
-00016690: 7368 6170 6520 6973 204e 6f6e 6520 656c  shape is None el
-000166a0: 7365 2074 7570 6c65 286e 6577 5f73 6861  se tuple(new_sha
-000166b0: 7065 290a 2020 2020 2020 2020 2020 2020  pe).            
-000166c0: 2020 2020 6966 2022 6461 7461 7365 7422      if "dataset"
-000166d0: 2069 6e20 5f66 696c 653a 0a20 2020 2020   in _file:.     
-000166e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000166f0: 6620 6e65 775f 7368 6170 6520 213d 205f  f new_shape != _
-00016700: 6669 6c65 5b22 6461 7461 7365 7422 5d2e  file["dataset"].
-00016710: 7368 6170 653a 0a20 2020 2020 2020 2020  shape:.         
-00016720: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-00016730: 6669 6c65 2e63 7265 6174 655f 6461 7461  file.create_data
-00016740: 7365 7428 0a20 2020 2020 2020 2020 2020  set(.           
-00016750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016760: 2022 7570 6461 7465 5f64 6174 6173 6574   "update_dataset
-00016770: 222c 206e 6577 5f73 6861 7065 2c20 6474  ", new_shape, dt
-00016780: 7970 653d 7365 6c66 2e64 7479 7065 0a20  ype=self.dtype. 
-00016790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000167a0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000167b0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-000167c0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000167d0: 2020 2020 2020 2020 2020 205f 6669 6c65             _file
-000167e0: 2e63 7265 6174 655f 6461 7461 7365 7428  .create_dataset(
-000167f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016800: 2020 2020 2020 2020 2020 2020 2022 7570               "up
-00016810: 6461 7465 5f64 6174 6173 6574 222c 0a20  date_dataset",. 
-00016820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016830: 2020 2020 2020 2020 2020 2073 6861 7065             shape
-00016840: 3d5f 6669 6c65 5b22 6461 7461 7365 7422  =_file["dataset"
-00016850: 5d2e 7368 6170 652c 0a20 2020 2020 2020  ].shape,.       
-00016860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016870: 2020 2020 2064 7479 7065 3d5f 6669 6c65       dtype=_file
-00016880: 5b22 6461 7461 7365 7422 5d2e 6474 7970  ["dataset"].dtyp
-00016890: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-000168a0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000168b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000168c0: 2020 2020 2066 6f72 2069 2c20 696d 6720       for i, img 
-000168d0: 696e 2065 6e75 6d65 7261 7465 285f 6669  in enumerate(_fi
-000168e0: 6c65 5b22 6461 7461 7365 7422 5d29 3a0a  le["dataset"]):.
-000168f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016900: 2020 2020 2020 2020 2020 2020 5f66 696c              _fil
-00016910: 655b 2275 7064 6174 655f 6461 7461 7365  e["update_datase
-00016920: 7422 5d5b 695d 203d 2069 6d67 0a20 2020  t"][i] = img.   
-00016930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016940: 2064 6174 6173 6574 5f6e 616d 6520 3d20   dataset_name = 
-00016950: 2275 7064 6174 655f 6461 7461 7365 7422  "update_dataset"
-00016960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016970: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00016980: 2020 2020 2020 2020 2020 205f 6669 6c65             _file
-00016990: 2e63 7265 6174 655f 6461 7461 7365 7428  .create_dataset(
-000169a0: 2264 6174 6173 6574 222c 206e 6577 5f73  "dataset", new_s
-000169b0: 6861 7065 2c20 6474 7970 653d 7365 6c66  hape, dtype=self
-000169c0: 2e64 7479 7065 290a 0a20 2020 2020 2020  .dtype)..       
-000169d0: 2020 2020 2020 2020 2066 6f72 2069 2069           for i i
-000169e0: 6e20 696e 6469 6365 733a 0a20 2020 2020  n indices:.     
-000169f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00016a00: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
-00016a10: 2020 2020 2020 2020 2020 2020 6f70 6572              oper
-00016a20: 6174 696f 6e20 6973 206e 6f74 204e 6f6e  ation is not Non
-00016a30: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00016a40: 2020 2020 2020 2020 2020 616e 6420 6e6f            and no
-00016a50: 7420 7365 6c66 2e73 7461 7465 5f6f 665f  t self.state_of_
-00016a60: 6f70 6572 6174 696f 6e73 2e69 735f 7275  operations.is_ru
-00016a70: 6e6e 696e 6728 6f70 6572 6174 696f 6e29  nning(operation)
-00016a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016a90: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
-00016aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ab0: 6966 2022 7570 6461 7465 5f64 6174 6173  if "update_datas
-00016ac0: 6574 2220 696e 205f 6669 6c65 3a0a 2020  et" in _file:.  
-00016ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ae0: 2020 2020 2020 2020 2020 6465 6c20 5f66            del _f
-00016af0: 696c 655b 2275 7064 6174 655f 6461 7461  ile["update_data
-00016b00: 7365 7422 5d0a 2020 2020 2020 2020 2020  set"].          
-00016b10: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00016b20: 7475 726e 0a20 2020 2020 2020 2020 2020  turn.           
-00016b30: 2020 2020 2020 2020 2023 2020 2020 2069           #     i
-00016b40: 6620 7361 7665 3a0a 2020 2020 2020 2020  f save:.        
-00016b50: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-00016b60: 2020 2020 2020 666f 7220 6a20 696e 2069        for j in i
-00016b70: 6e64 6963 6573 3a0a 2020 2020 2020 2020  ndices:.        
-00016b80: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-00016b90: 2020 2020 2020 2020 2020 6966 206a 2021            if j !
-00016ba0: 3d20 693a 0a20 2020 2020 2020 2020 2020  = i:.           
-00016bb0: 2020 2020 2020 2020 2023 2020 2020 2020           #      
-00016bc0: 2020 2020 2020 2020 2020 2066 696c 656e             filen
-00016bd0: 616d 6520 3d20 7361 7665 202b 2073 7472  ame = save + str
-00016be0: 286a 292e 7a66 696c 6c28 3429 202b 2022  (j).zfill(4) + "
-00016bf0: 2e6e 7079 220a 2020 2020 2020 2020 2020  .npy".          
-00016c00: 2020 2020 2020 2020 2020 2320 2020 2020            #     
-00016c10: 2020 2020 2020 2020 2020 2020 6f73 2e72              os.r
-00016c20: 656d 6f76 6528 6669 6c65 6e61 6d65 290a  emove(filename).
-00016c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016c40: 2020 2020 2320 2020 2020 2020 2020 2020      #           
-00016c50: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00016c60: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-00016c70: 2020 2020 2020 2020 2020 2020 2020 6272                br
-00016c80: 6561 6b0a 2020 2020 2020 2020 2020 2020  eak.            
-00016c90: 2020 2020 2020 2020 2320 2020 2020 7265          #     re
-00016ca0: 7475 726e 0a20 2020 2020 2020 2020 2020  turn.           
-00016cb0: 2020 2020 2020 2020 2069 6d67 203d 2073           img = s
-00016cc0: 656c 665b 696e 7428 6929 5d0a 2020 2020  elf[int(i)].    
-00016cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ce0: 666f 7220 662c 2061 7267 7320 696e 2066  for f, args in f
-00016cf0: 756e 6373 3a0a 2020 2020 2020 2020 2020  uncs:.          
-00016d00: 2020 2020 2020 2020 2020 2020 2020 696d                im
-00016d10: 6720 3d20 6628 2a28 5b69 6d67 5d20 2b20  g = f(*([img] + 
-00016d20: 6172 6773 2929 0a20 2020 2020 2020 2020  args)).         
-00016d30: 2020 2020 2020 2020 2020 2069 6620 7361             if sa
-00016d40: 7665 3a0a 2020 2020 2020 2020 2020 2020  ve:.            
-00016d50: 2020 2020 2020 2020 2020 2020 5f66 696c              _fil
-00016d60: 655b 6461 7461 7365 745f 6e61 6d65 5d5b  e[dataset_name][
-00016d70: 695d 203d 2069 6d67 0a20 2020 2020 2020  i] = img.       
-00016d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d90: 2075 726c 732e 6170 7065 6e64 280a 2020   urls.append(.  
-00016da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016db0: 2020 2020 2020 2020 2020 4461 7461 5572            DataUr
-00016dc0: 6c28 0a20 2020 2020 2020 2020 2020 2020  l(.             
-00016dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016de0: 2020 2066 696c 655f 7061 7468 3d73 6176     file_path=sav
-00016df0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00016e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016e10: 2020 2064 6174 615f 7061 7468 3d22 2f64     data_path="/d
-00016e20: 6174 6173 6574 222c 0a20 2020 2020 2020  ataset",.       
-00016e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016e40: 2020 2020 2020 2020 2064 6174 615f 736c           data_sl
-00016e50: 6963 653d 692c 0a20 2020 2020 2020 2020  ice=i,.         
-00016e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016e70: 2020 2020 2020 2073 6368 656d 653d 2273         scheme="s
-00016e80: 696c 7822 2c0a 2020 2020 2020 2020 2020  ilx",.          
-00016e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ea0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00016eb0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00016ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ed0: 2020 2020 2020 2320 6669 6c65 6e61 6d65        # filename
-00016ee0: 203d 2073 6176 6520 2b20 7374 7228 6929   = save + str(i)
-00016ef0: 2e7a 6669 6c6c 2834 2920 2b20 222e 6e70  .zfill(4) + ".np
-00016f00: 7922 0a20 2020 2020 2020 2020 2020 2020  y".             
-00016f10: 2020 2020 2020 2020 2020 2023 206e 756d             # num
-00016f20: 7079 2e73 6176 6528 6669 6c65 6e61 6d65  py.save(filename
-00016f30: 2c20 696d 6729 0a20 2020 2020 2020 2020  , img).         
-00016f40: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00016f50: 2075 726c 732e 6170 7065 6e64 2844 6174   urls.append(Dat
-00016f60: 6155 726c 2866 696c 655f 7061 7468 3d66  aUrl(file_path=f
-00016f70: 696c 656e 616d 652c 2073 6368 656d 653d  ilename, scheme=
-00016f80: 2766 6162 696f 2729 290a 2020 2020 2020  'fabio')).      
-00016f90: 2020 2020 2020 2020 2020 2020 2020 696f                io
-00016fa0: 5f75 7469 6c73 2e61 6476 616e 6365 6d65  _utils.advanceme
-00016fb0: 6e74 5f64 6973 706c 6179 2869 202b 2031  nt_display(i + 1
-00016fc0: 2c20 7365 6c66 2e6e 6672 616d 6573 2c20  , self.nframes, 
-00016fd0: 7465 7874 290a 0a20 2020 2020 2020 2020  text)..         
-00016fe0: 2020 2020 2020 2073 656c 662e 7374 6174         self.stat
-00016ff0: 655f 6f66 5f6f 7065 7261 7469 6f6e 732e  e_of_operations.
-00017000: 7374 6f70 286f 7065 7261 7469 6f6e 290a  stop(operation).
-00017010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017020: 2069 6620 6461 7461 7365 745f 6e61 6d65   if dataset_name
-00017030: 203d 3d20 2275 7064 6174 655f 6461 7461   == "update_data
-00017040: 7365 7422 3a0a 2020 2020 2020 2020 2020  set":.          
-00017050: 2020 2020 2020 2020 2020 6465 6c20 5f66            del _f
-00017060: 696c 655b 2264 6174 6173 6574 225d 0a20  ile["dataset"]. 
-00017070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017080: 2020 205f 6669 6c65 5b22 6461 7461 7365     _file["datase
-00017090: 7422 5d20 3d20 5f66 696c 655b 2275 7064  t"] = _file["upd
-000170a0: 6174 655f 6461 7461 7365 7422 5d0a 2020  ate_dataset"].  
-000170b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000170c0: 2020 6465 6c20 5f66 696c 655b 2275 7064    del _file["upd
-000170d0: 6174 655f 6461 7461 7365 7422 5d0a 2020  ate_dataset"].  
-000170e0: 2020 2020 2020 2020 2020 6669 6e61 6c6c            finall
-000170f0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00017100: 2020 2069 6620 5f66 696c 6520 6973 206e     if _file is n
-00017110: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00017120: 2020 2020 2020 2020 2020 2020 205f 6669               _fi
-00017130: 6c65 2e63 6c6f 7365 2829 0a20 2020 2020  le.close().     
-00017140: 2020 2072 6574 7572 6e20 6e75 6d70 792e     return numpy.
-00017150: 6172 7261 7928 7572 6c73 290a 0a20 2020  array(urls)..   
-00017160: 2064 6566 2073 6176 6528 7365 6c66 2c20   def save(self, 
-00017170: 7061 7468 2c20 696e 6469 6365 733d 4e6f  path, indices=No
-00017180: 6e65 2c20 6e65 775f 7368 6170 653d 4e6f  ne, new_shape=No
-00017190: 6e65 2c20 696e 5f6d 656d 6f72 793d 5472  ne, in_memory=Tr
-000171a0: 7565 2920 2d3e 204e 6f6e 653a 0a20 2020  ue) -> None:.   
-000171b0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000171c0: 2053 6176 6520 7468 6520 6461 7461 2069   Save the data i
-000171d0: 6e74 6f20 6070 6174 6860 2066 6f6c 6465  nto `path` folde
-000171e0: 7220 616e 6420 7265 706c 6163 6520 4461  r and replace Da
-000171f0: 7461 2075 726c 732e 0a20 2020 2020 2020  ta urls..       
-00017200: 2054 4f44 4f3a 2063 6865 636b 2069 6620   TODO: check if 
-00017210: 7572 6c73 2061 6c72 6561 6479 2065 7869  urls already exi
-00017220: 7374 2061 6e64 2c20 6966 2073 6f2c 206d  st and, if so, m
-00017230: 6f64 6966 7920 6f6e 6c79 2075 726c 735b  odify only urls[
-00017240: 696e 6469 6365 735d 2e0a 0a20 2020 2020  indices]...     
-00017250: 2020 203a 7061 7261 6d20 7061 7468 3a20     :param path: 
-00017260: 5061 7468 2074 6f20 7468 6520 666f 6c64  Path to the fold
-00017270: 6572 0a20 2020 2020 2020 203a 7479 7065  er.        :type
-00017280: 2070 6174 683a 2073 7472 0a20 2020 2020   path: str.     
-00017290: 2020 203a 7061 7261 6d20 696e 6469 6365     :param indice
-000172a0: 733a 2074 6865 2069 6e64 6963 6573 206f  s: the indices o
-000172b0: 6620 7468 6520 7661 6c75 6573 2074 6f20  f the values to 
-000172c0: 7361 7665 2c20 6465 6661 756c 7473 2074  save, defaults t
-000172d0: 6f20 4e6f 6e65 0a20 2020 2020 2020 203a  o None.        :
-000172e0: 7479 7065 2069 6e64 6963 6573 3a20 556e  type indices: Un
-000172f0: 696f 6e5b 4e6f 6e65 2c61 7272 6179 5f6c  ion[None,array_l
-00017300: 696b 655d 2c20 6f70 7469 6f6e 616c 0a20  ike], optional. 
-00017310: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00017320: 2020 2069 6620 6e6f 7420 6861 7361 7474     if not hasatt
-00017330: 7228 7365 6c66 2c20 2269 6e5f 6d65 6d6f  r(self, "in_memo
-00017340: 7279 2229 206f 7220 7365 6c66 2e69 6e5f  ry") or self.in_
-00017350: 6d65 6d6f 7279 2069 7320 4e6f 6e65 3a0a  memory is None:.
-00017360: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00017370: 2e69 6e5f 6d65 6d6f 7279 203d 2054 7275  .in_memory = Tru
-00017380: 650a 2020 2020 2020 2020 7572 6c73 203d  e.        urls =
-00017390: 205b 5d0a 0a20 2020 2020 2020 2069 6620   []..        if 
-000173a0: 696e 6469 6365 7320 6973 204e 6f6e 653a  indices is None:
-000173b0: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-000173c0: 6120 3d20 7365 6c66 2e66 6c61 7474 656e  a = self.flatten
-000173d0: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
-000173e0: 6e64 6963 6573 203d 206e 756d 7079 2e61  ndices = numpy.a
-000173f0: 7261 6e67 6528 6c65 6e28 6461 7461 2929  range(len(data))
-00017400: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00017410: 2020 2020 2020 2020 2020 2064 6174 6120             data 
-00017420: 3d20 7365 6c66 2e66 6c61 7474 656e 2829  = self.flatten()
-00017430: 5b69 6e64 6963 6573 5d0a 0a20 2020 2020  [indices]..     
-00017440: 2020 205f 6669 6c65 203d 204e 6f6e 650a     _file = None.
-00017450: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00017460: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00017470: 2020 2020 2020 2020 2020 2020 2020 5f66                _f
-00017480: 696c 6520 3d20 6835 7079 2e46 696c 6528  ile = h5py.File(
-00017490: 7061 7468 2c20 2261 2229 0a20 2020 2020  path, "a").     
-000174a0: 2020 2020 2020 2065 7863 6570 7420 4f53         except OS
-000174b0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-000174c0: 2020 2020 2020 2069 6620 6f73 2e70 6174         if os.pat
-000174d0: 682e 6578 6973 7473 2870 6174 6829 3a0a  h.exists(path):.
-000174e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000174f0: 2020 2020 6f73 2e72 656d 6f76 6528 7061      os.remove(pa
-00017500: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
-00017510: 2020 2020 5f66 696c 6520 3d20 6835 7079      _file = h5py
-00017520: 2e46 696c 6528 7061 7468 2c20 2277 2229  .File(path, "w")
-00017530: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00017540: 6e65 775f 7368 6170 653a 0a20 2020 2020  new_shape:.     
-00017550: 2020 2020 2020 2020 2020 206e 6577 5f73             new_s
-00017560: 6861 7065 203d 2074 7570 6c65 286e 6577  hape = tuple(new
-00017570: 5f73 6861 7065 290a 2020 2020 2020 2020  _shape).        
-00017580: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00017590: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-000175a0: 662e 6e64 696d 203e 2033 3a0a 2020 2020  f.ndim > 3:.    
-000175b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000175c0: 6e65 775f 7368 6170 6520 3d20 2873 656c  new_shape = (sel
-000175d0: 662e 6e66 7261 6d65 732c 2920 2b20 7365  f.nframes,) + se
-000175e0: 6c66 2e66 7261 6d65 5f73 6861 7065 0a20  lf.frame_shape. 
-000175f0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00017600: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00017610: 2020 2020 2020 2020 206e 6577 5f73 6861           new_sha
-00017620: 7065 203d 2073 656c 662e 7368 6170 650a  pe = self.shape.
-00017630: 2020 2020 2020 2020 2020 2020 6966 2022              if "
-00017640: 6461 7461 7365 7422 206e 6f74 2069 6e20  dataset" not in 
-00017650: 5f66 696c 653a 0a20 2020 2020 2020 2020  _file:.         
-00017660: 2020 2020 2020 205f 6669 6c65 2e63 7265         _file.cre
-00017670: 6174 655f 6461 7461 7365 7428 2264 6174  ate_dataset("dat
-00017680: 6173 6574 222c 206e 6577 5f73 6861 7065  aset", new_shape
-00017690: 2c20 6474 7970 653d 7365 6c66 2e64 7479  , dtype=self.dty
-000176a0: 7065 290a 2020 2020 2020 2020 2020 2020  pe).            
-000176b0: 656c 6966 206e 6577 5f73 6861 7065 2021  elif new_shape !
-000176c0: 3d20 5f66 696c 655b 2264 6174 6173 6574  = _file["dataset
-000176d0: 225d 2e73 6861 7065 3a0a 2020 2020 2020  "].shape:.      
-000176e0: 2020 2020 2020 2020 2020 6465 6c20 5f66            del _f
-000176f0: 696c 655b 2264 6174 6173 6574 225d 0a20  ile["dataset"]. 
-00017700: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-00017710: 6669 6c65 2e63 7265 6174 655f 6461 7461  file.create_data
-00017720: 7365 7428 2264 6174 6173 6574 222c 206e  set("dataset", n
-00017730: 6577 5f73 6861 7065 2c20 6474 7970 653d  ew_shape, dtype=
-00017740: 7365 6c66 2e64 7479 7065 290a 0a20 2020  self.dtype)..   
-00017750: 2020 2020 2020 2020 2066 6f72 2069 2c20           for i, 
-00017760: 6a20 696e 2065 6e75 6d65 7261 7465 2869  j in enumerate(i
-00017770: 6e64 6963 6573 293a 0a20 2020 2020 2020  ndices):.       
-00017780: 2020 2020 2020 2020 205f 6669 6c65 5b22           _file["
-00017790: 6461 7461 7365 7422 5d5b 6a5d 203d 2064  dataset"][j] = d
-000177a0: 6174 615b 695d 0a20 2020 2020 2020 2020  ata[i].         
-000177b0: 2020 2020 2020 2075 726c 732e 6170 7065         urls.appe
-000177c0: 6e64 280a 2020 2020 2020 2020 2020 2020  nd(.            
-000177d0: 2020 2020 2020 2020 4461 7461 5572 6c28          DataUrl(
-000177e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000177f0: 2020 2020 2020 2020 2066 696c 655f 7061           file_pa
-00017800: 7468 3d70 6174 682c 0a20 2020 2020 2020  th=path,.       
-00017810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017820: 2064 6174 615f 7061 7468 3d22 2f64 6174   data_path="/dat
-00017830: 6173 6574 222c 0a20 2020 2020 2020 2020  aset",.         
-00017840: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00017850: 6174 615f 736c 6963 653d 6a2c 0a20 2020  ata_slice=j,.   
-00017860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017870: 2020 2020 2073 6368 656d 653d 2273 696c       scheme="sil
-00017880: 7822 2c0a 2020 2020 2020 2020 2020 2020  x",.            
-00017890: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000178a0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000178b0: 2020 2020 2020 2020 2320 2020 2020 6669          #     fi
-000178c0: 6c65 6e61 6d65 203d 2070 6174 6820 2b20  lename = path + 
-000178d0: 7374 7228 6929 2e7a 6669 6c6c 2834 2920  str(i).zfill(4) 
-000178e0: 2b20 222e 6e70 7922 0a20 2020 2020 2020  + ".npy".       
-000178f0: 2020 2020 2023 2020 2020 206e 756d 7079       #     numpy
-00017900: 2e73 6176 6528 6669 6c65 6e61 6d65 2c20  .save(filename, 
-00017910: 696d 6729 0a20 2020 2020 2020 2020 2020  img).           
-00017920: 2023 2020 2020 2075 726c 732e 6170 7065   #     urls.appe
-00017930: 6e64 2844 6174 6155 726c 2866 696c 655f  nd(DataUrl(file_
-00017940: 7061 7468 3d66 696c 656e 616d 652c 2073  path=filename, s
-00017950: 6368 656d 653d 2766 6162 696f 2729 290a  cheme='fabio')).
-00017960: 2020 2020 2020 2020 6669 6e61 6c6c 793a          finally:
-00017970: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00017980: 5f66 696c 6520 6973 206e 6f74 204e 6f6e  _file is not Non
-00017990: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000179a0: 2020 205f 6669 6c65 2e63 6c6f 7365 2829     _file.close()
-000179b0: 0a20 2020 2020 2020 2075 726c 7320 3d20  .        urls = 
-000179c0: 6e75 6d70 792e 6173 6172 7261 7928 7572  numpy.asarray(ur
-000179d0: 6c73 290a 2020 2020 2020 2020 6966 2073  ls).        if s
-000179e0: 656c 662e 7572 6c73 2069 7320 6e6f 7420  elf.urls is not 
-000179f0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00017a00: 2020 6e65 775f 7572 6c73 203d 2073 656c    new_urls = sel
-00017a10: 662e 7572 6c73 2e66 6c61 7474 656e 2829  f.urls.flatten()
-00017a20: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
-00017a30: 5f75 726c 735b 696e 6469 6365 735d 203d  _urls[indices] =
-00017a40: 2075 726c 730a 2020 2020 2020 2020 2020   urls.          
-00017a50: 2020 7365 6c66 2e75 726c 7320 3d20 6e65    self.urls = ne
-00017a60: 775f 7572 6c73 2e72 6573 6861 7065 2873  w_urls.reshape(s
-00017a70: 656c 662e 7572 6c73 2e73 6861 7065 290a  elf.urls.shape).
-00017a80: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00017a90: 2020 2020 2020 2020 2020 7365 6c66 2e75            self.u
-00017aa0: 726c 7320 3d20 6e75 6d70 792e 6173 6172  rls = numpy.asar
-00017ab0: 7261 7928 7572 6c73 290a 0a20 2020 2040  ray(urls)..    @
-00017ac0: 636f 6e74 6578 746d 616e 6167 6572 0a20  contextmanager. 
-00017ad0: 2020 2064 6566 206f 7065 6e5f 6173 5f68     def open_as_h
-00017ae0: 6466 3528 7365 6c66 2c20 5f64 6972 2920  df5(self, _dir) 
-00017af0: 2d3e 2047 656e 6572 6174 6f72 5b68 3570  -> Generator[h5p
-00017b00: 792e 4461 7461 7365 742c 204e 6f6e 652c  y.Dataset, None,
-00017b10: 204e 6f6e 655d 3a0a 2020 2020 2020 2020   None]:.        
-00017b20: 2222 220a 2020 2020 2020 2020 436f 6e76  """.        Conv
-00017b30: 6572 7473 2074 6865 2064 6174 6120 696e  erts the data in
-00017b40: 746f 2061 6e20 4844 4635 2066 696c 652c  to an HDF5 file,
-00017b50: 2073 6574 7469 6e67 2066 6c61 7474 656e   setting flatten
-00017b60: 6564 2069 6d61 6765 7320 696e 2074 6865  ed images in the
-00017b70: 2072 6f77 732e 0a20 2020 2020 2020 2054   rows..        T
-00017b80: 4f44 4f3a 2070 6173 7320 6669 6c65 6e61  ODO: pass filena
-00017b90: 6d65 2070 6572 2070 6172 616d 6574 6572  me per parameter
-00017ba0: 3f0a 0a20 2020 2020 2020 203a 7061 7261  ?..        :para
-00017bb0: 6d20 5f64 6972 3a20 4469 7265 6374 6f72  m _dir: Director
-00017bc0: 7920 696e 2077 6869 6368 2074 6f20 7361  y in which to sa
-00017bd0: 7665 2074 6865 2048 4446 3520 6669 6c65  ve the HDF5 file
-00017be0: 2e0a 2020 2020 2020 2020 3a74 7970 6520  ..        :type 
-00017bf0: 5f64 6972 3a20 7374 720a 0a20 2020 2020  _dir: str..     
-00017c00: 2020 203a 7265 7475 726e 3a20 4844 4635     :return: HDF5
-00017c10: 2064 6174 6173 6574 0a20 2020 2020 2020   dataset.       
-00017c20: 203a 7274 7970 653a 2060 6835 7079 2e44   :rtype: `h5py.D
-00017c30: 6174 6173 6574 600a 2020 2020 2020 2020  ataset`.        
-00017c40: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
-00017c50: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
-00017c60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00017c70: 2020 6669 6c65 6e61 6d65 203d 206f 732e    filename = os.
-00017c80: 7061 7468 2e6a 6f69 6e28 5f64 6972 2c20  path.join(_dir, 
-00017c90: 2264 6174 612e 6864 6635 2229 0a20 2020  "data.hdf5").   
-00017ca0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00017cb0: 662e 5f66 696c 6520 3d20 6835 7079 2e46  f._file = h5py.F
-00017cc0: 696c 6528 6669 6c65 6e61 6d65 2c20 2261  ile(filename, "a
-00017cd0: 2229 0a20 2020 2020 2020 2020 2020 2065  ").            e
-00017ce0: 7863 6570 7420 4f53 4572 726f 723a 0a20  xcept OSError:. 
-00017cf0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00017d00: 6620 6f73 2e70 6174 682e 6578 6973 7473  f os.path.exists
-00017d10: 2866 696c 656e 616d 6529 3a0a 2020 2020  (filename):.    
-00017d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017d30: 6f73 2e72 656d 6f76 6528 6669 6c65 6e61  os.remove(filena
-00017d40: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-00017d50: 2020 2020 7365 6c66 2e5f 6669 6c65 203d      self._file =
-00017d60: 2068 3570 792e 4669 6c65 2866 696c 656e   h5py.File(filen
-00017d70: 616d 652c 2022 7722 290a 0a20 2020 2020  ame, "w")..     
-00017d80: 2020 2020 2020 206e 6672 616d 6573 203d         nframes =
-00017d90: 2073 656c 662e 6e66 7261 6d65 730a 2020   self.nframes.  
-00017da0: 2020 2020 2020 2020 2020 6672 616d 655f            frame_
-00017db0: 7368 6170 6520 3d20 7365 6c66 2e66 7261  shape = self.fra
-00017dc0: 6d65 5f73 6861 7065 0a20 2020 2020 2020  me_shape.       
-00017dd0: 2020 2020 2066 7261 6d65 5f73 697a 6520       frame_size 
-00017de0: 3d20 6672 616d 655f 7368 6170 655b 305d  = frame_shape[0]
-00017df0: 202a 2066 7261 6d65 5f73 6861 7065 5b31   * frame_shape[1
-00017e00: 5d0a 2020 2020 2020 2020 2020 2020 6864  ].            hd
-00017e10: 6635 5f73 6861 7065 203d 2028 6e66 7261  f5_shape = (nfra
-00017e20: 6d65 732c 2066 7261 6d65 5f73 697a 6529  mes, frame_size)
-00017e30: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00017e40: 2022 6461 7461 7365 7422 2069 6e20 7365   "dataset" in se
-00017e50: 6c66 2e5f 6669 6c65 2061 6e64 2073 656c  lf._file and sel
-00017e60: 662e 5f66 696c 655b 2264 6174 6173 6574  f._file["dataset
-00017e70: 225d 2e73 6861 7065 2021 3d20 6864 6635  "].shape != hdf5
-00017e80: 5f73 6861 7065 3a0a 2020 2020 2020 2020  _shape:.        
-00017e90: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
-00017ea0: 2e5f 6669 6c65 5b22 6461 7461 7365 7422  ._file["dataset"
-00017eb0: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
-00017ec0: 2022 6461 7461 7365 7422 206e 6f74 2069   "dataset" not i
-00017ed0: 6e20 7365 6c66 2e5f 6669 6c65 3a0a 2020  n self._file:.  
-00017ee0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00017ef0: 6c66 2e5f 6669 6c65 2e63 7265 6174 655f  lf._file.create_
-00017f00: 6461 7461 7365 7428 2264 6174 6173 6574  dataset("dataset
-00017f10: 222c 2073 6861 7065 3d68 6466 355f 7368  ", shape=hdf5_sh
-00017f20: 6170 652c 2064 7479 7065 3d73 656c 662e  ape, dtype=self.
-00017f30: 6474 7970 6529 0a0a 2020 2020 2020 2020  dtype)..        
-00017f40: 2020 2020 666f 7220 696d 6167 655f 6964      for image_id
-00017f50: 782c 2066 7261 6d65 2069 6e20 656e 756d  x, frame in enum
-00017f60: 6572 6174 6528 7365 6c66 2e5f 6974 6572  erate(self._iter
-00017f70: 5f66 7261 6d65 7328 2929 3a0a 2020 2020  _frames()):.    
-00017f80: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00017f90: 2e5f 6669 6c65 5b22 6461 7461 7365 7422  ._file["dataset"
-00017fa0: 5d5b 696d 6167 655f 6964 785d 203d 2066  ][image_idx] = f
-00017fb0: 7261 6d65 2e66 6c61 7474 656e 2829 0a0a  rame.flatten()..
-00017fc0: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
-00017fd0: 6420 7365 6c66 2e5f 6669 6c65 5b22 6461  d self._file["da
-00017fe0: 7461 7365 7422 5d0a 2020 2020 2020 2020  taset"].        
-00017ff0: 6669 6e61 6c6c 793a 0a20 2020 2020 2020  finally:.       
-00018000: 2020 2020 2069 6620 7365 6c66 2e5f 6669       if self._fi
-00018010: 6c65 2069 7320 6e6f 7420 4e6f 6e65 3a0a  le is not None:.
-00018020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018030: 7365 6c66 2e5f 6669 6c65 2e63 6c6f 7365  self._file.close
-00018040: 2829 0a0a 2020 2020 6465 6620 7265 7368  ()..    def resh
-00018050: 6170 6528 7365 6c66 2c20 7368 6170 652c  ape(self, shape,
-00018060: 206f 7264 6572 3d22 4322 2920 2d3e 2022   order="C") -> "
-00018070: 4461 7461 223a 0a20 2020 2020 2020 2022  Data":.        "
-00018080: 2222 0a20 2020 2020 2020 2052 6574 7572  "".        Retur
-00018090: 6e73 2061 6e20 6172 7261 7920 636f 6e74  ns an array cont
-000180a0: 6169 6e69 6e67 2074 6865 2073 616d 6520  aining the same 
-000180b0: 6461 7461 2077 6974 6820 6120 6e65 7720  data with a new 
-000180c0: 7368 6170 6520 6f66 2075 726c 7320 616e  shape of urls an
-000180d0: 6420 6d65 7461 6461 7461 2e0a 2020 2020  d metadata..    
-000180e0: 2020 2020 5368 6170 6520 616c 736f 2063      Shape also c
-000180f0: 6f6e 7461 696e 7320 696d 6167 6520 7368  ontains image sh
-00018100: 6170 6520 6174 2074 6865 206c 6173 7420  ape at the last 
-00018110: 7477 6f20 706f 7369 7469 6f6e 7320 2875  two positions (u
-00018120: 6e72 6573 6861 7061 626c 6529 2e0a 0a20  nreshapable)... 
-00018130: 2020 2020 2020 203a 7061 7261 6d20 7368         :param sh
-00018140: 6170 653a 204e 6577 2073 6861 7065 2c20  ape: New shape, 
-00018150: 7368 6f75 6c64 2062 6520 636f 6d70 6174  should be compat
-00018160: 6962 6c65 2077 6974 6820 7468 6520 6f72  ible with the or
-00018170: 6967 696e 616c 2073 6861 7065 2e0a 2020  iginal shape..  
-00018180: 2020 2020 2020 3a74 7970 6520 7368 6170        :type shap
-00018190: 653a 2069 6e74 206f 7220 7475 706c 6520  e: int or tuple 
-000181a0: 6f66 2069 6e74 732e 0a20 2020 2020 2020  of ints..       
-000181b0: 203a 7265 7475 726e 3a20 6e65 7720 4461   :return: new Da
-000181c0: 7461 206f 626a 6563 7420 7769 7468 2075  ta object with u
-000181d0: 726c 7320 616e 6420 6d65 7461 6461 7461  rls and metadata
-000181e0: 2072 6573 6861 7065 6420 746f 2073 6861   reshaped to sha
-000181f0: 7065 2e0a 2020 2020 2020 2020 2222 220a  pe..        """.
-00018200: 2020 2020 2020 2020 6461 7461 203d 204e          data = N
-00018210: 6f6e 650a 2020 2020 2020 2020 6966 2073  one.        if s
-00018220: 656c 662e 696e 5f6d 656d 6f72 793a 0a20  elf.in_memory:. 
-00018230: 2020 2020 2020 2020 2020 2064 6174 6120             data 
-00018240: 3d20 7375 7065 7228 292e 7265 7368 6170  = super().reshap
-00018250: 6528 7368 6170 652c 206f 7264 6572 3d6f  e(shape, order=o
-00018260: 7264 6572 292e 7669 6577 286e 756d 7079  rder).view(numpy
-00018270: 2e6e 6461 7272 6179 290a 2020 2020 2020  .ndarray).      
-00018280: 2020 7363 616e 5f73 6861 7065 203d 2073    scan_shape = s
-00018290: 6861 7065 5b3a 2d32 5d0a 2020 2020 2020  hape[:-2].      
-000182a0: 2020 7265 7475 726e 2044 6174 6128 0a20    return Data(. 
-000182b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000182c0: 7572 6c73 2e72 6573 6861 7065 2873 6361  urls.reshape(sca
-000182d0: 6e5f 7368 6170 652c 206f 7264 6572 3d6f  n_shape, order=o
-000182e0: 7264 6572 292c 0a20 2020 2020 2020 2020  rder),.         
-000182f0: 2020 2073 656c 662e 6d65 7461 6461 7461     self.metadata
-00018300: 2e72 6573 6861 7065 2873 6361 6e5f 7368  .reshape(scan_sh
-00018310: 6170 652c 206f 7264 6572 3d6f 7264 6572  ape, order=order
-00018320: 292c 0a20 2020 2020 2020 2020 2020 2073  ),.            s
-00018330: 656c 662e 696e 5f6d 656d 6f72 792c 0a20  elf.in_memory,. 
-00018340: 2020 2020 2020 2020 2020 2064 6174 613d             data=
-00018350: 6461 7461 2c0a 2020 2020 2020 2020 290a  data,.        ).
-00018360: 0a20 2020 2064 6566 2073 756d 2873 656c  .    def sum(sel
-00018370: 662c 2061 7869 733d 4e6f 6e65 2c20 2a2a  f, axis=None, **
-00018380: 6b77 6172 6773 2920 2d3e 2055 6e69 6f6e  kwargs) -> Union
-00018390: 5b6e 756d 7079 2e6e 6461 7272 6179 2c20  [numpy.ndarray, 
-000183a0: 666c 6f61 745d 3a0a 2020 2020 2020 2020  float]:.        
-000183b0: 2222 220a 2020 2020 2020 2020 5375 6d20  """.        Sum 
-000183c0: 6f66 2061 7272 6179 2065 6c65 6d65 6e74  of array element
-000183d0: 7320 6f76 6572 2061 2067 6976 656e 2061  s over a given a
-000183e0: 7869 732e 0a0a 2020 2020 2020 2020 3a70  xis...        :p
-000183f0: 6172 616d 2061 7869 733a 204f 6e6c 7920  aram axis: Only 
-00018400: 6178 6973 2061 6363 6570 7465 6420 6172  axis accepted ar
-00018410: 6520 3020 6f72 2031 2e0a 2020 2020 2020  e 0 or 1..      
-00018420: 2020 2020 2020 5769 7468 2030 2c20 7468        With 0, th
-00018430: 6520 7375 6d20 6973 2064 6f6e 6520 6172  e sum is done ar
-00018440: 6f75 6e64 2074 6865 207a 2061 7869 732c  ound the z axis,
-00018450: 2073 6f20 6120 7265 7375 6c74 696e 6720   so a resulting 
-00018460: 696d 6167 6520 6973 2072 6574 7572 6e65  image is returne
-00018470: 642e 0a20 2020 2020 2020 2020 2020 2057  d..            W
-00018480: 6974 6820 312c 2065 7665 7279 2069 6d61  ith 1, every ima
-00018490: 6765 7320 6861 7320 6974 7320 7069 7865  ges has its pixe
-000184a0: 6c73 2073 756d 6d65 6420 616e 6420 7468  ls summed and th
-000184b0: 6520 7265 7375 6c74 2069 7320 6120 6c69  e result is a li
-000184c0: 7374 2077 6974 680a 2020 2020 2020 2020  st with.        
-000184d0: 2020 2020 7468 6520 696e 7465 6e73 6974      the intensit
-000184e0: 7920 6f66 2065 6163 6820 696d 6167 652e  y of each image.
-000184f0: 0a20 2020 2020 2020 2020 2020 2057 6974  .            Wit
-00018500: 6820 4e6f 6e65 2c20 6120 666c 6f61 7420  h None, a float 
-00018510: 6973 2074 6865 2072 6573 756c 7420 6f66  is the result of
-00018520: 2074 6865 2073 756d 206f 6620 616c 6c20   the sum of all 
-00018530: 7468 6520 7069 7865 6c73 2061 6e64 2061  the pixels and a
-00018540: 6c6c 0a20 2020 2020 2020 2020 2020 2074  ll.            t
-00018550: 6865 2069 6d61 6765 732e 0a20 2020 2020  he images..     
-00018560: 2020 203a 7479 7065 2061 7869 733a 2055     :type axis: U
-00018570: 6e69 6f6e 5b4e 6f6e 652c 2069 6e74 5d0a  nion[None, int].
-00018580: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-00018590: 3a20 5375 6d6d 6564 2064 6174 610a 2020  : Summed data.  
-000185a0: 2020 2020 2020 3a72 7479 7065 3a20 556e        :rtype: Un
-000185b0: 696f 6e5b 666c 6f61 742c 206c 6973 745d  ion[float, list]
-000185c0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000185d0: 2020 2020 2064 6174 6120 3d20 7365 6c66       data = self
-000185e0: 2e66 6c61 7474 656e 2829 0a20 2020 2020  .flatten().     
-000185f0: 2020 2069 6620 7365 6c66 2e69 6e5f 6d65     if self.in_me
-00018600: 6d6f 7279 3a0a 2020 2020 2020 2020 2020  mory:.          
-00018610: 2020 6966 2061 7869 7320 3d3d 2030 3a0a    if axis == 0:.
-00018620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018630: 7265 7475 726e 2073 7570 6572 2844 6174  return super(Dat
-00018640: 612c 2064 6174 6129 2e73 756d 2861 7869  a, data).sum(axi
-00018650: 733d 6178 6973 292e 7669 6577 286e 756d  s=axis).view(num
-00018660: 7079 2e6e 6461 7272 6179 290a 2020 2020  py.ndarray).    
+00012790: 2020 2020 2020 2020 2069 202a 2063 6875           i * chu
+000127a0: 6e6b 735f 3220 2a20 6c65 6e28 6461 7461  nks_2 * len(data
+000127b0: 2920 2b20 6a20 2a20 6c65 6e28 6461 7461  ) + j * len(data
+000127c0: 2920 2b20 6b20 2b20 312c 0a20 2020 2020  ) + k + 1,.     
+000127d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000127e0: 2020 2020 2020 2020 2020 2063 6875 6e6b             chunk
+000127f0: 735f 3120 2a20 6368 756e 6b73 5f32 202a  s_1 * chunks_2 *
+00012800: 206c 656e 2864 6174 6129 2c0a 2020 2020   len(data),.    
+00012810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012820: 2020 2020 2020 2020 2020 2020 2246 6974              "Fit
+00012830: 7469 6e67 2072 6f63 6b69 6e67 2063 7572  ting rocking cur
+00012840: 7665 7322 2c0a 2020 2020 2020 2020 2020  ves",.          
+00012850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012860: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00012870: 2020 2020 2020 2020 2020 2020 6d61 7073              maps
+00012880: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00012890: 2020 2020 2020 2020 2020 2020 2020 3a2c                :,
+000128a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000128b0: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+000128c0: 7274 5b30 5d20 3a20 7374 6172 745b 305d  rt[0] : start[0]
+000128d0: 202b 2063 6875 6e6b 5f73 6861 7065 5b30   + chunk_shape[0
+000128e0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000128f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00012900: 7461 7274 5b31 5d20 3a20 7374 6172 745b  tart[1] : start[
+00012910: 315d 202b 2063 6875 6e6b 5f73 6861 7065  1] + chunk_shape
+00012920: 5b31 5d2c 0a20 2020 2020 2020 2020 2020  [1],.           
+00012930: 2020 2020 2020 2020 2020 2020 205d 203d               ] =
+00012940: 2063 6875 6e6b 6564 5f6d 6170 730a 2020   chunked_maps.  
+00012950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012960: 2020 2020 2020 7374 6172 745b 315d 203d        start[1] =
+00012970: 2063 6875 6e6b 5f73 6861 7065 5b31 5d20   chunk_shape[1] 
+00012980: 2a20 286a 202b 2031 290a 2020 2020 2020  * (j + 1).      
+00012990: 2020 2020 2020 2020 2020 2020 2020 7374                st
+000129a0: 6172 745b 305d 203d 2063 6875 6e6b 5f73  art[0] = chunk_s
+000129b0: 6861 7065 5b30 5d20 2a20 2869 202b 2031  hape[0] * (i + 1
+000129c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000129d0: 2020 2020 2020 7374 6172 745b 315d 203d        start[1] =
+000129e0: 2030 0a20 2020 2020 2020 2020 2020 2065   0.            e
+000129f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00012a00: 2020 2020 2066 6974 7465 645f 6461 7461       fitted_data
+00012a10: 2c20 6d61 7073 203d 205f 6669 7428 0a20  , maps = _fit(. 
+00012a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a30: 2020 2064 6174 612c 0a20 2020 2020 2020     data,.       
+00012a40: 2020 2020 2020 2020 2020 2020 2076 616c               val
+00012a50: 7565 733d 7661 6c75 6573 2c0a 2020 2020  ues=values,.    
+00012a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a70: 7368 6170 653d 7368 6170 652c 0a20 2020  shape=shape,.   
+00012a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a90: 2069 6e74 5f74 6872 6573 683d 696e 745f   int_thresh=int_
+00012aa0: 7468 7265 7368 2c0a 2020 2020 2020 2020  thresh,.        
+00012ab0: 2020 2020 2020 2020 2020 2020 696e 6469              indi
+00012ac0: 6365 733d 696e 6469 6365 732c 0a20 2020  ces=indices,.   
+00012ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ae0: 205f 7471 646d 3d54 7275 652c 0a20 2020   _tqdm=True,.   
+00012af0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00012b00: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00012b10: 6f72 2069 2c20 696d 6167 6520 696e 2065  or i, image in e
+00012b20: 6e75 6d65 7261 7465 2866 6974 7465 645f  numerate(fitted_
+00012b30: 6461 7461 293a 0a20 2020 2020 2020 2020  data):.         
+00012b40: 2020 2020 2020 2020 2020 2066 696c 656e             filen
+00012b50: 616d 6520 3d20 6f73 2e70 6174 682e 6a6f  ame = os.path.jo
+00012b60: 696e 280a 2020 2020 2020 2020 2020 2020  in(.            
+00012b70: 2020 2020 2020 2020 2020 2020 5f64 6972              _dir
+00012b80: 2c20 2264 6174 615f 6669 7422 202b 2073  , "data_fit" + s
+00012b90: 7472 2869 6e64 6963 6573 5b69 5d29 2e7a  tr(indices[i]).z
+00012ba0: 6669 6c6c 2834 2920 2b20 222e 6e70 7922  fill(4) + ".npy"
+00012bb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012bc0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00012bd0: 2020 2020 2020 2020 2020 206e 756d 7079             numpy
+00012be0: 2e73 6176 6528 6669 6c65 6e61 6d65 2c20  .save(filename, 
+00012bf0: 696d 6167 6529 0a20 2020 2020 2020 2020  image).         
+00012c00: 2020 2020 2020 2020 2020 2075 726c 732e             urls.
+00012c10: 6170 7065 6e64 2844 6174 6155 726c 2866  append(DataUrl(f
+00012c20: 696c 655f 7061 7468 3d66 696c 656e 616d  ile_path=filenam
+00012c30: 652c 2073 6368 656d 653d 2266 6162 696f  e, scheme="fabio
+00012c40: 2229 290a 0a20 2020 2020 2020 2069 6620  "))..        if 
+00012c50: 696e 6469 6365 7320 6973 206e 6f74 204e  indices is not N
+00012c60: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00012c70: 2023 2052 6570 6c61 6365 206f 6e6c 7920   # Replace only 
+00012c80: 6669 7474 6564 2064 6174 6120 7572 6c73  fitted data urls
+00012c90: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
+00012ca0: 5f75 726c 7320 3d20 6e75 6d70 792e 6172  _urls = numpy.ar
+00012cb0: 7261 7928 7365 6c66 2e64 6174 612e 7572  ray(self.data.ur
+00012cc0: 6c73 2c20 6474 7970 653d 6f62 6a65 6374  ls, dtype=object
+00012cd0: 292e 666c 6174 7465 6e28 290a 2020 2020  ).flatten().    
+00012ce0: 2020 2020 2020 2020 6e75 6d70 792e 7075          numpy.pu
+00012cf0: 7428 6e65 775f 7572 6c73 2c20 696e 6469  t(new_urls, indi
+00012d00: 6365 732c 2075 726c 7329 0a20 2020 2020  ces, urls).     
+00012d10: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00012d20: 2020 2020 206e 6577 5f75 726c 7320 3d20       new_urls = 
+00012d30: 6e75 6d70 792e 6172 7261 7928 7572 6c73  numpy.array(urls
+00012d40: 290a 0a20 2020 2020 2020 2064 6174 6120  )..        data 
+00012d50: 3d20 4461 7461 280a 2020 2020 2020 2020  = Data(.        
+00012d60: 2020 2020 6e65 775f 7572 6c73 2e72 6573      new_urls.res
+00012d70: 6861 7065 2873 656c 662e 6461 7461 2e75  hape(self.data.u
+00012d80: 726c 732e 7368 6170 6529 2c0a 2020 2020  rls.shape),.    
+00012d90: 2020 2020 2020 2020 7365 6c66 2e64 6174          self.dat
+00012da0: 612e 6d65 7461 6461 7461 2c0a 2020 2020  a.metadata,.    
+00012db0: 2020 2020 2020 2020 696e 5f6d 656d 6f72          in_memor
+00012dc0: 793d 7365 6c66 2e5f 696e 5f6d 656d 6f72  y=self._in_memor
+00012dd0: 792c 0a20 2020 2020 2020 2029 2020 2320  y,.        )  # 
+00012de0: 746f 206d 6f64 6966 790a 2020 2020 2020  to modify.      
+00012df0: 2020 7265 7475 726e 2028 0a20 2020 2020    return (.     
+00012e00: 2020 2020 2020 2044 6174 6173 6574 280a         Dataset(.
+00012e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012e20: 5f64 6972 3d5f 6469 722c 0a20 2020 2020  _dir=_dir,.     
+00012e30: 2020 2020 2020 2020 2020 2064 6174 613d             data=
+00012e40: 6461 7461 2c0a 2020 2020 2020 2020 2020  data,.          
+00012e50: 2020 2020 2020 6469 6d73 3d73 656c 662e        dims=self.
+00012e60: 5f5f 6469 6d73 2c0a 2020 2020 2020 2020  __dims,.        
+00012e70: 2020 2020 2020 2020 7472 616e 7366 6f72          transfor
+00012e80: 6d61 7469 6f6e 3d73 656c 662e 7472 616e  mation=self.tran
+00012e90: 7366 6f72 6d61 7469 6f6e 2c0a 2020 2020  sformation,.    
+00012ea0: 2020 2020 2020 2020 2020 2020 696e 5f6d              in_m
+00012eb0: 656d 6f72 793d 7365 6c66 2e5f 696e 5f6d  emory=self._in_m
+00012ec0: 656d 6f72 792c 0a20 2020 2020 2020 2020  emory,.         
+00012ed0: 2020 2020 2020 2074 6974 6c65 3d73 656c         title=sel
+00012ee0: 662e 7469 746c 652c 0a20 2020 2020 2020  f.title,.       
+00012ef0: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+00012f00: 2020 2020 6d61 7073 2c0a 2020 2020 2020      maps,.      
+00012f10: 2020 290a 0a20 2020 2064 6566 2063 6f6d    )..    def com
+00012f20: 7075 7465 5f74 7261 6e73 666f 726d 6174  pute_transformat
+00012f30: 696f 6e28 0a20 2020 2020 2020 2073 656c  ion(.        sel
+00012f40: 662c 2064 2c20 6b69 6e64 3d22 6d61 676e  f, d, kind="magn
+00012f50: 6966 6963 6174 696f 6e22 2c20 726f 7461  ification", rota
+00012f60: 7465 3d46 616c 7365 2c20 746f 706f 6772  te=False, topogr
+00012f70: 6170 6879 3d5b 4661 6c73 652c 2030 5d2c  aphy=[False, 0],
+00012f80: 2063 656e 7465 723d 5472 7565 0a20 2020   center=True.   
+00012f90: 2029 3a0a 2020 2020 2020 2020 2222 220a   ):.        """.
+00012fa0: 2020 2020 2020 2020 436f 6d70 7574 6573          Computes
+00012fb0: 2074 7261 6e73 666f 726d 6174 696f 6e20   transformation 
+00012fc0: 6d61 7472 6978 2e0a 2020 2020 2020 2020  matrix..        
+00012fd0: 4465 7065 6e64 696e 6720 6f6e 2074 6865  Depending on the
+00012fe0: 206b 696e 6420 6f66 2074 7261 6e73 666f   kind of transfo
+00012ff0: 726d 6174 696f 6e2c 2063 6f6d 7075 7465  rmation, compute
+00013000: 7320 6569 7468 6572 2052 534d 206f 7220  s either RSM or 
+00013010: 6d61 676e 6966 6963 6174 696f 6e0a 2020  magnification.  
+00013020: 2020 2020 2020 6178 6573 2074 6f20 6265        axes to be
+00013030: 2075 7365 6420 6f6e 2066 7574 7572 6520   used on future 
+00013040: 7769 6467 6574 732e 0a0a 2020 2020 2020  widgets...      
+00013050: 2020 3a70 6172 616d 2064 3a20 5369 7a65    :param d: Size
+00013060: 206f 6620 7468 6520 7069 7865 6c0a 2020   of the pixel.  
+00013070: 2020 2020 2020 3a74 7970 6520 643a 2066        :type d: f
+00013080: 6c6f 6174 0a20 2020 2020 2020 203a 7061  loat.        :pa
+00013090: 7261 6d20 6b69 6e64 3a20 5472 616e 7366  ram kind: Transf
+000130a0: 6f72 6d61 7469 6f6e 2074 6f20 6170 706c  ormation to appl
+000130b0: 792c 2065 6974 6865 7220 276d 6167 6e69  y, either 'magni
+000130c0: 6669 6361 7469 6f6e 2720 6f72 2027 7273  fication' or 'rs
+000130d0: 6d27 0a20 2020 2020 2020 203a 7479 7065  m'.        :type
+000130e0: 206b 696e 643a 2073 7472 0a20 2020 2020   kind: str.     
+000130f0: 2020 203a 7061 7261 6d20 726f 7461 7465     :param rotate
+00013100: 3a20 546f 2062 6520 7573 6564 206f 6e6c  : To be used onl
+00013110: 7920 7769 7468 206b 696e 643d 2772 736d  y with kind='rsm
+00013120: 272c 2069 6620 5472 7565 2074 6865 2069  ', if True the i
+00013130: 6d61 6765 7320 7769 7468 0a20 2020 2020  mages with.     
+00013140: 2020 2020 2020 2074 7261 6e73 666f 726d         transform
+00013150: 6174 696f 6e20 6172 6520 726f 7461 7465  ation are rotate
+00013160: 6420 3930 2064 6567 7265 6573 2e0a 2020  d 90 degrees..  
+00013170: 2020 2020 2020 3a74 7970 6520 726f 7461        :type rota
+00013180: 7465 3a20 626f 6f6c 0a20 2020 2020 2020  te: bool.       
+00013190: 203a 7061 7261 6d20 746f 706f 6772 6170   :param topograp
+000131a0: 6879 3a20 546f 2062 6520 7573 6564 206f  hy: To be used o
+000131b0: 6e6c 7920 7769 7468 206b 696e 643d 276d  nly with kind='m
+000131c0: 6167 6e69 6669 6361 7469 6f6e 272c 2069  agnification', i
+000131d0: 6620 5472 7565 0a20 2020 2020 2020 2020  f True.         
+000131e0: 2020 206f 6270 6974 6368 2076 616c 7565     obpitch value
+000131f0: 7320 6172 6520 6469 7669 6465 6420 6279  s are divided by
+00013200: 2069 7473 2073 696e 652e 0a20 2020 2020   its sine..     
+00013210: 2020 203a 7479 7065 2074 6f70 6f67 7261     :type topogra
+00013220: 7068 793a 2062 6f6f 6c0a 2020 2020 2020  phy: bool.      
+00013230: 2020 2222 220a 0a20 2020 2020 2020 2048    """..        H
+00013240: 2c20 5720 3d20 7365 6c66 2e67 6574 5f64  , W = self.get_d
+00013250: 6174 6128 3029 2e73 6861 7065 0a20 2020  ata(0).shape.   
+00013260: 2020 2020 2073 656c 662e 726f 7461 7465       self.rotate
+00013270: 203d 2072 6f74 6174 650a 0a20 2020 2020   = rotate..     
+00013280: 2020 2069 6620 7365 6c66 2e64 696d 732e     if self.dims.
+00013290: 6e64 696d 203d 3d20 3120 616e 6420 6b69  ndim == 1 and ki
+000132a0: 6e64 203d 3d20 2272 736d 223a 0a20 2020  nd == "rsm":.   
+000132b0: 2020 2020 2020 2020 2066 667a 203d 2073           ffz = s
+000132c0: 656c 662e 6765 745f 6d65 7461 6461 7461  elf.get_metadata
+000132d0: 5f76 616c 7565 7328 504f 5349 5449 4f4e  _values(POSITION
+000132e0: 4552 5f4d 4554 4144 4154 412c 2022 6666  ER_METADATA, "ff
+000132f0: 7a22 295b 305d 0a20 2020 2020 2020 2020  z")[0].         
+00013300: 2020 206d 6169 6e78 203d 202d 7365 6c66     mainx = -self
+00013310: 2e67 6574 5f6d 6574 6164 6174 615f 7661  .get_metadata_va
+00013320: 6c75 6573 2850 4f53 4954 494f 4e45 525f  lues(POSITIONER_
+00013330: 4d45 5441 4441 5441 2c20 226d 6169 6e78  METADATA, "mainx
+00013340: 2229 5b30 5d0a 2020 2020 2020 2020 2020  ")[0].          
+00013350: 2020 782c 2079 203d 2063 6f6d 7075 7465    x, y = compute
+00013360: 5f72 736d 2848 2c20 572c 2064 2c20 6666  _rsm(H, W, d, ff
+00013370: 7a2c 206d 6169 6e78 2c20 726f 7461 7465  z, mainx, rotate
+00013380: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00013390: 2020 2020 2020 2020 2020 2020 6f62 7820              obx 
+000133a0: 3d20 7365 6c66 2e67 6574 5f6d 6574 6164  = self.get_metad
+000133b0: 6174 615f 7661 6c75 6573 2850 4f53 4954  ata_values(POSIT
+000133c0: 494f 4e45 525f 4d45 5441 4441 5441 2c20  IONER_METADATA, 
+000133d0: 226f 6278 2229 5b30 5d0a 2020 2020 2020  "obx")[0].      
+000133e0: 2020 2020 2020 6f62 7069 7463 6820 3d20        obpitch = 
+000133f0: 6e75 6d70 792e 756e 6971 7565 280a 2020  numpy.unique(.  
+00013400: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00013410: 6c66 2e67 6574 5f6d 6574 6164 6174 615f  lf.get_metadata_
+00013420: 7661 6c75 6573 2850 4f53 4954 494f 4e45  values(POSITIONE
+00013430: 525f 4d45 5441 4441 5441 2c20 226f 6270  R_METADATA, "obp
+00013440: 6974 6368 2229 0a20 2020 2020 2020 2020  itch").         
+00013450: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00013460: 206f 6270 6974 6368 203d 206f 6270 6974   obpitch = obpit
+00013470: 6368 5b6c 656e 286f 6270 6974 6368 2920  ch[len(obpitch) 
+00013480: 2f2f 2032 5d0a 2020 2020 2020 2020 2020  // 2].          
+00013490: 2020 6d61 696e 7820 3d20 2d73 656c 662e    mainx = -self.
+000134a0: 6765 745f 6d65 7461 6461 7461 5f76 616c  get_metadata_val
+000134b0: 7565 7328 504f 5349 5449 4f4e 4552 5f4d  ues(POSITIONER_M
+000134c0: 4554 4144 4154 412c 2022 6d61 696e 7822  ETADATA, "mainx"
+000134d0: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
+000134e0: 2078 2c20 7920 3d20 636f 6d70 7574 655f   x, y = compute_
+000134f0: 6d61 676e 6966 6963 6174 696f 6e28 0a20  magnification(. 
+00013500: 2020 2020 2020 2020 2020 2020 2020 2048                 H
+00013510: 2c20 572c 2064 2c20 6f62 782c 206f 6270  , W, d, obx, obp
+00013520: 6974 6368 2c20 6d61 696e 782c 2074 6f70  itch, mainx, top
+00013530: 6f67 7261 7068 792c 2063 656e 7465 720a  ography, center.
+00013540: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00013550: 2020 2020 2020 7365 6c66 2e74 7261 6e73        self.trans
+00013560: 666f 726d 6174 696f 6e20 3d20 5472 616e  formation = Tran
+00013570: 7366 6f72 6d61 7469 6f6e 286b 696e 642c  sformation(kind,
+00013580: 2078 2c20 792c 2072 6f74 6174 6529 0a0a   x, y, rotate)..
+00013590: 2020 2020 6465 6620 7072 6f6a 6563 745f      def project_
+000135a0: 6461 7461 2873 656c 662c 2064 696d 656e  data(self, dimen
+000135b0: 7369 6f6e 2c20 696e 6469 6365 733d 4e6f  sion, indices=No
+000135c0: 6e65 2c20 5f64 6972 3d4e 6f6e 6529 3a0a  ne, _dir=None):.
+000135d0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+000135e0: 2020 2020 4170 706c 6965 7320 6120 7072      Applies a pr
+000135f0: 6f6a 6563 7469 6f6e 2074 6f20 7468 6520  ojection to the 
+00013600: 6461 7461 2e0a 2020 2020 2020 2020 5468  data..        Th
+00013610: 6520 6e65 7720 4461 7461 7365 7420 7769  e new Dataset wi
+00013620: 6c6c 2068 6176 6520 7468 6520 7361 6d65  ll have the same
+00013630: 2073 697a 6520 6173 2074 6865 2063 686f   size as the cho
+00013640: 7365 6e20 6469 6d65 6e73 696f 6e2c 2077  sen dimension, w
+00013650: 6865 7265 0a20 2020 2020 2020 2074 6865  here.        the
+00013660: 2064 6174 6120 6973 2070 726f 6a65 6374   data is project
+00013670: 6564 206f 6e2e 0a0a 2020 2020 2020 2020  ed on...        
+00013680: 3a70 6172 616d 2064 696d 656e 7369 6f6e  :param dimension
+00013690: 3a20 4469 6d65 6e73 696f 6e73 2074 6f20  : Dimensions to 
+000136a0: 7072 6f6a 6563 7420 7468 6520 6461 7461  project the data
+000136b0: 206f 6e74 6f0a 2020 2020 2020 2020 3a74   onto.        :t
+000136c0: 7970 6520 6469 6d65 6e73 696f 6e3a 2061  ype dimension: a
+000136d0: 7272 6179 5f6c 696b 650a 2020 2020 2020  rray_like.      
+000136e0: 2020 3a70 6172 616d 2069 6e64 6963 6573    :param indices
+000136f0: 3a20 496e 6469 6365 7320 6f66 2074 6865  : Indices of the
+00013700: 2069 6d61 6765 7320 746f 2075 7365 2066   images to use f
+00013710: 6f72 2074 6865 2070 726f 6a65 6374 696f  or the projectio
+00013720: 6e2e 0a20 2020 2020 2020 2020 2020 2049  n..            I
+00013730: 6620 4e6f 6e65 2c20 7468 6520 7072 6f6a  f None, the proj
+00013740: 6563 7469 6f6e 2069 7320 646f 6e65 2075  ection is done u
+00013750: 7369 6e67 2061 6c6c 2064 6174 612e 0a20  sing all data.. 
+00013760: 2020 2020 2020 203a 7479 7065 2069 6e64         :type ind
+00013770: 6963 6573 3a20 556e 696f 6e5b 4e6f 6e65  ices: Union[None
+00013780: 2c20 6172 7261 795f 6c69 6b65 5d0a 2020  , array_like].  
+00013790: 2020 2020 2020 3a70 6172 616d 2073 7472        :param str
+000137a0: 205f 6469 723a 2044 6972 6563 746f 7279   _dir: Directory
+000137b0: 2066 696c 656e 616d 6520 746f 2073 6176   filename to sav
+000137c0: 6520 7468 6520 6e65 7720 6461 7461 0a20  e the new data. 
+000137d0: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
+000137e0: 2020 2020 5f64 6972 203d 2073 656c 662e      _dir = self.
+000137f0: 6469 7220 6966 205f 6469 7220 6973 204e  dir if _dir is N
+00013800: 6f6e 6520 656c 7365 205f 6469 720a 2020  one else _dir.  
+00013810: 2020 2020 2020 6f73 2e6d 616b 6564 6972        os.makedir
+00013820: 7328 5f64 6972 2c20 6578 6973 745f 6f6b  s(_dir, exist_ok
+00013830: 3d54 7275 6529 0a0a 2020 2020 2020 2020  =True)..        
+00013840: 6469 6d73 203d 2041 6371 7569 7369 7469  dims = Acquisiti
+00013850: 6f6e 4469 6d73 2829 0a20 2020 2020 2020  onDims().       
+00013860: 2069 6620 6c65 6e28 6469 6d65 6e73 696f   if len(dimensio
+00013870: 6e29 203d 3d20 313a 0a20 2020 2020 2020  n) == 1:.       
+00013880: 2020 2020 2061 7869 7320 3d20 7365 6c66       axis = self
+00013890: 2e64 696d 732e 6e64 696d 202d 2064 696d  .dims.ndim - dim
+000138a0: 656e 7369 6f6e 5b30 5d20 2d20 310a 2020  ension[0] - 1.  
+000138b0: 2020 2020 2020 2020 2020 6469 6d20 3d20            dim = 
+000138c0: 7365 6c66 2e64 696d 732e 6765 7428 6469  self.dims.get(di
+000138d0: 6d65 6e73 696f 6e5b 305d 290a 2020 2020  mension[0]).    
+000138e0: 2020 2020 2020 2020 6461 7461 203d 205b          data = [
+000138f0: 5d0a 2020 2020 2020 2020 2020 2020 666f  ].            fo
+00013900: 7220 6920 696e 2072 616e 6765 2864 696d  r i in range(dim
+00013910: 2e73 697a 6529 3a0a 2020 2020 2020 2020  .size):.        
+00013920: 2020 2020 2020 2020 5f73 756d 203d 2073          _sum = s
+00013930: 656c 662e 7a73 756d 2869 6e64 6963 6573  elf.zsum(indices
+00013940: 3d69 6e64 6963 6573 2c20 6469 6d65 6e73  =indices, dimens
+00013950: 696f 6e3d 5b64 696d 656e 7369 6f6e 5b30  ion=[dimension[0
+00013960: 5d2c 2069 5d29 0a20 2020 2020 2020 2020  ], i]).         
+00013970: 2020 2020 2020 2069 6620 6c65 6e28 5f73         if len(_s
+00013980: 756d 293a 0a20 2020 2020 2020 2020 2020  um):.           
+00013990: 2020 2020 2020 2020 2064 6174 6120 2b3d           data +=
+000139a0: 205b 5f73 756d 5d0a 2020 2020 2020 2020   [_sum].        
+000139b0: 2020 2020 6469 6d73 2e61 6464 5f64 696d      dims.add_dim
+000139c0: 2830 2c20 6469 6d29 0a20 2020 2020 2020  (0, dim).       
+000139d0: 2065 6c69 6620 6c65 6e28 6469 6d65 6e73   elif len(dimens
+000139e0: 696f 6e29 203d 3d20 323a 0a20 2020 2020  ion) == 2:.     
+000139f0: 2020 2020 2020 2061 7869 7320 3d20 696e         axis = in
+00013a00: 7428 6e75 6d70 792e 7365 7464 6966 6631  t(numpy.setdiff1
+00013a10: 6428 7261 6e67 6528 7365 6c66 2e64 696d  d(range(self.dim
+00013a20: 732e 6e64 696d 292c 2064 696d 656e 7369  s.ndim), dimensi
+00013a30: 6f6e 295b 305d 290a 2020 2020 2020 2020  on)[0]).        
+00013a40: 2020 2020 6469 6d31 203d 2073 656c 662e      dim1 = self.
+00013a50: 6469 6d73 2e67 6574 2864 696d 656e 7369  dims.get(dimensi
+00013a60: 6f6e 5b30 5d29 0a20 2020 2020 2020 2020  on[0]).         
+00013a70: 2020 2064 696d 3220 3d20 7365 6c66 2e64     dim2 = self.d
+00013a80: 696d 732e 6765 7428 6469 6d65 6e73 696f  ims.get(dimensio
+00013a90: 6e5b 315d 290a 2020 2020 2020 2020 2020  n[1]).          
+00013aa0: 2020 6469 6d73 2e61 6464 5f64 696d 2830    dims.add_dim(0
+00013ab0: 2c20 6469 6d31 290a 2020 2020 2020 2020  , dim1).        
+00013ac0: 2020 2020 6469 6d73 2e61 6464 5f64 696d      dims.add_dim
+00013ad0: 2831 2c20 6469 6d32 290a 2020 2020 2020  (1, dim2).      
+00013ae0: 2020 2020 2020 6461 7461 203d 205b 5d0a        data = [].
+00013af0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00013b00: 6920 696e 2072 616e 6765 2864 696d 312e  i in range(dim1.
+00013b10: 7369 7a65 293a 0a20 2020 2020 2020 2020  size):.         
+00013b20: 2020 2020 2020 2066 6f72 206a 2069 6e20         for j in 
+00013b30: 7261 6e67 6528 6469 6d32 2e73 697a 6529  range(dim2.size)
+00013b40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00013b50: 2020 2020 2020 5f73 756d 203d 2073 656c        _sum = sel
+00013b60: 662e 7a73 756d 2869 6e64 6963 6573 3d69  f.zsum(indices=i
+00013b70: 6e64 6963 6573 2c20 6469 6d65 6e73 696f  ndices, dimensio
+00013b80: 6e3d 5b64 696d 656e 7369 6f6e 2c20 5b69  n=[dimension, [i
+00013b90: 2c20 6a5d 5d29 0a20 2020 2020 2020 2020  , j]]).         
+00013ba0: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
+00013bb0: 6e28 5f73 756d 293a 0a20 2020 2020 2020  n(_sum):.       
+00013bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013bd0: 2064 6174 6120 2b3d 205b 5f73 756d 5d0a   data += [_sum].
+00013be0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00013bf0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00013c00: 2056 616c 7565 4572 726f 7228 224f 6e6c   ValueError("Onl
+00013c10: 7920 3144 2061 6e64 2032 4420 7072 6f6a  y 1D and 2D proj
+00013c20: 6563 7469 6f6e 2069 7320 616c 6c6f 7765  ection is allowe
+00013c30: 6422 290a 2020 2020 2020 2020 6469 6d20  d").        dim 
+00013c40: 3d20 7365 6c66 2e64 696d 732e 6765 7428  = self.dims.get(
+00013c50: 6178 6973 290a 2020 2020 2020 2020 6461  axis).        da
+00013c60: 7461 203d 206e 756d 7079 2e61 7272 6179  ta = numpy.array
+00013c70: 2864 6174 6129 2e76 6965 7728 4461 7461  (data).view(Data
+00013c80: 290a 2020 2020 2020 2020 6d65 7461 6461  ).        metada
+00013c90: 7461 203d 206e 756d 7079 2e73 7761 7061  ta = numpy.swapa
+00013ca0: 7865 7328 7365 6c66 2e64 6174 612e 6d65  xes(self.data.me
+00013cb0: 7461 6461 7461 2c20 7365 6c66 2e64 696d  tadata, self.dim
+00013cc0: 732e 6e64 696d 202d 2031 2c20 6178 6973  s.ndim - 1, axis
+00013cd0: 290a 2020 2020 2020 2020 666f 7220 6920  ).        for i 
+00013ce0: 696e 2072 616e 6765 2873 656c 662e 6469  in range(self.di
+00013cf0: 6d73 2e6e 6469 6d20 2d20 6c65 6e28 6469  ms.ndim - len(di
+00013d00: 6d65 6e73 696f 6e29 293a 0a20 2020 2020  mension)):.     
+00013d10: 2020 2020 2020 206d 6574 6164 6174 6120         metadata 
+00013d20: 3d20 6d65 7461 6461 7461 5b30 5d0a 2020  = metadata[0].  
+00013d30: 2020 2020 2020 6461 7461 2e73 6176 6528        data.save(
+00013d40: 0a20 2020 2020 2020 2020 2020 206f 732e  .            os.
+00013d50: 7061 7468 2e6a 6f69 6e28 5f64 6972 2c20  path.join(_dir, 
+00013d60: 2270 726f 6a65 6374 5f22 202b 2064 696d  "project_" + dim
+00013d70: 2e6e 616d 6520 2b20 222e 6864 6635 2229  .name + ".hdf5")
+00013d80: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
+00013d90: 5f6d 656d 6f72 793d 7365 6c66 2e5f 696e  _memory=self._in
+00013da0: 5f6d 656d 6f72 792c 0a20 2020 2020 2020  _memory,.       
+00013db0: 2029 0a20 2020 2020 2020 2064 6174 612e   ).        data.
+00013dc0: 6d65 7461 6461 7461 203d 206d 6574 6164  metadata = metad
+00013dd0: 6174 610a 0a20 2020 2020 2020 2064 6174  ata..        dat
+00013de0: 6173 6574 203d 2044 6174 6173 6574 280a  aset = Dataset(.
+00013df0: 2020 2020 2020 2020 2020 2020 5f64 6972              _dir
+00013e00: 3d5f 6469 722c 0a20 2020 2020 2020 2020  =_dir,.         
+00013e10: 2020 2064 6174 613d 6461 7461 2c0a 2020     data=data,.  
+00013e20: 2020 2020 2020 2020 2020 6469 6d73 3d64            dims=d
+00013e30: 696d 732c 0a20 2020 2020 2020 2020 2020  ims,.           
+00013e40: 2074 7261 6e73 666f 726d 6174 696f 6e3d   transformation=
+00013e50: 7365 6c66 2e74 7261 6e73 666f 726d 6174  self.transformat
+00013e60: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
+00013e70: 2069 6e5f 6d65 6d6f 7279 3d73 656c 662e   in_memory=self.
+00013e80: 5f69 6e5f 6d65 6d6f 7279 2c0a 2020 2020  _in_memory,.    
+00013e90: 2020 2020 2020 2020 7469 746c 653d 7365          title=se
+00013ea0: 6c66 2e74 6974 6c65 2c0a 2020 2020 2020  lf.title,.      
+00013eb0: 2020 290a 0a20 2020 2020 2020 2072 6574    )..        ret
+00013ec0: 7572 6e20 6461 7461 7365 742e 7265 7368  urn dataset.resh
+00013ed0: 6170 655f 6461 7461 2829 0a0a 2020 2020  ape_data()..    
+00013ee0: 6465 6620 636f 6d70 7574 655f 7273 6d28  def compute_rsm(
+00013ef0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+00013f00: 2020 2020 2020 2051 2c0a 2020 2020 2020         Q,.      
+00013f10: 2020 612c 0a20 2020 2020 2020 206d 6170    a,.        map
+00013f20: 5f72 616e 6765 2c0a 2020 2020 2020 2020  _range,.        
+00013f30: 7069 7865 6c5f 7369 7a65 2c0a 2020 2020  pixel_size,.    
+00013f40: 2020 2020 756e 6974 732c 0a20 2020 2020      units,.     
+00013f50: 2020 206e 2c0a 2020 2020 2020 2020 6d61     n,.        ma
+00013f60: 705f 7368 6170 652c 0a20 2020 2020 2020  p_shape,.       
+00013f70: 2065 6e65 7267 793d 3137 2c0a 2020 2020   energy=17,.    
+00013f80: 2020 2020 7472 616e 7366 6f72 6d61 7469      transformati
+00013f90: 6f6e 3d4e 6f6e 652c 0a20 2020 2029 3a0a  on=None,.    ):.
+00013fa0: 2020 2020 2020 2020 6469 6666 7279 203d          diffry =
+00013fb0: 2073 656c 662e 6765 745f 6d65 7461 6461   self.get_metada
+00013fc0: 7461 5f76 616c 7565 7328 504f 5349 5449  ta_values(POSITI
+00013fd0: 4f4e 4552 5f4d 4554 4144 4154 412c 2022  ONER_METADATA, "
+00013fe0: 6469 6666 7279 2229 0a20 2020 2020 2020  diffry").       
+00013ff0: 2069 6620 7472 616e 7366 6f72 6d61 7469   if transformati
+00014000: 6f6e 2069 7320 4e6f 6e65 2061 6e64 2073  on is None and s
+00014010: 656c 662e 7472 616e 7366 6f72 6d61 7469  elf.transformati
+00014020: 6f6e 2069 7320 6e6f 7420 4e6f 6e65 3a0a  on is not None:.
+00014030: 2020 2020 2020 2020 2020 2020 7472 616e              tran
+00014040: 7366 6f72 6d61 7469 6f6e 203d 2073 656c  sformation = sel
+00014050: 662e 7472 616e 7366 6f72 6d61 7469 6f6e  f.transformation
+00014060: 0a20 2020 2020 2020 2065 6c69 6620 7365  .        elif se
+00014070: 6c66 2e74 7261 6e73 666f 726d 6174 696f  lf.transformatio
+00014080: 6e20 6973 204e 6f6e 653a 0a20 2020 2020  n is None:.     
+00014090: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+000140a0: 7565 4572 726f 7228 0a20 2020 2020 2020  ueError(.       
+000140b0: 2020 2020 2020 2020 2022 5472 616e 7366           "Transf
+000140c0: 6f72 6d61 7469 6f6e 2068 6173 2074 6f20  ormation has to 
+000140d0: 6669 7273 7420 6265 2063 6f6d 7075 7465  first be compute
+000140e0: 6420 7573 696e 6720 7468 6520 5472 616e  d using the Tran
+000140f0: 7366 6f72 6d61 7469 6f6e 2057 6964 6765  sformation Widge
+00014100: 7420 2862 6566 6f72 6520 616e 7920 524f  t (before any RO
+00014110: 4929 220a 2020 2020 2020 2020 2020 2020  I)".            
+00014120: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00014130: 6e20 6361 6c63 756c 6174 655f 5253 4d5f  n calculate_RSM_
+00014140: 6869 7374 6f67 7261 6d28 0a20 2020 2020  histogram(.     
+00014150: 2020 2020 2020 2064 6174 613d 7365 6c66         data=self
+00014160: 2e67 6574 5f64 6174 6128 292c 0a20 2020  .get_data(),.   
+00014170: 2020 2020 2020 2020 2064 6966 6672 795f           diffry_
+00014180: 7661 6c75 6573 3d64 6966 6672 792c 0a20  values=diffry,. 
+00014190: 2020 2020 2020 2020 2020 2074 776f 7468             twoth
+000141a0: 6574 613d 7472 616e 7366 6f72 6d61 7469  eta=transformati
+000141b0: 6f6e 2e79 2c0a 2020 2020 2020 2020 2020  on.y,.          
+000141c0: 2020 6574 613d 7472 616e 7366 6f72 6d61    eta=transforma
+000141d0: 7469 6f6e 2e78 2c0a 2020 2020 2020 2020  tion.x,.        
+000141e0: 2020 2020 513d 512c 0a20 2020 2020 2020      Q=Q,.       
+000141f0: 2020 2020 2061 3d61 2c0a 2020 2020 2020       a=a,.      
+00014200: 2020 2020 2020 6d61 705f 7261 6e67 653d        map_range=
+00014210: 6d61 705f 7261 6e67 652c 0a20 2020 2020  map_range,.     
+00014220: 2020 2020 2020 2075 6e69 7473 3d75 6e69         units=uni
+00014230: 7473 2c0a 2020 2020 2020 2020 2020 2020  ts,.            
+00014240: 6d61 705f 7368 6170 653d 6d61 705f 7368  map_shape=map_sh
+00014250: 6170 652c 0a20 2020 2020 2020 2020 2020  ape,.           
+00014260: 206e 3d6e 2c0a 2020 2020 2020 2020 2020   n=n,.          
+00014270: 2020 453d 656e 6572 6779 2c0a 2020 2020    E=energy,.    
+00014280: 2020 2020 290a 0a20 2020 2064 6566 2061      )..    def a
+00014290: 7070 6c79 5f62 696e 6e69 6e67 2873 656c  pply_binning(sel
+000142a0: 662c 2073 6361 6c65 2c20 5f64 6972 3d4e  f, scale, _dir=N
+000142b0: 6f6e 6529 3a0a 2020 2020 2020 2020 5f64  one):.        _d
+000142c0: 6972 203d 2073 656c 662e 6469 7220 6966  ir = self.dir if
+000142d0: 205f 6469 7220 6973 204e 6f6e 6520 656c   _dir is None el
+000142e0: 7365 205f 6469 720a 2020 2020 2020 2020  se _dir.        
+000142f0: 6f73 2e6d 616b 6564 6972 7328 5f64 6972  os.makedirs(_dir
+00014300: 2c20 6578 6973 745f 6f6b 3d54 7275 6529  , exist_ok=True)
+00014310: 0a0a 2020 2020 2020 2020 6461 7461 203d  ..        data =
+00014320: 2072 6573 6361 6c65 5f64 6174 6128 7365   rescale_data(se
+00014330: 6c66 2e67 6574 5f64 6174 6128 292c 2073  lf.get_data(), s
+00014340: 6361 6c65 290a 2020 2020 2020 2020 7368  cale).        sh
+00014350: 6170 6520 3d20 6461 7461 2e73 6861 7065  ape = data.shape
+00014360: 0a20 2020 2020 2020 2064 6174 6120 3d20  .        data = 
+00014370: 6461 7461 2e76 6965 7728 4461 7461 290a  data.view(Data).
+00014380: 2020 2020 2020 2020 6461 7461 2e73 6176          data.sav
+00014390: 6528 0a20 2020 2020 2020 2020 2020 206f  e(.            o
+000143a0: 732e 7061 7468 2e6a 6f69 6e28 5f64 6972  s.path.join(_dir
+000143b0: 2c20 2262 696e 6e65 645f 6461 7461 2e68  , "binned_data.h
+000143c0: 6466 3522 292c 0a20 2020 2020 2020 2020  df5"),.         
+000143d0: 2020 2069 6e5f 6d65 6d6f 7279 3d73 656c     in_memory=sel
+000143e0: 662e 5f69 6e5f 6d65 6d6f 7279 2c0a 2020  f._in_memory,.  
+000143f0: 2020 2020 2020 2020 2020 6e65 775f 7368            new_sh
+00014400: 6170 653d 7368 6170 652c 0a20 2020 2020  ape=shape,.     
+00014410: 2020 2029 0a20 2020 2020 2020 2064 6174     ).        dat
+00014420: 612e 6d65 7461 6461 7461 203d 2073 656c  a.metadata = sel
+00014430: 662e 6461 7461 2e6d 6574 6164 6174 610a  f.data.metadata.
+00014440: 2020 2020 2020 2020 7368 6170 6520 3d20          shape = 
+00014450: 6c69 7374 2873 656c 662e 6461 7461 2e73  list(self.data.s
+00014460: 6861 7065 295b 3a2d 325d 0a20 2020 2020  hape)[:-2].     
+00014470: 2020 2073 6861 7065 2e61 7070 656e 6428     shape.append(
+00014480: 6461 7461 2e73 6861 7065 5b2d 325d 290a  data.shape[-2]).
+00014490: 2020 2020 2020 2020 7368 6170 652e 6170          shape.ap
+000144a0: 7065 6e64 2864 6174 612e 7368 6170 655b  pend(data.shape[
+000144b0: 2d31 5d29 0a20 2020 2020 2020 2064 6174  -1]).        dat
+000144c0: 6120 3d20 6461 7461 2e72 6573 6861 7065  a = data.reshape
+000144d0: 2873 6861 7065 290a 0a20 2020 2020 2020  (shape)..       
+000144e0: 2072 6574 7572 6e20 4461 7461 7365 7428   return Dataset(
+000144f0: 0a20 2020 2020 2020 2020 2020 205f 6469  .            _di
+00014500: 723d 5f64 6972 2c0a 2020 2020 2020 2020  r=_dir,.        
+00014510: 2020 2020 6461 7461 3d64 6174 612c 0a20      data=data,. 
+00014520: 2020 2020 2020 2020 2020 2064 696d 733d             dims=
+00014530: 7365 6c66 2e64 696d 732c 0a20 2020 2020  self.dims,.     
+00014540: 2020 2020 2020 2074 7261 6e73 666f 726d         transform
+00014550: 6174 696f 6e3d 7365 6c66 2e74 7261 6e73  ation=self.trans
+00014560: 666f 726d 6174 696f 6e2c 0a20 2020 2020  formation,.     
+00014570: 2020 2020 2020 2069 6e5f 6d65 6d6f 7279         in_memory
+00014580: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
+00014590: 2020 2074 6974 6c65 3d73 656c 662e 7469     title=self.ti
+000145a0: 746c 652c 0a20 2020 2020 2020 2029 0a0a  tle,.        )..
+000145b0: 2020 2020 6465 6620 7265 636f 7665 725f      def recover_
+000145c0: 7765 616b 5f62 6561 6d28 7365 6c66 2c20  weak_beam(self, 
+000145d0: 6e2c 2069 6e64 6963 6573 3d4e 6f6e 6529  n, indices=None)
+000145e0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+000145f0: 2020 2020 2020 5365 7420 746f 207a 6572        Set to zer
+00014600: 6f20 616c 6c20 7069 7865 6c73 2068 6967  o all pixels hig
+00014610: 6865 7220 7468 616e 206e 2074 696d 6573  her than n times
+00014620: 2074 6865 2073 7461 6e64 6172 6420 6465   the standard de
+00014630: 7669 6174 696f 6e20 6163 726f 7373 2074  viation across t
+00014640: 6865 2073 7461 636b 2064 696d 656e 7369  he stack dimensi
+00014650: 6f6e 0a0a 2020 2020 2020 2020 3a70 6172  on..        :par
+00014660: 616d 206e 3a20 496e 6372 6561 7365 206f  am n: Increase o
+00014670: 7220 6465 6372 6561 7365 2074 6865 2074  r decrease the t
+00014680: 6f70 2074 6872 6573 686f 6c64 2062 7920  op threshold by 
+00014690: 7468 6973 2066 6978 6564 2076 616c 7565  this fixed value
+000146a0: 2e0a 2020 2020 2020 2020 3a74 7970 6520  ..        :type 
+000146b0: 6e3a 2066 6c6f 6174 0a20 2020 2020 2020  n: float.       
+000146c0: 203a 7061 7261 6d20 696e 6469 6365 733a   :param indices:
+000146d0: 2049 6e64 6963 6573 206f 6620 7468 6520   Indices of the 
+000146e0: 696d 6167 6573 2074 6f20 7573 6520 666f  images to use fo
+000146f0: 7220 7468 6520 6669 6c74 6572 696e 672e  r the filtering.
+00014700: 0a20 2020 2020 2020 2020 2020 2049 6620  .            If 
+00014710: 4e6f 6e65 2c20 7468 6520 6669 6c74 6572  None, the filter
+00014720: 696e 6720 6973 2064 6f6e 6520 7573 696e  ing is done usin
+00014730: 6720 616c 6c20 6461 7461 2e0a 2020 2020  g all data..    
+00014740: 2020 2020 3a74 7970 6520 696e 6469 6365      :type indice
+00014750: 733a 2055 6e69 6f6e 5b4e 6f6e 652c 2061  s: Union[None, a
+00014760: 7272 6179 5f6c 696b 655d 0a20 2020 2020  rray_like].     
+00014770: 2020 2022 2222 0a20 2020 2020 2020 2073     """.        s
+00014780: 7464 203d 206e 756d 7079 2e73 7464 2873  td = numpy.std(s
+00014790: 656c 662e 6765 745f 6461 7461 2869 6e64  elf.get_data(ind
+000147a0: 6963 6573 292e 7669 6577 286e 756d 7079  ices).view(numpy
+000147b0: 2e6e 6461 7272 6179 292c 2061 7869 733d  .ndarray), axis=
+000147c0: 3029 0a0a 2020 2020 2020 2020 7265 7475  0)..        retu
+000147d0: 726e 2073 656c 662e 6170 706c 795f 7468  rn self.apply_th
+000147e0: 7265 7368 6f6c 645f 7265 6d6f 7661 6c28  reshold_removal(
+000147f0: 746f 703d 6e20 2a20 7374 642c 2069 6e64  top=n * std, ind
+00014800: 6963 6573 3d69 6e64 6963 6573 290a 0a20  ices=indices).. 
+00014810: 2020 2064 6566 205f 5f64 6565 7063 6f70     def __deepcop
+00014820: 795f 5f28 7365 6c66 2c20 6d65 6d6f 293a  y__(self, memo):
+00014830: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00014840: 2020 2020 2043 7265 6174 6520 636f 7079       Create copy
+00014850: 206f 6620 7468 6520 6461 7461 7365 742e   of the dataset.
+00014860: 2054 6865 2064 6174 6120 6e75 6d70 7920   The data numpy 
+00014870: 6172 7261 7920 6973 2061 6c73 6f20 636f  array is also co
+00014880: 7069 6564 2075 7369 6e67 0a20 2020 2020  pied using.     
+00014890: 2020 2064 6565 7020 636f 7079 2e20 5468     deep copy. Th
+000148a0: 6520 7265 7374 206f 6620 7468 6520 6174  e rest of the at
+000148b0: 7472 6962 7574 6573 2061 7265 2074 6865  tributes are the
+000148c0: 2073 616d 652e 0a20 2020 2020 2020 2022   same..        "
+000148d0: 2222 0a20 2020 2020 2020 2064 6174 6173  "".        datas
+000148e0: 6574 203d 2074 7970 6528 7365 6c66 2928  et = type(self)(
+000148f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00014900: 662e 6469 722c 0a20 2020 2020 2020 2020  f.dir,.         
+00014910: 2020 2064 6174 613d 7365 6c66 2e64 6174     data=self.dat
+00014920: 612c 0a20 2020 2020 2020 2020 2020 2064  a,.            d
+00014930: 696d 733d 7365 6c66 2e5f 5f64 696d 732c  ims=self.__dims,
+00014940: 0a20 2020 2020 2020 2020 2020 2069 6e5f  .            in_
+00014950: 6d65 6d6f 7279 3d73 656c 662e 696e 5f6d  memory=self.in_m
+00014960: 656d 6f72 792c 0a20 2020 2020 2020 2020  emory,.         
+00014970: 2020 2063 6f70 795f 6669 6c65 733d 5472     copy_files=Tr
+00014980: 7565 2c0a 2020 2020 2020 2020 290a 2020  ue,.        ).  
+00014990: 2020 2020 2020 6461 7461 7365 742e 6469        dataset.di
+000149a0: 6d73 203d 2063 6f70 792e 6465 6570 636f  ms = copy.deepco
+000149b0: 7079 2873 656c 662e 5f5f 6469 6d73 2c20  py(self.__dims, 
+000149c0: 6d65 6d6f 290a 2020 2020 2020 2020 7265  memo).        re
+000149d0: 7475 726e 2064 6174 6173 6574 0a0a 0a63  turn dataset...c
+000149e0: 6c61 7373 2044 6174 6128 6e75 6d70 792e  lass Data(numpy.
+000149f0: 6e64 6172 7261 7929 3a0a 2020 2020 2222  ndarray):.    ""
+00014a00: 220a 2020 2020 436c 6173 7320 746f 2073  ".    Class to s
+00014a10: 7472 7563 7475 7265 2074 6865 2064 6174  tructure the dat
+00014a20: 6120 616e 6420 6c69 6e6b 2065 7665 7279  a and link every
+00014a30: 2069 6d61 6765 2077 6974 6820 6974 7320   image with its 
+00014a40: 636f 7272 6573 706f 6e64 696e 6720 7572  corresponding ur
+00014a50: 6c20 616e 640a 2020 2020 6d65 7461 6461  l and.    metada
+00014a60: 7461 2e20 4974 2069 6e68 6572 6974 7320  ta. It inherits 
+00014a70: 6672 6f6d 206e 756d 7079 2e6e 6461 7272  from numpy.ndarr
+00014a80: 6179 2061 6e64 204f 7665 7272 6964 6573  ay and Overrides
+00014a90: 2074 6865 206e 6563 6573 7361 7279 206d   the necessary m
+00014aa0: 6574 686f 6473 2c0a 2020 2020 7461 6b69  ethods,.    taki
+00014ab0: 6e67 2069 6e74 6f20 6163 636f 756e 7420  ng into account 
+00014ac0: 7468 6520 6069 6e5f 6d65 6d6f 7279 6020  the `in_memory` 
+00014ad0: 6174 7472 6962 7574 652e 0a0a 2020 2020  attribute...    
+00014ae0: 3a70 6172 616d 2075 726c 733a 2041 7272  :param urls: Arr
+00014af0: 6179 2077 6974 6820 7468 6520 7572 6c73  ay with the urls
+00014b00: 206f 6620 7468 6520 6461 7461 0a20 2020   of the data.   
+00014b10: 203a 7479 7065 2075 726c 733a 2061 7272   :type urls: arr
+00014b20: 6179 5f6c 696b 650a 2020 2020 3a70 6172  ay_like.    :par
+00014b30: 616d 206d 6574 6164 6174 613a 2041 7272  am metadata: Arr
+00014b40: 6179 2077 6974 6820 7468 6520 6d65 7461  ay with the meta
+00014b50: 6461 7461 206f 6620 7468 6520 6461 7461  data of the data
+00014b60: 0a20 2020 203a 7479 7065 206d 6574 6164  .    :type metad
+00014b70: 6174 613a 2061 7272 6179 5f6c 696b 650a  ata: array_like.
+00014b80: 2020 2020 3a70 6172 616d 2069 6e5f 6d65      :param in_me
+00014b90: 6d6f 7279 3a20 4966 2054 7275 652c 2074  mory: If True, t
+00014ba0: 6865 2064 6174 6120 6973 206c 6f61 6465  he data is loade
+00014bb0: 6420 696e 746f 206d 656d 6f72 792c 2064  d into memory, d
+00014bc0: 6566 6175 6c74 2054 7275 650a 2020 2020  efault True.    
+00014bd0: 3a74 7970 6520 696e 5f6d 656d 6f72 793a  :type in_memory:
+00014be0: 2062 6f6f 6c2c 206f 7074 696f 6e61 6c0a   bool, optional.
+00014bf0: 2020 2020 2222 220a 0a20 2020 2064 6566      """..    def
+00014c00: 205f 5f6e 6577 5f5f 2863 6c73 2c20 7572   __new__(cls, ur
+00014c10: 6c73 2c20 6d65 7461 6461 7461 2c20 696e  ls, metadata, in
+00014c20: 5f6d 656d 6f72 793d 5472 7565 2c20 6461  _memory=True, da
+00014c30: 7461 3d4e 6f6e 6529 3a0a 2020 2020 2020  ta=None):.      
+00014c40: 2020 7572 6c73 203d 206e 756d 7079 2e61    urls = numpy.a
+00014c50: 7361 7272 6179 2875 726c 7329 0a20 2020  sarray(urls).   
+00014c60: 2020 2020 2069 6d67 5f73 6861 7065 203d       img_shape =
+00014c70: 204e 6f6e 650a 2020 2020 2020 2020 6966   None.        if
+00014c80: 2069 6e5f 6d65 6d6f 7279 3a0a 2020 2020   in_memory:.    
+00014c90: 2020 2020 2020 2020 2320 4c6f 6164 2061          # Load a
+00014ca0: 6c6c 2069 6d61 6765 7320 696e 206d 656d  ll images in mem
+00014cb0: 6f72 790a 2020 2020 2020 2020 2020 2020  ory.            
+00014cc0: 6966 2064 6174 6120 6973 206e 6f74 204e  if data is not N
+00014cd0: 6f6e 6520 616e 6420 7572 6c73 2e73 6861  one and urls.sha
+00014ce0: 7065 2021 3d20 6461 7461 2e73 6861 7065  pe != data.shape
+00014cf0: 5b3a 2d32 5d3a 0a20 2020 2020 2020 2020  [:-2]:.         
+00014d00: 2020 2020 2020 2064 6174 6120 3d20 4e6f         data = No
+00014d10: 6e65 0a20 2020 2020 2020 2020 2020 2069  ne.            i
+00014d20: 6620 6461 7461 2069 7320 4e6f 6e65 3a0a  f data is None:.
+00014d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014d40: 7572 6c5f 7368 6170 6520 3d20 7572 6c73  url_shape = urls
+00014d50: 2e73 6861 7065 0a20 2020 2020 2020 2020  .shape.         
+00014d60: 2020 2020 2020 2075 726c 5f69 6478 7320         url_idxs 
+00014d70: 3d20 6e75 6d70 792e 756e 7261 7665 6c5f  = numpy.unravel_
+00014d80: 696e 6465 7828 6e75 6d70 792e 6172 616e  index(numpy.aran
+00014d90: 6765 2875 726c 732e 7369 7a65 292c 2075  ge(urls.size), u
+00014da0: 726c 5f73 6861 7065 290a 2020 2020 2020  rl_shape).      
+00014db0: 2020 2020 2020 2020 2020 6966 2075 726c            if url
+00014dc0: 732e 7369 7a65 203d 3d20 303a 0a20 2020  s.size == 0:.   
+00014dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014de0: 2064 6174 6120 3d20 6e75 6d70 792e 656d   data = numpy.em
+00014df0: 7074 7928 7572 6c5f 7368 6170 6520 2b20  pty(url_shape + 
+00014e00: 2830 2c20 3029 290a 2020 2020 2020 2020  (0, 0)).        
+00014e10: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00014e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014e30: 2020 696d 6720 3d20 7574 696c 732e 6765    img = utils.ge
+00014e40: 745f 6461 7461 286e 6578 7428 7572 6c73  t_data(next(urls
+00014e50: 2e66 6c61 7429 290a 2020 2020 2020 2020  .flat)).        
+00014e60: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00014e70: 203d 206e 756d 7079 2e65 6d70 7479 2875   = numpy.empty(u
+00014e80: 726c 5f73 6861 7065 202b 2069 6d67 2e73  rl_shape + img.s
+00014e90: 6861 7065 2c20 696d 672e 6474 7970 6529  hape, img.dtype)
+00014ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014eb0: 2020 2020 2066 6f72 2075 726c 2c20 2a75       for url, *u
+00014ec0: 726c 5f69 6478 2069 6e20 7a69 7028 7572  rl_idx in zip(ur
+00014ed0: 6c73 2e66 6c61 742c 202a 7572 6c5f 6964  ls.flat, *url_id
+00014ee0: 7873 293a 0a20 2020 2020 2020 2020 2020  xs):.           
+00014ef0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+00014f00: 615b 7475 706c 6528 7572 6c5f 6964 7829  a[tuple(url_idx)
+00014f10: 5d20 3d20 7574 696c 732e 6765 745f 6461  ] = utils.get_da
+00014f20: 7461 2875 726c 290a 2020 2020 2020 2020  ta(url).        
+00014f30: 2020 2020 6f62 6a20 3d20 6461 7461 2e76      obj = data.v
+00014f40: 6965 7728 636c 7329 0a20 2020 2020 2020  iew(cls).       
+00014f50: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00014f60: 2020 2023 2041 6363 6573 7320 696d 6167     # Access imag
+00014f70: 6520 6f6e 6520 6174 2061 2074 696d 6520  e one at a time 
+00014f80: 7573 696e 6720 7572 6c0a 2020 2020 2020  using url.      
+00014f90: 2020 2020 2020 6f62 6a20 3d20 7375 7065        obj = supe
+00014fa0: 7228 292e 5f5f 6e65 775f 5f28 636c 732c  r().__new__(cls,
+00014fb0: 2075 726c 732e 7368 6170 6529 0a0a 2020   urls.shape)..  
+00014fc0: 2020 2020 2020 6f62 6a2e 696e 5f6d 656d        obj.in_mem
+00014fd0: 6f72 7920 3d20 696e 5f6d 656d 6f72 790a  ory = in_memory.
+00014fe0: 2020 2020 2020 2020 6f62 6a2e 7572 6c73          obj.urls
+00014ff0: 203d 2075 726c 730a 2020 2020 2020 2020   = urls.        
+00015000: 6f62 6a2e 6d65 7461 6461 7461 203d 206e  obj.metadata = n
+00015010: 756d 7079 2e61 7361 7272 6179 286d 6574  umpy.asarray(met
+00015020: 6164 6174 6129 0a20 2020 2020 2020 206f  adata).        o
+00015030: 626a 2e5f 6669 6c65 203d 204e 6f6e 650a  bj._file = None.
+00015040: 2020 2020 2020 2020 6f62 6a2e 5f69 6d67          obj._img
+00015050: 5f73 6861 7065 203d 2069 6d67 5f73 6861  _shape = img_sha
+00015060: 7065 0a20 2020 2020 2020 206f 626a 2e73  pe.        obj.s
+00015070: 7461 7465 5f6f 665f 6f70 6572 6174 696f  tate_of_operatio
+00015080: 6e73 203d 205f 5374 6174 654f 664f 7065  ns = _StateOfOpe
+00015090: 7261 7469 6f6e 7328 290a 0a20 2020 2020  rations()..     
+000150a0: 2020 2072 6574 7572 6e20 6f62 6a0a 0a20     return obj.. 
+000150b0: 2020 2064 6566 205f 5f61 7272 6179 5f66     def __array_f
+000150c0: 696e 616c 697a 655f 5f28 7365 6c66 2c20  inalize__(self, 
+000150d0: 6f62 6a29 3a0a 2020 2020 2020 2020 6966  obj):.        if
+000150e0: 206f 626a 2069 7320 4e6f 6e65 3a0a 2020   obj is None:.  
+000150f0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00015100: 0a20 2020 2020 2020 2073 656c 662e 7572  .        self.ur
+00015110: 6c73 203d 2067 6574 6174 7472 286f 626a  ls = getattr(obj
+00015120: 2c20 2275 726c 7322 2c20 4e6f 6e65 290a  , "urls", None).
+00015130: 2020 2020 2020 2020 7365 6c66 2e6d 6574          self.met
+00015140: 6164 6174 6120 3d20 6765 7461 7474 7228  adata = getattr(
+00015150: 6f62 6a2c 2022 6d65 7461 6461 7461 222c  obj, "metadata",
+00015160: 204e 6f6e 6529 0a20 2020 2020 2020 2073   None).        s
+00015170: 656c 662e 696e 5f6d 656d 6f72 7920 3d20  elf.in_memory = 
+00015180: 6765 7461 7474 7228 6f62 6a2c 2022 696e  getattr(obj, "in
+00015190: 5f6d 656d 6f72 7922 2c20 4e6f 6e65 290a  _memory", None).
+000151a0: 0a20 2020 2064 6566 205f 5f67 6574 6974  .    def __getit
+000151b0: 656d 5f5f 2873 656c 662c 2069 6e64 6963  em__(self, indic
+000151c0: 6573 293a 0a20 2020 2020 2020 2022 2222  es):.        """
+000151d0: 0a20 2020 2020 2020 2052 6574 7572 6e20  .        Return 
+000151e0: 7365 6c66 5b69 6e64 6963 6573 5d0a 2020  self[indices].  
+000151f0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00015200: 2020 6966 2073 656c 662e 696e 5f6d 656d    if self.in_mem
+00015210: 6f72 793a 0a20 2020 2020 2020 2020 2020  ory:.           
+00015220: 2064 6174 6120 3d20 7375 7065 7228 292e   data = super().
+00015230: 5f5f 6765 7469 7465 6d5f 5f28 696e 6469  __getitem__(indi
+00015240: 6365 7329 0a20 2020 2020 2020 2020 2020  ces).           
+00015250: 2069 6620 6c65 6e28 6461 7461 2e73 6861   if len(data.sha
+00015260: 7065 2920 3c20 333a 0a20 2020 2020 2020  pe) < 3:.       
+00015270: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
+00015280: 6461 7461 2e76 6965 7728 6e75 6d70 792e  data.view(numpy.
+00015290: 6e64 6172 7261 7929 0a20 2020 2020 2020  ndarray).       
+000152a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000152b0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+000152c0: 696e 7374 616e 6365 2869 6e64 6963 6573  instance(indices
+000152d0: 2c20 7475 706c 6529 3a0a 2020 2020 2020  , tuple):.      
+000152e0: 2020 2020 2020 2020 2020 2020 2020 6461                da
+000152f0: 7461 2e75 726c 7320 3d20 7365 6c66 2e75  ta.urls = self.u
+00015300: 726c 735b 696e 6469 6365 735b 305d 5d0a  rls[indices[0]].
+00015310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015320: 2020 2020 6461 7461 2e6d 6574 6164 6174      data.metadat
+00015330: 6120 3d20 7365 6c66 2e6d 6574 6164 6174  a = self.metadat
+00015340: 615b 696e 6469 6365 735b 305d 5d0a 2020  a[indices[0]].  
+00015350: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00015360: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00015370: 2020 2020 2020 2020 6461 7461 2e75 726c          data.url
+00015380: 7320 3d20 7365 6c66 2e75 726c 735b 696e  s = self.urls[in
+00015390: 6469 6365 735d 0a20 2020 2020 2020 2020  dices].         
+000153a0: 2020 2020 2020 2020 2020 2064 6174 612e             data.
+000153b0: 6d65 7461 6461 7461 203d 2073 656c 662e  metadata = self.
+000153c0: 6d65 7461 6461 7461 5b69 6e64 6963 6573  metadata[indices
+000153d0: 5d0a 2020 2020 2020 2020 2020 2020 7265  ].            re
+000153e0: 7475 726e 2064 6174 610a 2020 2020 2020  turn data.      
+000153f0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00015400: 696e 6469 6365 732c 2074 7570 6c65 293a  indices, tuple):
+00015410: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00015420: 6e6f 7420 6973 696e 7374 616e 6365 2873  not isinstance(s
+00015430: 656c 662e 7572 6c73 5b69 6e64 6963 6573  elf.urls[indices
+00015440: 5b30 5d5d 2c20 6e75 6d70 792e 6e64 6172  [0]], numpy.ndar
+00015450: 7261 7929 3a0a 2020 2020 2020 2020 2020  ray):.          
+00015460: 2020 2020 2020 7265 7475 726e 2075 7469        return uti
+00015470: 6c73 2e67 6574 5f64 6174 6128 7365 6c66  ls.get_data(self
+00015480: 2e75 726c 735b 696e 6469 6365 735b 305d  .urls[indices[0]
+00015490: 5d29 5b69 6e64 6963 6573 5b31 5d2c 2069  ])[indices[1], i
+000154a0: 6e64 6963 6573 5b32 5d5d 0a20 2020 2020  ndices[2]].     
+000154b0: 2020 2020 2020 2072 6574 7572 6e20 4461         return Da
+000154c0: 7461 2873 656c 662e 7572 6c73 5b69 6e64  ta(self.urls[ind
+000154d0: 6963 6573 5b30 5d5d 2c20 7365 6c66 2e6d  ices[0]], self.m
+000154e0: 6574 6164 6174 615b 696e 6469 6365 735d  etadata[indices]
+000154f0: 2c20 7365 6c66 2e69 6e5f 6d65 6d6f 7279  , self.in_memory
+00015500: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+00015510: 2069 7369 6e73 7461 6e63 6528 7365 6c66   isinstance(self
+00015520: 2e75 726c 735b 696e 6469 6365 735d 2c20  .urls[indices], 
+00015530: 6e75 6d70 792e 6e64 6172 7261 7929 3a0a  numpy.ndarray):.
+00015540: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00015550: 726e 2075 7469 6c73 2e67 6574 5f64 6174  rn utils.get_dat
+00015560: 6128 7365 6c66 2e75 726c 735b 696e 6469  a(self.urls[indi
+00015570: 6365 735d 290a 2020 2020 2020 2020 7265  ces]).        re
+00015580: 7475 726e 2044 6174 6128 7365 6c66 2e75  turn Data(self.u
+00015590: 726c 735b 696e 6469 6365 735d 2c20 7365  rls[indices], se
+000155a0: 6c66 2e6d 6574 6164 6174 615b 696e 6469  lf.metadata[indi
+000155b0: 6365 735d 2c20 7365 6c66 2e69 6e5f 6d65  ces], self.in_me
+000155c0: 6d6f 7279 290a 0a20 2020 2064 6566 205f  mory)..    def _
+000155d0: 6974 6572 5f66 7261 6d65 7328 7365 6c66  iter_frames(self
+000155e0: 2920 2d3e 2047 656e 6572 6174 6f72 5b6e  ) -> Generator[n
+000155f0: 756d 7079 2e6e 6461 7272 6179 2c20 4e6f  umpy.ndarray, No
+00015600: 6e65 2c20 4e6f 6e65 5d3a 0a20 2020 2020  ne, None]:.     
+00015610: 2020 2069 6620 7365 6c66 2e69 6e5f 6d65     if self.in_me
+00015620: 6d6f 7279 3a0a 2020 2020 2020 2020 2020  mory:.          
+00015630: 2020 6673 6861 7065 203d 2028 7365 6c66    fshape = (self
+00015640: 2e6e 6672 616d 6573 2c29 202b 2073 656c  .nframes,) + sel
+00015650: 662e 6672 616d 655f 7368 6170 650a 2020  f.frame_shape.  
+00015660: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
+00015670: 6672 6f6d 2073 7570 6572 2829 2e72 6573  from super().res
+00015680: 6861 7065 2866 7368 6170 6529 0a20 2020  hape(fshape).   
+00015690: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000156a0: 2020 2020 2020 2066 6f72 2075 726c 2069         for url i
+000156b0: 6e20 7365 6c66 2e75 726c 732e 666c 6174  n self.urls.flat
+000156c0: 7465 6e28 293a 0a20 2020 2020 2020 2020  ten():.         
+000156d0: 2020 2020 2020 2079 6965 6c64 2075 7469         yield uti
+000156e0: 6c73 2e67 6574 5f64 6174 6128 7572 6c29  ls.get_data(url)
+000156f0: 0a0a 2020 2020 6465 6620 5f5f 7265 6475  ..    def __redu
+00015700: 6365 5f5f 2873 656c 6629 3a0a 2020 2020  ce__(self):.    
+00015710: 2020 2020 2320 4765 7420 7468 6520 7061      # Get the pa
+00015720: 7265 6e74 2773 205f 5f72 6564 7563 655f  rent's __reduce_
+00015730: 5f20 7475 706c 650a 2020 2020 2020 2020  _ tuple.        
+00015740: 7069 636b 6c65 645f 7374 6174 6520 3d20  pickled_state = 
+00015750: 7375 7065 7228 292e 5f5f 7265 6475 6365  super().__reduce
+00015760: 5f5f 2829 0a20 2020 2020 2020 2023 2043  __().        # C
+00015770: 7265 6174 6520 6f75 7220 6f77 6e20 7475  reate our own tu
+00015780: 706c 6520 746f 2070 6173 7320 746f 205f  ple to pass to _
+00015790: 5f73 6574 7374 6174 655f 5f0a 2020 2020  _setstate__.    
+000157a0: 2020 2020 6e65 775f 7374 6174 6520 3d20      new_state = 
+000157b0: 7069 636b 6c65 645f 7374 6174 655b 325d  pickled_state[2]
+000157c0: 202b 2028 2873 656c 662e 7572 6c73 2c20   + ((self.urls, 
+000157d0: 7365 6c66 2e6d 6574 6164 6174 612c 2073  self.metadata, s
+000157e0: 656c 662e 696e 5f6d 656d 6f72 7929 2c29  elf.in_memory),)
+000157f0: 0a20 2020 2020 2020 2023 2052 6574 7572  .        # Retur
+00015800: 6e20 6120 7475 706c 6520 7468 6174 2072  n a tuple that r
+00015810: 6570 6c61 6365 7320 7468 6520 7061 7265  eplaces the pare
+00015820: 6e74 2773 205f 5f73 6574 7374 6174 655f  nt's __setstate_
+00015830: 5f20 7475 706c 6520 7769 7468 206f 7572  _ tuple with our
+00015840: 206f 776e 0a20 2020 2020 2020 2072 6574   own.        ret
+00015850: 7572 6e20 2870 6963 6b6c 6564 5f73 7461  urn (pickled_sta
+00015860: 7465 5b30 5d2c 2070 6963 6b6c 6564 5f73  te[0], pickled_s
+00015870: 7461 7465 5b31 5d2c 206e 6577 5f73 7461  tate[1], new_sta
+00015880: 7465 290a 0a20 2020 2064 6566 205f 5f73  te)..    def __s
+00015890: 6574 7374 6174 655f 5f28 7365 6c66 2c20  etstate__(self, 
+000158a0: 7374 6174 6529 3a0a 2020 2020 2020 2020  state):.        
+000158b0: 7365 6c66 2e75 726c 732c 2073 656c 662e  self.urls, self.
+000158c0: 6d65 7461 6461 7461 2c20 7365 6c66 2e69  metadata, self.i
+000158d0: 6e5f 6d65 6d6f 7279 203d 2073 7461 7465  n_memory = state
+000158e0: 5b2d 315d 2020 2320 5365 7420 7468 6520  [-1]  # Set the 
+000158f0: 6174 7472 6962 7574 6573 0a20 2020 2020  attributes.     
+00015900: 2020 2073 7570 6572 2829 2e5f 5f73 6574     super().__set
+00015910: 7374 6174 655f 5f28 7374 6174 655b 303a  state__(state[0:
+00015920: 2d31 5d29 0a0a 2020 2020 6465 6620 7374  -1])..    def st
+00015930: 6f70 5f6f 7065 7261 7469 6f6e 2873 656c  op_operation(sel
+00015940: 662c 206f 7065 7261 7469 6f6e 3a20 4f70  f, operation: Op
+00015950: 6572 6174 696f 6e29 3a0a 2020 2020 2020  eration):.      
+00015960: 2020 2222 220a 2020 2020 2020 2020 4d65    """.        Me
+00015970: 7468 6f64 2075 7365 6420 666f 7220 6361  thod used for ca
+00015980: 7365 7320 7768 6572 6520 7468 7265 6164  ses where thread
+00015990: 7320 6172 6520 6372 6561 7465 6420 746f  s are created to
+000159a0: 2061 7070 6c79 2066 756e 6374 696f 6e73   apply functions
+000159b0: 2074 6f20 7468 6520 6461 7461 2e0a 2020   to the data..  
+000159c0: 2020 2020 2020 4966 206d 6574 686f 6420        If method 
+000159d0: 6973 2063 616c 6c65 642c 2074 6865 2066  is called, the f
+000159e0: 6c61 6720 636f 6e63 6572 6e69 6e67 2074  lag concerning t
+000159f0: 6865 2073 746f 7020 6973 2073 6574 2074  he stop is set t
+00015a00: 6f20 3020 736f 2074 6861 7420 6966 2074  o 0 so that if t
+00015a10: 6865 2063 6f6e 6365 726e 6564 0a20 2020  he concerned.   
+00015a20: 2020 2020 206f 7065 7261 7469 6f6e 2069       operation i
+00015a30: 7320 7275 6e6e 696e 6720 696e 2061 6e6f  s running in ano
+00015a40: 7468 6572 2074 6872 6561 6420 6974 206b  ther thread it k
+00015a50: 6e6f 7773 2074 6f20 7374 6f70 2e0a 0a20  nows to stop... 
+00015a60: 2020 2020 2020 203a 7061 7261 6d20 696e         :param in
+00015a70: 7420 6f70 6572 6174 696f 6e3a 206f 7065  t operation: ope
+00015a80: 7261 7469 6f6e 2074 6f20 7374 6f70 0a20  ration to stop. 
+00015a90: 2020 2020 2020 203a 7479 7065 2069 6e74         :type int
+00015aa0: 3a20 556e 696f 6e5b 696e 742c 2060 4f70  : Union[int, `Op
+00015ab0: 6572 6174 696f 6e60 5d0a 2020 2020 2020  eration`].      
+00015ac0: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+00015ad0: 2068 6173 6174 7472 2873 656c 662c 2022   hasattr(self, "
+00015ae0: 7374 6174 655f 6f66 5f6f 7065 7261 7469  state_of_operati
+00015af0: 6f6e 7322 2920 616e 6420 7365 6c66 2e73  ons") and self.s
+00015b00: 7461 7465 5f6f 665f 6f70 6572 6174 696f  tate_of_operatio
+00015b10: 6e73 2e69 735f 7275 6e6e 696e 6728 0a20  ns.is_running(. 
+00015b20: 2020 2020 2020 2020 2020 206f 7065 7261             opera
+00015b30: 7469 6f6e 0a20 2020 2020 2020 2029 3a0a  tion.        ):.
+00015b40: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00015b50: 2e73 7461 7465 5f6f 665f 6f70 6572 6174  .state_of_operat
+00015b60: 696f 6e73 2e73 746f 7028 6f70 6572 6174  ions.stop(operat
+00015b70: 696f 6e29 0a0a 2020 2020 4070 726f 7065  ion)..    @prope
+00015b80: 7274 790a 2020 2020 6465 6620 7368 6170  rty.    def shap
+00015b90: 6528 7365 6c66 2920 2d3e 2054 7570 6c65  e(self) -> Tuple
+00015ba0: 5b69 6e74 5d3a 0a20 2020 2020 2020 2022  [int]:.        "
+00015bb0: 2222 546f 7461 6c20 7368 6170 6520 3d20  ""Total shape = 
+00015bc0: 7363 616e 2073 6861 7065 202b 2066 7261  scan shape + fra
+00015bd0: 6d65 2073 6861 7065 2222 220a 2020 2020  me shape""".    
+00015be0: 2020 2020 7368 6170 6520 3d20 7375 7065      shape = supe
+00015bf0: 7228 292e 7368 6170 650a 2020 2020 2020  r().shape.      
+00015c00: 2020 6966 2073 656c 662e 696e 5f6d 656d    if self.in_mem
+00015c10: 6f72 793a 0a20 2020 2020 2020 2020 2020  ory:.           
+00015c20: 2072 6574 7572 6e20 7368 6170 650a 2020   return shape.  
+00015c30: 2020 2020 2020 7265 7475 726e 2073 6861        return sha
+00015c40: 7065 202b 2073 656c 662e 6672 616d 655f  pe + self.frame_
+00015c50: 7368 6170 650a 0a20 2020 2040 7072 6f70  shape..    @prop
+00015c60: 6572 7479 0a20 2020 2064 6566 2073 6361  erty.    def sca
+00015c70: 6e5f 7368 6170 6528 7365 6c66 2920 2d3e  n_shape(self) ->
+00015c80: 2054 7570 6c65 5b69 6e74 5d3a 0a20 2020   Tuple[int]:.   
+00015c90: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00015ca0: 2e73 6861 7065 5b3a 2d32 5d0a 0a20 2020  .shape[:-2]..   
+00015cb0: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+00015cc0: 6566 2066 7261 6d65 5f73 6861 7065 2873  ef frame_shape(s
+00015cd0: 656c 6629 202d 3e20 5475 706c 655b 696e  elf) -> Tuple[in
+00015ce0: 742c 2069 6e74 5d3a 0a20 2020 2020 2020  t, int]:.       
+00015cf0: 2069 6620 7365 6c66 2e69 6e5f 6d65 6d6f   if self.in_memo
+00015d00: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00015d10: 7265 7475 726e 2073 7570 6572 2829 2e73  return super().s
+00015d20: 6861 7065 5b2d 323a 5d0a 2020 2020 2020  hape[-2:].      
+00015d30: 2020 6966 2073 656c 662e 5f69 6d67 5f73    if self._img_s
+00015d40: 6861 7065 2069 7320 6e6f 7420 4e6f 6e65  hape is not None
+00015d50: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00015d60: 7475 726e 2073 656c 662e 5f69 6d67 5f73  turn self._img_s
+00015d70: 6861 7065 0a20 2020 2020 2020 2069 6620  hape.        if 
+00015d80: 7365 6c66 2e6e 6672 616d 6573 203d 3d20  self.nframes == 
+00015d90: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
+00015da0: 6574 7572 6e20 302c 2030 0a20 2020 2020  eturn 0, 0.     
+00015db0: 2020 2069 6d67 5f73 6861 7065 203d 2075     img_shape = u
+00015dc0: 7469 6c73 2e67 6574 5f64 6174 6128 6e65  tils.get_data(ne
+00015dd0: 7874 2873 656c 662e 7572 6c73 2e66 6c61  xt(self.urls.fla
+00015de0: 7429 292e 7368 6170 650a 2020 2020 2020  t)).shape.      
+00015df0: 2020 7365 6c66 2e5f 696d 675f 7368 6170    self._img_shap
+00015e00: 6520 3d20 696d 675f 7368 6170 650a 2020  e = img_shape.  
+00015e10: 2020 2020 2020 7265 7475 726e 2069 6d67        return img
+00015e20: 5f73 6861 7065 0a0a 2020 2020 4070 726f  _shape..    @pro
+00015e30: 7065 7274 790a 2020 2020 6465 6620 6e66  perty.    def nf
+00015e40: 7261 6d65 7328 7365 6c66 2920 2d3e 2069  rames(self) -> i
+00015e50: 6e74 3a0a 2020 2020 2020 2020 6966 2073  nt:.        if s
+00015e60: 656c 662e 7572 6c73 2069 7320 4e6f 6e65  elf.urls is None
+00015e70: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00015e80: 7475 726e 2030 0a20 2020 2020 2020 2072  turn 0.        r
+00015e90: 6574 7572 6e20 7365 6c66 2e75 726c 732e  eturn self.urls.
+00015ea0: 7369 7a65 0a0a 2020 2020 4070 726f 7065  size..    @prope
+00015eb0: 7274 790a 2020 2020 6465 6620 6e64 696d  rty.    def ndim
+00015ec0: 2873 656c 6629 202d 3e20 696e 743a 0a20  (self) -> int:. 
+00015ed0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00015ee0: 2020 204e 756d 6265 7220 6f66 2061 7272     Number of arr
+00015ef0: 6179 2064 696d 656e 7369 6f6e 732e 0a20  ay dimensions.. 
+00015f00: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00015f10: 2020 2069 6620 7365 6c66 2e69 6e5f 6d65     if self.in_me
+00015f20: 6d6f 7279 3a0a 2020 2020 2020 2020 2020  mory:.          
+00015f30: 2020 7265 7475 726e 2073 7570 6572 2829    return super()
+00015f40: 2e6e 6469 6d0a 2020 2020 2020 2020 7265  .ndim.        re
+00015f50: 7475 726e 2073 7570 6572 2829 2e6e 6469  turn super().ndi
+00015f60: 6d20 2b20 320a 0a20 2020 2064 6566 2061  m + 2..    def a
+00015f70: 7070 6c79 5f66 756e 6373 280a 2020 2020  pply_funcs(.    
+00015f80: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00015f90: 2020 6675 6e63 733d 5b5d 2c0a 2020 2020    funcs=[],.    
+00015fa0: 2020 2020 696e 6469 6365 733d 4e6f 6e65      indices=None
+00015fb0: 2c0a 2020 2020 2020 2020 7361 7665 3d46  ,.        save=F
+00015fc0: 616c 7365 2c0a 2020 2020 2020 2020 7465  alse,.        te
+00015fd0: 7874 3d22 222c 0a20 2020 2020 2020 206f  xt="",.        o
+00015fe0: 7065 7261 7469 6f6e 3d4e 6f6e 652c 0a20  peration=None,. 
+00015ff0: 2020 2020 2020 206e 6577 5f73 6861 7065         new_shape
+00016000: 3d4e 6f6e 652c 0a20 2020 2029 3a0a 2020  =None,.    ):.  
+00016010: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00016020: 2020 4d65 7468 6f64 2074 6861 7420 6170    Method that ap
+00016030: 706c 6965 7320 6120 7365 7269 6573 206f  plies a series o
+00016040: 6620 6675 6e63 7469 6f6e 7320 696e 746f  f functions into
+00016050: 2074 6865 2064 6174 612e 2049 7420 6361   the data. It ca
+00016060: 6e20 7361 7665 2074 6865 2069 6d61 6765  n save the image
+00016070: 730a 2020 2020 2020 2020 696e 746f 2064  s.        into d
+00016080: 6973 6b20 6f72 2072 6574 7572 6e20 7468  isk or return th
+00016090: 656d 2e0a 0a20 2020 2020 2020 203a 7061  em...        :pa
+000160a0: 7261 6d20 6675 6e63 733a 204c 6973 7420  ram funcs: List 
+000160b0: 6f66 2074 7570 706c 6573 2e20 4576 6572  of tupples. Ever
+000160c0: 7920 7475 7070 6c65 7320 636f 6e74 6169  y tupples contai
+000160d0: 6e73 2074 6865 2066 756e 6374 696f 6e20  ns the function 
+000160e0: 746f 0a20 2020 2020 2020 2020 2020 2061  to.            a
+000160f0: 7070 6c79 2061 6e64 2069 7473 2070 6172  pply and its par
+00016100: 616d 6574 6572 732c 2064 6566 6175 6c74  ameters, default
+00016110: 7320 746f 205b 5d0a 2020 2020 2020 2020  s to [].        
+00016120: 3a74 7970 6520 6675 6e63 733a 2061 7272  :type funcs: arr
+00016130: 6179 5f6c 696b 652c 206f 7074 696f 6e61  ay_like, optiona
+00016140: 6c0a 2020 2020 2020 2020 3a70 6172 616d  l.        :param
+00016150: 2069 6e64 6963 6573 3a20 496e 6469 6365   indices: Indice
+00016160: 7320 6f66 2074 6865 2064 6174 6120 746f  s of the data to
+00016170: 2061 7070 6c79 2074 6865 2066 756e 6374   apply the funct
+00016180: 696f 6e73 2074 6f2c 0a20 2020 2020 2020  ions to,.       
+00016190: 2020 2020 2064 6566 6175 6c74 7320 746f       defaults to
+000161a0: 204e 6f6e 650a 2020 2020 2020 2020 3a74   None.        :t
+000161b0: 7970 6520 696e 6469 6365 733a 2055 6e69  ype indices: Uni
+000161c0: 6f6e 5b4e 6f6e 652c 2061 7272 6179 5f6c  on[None, array_l
+000161d0: 696b 655d 2c20 6f70 7469 6f6e 616c 0a20  ike], optional. 
+000161e0: 2020 2020 2020 203a 7061 7261 6d20 7361         :param sa
+000161f0: 7665 3a20 4966 2054 7275 652c 2073 6176  ve: If True, sav
+00016200: 6573 2074 6865 2069 6d61 6765 7320 696e  es the images in
+00016210: 746f 2064 6973 6b2c 2064 6566 6175 6c74  to disk, default
+00016220: 7320 746f 2046 616c 7365 0a20 2020 2020  s to False.     
+00016230: 2020 203a 7479 7065 2073 6176 653a 2062     :type save: b
+00016240: 6f6f 6c0a 2020 2020 2020 2020 3a70 6172  ool.        :par
+00016250: 616d 2073 7472 2074 6578 743a 2054 6578  am str text: Tex
+00016260: 7420 746f 2073 686f 7720 696e 2074 6865  t to show in the
+00016270: 2061 6476 616e 6365 6d65 6e74 2064 6973   advancement dis
+00016280: 706c 6179 2e0a 2020 2020 2020 2020 3a70  play..        :p
+00016290: 6172 616d 2069 6e74 206f 7065 7261 7469  aram int operati
+000162a0: 6f6e 3a20 6f70 6572 6174 696f 6e20 746f  on: operation to
+000162b0: 2073 746f 700a 2020 2020 2020 2020 3a74   stop.        :t
+000162c0: 7970 6520 696e 743a 2055 6e69 6f6e 5b69  ype int: Union[i
+000162d0: 6e74 2c20 604f 7065 7261 7469 6f6e 605d  nt, `Operation`]
+000162e0: 0a0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
+000162f0: 6e73 3a20 4172 7261 7920 7769 7468 2074  ns: Array with t
+00016300: 6865 206e 6577 2075 726c 7320 2869 6620  he new urls (if 
+00016310: 6461 7461 2077 6173 2073 6176 6564 290a  data was saved).
+00016320: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00016330: 2020 2020 6966 2069 6e64 6963 6573 2069      if indices i
+00016340: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00016350: 2020 2020 696e 6469 6365 7320 3d20 7261      indices = ra
+00016360: 6e67 6528 6c65 6e28 7365 6c66 2929 0a20  nge(len(self)). 
+00016370: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00016380: 616e 6365 2869 6e64 6963 6573 2c20 696e  ance(indices, in
+00016390: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+000163a0: 696e 6469 6365 7320 3d20 5b69 6e64 6963  indices = [indic
+000163b0: 6573 5d0a 2020 2020 2020 2020 7572 6c73  es].        urls
+000163c0: 203d 205b 5d0a 2020 2020 2020 2020 696f   = [].        io
+000163d0: 5f75 7469 6c73 2e61 6476 616e 6365 6d65  _utils.advanceme
+000163e0: 6e74 5f64 6973 706c 6179 2830 2c20 7365  nt_display(0, se
+000163f0: 6c66 2e6e 6672 616d 6573 2c20 7465 7874  lf.nframes, text
+00016400: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
+00016410: 7420 6861 7361 7474 7228 7365 6c66 2c20  t hasattr(self, 
+00016420: 2273 7461 7465 5f6f 665f 6f70 6572 6174  "state_of_operat
+00016430: 696f 6e73 2229 3a0a 2020 2020 2020 2020  ions"):.        
+00016440: 2020 2020 7365 6c66 2e73 7461 7465 5f6f      self.state_o
+00016450: 665f 6f70 6572 6174 696f 6e73 203d 205f  f_operations = _
+00016460: 5374 6174 654f 664f 7065 7261 7469 6f6e  StateOfOperation
+00016470: 7328 290a 0a20 2020 2020 2020 2077 6974  s()..        wit
+00016480: 6820 7365 6c66 2e73 7461 7465 5f6f 665f  h self.state_of_
+00016490: 6f70 6572 6174 696f 6e73 2e72 756e 5f63  operations.run_c
+000164a0: 6f6e 7465 7874 286f 7065 7261 7469 6f6e  ontext(operation
+000164b0: 293a 0a20 2020 2020 2020 2020 2020 205f  ):.            _
+000164c0: 6669 6c65 203d 204e 6f6e 650a 2020 2020  file = None.    
+000164d0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+000164e0: 2020 2020 2020 2020 2020 2020 2074 7279               try
+000164f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00016500: 2020 2020 2020 5f66 696c 6520 3d20 6835        _file = h5
+00016510: 7079 2e46 696c 6528 7361 7665 2c20 2261  py.File(save, "a
+00016520: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+00016530: 2020 2065 7863 6570 7420 4f53 4572 726f     except OSErro
+00016540: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+00016550: 2020 2020 2020 2069 6620 6f73 2e70 6174         if os.pat
+00016560: 682e 6578 6973 7473 2873 6176 6529 3a0a  h.exists(save):.
+00016570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016580: 2020 2020 2020 2020 6f73 2e72 656d 6f76          os.remov
+00016590: 6528 7361 7665 290a 2020 2020 2020 2020  e(save).        
+000165a0: 2020 2020 2020 2020 2020 2020 5f66 696c              _fil
+000165b0: 6520 3d20 6835 7079 2e46 696c 6528 7361  e = h5py.File(sa
+000165c0: 7665 2c20 2277 2229 0a0a 2020 2020 2020  ve, "w")..      
+000165d0: 2020 2020 2020 2020 2020 6461 7461 7365            datase
+000165e0: 745f 6e61 6d65 203d 2022 6461 7461 7365  t_name = "datase
+000165f0: 7422 0a20 2020 2020 2020 2020 2020 2020  t".             
+00016600: 2020 206e 6577 5f73 6861 7065 203d 2073     new_shape = s
+00016610: 656c 662e 7368 6170 6520 6966 206e 6577  elf.shape if new
+00016620: 5f73 6861 7065 2069 7320 4e6f 6e65 2065  _shape is None e
+00016630: 6c73 6520 7475 706c 6528 6e65 775f 7368  lse tuple(new_sh
+00016640: 6170 6529 0a20 2020 2020 2020 2020 2020  ape).           
+00016650: 2020 2020 2069 6620 2264 6174 6173 6574       if "dataset
+00016660: 2220 696e 205f 6669 6c65 3a0a 2020 2020  " in _file:.    
+00016670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016680: 6966 206e 6577 5f73 6861 7065 2021 3d20  if new_shape != 
+00016690: 5f66 696c 655b 2264 6174 6173 6574 225d  _file["dataset"]
+000166a0: 2e73 6861 7065 3a0a 2020 2020 2020 2020  .shape:.        
+000166b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000166c0: 5f66 696c 652e 6372 6561 7465 5f64 6174  _file.create_dat
+000166d0: 6173 6574 280a 2020 2020 2020 2020 2020  aset(.          
+000166e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000166f0: 2020 2275 7064 6174 655f 6461 7461 7365    "update_datase
+00016700: 7422 2c20 6e65 775f 7368 6170 652c 2064  t", new_shape, d
+00016710: 7479 7065 3d73 656c 662e 6474 7970 650a  type=self.dtype.
+00016720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016730: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00016740: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00016750: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00016760: 2020 2020 2020 2020 2020 2020 5f66 696c              _fil
+00016770: 652e 6372 6561 7465 5f64 6174 6173 6574  e.create_dataset
+00016780: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00016790: 2020 2020 2020 2020 2020 2020 2020 2275                "u
+000167a0: 7064 6174 655f 6461 7461 7365 7422 2c0a  pdate_dataset",.
+000167b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000167c0: 2020 2020 2020 2020 2020 2020 7368 6170              shap
+000167d0: 653d 5f66 696c 655b 2264 6174 6173 6574  e=_file["dataset
+000167e0: 225d 2e73 6861 7065 2c0a 2020 2020 2020  "].shape,.      
+000167f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016800: 2020 2020 2020 6474 7970 653d 5f66 696c        dtype=_fil
+00016810: 655b 2264 6174 6173 6574 225d 2e64 7479  e["dataset"].dty
+00016820: 7065 2c0a 2020 2020 2020 2020 2020 2020  pe,.            
+00016830: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00016840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016850: 2020 2020 2020 666f 7220 692c 2069 6d67        for i, img
+00016860: 2069 6e20 656e 756d 6572 6174 6528 5f66   in enumerate(_f
+00016870: 696c 655b 2264 6174 6173 6574 225d 293a  ile["dataset"]):
+00016880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016890: 2020 2020 2020 2020 2020 2020 205f 6669               _fi
+000168a0: 6c65 5b22 7570 6461 7465 5f64 6174 6173  le["update_datas
+000168b0: 6574 225d 5b69 5d20 3d20 696d 670a 2020  et"][i] = img.  
+000168c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000168d0: 2020 6461 7461 7365 745f 6e61 6d65 203d    dataset_name =
+000168e0: 2022 7570 6461 7465 5f64 6174 6173 6574   "update_dataset
+000168f0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00016900: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00016910: 2020 2020 2020 2020 2020 2020 5f66 696c              _fil
+00016920: 652e 6372 6561 7465 5f64 6174 6173 6574  e.create_dataset
+00016930: 2822 6461 7461 7365 7422 2c20 6e65 775f  ("dataset", new_
+00016940: 7368 6170 652c 2064 7479 7065 3d73 656c  shape, dtype=sel
+00016950: 662e 6474 7970 6529 0a0a 2020 2020 2020  f.dtype)..      
+00016960: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
+00016970: 696e 2069 6e64 6963 6573 3a0a 2020 2020  in indices:.    
+00016980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016990: 6966 2028 0a20 2020 2020 2020 2020 2020  if (.           
+000169a0: 2020 2020 2020 2020 2020 2020 206f 7065               ope
+000169b0: 7261 7469 6f6e 2069 7320 6e6f 7420 4e6f  ration is not No
+000169c0: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
+000169d0: 2020 2020 2020 2020 2020 2061 6e64 206e             and n
+000169e0: 6f74 2073 656c 662e 7374 6174 655f 6f66  ot self.state_of
+000169f0: 5f6f 7065 7261 7469 6f6e 732e 6973 5f72  _operations.is_r
+00016a00: 756e 6e69 6e67 286f 7065 7261 7469 6f6e  unning(operation
+00016a10: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00016a20: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
+00016a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016a40: 2069 6620 2275 7064 6174 655f 6461 7461   if "update_data
+00016a50: 7365 7422 2069 6e20 5f66 696c 653a 0a20  set" in _file:. 
+00016a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016a70: 2020 2020 2020 2020 2020 2064 656c 205f             del _
+00016a80: 6669 6c65 5b22 7570 6461 7465 5f64 6174  file["update_dat
+00016a90: 6173 6574 225d 0a20 2020 2020 2020 2020  aset"].         
+00016aa0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00016ab0: 6574 7572 6e0a 2020 2020 2020 2020 2020  eturn.          
+00016ac0: 2020 2020 2020 2020 2020 2320 2020 2020            #     
+00016ad0: 6966 2073 6176 653a 0a20 2020 2020 2020  if save:.       
+00016ae0: 2020 2020 2020 2020 2020 2020 2023 2020               #  
+00016af0: 2020 2020 2020 2066 6f72 206a 2069 6e20         for j in 
+00016b00: 696e 6469 6365 733a 0a20 2020 2020 2020  indices:.       
+00016b10: 2020 2020 2020 2020 2020 2020 2023 2020               #  
+00016b20: 2020 2020 2020 2020 2020 2069 6620 6a20             if j 
+00016b30: 213d 2069 3a0a 2020 2020 2020 2020 2020  != i:.          
+00016b40: 2020 2020 2020 2020 2020 2320 2020 2020            #     
+00016b50: 2020 2020 2020 2020 2020 2020 6669 6c65              file
+00016b60: 6e61 6d65 203d 2073 6176 6520 2b20 7374  name = save + st
+00016b70: 7228 6a29 2e7a 6669 6c6c 2834 2920 2b20  r(j).zfill(4) + 
+00016b80: 222e 6e70 7922 0a20 2020 2020 2020 2020  ".npy".         
+00016b90: 2020 2020 2020 2020 2020 2023 2020 2020             #    
+00016ba0: 2020 2020 2020 2020 2020 2020 206f 732e               os.
+00016bb0: 7265 6d6f 7665 2866 696c 656e 616d 6529  remove(filename)
+00016bc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016bd0: 2020 2020 2023 2020 2020 2020 2020 2020       #          
+00016be0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00016bf0: 2020 2020 2020 2020 2020 2020 2023 2020               #  
+00016c00: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00016c10: 7265 616b 0a20 2020 2020 2020 2020 2020  reak.           
+00016c20: 2020 2020 2020 2020 2023 2020 2020 2072           #     r
+00016c30: 6574 7572 6e0a 2020 2020 2020 2020 2020  eturn.          
+00016c40: 2020 2020 2020 2020 2020 696d 6720 3d20            img = 
+00016c50: 7365 6c66 5b69 6e74 2869 295d 0a20 2020  self[int(i)].   
+00016c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016c70: 2066 6f72 2066 2c20 6172 6773 2069 6e20   for f, args in 
+00016c80: 6675 6e63 733a 0a20 2020 2020 2020 2020  funcs:.         
+00016c90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00016ca0: 6d67 203d 2066 282a 285b 696d 675d 202b  mg = f(*([img] +
+00016cb0: 2061 7267 7329 290a 2020 2020 2020 2020   args)).        
+00016cc0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00016cd0: 6176 653a 0a20 2020 2020 2020 2020 2020  ave:.           
+00016ce0: 2020 2020 2020 2020 2020 2020 205f 6669               _fi
+00016cf0: 6c65 5b64 6174 6173 6574 5f6e 616d 655d  le[dataset_name]
+00016d00: 5b69 5d20 3d20 696d 670a 2020 2020 2020  [i] = img.      
+00016d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016d20: 2020 7572 6c73 2e61 7070 656e 6428 0a20    urls.append(. 
+00016d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016d40: 2020 2020 2020 2020 2020 2044 6174 6155             DataU
+00016d50: 726c 280a 2020 2020 2020 2020 2020 2020  rl(.            
+00016d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016d70: 2020 2020 6669 6c65 5f70 6174 683d 7361      file_path=sa
+00016d80: 7665 2c0a 2020 2020 2020 2020 2020 2020  ve,.            
+00016d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016da0: 2020 2020 6461 7461 5f70 6174 683d 222f      data_path="/
+00016db0: 6461 7461 7365 7422 2c0a 2020 2020 2020  dataset",.      
+00016dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016dd0: 2020 2020 2020 2020 2020 6461 7461 5f73            data_s
+00016de0: 6c69 6365 3d69 2c0a 2020 2020 2020 2020  lice=i,.        
+00016df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e00: 2020 2020 2020 2020 7363 6865 6d65 3d22          scheme="
+00016e10: 7369 6c78 222c 0a20 2020 2020 2020 2020  silx",.         
+00016e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e30: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00016e40: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00016e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e60: 2020 2020 2020 2023 2066 696c 656e 616d         # filenam
+00016e70: 6520 3d20 7361 7665 202b 2073 7472 2869  e = save + str(i
+00016e80: 292e 7a66 696c 6c28 3429 202b 2022 2e6e  ).zfill(4) + ".n
+00016e90: 7079 220a 2020 2020 2020 2020 2020 2020  py".            
+00016ea0: 2020 2020 2020 2020 2020 2020 2320 6e75              # nu
+00016eb0: 6d70 792e 7361 7665 2866 696c 656e 616d  mpy.save(filenam
+00016ec0: 652c 2069 6d67 290a 2020 2020 2020 2020  e, img).        
+00016ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ee0: 2320 7572 6c73 2e61 7070 656e 6428 4461  # urls.append(Da
+00016ef0: 7461 5572 6c28 6669 6c65 5f70 6174 683d  taUrl(file_path=
+00016f00: 6669 6c65 6e61 6d65 2c20 7363 6865 6d65  filename, scheme
+00016f10: 3d27 6661 6269 6f27 2929 0a20 2020 2020  ='fabio')).     
+00016f20: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00016f30: 6f5f 7574 696c 732e 6164 7661 6e63 656d  o_utils.advancem
+00016f40: 656e 745f 6469 7370 6c61 7928 6920 2b20  ent_display(i + 
+00016f50: 312c 2073 656c 662e 6e66 7261 6d65 732c  1, self.nframes,
+00016f60: 2074 6578 7429 0a0a 2020 2020 2020 2020   text)..        
+00016f70: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
+00016f80: 7465 5f6f 665f 6f70 6572 6174 696f 6e73  te_of_operations
+00016f90: 2e73 746f 7028 6f70 6572 6174 696f 6e29  .stop(operation)
+00016fa0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00016fb0: 2020 6966 2064 6174 6173 6574 5f6e 616d    if dataset_nam
+00016fc0: 6520 3d3d 2022 7570 6461 7465 5f64 6174  e == "update_dat
+00016fd0: 6173 6574 223a 0a20 2020 2020 2020 2020  aset":.         
+00016fe0: 2020 2020 2020 2020 2020 2064 656c 205f             del _
+00016ff0: 6669 6c65 5b22 6461 7461 7365 7422 5d0a  file["dataset"].
+00017000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017010: 2020 2020 5f66 696c 655b 2264 6174 6173      _file["datas
+00017020: 6574 225d 203d 205f 6669 6c65 5b22 7570  et"] = _file["up
+00017030: 6461 7465 5f64 6174 6173 6574 225d 0a20  date_dataset"]. 
+00017040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017050: 2020 2064 656c 205f 6669 6c65 5b22 7570     del _file["up
+00017060: 6461 7465 5f64 6174 6173 6574 225d 0a20  date_dataset"]. 
+00017070: 2020 2020 2020 2020 2020 2066 696e 616c             final
+00017080: 6c79 3a0a 2020 2020 2020 2020 2020 2020  ly:.            
+00017090: 2020 2020 6966 205f 6669 6c65 2069 7320      if _file is 
+000170a0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+000170b0: 2020 2020 2020 2020 2020 2020 2020 5f66                _f
+000170c0: 696c 652e 636c 6f73 6528 290a 2020 2020  ile.close().    
+000170d0: 2020 2020 7265 7475 726e 206e 756d 7079      return numpy
+000170e0: 2e61 7272 6179 2875 726c 7329 0a0a 2020  .array(urls)..  
+000170f0: 2020 6465 6620 7361 7665 2873 656c 662c    def save(self,
+00017100: 2070 6174 682c 2069 6e64 6963 6573 3d4e   path, indices=N
+00017110: 6f6e 652c 206e 6577 5f73 6861 7065 3d4e  one, new_shape=N
+00017120: 6f6e 652c 2069 6e5f 6d65 6d6f 7279 3d54  one, in_memory=T
+00017130: 7275 6529 202d 3e20 4e6f 6e65 3a0a 2020  rue) -> None:.  
+00017140: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00017150: 2020 5361 7665 2074 6865 2064 6174 6120    Save the data 
+00017160: 696e 746f 2060 7061 7468 6020 666f 6c64  into `path` fold
+00017170: 6572 2061 6e64 2072 6570 6c61 6365 2044  er and replace D
+00017180: 6174 6120 7572 6c73 2e0a 2020 2020 2020  ata urls..      
+00017190: 2020 544f 444f 3a20 6368 6563 6b20 6966    TODO: check if
+000171a0: 2075 726c 7320 616c 7265 6164 7920 6578   urls already ex
+000171b0: 6973 7420 616e 642c 2069 6620 736f 2c20  ist and, if so, 
+000171c0: 6d6f 6469 6679 206f 6e6c 7920 7572 6c73  modify only urls
+000171d0: 5b69 6e64 6963 6573 5d2e 0a0a 2020 2020  [indices]...    
+000171e0: 2020 2020 3a70 6172 616d 2070 6174 683a      :param path:
+000171f0: 2050 6174 6820 746f 2074 6865 2066 6f6c   Path to the fol
+00017200: 6465 720a 2020 2020 2020 2020 3a74 7970  der.        :typ
+00017210: 6520 7061 7468 3a20 7374 720a 2020 2020  e path: str.    
+00017220: 2020 2020 3a70 6172 616d 2069 6e64 6963      :param indic
+00017230: 6573 3a20 7468 6520 696e 6469 6365 7320  es: the indices 
+00017240: 6f66 2074 6865 2076 616c 7565 7320 746f  of the values to
+00017250: 2073 6176 652c 2064 6566 6175 6c74 7320   save, defaults 
+00017260: 746f 204e 6f6e 650a 2020 2020 2020 2020  to None.        
+00017270: 3a74 7970 6520 696e 6469 6365 733a 2055  :type indices: U
+00017280: 6e69 6f6e 5b4e 6f6e 652c 6172 7261 795f  nion[None,array_
+00017290: 6c69 6b65 5d2c 206f 7074 696f 6e61 6c0a  like], optional.
+000172a0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+000172b0: 2020 2020 6966 206e 6f74 2068 6173 6174      if not hasat
+000172c0: 7472 2873 656c 662c 2022 696e 5f6d 656d  tr(self, "in_mem
+000172d0: 6f72 7922 2920 6f72 2073 656c 662e 696e  ory") or self.in
+000172e0: 5f6d 656d 6f72 7920 6973 204e 6f6e 653a  _memory is None:
+000172f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00017300: 662e 696e 5f6d 656d 6f72 7920 3d20 5472  f.in_memory = Tr
+00017310: 7565 0a20 2020 2020 2020 2075 726c 7320  ue.        urls 
+00017320: 3d20 5b5d 0a0a 2020 2020 2020 2020 6966  = []..        if
+00017330: 2069 6e64 6963 6573 2069 7320 4e6f 6e65   indices is None
+00017340: 3a0a 2020 2020 2020 2020 2020 2020 6461  :.            da
+00017350: 7461 203d 2073 656c 662e 666c 6174 7465  ta = self.flatte
+00017360: 6e28 290a 2020 2020 2020 2020 2020 2020  n().            
+00017370: 696e 6469 6365 7320 3d20 6e75 6d70 792e  indices = numpy.
+00017380: 6172 616e 6765 286c 656e 2864 6174 6129  arange(len(data)
+00017390: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+000173a0: 2020 2020 2020 2020 2020 2020 6461 7461              data
+000173b0: 203d 2073 656c 662e 666c 6174 7465 6e28   = self.flatten(
+000173c0: 295b 696e 6469 6365 735d 0a0a 2020 2020  )[indices]..    
+000173d0: 2020 2020 5f66 696c 6520 3d20 4e6f 6e65      _file = None
+000173e0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+000173f0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00017400: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+00017410: 6669 6c65 203d 2068 3570 792e 4669 6c65  file = h5py.File
+00017420: 2870 6174 682c 2022 6122 290a 2020 2020  (path, "a").    
+00017430: 2020 2020 2020 2020 6578 6365 7074 204f          except O
+00017440: 5345 7272 6f72 3a0a 2020 2020 2020 2020  SError:.        
+00017450: 2020 2020 2020 2020 6966 206f 732e 7061          if os.pa
+00017460: 7468 2e65 7869 7374 7328 7061 7468 293a  th.exists(path):
+00017470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017480: 2020 2020 206f 732e 7265 6d6f 7665 2870       os.remove(p
+00017490: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
+000174a0: 2020 2020 205f 6669 6c65 203d 2068 3570       _file = h5p
+000174b0: 792e 4669 6c65 2870 6174 682c 2022 7722  y.File(path, "w"
+000174c0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+000174d0: 206e 6577 5f73 6861 7065 3a0a 2020 2020   new_shape:.    
+000174e0: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
+000174f0: 7368 6170 6520 3d20 7475 706c 6528 6e65  shape = tuple(ne
+00017500: 775f 7368 6170 6529 0a20 2020 2020 2020  w_shape).       
+00017510: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00017520: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+00017530: 6c66 2e6e 6469 6d20 3e20 333a 0a20 2020  lf.ndim > 3:.   
+00017540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017550: 206e 6577 5f73 6861 7065 203d 2028 7365   new_shape = (se
+00017560: 6c66 2e6e 6672 616d 6573 2c29 202b 2073  lf.nframes,) + s
+00017570: 656c 662e 6672 616d 655f 7368 6170 650a  elf.frame_shape.
+00017580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017590: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000175a0: 2020 2020 2020 2020 2020 6e65 775f 7368            new_sh
+000175b0: 6170 6520 3d20 7365 6c66 2e73 6861 7065  ape = self.shape
+000175c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000175d0: 2264 6174 6173 6574 2220 6e6f 7420 696e  "dataset" not in
+000175e0: 205f 6669 6c65 3a0a 2020 2020 2020 2020   _file:.        
+000175f0: 2020 2020 2020 2020 5f66 696c 652e 6372          _file.cr
+00017600: 6561 7465 5f64 6174 6173 6574 2822 6461  eate_dataset("da
+00017610: 7461 7365 7422 2c20 6e65 775f 7368 6170  taset", new_shap
+00017620: 652c 2064 7479 7065 3d73 656c 662e 6474  e, dtype=self.dt
+00017630: 7970 6529 0a20 2020 2020 2020 2020 2020  ype).           
+00017640: 2065 6c69 6620 6e65 775f 7368 6170 6520   elif new_shape 
+00017650: 213d 205f 6669 6c65 5b22 6461 7461 7365  != _file["datase
+00017660: 7422 5d2e 7368 6170 653a 0a20 2020 2020  t"].shape:.     
+00017670: 2020 2020 2020 2020 2020 2064 656c 205f             del _
+00017680: 6669 6c65 5b22 6461 7461 7365 7422 5d0a  file["dataset"].
+00017690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000176a0: 5f66 696c 652e 6372 6561 7465 5f64 6174  _file.create_dat
+000176b0: 6173 6574 2822 6461 7461 7365 7422 2c20  aset("dataset", 
+000176c0: 6e65 775f 7368 6170 652c 2064 7479 7065  new_shape, dtype
+000176d0: 3d73 656c 662e 6474 7970 6529 0a0a 2020  =self.dtype)..  
+000176e0: 2020 2020 2020 2020 2020 666f 7220 692c            for i,
+000176f0: 206a 2069 6e20 656e 756d 6572 6174 6528   j in enumerate(
+00017700: 696e 6469 6365 7329 3a0a 2020 2020 2020  indices):.      
+00017710: 2020 2020 2020 2020 2020 5f66 696c 655b            _file[
+00017720: 2264 6174 6173 6574 225d 5b6a 5d20 3d20  "dataset"][j] = 
+00017730: 6461 7461 5b69 5d0a 2020 2020 2020 2020  data[i].        
+00017740: 2020 2020 2020 2020 7572 6c73 2e61 7070          urls.app
+00017750: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
+00017760: 2020 2020 2020 2020 2044 6174 6155 726c           DataUrl
+00017770: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00017780: 2020 2020 2020 2020 2020 6669 6c65 5f70            file_p
+00017790: 6174 683d 7061 7468 2c0a 2020 2020 2020  ath=path,.      
+000177a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000177b0: 2020 6461 7461 5f70 6174 683d 222f 6461    data_path="/da
+000177c0: 7461 7365 7422 2c0a 2020 2020 2020 2020  taset",.        
+000177d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000177e0: 6461 7461 5f73 6c69 6365 3d6a 2c0a 2020  data_slice=j,.  
+000177f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017800: 2020 2020 2020 7363 6865 6d65 3d22 7369        scheme="si
+00017810: 6c78 222c 0a20 2020 2020 2020 2020 2020  lx",.           
+00017820: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00017830: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00017840: 2020 2020 2020 2020 2023 2020 2020 2066           #     f
+00017850: 696c 656e 616d 6520 3d20 7061 7468 202b  ilename = path +
+00017860: 2073 7472 2869 292e 7a66 696c 6c28 3429   str(i).zfill(4)
+00017870: 202b 2022 2e6e 7079 220a 2020 2020 2020   + ".npy".      
+00017880: 2020 2020 2020 2320 2020 2020 6e75 6d70        #     nump
+00017890: 792e 7361 7665 2866 696c 656e 616d 652c  y.save(filename,
+000178a0: 2069 6d67 290a 2020 2020 2020 2020 2020   img).          
+000178b0: 2020 2320 2020 2020 7572 6c73 2e61 7070    #     urls.app
+000178c0: 656e 6428 4461 7461 5572 6c28 6669 6c65  end(DataUrl(file
+000178d0: 5f70 6174 683d 6669 6c65 6e61 6d65 2c20  _path=filename, 
+000178e0: 7363 6865 6d65 3d27 6661 6269 6f27 2929  scheme='fabio'))
+000178f0: 0a20 2020 2020 2020 2066 696e 616c 6c79  .        finally
+00017900: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00017910: 205f 6669 6c65 2069 7320 6e6f 7420 4e6f   _file is not No
+00017920: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00017930: 2020 2020 5f66 696c 652e 636c 6f73 6528      _file.close(
+00017940: 290a 2020 2020 2020 2020 7572 6c73 203d  ).        urls =
+00017950: 206e 756d 7079 2e61 7361 7272 6179 2875   numpy.asarray(u
+00017960: 726c 7329 0a20 2020 2020 2020 2069 6620  rls).        if 
+00017970: 7365 6c66 2e75 726c 7320 6973 206e 6f74  self.urls is not
+00017980: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00017990: 2020 206e 6577 5f75 726c 7320 3d20 7365     new_urls = se
+000179a0: 6c66 2e75 726c 732e 666c 6174 7465 6e28  lf.urls.flatten(
+000179b0: 290a 2020 2020 2020 2020 2020 2020 6e65  ).            ne
+000179c0: 775f 7572 6c73 5b69 6e64 6963 6573 5d20  w_urls[indices] 
+000179d0: 3d20 7572 6c73 0a20 2020 2020 2020 2020  = urls.         
+000179e0: 2020 2073 656c 662e 7572 6c73 203d 206e     self.urls = n
+000179f0: 6577 5f75 726c 732e 7265 7368 6170 6528  ew_urls.reshape(
+00017a00: 7365 6c66 2e75 726c 732e 7368 6170 6529  self.urls.shape)
+00017a10: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00017a20: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00017a30: 7572 6c73 203d 206e 756d 7079 2e61 7361  urls = numpy.asa
+00017a40: 7272 6179 2875 726c 7329 0a0a 2020 2020  rray(urls)..    
+00017a50: 4063 6f6e 7465 7874 6d61 6e61 6765 720a  @contextmanager.
+00017a60: 2020 2020 6465 6620 6f70 656e 5f61 735f      def open_as_
+00017a70: 6864 6635 2873 656c 662c 205f 6469 7229  hdf5(self, _dir)
+00017a80: 202d 3e20 4765 6e65 7261 746f 725b 6835   -> Generator[h5
+00017a90: 7079 2e44 6174 6173 6574 2c20 4e6f 6e65  py.Dataset, None
+00017aa0: 2c20 4e6f 6e65 5d3a 0a20 2020 2020 2020  , None]:.       
+00017ab0: 2022 2222 0a20 2020 2020 2020 2043 6f6e   """.        Con
+00017ac0: 7665 7274 7320 7468 6520 6461 7461 2069  verts the data i
+00017ad0: 6e74 6f20 616e 2048 4446 3520 6669 6c65  nto an HDF5 file
+00017ae0: 2c20 7365 7474 696e 6720 666c 6174 7465  , setting flatte
+00017af0: 6e65 6420 696d 6167 6573 2069 6e20 7468  ned images in th
+00017b00: 6520 726f 7773 2e0a 2020 2020 2020 2020  e rows..        
+00017b10: 544f 444f 3a20 7061 7373 2066 696c 656e  TODO: pass filen
+00017b20: 616d 6520 7065 7220 7061 7261 6d65 7465  ame per paramete
+00017b30: 723f 0a0a 2020 2020 2020 2020 3a70 6172  r?..        :par
+00017b40: 616d 205f 6469 723a 2044 6972 6563 746f  am _dir: Directo
+00017b50: 7279 2069 6e20 7768 6963 6820 746f 2073  ry in which to s
+00017b60: 6176 6520 7468 6520 4844 4635 2066 696c  ave the HDF5 fil
+00017b70: 652e 0a20 2020 2020 2020 203a 7479 7065  e..        :type
+00017b80: 205f 6469 723a 2073 7472 0a0a 2020 2020   _dir: str..    
+00017b90: 2020 2020 3a72 6574 7572 6e3a 2048 4446      :return: HDF
+00017ba0: 3520 6461 7461 7365 740a 2020 2020 2020  5 dataset.      
+00017bb0: 2020 3a72 7479 7065 3a20 6068 3570 792e    :rtype: `h5py.
+00017bc0: 4461 7461 7365 7460 0a20 2020 2020 2020  Dataset`.       
+00017bd0: 2022 2222 0a20 2020 2020 2020 2074 7279   """.        try
+00017be0: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
+00017bf0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00017c00: 2020 2066 696c 656e 616d 6520 3d20 6f73     filename = os
+00017c10: 2e70 6174 682e 6a6f 696e 285f 6469 722c  .path.join(_dir,
+00017c20: 2022 6461 7461 2e68 6466 3522 290a 2020   "data.hdf5").  
+00017c30: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00017c40: 6c66 2e5f 6669 6c65 203d 2068 3570 792e  lf._file = h5py.
+00017c50: 4669 6c65 2866 696c 656e 616d 652c 2022  File(filename, "
+00017c60: 6122 290a 2020 2020 2020 2020 2020 2020  a").            
+00017c70: 6578 6365 7074 204f 5345 7272 6f72 3a0a  except OSError:.
+00017c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017c90: 6966 206f 732e 7061 7468 2e65 7869 7374  if os.path.exist
+00017ca0: 7328 6669 6c65 6e61 6d65 293a 0a20 2020  s(filename):.   
+00017cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017cc0: 206f 732e 7265 6d6f 7665 2866 696c 656e   os.remove(filen
+00017cd0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+00017ce0: 2020 2020 2073 656c 662e 5f66 696c 6520       self._file 
+00017cf0: 3d20 6835 7079 2e46 696c 6528 6669 6c65  = h5py.File(file
+00017d00: 6e61 6d65 2c20 2277 2229 0a0a 2020 2020  name, "w")..    
+00017d10: 2020 2020 2020 2020 6e66 7261 6d65 7320          nframes 
+00017d20: 3d20 7365 6c66 2e6e 6672 616d 6573 0a20  = self.nframes. 
+00017d30: 2020 2020 2020 2020 2020 2066 7261 6d65             frame
+00017d40: 5f73 6861 7065 203d 2073 656c 662e 6672  _shape = self.fr
+00017d50: 616d 655f 7368 6170 650a 2020 2020 2020  ame_shape.      
+00017d60: 2020 2020 2020 6672 616d 655f 7369 7a65        frame_size
+00017d70: 203d 2066 7261 6d65 5f73 6861 7065 5b30   = frame_shape[0
+00017d80: 5d20 2a20 6672 616d 655f 7368 6170 655b  ] * frame_shape[
+00017d90: 315d 0a20 2020 2020 2020 2020 2020 2068  1].            h
+00017da0: 6466 355f 7368 6170 6520 3d20 286e 6672  df5_shape = (nfr
+00017db0: 616d 6573 2c20 6672 616d 655f 7369 7a65  ames, frame_size
+00017dc0: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+00017dd0: 6620 2264 6174 6173 6574 2220 696e 2073  f "dataset" in s
+00017de0: 656c 662e 5f66 696c 6520 616e 6420 7365  elf._file and se
+00017df0: 6c66 2e5f 6669 6c65 5b22 6461 7461 7365  lf._file["datase
+00017e00: 7422 5d2e 7368 6170 6520 213d 2068 6466  t"].shape != hdf
+00017e10: 355f 7368 6170 653a 0a20 2020 2020 2020  5_shape:.       
+00017e20: 2020 2020 2020 2020 2064 656c 2073 656c           del sel
+00017e30: 662e 5f66 696c 655b 2264 6174 6173 6574  f._file["dataset
+00017e40: 225d 0a20 2020 2020 2020 2020 2020 2069  "].            i
+00017e50: 6620 2264 6174 6173 6574 2220 6e6f 7420  f "dataset" not 
+00017e60: 696e 2073 656c 662e 5f66 696c 653a 0a20  in self._file:. 
+00017e70: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00017e80: 656c 662e 5f66 696c 652e 6372 6561 7465  elf._file.create
+00017e90: 5f64 6174 6173 6574 2822 6461 7461 7365  _dataset("datase
+00017ea0: 7422 2c20 7368 6170 653d 6864 6635 5f73  t", shape=hdf5_s
+00017eb0: 6861 7065 2c20 6474 7970 653d 7365 6c66  hape, dtype=self
+00017ec0: 2e64 7479 7065 290a 0a20 2020 2020 2020  .dtype)..       
+00017ed0: 2020 2020 2066 6f72 2069 6d61 6765 5f69       for image_i
+00017ee0: 6478 2c20 6672 616d 6520 696e 2065 6e75  dx, frame in enu
+00017ef0: 6d65 7261 7465 2873 656c 662e 5f69 7465  merate(self._ite
+00017f00: 725f 6672 616d 6573 2829 293a 0a20 2020  r_frames()):.   
+00017f10: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00017f20: 662e 5f66 696c 655b 2264 6174 6173 6574  f._file["dataset
+00017f30: 225d 5b69 6d61 6765 5f69 6478 5d20 3d20  "][image_idx] = 
+00017f40: 6672 616d 652e 666c 6174 7465 6e28 290a  frame.flatten().
+00017f50: 0a20 2020 2020 2020 2020 2020 2079 6965  .            yie
+00017f60: 6c64 2073 656c 662e 5f66 696c 655b 2264  ld self._file["d
+00017f70: 6174 6173 6574 225d 0a20 2020 2020 2020  ataset"].       
+00017f80: 2066 696e 616c 6c79 3a0a 2020 2020 2020   finally:.      
+00017f90: 2020 2020 2020 6966 2073 656c 662e 5f66        if self._f
+00017fa0: 696c 6520 6973 206e 6f74 204e 6f6e 653a  ile is not None:
+00017fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017fc0: 2073 656c 662e 5f66 696c 652e 636c 6f73   self._file.clos
+00017fd0: 6528 290a 0a20 2020 2064 6566 2072 6573  e()..    def res
+00017fe0: 6861 7065 2873 656c 662c 2073 6861 7065  hape(self, shape
+00017ff0: 2c20 6f72 6465 723d 2243 2229 202d 3e20  , order="C") -> 
+00018000: 2244 6174 6122 3a0a 2020 2020 2020 2020  "Data":.        
+00018010: 2222 220a 2020 2020 2020 2020 5265 7475  """.        Retu
+00018020: 726e 7320 616e 2061 7272 6179 2063 6f6e  rns an array con
+00018030: 7461 696e 696e 6720 7468 6520 7361 6d65  taining the same
+00018040: 2064 6174 6120 7769 7468 2061 206e 6577   data with a new
+00018050: 2073 6861 7065 206f 6620 7572 6c73 2061   shape of urls a
+00018060: 6e64 206d 6574 6164 6174 612e 0a20 2020  nd metadata..   
+00018070: 2020 2020 2053 6861 7065 2061 6c73 6f20       Shape also 
+00018080: 636f 6e74 6169 6e73 2069 6d61 6765 2073  contains image s
+00018090: 6861 7065 2061 7420 7468 6520 6c61 7374  hape at the last
+000180a0: 2074 776f 2070 6f73 6974 696f 6e73 2028   two positions (
+000180b0: 756e 7265 7368 6170 6162 6c65 292e 0a0a  unreshapable)...
+000180c0: 2020 2020 2020 2020 3a70 6172 616d 2073          :param s
+000180d0: 6861 7065 3a20 4e65 7720 7368 6170 652c  hape: New shape,
+000180e0: 2073 686f 756c 6420 6265 2063 6f6d 7061   should be compa
+000180f0: 7469 626c 6520 7769 7468 2074 6865 206f  tible with the o
+00018100: 7269 6769 6e61 6c20 7368 6170 652e 0a20  riginal shape.. 
+00018110: 2020 2020 2020 203a 7479 7065 2073 6861         :type sha
+00018120: 7065 3a20 696e 7420 6f72 2074 7570 6c65  pe: int or tuple
+00018130: 206f 6620 696e 7473 2e0a 2020 2020 2020   of ints..      
+00018140: 2020 3a72 6574 7572 6e3a 206e 6577 2044    :return: new D
+00018150: 6174 6120 6f62 6a65 6374 2077 6974 6820  ata object with 
+00018160: 7572 6c73 2061 6e64 206d 6574 6164 6174  urls and metadat
+00018170: 6120 7265 7368 6170 6564 2074 6f20 7368  a reshaped to sh
+00018180: 6170 652e 0a20 2020 2020 2020 2022 2222  ape..        """
+00018190: 0a20 2020 2020 2020 2064 6174 6120 3d20  .        data = 
+000181a0: 4e6f 6e65 0a20 2020 2020 2020 2069 6620  None.        if 
+000181b0: 7365 6c66 2e69 6e5f 6d65 6d6f 7279 3a0a  self.in_memory:.
+000181c0: 2020 2020 2020 2020 2020 2020 6461 7461              data
+000181d0: 203d 2073 7570 6572 2829 2e72 6573 6861   = super().resha
+000181e0: 7065 2873 6861 7065 2c20 6f72 6465 723d  pe(shape, order=
+000181f0: 6f72 6465 7229 2e76 6965 7728 6e75 6d70  order).view(nump
+00018200: 792e 6e64 6172 7261 7929 0a20 2020 2020  y.ndarray).     
+00018210: 2020 2073 6361 6e5f 7368 6170 6520 3d20     scan_shape = 
+00018220: 7368 6170 655b 3a2d 325d 0a20 2020 2020  shape[:-2].     
+00018230: 2020 2072 6574 7572 6e20 4461 7461 280a     return Data(.
+00018240: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00018250: 2e75 726c 732e 7265 7368 6170 6528 7363  .urls.reshape(sc
+00018260: 616e 5f73 6861 7065 2c20 6f72 6465 723d  an_shape, order=
+00018270: 6f72 6465 7229 2c0a 2020 2020 2020 2020  order),.        
+00018280: 2020 2020 7365 6c66 2e6d 6574 6164 6174      self.metadat
+00018290: 612e 7265 7368 6170 6528 7363 616e 5f73  a.reshape(scan_s
+000182a0: 6861 7065 2c20 6f72 6465 723d 6f72 6465  hape, order=orde
+000182b0: 7229 2c0a 2020 2020 2020 2020 2020 2020  r),.            
+000182c0: 7365 6c66 2e69 6e5f 6d65 6d6f 7279 2c0a  self.in_memory,.
+000182d0: 2020 2020 2020 2020 2020 2020 6461 7461              data
+000182e0: 3d64 6174 612c 0a20 2020 2020 2020 2029  =data,.        )
+000182f0: 0a0a 2020 2020 6465 6620 7375 6d28 7365  ..    def sum(se
+00018300: 6c66 2c20 6178 6973 3d4e 6f6e 652c 202a  lf, axis=None, *
+00018310: 2a6b 7761 7267 7329 202d 3e20 556e 696f  *kwargs) -> Unio
+00018320: 6e5b 6e75 6d70 792e 6e64 6172 7261 792c  n[numpy.ndarray,
+00018330: 2066 6c6f 6174 5d3a 0a20 2020 2020 2020   float]:.       
+00018340: 2022 2222 0a20 2020 2020 2020 2053 756d   """.        Sum
+00018350: 206f 6620 6172 7261 7920 656c 656d 656e   of array elemen
+00018360: 7473 206f 7665 7220 6120 6769 7665 6e20  ts over a given 
+00018370: 6178 6973 2e0a 0a20 2020 2020 2020 203a  axis...        :
+00018380: 7061 7261 6d20 6178 6973 3a20 4f6e 6c79  param axis: Only
+00018390: 2061 7869 7320 6163 6365 7074 6564 2061   axis accepted a
+000183a0: 7265 2030 206f 7220 312e 0a20 2020 2020  re 0 or 1..     
+000183b0: 2020 2020 2020 2057 6974 6820 302c 2074         With 0, t
+000183c0: 6865 2073 756d 2069 7320 646f 6e65 2061  he sum is done a
+000183d0: 726f 756e 6420 7468 6520 7a20 6178 6973  round the z axis
+000183e0: 2c20 736f 2061 2072 6573 756c 7469 6e67  , so a resulting
+000183f0: 2069 6d61 6765 2069 7320 7265 7475 726e   image is return
+00018400: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00018410: 5769 7468 2031 2c20 6576 6572 7920 696d  With 1, every im
+00018420: 6167 6573 2068 6173 2069 7473 2070 6978  ages has its pix
+00018430: 656c 7320 7375 6d6d 6564 2061 6e64 2074  els summed and t
+00018440: 6865 2072 6573 756c 7420 6973 2061 206c  he result is a l
+00018450: 6973 7420 7769 7468 0a20 2020 2020 2020  ist with.       
+00018460: 2020 2020 2074 6865 2069 6e74 656e 7369       the intensi
+00018470: 7479 206f 6620 6561 6368 2069 6d61 6765  ty of each image
+00018480: 2e0a 2020 2020 2020 2020 2020 2020 5769  ..            Wi
+00018490: 7468 204e 6f6e 652c 2061 2066 6c6f 6174  th None, a float
+000184a0: 2069 7320 7468 6520 7265 7375 6c74 206f   is the result o
+000184b0: 6620 7468 6520 7375 6d20 6f66 2061 6c6c  f the sum of all
+000184c0: 2074 6865 2070 6978 656c 7320 616e 6420   the pixels and 
+000184d0: 616c 6c0a 2020 2020 2020 2020 2020 2020  all.            
+000184e0: 7468 6520 696d 6167 6573 2e0a 2020 2020  the images..    
+000184f0: 2020 2020 3a74 7970 6520 6178 6973 3a20      :type axis: 
+00018500: 556e 696f 6e5b 4e6f 6e65 2c20 696e 745d  Union[None, int]
+00018510: 0a0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
+00018520: 6e3a 2053 756d 6d65 6420 6461 7461 0a20  n: Summed data. 
+00018530: 2020 2020 2020 203a 7274 7970 653a 2055         :rtype: U
+00018540: 6e69 6f6e 5b66 6c6f 6174 2c20 6c69 7374  nion[float, list
+00018550: 5d0a 2020 2020 2020 2020 2222 220a 2020  ].        """.  
+00018560: 2020 2020 2020 6461 7461 203d 2073 656c        data = sel
+00018570: 662e 666c 6174 7465 6e28 290a 2020 2020  f.flatten().    
+00018580: 2020 2020 6966 2073 656c 662e 696e 5f6d      if self.in_m
+00018590: 656d 6f72 793a 0a20 2020 2020 2020 2020  emory:.         
+000185a0: 2020 2069 6620 6178 6973 203d 3d20 303a     if axis == 0:
+000185b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000185c0: 2072 6574 7572 6e20 7375 7065 7228 4461   return super(Da
+000185d0: 7461 2c20 6461 7461 292e 7375 6d28 6178  ta, data).sum(ax
+000185e0: 6973 3d61 7869 7329 2e76 6965 7728 6e75  is=axis).view(nu
+000185f0: 6d70 792e 6e64 6172 7261 7929 0a20 2020  mpy.ndarray).   
+00018600: 2020 2020 2020 2020 2069 6620 6178 6973           if axis
+00018610: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
+00018620: 2020 2020 2020 2072 6574 7572 6e20 7375         return su
+00018630: 7065 7228 4461 7461 2c20 6461 7461 292e  per(Data, data).
+00018640: 7669 6577 286e 756d 7079 2e6e 6461 7272  view(numpy.ndarr
+00018650: 6179 292e 7375 6d28 6178 6973 3d31 292e  ay).sum(axis=1).
+00018660: 7375 6d28 6178 6973 3d31 290a 2020 2020  sum(axis=1).    
 00018670: 2020 2020 2020 2020 6966 2061 7869 7320          if axis 
-00018680: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
-00018690: 2020 2020 2020 7265 7475 726e 2073 7570        return sup
-000186a0: 6572 2844 6174 612c 2064 6174 6129 2e76  er(Data, data).v
-000186b0: 6965 7728 6e75 6d70 792e 6e64 6172 7261  iew(numpy.ndarra
-000186c0: 7929 2e73 756d 2861 7869 733d 3129 2e73  y).sum(axis=1).s
-000186d0: 756d 2861 7869 733d 3129 0a20 2020 2020  um(axis=1).     
-000186e0: 2020 2020 2020 2069 6620 6178 6973 2069         if axis i
-000186f0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00018700: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00018710: 7570 6572 2844 6174 612c 2064 6174 6129  uper(Data, data)
-00018720: 2e73 756d 2829 0a20 2020 2020 2020 2020  .sum().         
-00018730: 2020 2072 6169 7365 2054 7970 6545 7272     raise TypeErr
-00018740: 6f72 2822 4178 6973 206d 7573 7420 6265  or("Axis must be
-00018750: 204e 6f6e 652c 2030 206f 7220 3122 290a   None, 0 or 1").
-00018760: 2020 2020 2020 2020 6966 2061 7869 7320          if axis 
-00018770: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-00018780: 2020 6966 2064 6174 612e 7369 7a65 203d    if data.size =
-00018790: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-000187a0: 2020 2020 2072 6574 7572 6e20 6e75 6d70       return nump
-000187b0: 792e 6172 7261 7928 5b5d 290a 2020 2020  y.array([]).    
-000187c0: 2020 2020 2020 2020 6966 206e 6f74 2064          if not d
-000187d0: 6174 612e 7368 6170 655b 305d 3a0a 2020  ata.shape[0]:.  
-000187e0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000187f0: 7475 726e 206e 756d 7079 2e7a 6572 6f73  turn numpy.zeros
-00018800: 2864 6174 615b 305d 2e73 6861 7065 290a  (data[0].shape).
-00018810: 2020 2020 2020 2020 2020 2020 7a73 756d              zsum
-00018820: 203d 206e 756d 7079 2e61 7272 6179 2864   = numpy.array(d
-00018830: 6174 615b 305d 2c20 6474 7970 653d 6e75  ata[0], dtype=nu
-00018840: 6d70 792e 666c 6f61 7436 3429 0a20 2020  mpy.float64).   
-00018850: 2020 2020 2020 2020 2066 6f72 2069 2069           for i i
-00018860: 6e20 7261 6e67 6528 312c 206c 656e 2864  n range(1, len(d
-00018870: 6174 6129 293a 0a20 2020 2020 2020 2020  ata)):.         
-00018880: 2020 2020 2020 207a 7375 6d20 2b3d 2064         zsum += d
-00018890: 6174 615b 695d 0a20 2020 2020 2020 2020  ata[i].         
-000188a0: 2020 2072 6574 7572 6e20 7a73 756d 0a20     return zsum. 
-000188b0: 2020 2020 2020 2069 6620 6178 6973 203d         if axis =
-000188c0: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
-000188d0: 2072 6574 7572 6e20 6e75 6d70 792e 6172   return numpy.ar
-000188e0: 7261 7928 5b69 2e73 756d 2829 2066 6f72  ray([i.sum() for
-000188f0: 2069 2069 6e20 6461 7461 5d29 0a20 2020   i in data]).   
-00018900: 2020 2020 2069 6620 6178 6973 2069 7320       if axis is 
-00018910: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00018920: 2020 696d 675f 7375 6d20 3d20 300a 2020    img_sum = 0.  
-00018930: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
-00018940: 696e 2064 6174 613a 0a20 2020 2020 2020  in data:.       
-00018950: 2020 2020 2020 2020 2069 6d67 5f73 756d           img_sum
-00018960: 202b 3d20 692e 7375 6d28 290a 2020 2020   += i.sum().    
-00018970: 2020 2020 2020 2020 7265 7475 726e 2069          return i
-00018980: 6d67 5f73 756d 0a20 2020 2020 2020 2072  mg_sum.        r
-00018990: 6169 7365 2054 7970 6545 7272 6f72 2822  aise TypeError("
-000189a0: 4178 6973 206d 7573 7420 6265 204e 6f6e  Axis must be Non
-000189b0: 652c 2030 206f 7220 3122 290a 0a20 2020  e, 0 or 1")..   
-000189c0: 2064 6566 2074 616b 6528 7365 6c66 2c20   def take(self, 
-000189d0: 696e 6469 6365 732c 2061 7869 733d 4e6f  indices, axis=No
-000189e0: 6e65 2c20 6f75 743d 4e6f 6e65 2c20 6d6f  ne, out=None, mo
-000189f0: 6465 3d22 7261 6973 6522 2920 2d3e 2022  de="raise") -> "
-00018a00: 4461 7461 223a 0a20 2020 2020 2020 2022  Data":.        "
-00018a10: 2222 0a20 2020 2020 2020 2054 616b 6520  "".        Take 
-00018a20: 656c 656d 656e 7473 2066 726f 6d20 7572  elements from ur
-00018a30: 6c73 2061 6e64 206d 6574 6164 6174 6120  ls and metadata 
-00018a40: 6672 6f6d 2061 6e20 6172 7261 7920 616c  from an array al
-00018a50: 6f6e 6720 616e 2061 7869 732e 0a0a 2020  ong an axis...  
-00018a60: 2020 2020 2020 3a70 6172 616d 2069 6e64        :param ind
-00018a70: 6963 6573 3a20 7468 6520 696e 6469 6365  ices: the indice
-00018a80: 7320 6f66 2074 6865 2076 616c 7565 7320  s of the values 
-00018a90: 746f 2065 7874 7261 6374 0a20 2020 2020  to extract.     
-00018aa0: 2020 203a 7479 7065 2069 6e64 6963 6573     :type indices
-00018ab0: 3a20 6172 7261 795f 6c69 6b65 0a20 2020  : array_like.   
-00018ac0: 2020 2020 203a 7061 7261 6d20 6178 6973       :param axis
-00018ad0: 3a20 7468 6520 6178 6973 206f 7665 7220  : the axis over 
-00018ae0: 7768 6963 6820 746f 2073 656c 6563 7420  which to select 
-00018af0: 7661 6c75 6573 2c20 6465 6661 756c 7473  values, defaults
-00018b00: 2074 6f20 4e6f 6e65 0a20 2020 2020 2020   to None.       
-00018b10: 203a 7479 7065 2061 7869 733a 2055 6e69   :type axis: Uni
-00018b20: 6f6e 5b4e 206f 6e65 2c20 696e 745d 2c20  on[N one, int], 
-00018b30: 6f70 7469 6f6e 616c 0a0a 2020 2020 2020  optional..      
-00018b40: 2020 3a72 6574 7572 6e3a 2046 6c61 7474    :return: Flatt
-00018b50: 656e 6564 2064 6174 612e 0a20 2020 2020  ened data..     
-00018b60: 2020 203a 7274 7970 653a 203a 636c 6173     :rtype: :clas
-00018b70: 733a 6044 6174 6160 0a20 2020 2020 2020  s:`Data`.       
-00018b80: 2022 2222 0a20 2020 2020 2020 2075 726c   """.        url
-00018b90: 7320 3d20 6e75 6d70 792e 7461 6b65 2873  s = numpy.take(s
-00018ba0: 656c 662e 7572 6c73 2c20 696e 6469 6365  elf.urls, indice
-00018bb0: 732c 2061 7869 732c 206d 6f64 653d 6d6f  s, axis, mode=mo
-00018bc0: 6465 290a 2020 2020 2020 2020 6d65 7461  de).        meta
-00018bd0: 6461 7461 203d 206e 756d 7079 2e74 616b  data = numpy.tak
-00018be0: 6528 7365 6c66 2e6d 6574 6164 6174 612c  e(self.metadata,
-00018bf0: 2069 6e64 6963 6573 2c20 6178 6973 2c20   indices, axis, 
-00018c00: 6d6f 6465 3d6d 6f64 6529 0a20 2020 2020  mode=mode).     
-00018c10: 2020 2064 6174 6120 3d20 4e6f 6e65 0a20     data = None. 
-00018c20: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
-00018c30: 6e5f 6d65 6d6f 7279 3a0a 2020 2020 2020  n_memory:.      
-00018c40: 2020 2020 2020 6461 7461 203d 2073 7570        data = sup
-00018c50: 6572 2829 2e74 616b 6528 696e 6469 6365  er().take(indice
-00018c60: 732c 2061 7869 732c 206d 6f64 653d 6d6f  s, axis, mode=mo
-00018c70: 6465 292e 7669 6577 286e 756d 7079 2e6e  de).view(numpy.n
-00018c80: 6461 7272 6179 290a 2020 2020 2020 2020  darray).        
-00018c90: 7265 7475 726e 2044 6174 6128 7572 6c73  return Data(urls
-00018ca0: 2c20 6d65 7461 6461 7461 2c20 7365 6c66  , metadata, self
-00018cb0: 2e69 6e5f 6d65 6d6f 7279 2c20 6461 7461  .in_memory, data
-00018cc0: 3d64 6174 6129 0a0a 2020 2020 6465 6620  =data)..    def 
-00018cd0: 666c 6174 7465 6e28 7365 6c66 2920 2d3e  flatten(self) ->
-00018ce0: 2022 4461 7461 223a 0a20 2020 2020 2020   "Data":.       
-00018cf0: 2022 2222 466c 6174 7465 6e73 2074 6865   """Flattens the
-00018d00: 2073 6361 6e20 6469 6d65 6e73 696f 6e73   scan dimensions
-00018d10: 2c20 6e6f 7420 7468 6520 6672 616d 6520  , not the frame 
-00018d20: 6469 6d65 6e73 696f 6e73 2e0a 2020 2020  dimensions..    
-00018d30: 2020 2020 544f 444f 3a20 7468 6973 2073      TODO: this s
-00018d40: 686f 756c 6420 6765 7420 6120 6469 6666  hould get a diff
-00018d50: 6572 656e 7420 6675 6e63 7469 6f6e 206e  erent function n
-00018d60: 616d 650a 0a20 2020 2020 2020 203a 7265  ame..        :re
-00018d70: 7475 726e 3a20 6e65 7720 6461 7461 2077  turn: new data w
-00018d80: 6974 6820 666c 6174 7465 6e65 6420 7572  ith flattened ur
-00018d90: 6c73 2061 6e64 206d 6574 6164 6174 6120  ls and metadata 
-00018da0: 2862 7574 206e 6f74 2066 7261 6d65 7329  (but not frames)
-00018db0: 2e0a 2020 2020 2020 2020 3a72 7479 7065  ..        :rtype
-00018dc0: 3a20 3a63 6c61 7373 3a60 4461 7461 600a  : :class:`Data`.
-00018dd0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00018de0: 2020 2020 6966 2073 656c 662e 6e66 7261      if self.nfra
-00018df0: 6d65 7320 3d3d 2030 206f 7220 7365 6c66  mes == 0 or self
-00018e00: 2e6e 6469 6d20 3c3d 2033 3a0a 2020 2020  .ndim <= 3:.    
-00018e10: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00018e20: 656c 660a 2020 2020 2020 2020 6461 7461  elf.        data
-00018e30: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00018e40: 6966 2073 656c 662e 696e 5f6d 656d 6f72  if self.in_memor
-00018e50: 793a 0a20 2020 2020 2020 2020 2020 2066  y:.            f
-00018e60: 7368 6170 6520 3d20 2873 656c 662e 6e66  shape = (self.nf
-00018e70: 7261 6d65 732c 2920 2b20 7365 6c66 2e66  rames,) + self.f
-00018e80: 7261 6d65 5f73 6861 7065 0a20 2020 2020  rame_shape.     
-00018e90: 2020 2020 2020 2023 2054 4f44 4f3a 206e         # TODO: n
-00018ea0: 6f74 2073 7572 6520 7768 7920 7765 206e  ot sure why we n
-00018eb0: 6565 6420 7468 6520 7665 7720 6865 7265  eed the vew here
-00018ec0: 3a0a 2020 2020 2020 2020 2020 2020 6461  :.            da
-00018ed0: 7461 203d 2073 7570 6572 2829 2e72 6573  ta = super().res
-00018ee0: 6861 7065 2866 7368 6170 6529 2e76 6965  hape(fshape).vie
-00018ef0: 7728 6e75 6d70 792e 6e64 6172 7261 7929  w(numpy.ndarray)
-00018f00: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00018f10: 4461 7461 280a 2020 2020 2020 2020 2020  Data(.          
-00018f20: 2020 7365 6c66 2e75 726c 732e 666c 6174    self.urls.flat
-00018f30: 7465 6e28 292c 2073 656c 662e 6d65 7461  ten(), self.meta
-00018f40: 6461 7461 2e66 6c61 7474 656e 2829 2c20  data.flatten(), 
-00018f50: 7365 6c66 2e69 6e5f 6d65 6d6f 7279 2c20  self.in_memory, 
-00018f60: 6461 7461 3d64 6174 610a 2020 2020 2020  data=data.      
-00018f70: 2020 290a 0a0a 636c 6173 7320 5472 616e    )...class Tran
-00018f80: 7366 6f72 6d61 7469 6f6e 3a0a 2020 2020  sformation:.    
-00018f90: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
-00018fa0: 662c 206b 696e 643a 2073 7472 2c20 783a  f, kind: str, x:
-00018fb0: 206e 756d 7079 2e6e 6461 7272 6179 2c20   numpy.ndarray, 
-00018fc0: 793a 206e 756d 7079 2e6e 6461 7272 6179  y: numpy.ndarray
-00018fd0: 2c20 726f 7461 7465 3a20 626f 6f6c 293a  , rotate: bool):
-00018fe0: 0a20 2020 2020 2020 2073 656c 662e 7820  .        self.x 
-00018ff0: 3d20 7820 2023 2073 6861 7065 2028 7379  = x  # shape (sy
-00019000: 2c20 7378 290a 2020 2020 2020 2020 7365  , sx).        se
-00019010: 6c66 2e79 203d 2079 2020 2320 7368 6170  lf.y = y  # shap
-00019020: 6520 2873 792c 2073 7829 0a20 2020 2020  e (sy, sx).     
-00019030: 2020 2073 656c 662e 726f 7461 7465 203d     self.rotate =
-00019040: 2072 6f74 6174 650a 2020 2020 2020 2020   rotate.        
-00019050: 7365 6c66 2e6b 696e 6420 3d20 6b69 6e64  self.kind = kind
-00019060: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-00019070: 2020 2020 6465 6620 7368 6170 6528 7365      def shape(se
-00019080: 6c66 2920 2d3e 2054 7570 6c65 5b69 6e74  lf) -> Tuple[int
-00019090: 2c20 696e 745d 3a0a 2020 2020 2020 2020  , int]:.        
-000190a0: 7265 7475 726e 2073 656c 662e 782e 7368  return self.x.sh
-000190b0: 6170 650a 0a20 2020 2040 7072 6f70 6572  ape..    @proper
-000190c0: 7479 0a20 2020 2064 6566 2073 7828 7365  ty.    def sx(se
-000190d0: 6c66 2920 2d3e 2069 6e74 3a0a 2020 2020  lf) -> int:.    
-000190e0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-000190f0: 7368 6170 655b 315d 0a0a 2020 2020 4070  shape[1]..    @p
-00019100: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-00019110: 7379 2873 656c 6629 202d 3e20 696e 743a  sy(self) -> int:
-00019120: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00019130: 7365 6c66 2e73 6861 7065 5b30 5d0a 0a20  self.shape[0].. 
-00019140: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-00019150: 2064 6566 206c 6162 656c 2873 656c 6629   def label(self)
-00019160: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-00019170: 2072 6574 7572 6e20 2264 6567 7265 6573   return "degrees
-00019180: 2220 6966 2073 656c 662e 6b69 6e64 203d  " if self.kind =
-00019190: 3d20 2272 736d 2220 656c 7365 2022 c2b5  = "rsm" else "..
-000191a0: 6d22 0a0a 2020 2020 4070 726f 7065 7274  m"..    @propert
-000191b0: 790a 2020 2020 6465 6620 7872 6567 756c  y.    def xregul
-000191c0: 6172 2873 656c 6629 202d 3e20 6e75 6d70  ar(self) -> nump
-000191d0: 792e 6e64 6172 7261 793a 0a20 2020 2020  y.ndarray:.     
-000191e0: 2020 2072 6574 7572 6e20 7365 6c66 2e78     return self.x
-000191f0: 7363 616c 6520 2a20 6e75 6d70 792e 6172  scale * numpy.ar
-00019200: 616e 6765 2873 656c 662e 7378 2920 2b20  ange(self.sx) + 
-00019210: 7365 6c66 2e78 6f72 6967 696e 0a0a 2020  self.xorigin..  
-00019220: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00019230: 6465 6620 7972 6567 756c 6172 2873 656c  def yregular(sel
-00019240: 6629 202d 3e20 6e75 6d70 792e 6e64 6172  f) -> numpy.ndar
-00019250: 7261 793a 0a20 2020 2020 2020 2072 6574  ray:.        ret
-00019260: 7572 6e20 7365 6c66 2e79 7363 616c 6520  urn self.yscale 
-00019270: 2a20 6e75 6d70 792e 6172 616e 6765 2873  * numpy.arange(s
-00019280: 656c 662e 7379 2920 2b20 7365 6c66 2e79  elf.sy) + self.y
-00019290: 6f72 6967 696e 0a0a 2020 2020 4070 726f  origin..    @pro
-000192a0: 7065 7274 790a 2020 2020 6465 6620 786f  perty.    def xo
-000192b0: 7269 6769 6e28 7365 6c66 2920 2d3e 204e  rigin(self) -> N
-000192c0: 756d 6265 723a 0a20 2020 2020 2020 2072  umber:.        r
-000192d0: 6574 7572 6e20 7365 6c66 2e78 5b30 5d5b  eturn self.x[0][
-000192e0: 305d 0a0a 2020 2020 4070 726f 7065 7274  0]..    @propert
-000192f0: 790a 2020 2020 6465 6620 796f 7269 6769  y.    def yorigi
-00019300: 6e28 7365 6c66 2920 2d3e 204e 756d 6265  n(self) -> Numbe
-00019310: 723a 0a20 2020 2020 2020 2072 6574 7572  r:.        retur
-00019320: 6e20 7365 6c66 2e79 5b30 5d5b 305d 0a0a  n self.y[0][0]..
-00019330: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-00019340: 2020 6465 6620 6f72 6967 696e 2873 656c    def origin(sel
-00019350: 6629 202d 3e20 5475 706c 655b 4e75 6d62  f) -> Tuple[Numb
-00019360: 6572 2c20 4e75 6d62 6572 5d3a 0a20 2020  er, Number]:.   
-00019370: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00019380: 2e78 6f72 6967 696e 2c20 7365 6c66 2e79  .xorigin, self.y
-00019390: 6f72 6967 696e 0a0a 2020 2020 4070 726f  origin..    @pro
-000193a0: 7065 7274 790a 2020 2020 6465 6620 7873  perty.    def xs
-000193b0: 6361 6c65 2873 656c 6629 202d 3e20 4e75  cale(self) -> Nu
-000193c0: 6d62 6572 3a0a 2020 2020 2020 2020 7820  mber:.        x 
-000193d0: 3d20 7365 6c66 2e78 0a20 2020 2020 2020  = self.x.       
-000193e0: 2072 6574 7572 6e20 2878 5b2d 315d 5b2d   return (x[-1][-
-000193f0: 315d 202d 2078 5b30 5d5b 305d 2920 2f20  1] - x[0][0]) / 
-00019400: 7365 6c66 2e73 780a 0a20 2020 2040 7072  self.sx..    @pr
-00019410: 6f70 6572 7479 0a20 2020 2064 6566 2079  operty.    def y
-00019420: 7363 616c 6528 7365 6c66 2920 2d3e 204e  scale(self) -> N
-00019430: 756d 6265 723a 0a20 2020 2020 2020 2079  umber:.        y
-00019440: 203d 2073 656c 662e 790a 2020 2020 2020   = self.y.      
-00019450: 2020 7265 7475 726e 2028 795b 2d31 5d5b    return (y[-1][
-00019460: 2d31 5d20 2d20 795b 305d 5b30 5d29 202f  -1] - y[0][0]) /
-00019470: 2073 656c 662e 7379 0a0a 2020 2020 4070   self.sy..    @p
-00019480: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-00019490: 7363 616c 6528 7365 6c66 2920 2d3e 2054  scale(self) -> T
-000194a0: 7570 6c65 5b4e 756d 6265 722c 204e 756d  uple[Number, Num
-000194b0: 6265 725d 3a0a 2020 2020 2020 2020 7265  ber]:.        re
-000194c0: 7475 726e 2073 656c 662e 7873 6361 6c65  turn self.xscale
-000194d0: 2c20 7365 6c66 2e79 7363 616c 650a 0a0a  , self.yscale...
-000194e0: 636c 6173 7320 5f48 4446 354d 6574 6164  class _HDF5Metad
-000194f0: 6174 6152 6561 6465 723a 0a20 2020 2022  ataReader:.    "
-00019500: 2222 0a20 2020 2045 7175 6976 616c 656e  "".    Equivalen
-00019510: 7420 6f66 2073 696c 782e 696f 2e66 6162  t of silx.io.fab
-00019520: 696f 6835 2e46 6162 696f 5265 6164 6572  ioh5.FabioReader
-00019530: 2074 6f20 6769 7665 2061 6363 6573 7320   to give access 
-00019540: 746f 2048 4446 3520 6d65 7461 6461 7461  to HDF5 metadata
-00019550: 0a0a 2020 2020 4649 584d 453a 2072 656d  ..    FIXME: rem
-00019560: 6f76 6520 7468 6973 2063 6c61 7373 2e20  ove this class. 
-00019570: 5374 6f72 6167 6520 616e 6420 7265 6164  Storage and read
-00019580: 696e 6720 6f66 206d 6574 6164 6174 6120  ing of metadata 
-00019590: 6861 7320 6265 656e 2062 6173 6564 206f  has been based o
-000195a0: 6e20 4544 462e 2054 6869 7320 636c 6173  n EDF. This clas
-000195b0: 7320 6973 2061 2077 6f72 6b2d 6172 6f75  s is a work-arou
-000195c0: 6e64 0a20 2020 2044 6573 6967 6e20 6f66  nd.    Design of
-000195d0: 2068 616e 646c 6520 6d65 7461 6461 7461   handle metadata
-000195e0: 2073 686f 756c 646e 2774 2062 6520 6261   shouldn't be ba
-000195f0: 7365 6420 6f6e 2074 6865 2064 6174 6120  sed on the data 
-00019600: 7479 7065 2062 7574 206d 6f72 6520 6162  type but more ab
-00019610: 7374 7261 6374 6564 0a20 2020 2022 2222  stracted.    """
-00019620: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-00019630: 5f5f 2873 656c 662c 206d 6574 6164 6174  __(self, metadat
-00019640: 613a 2064 6963 7429 202d 3e20 4e6f 6e65  a: dict) -> None
-00019650: 3a0a 2020 2020 2020 2020 7365 6c66 2e5f  :.        self._
-00019660: 5f6d 6574 6164 6174 6120 3d20 6d65 7461  _metadata = meta
-00019670: 6461 7461 0a0a 2020 2020 6465 6620 6765  data..    def ge
-00019680: 745f 7661 6c75 6528 7365 6c66 2c20 6b69  t_value(self, ki
-00019690: 6e64 2c20 6e61 6d65 293a 0a20 2020 2020  nd, name):.     
-000196a0: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
-000196b0: 5f6d 6574 6164 6174 612e 6765 7428 6e61  _metadata.get(na
-000196c0: 6d65 2c20 4e6f 6e65 290a 0a20 2020 2064  me, None)..    d
-000196d0: 6566 2067 6574 5f6b 6579 7328 7365 6c66  ef get_keys(self
-000196e0: 2c20 6b69 6e64 293a 0a20 2020 2020 2020  , kind):.       
-000196f0: 2072 6574 7572 6e20 7475 706c 6528 7365   return tuple(se
-00019700: 6c66 2e5f 5f6d 6574 6164 6174 612e 6b65  lf.__metadata.ke
-00019710: 7973 2829 290a                           ys()).
+00018680: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00018690: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000186a0: 7375 7065 7228 4461 7461 2c20 6461 7461  super(Data, data
+000186b0: 292e 7375 6d28 290a 2020 2020 2020 2020  ).sum().        
+000186c0: 2020 2020 7261 6973 6520 5479 7065 4572      raise TypeEr
+000186d0: 726f 7228 2241 7869 7320 6d75 7374 2062  ror("Axis must b
+000186e0: 6520 4e6f 6e65 2c20 3020 6f72 2031 2229  e None, 0 or 1")
+000186f0: 0a20 2020 2020 2020 2069 6620 6178 6973  .        if axis
+00018700: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
+00018710: 2020 2069 6620 6461 7461 2e73 697a 6520     if data.size 
+00018720: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+00018730: 2020 2020 2020 7265 7475 726e 206e 756d        return num
+00018740: 7079 2e61 7272 6179 285b 5d29 0a20 2020  py.array([]).   
+00018750: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00018760: 6461 7461 2e73 6861 7065 5b30 5d3a 0a20  data.shape[0]:. 
+00018770: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00018780: 6574 7572 6e20 6e75 6d70 792e 7a65 726f  eturn numpy.zero
+00018790: 7328 6461 7461 5b30 5d2e 7368 6170 6529  s(data[0].shape)
+000187a0: 0a20 2020 2020 2020 2020 2020 207a 7375  .            zsu
+000187b0: 6d20 3d20 6e75 6d70 792e 6172 7261 7928  m = numpy.array(
+000187c0: 6461 7461 5b30 5d2c 2064 7479 7065 3d6e  data[0], dtype=n
+000187d0: 756d 7079 2e66 6c6f 6174 3634 290a 2020  umpy.float64).  
+000187e0: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
+000187f0: 696e 2072 616e 6765 2831 2c20 6c65 6e28  in range(1, len(
+00018800: 6461 7461 2929 3a0a 2020 2020 2020 2020  data)):.        
+00018810: 2020 2020 2020 2020 7a73 756d 202b 3d20          zsum += 
+00018820: 6461 7461 5b69 5d0a 2020 2020 2020 2020  data[i].        
+00018830: 2020 2020 7265 7475 726e 207a 7375 6d0a      return zsum.
+00018840: 2020 2020 2020 2020 6966 2061 7869 7320          if axis 
+00018850: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
+00018860: 2020 7265 7475 726e 206e 756d 7079 2e61    return numpy.a
+00018870: 7272 6179 285b 692e 7375 6d28 2920 666f  rray([i.sum() fo
+00018880: 7220 6920 696e 2064 6174 615d 290a 2020  r i in data]).  
+00018890: 2020 2020 2020 6966 2061 7869 7320 6973        if axis is
+000188a0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000188b0: 2020 2069 6d67 5f73 756d 203d 2030 0a20     img_sum = 0. 
+000188c0: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+000188d0: 2069 6e20 6461 7461 3a0a 2020 2020 2020   in data:.      
+000188e0: 2020 2020 2020 2020 2020 696d 675f 7375            img_su
+000188f0: 6d20 2b3d 2069 2e73 756d 2829 0a20 2020  m += i.sum().   
+00018900: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00018910: 696d 675f 7375 6d0a 2020 2020 2020 2020  img_sum.        
+00018920: 7261 6973 6520 5479 7065 4572 726f 7228  raise TypeError(
+00018930: 2241 7869 7320 6d75 7374 2062 6520 4e6f  "Axis must be No
+00018940: 6e65 2c20 3020 6f72 2031 2229 0a0a 2020  ne, 0 or 1")..  
+00018950: 2020 6465 6620 7461 6b65 2873 656c 662c    def take(self,
+00018960: 2069 6e64 6963 6573 2c20 6178 6973 3d4e   indices, axis=N
+00018970: 6f6e 652c 206f 7574 3d4e 6f6e 652c 206d  one, out=None, m
+00018980: 6f64 653d 2272 6169 7365 2229 202d 3e20  ode="raise") -> 
+00018990: 2244 6174 6122 3a0a 2020 2020 2020 2020  "Data":.        
+000189a0: 2222 220a 2020 2020 2020 2020 5461 6b65  """.        Take
+000189b0: 2065 6c65 6d65 6e74 7320 6672 6f6d 2075   elements from u
+000189c0: 726c 7320 616e 6420 6d65 7461 6461 7461  rls and metadata
+000189d0: 2066 726f 6d20 616e 2061 7272 6179 2061   from an array a
+000189e0: 6c6f 6e67 2061 6e20 6178 6973 2e0a 0a20  long an axis... 
+000189f0: 2020 2020 2020 203a 7061 7261 6d20 696e         :param in
+00018a00: 6469 6365 733a 2074 6865 2069 6e64 6963  dices: the indic
+00018a10: 6573 206f 6620 7468 6520 7661 6c75 6573  es of the values
+00018a20: 2074 6f20 6578 7472 6163 740a 2020 2020   to extract.    
+00018a30: 2020 2020 3a74 7970 6520 696e 6469 6365      :type indice
+00018a40: 733a 2061 7272 6179 5f6c 696b 650a 2020  s: array_like.  
+00018a50: 2020 2020 2020 3a70 6172 616d 2061 7869        :param axi
+00018a60: 733a 2074 6865 2061 7869 7320 6f76 6572  s: the axis over
+00018a70: 2077 6869 6368 2074 6f20 7365 6c65 6374   which to select
+00018a80: 2076 616c 7565 732c 2064 6566 6175 6c74   values, default
+00018a90: 7320 746f 204e 6f6e 650a 2020 2020 2020  s to None.      
+00018aa0: 2020 3a74 7970 6520 6178 6973 3a20 556e    :type axis: Un
+00018ab0: 696f 6e5b 4e20 6f6e 652c 2069 6e74 5d2c  ion[N one, int],
+00018ac0: 206f 7074 696f 6e61 6c0a 0a20 2020 2020   optional..     
+00018ad0: 2020 203a 7265 7475 726e 3a20 466c 6174     :return: Flat
+00018ae0: 7465 6e65 6420 6461 7461 2e0a 2020 2020  tened data..    
+00018af0: 2020 2020 3a72 7479 7065 3a20 3a63 6c61      :rtype: :cla
+00018b00: 7373 3a60 4461 7461 600a 2020 2020 2020  ss:`Data`.      
+00018b10: 2020 2222 220a 2020 2020 2020 2020 7572    """.        ur
+00018b20: 6c73 203d 206e 756d 7079 2e74 616b 6528  ls = numpy.take(
+00018b30: 7365 6c66 2e75 726c 732c 2069 6e64 6963  self.urls, indic
+00018b40: 6573 2c20 6178 6973 2c20 6d6f 6465 3d6d  es, axis, mode=m
+00018b50: 6f64 6529 0a20 2020 2020 2020 206d 6574  ode).        met
+00018b60: 6164 6174 6120 3d20 6e75 6d70 792e 7461  adata = numpy.ta
+00018b70: 6b65 2873 656c 662e 6d65 7461 6461 7461  ke(self.metadata
+00018b80: 2c20 696e 6469 6365 732c 2061 7869 732c  , indices, axis,
+00018b90: 206d 6f64 653d 6d6f 6465 290a 2020 2020   mode=mode).    
+00018ba0: 2020 2020 6461 7461 203d 204e 6f6e 650a      data = None.
+00018bb0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00018bc0: 696e 5f6d 656d 6f72 793a 0a20 2020 2020  in_memory:.     
+00018bd0: 2020 2020 2020 2064 6174 6120 3d20 7375         data = su
+00018be0: 7065 7228 292e 7461 6b65 2869 6e64 6963  per().take(indic
+00018bf0: 6573 2c20 6178 6973 2c20 6d6f 6465 3d6d  es, axis, mode=m
+00018c00: 6f64 6529 2e76 6965 7728 6e75 6d70 792e  ode).view(numpy.
+00018c10: 6e64 6172 7261 7929 0a20 2020 2020 2020  ndarray).       
+00018c20: 2072 6574 7572 6e20 4461 7461 2875 726c   return Data(url
+00018c30: 732c 206d 6574 6164 6174 612c 2073 656c  s, metadata, sel
+00018c40: 662e 696e 5f6d 656d 6f72 792c 2064 6174  f.in_memory, dat
+00018c50: 613d 6461 7461 290a 0a20 2020 2064 6566  a=data)..    def
+00018c60: 2066 6c61 7474 656e 2873 656c 6629 202d   flatten(self) -
+00018c70: 3e20 2244 6174 6122 3a0a 2020 2020 2020  > "Data":.      
+00018c80: 2020 2222 2246 6c61 7474 656e 7320 7468    """Flattens th
+00018c90: 6520 7363 616e 2064 696d 656e 7369 6f6e  e scan dimension
+00018ca0: 732c 206e 6f74 2074 6865 2066 7261 6d65  s, not the frame
+00018cb0: 2064 696d 656e 7369 6f6e 732e 0a20 2020   dimensions..   
+00018cc0: 2020 2020 2054 4f44 4f3a 2074 6869 7320       TODO: this 
+00018cd0: 7368 6f75 6c64 2067 6574 2061 2064 6966  should get a dif
+00018ce0: 6665 7265 6e74 2066 756e 6374 696f 6e20  ferent function 
+00018cf0: 6e61 6d65 0a0a 2020 2020 2020 2020 3a72  name..        :r
+00018d00: 6574 7572 6e3a 206e 6577 2064 6174 6120  eturn: new data 
+00018d10: 7769 7468 2066 6c61 7474 656e 6564 2075  with flattened u
+00018d20: 726c 7320 616e 6420 6d65 7461 6461 7461  rls and metadata
+00018d30: 2028 6275 7420 6e6f 7420 6672 616d 6573   (but not frames
+00018d40: 292e 0a20 2020 2020 2020 203a 7274 7970  )..        :rtyp
+00018d50: 653a 203a 636c 6173 733a 6044 6174 6160  e: :class:`Data`
+00018d60: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00018d70: 2020 2020 2069 6620 7365 6c66 2e6e 6672       if self.nfr
+00018d80: 616d 6573 203d 3d20 3020 6f72 2073 656c  ames == 0 or sel
+00018d90: 662e 6e64 696d 203c 3d20 333a 0a20 2020  f.ndim <= 3:.   
+00018da0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00018db0: 7365 6c66 0a20 2020 2020 2020 2064 6174  self.        dat
+00018dc0: 6120 3d20 4e6f 6e65 0a20 2020 2020 2020  a = None.       
+00018dd0: 2069 6620 7365 6c66 2e69 6e5f 6d65 6d6f   if self.in_memo
+00018de0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00018df0: 6673 6861 7065 203d 2028 7365 6c66 2e6e  fshape = (self.n
+00018e00: 6672 616d 6573 2c29 202b 2073 656c 662e  frames,) + self.
+00018e10: 6672 616d 655f 7368 6170 650a 2020 2020  frame_shape.    
+00018e20: 2020 2020 2020 2020 2320 544f 444f 3a20          # TODO: 
+00018e30: 6e6f 7420 7375 7265 2077 6879 2077 6520  not sure why we 
+00018e40: 6e65 6564 2074 6865 2076 6577 2068 6572  need the vew her
+00018e50: 653a 0a20 2020 2020 2020 2020 2020 2064  e:.            d
+00018e60: 6174 6120 3d20 7375 7065 7228 292e 7265  ata = super().re
+00018e70: 7368 6170 6528 6673 6861 7065 292e 7669  shape(fshape).vi
+00018e80: 6577 286e 756d 7079 2e6e 6461 7272 6179  ew(numpy.ndarray
+00018e90: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00018ea0: 2044 6174 6128 0a20 2020 2020 2020 2020   Data(.         
+00018eb0: 2020 2073 656c 662e 7572 6c73 2e66 6c61     self.urls.fla
+00018ec0: 7474 656e 2829 2c20 7365 6c66 2e6d 6574  tten(), self.met
+00018ed0: 6164 6174 612e 666c 6174 7465 6e28 292c  adata.flatten(),
+00018ee0: 2073 656c 662e 696e 5f6d 656d 6f72 792c   self.in_memory,
+00018ef0: 2064 6174 613d 6461 7461 0a20 2020 2020   data=data.     
+00018f00: 2020 2029 0a0a 0a63 6c61 7373 2054 7261     )...class Tra
+00018f10: 6e73 666f 726d 6174 696f 6e3a 0a20 2020  nsformation:.   
+00018f20: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+00018f30: 6c66 2c20 6b69 6e64 3a20 7374 722c 2078  lf, kind: str, x
+00018f40: 3a20 6e75 6d70 792e 6e64 6172 7261 792c  : numpy.ndarray,
+00018f50: 2079 3a20 6e75 6d70 792e 6e64 6172 7261   y: numpy.ndarra
+00018f60: 792c 2072 6f74 6174 653a 2062 6f6f 6c29  y, rotate: bool)
+00018f70: 3a0a 2020 2020 2020 2020 7365 6c66 2e78  :.        self.x
+00018f80: 203d 2078 2020 2320 7368 6170 6520 2873   = x  # shape (s
+00018f90: 792c 2073 7829 0a20 2020 2020 2020 2073  y, sx).        s
+00018fa0: 656c 662e 7920 3d20 7920 2023 2073 6861  elf.y = y  # sha
+00018fb0: 7065 2028 7379 2c20 7378 290a 2020 2020  pe (sy, sx).    
+00018fc0: 2020 2020 7365 6c66 2e72 6f74 6174 6520      self.rotate 
+00018fd0: 3d20 726f 7461 7465 0a20 2020 2020 2020  = rotate.       
+00018fe0: 2073 656c 662e 6b69 6e64 203d 206b 696e   self.kind = kin
+00018ff0: 640a 0a20 2020 2040 7072 6f70 6572 7479  d..    @property
+00019000: 0a20 2020 2064 6566 2073 6861 7065 2873  .    def shape(s
+00019010: 656c 6629 202d 3e20 5475 706c 655b 696e  elf) -> Tuple[in
+00019020: 742c 2069 6e74 5d3a 0a20 2020 2020 2020  t, int]:.       
+00019030: 2072 6574 7572 6e20 7365 6c66 2e78 2e73   return self.x.s
+00019040: 6861 7065 0a0a 2020 2020 4070 726f 7065  hape..    @prope
+00019050: 7274 790a 2020 2020 6465 6620 7378 2873  rty.    def sx(s
+00019060: 656c 6629 202d 3e20 696e 743a 0a20 2020  elf) -> int:.   
+00019070: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00019080: 2e73 6861 7065 5b31 5d0a 0a20 2020 2040  .shape[1]..    @
+00019090: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+000190a0: 2073 7928 7365 6c66 2920 2d3e 2069 6e74   sy(self) -> int
+000190b0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+000190c0: 2073 656c 662e 7368 6170 655b 305d 0a0a   self.shape[0]..
+000190d0: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+000190e0: 2020 6465 6620 6c61 6265 6c28 7365 6c66    def label(self
+000190f0: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
+00019100: 2020 7265 7475 726e 2022 6465 6772 6565    return "degree
+00019110: 7322 2069 6620 7365 6c66 2e6b 696e 6420  s" if self.kind 
+00019120: 3d3d 2022 7273 6d22 2065 6c73 6520 22c2  == "rsm" else ".
+00019130: b56d 220a 0a20 2020 2040 7072 6f70 6572  .m"..    @proper
+00019140: 7479 0a20 2020 2064 6566 2078 7265 6775  ty.    def xregu
+00019150: 6c61 7228 7365 6c66 2920 2d3e 206e 756d  lar(self) -> num
+00019160: 7079 2e6e 6461 7272 6179 3a0a 2020 2020  py.ndarray:.    
+00019170: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00019180: 7873 6361 6c65 202a 206e 756d 7079 2e61  xscale * numpy.a
+00019190: 7261 6e67 6528 7365 6c66 2e73 7829 202b  range(self.sx) +
+000191a0: 2073 656c 662e 786f 7269 6769 6e0a 0a20   self.xorigin.. 
+000191b0: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+000191c0: 2064 6566 2079 7265 6775 6c61 7228 7365   def yregular(se
+000191d0: 6c66 2920 2d3e 206e 756d 7079 2e6e 6461  lf) -> numpy.nda
+000191e0: 7272 6179 3a0a 2020 2020 2020 2020 7265  rray:.        re
+000191f0: 7475 726e 2073 656c 662e 7973 6361 6c65  turn self.yscale
+00019200: 202a 206e 756d 7079 2e61 7261 6e67 6528   * numpy.arange(
+00019210: 7365 6c66 2e73 7929 202b 2073 656c 662e  self.sy) + self.
+00019220: 796f 7269 6769 6e0a 0a20 2020 2040 7072  yorigin..    @pr
+00019230: 6f70 6572 7479 0a20 2020 2064 6566 2078  operty.    def x
+00019240: 6f72 6967 696e 2873 656c 6629 202d 3e20  origin(self) -> 
+00019250: 4e75 6d62 6572 3a0a 2020 2020 2020 2020  Number:.        
+00019260: 7265 7475 726e 2073 656c 662e 785b 305d  return self.x[0]
+00019270: 5b30 5d0a 0a20 2020 2040 7072 6f70 6572  [0]..    @proper
+00019280: 7479 0a20 2020 2064 6566 2079 6f72 6967  ty.    def yorig
+00019290: 696e 2873 656c 6629 202d 3e20 4e75 6d62  in(self) -> Numb
+000192a0: 6572 3a0a 2020 2020 2020 2020 7265 7475  er:.        retu
+000192b0: 726e 2073 656c 662e 795b 305d 5b30 5d0a  rn self.y[0][0].
+000192c0: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+000192d0: 2020 2064 6566 206f 7269 6769 6e28 7365     def origin(se
+000192e0: 6c66 2920 2d3e 2054 7570 6c65 5b4e 756d  lf) -> Tuple[Num
+000192f0: 6265 722c 204e 756d 6265 725d 3a0a 2020  ber, Number]:.  
+00019300: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00019310: 662e 786f 7269 6769 6e2c 2073 656c 662e  f.xorigin, self.
+00019320: 796f 7269 6769 6e0a 0a20 2020 2040 7072  yorigin..    @pr
+00019330: 6f70 6572 7479 0a20 2020 2064 6566 2078  operty.    def x
+00019340: 7363 616c 6528 7365 6c66 2920 2d3e 204e  scale(self) -> N
+00019350: 756d 6265 723a 0a20 2020 2020 2020 2078  umber:.        x
+00019360: 203d 2073 656c 662e 780a 2020 2020 2020   = self.x.      
+00019370: 2020 7265 7475 726e 2028 785b 2d31 5d5b    return (x[-1][
+00019380: 2d31 5d20 2d20 785b 305d 5b30 5d29 202f  -1] - x[0][0]) /
+00019390: 2073 656c 662e 7378 0a0a 2020 2020 4070   self.sx..    @p
+000193a0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+000193b0: 7973 6361 6c65 2873 656c 6629 202d 3e20  yscale(self) -> 
+000193c0: 4e75 6d62 6572 3a0a 2020 2020 2020 2020  Number:.        
+000193d0: 7920 3d20 7365 6c66 2e79 0a20 2020 2020  y = self.y.     
+000193e0: 2020 2072 6574 7572 6e20 2879 5b2d 315d     return (y[-1]
+000193f0: 5b2d 315d 202d 2079 5b30 5d5b 305d 2920  [-1] - y[0][0]) 
+00019400: 2f20 7365 6c66 2e73 790a 0a20 2020 2040  / self.sy..    @
+00019410: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+00019420: 2073 6361 6c65 2873 656c 6629 202d 3e20   scale(self) -> 
+00019430: 5475 706c 655b 4e75 6d62 6572 2c20 4e75  Tuple[Number, Nu
+00019440: 6d62 6572 5d3a 0a20 2020 2020 2020 2072  mber]:.        r
+00019450: 6574 7572 6e20 7365 6c66 2e78 7363 616c  eturn self.xscal
+00019460: 652c 2073 656c 662e 7973 6361 6c65 0a0a  e, self.yscale..
+00019470: 0a63 6c61 7373 205f 4844 4635 4d65 7461  .class _HDF5Meta
+00019480: 6461 7461 5265 6164 6572 3a0a 2020 2020  dataReader:.    
+00019490: 2222 220a 2020 2020 4571 7569 7661 6c65  """.    Equivale
+000194a0: 6e74 206f 6620 7369 6c78 2e69 6f2e 6661  nt of silx.io.fa
+000194b0: 6269 6f68 352e 4661 6269 6f52 6561 6465  bioh5.FabioReade
+000194c0: 7220 746f 2067 6976 6520 6163 6365 7373  r to give access
+000194d0: 2074 6f20 4844 4635 206d 6574 6164 6174   to HDF5 metadat
+000194e0: 610a 0a20 2020 2046 4958 4d45 3a20 7265  a..    FIXME: re
+000194f0: 6d6f 7665 2074 6869 7320 636c 6173 732e  move this class.
+00019500: 2053 746f 7261 6765 2061 6e64 2072 6561   Storage and rea
+00019510: 6469 6e67 206f 6620 6d65 7461 6461 7461  ding of metadata
+00019520: 2068 6173 2062 6565 6e20 6261 7365 6420   has been based 
+00019530: 6f6e 2045 4446 2e20 5468 6973 2063 6c61  on EDF. This cla
+00019540: 7373 2069 7320 6120 776f 726b 2d61 726f  ss is a work-aro
+00019550: 756e 640a 2020 2020 4465 7369 676e 206f  und.    Design o
+00019560: 6620 6861 6e64 6c65 206d 6574 6164 6174  f handle metadat
+00019570: 6120 7368 6f75 6c64 6e27 7420 6265 2062  a shouldn't be b
+00019580: 6173 6564 206f 6e20 7468 6520 6461 7461  ased on the data
+00019590: 2074 7970 6520 6275 7420 6d6f 7265 2061   type but more a
+000195a0: 6273 7472 6163 7465 640a 2020 2020 2222  bstracted.    ""
+000195b0: 220a 0a20 2020 2064 6566 205f 5f69 6e69  "..    def __ini
+000195c0: 745f 5f28 7365 6c66 2c20 6d65 7461 6461  t__(self, metada
+000195d0: 7461 3a20 6469 6374 2920 2d3e 204e 6f6e  ta: dict) -> Non
+000195e0: 653a 0a20 2020 2020 2020 2073 656c 662e  e:.        self.
+000195f0: 5f6d 6574 6164 6174 6120 3d20 6d65 7461  _metadata = meta
+00019600: 6461 7461 0a0a 2020 2020 6465 6620 6765  data..    def ge
+00019610: 745f 7661 6c75 6528 7365 6c66 2c20 6b69  t_value(self, ki
+00019620: 6e64 2c20 6e61 6d65 293a 0a20 2020 2020  nd, name):.     
+00019630: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+00019640: 6d65 7461 6461 7461 2e67 6574 286e 616d  metadata.get(nam
+00019650: 652c 204e 6f6e 6529 0a0a 2020 2020 6465  e, None)..    de
+00019660: 6620 6765 745f 6b65 7973 2873 656c 662c  f get_keys(self,
+00019670: 206b 696e 6429 3a0a 2020 2020 2020 2020   kind):.        
+00019680: 7265 7475 726e 2074 7570 6c65 2873 656c  return tuple(sel
+00019690: 662e 5f6d 6574 6164 6174 612e 6b65 7973  f._metadata.keys
+000196a0: 2829 290a 0a0a 6465 6620 5f65 7874 7261  ())...def _extra
+000196b0: 6374 5f6d 6574 6164 6174 615f 7661 6c75  ct_metadata_valu
+000196c0: 6573 280a 2020 2020 6d65 7461 6461 7461  es(.    metadata
+000196d0: 2c0a 2020 2020 6b69 6e64 2c0a 2020 2020  ,.    kind,.    
+000196e0: 6b65 792c 0a20 2020 206d 6973 7369 6e67  key,.    missing
+000196f0: 5f76 616c 7565 3d6e 756d 7079 2e6e 616e  _value=numpy.nan
+00019700: 2c0a 2020 2020 7461 6b65 5f70 7265 7669  ,.    take_previ
+00019710: 6f75 735f 7768 656e 5f6d 6973 7369 6e67  ous_when_missing
+00019720: 3a20 626f 6f6c 203d 2054 7275 652c 0a29  : bool = True,.)
+00019730: 202d 3e20 6c69 7374 3a0a 2020 2020 7661   -> list:.    va
+00019740: 6c75 6573 203d 205b 5d0a 2020 2020 6861  lues = [].    ha
+00019750: 735f 6d69 7373 696e 675f 7661 6c75 6520  s_missing_value 
+00019760: 3d20 4661 6c73 650a 2020 2020 666f 7220  = False.    for 
+00019770: 6461 7461 2069 6e20 6d65 7461 6461 7461  data in metadata
+00019780: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
+00019790: 2020 2020 2020 2020 2020 2076 616c 7565             value
+000197a0: 203d 2064 6174 612e 6765 745f 7661 6c75   = data.get_valu
+000197b0: 6528 6b69 6e64 3d6b 696e 642c 206e 616d  e(kind=kind, nam
+000197c0: 653d 6b65 7929 0a20 2020 2020 2020 2065  e=key).        e
+000197d0: 7863 6570 7420 4b65 7945 7272 6f72 3a0a  xcept KeyError:.
+000197e0: 2020 2020 2020 2020 2020 2020 6861 735f              has_
+000197f0: 6d69 7373 696e 675f 7661 6c75 6520 3d20  missing_value = 
+00019800: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+00019810: 2069 6620 7461 6b65 5f70 7265 7669 6f75   if take_previou
+00019820: 735f 7768 656e 5f6d 6973 7369 6e67 2061  s_when_missing a
+00019830: 6e64 2076 616c 7565 733a 0a20 2020 2020  nd values:.     
+00019840: 2020 2020 2020 2020 2020 2076 616c 7565             value
+00019850: 732e 6170 7065 6e64 2876 616c 7565 735b  s.append(values[
+00019860: 2d31 5d29 0a20 2020 2020 2020 2020 2020  -1]).           
+00019870: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00019880: 2020 2020 2020 2076 616c 7565 732e 6170         values.ap
+00019890: 7065 6e64 286d 6973 7369 6e67 5f76 616c  pend(missing_val
+000198a0: 7565 290a 2020 2020 2020 2020 656c 7365  ue).        else
+000198b0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+000198c0: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+000198d0: 6461 7461 2c20 5f48 4446 354d 6574 6164  data, _HDF5Metad
+000198e0: 6174 6152 6561 6465 7229 3a0a 2020 2020  ataReader):.    
+000198f0: 2020 2020 2020 2020 2020 2020 2320 5f48              # _H
+00019900: 4446 354d 6574 6164 6174 6152 6561 6465  DF5MetadataReade
+00019910: 7220 616c 7265 6164 7920 7265 7475 726e  r already return
+00019920: 7320 6120 7363 616c 6172 2077 6865 6e20  s a scalar when 
+00019930: 7369 6c78 2046 6162 696f 5265 6164 6572  silx FabioReader
+00019940: 2072 6574 7572 6e20 616e 2061 7272 6179   return an array
+00019950: 206f 6620 6120 7369 6e67 6c65 2065 6c65   of a single ele
+00019960: 6d65 6e74 0a20 2020 2020 2020 2020 2020  ment.           
+00019970: 2020 2020 2076 616c 7565 203d 2076 616c       value = val
+00019980: 7565 5b30 5d0a 2020 2020 2020 2020 2020  ue[0].          
+00019990: 2020 7661 6c75 6573 2e61 7070 656e 6428    values.append(
+000199a0: 7661 6c75 6529 0a20 2020 2069 6620 6861  value).    if ha
+000199b0: 735f 6d69 7373 696e 675f 7661 6c75 653a  s_missing_value:
+000199c0: 0a20 2020 2020 2020 2069 6620 7461 6b65  .        if take
+000199d0: 5f70 7265 7669 6f75 735f 7768 656e 5f6d  _previous_when_m
+000199e0: 6973 7369 6e67 3a0a 2020 2020 2020 2020  issing:.        
+000199f0: 2020 2020 5f6c 6f67 6765 722e 7761 726e      _logger.warn
+00019a00: 696e 6728 0a20 2020 2020 2020 2020 2020  ing(.           
+00019a10: 2020 2020 2022 4d69 7373 696e 6720 7661       "Missing va
+00019a20: 6c75 6528 7329 2066 696c 6c65 6420 746f  lue(s) filled to
+00019a30: 2070 7265 7669 6f75 7320 7661 6c75 6520   previous value 
+00019a40: 666f 7220 6b69 6e64 2027 2573 2720 616e  for kind '%s' an
+00019a50: 6420 6b65 7920 2725 7327 222c 0a20 2020  d key '%s'",.   
+00019a60: 2020 2020 2020 2020 2020 2020 206b 696e               kin
+00019a70: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00019a80: 2020 206b 6579 2c0a 2020 2020 2020 2020     key,.        
+00019a90: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
+00019aa0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00019ab0: 5f6c 6f67 6765 722e 7761 726e 696e 6728  _logger.warning(
+00019ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019ad0: 2022 4d69 7373 696e 6720 7661 6c75 6528   "Missing value(
+00019ae0: 7329 2066 696c 6c65 6420 7769 7468 2025  s) filled with %
+00019af0: 7320 666f 7220 6b69 6e64 2027 2573 2720  s for kind '%s' 
+00019b00: 616e 6420 6b65 7920 2725 7327 222c 0a20  and key '%s'",. 
+00019b10: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00019b20: 6973 7369 6e67 5f76 616c 7565 2c0a 2020  issing_value,.  
+00019b30: 2020 2020 2020 2020 2020 2020 2020 6b69                ki
+00019b40: 6e64 2c0a 2020 2020 2020 2020 2020 2020  nd,.            
+00019b50: 2020 2020 6b65 792c 0a20 2020 2020 2020      key,.       
+00019b60: 2020 2020 2029 0a20 2020 2072 6574 7572       ).    retur
+00019b70: 6e20 7661 6c75 6573 0a                   n values.
```

### Comparing `darfix-1.0.1rc1/src/darfix/core/dimension.py` & `darfix-1.0.2/src/darfix/core/dimension.py`

 * *Files 1% similar despite different names*

```diff
@@ -24,15 +24,15 @@
 _METADATA_TYPES_I = {}
 """used to retrieve the metadata name (str) for the silx.io.fabioh5 id"""
 for key, value in _METADATA_TYPES.items():
     assert value not in _METADATA_TYPES_I
     _METADATA_TYPES_I[value] = key
 
 
-class AcquisitionDims(object):
+class AcquisitionDims:
     """
     Define the view of the data which has to be made
     """
 
     def __init__(self):
         self.__dims = {}
 
@@ -126,15 +126,15 @@
                 self.add_dim(int(_axis), Dimension.from_dict(_dim))
 
     def __iter__(self):
         for iAxis, dim in sorted(self.__dims.items()):
             yield (iAxis, dim)
 
 
-class Dimension(object):
+class Dimension:
     """
     Define a dimension used during the dataset
 
     :param Union[int,str] kind: metadata type in fabioh5 mapping
     :param str name: name of the dimension (should fit the fabioh5 mapping
                      for now)
     :param Union[int,None] size: length of the dimension.
@@ -221,27 +221,30 @@
         """
         Sets the unique values of the dimension. If the size of the dimension is fixed,
         it automatically sets the first size values, else it finds the unique values.
 
         :param array_like values: list of values.
         """
         if self.range:
-            v0, v1, step = numpy.round(self.range, 5)
+            v0, v1, step = self.range
             if not step:
                 if not self.size:
                     self.__unique_values = self._values_with_step(
                         self._find_unique_values(values)
                     )
                 else:
                     step = (v1 - v0) / (self.size - 1)
                     self.__unique_values = [
                         s for s in numpy.linspace(v0, v1, self.size)
                     ]
             else:
-                size = int(numpy.round((v1 - v0) / step, 5)) + 1
+                if not self.size:
+                    size = int(numpy.round((v1 - v0) / step)) + 1
+                else:
+                    size = self.size
                 self.__unique_values = [s for s in numpy.linspace(v0, v1, size)]
             self.set_range([v0, v1, step])
         elif self.size:
             self.__unique_values = self._values_with_step(values[: self.size])
         else:
             self.__unique_values = self._values_with_step(
                 self._find_unique_values(values)
```

### Comparing `darfix-1.0.1rc1/src/darfix/core/geneticShiftDetection.py` & `darfix-1.0.2/src/darfix/core/geneticShiftDetection.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/core/imageOperations.py` & `darfix-1.0.2/src/darfix/core/imageOperations.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/core/imageRegistration.py` & `darfix-1.0.2/src/darfix/core/imageRegistration.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/core/mapping.py` & `darfix-1.0.2/src/darfix/core/mapping.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/core/process.py` & `darfix-1.0.2/src/darfix/core/process.py`

 * *Files 16% similar despite different names*

```diff
@@ -21,15 +21,15 @@
 from silx.io.url import DataUrl
 
 from ewokscore import Task
 from ewokscore.graph import TaskGraph
 from ewoksutils.import_utils import qualname
 
 from darfix.core import utils
-from darfix.io.hdf5 import VALID_HDF5_EXTENSIONS
+from darfix.io.hdf5 import is_hdf5
 from darfix.gui.blindSourceSeparationWidget import Method
 from darfix.gui.grainPlotWidget import GrainPlotWidget
 from darfix.gui.rsmHistogramWidget import RSMHistogramWidget
 from darfix.gui.zSumWidget import ZSumWidget
 from darfix.gui.rsmWidget import PixelSize
 from darfix.core.data_selection import load_process_data
 from darfix.io.utils import write_components
@@ -40,69 +40,91 @@
     graph: TaskGraph,
     filenames: Union[str, Iterable[str]],
     root_dir: Optional[str] = None,
     in_memory: bool = True,
     dark_filename: Optional[str] = None,
     copy_files: bool = True,
     title: Optional[str] = None,
+    metadata_url: Optional[str] = None,
+    raw_filename: Optional[str] = None,
 ):
     task_identifier = qualname(DataSelection)
     for node_attrs in graph.graph.nodes.values():
         if node_attrs.get("task_identifier") == task_identifier:
-            default_inputs = node_attrs["default_inputs"] = list()
-            default_inputs.append({"name": "root_dir", "value": root_dir})
-            default_inputs.append({"name": "filenames", "value": filenames})
-            default_inputs.append({"name": "dark_filename", "value": dark_filename})
-            default_inputs.append({"name": "copy_files", "value": copy_files})
-            default_inputs.append({"name": "in_memory", "value": in_memory})
-            default_inputs.append({"name": "title", "value": title})
+            default_inputs = node_attrs.setdefault("default_inputs", list())
+            if root_dir:
+                default_inputs.append({"name": "root_dir", "value": root_dir})
+            if filenames:
+                default_inputs.append({"name": "filenames", "value": filenames})
+            if dark_filename:
+                default_inputs.append({"name": "dark_filename", "value": dark_filename})
+            if copy_files:
+                default_inputs.append({"name": "copy_files", "value": copy_files})
+            if in_memory:
+                default_inputs.append({"name": "in_memory", "value": in_memory})
+            if title:
+                default_inputs.append({"name": "title", "value": title})
+            if metadata_url:
+                default_inputs.append({"name": "metadata_url", "value": metadata_url})
+            if raw_filename:
+                default_inputs.append({"name": "raw_filename", "value": raw_filename})
             return
     raise RuntimeError(f"Workflow {graph} does not contain a 'DataSelection' task")
 
 
 class DataSelection(
     Task,
-    input_names=["filenames"],
+    input_names=[],
     optional_input_names=[
+        "filenames",
         "root_dir",
         "in_memory",
         "dark_filename",
         "copy_files",
         "title",
+        "metadata_url",
+        "raw_filename",
     ],
     output_names=["dataset"],
 ):
     """Simple util class to ignore a processing when executing without GUI"""
 
     def run(self):
-        in_memory = self.inputs.in_memory
-        if in_memory == self.MISSING_DATA:
-            in_memory = True
-        copy_files = self.inputs.copy_files
-        if copy_files == self.MISSING_DATA:
-            copy_files = True
-        dark_filename = self.inputs.dark_filename
-        if dark_filename == self.MISSING_DATA:
-            dark_filename = None
+        in_memory = self.get_input_value("in_memory", True)
+        copy_files = self.get_input_value("copy_files", True)
+        dark_filename = self.get_input_value("dark_filename", None)
+        root_dir = self.get_input_value("root_dir", None)
+        title = self.get_input_value("title", "")
+        metadata_url = self.get_input_value("metadata_url", None)
 
+        filenames = self.get_input_value("filenames", None)
         isH5 = False
-        if isinstance(self.input_names, DataUrl):
-            _, ext = os.path.splitext(self.input_names.file_path())
-            if ext in VALID_HDF5_EXTENSIONS:
-                isH5 = True
+        if filenames:
+            isH5 = is_hdf5(filenames[0])
+        else:
+            filenames = self.get_input_value("raw_filename", None)
+            if filenames:
+                filenames = DataUrl(filenames)
+                isH5 = is_hdf5(filenames)
+            else:
+                raise ValueError(
+                    "either 'filenames' or 'raw_filename' needs to be provided"
+                )
 
         results = load_process_data(
-            filenames=self.inputs.filenames,
-            root_dir=self.inputs.root_dir,
+            filenames=filenames,
+            root_dir=root_dir,
             dark_filename=dark_filename,
             in_memory=in_memory,
             copy_files=copy_files,
-            title=self.inputs.title,
+            title=title,
             isH5=isH5,
+            metadata_url=metadata_url,
         )
+
         self.outputs.dataset = dtypes.Dataset(*results)
 
 
 class DataCopy(
     Task,
     input_names=["dataset"],
     output_names=["dataset"],
@@ -232,37 +254,37 @@
         dims = utils.convertDictToDim(self.inputs._dims)
         if dataset is not None and len(dataset.data.metadata) > 0:
             for axis, dim in dims.items():
                 assert type(axis) is int
                 dataset.add_dim(axis=axis, dim=dim)
             try:
                 dataset = dataset.reshape_data()
+            except ValueError:
+                for axis, dimension in dataset.dims:
+                    values = self.dataset.get_dimensions_values()[dimension.name]
+                    dimension.set_unique_values(numpy.unique(values))
+                dataset = dataset.reshape_data()
+            else:
                 for axis, dimension in dataset.dims:
                     if dataset.dims.ndim > 1:
                         metadata = numpy.swapaxes(dataset.data.metadata, 0, axis)[0]
                     else:
                         metadata = dataset.data.metadata
-                    values = []
-                    for data in metadata:
-                        try:
-                            values += [
-                                data.get_value(
-                                    kind=dimension.kind, name=dimension.name
-                                )[0]
-                            ]
-                        except KeyError:
-                            values += ["0"]
-                    dimension.set_unique_values(values)
-            except ValueError:
-                for axis, dimension in dataset.dims:
-                    values = numpy.unique(
-                        self.dataset.get_dimensions_values()[dimension.name]
+
+                    from darfix.core.dataset import _extract_metadata_values
+
+                    values = _extract_metadata_values(
+                        metadata,
+                        dimension.kind,
+                        dimension.name,
+                        missing_value="0",
+                        take_previous_when_missing=False,
                     )
                     dimension.set_unique_values(values)
-                dataset = dataset.reshape_data()
+
         self.outputs.dataset = dtypes.Dataset(dataset, indices, li_indices, bg_dataset)
 
 
 class ShiftCorrection(
     Task,
     input_names=["dataset"],
     optional_input_names=["shift"],
```

### Comparing `darfix-1.0.1rc1/src/darfix/core/roi.py` & `darfix-1.0.2/src/darfix/core/roi.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/core/test/test_components_matching.py` & `darfix-1.0.2/src/darfix/core/test/test_components_matching.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/core/test/test_data_selection.py` & `darfix-1.0.2/src/darfix/core/test/test_data_selection.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/core/test/test_dataset.py` & `darfix-1.0.2/src/darfix/core/test/test_dataset.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/core/test/test_dimension.py` & `darfix-1.0.2/src/darfix/core/test/test_dimension.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/core/test/test_ga.py` & `darfix-1.0.2/src/darfix/core/test/test_ga.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/core/test/test_image_operations.py` & `darfix-1.0.2/src/darfix/core/test/test_image_operations.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/core/test/test_image_registration.py` & `darfix-1.0.2/src/darfix/core/test/test_image_registration.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/core/test/test_mapping.py` & `darfix-1.0.2/src/darfix/core/test/test_mapping.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/core/test/test_roi.py` & `darfix-1.0.2/src/darfix/core/test/test_roi.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/core/test/test_workflow.py` & `darfix-1.0.2/src/darfix/core/test/test_workflow.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/core/utils.py` & `darfix-1.0.2/src/darfix/core/utils.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/decomposition/base.py` & `darfix-1.0.2/src/darfix/decomposition/base.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/decomposition/ipca.py` & `darfix-1.0.2/src/darfix/decomposition/ipca.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/decomposition/nica.py` & `darfix-1.0.2/src/darfix/decomposition/nica.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/decomposition/nmf.py` & `darfix-1.0.2/src/darfix/decomposition/nmf.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/decomposition/pca.py` & `darfix-1.0.2/src/darfix/decomposition/pca.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/decomposition/test/test_base.py` & `darfix-1.0.2/src/darfix/decomposition/test/test_base.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/decomposition/test/test_ipca.py` & `darfix-1.0.2/src/darfix/decomposition/test/test_ipca.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/decomposition/test/test_nica.py` & `darfix-1.0.2/src/darfix/decomposition/test/test_nica.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/decomposition/test/test_nmf.py` & `darfix-1.0.2/src/darfix/decomposition/test/test_nmf.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/decomposition/test/utils.py` & `darfix-1.0.2/src/darfix/decomposition/test/utils.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/dtypes.py` & `darfix-1.0.2/src/darfix/dtypes.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/PCAWidget.py` & `darfix-1.0.2/src/darfix/gui/PCAWidget.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/binningWidget.py` & `darfix-1.0.2/src/darfix/gui/binningWidget.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/blindSourceSeparationWidget.py` & `darfix-1.0.2/src/darfix/gui/blindSourceSeparationWidget.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/dataPartitionWidget.py` & `darfix-1.0.2/src/darfix/gui/dataPartitionWidget.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/datasetSelectionWidget.py` & `darfix-1.0.2/src/darfix/gui/datasetSelectionWidget.py`

 * *Files 1% similar despite different names*

```diff
@@ -401,23 +401,28 @@
 
     def _uploadFilename(self):
         """
         Loads the file from a FileDialog.
         """
         if self._isH5:
             fileDialog = DataFileDialog()
+            fileDialog.setFilterMode(DataFileDialog.FilterMode.ExistingDataset)
+            if self._filename:
+                fileDialog.selectUrl(self._filename)
             if fileDialog.exec_():
                 self._filename = fileDialog.selectedDataUrl().path()
                 self._filenameLE.setText(self._filename)
                 self.filenameChanged.emit()
             else:
                 _logger.warning("Could not open file")
         else:
             fileDialog = qt.QFileDialog()
             fileDialog.setFileMode(qt.QFileDialog.ExistingFile)
+            if self._filename:
+                fileDialog.selectFile(self._filename)
             if fileDialog.exec_():
                 self._filenameLE.setText(fileDialog.selectedFiles()[0])
                 self._filename = fileDialog.selectedFiles()[0]
                 self.filenameChanged.emit()
             else:
                 _logger.warning("Could not open file")
```

### Comparing `darfix-1.0.1rc1/src/darfix/gui/dimensionsWidget.py` & `darfix-1.0.2/src/darfix/gui/dimensionsWidget.py`

 * *Files 1% similar despite different names*

```diff
@@ -12,15 +12,15 @@
 from darfix.core.dimension import (
     Dimension,
     _METADATA_TYPES,
     _METADATA_TYPES_I,
     DEFAULT_METADATA,
 )
 from darfix import dtypes
-
+from darfix.core import array_utils
 
 _logger = logging.getLogger(__file__)
 
 
 class DimensionMapping(qt.QWidget):
     """
     Widget used to define the number of dimension and with which values they are
@@ -276,63 +276,49 @@
                 self.dataset.clear_dims()
                 for dimension in self.dims.values():
                     axis = dimension.axis
                     dimension = dimension.dim
                     values = self.dataset.get_metadata_values(
                         kind=dimension.kind, key=dimension.name
                     )
-                    indices = numpy.unique(values, return_index=True)[1]
-                    dimension.set_unique_values(
-                        [values[index] for index in sorted(indices)]
-                    )
+                    dimension.set_unique_values(array_utils.unique(values))
                     self.dataset.add_dim(axis=axis, dim=dimension)
                 try:
                     self._update_dataset = self.dataset.reshape_data()
+                except ValueError:
+                    for axis, dimension in self.dataset.dims:
+                        values = self.dataset.get_metadata_values(
+                            kind=dimension.kind, key=dimension.name
+                        )
+                        dimension.set_unique_values(numpy.unique(values))
+                    self._update_dataset = self.dataset.reshape_data()
+                else:
                     ndim = self._update_dataset.dims.ndim
                     for axis, dimension in self._update_dataset.dims:
                         # Flip axis to be consistent with the data shape
                         not_axis = ndim - axis - 1
                         if self._update_dataset.dims.ndim > 1:
                             metadata = numpy.swapaxes(
                                 self._update_dataset.data.metadata, ndim - 1, not_axis
                             )
                             for axis in range(ndim - 1):
                                 metadata = metadata[0]
                         else:
                             metadata = self._update_dataset.data.metadata
-                        # missing_value = False
-                        for data in metadata:
-                            try:
-                                value = data.get_value(
-                                    kind=dimension.kind, name=dimension.name
-                                )
-                            except KeyError:
-                                # missing_value = True
-                                if len(values):
-                                    values += [values[-1]]
-                                else:
-                                    values = ["0"]
-                            else:
-                                from darfix.core.dataset import _HDF5MetadataReader
-
-                                if not isinstance(data, _HDF5MetadataReader):
-                                    # _HDF5MetadataReader already return a scalar when silx FabioReader return an array of a single element
-                                    value = value[0]
-                                values += [value]
 
-                        dimension.set_unique_values(values)
-                except ValueError:
-                    for axis, dimension in self.dataset.dims:
-                        values = numpy.unique(
-                            self.dataset.get_metadata_values(
-                                kind=dimension.kind, key=dimension.name
-                            )
+                        from darfix.core.dataset import _extract_metadata_values
+
+                        values = _extract_metadata_values(
+                            metadata,
+                            dimension.kind,
+                            dimension.name,
+                            missing_value="0",
+                            take_previous_when_missing=True,
                         )
                         dimension.set_unique_values(values)
-                    self._update_dataset = self.dataset.reshape_data()
             else:
                 raise ValueError("Cannot fit without dimensions")
             super().clear()
             for dim in self.dataset.dims:
                 self.addDim(dim[0], dim[1])
             self._update_dataset = self.dataset.reshape_data()
         except Exception as e:
```

### Comparing `darfix-1.0.1rc1/src/darfix/gui/displayComponentsWidget.py` & `darfix-1.0.2/src/darfix/gui/displayComponentsWidget.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/grainPlotWidget.py` & `darfix-1.0.2/src/darfix/gui/grainPlotWidget.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/lineProfileWidget.py` & `darfix-1.0.2/src/darfix/gui/lineProfileWidget.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/linkComponentsWidget.py` & `darfix-1.0.2/src/darfix/gui/linkComponentsWidget.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/magnificationWidget.py` & `darfix-1.0.2/src/darfix/gui/magnificationWidget.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/metadataWidget.py` & `darfix-1.0.2/src/darfix/gui/metadataWidget.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/noiseRemovalWidget.py` & `darfix-1.0.2/src/darfix/gui/noiseRemovalWidget.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/operationThread.py` & `darfix-1.0.2/src/darfix/gui/operationThread.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/projectionWidget.py` & `darfix-1.0.2/src/darfix/gui/projectionWidget.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/rockingCurvesWidget.py` & `darfix-1.0.2/src/darfix/gui/rockingCurvesWidget.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/roiLimitsToolbar.py` & `darfix-1.0.2/src/darfix/gui/roiLimitsToolbar.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/roiSelectionWidget.py` & `darfix-1.0.2/src/darfix/gui/roiSelectionWidget.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/rsmHistogramWidget.py` & `darfix-1.0.2/src/darfix/gui/rsmHistogramWidget.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/rsmWidget.py` & `darfix-1.0.2/src/darfix/gui/rsmWidget.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/shiftCorrectionWidget.py` & `darfix-1.0.2/src/darfix/gui/shiftCorrectionWidget.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/showStackWidget.py` & `darfix-1.0.2/src/darfix/gui/showStackWidget.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/utils.py` & `darfix-1.0.2/src/darfix/gui/utils.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/weakBeamWidget.py` & `darfix-1.0.2/src/darfix/gui/weakBeamWidget.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/gui/zSumWidget.py` & `darfix-1.0.2/src/darfix/gui/zSumWidget.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/io/dataset_io.py` & `darfix-1.0.2/src/darfix/io/dataset_io.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/io/utils.py` & `darfix-1.0.2/src/darfix/io/utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -2,14 +2,15 @@
 __license__ = "MIT"
 __date__ = "03/07/2021"
 
 import logging
 import h5py
 from datetime import datetime
 import numpy
+import sys
 
 from silx.io.dictdump import dicttoh5, h5todict
 
 _logger = logging.getLogger(__file__)
 
 
 def assert_string(s, enums):
@@ -53,18 +54,18 @@
     else:
         progress = ncurrent + 1
     percent_fmt = "{0:." + str(decimals) + "f}"
     percent = percent_fmt.format(100 * progress)
     filledLength = int(length * min(progress, 1))
     leftLength = length - filledLength
     bar = fill * filledLength + left * leftLength
-    print("\r%s |%s| %s%% %s" % (prefix, bar, percent, suffix), end="\r")
+    sys.stdout.write("\r%s |%s| %s%% %s\r" % (prefix, bar, percent, suffix))
     # Print New Line on Complete
     if ncurrent >= ntotal:
-        print()
+        sys.stdout.write("\n")
 
 
 def write_maps(
     h5_file,
     list_of_maps,
     default_map,
     entry,
```

### Comparing `darfix-1.0.1rc1/src/darfix/resources/gui/icons/curves.png` & `darfix-1.0.2/src/darfix/resources/gui/icons/curves.png`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/resources/gui/icons/curves.svg` & `darfix-1.0.2/src/darfix/resources/gui/icons/curves.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/resources/gui/icons/resize.png` & `darfix-1.0.2/src/darfix/resources/gui/icons/resize.png`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/resources/gui/icons/resize.svg` & `darfix-1.0.2/src/darfix/resources/gui/icons/resize.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/resources/gui/icons/scatter.png` & `darfix-1.0.2/src/darfix/resources/gui/icons/scatter.png`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/resources/gui/icons/scatter.svg` & `darfix-1.0.2/src/darfix/resources/gui/icons/scatter.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/test/conftest.py` & `darfix-1.0.2/src/darfix/test/conftest.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix/test/utils.py` & `darfix-1.0.2/src/darfix/test/utils.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/darfix.egg-info/PKG-INFO` & `darfix-1.0.2/src/darfix.egg-info/PKG-INFO`

 * *Files 6% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: darfix
-Version: 1.0.1rc1
+Version: 1.0.2
 Summary: Computer vision software for the interpretation of diffraction images
 Home-page: https://gitlab.esrf.fr/XRD/darfix
 Author: J.Garriga
 Author-email: julia.garriga@esrf.fr
 License: MIT
 Project-URL: Source, https://gitlab.esrf.fr/XRD/darfix/
 Project-URL: Documentation, http://www.edna-site.org/pub/doc/darfix/latest
@@ -31,28 +31,30 @@
 Requires-Dist: scikit-learn; extra == "full"
 Requires-Dist: PyQt5; extra == "full"
 Requires-Dist: ewoksorange>=0.1.0; extra == "full"
 Requires-Dist: orange3; extra == "full"
 Requires-Dist: orange3<=3.32.0; python_version < "3.8" and extra == "full"
 Requires-Dist: orange3<=3.30.1; python_version < "3.7" and extra == "full"
 Requires-Dist: openTSNE<=0.6.1; python_version < "3.7" and extra == "full"
+Requires-Dist: bottleneck<=1.3.8; python_version < "3.7" and extra == "full"
 Requires-Dist: tqdm; extra == "full"
 Requires-Dist: hdf5plugin; extra == "full"
 Provides-Extra: test
 Requires-Dist: matplotlib>=1.2.0; extra == "test"
 Requires-Dist: opencv-python-headless<4.7,>=4.3.0.36; extra == "test"
 Requires-Dist: scikit-image>=0.17.1; python_version >= "3.7" and extra == "test"
 Requires-Dist: scikit-image<0.17.1; python_version < "3.7" and extra == "test"
 Requires-Dist: scikit-learn; extra == "test"
 Requires-Dist: PyQt5; extra == "test"
 Requires-Dist: ewoksorange>=0.1.0; extra == "test"
 Requires-Dist: orange3; extra == "test"
 Requires-Dist: orange3<=3.32.0; python_version < "3.8" and extra == "test"
 Requires-Dist: orange3<=3.30.1; python_version < "3.7" and extra == "test"
 Requires-Dist: openTSNE<=0.6.1; python_version < "3.7" and extra == "test"
+Requires-Dist: bottleneck<=1.3.8; python_version < "3.7" and extra == "test"
 Requires-Dist: tqdm; extra == "test"
 Requires-Dist: hdf5plugin; extra == "test"
 Requires-Dist: pytest; extra == "test"
 Provides-Extra: dev
 Requires-Dist: matplotlib>=1.2.0; extra == "dev"
 Requires-Dist: opencv-python-headless<4.7,>=4.3.0.36; extra == "dev"
 Requires-Dist: scikit-image>=0.17.1; python_version >= "3.7" and extra == "dev"
@@ -60,14 +62,15 @@
 Requires-Dist: scikit-learn; extra == "dev"
 Requires-Dist: PyQt5; extra == "dev"
 Requires-Dist: ewoksorange>=0.1.0; extra == "dev"
 Requires-Dist: orange3; extra == "dev"
 Requires-Dist: orange3<=3.32.0; python_version < "3.8" and extra == "dev"
 Requires-Dist: orange3<=3.30.1; python_version < "3.7" and extra == "dev"
 Requires-Dist: openTSNE<=0.6.1; python_version < "3.7" and extra == "dev"
+Requires-Dist: bottleneck<=1.3.8; python_version < "3.7" and extra == "dev"
 Requires-Dist: tqdm; extra == "dev"
 Requires-Dist: hdf5plugin; extra == "dev"
 Requires-Dist: pytest; extra == "dev"
 Requires-Dist: black>=22; extra == "dev"
 Requires-Dist: flake8>=4; extra == "dev"
 Requires-Dist: flake8_nb>=0.3.1; extra == "dev"
 Provides-Extra: doc
@@ -78,28 +81,30 @@
 Requires-Dist: scikit-learn; extra == "doc"
 Requires-Dist: PyQt5; extra == "doc"
 Requires-Dist: ewoksorange>=0.1.0; extra == "doc"
 Requires-Dist: orange3; extra == "doc"
 Requires-Dist: orange3<=3.32.0; python_version < "3.8" and extra == "doc"
 Requires-Dist: orange3<=3.30.1; python_version < "3.7" and extra == "doc"
 Requires-Dist: openTSNE<=0.6.1; python_version < "3.7" and extra == "doc"
+Requires-Dist: bottleneck<=1.3.8; python_version < "3.7" and extra == "doc"
 Requires-Dist: tqdm; extra == "doc"
 Requires-Dist: hdf5plugin; extra == "doc"
 Requires-Dist: pytest; extra == "doc"
 Requires-Dist: matplotlib>=1.2.0; extra == "doc"
 Requires-Dist: opencv-python-headless<4.7,>=4.3.0.36; extra == "doc"
 Requires-Dist: scikit-image>=0.17.1; python_version >= "3.7" and extra == "doc"
 Requires-Dist: scikit-image<0.17.1; python_version < "3.7" and extra == "doc"
 Requires-Dist: scikit-learn; extra == "doc"
 Requires-Dist: PyQt5; extra == "doc"
 Requires-Dist: ewoksorange>=0.1.0; extra == "doc"
 Requires-Dist: orange3; extra == "doc"
 Requires-Dist: orange3<=3.32.0; python_version < "3.8" and extra == "doc"
 Requires-Dist: orange3<=3.30.1; python_version < "3.7" and extra == "doc"
 Requires-Dist: openTSNE<=0.6.1; python_version < "3.7" and extra == "doc"
+Requires-Dist: bottleneck<=1.3.8; python_version < "3.7" and extra == "doc"
 Requires-Dist: tqdm; extra == "doc"
 Requires-Dist: hdf5plugin; extra == "doc"
 Requires-Dist: sphinx>=4.5; extra == "doc"
 Requires-Dist: sphinx-autodoc-typehints>=1.16; extra == "doc"
 Requires-Dist: nbsphinx; extra == "doc"
 Requires-Dist: recommonmark; extra == "doc"
 Requires-Dist: pydata_sphinx_theme<0.15; extra == "doc"
```

### Comparing `darfix-1.0.1rc1/src/darfix.egg-info/SOURCES.txt` & `darfix-1.0.2/src/darfix.egg-info/SOURCES.txt`

 * *Files 1% similar despite different names*

```diff
@@ -11,14 +11,15 @@
 src/darfix.egg-info/dependency_links.txt
 src/darfix.egg-info/entry_points.txt
 src/darfix.egg-info/requires.txt
 src/darfix.egg-info/top_level.txt
 src/darfix/app/__init__.py
 src/darfix/app/__main__.py
 src/darfix/core/__init__.py
+src/darfix/core/array_utils.py
 src/darfix/core/autofocus.py
 src/darfix/core/componentsMatching.py
 src/darfix/core/data_selection.py
 src/darfix/core/dataset.py
 src/darfix/core/dimension.py
 src/darfix/core/geneticShiftDetection.py
 src/darfix/core/imageOperations.py
@@ -87,23 +88,26 @@
 src/darfix/resources/gui/icons/curves.svg
 src/darfix/resources/gui/icons/resize.png
 src/darfix/resources/gui/icons/resize.svg
 src/darfix/resources/gui/icons/scatter.png
 src/darfix/resources/gui/icons/scatter.svg
 src/darfix/test/__init__.py
 src/darfix/test/conftest.py
+src/darfix/test/test_array_utils.py
 src/darfix/test/utils.py
 src/orangecontrib/darfix/__init__.py
 src/orangecontrib/darfix/test/__init__.py
 src/orangecontrib/darfix/test/test_ewoks.py
 src/orangecontrib/darfix/tutorials/__init__.py
 src/orangecontrib/darfix/tutorials/darfix_example1.ows
 src/orangecontrib/darfix/tutorials/darfix_example2.ows
-src/orangecontrib/darfix/tutorials/strain_0000.edf
-src/orangecontrib/darfix/tutorials/strain_0001.edf
+src/orangecontrib/darfix/tutorials/edf_dataset/strain_0000.edf
+src/orangecontrib/darfix/tutorials/edf_dataset/strain_0001.edf
+src/orangecontrib/darfix/tutorials/hdf5_dataset/strain.hdf5
+src/orangecontrib/darfix/tutorials/hdf5_dataset/treated/data.hdf5
 src/orangecontrib/darfix/widgets/__init__.py
 src/orangecontrib/darfix/widgets/binning.py
 src/orangecontrib/darfix/widgets/blindsourceseparation.py
 src/orangecontrib/darfix/widgets/datacopy.py
 src/orangecontrib/darfix/widgets/datapartition.py
 src/orangecontrib/darfix/widgets/dataselection.py
 src/orangecontrib/darfix/widgets/dimensions.py
```

### Comparing `darfix-1.0.1rc1/src/darfix.egg-info/requires.txt` & `darfix-1.0.2/src/darfix.egg-info/requires.txt`

 * *Files 8% similar despite different names*

```diff
@@ -22,14 +22,15 @@
 flake8>=4
 flake8_nb>=0.3.1
 
 [dev:python_version < "3.7"]
 scikit-image<0.17.1
 orange3<=3.30.1
 openTSNE<=0.6.1
+bottleneck<=1.3.8
 
 [dev:python_version < "3.8"]
 orange3<=3.32.0
 
 [dev:python_version >= "3.7"]
 scikit-image>=0.17.1
 
@@ -49,14 +50,15 @@
 recommonmark
 pydata_sphinx_theme<0.15
 
 [doc:python_version < "3.7"]
 scikit-image<0.17.1
 orange3<=3.30.1
 openTSNE<=0.6.1
+bottleneck<=1.3.8
 
 [doc:python_version < "3.8"]
 orange3<=3.32.0
 
 [doc:python_version >= "3.7"]
 scikit-image>=0.17.1
 
@@ -70,14 +72,15 @@
 tqdm
 hdf5plugin
 
 [full:python_version < "3.7"]
 scikit-image<0.17.1
 orange3<=3.30.1
 openTSNE<=0.6.1
+bottleneck<=1.3.8
 
 [full:python_version < "3.8"]
 orange3<=3.32.0
 
 [full:python_version >= "3.7"]
 scikit-image>=0.17.1
 
@@ -92,13 +95,14 @@
 hdf5plugin
 pytest
 
 [test:python_version < "3.7"]
 scikit-image<0.17.1
 orange3<=3.30.1
 openTSNE<=0.6.1
+bottleneck<=1.3.8
 
 [test:python_version < "3.8"]
 orange3<=3.32.0
 
 [test:python_version >= "3.7"]
 scikit-image>=0.17.1
```

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/test/test_ewoks.py` & `darfix-1.0.2/src/orangecontrib/darfix/test/test_ewoks.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,13 +1,15 @@
 import unittest
 import shutil
 import tempfile
+import os
 from ewoks import load_graph
 from darfix.core.process import graph_data_selection
 from darfix.app.__main__ import execute_graph
+from silx.io.url import DataUrl
 
 try:
     from importlib.resources import files as resource_files
 except ImportError:
     from importlib_resources import files as resource_files
 
 
@@ -16,42 +18,74 @@
         # Create a temporary directory
         self.tmpdir = tempfile.mkdtemp()
 
     def tearDown(self):
         # Remove the directory after the test
         shutil.rmtree(self.tmpdir)
 
-    def test_darfix_example2(self):
+    def test_darfix_example2_edf(self):
         from orangecontrib.darfix import tutorials
 
         filename = resource_files(tutorials).joinpath("darfix_example2.ows")
         graph = load_graph(str(filename))
 
-        image0 = resource_files(tutorials).joinpath("strain_0000.edf")
-        image1 = resource_files(tutorials).joinpath("strain_0001.edf")
+        image0 = resource_files(tutorials).joinpath("edf_dataset", "strain_0000.edf")
+        image1 = resource_files(tutorials).joinpath("edf_dataset", "strain_0001.edf")
         filenames = [str(image0), str(image1)]
         graph_data_selection(
             graph=graph,
             filenames=filenames,
             root_dir=str(self.tmpdir),
             in_memory=True,
         )
         results = graph.execute(output_tasks=True)
         for node_id, task in results.items():
             assert task.succeeded, node_id
 
+    def test_darfix_example2_hdf5(self):
+        from orangecontrib.darfix import tutorials
+
+        filename = resource_files(tutorials).joinpath("darfix_example2.ows")
+        graph = load_graph(str(filename))
+
+        hdf5_dataset_file = resource_files(tutorials).joinpath(
+            "hdf5_dataset", "strain.hdf5"
+        )
+        assert os.path.exists(str(hdf5_dataset_file))
+        filenames = (
+            DataUrl(
+                file_path=str(hdf5_dataset_file),
+                data_path="/1.1/instrument/my_detector/data",
+                scheme="silx",
+            ).path(),
+        )
+        graph_data_selection(
+            graph=graph,
+            filenames=filenames,
+            root_dir=str(self.tmpdir),
+            in_memory=False,
+            metadata_url=DataUrl(
+                file_path=str(hdf5_dataset_file),
+                data_path="/1.1/instrument/positioners",
+                scheme="silx",
+            ).path(),
+        )
+        results = graph.execute(output_tasks=True)
+        for node_id, task in results.items():
+            assert task.succeeded, node_id
+
     def test_darfix_example2_cli(self):
         from orangecontrib.darfix import tutorials
 
         filename = resource_files(tutorials).joinpath("darfix_example2.ows")
         argv = [
             None,
             "-wf",
             str(filename),
             "-fd",
-            str(filename.parent),
+            os.path.join(str(filename.parent), "edf_dataset"),
             "-td",
             str(self.tmpdir),
         ]
         results = execute_graph(argv=argv, output_tasks=True)
         for node_id, task in results.items():
             assert task.succeeded, node_id
```

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/tutorials/darfix_example1.ows` & `darfix-1.0.2/src/orangecontrib/darfix/tutorials/darfix_example1.ows`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/tutorials/darfix_example2.ows` & `darfix-1.0.2/src/orangecontrib/darfix/tutorials/darfix_example2.ows`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/tutorials/strain_0000.edf` & `darfix-1.0.2/src/orangecontrib/darfix/tutorials/edf_dataset/strain_0000.edf`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/tutorials/strain_0001.edf` & `darfix-1.0.2/src/orangecontrib/darfix/tutorials/edf_dataset/strain_0001.edf`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/__init__.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/__init__.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/binning.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/binning.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/blindsourceseparation.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/blindsourceseparation.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/datacopy.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/datacopy.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/datapartition.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/datapartition.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/dataselection.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/dataselection.py`

 * *Files 4% similar despite different names*

```diff
@@ -2,21 +2,21 @@
 __license__ = "MIT"
 __date__ = "20/11/2020"
 
 import logging
 from Orange.widgets.settings import Setting
 from Orange.widgets.widget import OWWidget, Output
 
-import h5py
 from silx.gui import qt
 from silx.io.url import DataUrl
 
 from darfix.gui.operationThread import OperationThread
 from darfix.gui.datasetSelectionWidget import DatasetSelectionWidget
 from darfix.core.process import DataSelection
+from darfix.io.hdf5 import is_hdf5
 from darfix import dtypes
 
 
 _logger = logging.getLogger(__file__)
 
 
 class DataSelectionWidgetOW(OWWidget):
@@ -67,24 +67,16 @@
     def setDataset(self):
         self._widget.setRawFilenames(self.filenames)
         self._widget.setRawFilename(self.raw_filename)
         self._widget.setDarkFilename(self.dark_filename)
         if self.on_disk:
             self._widget._onDiskCB.setChecked(True)
         self._widget.setMetadataUrl(self.metadata_url)
-
-        if self.raw_filename not in (None, ""):
-            try:
-                url = DataUrl(path=self.raw_filename)
-            except Exception:
-                file_path = self.raw_filename
-            else:
-                file_path = url.file_path()
-            is_hdf5 = h5py.is_hdf5(file_path)
-            self._widget.setIsH5(is_hdf5)
+        if self.raw_filename:
+            self._widget.setIsH5(is_hdf5(self.raw_filename))
 
     def _getDataset(self):
         if self.__updatingData:
             _logger.warning(
                 "Another dataset is being loaded, please wait \
                             until it has finished"
             )
```

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/dimensions.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/dimensions.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/flash.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/flash.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/grainplot.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/grainplot.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/axes.png` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/axes.png`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/axes.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/axes.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/bss.png` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/bss.png`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/bss.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/bss.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/copy.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/copy.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/curves.png` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/curves.png`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/curves.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/curves.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/darfix_icon.png` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/darfix_icon.png`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/darfix_icon.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/darfix_icon.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/darfix_icon8.png` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/darfix_icon8.png`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/filter.png` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/filter.png`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/filter.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/filter.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/flash.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/flash.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/gaussian.png` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/gaussian.png`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/gaussian.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/gaussian.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/grainplot.png` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/grainplot.png`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/grainplot.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/grainplot.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/image-select-box.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/image-select-box.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/line_profile.png` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/line_profile.png`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/line_profile.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/line_profile.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/link.png` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/link.png`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/link.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/link.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/metadata.png` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/metadata.png`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/metadata.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/metadata.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/mywidget.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/mywidget.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/noise_removal.png` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/noise_removal.png`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/noise_removal.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/noise_removal.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/noise_removal_backup.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/noise_removal_backup.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/param_dims.png` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/param_dims.png`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/param_dims.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/param_dims.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/pca.png` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/pca.png`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/pca.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/pca.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/random.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/random.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/resize.png` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/resize.png`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/roi.png` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/roi.png`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/roi.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/roi.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/save.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/save.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/shift_correction.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/shift_correction.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/upload.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/upload.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/icons/zsum.svg` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/icons/zsum.svg`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/lineprofile.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/lineprofile.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/linkcomponents.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/linkcomponents.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/metadata.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/metadata.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/noiseremoval.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/noiseremoval.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/pca.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/pca.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/projection.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/projection.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/rockingcurves.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/rockingcurves.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/roiselection.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/roiselection.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/rsmhistogram.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/rsmhistogram.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/shiftcorrection.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/shiftcorrection.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/test/test_data_selection.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/test/test_data_selection.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/transformation.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/transformation.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/weakbeam.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/weakbeam.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/orangecontrib/darfix/widgets/zsum.py` & `darfix-1.0.2/src/orangecontrib/darfix/widgets/zsum.py`

 * *Files identical despite different names*

### Comparing `darfix-1.0.1rc1/src/snippets/convert_edf_to_hdf5.py` & `darfix-1.0.2/src/snippets/convert_edf_to_hdf5.py`

 * *Files identical despite different names*

