# Comparing `tmp/langchain_core-0.1.9.tar.gz` & `tmp/langchain_core-0.2.0rc1.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "langchain_core-0.1.9.tar", max compression
+gzip compressed data, was "langchain_core-0.2.0rc1.tar", max compression
```

## Comparing `langchain_core-0.1.9.tar` & `langchain_core-0.2.0rc1.tar`

### file list

```diff
@@ -1,120 +1,150 @@
--rw-r--r--   0        0        0     3046 2024-01-10 03:28:32.000835 langchain_core-0.1.9/README.md
--rw-r--r--   0        0        0      390 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/__init__.py
--rw-r--r--   0        0        0     1025 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/_api/__init__.py
--rw-r--r--   0        0        0     8977 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/_api/beta_decorator.py
--rw-r--r--   0        0        0    13829 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/_api/deprecation.py
--rw-r--r--   0        0        0      662 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/_api/internal.py
--rw-r--r--   0        0        0      984 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/_api/path.py
--rw-r--r--   0        0        0     6197 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/agents.py
--rw-r--r--   0        0        0        0 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/beta/__init__.py
--rw-r--r--   0        0        0        0 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/beta/runnables/__init__.py
--rw-r--r--   0        0        0    10617 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/beta/runnables/context.py
--rw-r--r--   0        0        0      722 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/caches.py
--rw-r--r--   0        0        0     1852 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/callbacks/__init__.py
--rw-r--r--   0        0        0    16850 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/callbacks/base.py
--rw-r--r--   0        0        0    62827 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/callbacks/manager.py
--rw-r--r--   0        0        0     2256 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/callbacks/stdout.py
--rw-r--r--   0        0        0     2433 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/callbacks/streaming_stdout.py
--rw-r--r--   0        0        0     2493 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/chat_history.py
--rw-r--r--   0        0        0      415 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/chat_sessions.py
--rw-r--r--   0        0        0      176 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/documents/__init__.py
--rw-r--r--   0        0        0      839 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/documents/base.py
--rw-r--r--   0        0        0     2494 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/documents/transformers.py
--rw-r--r--   0        0        0      787 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/embeddings.py
--rw-r--r--   0        0        0      486 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/env.py
--rw-r--r--   0        0        0      571 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/example_selectors/__init__.py
--rw-r--r--   0        0        0      516 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/example_selectors/base.py
--rw-r--r--   0        0        0     2453 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/example_selectors/length_based.py
--rw-r--r--   0        0        0     7143 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/example_selectors/semantic_similarity.py
--rw-r--r--   0        0        0     1869 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/exceptions.py
--rw-r--r--   0        0        0     8376 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/globals/__init__.py
--rw-r--r--   0        0        0      522 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/language_models/__init__.py
--rw-r--r--   0        0        0    10688 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/language_models/base.py
--rw-r--r--   0        0        0    29147 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/language_models/chat_models.py
--rw-r--r--   0        0        0    41173 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/language_models/llms.py
--rw-r--r--   0        0        0      261 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/load/__init__.py
--rw-r--r--   0        0        0     1174 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/load/dump.py
--rw-r--r--   0        0        0     5333 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/load/load.py
--rw-r--r--   0        0        0    16194 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/load/mapping.py
--rw-r--r--   0        0        0     6237 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/load/serializable.py
--rw-r--r--   0        0        0     2019 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/memory.py
--rw-r--r--   0        0        0     4642 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/messages/__init__.py
--rw-r--r--   0        0        0     1754 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/messages/ai.py
--rw-r--r--   0        0        0     6254 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/messages/base.py
--rw-r--r--   0        0        0     2047 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/messages/chat.py
--rw-r--r--   0        0        0     1759 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/messages/function.py
--rw-r--r--   0        0        0     1093 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/messages/human.py
--rw-r--r--   0        0        0     1046 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/messages/system.py
--rw-r--r--   0        0        0     1753 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/messages/tool.py
--rw-r--r--   0        0        0     1044 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/output_parsers/__init__.py
--rw-r--r--   0        0        0     9740 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/output_parsers/base.py
--rw-r--r--   0        0        0      527 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/output_parsers/format_instructions.py
--rw-r--r--   0        0        0     7839 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/output_parsers/json.py
--rw-r--r--   0        0        0     5507 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/output_parsers/list.py
--rw-r--r--   0        0        0      789 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/output_parsers/string.py
--rw-r--r--   0        0        0     4466 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/output_parsers/transform.py
--rw-r--r--   0        0        0     6056 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/output_parsers/xml.py
--rw-r--r--   0        0        0      482 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/outputs/__init__.py
--rw-r--r--   0        0        0     2633 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/outputs/chat_generation.py
--rw-r--r--   0        0        0      511 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/outputs/chat_result.py
--rw-r--r--   0        0        0     1848 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/outputs/generation.py
--rw-r--r--   0        0        0     2448 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/outputs/llm_result.py
--rw-r--r--   0        0        0      295 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/outputs/run_info.py
--rw-r--r--   0        0        0     2662 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/prompt_values.py
--rw-r--r--   0        0        0     2581 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/prompts/__init__.py
--rw-r--r--   0        0        0     8813 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/prompts/base.py
--rw-r--r--   0        0        0    25391 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/prompts/chat.py
--rw-r--r--   0        0        0    11888 2024-01-10 03:28:32.000835 langchain_core-0.1.9/langchain_core/prompts/few_shot.py
--rw-r--r--   0        0        0     5817 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/prompts/few_shot_with_templates.py
--rw-r--r--   0        0        0     6357 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/prompts/loading.py
--rw-r--r--   0        0        0     2498 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/prompts/pipeline.py
--rw-r--r--   0        0        0     9833 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/prompts/prompt.py
--rw-r--r--   0        0        0     5684 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/prompts/string.py
--rw-r--r--   0        0        0        0 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/py.typed
--rw-r--r--   0        0        0      927 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/pydantic_v1/__init__.py
--rw-r--r--   0        0        0      134 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/pydantic_v1/dataclasses.py
--rw-r--r--   0        0        0      120 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/pydantic_v1/main.py
--rw-r--r--   0        0        0    10835 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/retrievers.py
--rw-r--r--   0        0        0     2184 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/runnables/__init__.py
--rw-r--r--   0        0        0   143823 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/runnables/base.py
--rw-r--r--   0        0        0    14400 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/runnables/branch.py
--rw-r--r--   0        0        0    16801 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/runnables/config.py
--rw-r--r--   0        0        0    16031 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/runnables/configurable.py
--rw-r--r--   0        0        0    11862 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/runnables/fallbacks.py
--rw-r--r--   0        0        0     5044 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/runnables/graph.py
--rw-r--r--   0        0        0     8703 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/runnables/graph_draw.py
--rw-r--r--   0        0        0    15977 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/runnables/history.py
--rw-r--r--   0        0        0    21912 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/runnables/passthrough.py
--rw-r--r--   0        0        0    11952 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/runnables/retry.py
--rw-r--r--   0        0        0     6274 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/runnables/router.py
--rw-r--r--   0        0        0    12554 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/runnables/utils.py
--rw-r--r--   0        0        0     1647 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/stores.py
--rw-r--r--   0        0        0     1604 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/sys_info.py
--rw-r--r--   0        0        0    30198 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/tools.py
--rw-r--r--   0        0        0      598 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/tracers/__init__.py
--rw-r--r--   0        0        0    18584 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/tracers/base.py
--rw-r--r--   0        0        0     7626 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/tracers/context.py
--rw-r--r--   0        0        0     8220 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/tracers/evaluation.py
--rw-r--r--   0        0        0     9208 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/tracers/langchain.py
--rw-r--r--   0        0        0     7467 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/tracers/langchain_v1.py
--rw-r--r--   0        0        0    11231 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/tracers/log_stream.py
--rw-r--r--   0        0        0     1706 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/tracers/root_listeners.py
--rw-r--r--   0        0        0     1532 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/tracers/run_collector.py
--rw-r--r--   0        0        0     4265 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/tracers/schemas.py
--rw-r--r--   0        0        0     6186 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/tracers/stdout.py
--rw-r--r--   0        0        0     1232 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/utils/__init__.py
--rw-r--r--   0        0        0     7198 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/utils/aiter.py
--rw-r--r--   0        0        0     1297 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/utils/env.py
--rw-r--r--   0        0        0      907 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/utils/formatting.py
--rw-r--r--   0        0        0     6666 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/utils/function_calling.py
--rw-r--r--   0        0        0     3090 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/utils/html.py
--rw-r--r--   0        0        0     1289 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/utils/input.py
--rw-r--r--   0        0        0     5822 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/utils/iter.py
--rw-r--r--   0        0        0     2318 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/utils/json_schema.py
--rw-r--r--   0        0        0     2011 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/utils/loading.py
--rw-r--r--   0        0        0      301 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/utils/pydantic.py
--rw-r--r--   0        0        0      908 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/utils/strings.py
--rw-r--r--   0        0        0     6160 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/utils/utils.py
--rw-r--r--   0        0        0    25692 2024-01-10 03:28:32.004835 langchain_core-0.1.9/langchain_core/vectorstores.py
--rw-r--r--   0        0        0     2725 2024-01-10 03:28:32.004835 langchain_core-0.1.9/pyproject.toml
--rw-r--r--   0        0        0     4006 1970-01-01 00:00:00.000000 langchain_core-0.1.9/PKG-INFO
+-rw-r--r--   0        0        0     4982 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/README.md
+-rw-r--r--   0        0        0      390 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/__init__.py
+-rw-r--r--   0        0        0     1025 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/_api/__init__.py
+-rw-r--r--   0        0        0     9904 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/_api/beta_decorator.py
+-rw-r--r--   0        0        0    15031 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/_api/deprecation.py
+-rw-r--r--   0        0        0      662 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/_api/internal.py
+-rw-r--r--   0        0        0      984 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/_api/path.py
+-rw-r--r--   0        0        0     7002 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/agents.py
+-rw-r--r--   0        0        0       68 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/beta/__init__.py
+-rw-r--r--   0        0        0        0 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/beta/runnables/__init__.py
+-rw-r--r--   0        0        0    12193 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/beta/runnables/context.py
+-rw-r--r--   0        0        0     7271 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/caches.py
+-rw-r--r--   0        0        0     2131 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/callbacks/__init__.py
+-rw-r--r--   0        0        0    17991 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/callbacks/base.py
+-rw-r--r--   0        0        0     2626 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/callbacks/file.py
+-rw-r--r--   0        0        0    65384 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/callbacks/manager.py
+-rw-r--r--   0        0        0     2314 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/callbacks/stdout.py
+-rw-r--r--   0        0        0     2433 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/callbacks/streaming_stdout.py
+-rw-r--r--   0        0        0     7414 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/chat_history.py
+-rw-r--r--   0        0        0      444 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/chat_loaders.py
+-rw-r--r--   0        0        0      490 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/chat_sessions.py
+-rw-r--r--   0        0        0      261 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/document_loaders/__init__.py
+-rw-r--r--   0        0        0     4235 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/document_loaders/base.py
+-rw-r--r--   0        0        0     6636 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/document_loaders/blob_loaders.py
+-rw-r--r--   0        0        0      377 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/documents/__init__.py
+-rw-r--r--   0        0        0     1036 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/documents/base.py
+-rw-r--r--   0        0        0     1039 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/documents/compressor.py
+-rw-r--r--   0        0        0     2494 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/documents/transformers.py
+-rw-r--r--   0        0        0      220 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/embeddings/__init__.py
+-rw-r--r--   0        0        0      819 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/embeddings/embeddings.py
+-rw-r--r--   0        0        0     1649 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/embeddings/fake.py
+-rw-r--r--   0        0        0      486 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/env.py
+-rw-r--r--   0        0        0      680 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/example_selectors/__init__.py
+-rw-r--r--   0        0        0      979 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/example_selectors/base.py
+-rw-r--r--   0        0        0     2804 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/example_selectors/length_based.py
+-rw-r--r--   0        0        0    12865 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/example_selectors/semantic_similarity.py
+-rw-r--r--   0        0        0     1913 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/exceptions.py
+-rw-r--r--   0        0        0     8376 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/globals.py
+-rw-r--r--   0        0        0      429 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/indexing/__init__.py
+-rw-r--r--   0        0        0    22835 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/indexing/api.py
+-rw-r--r--   0        0        0     6032 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/indexing/base.py
+-rw-r--r--   0        0        0     1687 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/language_models/__init__.py
+-rw-r--r--   0        0        0    12963 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/language_models/base.py
+-rw-r--r--   0        0        0    34364 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/language_models/chat_models.py
+-rw-r--r--   0        0        0     2901 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/language_models/fake.py
+-rw-r--r--   0        0        0    10865 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/language_models/fake_chat_models.py
+-rw-r--r--   0        0        0    48288 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/language_models/llms.py
+-rw-r--r--   0        0        0      288 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/load/__init__.py
+-rw-r--r--   0        0        0     1174 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/load/dump.py
+-rw-r--r--   0        0        0     5744 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/load/load.py
+-rw-r--r--   0        0        0    27029 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/load/mapping.py
+-rw-r--r--   0        0        0     7069 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/load/serializable.py
+-rw-r--r--   0        0        0     2912 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/memory.py
+-rw-r--r--   0        0        0     1970 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/messages/__init__.py
+-rw-r--r--   0        0        0     7448 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/messages/ai.py
+-rw-r--r--   0        0        0     6134 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/messages/base.py
+-rw-r--r--   0        0        0     2395 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/messages/chat.py
+-rw-r--r--   0        0        0     1957 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/messages/function.py
+-rw-r--r--   0        0        0     1089 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/messages/human.py
+-rw-r--r--   0        0        0     1042 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/messages/system.py
+-rw-r--r--   0        0        0     5678 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/messages/tool.py
+-rw-r--r--   0        0        0     8303 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/messages/utils.py
+-rw-r--r--   0        0        0     1452 2024-05-14 03:33:08.728146 langchain_core-0.2.0rc1/langchain_core/output_parsers/__init__.py
+-rw-r--r--   0        0        0     9841 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/output_parsers/base.py
+-rw-r--r--   0        0        0      527 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/output_parsers/format_instructions.py
+-rw-r--r--   0        0        0     3704 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/output_parsers/json.py
+-rw-r--r--   0        0        0     5542 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/output_parsers/list.py
+-rw-r--r--   0        0        0     8014 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/output_parsers/openai_functions.py
+-rw-r--r--   0        0        0     7155 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/output_parsers/openai_tools.py
+-rw-r--r--   0        0        0     3847 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/output_parsers/pydantic.py
+-rw-r--r--   0        0        0      789 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/output_parsers/string.py
+-rw-r--r--   0        0        0     4466 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/output_parsers/transform.py
+-rw-r--r--   0        0        0     9277 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/output_parsers/xml.py
+-rw-r--r--   0        0        0      593 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/outputs/__init__.py
+-rw-r--r--   0        0        0     3280 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/outputs/chat_generation.py
+-rw-r--r--   0        0        0      511 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/outputs/chat_result.py
+-rw-r--r--   0        0        0     1809 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/outputs/generation.py
+-rw-r--r--   0        0        0     2448 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/outputs/llm_result.py
+-rw-r--r--   0        0        0      295 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/outputs/run_info.py
+-rw-r--r--   0        0        0     3582 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/prompt_values.py
+-rw-r--r--   0        0        0     2658 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/prompts/__init__.py
+-rw-r--r--   0        0        0    12230 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/prompts/base.py
+-rw-r--r--   0        0        0    44051 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/prompts/chat.py
+-rw-r--r--   0        0        0    14119 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/prompts/few_shot.py
+-rw-r--r--   0        0        0     7508 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/prompts/few_shot_with_templates.py
+-rw-r--r--   0        0        0     3106 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/prompts/image.py
+-rw-r--r--   0        0        0     6452 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/prompts/loading.py
+-rw-r--r--   0        0        0     3138 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/prompts/pipeline.py
+-rw-r--r--   0        0        0    10048 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/prompts/prompt.py
+-rw-r--r--   0        0        0     8411 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/prompts/string.py
+-rw-r--r--   0        0        0     4688 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/prompts/structured.py
+-rw-r--r--   0        0        0        0 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/py.typed
+-rw-r--r--   0        0        0      927 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/pydantic_v1/__init__.py
+-rw-r--r--   0        0        0      134 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/pydantic_v1/dataclasses.py
+-rw-r--r--   0        0        0      120 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/pydantic_v1/main.py
+-rw-r--r--   0        0        0    14249 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/retrievers.py
+-rw-r--r--   0        0        0     2258 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/runnables/__init__.py
+-rw-r--r--   0        0        0   187490 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/runnables/base.py
+-rw-r--r--   0        0        0    14612 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/runnables/branch.py
+-rw-r--r--   0        0        0    17732 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/runnables/config.py
+-rw-r--r--   0        0        0    23196 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/runnables/configurable.py
+-rw-r--r--   0        0        0    20237 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/runnables/fallbacks.py
+-rw-r--r--   0        0        0    13761 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/runnables/graph.py
+-rw-r--r--   0        0        0     8787 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/runnables/graph_ascii.py
+-rw-r--r--   0        0        0     9241 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/runnables/graph_mermaid.py
+-rw-r--r--   0        0        0     5243 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/runnables/graph_png.py
+-rw-r--r--   0        0        0    20156 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/runnables/history.py
+-rw-r--r--   0        0        0      436 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/runnables/learnable.py
+-rw-r--r--   0        0        0    24579 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/runnables/passthrough.py
+-rw-r--r--   0        0        0    11947 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/runnables/retry.py
+-rw-r--r--   0        0        0     6703 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/runnables/router.py
+-rw-r--r--   0        0        0     4397 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/runnables/schema.py
+-rw-r--r--   0        0        0    16280 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/runnables/utils.py
+-rw-r--r--   0        0        0     8066 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/stores.py
+-rw-r--r--   0        0        0     3834 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/structured_query.py
+-rw-r--r--   0        0        0     2778 2024-05-14 03:33:08.732146 langchain_core-0.2.0rc1/langchain_core/sys_info.py
+-rw-r--r--   0        0        0    38321 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/tools.py
+-rw-r--r--   0        0        0      896 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/tracers/__init__.py
+-rw-r--r--   0        0        0    21442 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/tracers/base.py
+-rw-r--r--   0        0        0     7095 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/tracers/context.py
+-rw-r--r--   0        0        0     8218 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/tracers/evaluation.py
+-rw-r--r--   0        0        0     8283 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/tracers/langchain.py
+-rw-r--r--   0        0        0      546 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/tracers/langchain_v1.py
+-rw-r--r--   0        0        0    21471 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/tracers/log_stream.py
+-rw-r--r--   0        0        0     3933 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/tracers/memory_stream.py
+-rw-r--r--   0        0        0     1704 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/tracers/root_listeners.py
+-rw-r--r--   0        0        0     1530 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/tracers/run_collector.py
+-rw-r--r--   0        0        0     4209 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/tracers/schemas.py
+-rw-r--r--   0        0        0     6136 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/tracers/stdout.py
+-rw-r--r--   0        0        0     1284 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/utils/__init__.py
+-rw-r--r--   0        0        0     2648 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/utils/_merge.py
+-rw-r--r--   0        0        0     7199 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/utils/aiter.py
+-rw-r--r--   0        0        0     1297 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/utils/env.py
+-rw-r--r--   0        0        0      893 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/utils/formatting.py
+-rw-r--r--   0        0        0    15248 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/utils/function_calling.py
+-rw-r--r--   0        0        0     3722 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/utils/html.py
+-rw-r--r--   0        0        0      423 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/utils/image.py
+-rw-r--r--   0        0        0     1304 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/utils/input.py
+-rw-r--r--   0        0        0      139 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/utils/interactive_env.py
+-rw-r--r--   0        0        0     6011 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/utils/iter.py
+-rw-r--r--   0        0        0     5805 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/utils/json.py
+-rw-r--r--   0        0        0     3067 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/utils/json_schema.py
+-rw-r--r--   0        0        0      793 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/utils/loading.py
+-rw-r--r--   0        0        0    19871 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/utils/mustache.py
+-rw-r--r--   0        0        0      301 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/utils/pydantic.py
+-rw-r--r--   0        0        0      908 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/utils/strings.py
+-rw-r--r--   0        0        0     6235 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/utils/utils.py
+-rw-r--r--   0        0        0    27149 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/langchain_core/vectorstores.py
+-rw-r--r--   0        0        0     2855 2024-05-14 03:33:08.736146 langchain_core-0.2.0rc1/pyproject.toml
+-rw-r--r--   0        0        0     5932 1970-01-01 00:00:00.000000 langchain_core-0.2.0rc1/PKG-INFO
```

### Comparing `langchain_core-0.1.9/langchain_core/_api/__init__.py` & `langchain_core-0.2.0rc1/langchain_core/_api/__init__.py`

 * *Files identical despite different names*

### Comparing `langchain_core-0.1.9/langchain_core/_api/beta_decorator.py` & `langchain_core-0.2.0rc1/langchain_core/_api/beta_decorator.py`

 * *Files 12% similar despite different names*

```diff
@@ -5,31 +5,32 @@
 https://github.com/matplotlib/matplotlib/blob/main/lib/matplotlib/_api/deprecation.py
 
 .. warning::
 
     This module is for internal use only.  Do not use it in your own code.
     We may change the API at any time with no warning.
 """
+
 import contextlib
 import functools
 import inspect
 import warnings
-from typing import Any, Callable, Generator, Type, TypeVar
+from typing import Any, Callable, Generator, Type, TypeVar, Union, cast
 
 from langchain_core._api.internal import is_caller_internal
 
 
 class LangChainBetaWarning(DeprecationWarning):
     """A class for issuing beta warnings for LangChain users."""
 
 
 # PUBLIC API
 
 
-T = TypeVar("T", Type, Callable)
+T = TypeVar("T", bound=Union[Callable[..., Any], Type])
 
 
 def beta(
     *,
     message: str = "",
     name: str = "",
     obj_type: str = "",
@@ -104,22 +105,30 @@
             """
             nonlocal warned
             if not warned and not is_caller_internal():
                 warned = True
                 emit_warning()
             return wrapped(*args, **kwargs)
 
+        async def awarning_emitting_wrapper(*args: Any, **kwargs: Any) -> Any:
+            """Same as warning_emitting_wrapper, but for async functions."""
+            nonlocal warned
+            if not warned and not is_caller_internal():
+                warned = True
+                emit_warning()
+            return await wrapped(*args, **kwargs)
+
         if isinstance(obj, type):
             if not _obj_type:
                 _obj_type = "class"
             wrapped = obj.__init__  # type: ignore
-            _name = _name or obj.__name__
+            _name = _name or obj.__qualname__
             old_doc = obj.__doc__
 
-            def finalize(_: Any, new_doc: str) -> T:
+            def finalize(wrapper: Callable[..., Any], new_doc: str) -> T:
                 """Finalize the annotation of a class."""
                 try:
                     obj.__doc__ = new_doc
                 except AttributeError:  # Can't set on some extension objects.
                     pass
 
                 def warn_if_direct_instance(
@@ -131,97 +140,107 @@
                         warned = True
                         emit_warning()
                     return wrapped(self, *args, **kwargs)
 
                 obj.__init__ = functools.wraps(obj.__init__)(  # type: ignore[misc]
                     warn_if_direct_instance
                 )
-                return obj
+                return cast(T, obj)
 
         elif isinstance(obj, property):
+            # note(erick): this block doesn't seem to be used?
             if not _obj_type:
                 _obj_type = "attribute"
             wrapped = None
-            _name = _name or obj.fget.__name__
+            _name = _name or obj.fget.__qualname__
             old_doc = obj.__doc__
 
-            class _beta_property(type(obj)):  # type: ignore
+            class _beta_property(property):
                 """A beta property."""
 
-                def __get__(self, instance, owner=None):  # type: ignore
+                def __init__(self, fget=None, fset=None, fdel=None, doc=None):
+                    super().__init__(fget, fset, fdel, doc)
+                    self.__orig_fget = fget
+                    self.__orig_fset = fset
+                    self.__orig_fdel = fdel
+
+                def __get__(self, instance, owner=None):
                     if instance is not None or owner is not None:
                         emit_warning()
-                    return super().__get__(instance, owner)
+                    return self.fget(instance)
 
-                def __set__(self, instance, value):  # type: ignore
+                def __set__(self, instance, value):
                     if instance is not None:
                         emit_warning()
-                    return super().__set__(instance, value)
+                    return self.fset(instance, value)
 
-                def __delete__(self, instance):  # type: ignore
+                def __delete__(self, instance):
                     if instance is not None:
                         emit_warning()
-                    return super().__delete__(instance)
+                    return self.fdel(instance)
 
-                def __set_name__(self, owner, set_name):  # type: ignore
+                def __set_name__(self, owner, set_name):
                     nonlocal _name
                     if _name == "<lambda>":
                         _name = set_name
 
-            def finalize(_: Any, new_doc: str) -> Any:  # type: ignore
+            def finalize(wrapper: Callable[..., Any], new_doc: str) -> Any:
                 """Finalize the property."""
                 return _beta_property(
                     fget=obj.fget, fset=obj.fset, fdel=obj.fdel, doc=new_doc
                 )
 
         else:
+            _name = _name or obj.__qualname__
             if not _obj_type:
-                _obj_type = "function"
+                # edge case: when a function is within another function
+                # within a test, this will call it a "method" not a "function"
+                _obj_type = "function" if "." not in _name else "method"
             wrapped = obj
-            _name = _name or obj.__name__  # type: ignore
             old_doc = wrapped.__doc__
 
-            def finalize(  # type: ignore
-                wrapper: Callable[..., Any], new_doc: str
-            ) -> T:
+            def finalize(wrapper: Callable[..., Any], new_doc: str) -> T:
                 """Wrap the wrapped function using the wrapper and update the docstring.
 
                 Args:
                     wrapper: The wrapper function.
                     new_doc: The new docstring.
 
                 Returns:
                     The wrapped function.
                 """
                 wrapper = functools.wraps(wrapped)(wrapper)
                 wrapper.__doc__ = new_doc
-                return wrapper
+                return cast(T, wrapper)
 
         old_doc = inspect.cleandoc(old_doc or "").strip("\n")
 
+        # old_doc can be None
         if not old_doc:
-            new_doc = "[*Beta*]"
-        else:
-            new_doc = f"[*Beta*]  {old_doc}"
+            old_doc = ""
 
         # Modify the docstring to include a beta notice.
         notes_header = "\nNotes\n-----"
         components = [
             message,
             addendum,
         ]
         details = " ".join([component.strip() for component in components if component])
-        new_doc += (
+        new_doc = (
             f"[*Beta*] {old_doc}\n"
             f"{notes_header if notes_header not in old_doc else ''}\n"
             f".. beta::\n"
             f"   {details}"
         )
 
-        return finalize(warning_emitting_wrapper, new_doc)
+        if inspect.iscoroutinefunction(obj):
+            finalized = finalize(awarning_emitting_wrapper, new_doc)
+        else:
+            finalized = finalize(warning_emitting_wrapper, new_doc)
+        return cast(T, finalized)
 
     return beta
 
 
 @contextlib.contextmanager
 def suppress_langchain_beta_warning() -> Generator[None, None, None]:
     """Context manager to suppress LangChainDeprecationWarning."""
```

### Comparing `langchain_core-0.1.9/langchain_core/_api/deprecation.py` & `langchain_core-0.2.0rc1/langchain_core/_api/deprecation.py`

 * *Files 8% similar despite different names*

```diff
@@ -10,15 +10,15 @@
     We may change the API at any time with no warning.
 """
 
 import contextlib
 import functools
 import inspect
 import warnings
-from typing import Any, Callable, Generator, Type, TypeVar
+from typing import Any, Callable, Generator, Type, TypeVar, Union, cast
 
 from langchain_core._api.internal import is_caller_internal
 
 
 class LangChainDeprecationWarning(DeprecationWarning):
     """A class for issuing deprecation warnings for LangChain users."""
 
@@ -26,28 +26,29 @@
 class LangChainPendingDeprecationWarning(PendingDeprecationWarning):
     """A class for issuing deprecation warnings for LangChain users."""
 
 
 # PUBLIC API
 
 
-T = TypeVar("T", Type, Callable)
+T = TypeVar("T", bound=Union[Type, Callable[..., Any]])
 
 
 def deprecated(
     since: str,
     *,
     message: str = "",
     name: str = "",
     alternative: str = "",
     alternative_import: str = "",
     pending: bool = False,
     obj_type: str = "",
     addendum: str = "",
     removal: str = "",
+    package: str = "",
 ) -> Callable[[T], T]:
     """Decorator to mark a function, a class, or a property as deprecated.
 
     When deprecating a classmethod, a staticmethod, or a property, the
     ``@deprecated`` decorator should go *under* ``@classmethod`` and
     ``@staticmethod`` (i.e., `deprecated` should directly decorate the
     underlying callable), but *over* ``@property``.
@@ -105,14 +106,15 @@
         _obj_type: str = obj_type,
         _name: str = name,
         _message: str = message,
         _alternative: str = alternative,
         _alternative_import: str = alternative_import,
         _pending: bool = pending,
         _addendum: str = addendum,
+        _package: str = package,
     ) -> T:
         """Implementation of the decorator returned by `deprecated`."""
 
         def emit_warning() -> None:
             """Emit the warning."""
             warn_deprecated(
                 since,
@@ -120,14 +122,15 @@
                 name=_name,
                 alternative=_alternative,
                 alternative_import=_alternative_import,
                 pending=_pending,
                 obj_type=_obj_type,
                 addendum=_addendum,
                 removal=removal,
+                package=_package,
             )
 
         warned = False
 
         def warning_emitting_wrapper(*args: Any, **kwargs: Any) -> Any:
             """Wrapper for the original wrapped callable that emits a warning.
 
@@ -140,24 +143,33 @@
             """
             nonlocal warned
             if not warned and not is_caller_internal():
                 warned = True
                 emit_warning()
             return wrapped(*args, **kwargs)
 
+        async def awarning_emitting_wrapper(*args: Any, **kwargs: Any) -> Any:
+            """Same as warning_emitting_wrapper, but for async functions."""
+
+            nonlocal warned
+            if not warned and not is_caller_internal():
+                warned = True
+                emit_warning()
+            return await wrapped(*args, **kwargs)
+
+        _package = _package or obj.__module__.split(".")[0].replace("_", "-")
+
         if isinstance(obj, type):
             if not _obj_type:
                 _obj_type = "class"
             wrapped = obj.__init__  # type: ignore
-            _name = _name or (
-                f"{obj.__module__}.{obj.__name__}" if obj.__module__ else obj.__name__
-            )
+            _name = _name or obj.__qualname__
             old_doc = obj.__doc__
 
-            def finalize(_: Any, new_doc: str) -> T:
+            def finalize(wrapper: Callable[..., Any], new_doc: str) -> T:
                 """Finalize the deprecation of a class."""
                 try:
                     obj.__doc__ = new_doc
                 except AttributeError:  # Can't set on some extension objects.
                     pass
 
                 def warn_if_direct_instance(
@@ -169,98 +181,111 @@
                         warned = True
                         emit_warning()
                     return wrapped(self, *args, **kwargs)
 
                 obj.__init__ = functools.wraps(obj.__init__)(  # type: ignore[misc]
                     warn_if_direct_instance
                 )
-                return obj
+                return cast(T, obj)
 
         elif isinstance(obj, property):
             if not _obj_type:
                 _obj_type = "attribute"
             wrapped = None
-            _name = _name or obj.fget.__name__
+            _name = _name or obj.fget.__qualname__
             old_doc = obj.__doc__
 
-            class _deprecated_property(type(obj)):  # type: ignore
+            class _deprecated_property(property):
                 """A deprecated property."""
 
-                def __get__(self, instance, owner=None):  # type: ignore
+                def __init__(self, fget=None, fset=None, fdel=None, doc=None):
+                    super().__init__(fget, fset, fdel, doc)
+                    self.__orig_fget = fget
+                    self.__orig_fset = fset
+                    self.__orig_fdel = fdel
+
+                def __get__(self, instance, owner=None):
                     if instance is not None or owner is not None:
                         emit_warning()
-                    return super().__get__(instance, owner)
+                    return self.fget(instance)
 
-                def __set__(self, instance, value):  # type: ignore
+                def __set__(self, instance, value):
                     if instance is not None:
                         emit_warning()
-                    return super().__set__(instance, value)
+                    return self.fset(instance, value)
 
-                def __delete__(self, instance):  # type: ignore
+                def __delete__(self, instance):
                     if instance is not None:
                         emit_warning()
-                    return super().__delete__(instance)
+                    return self.fdel(instance)
 
-                def __set_name__(self, owner, set_name):  # type: ignore
+                def __set_name__(self, owner, set_name):
                     nonlocal _name
                     if _name == "<lambda>":
                         _name = set_name
 
-            def finalize(_: Any, new_doc: str) -> Any:  # type: ignore
+            def finalize(wrapper: Callable[..., Any], new_doc: str) -> Any:
                 """Finalize the property."""
                 return _deprecated_property(
                     fget=obj.fget, fset=obj.fset, fdel=obj.fdel, doc=new_doc
                 )
 
         else:
+            _name = _name or obj.__qualname__
             if not _obj_type:
-                _obj_type = "function"
+                # edge case: when a function is within another function
+                # within a test, this will call it a "method" not a "function"
+                _obj_type = "function" if "." not in _name else "method"
             wrapped = obj
-            _name = _name or obj.__name__  # type: ignore
             old_doc = wrapped.__doc__
 
-            def finalize(  # type: ignore
-                wrapper: Callable[..., Any], new_doc: str
-            ) -> T:
+            def finalize(wrapper: Callable[..., Any], new_doc: str) -> T:
                 """Wrap the wrapped function using the wrapper and update the docstring.
 
                 Args:
                     wrapper: The wrapper function.
                     new_doc: The new docstring.
 
                 Returns:
                     The wrapped function.
                 """
                 wrapper = functools.wraps(wrapped)(wrapper)
                 wrapper.__doc__ = new_doc
-                return wrapper
+                return cast(T, wrapper)
 
         old_doc = inspect.cleandoc(old_doc or "").strip("\n")
 
+        # old_doc can be None
         if not old_doc:
-            new_doc = "[*Deprecated*]"
-        else:
-            new_doc = f"[*Deprecated*]  {old_doc}"
+            old_doc = ""
 
         # Modify the docstring to include a deprecation notice.
         notes_header = "\nNotes\n-----"
         components = [
             message,
             f"Use {alternative} instead." if alternative else "",
             addendum,
         ]
         details = " ".join([component.strip() for component in components if component])
-        new_doc += (
+        package = (
+            _package or _name.split(".")[0].replace("_", "-") if "." in _name else None
+        )
+        since_str = f"{package}=={since}" if package else since
+        new_doc = (
             f"[*Deprecated*] {old_doc}\n"
             f"{notes_header if notes_header not in old_doc else ''}\n"
-            f".. deprecated:: {since}\n"
+            f".. deprecated:: {since_str}\n"
             f"   {details}"
         )
 
-        return finalize(warning_emitting_wrapper, new_doc)
+        if inspect.iscoroutinefunction(obj):
+            finalized = finalize(awarning_emitting_wrapper, new_doc)
+        else:
+            finalized = finalize(warning_emitting_wrapper, new_doc)
+        return cast(T, finalized)
 
     return deprecate
 
 
 @contextlib.contextmanager
 def suppress_langchain_deprecation_warning() -> Generator[None, None, None]:
     """Context manager to suppress LangChainDeprecationWarning."""
@@ -277,14 +302,15 @@
     name: str = "",
     alternative: str = "",
     alternative_import: str = "",
     pending: bool = False,
     obj_type: str = "",
     addendum: str = "",
     removal: str = "",
+    package: str = "",
 ) -> None:
     """Display a standardized deprecation.
 
     Arguments:
         since : str
             The release at which this API became deprecated.
         message : str, optional
@@ -326,32 +352,36 @@
                 f"{removal}"
             )
         else:
             removal = f"in {removal}"
 
     if not message:
         message = ""
-        package = name.split(".")[0].replace("_", "-") if "." in name else "LangChain"
+        _package = (
+            package or name.split(".")[0].replace("_", "-")
+            if "." in name
+            else "LangChain"
+        )
 
         if obj_type:
             message += f"The {obj_type} `{name}`"
         else:
             message += f"`{name}`"
 
         if pending:
             message += " will be deprecated in a future version"
         else:
-            message += f" was deprecated in {package} {since}"
+            message += f" was deprecated in {_package} {since}"
 
             if removal:
                 message += f" and will be removed {removal}"
 
         if alternative_import:
             alt_package = alternative_import.split(".")[0].replace("_", "-")
-            if alt_package == package:
+            if alt_package == _package:
                 message += f". Use {alternative_import} instead."
             else:
                 alt_module, alt_name = alternative_import.rsplit(".", 1)
                 message += (
                     f". An updated version of the {obj_type} exists in the "
                     f"{alt_package} package and should be used instead. To use it run "
                     f"`pip install -U {alt_package}` and import as "
```

### Comparing `langchain_core-0.1.9/langchain_core/_api/internal.py` & `langchain_core-0.2.0rc1/langchain_core/_api/internal.py`

 * *Files identical despite different names*

### Comparing `langchain_core-0.1.9/langchain_core/_api/path.py` & `langchain_core-0.2.0rc1/langchain_core/_api/path.py`

 * *Files identical despite different names*

### Comparing `langchain_core-0.1.9/langchain_core/agents.py` & `langchain_core-0.2.0rc1/langchain_core/agents.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,7 +1,37 @@
+"""
+**Agent** is a class that uses an LLM to choose a sequence of actions to take.
+
+In Chains, a sequence of actions is hardcoded. In Agents,
+a language model is used as a reasoning engine to determine which actions
+to take and in which order.
+
+Agents select and use **Tools** and **Toolkits** for actions.
+
+**Class hierarchy:**
+
+.. code-block::
+
+    BaseSingleActionAgent --> LLMSingleActionAgent
+                              OpenAIFunctionsAgent
+                              XMLAgent
+                              Agent --> <name>Agent  # Examples: ZeroShotAgent, ChatAgent
+
+
+    BaseMultiActionAgent  --> OpenAIMultiFunctionsAgent
+
+
+**Main helpers:**
+
+.. code-block::
+
+    AgentType, AgentExecutor, AgentOutputParser, AgentExecutorIterator,
+    AgentAction, AgentFinish, AgentStep
+
+"""  # noqa: E501
 from __future__ import annotations
 
 import json
 from typing import Any, List, Literal, Sequence, Union
 
 from langchain_core.load.serializable import Serializable
 from langchain_core.messages import (
```

### Comparing `langchain_core-0.1.9/langchain_core/beta/runnables/context.py` & `langchain_core-0.2.0rc1/langchain_core/beta/runnables/context.py`

 * *Files 9% similar despite different names*

```diff
@@ -237,15 +237,15 @@
         key: Optional[str] = None,
         value: Optional[SetValue] = None,
         prefix: str = "",
         **kwargs: SetValue,
     ):
         if key is not None:
             kwargs[key] = value
-        super().__init__(
+        super().__init__(  # type: ignore[call-arg]
             keys={
                 k: _coerce_set_value(v) if v is not None else None
                 for k, v in kwargs.items()
             },
             prefix=prefix,
         )
 
@@ -303,15 +303,54 @@
                 await configurable[id_](await mapper.ainvoke(input, config))
             else:
                 await configurable[id_](input)
         return input
 
 
 class Context:
-    """Context for a runnable."""
+    """
+    Context for a runnable.
+
+    The `Context` class provides methods for creating context scopes,
+    getters, and setters within a runnable. It allows for managing
+    and accessing contextual information throughout the execution
+    of a program.
+
+    Example:
+        .. code-block:: python
+
+            from langchain_core.beta.runnables.context import Context
+            from langchain_core.runnables.passthrough import RunnablePassthrough
+            from langchain_core.prompts.prompt import PromptTemplate
+            from langchain_core.output_parsers.string import StrOutputParser
+            from tests.unit_tests.fake.llm import FakeListLLM
+
+            chain = (
+                Context.setter("input")
+                | {
+                    "context": RunnablePassthrough()
+                            | Context.setter("context"),
+                    "question": RunnablePassthrough(),
+                }
+                | PromptTemplate.from_template("{context} {question}")
+                | FakeListLLM(responses=["hello"])
+                | StrOutputParser()
+                | {
+                    "result": RunnablePassthrough(),
+                    "context": Context.getter("context"),
+                    "input": Context.getter("input"),
+                }
+            )
+
+            # Use the chain
+            output = chain.invoke("What's your name?")
+            print(output["result"])  # Output: "hello"
+            print(output["context"])  # Output: "What's your name?"
+            print(output["input"])  # Output: "What's your name?
+    """
 
     @staticmethod
     def create_scope(scope: str, /) -> "PrefixContext":
         """Create a context scope.
 
         Args:
             scope: The scope.
```

### Comparing `langchain_core-0.1.9/langchain_core/callbacks/__init__.py` & `langchain_core-0.2.0rc1/langchain_core/callbacks/__init__.py`

 * *Files 18% similar despite different names*

```diff
@@ -1,19 +1,28 @@
+"""**Callback handlers** allow listening to events in LangChain.
+
+**Class hierarchy:**
+
+.. code-block::
+
+    BaseCallbackHandler --> <name>CallbackHandler  # Example: AimCallbackHandler
+"""
 from langchain_core.callbacks.base import (
     AsyncCallbackHandler,
     BaseCallbackHandler,
     BaseCallbackManager,
     CallbackManagerMixin,
     Callbacks,
     ChainManagerMixin,
     LLMManagerMixin,
     RetrieverManagerMixin,
     RunManagerMixin,
     ToolManagerMixin,
 )
+from langchain_core.callbacks.file import FileCallbackHandler
 from langchain_core.callbacks.manager import (
     AsyncCallbackManager,
     AsyncCallbackManagerForChainGroup,
     AsyncCallbackManagerForChainRun,
     AsyncCallbackManagerForLLMRun,
     AsyncCallbackManagerForRetrieverRun,
     AsyncCallbackManagerForToolRun,
@@ -58,8 +67,9 @@
     "AsyncCallbackManagerForRetrieverRun",
     "CallbackManager",
     "CallbackManagerForChainGroup",
     "AsyncCallbackManager",
     "AsyncCallbackManagerForChainGroup",
     "StdOutCallbackHandler",
     "StreamingStdOutCallbackHandler",
+    "FileCallbackHandler",
 ]
```

### Comparing `langchain_core-0.1.9/langchain_core/callbacks/base.py` & `langchain_core-0.2.0rc1/langchain_core/callbacks/base.py`

 * *Files 2% similar despite different names*

```diff
@@ -129,15 +129,15 @@
 
 
 class ToolManagerMixin:
     """Mixin for tool callbacks."""
 
     def on_tool_end(
         self,
-        output: str,
+        output: Any,
         *,
         run_id: UUID,
         parent_run_id: Optional[UUID] = None,
         **kwargs: Any,
     ) -> Any:
         """Run when tool ends running."""
 
@@ -162,28 +162,39 @@
         *,
         run_id: UUID,
         parent_run_id: Optional[UUID] = None,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
         **kwargs: Any,
     ) -> Any:
-        """Run when LLM starts running."""
+        """Run when LLM starts running.
+
+        **ATTENTION**: This method is called for non-chat models (regular LLMs). If
+            you're implementing a handler for a chat model,
+            you should use on_chat_model_start instead.
+        """
 
     def on_chat_model_start(
         self,
         serialized: Dict[str, Any],
         messages: List[List[BaseMessage]],
         *,
         run_id: UUID,
         parent_run_id: Optional[UUID] = None,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
         **kwargs: Any,
     ) -> Any:
-        """Run when a chat model starts running."""
+        """Run when a chat model starts running.
+
+        **ATTENTION**: This method is called for chat models. If you're implementing
+            a handler for a non-chat model, you should use on_llm_start instead.
+        """
+        # NotImplementedError is thrown intentionally
+        # Callback handler will fall back to on_llm_start if this is exception is thrown
         raise NotImplementedError(
             f"{self.__class__.__name__} does not implement `on_chat_model_start`"
         )
 
     def on_retriever_start(
         self,
         serialized: Dict[str, Any],
@@ -215,14 +226,15 @@
         serialized: Dict[str, Any],
         input_str: str,
         *,
         run_id: UUID,
         parent_run_id: Optional[UUID] = None,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
+        inputs: Optional[Dict[str, Any]] = None,
         **kwargs: Any,
     ) -> Any:
         """Run when tool starts running."""
 
 
 class RunManagerMixin:
     """Mixin for run manager."""
@@ -303,28 +315,39 @@
         *,
         run_id: UUID,
         parent_run_id: Optional[UUID] = None,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
         **kwargs: Any,
     ) -> None:
-        """Run when LLM starts running."""
+        """Run when LLM starts running.
+
+        **ATTENTION**: This method is called for non-chat models (regular LLMs). If
+            you're implementing a handler for a chat model,
+            you should use on_chat_model_start instead.
+        """
 
     async def on_chat_model_start(
         self,
         serialized: Dict[str, Any],
         messages: List[List[BaseMessage]],
         *,
         run_id: UUID,
         parent_run_id: Optional[UUID] = None,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
         **kwargs: Any,
     ) -> Any:
-        """Run when a chat model starts running."""
+        """Run when a chat model starts running.
+
+        **ATTENTION**: This method is called for chat models. If you're implementing
+            a handler for a non-chat model, you should use on_llm_start instead.
+        """
+        # NotImplementedError is thrown intentionally
+        # Callback handler will fall back to on_llm_start if this is exception is thrown
         raise NotImplementedError(
             f"{self.__class__.__name__} does not implement `on_chat_model_start`"
         )
 
     async def on_llm_new_token(
         self,
         token: str,
@@ -354,16 +377,17 @@
         *,
         run_id: UUID,
         parent_run_id: Optional[UUID] = None,
         tags: Optional[List[str]] = None,
         **kwargs: Any,
     ) -> None:
         """Run when LLM errors.
+
         Args:
-            error (BaseException): The error that occurred.
+            error: The error that occurred.
             kwargs (Any): Additional keyword arguments.
                 - response (LLMResult): The response which was generated before
                     the error occurred.
         """
 
     async def on_chain_start(
         self,
@@ -405,21 +429,22 @@
         serialized: Dict[str, Any],
         input_str: str,
         *,
         run_id: UUID,
         parent_run_id: Optional[UUID] = None,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
+        inputs: Optional[Dict[str, Any]] = None,
         **kwargs: Any,
     ) -> None:
         """Run when tool starts running."""
 
     async def on_tool_end(
         self,
-        output: str,
+        output: Any,
         *,
         run_id: UUID,
         parent_run_id: Optional[UUID] = None,
         tags: Optional[List[str]] = None,
         **kwargs: Any,
     ) -> None:
         """Run when tool ends running."""
```

### Comparing `langchain_core-0.1.9/langchain_core/callbacks/manager.py` & `langchain_core-0.2.0rc1/langchain_core/callbacks/manager.py`

 * *Files 4% similar despite different names*

```diff
@@ -37,14 +37,15 @@
     LLMManagerMixin,
     RetrieverManagerMixin,
     RunManagerMixin,
     ToolManagerMixin,
 )
 from langchain_core.callbacks.stdout import StdOutCallbackHandler
 from langchain_core.messages import BaseMessage, get_buffer_string
+from langchain_core.tracers.schemas import Run
 from langchain_core.utils.env import env_var_is_set
 
 if TYPE_CHECKING:
     from langchain_core.agents import AgentAction, AgentFinish
     from langchain_core.documents import Document
     from langchain_core.outputs import ChatGenerationChunk, GenerationChunk, LLMResult
 
@@ -63,14 +64,15 @@
     callback_manager: Optional[CallbackManager] = None,
     *,
     inputs: Optional[Dict[str, Any]] = None,
     project_name: Optional[str] = None,
     example_id: Optional[Union[str, UUID]] = None,
     run_id: Optional[UUID] = None,
     tags: Optional[List[str]] = None,
+    metadata: Optional[Dict[str, Any]] = None,
 ) -> Generator[CallbackManagerForChainGroup, None, None]:
     """Get a callback manager for a chain group in a context manager.
     Useful for grouping different calls together as a single run even if
     they aren't composed in a single chain.
 
     Args:
         group_name (str): The name of the chain group.
@@ -79,37 +81,40 @@
         project_name (str, optional): The name of the project.
             Defaults to None.
         example_id (str or UUID, optional): The ID of the example.
             Defaults to None.
         run_id (UUID, optional): The ID of the run.
         tags (List[str], optional): The inheritable tags to apply to all runs.
             Defaults to None.
+        metadata (Dict[str, Any], optional): The metadata to apply to all runs.
+            Defaults to None.
 
     Note: must have LANGCHAIN_TRACING_V2 env var set to true to see the trace in LangSmith.
 
     Returns:
         CallbackManagerForChainGroup: The callback manager for the chain group.
 
     Example:
         .. code-block:: python
 
             llm_input = "Foo"
             with trace_as_chain_group("group_name", inputs={"input": llm_input}) as manager:
                 # Use the callback manager for the chain group
-                res = llm.predict(llm_input, callbacks=manager)
+                res = llm.invoke(llm_input, {"callbacks": manager})
                 manager.on_chain_end({"output": res})
     """  # noqa: E501
     from langchain_core.tracers.context import _get_trace_callbacks
 
     cb = _get_trace_callbacks(
         project_name, example_id, callback_manager=callback_manager
     )
     cm = CallbackManager.configure(
         inheritable_callbacks=cb,
         inheritable_tags=tags,
+        inheritable_metadata=metadata,
     )
 
     run_manager = cm.on_chain_start({"name": group_name}, inputs or {}, run_id=run_id)
     child_cm = run_manager.get_child()
     group_cm = CallbackManagerForChainGroup(
         child_cm.handlers,
         child_cm.inheritable_handlers,
@@ -137,14 +142,15 @@
     callback_manager: Optional[AsyncCallbackManager] = None,
     *,
     inputs: Optional[Dict[str, Any]] = None,
     project_name: Optional[str] = None,
     example_id: Optional[Union[str, UUID]] = None,
     run_id: Optional[UUID] = None,
     tags: Optional[List[str]] = None,
+    metadata: Optional[Dict[str, Any]] = None,
 ) -> AsyncGenerator[AsyncCallbackManagerForChainGroup, None]:
     """Get an async callback manager for a chain group in a context manager.
     Useful for grouping different async calls together as a single run even if
     they aren't composed in a single chain.
 
     Args:
         group_name (str): The name of the chain group.
@@ -153,34 +159,38 @@
         project_name (str, optional): The name of the project.
             Defaults to None.
         example_id (str or UUID, optional): The ID of the example.
             Defaults to None.
         run_id (UUID, optional): The ID of the run.
         tags (List[str], optional): The inheritable tags to apply to all runs.
             Defaults to None.
+        metadata (Dict[str, Any], optional): The metadata to apply to all runs.
+            Defaults to None.
     Returns:
         AsyncCallbackManager: The async callback manager for the chain group.
 
     Note: must have LANGCHAIN_TRACING_V2 env var set to true to see the trace in LangSmith.
 
     Example:
         .. code-block:: python
 
             llm_input = "Foo"
             async with atrace_as_chain_group("group_name", inputs={"input": llm_input}) as manager:
                 # Use the async callback manager for the chain group
-                res = await llm.apredict(llm_input, callbacks=manager)
+                res = await llm.ainvoke(llm_input, {"callbacks": manager})
                 await manager.on_chain_end({"output": res})
     """  # noqa: E501
     from langchain_core.tracers.context import _get_trace_callbacks
 
     cb = _get_trace_callbacks(
         project_name, example_id, callback_manager=callback_manager
     )
-    cm = AsyncCallbackManager.configure(inheritable_callbacks=cb, inheritable_tags=tags)
+    cm = AsyncCallbackManager.configure(
+        inheritable_callbacks=cb, inheritable_tags=tags, inheritable_metadata=metadata
+    )
 
     run_manager = await cm.on_chain_start(
         {"name": group_name}, inputs or {}, run_id=run_id
     )
     child_cm = run_manager.get_child()
     group_cm = AsyncCallbackManagerForChainGroup(
         child_cm.handlers,
@@ -199,14 +209,29 @@
             await run_manager.on_chain_error(e)
         raise e
     else:
         if not group_cm.ended:
             await run_manager.on_chain_end({})
 
 
+Func = TypeVar("Func", bound=Callable)
+
+
+def shielded(func: Func) -> Func:
+    """
+    Makes so an awaitable method is always shielded from cancellation
+    """
+
+    @functools.wraps(func)
+    async def wrapped(*args: Any, **kwargs: Any) -> Any:
+        return await asyncio.shield(func(*args, **kwargs))
+
+    return cast(Func, wrapped)
+
+
 def handle_event(
     handlers: List[BaseCallbackHandler],
     event_name: str,
     ignore_condition_name: Optional[str],
     *args: Any,
     **kwargs: Any,
 ) -> None:
@@ -289,24 +314,30 @@
         # - install signal handlers
         # - run pending tasks scheduled by `coros`
         # - close asyncgens and executors
         # - close the loop
         with asyncio.Runner() as runner:
             # Run the coroutine, get the result
             for coro in coros:
-                runner.run(coro)
+                try:
+                    runner.run(coro)
+                except Exception as e:
+                    logger.warning(f"Error in callback coroutine: {repr(e)}")
 
             # Run pending tasks scheduled by coros until they are all done
             while pending := asyncio.all_tasks(runner.get_loop()):
                 runner.run(asyncio.wait(pending))
     else:
         # Before Python 3.11 we need to run each coroutine in a new event loop
         # as the Runner api is not available.
         for coro in coros:
-            asyncio.run(coro)
+            try:
+                asyncio.run(coro)
+            except Exception as e:
+                logger.warning(f"Error in callback coroutine: {repr(e)}")
 
 
 async def _ahandle_event_for_handler(
     handler: BaseCallbackHandler,
     event_name: str,
     ignore_condition_name: Optional[str],
     *args: Any,
@@ -678,14 +709,15 @@
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             inheritable_tags=self.inheritable_tags,
             metadata=self.metadata,
             inheritable_metadata=self.inheritable_metadata,
         )
 
+    @shielded
     async def on_llm_new_token(
         self,
         token: str,
         *,
         chunk: Optional[Union[GenerationChunk, ChatGenerationChunk]] = None,
         **kwargs: Any,
     ) -> None:
@@ -702,14 +734,15 @@
             chunk=chunk,
             run_id=self.run_id,
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             **kwargs,
         )
 
+    @shielded
     async def on_llm_end(self, response: LLMResult, **kwargs: Any) -> None:
         """Run when LLM ends running.
 
         Args:
             response (LLMResult): The LLM result.
         """
         await ahandle_event(
@@ -719,14 +752,15 @@
             response,
             run_id=self.run_id,
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             **kwargs,
         )
 
+    @shielded
     async def on_llm_error(
         self,
         error: BaseException,
         **kwargs: Any,
     ) -> None:
         """Run when LLM errors.
 
@@ -849,14 +883,15 @@
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             inheritable_tags=self.inheritable_tags,
             metadata=self.metadata,
             inheritable_metadata=self.inheritable_metadata,
         )
 
+    @shielded
     async def on_chain_end(
         self, outputs: Union[Dict[str, Any], Any], **kwargs: Any
     ) -> None:
         """Run when chain ends running.
 
         Args:
             outputs (Union[Dict[str, Any], Any]): The outputs of the chain.
@@ -868,14 +903,15 @@
             outputs,
             run_id=self.run_id,
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             **kwargs,
         )
 
+    @shielded
     async def on_chain_error(
         self,
         error: BaseException,
         **kwargs: Any,
     ) -> None:
         """Run when chain errors.
 
@@ -889,14 +925,15 @@
             error,
             run_id=self.run_id,
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             **kwargs,
         )
 
+    @shielded
     async def on_agent_action(self, action: AgentAction, **kwargs: Any) -> Any:
         """Run when agent action is received.
 
         Args:
             action (AgentAction): The agent action.
 
         Returns:
@@ -909,14 +946,15 @@
             action,
             run_id=self.run_id,
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             **kwargs,
         )
 
+    @shielded
     async def on_agent_finish(self, finish: AgentFinish, **kwargs: Any) -> Any:
         """Run when agent finish is received.
 
         Args:
             finish (AgentFinish): The agent finish.
 
         Returns:
@@ -935,21 +973,21 @@
 
 
 class CallbackManagerForToolRun(ParentRunManager, ToolManagerMixin):
     """Callback manager for tool run."""
 
     def on_tool_end(
         self,
-        output: str,
+        output: Any,
         **kwargs: Any,
     ) -> None:
         """Run when tool ends running.
 
         Args:
-            output (str): The output of the tool.
+            output (Any): The output of the tool.
         """
         handle_event(
             self.handlers,
             "on_tool_end",
             "ignore_agent",
             output,
             run_id=self.run_id,
@@ -996,31 +1034,33 @@
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             inheritable_tags=self.inheritable_tags,
             metadata=self.metadata,
             inheritable_metadata=self.inheritable_metadata,
         )
 
-    async def on_tool_end(self, output: str, **kwargs: Any) -> None:
+    @shielded
+    async def on_tool_end(self, output: Any, **kwargs: Any) -> None:
         """Run when tool ends running.
 
         Args:
-            output (str): The output of the tool.
+            output (Any): The output of the tool.
         """
         await ahandle_event(
             self.handlers,
             "on_tool_end",
             "ignore_agent",
             output,
             run_id=self.run_id,
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             **kwargs,
         )
 
+    @shielded
     async def on_tool_error(
         self,
         error: BaseException,
         **kwargs: Any,
     ) -> None:
         """Run when tool errors.
 
@@ -1096,14 +1136,15 @@
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             inheritable_tags=self.inheritable_tags,
             metadata=self.metadata,
             inheritable_metadata=self.inheritable_metadata,
         )
 
+    @shielded
     async def on_retriever_end(
         self, documents: Sequence[Document], **kwargs: Any
     ) -> None:
         """Run when retriever ends running."""
         await ahandle_event(
             self.handlers,
             "on_retriever_end",
@@ -1111,14 +1152,15 @@
             documents,
             run_id=self.run_id,
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             **kwargs,
         )
 
+    @shielded
     async def on_retriever_error(
         self,
         error: BaseException,
         **kwargs: Any,
     ) -> None:
         """Run when retriever errors."""
         await ahandle_event(
@@ -1136,30 +1178,32 @@
 class CallbackManager(BaseCallbackManager):
     """Callback manager that handles callbacks from LangChain."""
 
     def on_llm_start(
         self,
         serialized: Dict[str, Any],
         prompts: List[str],
+        run_id: Optional[UUID] = None,
         **kwargs: Any,
     ) -> List[CallbackManagerForLLMRun]:
         """Run when LLM starts running.
 
         Args:
             serialized (Dict[str, Any]): The serialized LLM.
             prompts (List[str]): The list of prompts.
             run_id (UUID, optional): The ID of the run. Defaults to None.
 
         Returns:
             List[CallbackManagerForLLMRun]: A callback manager for each
                 prompt as an LLM run.
         """
         managers = []
-        for prompt in prompts:
-            run_id_ = uuid.uuid4()
+        for i, prompt in enumerate(prompts):
+            # Can't have duplicate runs with the same run ID (if provided)
+            run_id_ = run_id if i == 0 and run_id is not None else uuid.uuid4()
             handle_event(
                 self.handlers,
                 "on_llm_start",
                 "ignore_llm",
                 serialized,
                 [prompt],
                 run_id=run_id_,
@@ -1184,14 +1228,15 @@
 
         return managers
 
     def on_chat_model_start(
         self,
         serialized: Dict[str, Any],
         messages: List[List[BaseMessage]],
+        run_id: Optional[UUID] = None,
         **kwargs: Any,
     ) -> List[CallbackManagerForLLMRun]:
         """Run when LLM starts running.
 
         Args:
             serialized (Dict[str, Any]): The serialized LLM.
             messages (List[List[BaseMessage]]): The list of messages.
@@ -1200,15 +1245,19 @@
         Returns:
             List[CallbackManagerForLLMRun]: A callback manager for each
                 list of messages as an LLM run.
         """
 
         managers = []
         for message_list in messages:
-            run_id_ = uuid.uuid4()
+            if run_id is not None:
+                run_id_ = run_id
+                run_id = None
+            else:
+                run_id_ = uuid.uuid4()
             handle_event(
                 self.handlers,
                 "on_chat_model_start",
                 "ignore_chat_model",
                 serialized,
                 [message_list],
                 run_id=run_id_,
@@ -1278,23 +1327,30 @@
 
     def on_tool_start(
         self,
         serialized: Dict[str, Any],
         input_str: str,
         run_id: Optional[UUID] = None,
         parent_run_id: Optional[UUID] = None,
+        inputs: Optional[Dict[str, Any]] = None,
         **kwargs: Any,
     ) -> CallbackManagerForToolRun:
         """Run when tool starts running.
 
         Args:
-            serialized (Dict[str, Any]): The serialized tool.
-            input_str (str): The input to the tool.
-            run_id (UUID, optional): The ID of the run. Defaults to None.
-            parent_run_id (UUID, optional): The ID of the parent run. Defaults to None.
+            serialized: Serialized representation of the tool.
+            input_str: The  input to the tool as a string.
+                Non-string inputs are cast to strings.
+            run_id: ID for the run. Defaults to None.
+            parent_run_id: The ID of the parent run. Defaults to None.
+            inputs: The original input to the tool if provided.
+                Recommended for usage instead of input_str when the original
+                input is needed.
+                If provided, the inputs are expected to be formatted as a dict.
+                The keys will correspond to the named-arguments in the tool.
 
         Returns:
             CallbackManagerForToolRun: The callback manager for the tool run.
         """
         if run_id is None:
             run_id = uuid.uuid4()
 
@@ -1304,14 +1360,15 @@
             "ignore_agent",
             serialized,
             input_str,
             run_id=run_id,
             parent_run_id=self.parent_run_id,
             tags=self.tags,
             metadata=self.metadata,
+            inputs=inputs,
             **kwargs,
         )
 
         return CallbackManagerForToolRun(
             run_id=run_id,
             handlers=self.handlers,
             inheritable_handlers=self.inheritable_handlers,
@@ -1465,14 +1522,15 @@
         """Return whether the handler is async."""
         return True
 
     async def on_llm_start(
         self,
         serialized: Dict[str, Any],
         prompts: List[str],
+        run_id: Optional[UUID] = None,
         **kwargs: Any,
     ) -> List[AsyncCallbackManagerForLLMRun]:
         """Run when LLM starts running.
 
         Args:
             serialized (Dict[str, Any]): The serialized LLM.
             prompts (List[str]): The list of prompts.
@@ -1484,15 +1542,19 @@
                 to each prompt.
         """
 
         tasks = []
         managers = []
 
         for prompt in prompts:
-            run_id_ = uuid.uuid4()
+            if run_id is not None:
+                run_id_ = run_id
+                run_id = None
+            else:
+                run_id_ = uuid.uuid4()
 
             tasks.append(
                 ahandle_event(
                     self.handlers,
                     "on_llm_start",
                     "ignore_llm",
                     serialized,
@@ -1522,14 +1584,15 @@
 
         return managers
 
     async def on_chat_model_start(
         self,
         serialized: Dict[str, Any],
         messages: List[List[BaseMessage]],
+        run_id: Optional[UUID] = None,
         **kwargs: Any,
     ) -> List[AsyncCallbackManagerForLLMRun]:
         """Run when LLM starts running.
 
         Args:
             serialized (Dict[str, Any]): The serialized LLM.
             messages (List[List[BaseMessage]]): The list of messages.
@@ -1540,15 +1603,19 @@
                 async callback managers, one for each LLM Run
                 corresponding to each inner  message list.
         """
         tasks = []
         managers = []
 
         for message_list in messages:
-            run_id_ = uuid.uuid4()
+            if run_id is not None:
+                run_id_ = run_id
+                run_id = None
+            else:
+                run_id_ = uuid.uuid4()
 
             tasks.append(
                 ahandle_event(
                     self.handlers,
                     "on_chat_model_start",
                     "ignore_chat_model",
                     serialized,
@@ -1843,15 +1910,14 @@
     Returns:
         T: The configured callback manager.
     """
     from langchain_core.tracers.context import (
         _configure_hooks,
         _get_tracer_project,
         _tracing_v2_is_enabled,
-        tracing_callback_var,
         tracing_v2_callback_var,
     )
 
     run_tree = get_run_tree_context()
     parent_run_id = None if run_tree is None else getattr(run_tree, "id")
     callback_manager = callback_manager_cls(handlers=[], parent_run_id=parent_run_id)
     if inheritable_callbacks or local_callbacks:
@@ -1882,28 +1948,33 @@
     if inheritable_tags or local_tags:
         callback_manager.add_tags(inheritable_tags or [])
         callback_manager.add_tags(local_tags or [], False)
     if inheritable_metadata or local_metadata:
         callback_manager.add_metadata(inheritable_metadata or {})
         callback_manager.add_metadata(local_metadata or {}, False)
 
-    tracer = tracing_callback_var.get()
-    tracing_enabled_ = (
-        env_var_is_set("LANGCHAIN_TRACING")
-        or tracer is not None
-        or env_var_is_set("LANGCHAIN_HANDLER")
+    v1_tracing_enabled_ = env_var_is_set("LANGCHAIN_TRACING") or env_var_is_set(
+        "LANGCHAIN_HANDLER"
     )
 
     tracer_v2 = tracing_v2_callback_var.get()
     tracing_v2_enabled_ = _tracing_v2_is_enabled()
+
+    if v1_tracing_enabled_ and not tracing_v2_enabled_:
+        # if both are enabled, can silently ignore the v1 tracer
+        raise RuntimeError(
+            "Tracing using LangChainTracerV1 is no longer supported. "
+            "Please set the LANGCHAIN_TRACING_V2 environment variable to enable "
+            "tracing instead."
+        )
+
     tracer_project = _get_tracer_project()
     debug = _get_debug()
-    if verbose or debug or tracing_enabled_ or tracing_v2_enabled_:
+    if verbose or debug or tracing_v2_enabled_:
         from langchain_core.tracers.langchain import LangChainTracer
-        from langchain_core.tracers.langchain_v1 import LangChainTracerV1
         from langchain_core.tracers.stdout import ConsoleCallbackHandler
 
         if verbose and not any(
             isinstance(handler, StdOutCallbackHandler)
             for handler in callback_manager.handlers
         ):
             if debug:
@@ -1911,41 +1982,42 @@
             else:
                 callback_manager.add_handler(StdOutCallbackHandler(), False)
         if debug and not any(
             isinstance(handler, ConsoleCallbackHandler)
             for handler in callback_manager.handlers
         ):
             callback_manager.add_handler(ConsoleCallbackHandler(), True)
-        if tracing_enabled_ and not any(
-            isinstance(handler, LangChainTracerV1)
-            for handler in callback_manager.handlers
-        ):
-            if tracer:
-                callback_manager.add_handler(tracer, True)
-            else:
-                handler = LangChainTracerV1()
-                handler.load_session(tracer_project)
-                callback_manager.add_handler(handler, True)
         if tracing_v2_enabled_ and not any(
             isinstance(handler, LangChainTracer)
             for handler in callback_manager.handlers
         ):
             if tracer_v2:
                 callback_manager.add_handler(tracer_v2, True)
             else:
                 try:
-                    handler = LangChainTracer(project_name=tracer_project)
+                    handler = LangChainTracer(
+                        project_name=tracer_project,
+                        client=run_tree.client if run_tree is not None else None,
+                    )
                     callback_manager.add_handler(handler, True)
                 except Exception as e:
                     logger.warning(
                         "Unable to load requested LangChainTracer."
                         " To disable this warning,"
                         " unset the LANGCHAIN_TRACING_V2 environment variables.",
-                        e,
+                        f"{repr(e)}",
+                    )
+        if run_tree is not None:
+            for handler in callback_manager.handlers:
+                if isinstance(handler, LangChainTracer):
+                    handler.order_map[run_tree.id] = (
+                        run_tree.trace_id,
+                        run_tree.dotted_order,
                     )
+                    handler.run_map[str(run_tree.id)] = cast(Run, run_tree)
     for var, inheritable, handler_class, env_var in _configure_hooks:
         create_one = (
             env_var is not None
             and env_var_is_set(env_var)
             and handler_class is not None
         )
         if var.get() is not None or create_one:
```

### Comparing `langchain_core-0.1.9/langchain_core/callbacks/stdout.py` & `langchain_core-0.2.0rc1/langchain_core/callbacks/stdout.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,8 +1,9 @@
 """Callback Handler that prints to std out."""
+
 from __future__ import annotations
 
 from typing import TYPE_CHECKING, Any, Dict, Optional
 
 from langchain_core.callbacks.base import BaseCallbackHandler
 from langchain_core.utils import print_text
 
@@ -18,35 +19,36 @@
         self.color = color
 
     def on_chain_start(
         self, serialized: Dict[str, Any], inputs: Dict[str, Any], **kwargs: Any
     ) -> None:
         """Print out that we are entering a chain."""
         class_name = serialized.get("name", serialized.get("id", ["<unknown>"])[-1])
-        print(f"\n\n\033[1m> Entering new {class_name} chain...\033[0m")
+        print(f"\n\n\033[1m> Entering new {class_name} chain...\033[0m")  # noqa: T201
 
     def on_chain_end(self, outputs: Dict[str, Any], **kwargs: Any) -> None:
         """Print out that we finished a chain."""
-        print("\n\033[1m> Finished chain.\033[0m")
+        print("\n\033[1m> Finished chain.\033[0m")  # noqa: T201
 
     def on_agent_action(
         self, action: AgentAction, color: Optional[str] = None, **kwargs: Any
     ) -> Any:
         """Run on agent action."""
         print_text(action.log, color=color or self.color)
 
     def on_tool_end(
         self,
-        output: str,
+        output: Any,
         color: Optional[str] = None,
         observation_prefix: Optional[str] = None,
         llm_prefix: Optional[str] = None,
         **kwargs: Any,
     ) -> None:
         """If not the final action, print out observation."""
+        output = str(output)
         if observation_prefix is not None:
             print_text(f"\n{observation_prefix}")
         print_text(output, color=color or self.color)
         if llm_prefix is not None:
             print_text(f"\n{llm_prefix}")
 
     def on_text(
```

### Comparing `langchain_core-0.1.9/langchain_core/callbacks/streaming_stdout.py` & `langchain_core-0.2.0rc1/langchain_core/callbacks/streaming_stdout.py`

 * *Files 1% similar despite different names*

```diff
@@ -55,15 +55,15 @@
     ) -> None:
         """Run when tool starts running."""
 
     def on_agent_action(self, action: AgentAction, **kwargs: Any) -> Any:
         """Run on agent action."""
         pass
 
-    def on_tool_end(self, output: str, **kwargs: Any) -> None:
+    def on_tool_end(self, output: Any, **kwargs: Any) -> None:
         """Run when tool ends running."""
 
     def on_tool_error(self, error: BaseException, **kwargs: Any) -> None:
         """Run when tool errors."""
 
     def on_text(self, text: str, **kwargs: Any) -> None:
         """Run on arbitrary text."""
```

### Comparing `langchain_core-0.1.9/langchain_core/documents/base.py` & `langchain_core-0.2.0rc1/langchain_core/documents/base.py`

 * *Files 19% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 from __future__ import annotations
 
-from typing import List, Literal
+from typing import Any, List, Literal
 
 from langchain_core.load.serializable import Serializable
 from langchain_core.pydantic_v1 import Field
 
 
 class Document(Serializable):
     """Class for storing a piece of text and associated metadata."""
@@ -13,14 +13,18 @@
     """String text."""
     metadata: dict = Field(default_factory=dict)
     """Arbitrary metadata about the page content (e.g., source, relationships to other
         documents, etc.).
     """
     type: Literal["Document"] = "Document"
 
+    def __init__(self, page_content: str, **kwargs: Any) -> None:
+        """Pass page_content in as positional or named arg."""
+        super().__init__(page_content=page_content, **kwargs)
+
     @classmethod
     def is_lc_serializable(cls) -> bool:
         """Return whether this class is serializable."""
         return True
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
```

### Comparing `langchain_core-0.1.9/langchain_core/documents/transformers.py` & `langchain_core-0.2.0rc1/langchain_core/documents/transformers.py`

 * *Files identical despite different names*

### Comparing `langchain_core-0.1.9/langchain_core/embeddings.py` & `langchain_core-0.2.0rc1/langchain_core/embeddings/embeddings.py`

 * *Files 16% similar despite different names*

```diff
@@ -1,7 +1,8 @@
+"""**Embeddings** interface."""
 from abc import ABC, abstractmethod
 from typing import List
 
 from langchain_core.runnables.config import run_in_executor
 
 
 class Embeddings(ABC):
```

### Comparing `langchain_core-0.1.9/langchain_core/example_selectors/__init__.py` & `langchain_core-0.2.0rc1/langchain_core/example_selectors/__init__.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,8 +1,11 @@
-"""Logic for selecting examples to include in prompts."""
+"""**Example selector** implements logic for selecting examples to include them
+in prompts.
+This allows us to select examples that are most relevant to the input.
+"""
 from langchain_core.example_selectors.base import BaseExampleSelector
 from langchain_core.example_selectors.length_based import (
     LengthBasedExampleSelector,
 )
 from langchain_core.example_selectors.semantic_similarity import (
     MaxMarginalRelevanceExampleSelector,
     SemanticSimilarityExampleSelector,
```

### Comparing `langchain_core-0.1.9/langchain_core/example_selectors/length_based.py` & `langchain_core-0.2.0rc1/langchain_core/example_selectors/length_based.py`

 * *Files 4% similar despite different names*

```diff
@@ -30,14 +30,18 @@
 
     def add_example(self, example: Dict[str, str]) -> None:
         """Add new example to list."""
         self.examples.append(example)
         string_example = self.example_prompt.format(**example)
         self.example_text_lengths.append(self.get_text_length(string_example))
 
+    async def aadd_example(self, example: Dict[str, str]) -> None:
+        """Add new example to list."""
+        self.add_example(example)
+
     @validator("example_text_lengths", always=True)
     def calculate_example_text_lengths(cls, v: List[int], values: Dict) -> List[int]:
         """Calculate text lengths if they don't exist."""
         # Check if text lengths were passed in
         if v:
             return v
         # If they were not, calculate them
@@ -57,7 +61,11 @@
             if new_length < 0:
                 break
             else:
                 examples.append(self.examples[i])
                 remaining_length = new_length
             i += 1
         return examples
+
+    async def aselect_examples(self, input_variables: Dict[str, str]) -> List[dict]:
+        """Select which examples to use based on the input lengths."""
+        return self.select_examples(input_variables)
```

### Comparing `langchain_core-0.1.9/langchain_core/example_selectors/semantic_similarity.py` & `langchain_core-0.2.0rc1/langchain_core/prompts/few_shot_with_templates.py`

 * *Files 27% similar despite different names*

```diff
@@ -1,172 +1,204 @@
-"""Example selector that selects examples based on SemanticSimilarity."""
-from __future__ import annotations
+"""Prompt template that contains few shot examples."""
+from pathlib import Path
+from typing import Any, Dict, List, Optional, Union
 
-from typing import TYPE_CHECKING, Any, Dict, List, Optional, Type
+from langchain_core.prompts.prompt import PromptTemplate
+from langchain_core.prompts.string import (
+    DEFAULT_FORMATTER_MAPPING,
+    StringPromptTemplate,
+)
+from langchain_core.pydantic_v1 import Extra, root_validator
 
-from langchain_core.example_selectors.base import BaseExampleSelector
-from langchain_core.pydantic_v1 import BaseModel, Extra
-from langchain_core.vectorstores import VectorStore
-
-if TYPE_CHECKING:
-    from langchain_core.embeddings import Embeddings
-
-
-def sorted_values(values: Dict[str, str]) -> List[Any]:
-    """Return a list of values in dict sorted by key."""
-    return [values[val] for val in sorted(values)]
-
-
-class SemanticSimilarityExampleSelector(BaseExampleSelector, BaseModel):
-    """Example selector that selects examples based on SemanticSimilarity."""
-
-    vectorstore: VectorStore
-    """VectorStore than contains information about examples."""
-    k: int = 4
-    """Number of examples to select."""
-    example_keys: Optional[List[str]] = None
-    """Optional keys to filter examples to."""
-    input_keys: Optional[List[str]] = None
-    """Optional keys to filter input to. If provided, the search is based on
-    the input variables instead of all variables."""
-    vectorstore_kwargs: Optional[Dict[str, Any]] = None
-    """Extra arguments passed to similarity_search function of the vectorstore."""
 
-    class Config:
-        """Configuration for this pydantic object."""
+class FewShotPromptWithTemplates(StringPromptTemplate):
+    """Prompt template that contains few shot examples."""
 
-        extra = Extra.forbid
-        arbitrary_types_allowed = True
+    examples: Optional[List[dict]] = None
+    """Examples to format into the prompt.
+    Either this or example_selector should be provided."""
 
-    def add_example(self, example: Dict[str, str]) -> str:
-        """Add new example to vectorstore."""
-        if self.input_keys:
-            string_example = " ".join(
-                sorted_values({key: example[key] for key in self.input_keys})
-            )
-        else:
-            string_example = " ".join(sorted_values(example))
-        ids = self.vectorstore.add_texts([string_example], metadatas=[example])
-        return ids[0]
-
-    def select_examples(self, input_variables: Dict[str, str]) -> List[dict]:
-        """Select which examples to use based on semantic similarity."""
-        # Get the docs with the highest similarity.
-        if self.input_keys:
-            input_variables = {key: input_variables[key] for key in self.input_keys}
-        vectorstore_kwargs = self.vectorstore_kwargs or {}
-        query = " ".join(sorted_values(input_variables))
-        example_docs = self.vectorstore.similarity_search(
-            query, k=self.k, **vectorstore_kwargs
-        )
-        # Get the examples from the metadata.
-        # This assumes that examples are stored in metadata.
-        examples = [dict(e.metadata) for e in example_docs]
-        # If example keys are provided, filter examples to those keys.
-        if self.example_keys:
-            examples = [{k: eg[k] for k in self.example_keys} for eg in examples]
-        return examples
+    example_selector: Any = None
+    """ExampleSelector to choose the examples to format into the prompt.
+    Either this or examples should be provided."""
+
+    example_prompt: PromptTemplate
+    """PromptTemplate used to format an individual example."""
+
+    suffix: StringPromptTemplate
+    """A PromptTemplate to put after the examples."""
+
+    input_variables: List[str]
+    """A list of the names of the variables the prompt template expects."""
+
+    example_separator: str = "\n\n"
+    """String separator used to join the prefix, the examples, and suffix."""
+
+    prefix: Optional[StringPromptTemplate] = None
+    """A PromptTemplate to put before the examples."""
+
+    template_format: str = "f-string"
+    """The format of the prompt template. Options are: 'f-string', 'jinja2'."""
+
+    validate_template: bool = False
+    """Whether or not to try validating the template."""
 
     @classmethod
-    def from_examples(
-        cls,
-        examples: List[dict],
-        embeddings: Embeddings,
-        vectorstore_cls: Type[VectorStore],
-        k: int = 4,
-        input_keys: Optional[List[str]] = None,
-        **vectorstore_cls_kwargs: Any,
-    ) -> SemanticSimilarityExampleSelector:
-        """Create k-shot example selector using example list and embeddings.
+    def get_lc_namespace(cls) -> List[str]:
+        """Get the namespace of the langchain object."""
+        return ["langchain", "prompts", "few_shot_with_templates"]
+
+    @root_validator(pre=True)
+    def check_examples_and_selector(cls, values: Dict) -> Dict:
+        """Check that one and only one of examples/example_selector are provided."""
+        examples = values.get("examples", None)
+        example_selector = values.get("example_selector", None)
+        if examples and example_selector:
+            raise ValueError(
+                "Only one of 'examples' and 'example_selector' should be provided"
+            )
 
-        Reshuffles examples dynamically based on query similarity.
+        if examples is None and example_selector is None:
+            raise ValueError(
+                "One of 'examples' and 'example_selector' should be provided"
+            )
 
-        Args:
-            examples: List of examples to use in the prompt.
-            embeddings: An initialized embedding API interface, e.g. OpenAIEmbeddings().
-            vectorstore_cls: A vector store DB interface class, e.g. FAISS.
-            k: Number of examples to select
-            input_keys: If provided, the search is based on the input variables
-                instead of all variables.
-            vectorstore_cls_kwargs: optional kwargs containing url for vector store
+        return values
 
-        Returns:
-            The ExampleSelector instantiated, backed by a vector store.
-        """
-        if input_keys:
-            string_examples = [
-                " ".join(sorted_values({k: eg[k] for k in input_keys}))
-                for eg in examples
-            ]
+    @root_validator()
+    def template_is_valid(cls, values: Dict) -> Dict:
+        """Check that prefix, suffix, and input variables are consistent."""
+        if values["validate_template"]:
+            input_variables = values["input_variables"]
+            expected_input_variables = set(values["suffix"].input_variables)
+            expected_input_variables |= set(values["partial_variables"])
+            if values["prefix"] is not None:
+                expected_input_variables |= set(values["prefix"].input_variables)
+            missing_vars = expected_input_variables.difference(input_variables)
+            if missing_vars:
+                raise ValueError(
+                    f"Got input_variables={input_variables}, but based on "
+                    f"prefix/suffix expected {expected_input_variables}"
+                )
         else:
-            string_examples = [" ".join(sorted_values(eg)) for eg in examples]
-        vectorstore = vectorstore_cls.from_texts(
-            string_examples, embeddings, metadatas=examples, **vectorstore_cls_kwargs
-        )
-        return cls(vectorstore=vectorstore, k=k, input_keys=input_keys)
+            values["input_variables"] = sorted(
+                set(values["suffix"].input_variables)
+                | set(values["prefix"].input_variables if values["prefix"] else [])
+                - set(values["partial_variables"])
+            )
+        return values
 
+    class Config:
+        """Configuration for this pydantic object."""
 
-class MaxMarginalRelevanceExampleSelector(SemanticSimilarityExampleSelector):
-    """ExampleSelector that selects examples based on Max Marginal Relevance.
+        extra = Extra.forbid
+        arbitrary_types_allowed = True
 
-    This was shown to improve performance in this paper:
-    https://arxiv.org/pdf/2211.13892.pdf
-    """
-
-    fetch_k: int = 20
-    """Number of examples to fetch to rerank."""
-
-    def select_examples(self, input_variables: Dict[str, str]) -> List[dict]:
-        """Select which examples to use based on semantic similarity."""
-        # Get the docs with the highest similarity.
-        if self.input_keys:
-            input_variables = {key: input_variables[key] for key in self.input_keys}
-        query = " ".join(sorted_values(input_variables))
-        example_docs = self.vectorstore.max_marginal_relevance_search(
-            query, k=self.k, fetch_k=self.fetch_k
-        )
-        # Get the examples from the metadata.
-        # This assumes that examples are stored in metadata.
-        examples = [dict(e.metadata) for e in example_docs]
-        # If example keys are provided, filter examples to those keys.
-        if self.example_keys:
-            examples = [{k: eg[k] for k in self.example_keys} for eg in examples]
-        return examples
+    def _get_examples(self, **kwargs: Any) -> List[dict]:
+        if self.examples is not None:
+            return self.examples
+        elif self.example_selector is not None:
+            return self.example_selector.select_examples(kwargs)
+        else:
+            raise ValueError
 
-    @classmethod
-    def from_examples(
-        cls,
-        examples: List[dict],
-        embeddings: Embeddings,
-        vectorstore_cls: Type[VectorStore],
-        k: int = 4,
-        input_keys: Optional[List[str]] = None,
-        fetch_k: int = 20,
-        **vectorstore_cls_kwargs: Any,
-    ) -> MaxMarginalRelevanceExampleSelector:
-        """Create k-shot example selector using example list and embeddings.
+    async def _aget_examples(self, **kwargs: Any) -> List[dict]:
+        if self.examples is not None:
+            return self.examples
+        elif self.example_selector is not None:
+            return await self.example_selector.aselect_examples(kwargs)
+        else:
+            raise ValueError
 
-        Reshuffles examples dynamically based on query similarity.
+    def format(self, **kwargs: Any) -> str:
+        """Format the prompt with the inputs.
 
         Args:
-            examples: List of examples to use in the prompt.
-            embeddings: An iniialized embedding API interface, e.g. OpenAIEmbeddings().
-            vectorstore_cls: A vector store DB interface class, e.g. FAISS.
-            k: Number of examples to select
-            input_keys: If provided, the search is based on the input variables
-                instead of all variables.
-            vectorstore_cls_kwargs: optional kwargs containing url for vector store
+            kwargs: Any arguments to be passed to the prompt template.
 
         Returns:
-            The ExampleSelector instantiated, backed by a vector store.
+            A formatted string.
+
+        Example:
+
+        .. code-block:: python
+
+            prompt.format(variable1="foo")
         """
-        if input_keys:
-            string_examples = [
-                " ".join(sorted_values({k: eg[k] for k in input_keys}))
-                for eg in examples
-            ]
+        kwargs = self._merge_partial_and_user_variables(**kwargs)
+        # Get the examples to use.
+        examples = self._get_examples(**kwargs)
+        # Format the examples.
+        example_strings = [
+            self.example_prompt.format(**example) for example in examples
+        ]
+        # Create the overall prefix.
+        if self.prefix is None:
+            prefix = ""
         else:
-            string_examples = [" ".join(sorted_values(eg)) for eg in examples]
-        vectorstore = vectorstore_cls.from_texts(
-            string_examples, embeddings, metadatas=examples, **vectorstore_cls_kwargs
+            prefix_kwargs = {
+                k: v for k, v in kwargs.items() if k in self.prefix.input_variables
+            }
+            for k in prefix_kwargs.keys():
+                kwargs.pop(k)
+            prefix = self.prefix.format(**prefix_kwargs)
+
+        # Create the overall suffix
+        suffix_kwargs = {
+            k: v for k, v in kwargs.items() if k in self.suffix.input_variables
+        }
+        for k in suffix_kwargs.keys():
+            kwargs.pop(k)
+        suffix = self.suffix.format(
+            **suffix_kwargs,
         )
-        return cls(vectorstore=vectorstore, k=k, fetch_k=fetch_k, input_keys=input_keys)
+
+        pieces = [prefix, *example_strings, suffix]
+        template = self.example_separator.join([piece for piece in pieces if piece])
+        # Format the template with the input variables.
+        return DEFAULT_FORMATTER_MAPPING[self.template_format](template, **kwargs)
+
+    async def aformat(self, **kwargs: Any) -> str:
+        kwargs = self._merge_partial_and_user_variables(**kwargs)
+        # Get the examples to use.
+        examples = await self._aget_examples(**kwargs)
+        # Format the examples.
+        example_strings = [
+            # We can use the sync method here as PromptTemplate doesn't block
+            self.example_prompt.format(**example)
+            for example in examples
+        ]
+        # Create the overall prefix.
+        if self.prefix is None:
+            prefix = ""
+        else:
+            prefix_kwargs = {
+                k: v for k, v in kwargs.items() if k in self.prefix.input_variables
+            }
+            for k in prefix_kwargs.keys():
+                kwargs.pop(k)
+            prefix = await self.prefix.aformat(**prefix_kwargs)
+
+        # Create the overall suffix
+        suffix_kwargs = {
+            k: v for k, v in kwargs.items() if k in self.suffix.input_variables
+        }
+        for k in suffix_kwargs.keys():
+            kwargs.pop(k)
+        suffix = await self.suffix.aformat(
+            **suffix_kwargs,
+        )
+
+        pieces = [prefix, *example_strings, suffix]
+        template = self.example_separator.join([piece for piece in pieces if piece])
+        # Format the template with the input variables.
+        return DEFAULT_FORMATTER_MAPPING[self.template_format](template, **kwargs)
+
+    @property
+    def _prompt_type(self) -> str:
+        """Return the prompt type key."""
+        return "few_shot_with_templates"
+
+    def save(self, file_path: Union[Path, str]) -> None:
+        if self.example_selector:
+            raise ValueError("Saving an example selector is not currently supported")
+        return super().save(file_path)
```

### Comparing `langchain_core-0.1.9/langchain_core/exceptions.py` & `langchain_core-0.2.0rc1/langchain_core/exceptions.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,7 +1,8 @@
+"""Custom **exceptions** for LangChain. """
 from typing import Any, Optional
 
 
 class LangChainException(Exception):
     """General LangChain exception."""
```

### Comparing `langchain_core-0.1.9/langchain_core/globals/__init__.py` & `langchain_core-0.2.0rc1/langchain_core/globals.py`

 * *Files identical despite different names*

### Comparing `langchain_core-0.1.9/langchain_core/language_models/base.py` & `langchain_core-0.2.0rc1/langchain_core/language_models/base.py`

 * *Files 15% similar despite different names*

```diff
@@ -1,31 +1,42 @@
 from __future__ import annotations
 
 from abc import ABC, abstractmethod
 from functools import lru_cache
 from typing import (
     TYPE_CHECKING,
     Any,
+    Callable,
+    Dict,
     List,
+    Mapping,
     Optional,
     Sequence,
     Set,
+    Type,
     TypeVar,
     Union,
 )
 
 from typing_extensions import TypeAlias
 
 from langchain_core._api import deprecated
-from langchain_core.messages import AnyMessage, BaseMessage, get_buffer_string
+from langchain_core.messages import (
+    AnyMessage,
+    BaseMessage,
+    MessageLikeRepresentation,
+    get_buffer_string,
+)
 from langchain_core.prompt_values import PromptValue
+from langchain_core.pydantic_v1 import BaseModel, Field, validator
 from langchain_core.runnables import Runnable, RunnableSerializable
 from langchain_core.utils import get_pydantic_field_names
 
 if TYPE_CHECKING:
+    from langchain_core.caches import BaseCache
     from langchain_core.callbacks import Callbacks
     from langchain_core.outputs import LLMResult
 
 
 @lru_cache(maxsize=None)  # Cache the tokenizer
 def get_tokenizer() -> Any:
     try:
@@ -45,28 +56,68 @@
     # get the cached tokenizer
     tokenizer = get_tokenizer()
 
     # tokenize the text using the GPT-2 tokenizer
     return tokenizer.encode(text)
 
 
-LanguageModelInput = Union[PromptValue, str, Sequence[BaseMessage]]
+LanguageModelInput = Union[PromptValue, str, Sequence[MessageLikeRepresentation]]
 LanguageModelOutput = Union[BaseMessage, str]
 LanguageModelLike = Runnable[LanguageModelInput, LanguageModelOutput]
 LanguageModelOutputVar = TypeVar("LanguageModelOutputVar", BaseMessage, str)
 
 
+def _get_verbosity() -> bool:
+    from langchain_core.globals import get_verbose
+
+    return get_verbose()
+
+
 class BaseLanguageModel(
     RunnableSerializable[LanguageModelInput, LanguageModelOutputVar], ABC
 ):
     """Abstract base class for interfacing with language models.
 
     All language model wrappers inherit from BaseLanguageModel.
     """
 
+    cache: Union[BaseCache, bool, None] = None
+    """Whether to cache the response.
+    
+    * If true, will use the global cache.
+    * If false, will not use a cache
+    * If None, will use the global cache if it's set, otherwise no cache.
+    * If instance of BaseCache, will use the provided cache.
+    
+    Caching is not currently supported for streaming methods of models.
+    """
+    verbose: bool = Field(default_factory=_get_verbosity)
+    """Whether to print out response text."""
+    callbacks: Callbacks = Field(default=None, exclude=True)
+    """Callbacks to add to the run trace."""
+    tags: Optional[List[str]] = Field(default=None, exclude=True)
+    """Tags to add to the run trace."""
+    metadata: Optional[Dict[str, Any]] = Field(default=None, exclude=True)
+    """Metadata to add to the run trace."""
+    custom_get_token_ids: Optional[Callable[[str], List[int]]] = Field(
+        default=None, exclude=True
+    )
+    """Optional encoder to use for counting tokens."""
+
+    @validator("verbose", pre=True, always=True)
+    def set_verbose(cls, verbose: Optional[bool]) -> bool:
+        """If verbose is None, set it.
+
+        This allows users to pass in None as verbose to access the global setting.
+        """
+        if verbose is None:
+            return _get_verbosity()
+        else:
+            return verbose
+
     @property
     def InputType(self) -> TypeAlias:
         """Get the input type for this runnable."""
         from langchain_core.prompt_values import (
             ChatPromptValueConcrete,
             StringPromptValue,
         )
@@ -146,15 +197,21 @@
                 to the model provider API call.
 
         Returns:
             An LLMResult, which contains a list of candidate Generations for each input
                 prompt and additional model provider-specific output.
         """
 
-    @deprecated("0.1.7", alternative="invoke", removal="0.2.0")
+    def with_structured_output(
+        self, schema: Union[Dict, Type[BaseModel]], **kwargs: Any
+    ) -> Runnable[LanguageModelInput, Union[Dict, BaseModel]]:
+        """Implement this if there is a way of steering the model to generate responses that match a given schema."""  # noqa: E501
+        raise NotImplementedError()
+
+    @deprecated("0.1.7", alternative="invoke", removal="0.3.0")
     @abstractmethod
     def predict(
         self, text: str, *, stop: Optional[Sequence[str]] = None, **kwargs: Any
     ) -> str:
         """Pass a single string input to the model and return a string.
 
          Use this method when passing in raw text. If you want to pass in specific
@@ -167,15 +224,15 @@
             **kwargs: Arbitrary additional keyword arguments. These are usually passed
                 to the model provider API call.
 
         Returns:
             Top model prediction as a string.
         """
 
-    @deprecated("0.1.7", alternative="invoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="invoke", removal="0.3.0")
     @abstractmethod
     def predict_messages(
         self,
         messages: List[BaseMessage],
         *,
         stop: Optional[Sequence[str]] = None,
         **kwargs: Any,
@@ -192,15 +249,15 @@
             **kwargs: Arbitrary additional keyword arguments. These are usually passed
                 to the model provider API call.
 
         Returns:
             Top model prediction as a message.
         """
 
-    @deprecated("0.1.7", alternative="ainvoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="ainvoke", removal="0.3.0")
     @abstractmethod
     async def apredict(
         self, text: str, *, stop: Optional[Sequence[str]] = None, **kwargs: Any
     ) -> str:
         """Asynchronously pass a string to the model and return a string.
 
         Use this method when calling pure text generation models and only the top
@@ -213,15 +270,15 @@
             **kwargs: Arbitrary additional keyword arguments. These are usually passed
                 to the model provider API call.
 
         Returns:
             Top model prediction as a string.
         """
 
-    @deprecated("0.1.7", alternative="ainvoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="ainvoke", removal="0.3.0")
     @abstractmethod
     async def apredict_messages(
         self,
         messages: List[BaseMessage],
         *,
         stop: Optional[Sequence[str]] = None,
         **kwargs: Any,
@@ -238,25 +295,33 @@
             **kwargs: Arbitrary additional keyword arguments. These are usually passed
                 to the model provider API call.
 
         Returns:
             Top model prediction as a message.
         """
 
+    @property
+    def _identifying_params(self) -> Mapping[str, Any]:
+        """Get the identifying parameters."""
+        return self.lc_attributes
+
     def get_token_ids(self, text: str) -> List[int]:
         """Return the ordered ids of the tokens in a text.
 
         Args:
             text: The string input to tokenize.
 
         Returns:
             A list of ids corresponding to the tokens in the text, in order they occur
                 in the text.
         """
-        return _get_token_ids_default_method(text)
+        if self.custom_get_token_ids is not None:
+            return self.custom_get_token_ids(text)
+        else:
+            return _get_token_ids_default_method(text)
 
     def get_num_tokens(self, text: str) -> int:
         """Get the number of tokens present in the text.
 
         Useful for checking if an input will fit in a model's context window.
 
         Args:
```

### Comparing `langchain_core-0.1.9/langchain_core/language_models/chat_models.py` & `langchain_core-0.2.0rc1/langchain_core/language_models/chat_models.py`

 * *Files 14% similar despite different names*

```diff
@@ -1,26 +1,31 @@
 from __future__ import annotations
 
 import asyncio
 import inspect
+import uuid
 import warnings
 from abc import ABC, abstractmethod
 from typing import (
     TYPE_CHECKING,
     Any,
     AsyncIterator,
+    Callable,
     Dict,
     Iterator,
     List,
     Optional,
     Sequence,
+    Type,
+    Union,
     cast,
 )
 
 from langchain_core._api import deprecated
+from langchain_core.caches import BaseCache
 from langchain_core.callbacks import (
     AsyncCallbackManager,
     AsyncCallbackManagerForLLMRun,
     BaseCallbackManager,
     CallbackManager,
     CallbackManagerForLLMRun,
     Callbacks,
@@ -30,35 +35,33 @@
 from langchain_core.load import dumpd, dumps
 from langchain_core.messages import (
     AIMessage,
     AnyMessage,
     BaseMessage,
     BaseMessageChunk,
     HumanMessage,
+    convert_to_messages,
     message_chunk_to_message,
 )
 from langchain_core.outputs import (
     ChatGeneration,
     ChatGenerationChunk,
     ChatResult,
     LLMResult,
     RunInfo,
 )
 from langchain_core.prompt_values import ChatPromptValue, PromptValue, StringPromptValue
 from langchain_core.pydantic_v1 import Field, root_validator
 from langchain_core.runnables.config import ensure_config, run_in_executor
+from langchain_core.tracers.log_stream import LogStreamCallbackHandler
 
 if TYPE_CHECKING:
-    from langchain_core.runnables import RunnableConfig
-
-
-def _get_verbosity() -> bool:
-    from langchain_core.globals import get_verbose
-
-    return get_verbose()
+    from langchain_core.pydantic_v1 import BaseModel
+    from langchain_core.runnables import Runnable, RunnableConfig
+    from langchain_core.tools import BaseTool
 
 
 def generate_from_stream(stream: Iterator[ChatGenerationChunk]) -> ChatResult:
     """Generate from a stream."""
 
     generation: Optional[ChatGenerationChunk] = None
     for chunk in stream:
@@ -98,26 +101,16 @@
         ]
     )
 
 
 class BaseChatModel(BaseLanguageModel[BaseMessage], ABC):
     """Base class for Chat models."""
 
-    cache: Optional[bool] = None
-    """Whether to cache the response."""
-    verbose: bool = Field(default_factory=_get_verbosity)
-    """Whether to print out response text."""
-    callbacks: Callbacks = Field(default=None, exclude=True)
-    """Callbacks to add to the run trace."""
     callback_manager: Optional[BaseCallbackManager] = Field(default=None, exclude=True)
     """[DEPRECATED] Callback manager to add to the run trace."""
-    tags: Optional[List[str]] = Field(default=None, exclude=True)
-    """Tags to add to the run trace."""
-    metadata: Optional[Dict[str, Any]] = Field(default=None, exclude=True)
-    """Metadata to add to the run trace."""
 
     @root_validator()
     def raise_deprecation(cls, values: Dict) -> Dict:
         """Raise deprecation warning if callback_manager is used."""
         if values.get("callback_manager") is not None:
             warnings.warn(
                 "callback_manager is deprecated. Please use callbacks instead.",
@@ -140,15 +133,15 @@
 
     def _convert_input(self, input: LanguageModelInput) -> PromptValue:
         if isinstance(input, PromptValue):
             return input
         elif isinstance(input, str):
             return StringPromptValue(text=input)
         elif isinstance(input, Sequence):
-            return ChatPromptValue(messages=input)
+            return ChatPromptValue(messages=convert_to_messages(input))
         else:
             raise ValueError(
                 f"Invalid input type {type(input)}. "
                 "Must be a PromptValue, str, or list of BaseMessages."
             )
 
     def invoke(
@@ -165,14 +158,15 @@
             self.generate_prompt(
                 [self._convert_input(input)],
                 stop=stop,
                 callbacks=config.get("callbacks"),
                 tags=config.get("tags"),
                 metadata=config.get("metadata"),
                 run_name=config.get("run_name"),
+                run_id=config.pop("run_id", None),
                 **kwargs,
             ).generations[0][0],
         ).message
 
     async def ainvoke(
         self,
         input: LanguageModelInput,
@@ -185,14 +179,15 @@
         llm_result = await self.agenerate_prompt(
             [self._convert_input(input)],
             stop=stop,
             callbacks=config.get("callbacks"),
             tags=config.get("tags"),
             metadata=config.get("metadata"),
             run_name=config.get("run_name"),
+            run_id=config.pop("run_id", None),
             **kwargs,
         )
         return cast(ChatGeneration, llm_result.generations[0][0]).message
 
     def stream(
         self,
         input: LanguageModelInput,
@@ -222,21 +217,26 @@
             )
             (run_manager,) = callback_manager.on_chat_model_start(
                 dumpd(self),
                 [messages],
                 invocation_params=params,
                 options=options,
                 name=config.get("run_name"),
+                run_id=config.pop("run_id", None),
                 batch_size=1,
             )
             generation: Optional[ChatGenerationChunk] = None
             try:
-                for chunk in self._stream(
-                    messages, stop=stop, run_manager=run_manager, **kwargs
-                ):
+                for chunk in self._stream(messages, stop=stop, **kwargs):
+                    if chunk.message.id is None:
+                        chunk.message.id = f"run-{run_manager.run_id}"
+                    chunk.message.response_metadata = _gen_info_and_msg_metadata(chunk)
+                    run_manager.on_llm_new_token(
+                        cast(str, chunk.message.content), chunk=chunk
+                    )
                     yield chunk.message
                     if generation is None:
                         generation = chunk
                     else:
                         generation += chunk
                 assert generation is not None
             except BaseException as e:
@@ -254,65 +254,77 @@
         self,
         input: LanguageModelInput,
         config: Optional[RunnableConfig] = None,
         *,
         stop: Optional[List[str]] = None,
         **kwargs: Any,
     ) -> AsyncIterator[BaseMessageChunk]:
-        if type(self)._astream == BaseChatModel._astream:
-            # model doesn't implement streaming, so use default implementation
+        if (
+            type(self)._astream is BaseChatModel._astream
+            and type(self)._stream is BaseChatModel._stream
+        ):
+            # No async or sync stream is implemented, so fall back to ainvoke
             yield cast(
                 BaseMessageChunk,
                 await self.ainvoke(input, config=config, stop=stop, **kwargs),
             )
-        else:
-            config = ensure_config(config)
-            messages = self._convert_input(input).to_messages()
-            params = self._get_invocation_params(stop=stop, **kwargs)
-            options = {"stop": stop, **kwargs}
-            callback_manager = AsyncCallbackManager.configure(
-                config.get("callbacks"),
-                self.callbacks,
-                self.verbose,
-                config.get("tags"),
-                self.tags,
-                config.get("metadata"),
-                self.metadata,
+            return
+
+        config = ensure_config(config)
+        messages = self._convert_input(input).to_messages()
+        params = self._get_invocation_params(stop=stop, **kwargs)
+        options = {"stop": stop, **kwargs}
+        callback_manager = AsyncCallbackManager.configure(
+            config.get("callbacks"),
+            self.callbacks,
+            self.verbose,
+            config.get("tags"),
+            self.tags,
+            config.get("metadata"),
+            self.metadata,
+        )
+        (run_manager,) = await callback_manager.on_chat_model_start(
+            dumpd(self),
+            [messages],
+            invocation_params=params,
+            options=options,
+            name=config.get("run_name"),
+            run_id=config.pop("run_id", None),
+            batch_size=1,
+        )
+
+        generation: Optional[ChatGenerationChunk] = None
+        try:
+            async for chunk in self._astream(
+                messages,
+                stop=stop,
+                **kwargs,
+            ):
+                if chunk.message.id is None:
+                    chunk.message.id = f"run-{run_manager.run_id}"
+                chunk.message.response_metadata = _gen_info_and_msg_metadata(chunk)
+                await run_manager.on_llm_new_token(
+                    cast(str, chunk.message.content), chunk=chunk
+                )
+                yield chunk.message
+                if generation is None:
+                    generation = chunk
+                else:
+                    generation += chunk
+            assert generation is not None
+        except BaseException as e:
+            await run_manager.on_llm_error(
+                e,
+                response=LLMResult(generations=[[generation]] if generation else []),
             )
-            (run_manager,) = await callback_manager.on_chat_model_start(
-                dumpd(self),
-                [messages],
-                invocation_params=params,
-                options=options,
-                name=config.get("run_name"),
-                batch_size=1,
+            raise e
+        else:
+            await run_manager.on_llm_end(
+                LLMResult(generations=[[generation]]),
             )
-            generation: Optional[ChatGenerationChunk] = None
-            try:
-                async for chunk in self._astream(
-                    messages, stop=stop, run_manager=run_manager, **kwargs
-                ):
-                    yield chunk.message
-                    if generation is None:
-                        generation = chunk
-                    else:
-                        generation += chunk
-                assert generation is not None
-            except BaseException as e:
-                await run_manager.on_llm_error(
-                    e,
-                    response=LLMResult(
-                        generations=[[generation]] if generation else []
-                    ),
-                )
-                raise e
-            else:
-                await run_manager.on_llm_end(
-                    LLMResult(generations=[[generation]]),
-                )
 
     # --- Custom methods ---
 
     def _combine_llm_outputs(self, llm_outputs: List[Optional[dict]]) -> dict:
         return {}
 
     def _get_invocation_params(
@@ -340,14 +352,15 @@
         messages: List[List[BaseMessage]],
         stop: Optional[List[str]] = None,
         callbacks: Callbacks = None,
         *,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
         run_name: Optional[str] = None,
+        run_id: Optional[uuid.UUID] = None,
         **kwargs: Any,
     ) -> LLMResult:
         """Pass a sequence of prompts to the model and return model generations.
 
         This method should make use of batched calls for models that expose a batched
         API.
 
@@ -384,14 +397,15 @@
         )
         run_managers = callback_manager.on_chat_model_start(
             dumpd(self),
             messages,
             invocation_params=params,
             options=options,
             name=run_name,
+            run_id=run_id,
             batch_size=len(messages),
         )
         results = []
         for i, m in enumerate(messages):
             try:
                 results.append(
                     self._generate_with_cache(
@@ -402,20 +416,20 @@
                     )
                 )
             except BaseException as e:
                 if run_managers:
                     run_managers[i].on_llm_error(e, response=LLMResult(generations=[]))
                 raise e
         flattened_outputs = [
-            LLMResult(generations=[res.generations], llm_output=res.llm_output)
+            LLMResult(generations=[res.generations], llm_output=res.llm_output)  # type: ignore[list-item]
             for res in results
         ]
         llm_output = self._combine_llm_outputs([res.llm_output for res in results])
         generations = [res.generations for res in results]
-        output = LLMResult(generations=generations, llm_output=llm_output)
+        output = LLMResult(generations=generations, llm_output=llm_output)  # type: ignore[arg-type]
         if run_managers:
             run_infos = []
             for manager, flattened_output in zip(run_managers, flattened_outputs):
                 manager.on_llm_end(flattened_output)
                 run_infos.append(RunInfo(run_id=manager.run_id))
             output.run = run_infos
         return output
@@ -425,14 +439,15 @@
         messages: List[List[BaseMessage]],
         stop: Optional[List[str]] = None,
         callbacks: Callbacks = None,
         *,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
         run_name: Optional[str] = None,
+        run_id: Optional[uuid.UUID] = None,
         **kwargs: Any,
     ) -> LLMResult:
         """Asynchronously pass a sequence of prompts to a model and return generations.
 
         This method should make use of batched calls for models that expose a batched
         API.
 
@@ -471,14 +486,15 @@
         run_managers = await callback_manager.on_chat_model_start(
             dumpd(self),
             messages,
             invocation_params=params,
             options=options,
             name=run_name,
             batch_size=len(messages),
+            run_id=run_id,
         )
 
         results = await asyncio.gather(
             *[
                 self._agenerate_with_cache(
                     m,
                     stop=stop,
@@ -499,29 +515,30 @@
                 exceptions.append(res)
         if exceptions:
             if run_managers:
                 await asyncio.gather(
                     *[
                         run_manager.on_llm_end(
                             LLMResult(
-                                generations=[res.generations], llm_output=res.llm_output
+                                generations=[res.generations],  # type: ignore[list-item, union-attr]
+                                llm_output=res.llm_output,  # type: ignore[list-item, union-attr]
                             )
                         )
                         for run_manager, res in zip(run_managers, results)
                         if not isinstance(res, Exception)
                     ]
                 )
             raise exceptions[0]
         flattened_outputs = [
-            LLMResult(generations=[res.generations], llm_output=res.llm_output)
+            LLMResult(generations=[res.generations], llm_output=res.llm_output)  # type: ignore[list-item, union-attr]
             for res in results
         ]
-        llm_output = self._combine_llm_outputs([res.llm_output for res in results])
-        generations = [res.generations for res in results]
-        output = LLMResult(generations=generations, llm_output=llm_output)
+        llm_output = self._combine_llm_outputs([res.llm_output for res in results])  # type: ignore[union-attr]
+        generations = [res.generations for res in results]  # type: ignore[union-attr]
+        output = LLMResult(generations=generations, llm_output=llm_output)  # type: ignore[arg-type]
         await asyncio.gather(
             *[
                 run_manager.on_llm_end(flattened_output)
                 for run_manager, flattened_output in zip(
                     run_managers, flattened_outputs
                 )
             ]
@@ -557,86 +574,169 @@
     def _generate_with_cache(
         self,
         messages: List[BaseMessage],
         stop: Optional[List[str]] = None,
         run_manager: Optional[CallbackManagerForLLMRun] = None,
         **kwargs: Any,
     ) -> ChatResult:
-        new_arg_supported = inspect.signature(self._generate).parameters.get(
-            "run_manager"
-        )
-        disregard_cache = self.cache is not None and not self.cache
-        llm_cache = get_llm_cache()
-        if llm_cache is None or disregard_cache:
-            # This happens when langchain.cache is None, but self.cache is True
-            if self.cache is not None and self.cache:
+        if isinstance(self.cache, BaseCache):
+            llm_cache = self.cache
+        else:
+            llm_cache = get_llm_cache()
+        # We should check the cache unless it's explicitly set to False
+        # A None cache means we should use the default global cache
+        # if it's configured.
+        check_cache = self.cache or self.cache is None
+        if check_cache:
+            if llm_cache:
+                llm_string = self._get_llm_string(stop=stop, **kwargs)
+                prompt = dumps(messages)
+                cache_val = llm_cache.lookup(prompt, llm_string)
+                if isinstance(cache_val, list):
+                    return ChatResult(generations=cache_val)
+            elif self.cache is None:
+                pass
+            else:
                 raise ValueError(
                     "Asked to cache, but no cache found at `langchain.cache`."
                 )
-            if new_arg_supported:
-                return self._generate(
-                    messages, stop=stop, run_manager=run_manager, **kwargs
+        # If stream is not explicitly set, check if implicitly requested by
+        # astream_events() or astream_log(). Bail out if _stream not implemented
+        if type(self)._stream != BaseChatModel._stream and kwargs.pop(
+            "stream",
+            (
+                next(
+                    (
+                        True
+                        for h in run_manager.handlers
+                        if isinstance(h, LogStreamCallbackHandler)
+                    ),
+                    False,
                 )
-            else:
-                return self._generate(messages, stop=stop, **kwargs)
+                if run_manager
+                else False
+            ),
+        ):
+            chunks: List[ChatGenerationChunk] = []
+            for chunk in self._stream(messages, stop=stop, **kwargs):
+                chunk.message.response_metadata = _gen_info_and_msg_metadata(chunk)
+                if run_manager:
+                    if chunk.message.id is None:
+                        chunk.message.id = f"run-{run_manager.run_id}"
+                    run_manager.on_llm_new_token(
+                        cast(str, chunk.message.content), chunk=chunk
+                    )
+                chunks.append(chunk)
+            result = generate_from_stream(iter(chunks))
         else:
-            llm_string = self._get_llm_string(stop=stop, **kwargs)
-            prompt = dumps(messages)
-            cache_val = llm_cache.lookup(prompt, llm_string)
-            if isinstance(cache_val, list):
-                return ChatResult(generations=cache_val)
+            if inspect.signature(self._generate).parameters.get("run_manager"):
+                result = self._generate(
+                    messages, stop=stop, run_manager=run_manager, **kwargs
+                )
             else:
-                if new_arg_supported:
-                    result = self._generate(
-                        messages, stop=stop, run_manager=run_manager, **kwargs
-                    )
-                else:
-                    result = self._generate(messages, stop=stop, **kwargs)
-                llm_cache.update(prompt, llm_string, result.generations)
-                return result
+                result = self._generate(messages, stop=stop, **kwargs)
+
+        # Add response metadata to each generation
+        for idx, generation in enumerate(result.generations):
+            if run_manager and generation.message.id is None:
+                generation.message.id = f"run-{run_manager.run_id}-{idx}"
+            generation.message.response_metadata = _gen_info_and_msg_metadata(
+                generation
+            )
+        if len(result.generations) == 1 and result.llm_output is not None:
+            result.generations[0].message.response_metadata = {
+                **result.llm_output,
+                **result.generations[0].message.response_metadata,
+            }
+        if check_cache and llm_cache:
+            llm_cache.update(prompt, llm_string, result.generations)
+        return result
 
     async def _agenerate_with_cache(
         self,
         messages: List[BaseMessage],
         stop: Optional[List[str]] = None,
         run_manager: Optional[AsyncCallbackManagerForLLMRun] = None,
         **kwargs: Any,
     ) -> ChatResult:
-        new_arg_supported = inspect.signature(self._agenerate).parameters.get(
-            "run_manager"
-        )
-        disregard_cache = self.cache is not None and not self.cache
-        llm_cache = get_llm_cache()
-        if llm_cache is None or disregard_cache:
-            # This happens when langchain.cache is None, but self.cache is True
-            if self.cache is not None and self.cache:
+        if isinstance(self.cache, BaseCache):
+            llm_cache = self.cache
+        else:
+            llm_cache = get_llm_cache()
+        # We should check the cache unless it's explicitly set to False
+        # A None cache means we should use the default global cache
+        # if it's configured.
+        check_cache = self.cache or self.cache is None
+        if check_cache:
+            if llm_cache:
+                llm_string = self._get_llm_string(stop=stop, **kwargs)
+                prompt = dumps(messages)
+                cache_val = await llm_cache.alookup(prompt, llm_string)
+                if isinstance(cache_val, list):
+                    return ChatResult(generations=cache_val)
+            elif self.cache is None:
+                pass
+            else:
                 raise ValueError(
                     "Asked to cache, but no cache found at `langchain.cache`."
                 )
-            if new_arg_supported:
-                return await self._agenerate(
-                    messages, stop=stop, run_manager=run_manager, **kwargs
+        # If stream is not explicitly set, check if implicitly requested by
+        # astream_events() or astream_log(). Bail out if _astream not implemented
+        if (
+            type(self)._astream != BaseChatModel._astream
+            or type(self)._stream != BaseChatModel._stream
+        ) and kwargs.pop(
+            "stream",
+            (
+                next(
+                    (
+                        True
+                        for h in run_manager.handlers
+                        if isinstance(h, LogStreamCallbackHandler)
+                    ),
+                    False,
                 )
-            else:
-                return await self._agenerate(messages, stop=stop, **kwargs)
+                if run_manager
+                else False
+            ),
+        ):
+            chunks: List[ChatGenerationChunk] = []
+            async for chunk in self._astream(messages, stop=stop, **kwargs):
+                chunk.message.response_metadata = _gen_info_and_msg_metadata(chunk)
+                if run_manager:
+                    if chunk.message.id is None:
+                        chunk.message.id = f"run-{run_manager.run_id}"
+                    await run_manager.on_llm_new_token(
+                        cast(str, chunk.message.content), chunk=chunk
+                    )
+                chunks.append(chunk)
+            result = generate_from_stream(iter(chunks))
         else:
-            llm_string = self._get_llm_string(stop=stop, **kwargs)
-            prompt = dumps(messages)
-            cache_val = llm_cache.lookup(prompt, llm_string)
-            if isinstance(cache_val, list):
-                return ChatResult(generations=cache_val)
+            if inspect.signature(self._agenerate).parameters.get("run_manager"):
+                result = await self._agenerate(
+                    messages, stop=stop, run_manager=run_manager, **kwargs
+                )
             else:
-                if new_arg_supported:
-                    result = await self._agenerate(
-                        messages, stop=stop, run_manager=run_manager, **kwargs
-                    )
-                else:
-                    result = await self._agenerate(messages, stop=stop, **kwargs)
-                llm_cache.update(prompt, llm_string, result.generations)
-                return result
+                result = await self._agenerate(messages, stop=stop, **kwargs)
+
+        # Add response metadata to each generation
+        for idx, generation in enumerate(result.generations):
+            if run_manager and generation.message.id is None:
+                generation.message.id = f"run-{run_manager.run_id}-{idx}"
+            generation.message.response_metadata = _gen_info_and_msg_metadata(
+                generation
+            )
+        if len(result.generations) == 1 and result.llm_output is not None:
+            result.generations[0].message.response_metadata = {
+                **result.llm_output,
+                **result.generations[0].message.response_metadata,
+            }
+        if check_cache and llm_cache:
+            await llm_cache.aupdate(prompt, llm_string, result.generations)
+        return result
 
     @abstractmethod
     def _generate(
         self,
         messages: List[BaseMessage],
         stop: Optional[List[str]] = None,
         run_manager: Optional[CallbackManagerForLLMRun] = None,
@@ -666,24 +766,42 @@
         messages: List[BaseMessage],
         stop: Optional[List[str]] = None,
         run_manager: Optional[CallbackManagerForLLMRun] = None,
         **kwargs: Any,
     ) -> Iterator[ChatGenerationChunk]:
         raise NotImplementedError()
 
-    def _astream(
+    async def _astream(
         self,
         messages: List[BaseMessage],
         stop: Optional[List[str]] = None,
         run_manager: Optional[AsyncCallbackManagerForLLMRun] = None,
         **kwargs: Any,
     ) -> AsyncIterator[ChatGenerationChunk]:
-        raise NotImplementedError()
+        iterator = await run_in_executor(
+            None,
+            self._stream,
+            messages,
+            stop,
+            run_manager.get_sync() if run_manager else None,
+            **kwargs,
+        )
+        done = object()
+        while True:
+            item = await run_in_executor(
+                None,
+                next,
+                iterator,
+                done,  # type: ignore[call-arg, arg-type]
+            )
+            if item is done:
+                break
+            yield item  # type: ignore[misc]
 
-    @deprecated("0.1.7", alternative="invoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="invoke", removal="0.3.0")
     def __call__(
         self,
         messages: List[BaseMessage],
         stop: Optional[List[str]] = None,
         callbacks: Callbacks = None,
         **kwargs: Any,
     ) -> BaseMessage:
@@ -707,49 +825,49 @@
         )
         generation = result.generations[0][0]
         if isinstance(generation, ChatGeneration):
             return generation.message
         else:
             raise ValueError("Unexpected generation type")
 
-    @deprecated("0.1.7", alternative="invoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="invoke", removal="0.3.0")
     def call_as_llm(
         self, message: str, stop: Optional[List[str]] = None, **kwargs: Any
     ) -> str:
         return self.predict(message, stop=stop, **kwargs)
 
-    @deprecated("0.1.7", alternative="invoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="invoke", removal="0.3.0")
     def predict(
         self, text: str, *, stop: Optional[Sequence[str]] = None, **kwargs: Any
     ) -> str:
         if stop is None:
             _stop = None
         else:
             _stop = list(stop)
         result = self([HumanMessage(content=text)], stop=_stop, **kwargs)
         if isinstance(result.content, str):
             return result.content
         else:
             raise ValueError("Cannot use predict when output is not a string.")
 
-    @deprecated("0.1.7", alternative="invoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="invoke", removal="0.3.0")
     def predict_messages(
         self,
         messages: List[BaseMessage],
         *,
         stop: Optional[Sequence[str]] = None,
         **kwargs: Any,
     ) -> BaseMessage:
         if stop is None:
             _stop = None
         else:
             _stop = list(stop)
         return self(messages, stop=_stop, **kwargs)
 
-    @deprecated("0.1.7", alternative="ainvoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="ainvoke", removal="0.3.0")
     async def apredict(
         self, text: str, *, stop: Optional[Sequence[str]] = None, **kwargs: Any
     ) -> str:
         if stop is None:
             _stop = None
         else:
             _stop = list(stop)
@@ -757,47 +875,49 @@
             [HumanMessage(content=text)], stop=_stop, **kwargs
         )
         if isinstance(result.content, str):
             return result.content
         else:
             raise ValueError("Cannot use predict when output is not a string.")
 
-    @deprecated("0.1.7", alternative="ainvoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="ainvoke", removal="0.3.0")
     async def apredict_messages(
         self,
         messages: List[BaseMessage],
         *,
         stop: Optional[Sequence[str]] = None,
         **kwargs: Any,
     ) -> BaseMessage:
         if stop is None:
             _stop = None
         else:
             _stop = list(stop)
         return await self._call_async(messages, stop=_stop, **kwargs)
 
     @property
-    def _identifying_params(self) -> Dict[str, Any]:
-        """Get the identifying parameters."""
-        return {}
-
-    @property
     @abstractmethod
     def _llm_type(self) -> str:
         """Return type of chat model."""
 
     def dict(self, **kwargs: Any) -> Dict:
         """Return a dictionary of the LLM."""
         starter_dict = dict(self._identifying_params)
         starter_dict["_type"] = self._llm_type
         return starter_dict
 
+    def bind_tools(
+        self,
+        tools: Sequence[Union[Dict[str, Any], Type[BaseModel], Callable, BaseTool]],
+        **kwargs: Any,
+    ) -> Runnable[LanguageModelInput, BaseMessage]:
+        raise NotImplementedError()
+
 
 class SimpleChatModel(BaseChatModel):
-    """Simple Chat Model."""
+    """Simplified implementation for a chat model to inherit from."""
 
     def _generate(
         self,
         messages: List[BaseMessage],
         stop: Optional[List[str]] = None,
         run_manager: Optional[CallbackManagerForLLMRun] = None,
         **kwargs: Any,
@@ -828,7 +948,16 @@
             None,
             self._generate,
             messages,
             stop=stop,
             run_manager=run_manager.get_sync() if run_manager else None,
             **kwargs,
         )
+
+
+def _gen_info_and_msg_metadata(
+    generation: Union[ChatGeneration, ChatGenerationChunk],
+) -> dict:
+    return {
+        **(generation.generation_info or {}),
+        **generation.message.response_metadata,
+    }
```

### Comparing `langchain_core-0.1.9/langchain_core/language_models/llms.py` & `langchain_core-0.2.0rc1/langchain_core/language_models/llms.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,26 +1,27 @@
 """Base interface for large language models to expose."""
+
 from __future__ import annotations
 
 import asyncio
 import functools
 import inspect
 import json
 import logging
+import uuid
 import warnings
 from abc import ABC, abstractmethod
 from pathlib import Path
 from typing import (
     Any,
     AsyncIterator,
     Callable,
     Dict,
     Iterator,
     List,
-    Mapping,
     Optional,
     Sequence,
     Tuple,
     Type,
     Union,
     cast,
 )
@@ -33,41 +34,41 @@
     retry_base,
     retry_if_exception_type,
     stop_after_attempt,
     wait_exponential,
 )
 
 from langchain_core._api import deprecated
+from langchain_core.caches import BaseCache
 from langchain_core.callbacks import (
     AsyncCallbackManager,
     AsyncCallbackManagerForLLMRun,
     BaseCallbackManager,
     CallbackManager,
     CallbackManagerForLLMRun,
     Callbacks,
 )
 from langchain_core.globals import get_llm_cache
 from langchain_core.language_models.base import BaseLanguageModel, LanguageModelInput
 from langchain_core.load import dumpd
-from langchain_core.messages import AIMessage, BaseMessage, get_buffer_string
+from langchain_core.messages import (
+    AIMessage,
+    BaseMessage,
+    convert_to_messages,
+    get_buffer_string,
+)
 from langchain_core.outputs import Generation, GenerationChunk, LLMResult, RunInfo
 from langchain_core.prompt_values import ChatPromptValue, PromptValue, StringPromptValue
-from langchain_core.pydantic_v1 import Field, root_validator, validator
+from langchain_core.pydantic_v1 import Field, root_validator
 from langchain_core.runnables import RunnableConfig, ensure_config, get_config_list
 from langchain_core.runnables.config import run_in_executor
 
 logger = logging.getLogger(__name__)
 
 
-def _get_verbosity() -> bool:
-    from langchain_core.globals import get_verbose
-
-    return get_verbose()
-
-
 @functools.lru_cache
 def _log_error_once(msg: str) -> None:
     """Log an error once."""
     logger.error(msg)
 
 
 def create_base_retry_decorator(
@@ -110,67 +111,123 @@
         stop=stop_after_attempt(max_retries),
         wait=wait_exponential(multiplier=1, min=min_seconds, max=max_seconds),
         retry=retry_instance,
         before_sleep=_before_sleep,
     )
 
 
+def _resolve_cache(cache: Union[BaseCache, bool, None]) -> Optional[BaseCache]:
+    """Resolve the cache."""
+    if isinstance(cache, BaseCache):
+        llm_cache = cache
+    elif cache is None:
+        llm_cache = get_llm_cache()
+    elif cache is True:
+        llm_cache = get_llm_cache()
+        if llm_cache is None:
+            raise ValueError(
+                "No global cache was configured. Use `set_llm_cache`."
+                "to set a global cache if you want to use a global cache."
+                "Otherwise either pass a cache object or set cache to False/None"
+            )
+    elif cache is False:
+        llm_cache = None
+    else:
+        raise ValueError(f"Unsupported cache value {cache}")
+    return llm_cache
+
+
 def get_prompts(
-    params: Dict[str, Any], prompts: List[str]
+    params: Dict[str, Any],
+    prompts: List[str],
+    cache: Optional[Union[BaseCache, bool, None]] = None,
 ) -> Tuple[Dict[int, List], str, List[int], List[str]]:
     """Get prompts that are already cached."""
     llm_string = str(sorted([(k, v) for k, v in params.items()]))
     missing_prompts = []
     missing_prompt_idxs = []
     existing_prompts = {}
-    llm_cache = get_llm_cache()
+
+    llm_cache = _resolve_cache(cache)
     for i, prompt in enumerate(prompts):
-        if llm_cache is not None:
+        if llm_cache:
             cache_val = llm_cache.lookup(prompt, llm_string)
             if isinstance(cache_val, list):
                 existing_prompts[i] = cache_val
             else:
                 missing_prompts.append(prompt)
                 missing_prompt_idxs.append(i)
     return existing_prompts, llm_string, missing_prompt_idxs, missing_prompts
 
 
+async def aget_prompts(
+    params: Dict[str, Any],
+    prompts: List[str],
+    cache: Optional[Union[BaseCache, bool, None]] = None,
+) -> Tuple[Dict[int, List], str, List[int], List[str]]:
+    """Get prompts that are already cached. Async version."""
+    llm_string = str(sorted([(k, v) for k, v in params.items()]))
+    missing_prompts = []
+    missing_prompt_idxs = []
+    existing_prompts = {}
+    llm_cache = _resolve_cache(cache)
+    for i, prompt in enumerate(prompts):
+        if llm_cache:
+            cache_val = await llm_cache.alookup(prompt, llm_string)
+            if isinstance(cache_val, list):
+                existing_prompts[i] = cache_val
+            else:
+                missing_prompts.append(prompt)
+                missing_prompt_idxs.append(i)
+    return existing_prompts, llm_string, missing_prompt_idxs, missing_prompts
+
+
 def update_cache(
+    cache: Union[BaseCache, bool, None],
     existing_prompts: Dict[int, List],
     llm_string: str,
     missing_prompt_idxs: List[int],
     new_results: LLMResult,
     prompts: List[str],
 ) -> Optional[dict]:
     """Update the cache and get the LLM output."""
-    llm_cache = get_llm_cache()
+    llm_cache = _resolve_cache(cache)
     for i, result in enumerate(new_results.generations):
         existing_prompts[missing_prompt_idxs[i]] = result
         prompt = prompts[missing_prompt_idxs[i]]
         if llm_cache is not None:
             llm_cache.update(prompt, llm_string, result)
     llm_output = new_results.llm_output
     return llm_output
 
 
+async def aupdate_cache(
+    cache: Union[BaseCache, bool, None],
+    existing_prompts: Dict[int, List],
+    llm_string: str,
+    missing_prompt_idxs: List[int],
+    new_results: LLMResult,
+    prompts: List[str],
+) -> Optional[dict]:
+    """Update the cache and get the LLM output. Async version"""
+    llm_cache = _resolve_cache(cache)
+    for i, result in enumerate(new_results.generations):
+        existing_prompts[missing_prompt_idxs[i]] = result
+        prompt = prompts[missing_prompt_idxs[i]]
+        if llm_cache:
+            await llm_cache.aupdate(prompt, llm_string, result)
+    llm_output = new_results.llm_output
+    return llm_output
+
+
 class BaseLLM(BaseLanguageModel[str], ABC):
     """Base LLM abstract interface.
 
     It should take in a prompt and return a string."""
 
-    cache: Optional[bool] = None
-    """Whether to cache the response."""
-    verbose: bool = Field(default_factory=_get_verbosity)
-    """Whether to print out response text."""
-    callbacks: Callbacks = Field(default=None, exclude=True)
-    """Callbacks to add to the run trace."""
-    tags: Optional[List[str]] = Field(default=None, exclude=True)
-    """Tags to add to the run trace."""
-    metadata: Optional[Dict[str, Any]] = Field(default=None, exclude=True)
-    """Metadata to add to the run trace."""
     callback_manager: Optional[BaseCallbackManager] = Field(default=None, exclude=True)
     """[DEPRECATED]"""
 
     class Config:
         """Configuration for this pydantic object."""
 
         arbitrary_types_allowed = True
@@ -182,39 +239,28 @@
             warnings.warn(
                 "callback_manager is deprecated. Please use callbacks instead.",
                 DeprecationWarning,
             )
             values["callbacks"] = values.pop("callback_manager", None)
         return values
 
-    @validator("verbose", pre=True, always=True)
-    def set_verbose(cls, verbose: Optional[bool]) -> bool:
-        """If verbose is None, set it.
-
-        This allows users to pass in None as verbose to access the global setting.
-        """
-        if verbose is None:
-            return _get_verbosity()
-        else:
-            return verbose
-
     # --- Runnable methods ---
 
     @property
     def OutputType(self) -> Type[str]:
         """Get the input type for this runnable."""
         return str
 
     def _convert_input(self, input: LanguageModelInput) -> PromptValue:
         if isinstance(input, PromptValue):
             return input
         elif isinstance(input, str):
             return StringPromptValue(text=input)
         elif isinstance(input, Sequence):
-            return ChatPromptValue(messages=input)
+            return ChatPromptValue(messages=convert_to_messages(input))
         else:
             raise ValueError(
                 f"Invalid input type {type(input)}. "
                 "Must be a PromptValue, str, or list of BaseMessages."
             )
 
     def invoke(
@@ -230,14 +276,15 @@
             self.generate_prompt(
                 [self._convert_input(input)],
                 stop=stop,
                 callbacks=config.get("callbacks"),
                 tags=config.get("tags"),
                 metadata=config.get("metadata"),
                 run_name=config.get("run_name"),
+                run_id=config.pop("run_id", None),
                 **kwargs,
             )
             .generations[0][0]
             .text
         )
 
     async def ainvoke(
@@ -252,14 +299,15 @@
         llm_result = await self.agenerate_prompt(
             [self._convert_input(input)],
             stop=stop,
             callbacks=config.get("callbacks"),
             tags=config.get("tags"),
             metadata=config.get("metadata"),
             run_name=config.get("run_name"),
+            run_id=config.pop("run_id", None),
             **kwargs,
         )
         return llm_result.generations[0][0].text
 
     def batch(
         self,
         inputs: List[LanguageModelInput],
@@ -382,14 +430,15 @@
             )
             (run_manager,) = callback_manager.on_llm_start(
                 dumpd(self),
                 [prompt],
                 invocation_params=params,
                 options=options,
                 name=config.get("run_name"),
+                run_id=config.pop("run_id", None),
                 batch_size=1,
             )
             generation: Optional[GenerationChunk] = None
             try:
                 for chunk in self._stream(
                     prompt, stop=stop, run_manager=run_manager, **kwargs
                 ):
@@ -414,62 +463,67 @@
         self,
         input: LanguageModelInput,
         config: Optional[RunnableConfig] = None,
         *,
         stop: Optional[List[str]] = None,
         **kwargs: Any,
     ) -> AsyncIterator[str]:
-        if type(self)._astream == BaseLLM._astream:
-            # model doesn't implement streaming, so use default implementation
+        if (
+            type(self)._astream is BaseLLM._astream
+            and type(self)._stream is BaseLLM._stream
+        ):
             yield await self.ainvoke(input, config=config, stop=stop, **kwargs)
-        else:
-            prompt = self._convert_input(input).to_string()
-            config = ensure_config(config)
-            params = self.dict()
-            params["stop"] = stop
-            params = {**params, **kwargs}
-            options = {"stop": stop}
-            callback_manager = AsyncCallbackManager.configure(
-                config.get("callbacks"),
-                self.callbacks,
-                self.verbose,
-                config.get("tags"),
-                self.tags,
-                config.get("metadata"),
-                self.metadata,
-            )
-            (run_manager,) = await callback_manager.on_llm_start(
-                dumpd(self),
-                [prompt],
-                invocation_params=params,
-                options=options,
-                name=config.get("run_name"),
-                batch_size=1,
+            return
+
+        prompt = self._convert_input(input).to_string()
+        config = ensure_config(config)
+        params = self.dict()
+        params["stop"] = stop
+        params = {**params, **kwargs}
+        options = {"stop": stop}
+        callback_manager = AsyncCallbackManager.configure(
+            config.get("callbacks"),
+            self.callbacks,
+            self.verbose,
+            config.get("tags"),
+            self.tags,
+            config.get("metadata"),
+            self.metadata,
+        )
+        (run_manager,) = await callback_manager.on_llm_start(
+            dumpd(self),
+            [prompt],
+            invocation_params=params,
+            options=options,
+            name=config.get("run_name"),
+            run_id=config.pop("run_id", None),
+            batch_size=1,
+        )
+        generation: Optional[GenerationChunk] = None
+        try:
+            async for chunk in self._astream(
+                prompt,
+                stop=stop,
+                run_manager=run_manager,
+                **kwargs,
+            ):
+                yield chunk.text
+                if generation is None:
+                    generation = chunk
+                else:
+                    generation += chunk
+            assert generation is not None
+        except BaseException as e:
+            await run_manager.on_llm_error(
+                e,
+                response=LLMResult(generations=[[generation]] if generation else []),
             )
-            generation: Optional[GenerationChunk] = None
-            try:
-                async for chunk in self._astream(
-                    prompt, stop=stop, run_manager=run_manager, **kwargs
-                ):
-                    yield chunk.text
-                    if generation is None:
-                        generation = chunk
-                    else:
-                        generation += chunk
-                assert generation is not None
-            except BaseException as e:
-                await run_manager.on_llm_error(
-                    e,
-                    response=LLMResult(
-                        generations=[[generation]] if generation else []
-                    ),
-                )
-                raise e
-            else:
-                await run_manager.on_llm_end(LLMResult(generations=[[generation]]))
+            raise e
+        else:
+            await run_manager.on_llm_end(LLMResult(generations=[[generation]]))
 
     # --- Custom methods ---
 
     @abstractmethod
     def _generate(
         self,
         prompts: List[str],
@@ -499,24 +553,78 @@
     def _stream(
         self,
         prompt: str,
         stop: Optional[List[str]] = None,
         run_manager: Optional[CallbackManagerForLLMRun] = None,
         **kwargs: Any,
     ) -> Iterator[GenerationChunk]:
+        """Stream the LLM on the given prompt.
+
+        This method should be overridden by subclasses that support streaming.
+
+        If not implemented, the default behavior of calls to stream will be to
+        fallback to the non-streaming version of the model and return
+        the output as a single chunk.
+
+        Args:
+            prompt: The prompt to generate from.
+            stop: Stop words to use when generating. Model output is cut off at the
+                first occurrence of any of these substrings.
+            run_manager: Callback manager for the run.
+            **kwargs: Arbitrary additional keyword arguments. These are usually passed
+                to the model provider API call.
+
+        Returns:
+            An iterator of GenerationChunks.
+        """
         raise NotImplementedError()
 
-    def _astream(
+    async def _astream(
         self,
         prompt: str,
         stop: Optional[List[str]] = None,
         run_manager: Optional[AsyncCallbackManagerForLLMRun] = None,
         **kwargs: Any,
     ) -> AsyncIterator[GenerationChunk]:
-        raise NotImplementedError()
+        """An async version of the _stream method.
+
+        The default implementation uses the synchronous _stream method and wraps it in
+        an async iterator. Subclasses that need to provide a true async implementation
+        should override this method.
+
+        Args:
+            prompt: The prompt to generate from.
+            stop: Stop words to use when generating. Model output is cut off at the
+                first occurrence of any of these substrings.
+            run_manager: Callback manager for the run.
+            **kwargs: Arbitrary additional keyword arguments. These are usually passed
+                to the model provider API call.
+
+        Returns:
+            An async iterator of GenerationChunks.
+        """
+        iterator = await run_in_executor(
+            None,
+            self._stream,
+            prompt,
+            stop,
+            run_manager.get_sync() if run_manager else None,
+            **kwargs,
+        )
+        done = object()
+        while True:
+            item = await run_in_executor(
+                None,
+                next,
+                iterator,
+                done,  # type: ignore[call-arg, arg-type]
+            )
+            if item is done:
+                break
+            yield item  # type: ignore[misc]
 
     def generate_prompt(
         self,
         prompts: List[PromptValue],
         stop: Optional[List[str]] = None,
         callbacks: Optional[Union[Callbacks, List[Callbacks]]] = None,
         **kwargs: Any,
@@ -574,14 +682,15 @@
         prompts: List[str],
         stop: Optional[List[str]] = None,
         callbacks: Optional[Union[Callbacks, List[Callbacks]]] = None,
         *,
         tags: Optional[Union[List[str], List[List[str]]]] = None,
         metadata: Optional[Union[Dict[str, Any], List[Dict[str, Any]]]] = None,
         run_name: Optional[Union[str, List[str]]] = None,
+        run_id: Optional[Union[uuid.UUID, List[Optional[uuid.UUID]]]] = None,
         **kwargs: Any,
     ) -> LLMResult:
         """Pass a sequence of prompts to a model and return generations.
 
         This method should make use of batched calls for models that expose a batched
         API.
 
@@ -659,44 +768,40 @@
                     cast(List[str], tags),
                     self.tags,
                     cast(Dict[str, Any], metadata),
                     self.metadata,
                 )
             ] * len(prompts)
             run_name_list = [cast(Optional[str], run_name)] * len(prompts)
-
+        run_ids_list = self._get_run_ids_list(run_id, prompts)
         params = self.dict()
         params["stop"] = stop
         options = {"stop": stop}
         (
             existing_prompts,
             llm_string,
             missing_prompt_idxs,
             missing_prompts,
-        ) = get_prompts(params, prompts)
-        disregard_cache = self.cache is not None and not self.cache
+        ) = get_prompts(params, prompts, self.cache)
         new_arg_supported = inspect.signature(self._generate).parameters.get(
             "run_manager"
         )
-        if get_llm_cache() is None or disregard_cache:
-            if self.cache is not None and self.cache:
-                raise ValueError(
-                    "Asked to cache, but no cache found at `langchain.cache`."
-                )
+        if (self.cache is None and get_llm_cache() is None) or self.cache is False:
             run_managers = [
                 callback_manager.on_llm_start(
                     dumpd(self),
                     [prompt],
                     invocation_params=params,
                     options=options,
                     name=run_name,
                     batch_size=len(prompts),
+                    run_id=run_id_,
                 )[0]
-                for callback_manager, prompt, run_name in zip(
-                    callback_managers, prompts, run_name_list
+                for callback_manager, prompt, run_name, run_id_ in zip(
+                    callback_managers, prompts, run_name_list, run_ids_list
                 )
             ]
             output = self._generate_helper(
                 prompts, stop, run_managers, bool(new_arg_supported), **kwargs
             )
             return output
         if len(missing_prompts) > 0:
@@ -711,27 +816,47 @@
                 )[0]
                 for idx in missing_prompt_idxs
             ]
             new_results = self._generate_helper(
                 missing_prompts, stop, run_managers, bool(new_arg_supported), **kwargs
             )
             llm_output = update_cache(
-                existing_prompts, llm_string, missing_prompt_idxs, new_results, prompts
+                self.cache,
+                existing_prompts,
+                llm_string,
+                missing_prompt_idxs,
+                new_results,
+                prompts,
             )
             run_info = (
                 [RunInfo(run_id=run_manager.run_id) for run_manager in run_managers]
                 if run_managers
                 else None
             )
         else:
             llm_output = {}
             run_info = None
         generations = [existing_prompts[i] for i in range(len(prompts))]
         return LLMResult(generations=generations, llm_output=llm_output, run=run_info)
 
+    @staticmethod
+    def _get_run_ids_list(
+        run_id: Optional[Union[uuid.UUID, List[Optional[uuid.UUID]]]], prompts: list
+    ) -> list:
+        if run_id is None:
+            return [None] * len(prompts)
+        if isinstance(run_id, list):
+            if len(run_id) != len(prompts):
+                raise ValueError(
+                    "Number of manually provided run_id's does not match batch length."
+                    f" {len(run_id)} != {len(prompts)}"
+                )
+            return run_id
+        return [run_id] + [None] * (len(prompts) - 1)
+
     async def _agenerate_helper(
         self,
         prompts: List[str],
         stop: Optional[List[str]],
         run_managers: List[AsyncCallbackManagerForLLMRun],
         new_arg_supported: bool,
         **kwargs: Any,
@@ -775,14 +900,15 @@
         prompts: List[str],
         stop: Optional[List[str]] = None,
         callbacks: Optional[Union[Callbacks, List[Callbacks]]] = None,
         *,
         tags: Optional[Union[List[str], List[List[str]]]] = None,
         metadata: Optional[Union[Dict[str, Any], List[Dict[str, Any]]]] = None,
         run_name: Optional[Union[str, List[str]]] = None,
+        run_id: Optional[Union[uuid.UUID, List[Optional[uuid.UUID]]]] = None,
         **kwargs: Any,
     ) -> LLMResult:
         """Asynchronously pass a sequence of prompts to a model and return generations.
 
         This method should make use of batched calls for models that expose a batched
         API.
 
@@ -851,51 +977,54 @@
                     cast(List[str], tags),
                     self.tags,
                     cast(Dict[str, Any], metadata),
                     self.metadata,
                 )
             ] * len(prompts)
             run_name_list = [cast(Optional[str], run_name)] * len(prompts)
-
+        run_ids_list = self._get_run_ids_list(run_id, prompts)
         params = self.dict()
         params["stop"] = stop
         options = {"stop": stop}
         (
             existing_prompts,
             llm_string,
             missing_prompt_idxs,
             missing_prompts,
-        ) = get_prompts(params, prompts)
-        disregard_cache = self.cache is not None and not self.cache
+        ) = await aget_prompts(params, prompts, self.cache)
+
+        # Verify whether the cache is set, and if the cache is set,
+        # verify whether the cache is available.
         new_arg_supported = inspect.signature(self._agenerate).parameters.get(
             "run_manager"
         )
-        if get_llm_cache() is None or disregard_cache:
-            if self.cache is not None and self.cache:
-                raise ValueError(
-                    "Asked to cache, but no cache found at `langchain.cache`."
-                )
+        if (self.cache is None and get_llm_cache() is None) or self.cache is False:
             run_managers = await asyncio.gather(
                 *[
                     callback_manager.on_llm_start(
                         dumpd(self),
                         [prompt],
                         invocation_params=params,
                         options=options,
                         name=run_name,
                         batch_size=len(prompts),
+                        run_id=run_id_,
                     )
-                    for callback_manager, prompt, run_name in zip(
-                        callback_managers, prompts, run_name_list
+                    for callback_manager, prompt, run_name, run_id_ in zip(
+                        callback_managers, prompts, run_name_list, run_ids_list
                     )
                 ]
             )
-            run_managers = [r[0] for r in run_managers]
+            run_managers = [r[0] for r in run_managers]  # type: ignore[misc]
             output = await self._agenerate_helper(
-                prompts, stop, run_managers, bool(new_arg_supported), **kwargs
+                prompts,
+                stop,
+                run_managers,  # type: ignore[arg-type]
+                bool(new_arg_supported),
+                **kwargs,  # type: ignore[arg-type]
             )
             return output
         if len(missing_prompts) > 0:
             run_managers = await asyncio.gather(
                 *[
                     callback_managers[idx].on_llm_start(
                         dumpd(self),
@@ -904,33 +1033,42 @@
                         options=options,
                         name=run_name_list[idx],
                         batch_size=len(missing_prompts),
                     )
                     for idx in missing_prompt_idxs
                 ]
             )
-            run_managers = [r[0] for r in run_managers]
+            run_managers = [r[0] for r in run_managers]  # type: ignore[misc]
             new_results = await self._agenerate_helper(
-                missing_prompts, stop, run_managers, bool(new_arg_supported), **kwargs
-            )
-            llm_output = update_cache(
-                existing_prompts, llm_string, missing_prompt_idxs, new_results, prompts
+                missing_prompts,
+                stop,
+                run_managers,  # type: ignore[arg-type]
+                bool(new_arg_supported),
+                **kwargs,  # type: ignore[arg-type]
+            )
+            llm_output = await aupdate_cache(
+                self.cache,
+                existing_prompts,
+                llm_string,
+                missing_prompt_idxs,
+                new_results,
+                prompts,
             )
             run_info = (
-                [RunInfo(run_id=run_manager.run_id) for run_manager in run_managers]
+                [RunInfo(run_id=run_manager.run_id) for run_manager in run_managers]  # type: ignore[attr-defined]
                 if run_managers
                 else None
             )
         else:
             llm_output = {}
             run_info = None
         generations = [existing_prompts[i] for i in range(len(prompts))]
         return LLMResult(generations=generations, llm_output=llm_output, run=run_info)
 
-    @deprecated("0.1.7", alternative="invoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="invoke", removal="0.3.0")
     def __call__(
         self,
         prompt: str,
         stop: Optional[List[str]] = None,
         callbacks: Callbacks = None,
         *,
         tags: Optional[List[str]] = None,
@@ -974,25 +1112,25 @@
             callbacks=callbacks,
             tags=tags,
             metadata=metadata,
             **kwargs,
         )
         return result.generations[0][0].text
 
-    @deprecated("0.1.7", alternative="invoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="invoke", removal="0.3.0")
     def predict(
         self, text: str, *, stop: Optional[Sequence[str]] = None, **kwargs: Any
     ) -> str:
         if stop is None:
             _stop = None
         else:
             _stop = list(stop)
         return self(text, stop=_stop, **kwargs)
 
-    @deprecated("0.1.7", alternative="invoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="invoke", removal="0.3.0")
     def predict_messages(
         self,
         messages: List[BaseMessage],
         *,
         stop: Optional[Sequence[str]] = None,
         **kwargs: Any,
     ) -> BaseMessage:
@@ -1000,25 +1138,25 @@
         if stop is None:
             _stop = None
         else:
             _stop = list(stop)
         content = self(text, stop=_stop, **kwargs)
         return AIMessage(content=content)
 
-    @deprecated("0.1.7", alternative="ainvoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="ainvoke", removal="0.3.0")
     async def apredict(
         self, text: str, *, stop: Optional[Sequence[str]] = None, **kwargs: Any
     ) -> str:
         if stop is None:
             _stop = None
         else:
             _stop = list(stop)
         return await self._call_async(text, stop=_stop, **kwargs)
 
-    @deprecated("0.1.7", alternative="ainvoke", removal="0.2.0")
+    @deprecated("0.1.7", alternative="ainvoke", removal="0.3.0")
     async def apredict_messages(
         self,
         messages: List[BaseMessage],
         *,
         stop: Optional[Sequence[str]] = None,
         **kwargs: Any,
     ) -> BaseMessage:
@@ -1026,19 +1164,14 @@
         if stop is None:
             _stop = None
         else:
             _stop = list(stop)
         content = await self._call_async(text, stop=_stop, **kwargs)
         return AIMessage(content=content)
 
-    @property
-    def _identifying_params(self) -> Mapping[str, Any]:
-        """Get the identifying parameters."""
-        return {}
-
     def __str__(self) -> str:
         """Get a string representation of the object for printing."""
         cls_name = f"\033[1m{self.__class__.__name__}\033[0m"
         return f"{cls_name}\nParams: {self._identifying_params}"
 
     @property
     @abstractmethod
@@ -1073,46 +1206,96 @@
 
         # Fetch dictionary to save
         prompt_dict = self.dict()
 
         if save_path.suffix == ".json":
             with open(file_path, "w") as f:
                 json.dump(prompt_dict, f, indent=4)
-        elif save_path.suffix == ".yaml":
+        elif save_path.suffix.endswith((".yaml", ".yml")):
             with open(file_path, "w") as f:
                 yaml.dump(prompt_dict, f, default_flow_style=False)
         else:
             raise ValueError(f"{save_path} must be json or yaml")
 
 
 class LLM(BaseLLM):
-    """Base LLM abstract class.
+    """Simple interface for implementing a custom LLM.
+
+    You should subclass this class and implement the following:
 
-    The purpose of this class is to expose a simpler interface for working
-    with LLMs, rather than expect the user to implement the full _generate method.
+    - `_call` method: Run the LLM on the given prompt and input (used by `invoke`).
+    - `_identifying_params` property: Return a dictionary of the identifying parameters
+        This is critical for caching and tracing purposes. Identifying parameters
+        is a dict that identifies the LLM.
+        It should mostly include a `model_name`.
+
+    Optional: Override the following methods to provide more optimizations:
+
+    - `_acall`: Provide a native async version of the `_call` method.
+        If not provided, will delegate to the synchronous version using
+        `run_in_executor`. (Used by `ainvoke`).
+    - `_stream`: Stream the LLM on the given prompt and input.
+        `stream` will use `_stream` if provided, otherwise it
+        use `_call` and output will arrive in one chunk.
+    - `_astream`: Override to provide a native async version of the `_stream` method.
+        `astream` will use `_astream` if provided, otherwise it will implement
+        a fallback behavior that will use `_stream` if `_stream` is implemented,
+        and use `_acall` if `_stream` is not implemented.
     """
 
     @abstractmethod
     def _call(
         self,
         prompt: str,
         stop: Optional[List[str]] = None,
         run_manager: Optional[CallbackManagerForLLMRun] = None,
         **kwargs: Any,
     ) -> str:
-        """Run the LLM on the given prompt and input."""
+        """Run the LLM on the given input.
+
+        Override this method to implement the LLM logic.
+
+        Args:
+            prompt: The prompt to generate from.
+            stop: Stop words to use when generating. Model output is cut off at the
+                first occurrence of any of the stop substrings.
+                If stop tokens are not supported consider raising NotImplementedError.
+            run_manager: Callback manager for the run.
+            **kwargs: Arbitrary additional keyword arguments. These are usually passed
+                to the model provider API call.
+
+        Returns:
+            The model output as a string. SHOULD NOT include the prompt.
+        """
 
     async def _acall(
         self,
         prompt: str,
         stop: Optional[List[str]] = None,
         run_manager: Optional[AsyncCallbackManagerForLLMRun] = None,
         **kwargs: Any,
     ) -> str:
-        """Run the LLM on the given prompt and input."""
+        """Async version of the _call method.
+
+        The default implementation delegates to the synchronous _call method using
+        `run_in_executor`. Subclasses that need to provide a true async implementation
+        should override this method to reduce the overhead of using `run_in_executor`.
+
+        Args:
+            prompt: The prompt to generate from.
+            stop: Stop words to use when generating. Model output is cut off at the
+                first occurrence of any of the stop substrings.
+                If stop tokens are not supported consider raising NotImplementedError.
+            run_manager: Callback manager for the run.
+            **kwargs: Arbitrary additional keyword arguments. These are usually passed
+                to the model provider API call.
+
+        Returns:
+            The model output as a string. SHOULD NOT include the prompt.
+        """
         return await run_in_executor(
             None,
             self._call,
             prompt,
             stop,
             run_manager.get_sync() if run_manager else None,
             **kwargs,
```

### Comparing `langchain_core-0.1.9/langchain_core/load/dump.py` & `langchain_core-0.2.0rc1/langchain_core/load/dump.py`

 * *Files identical despite different names*

### Comparing `langchain_core-0.1.9/langchain_core/load/load.py` & `langchain_core-0.2.0rc1/langchain_core/load/load.py`

 * *Files 10% similar despite different names*

```diff
@@ -1,32 +1,46 @@
 import importlib
 import json
 import os
 from typing import Any, Dict, List, Optional
 
 from langchain_core._api import beta
 from langchain_core.load.mapping import (
-    OLD_PROMPT_TEMPLATE_FORMATS,
+    _JS_SERIALIZABLE_MAPPING,
+    _OG_SERIALIZABLE_MAPPING,
+    OLD_CORE_NAMESPACES_MAPPING,
     SERIALIZABLE_MAPPING,
 )
 from langchain_core.load.serializable import Serializable
 
-DEFAULT_NAMESPACES = ["langchain", "langchain_core", "langchain_community"]
-
-ALL_SERIALIZABLE_MAPPINGS = {**SERIALIZABLE_MAPPING, **OLD_PROMPT_TEMPLATE_FORMATS}
+DEFAULT_NAMESPACES = [
+    "langchain",
+    "langchain_core",
+    "langchain_community",
+    "langchain_anthropic",
+]
+
+ALL_SERIALIZABLE_MAPPINGS = {
+    **SERIALIZABLE_MAPPING,
+    **OLD_CORE_NAMESPACES_MAPPING,
+    **_OG_SERIALIZABLE_MAPPING,
+    **_JS_SERIALIZABLE_MAPPING,
+}
 
 
 class Reviver:
     """Reviver for JSON objects."""
 
     def __init__(
         self,
         secrets_map: Optional[Dict[str, str]] = None,
         valid_namespaces: Optional[List[str]] = None,
+        secrets_from_env: bool = True,
     ) -> None:
+        self.secrets_from_env = secrets_from_env
         self.secrets_map = secrets_map or dict()
         # By default only support langchain, but user can pass in additional namespaces
         self.valid_namespaces = (
             [*DEFAULT_NAMESPACES, *valid_namespaces]
             if valid_namespaces
             else DEFAULT_NAMESPACES
         )
@@ -37,15 +51,15 @@
             and value.get("type", None) == "secret"
             and value.get("id", None) is not None
         ):
             [key] = value["id"]
             if key in self.secrets_map:
                 return self.secrets_map[key]
             else:
-                if key in os.environ and os.environ[key]:
+                if self.secrets_from_env and key in os.environ and os.environ[key]:
                     return os.environ[key]
                 raise KeyError(f'Missing key "{key}" in load(secrets_map)')
 
         if (
             value.get("lc", None) == 1
             and value.get("type", None) == "not_implemented"
             and value.get("id", None) is not None
@@ -105,50 +119,54 @@
 
 @beta()
 def loads(
     text: str,
     *,
     secrets_map: Optional[Dict[str, str]] = None,
     valid_namespaces: Optional[List[str]] = None,
+    secrets_from_env: bool = True,
 ) -> Any:
     """Revive a LangChain class from a JSON string.
     Equivalent to `load(json.loads(text))`.
 
     Args:
         text: The string to load.
         secrets_map: A map of secrets to load.
         valid_namespaces: A list of additional namespaces (modules)
             to allow to be deserialized.
 
     Returns:
         Revived LangChain objects.
     """
-    return json.loads(text, object_hook=Reviver(secrets_map, valid_namespaces))
+    return json.loads(
+        text, object_hook=Reviver(secrets_map, valid_namespaces, secrets_from_env)
+    )
 
 
 @beta()
 def load(
     obj: Any,
     *,
     secrets_map: Optional[Dict[str, str]] = None,
     valid_namespaces: Optional[List[str]] = None,
+    secrets_from_env: bool = True,
 ) -> Any:
     """Revive a LangChain class from a JSON object. Use this if you already
     have a parsed JSON object, eg. from `json.load` or `orjson.loads`.
 
     Args:
         obj: The object to load.
         secrets_map: A map of secrets to load.
         valid_namespaces: A list of additional namespaces (modules)
             to allow to be deserialized.
 
     Returns:
         Revived LangChain objects.
     """
-    reviver = Reviver(secrets_map, valid_namespaces)
+    reviver = Reviver(secrets_map, valid_namespaces, secrets_from_env)
 
     def _load(obj: Any) -> Any:
         if isinstance(obj, dict):
             # Need to revive leaf nodes before reviving this node
             loaded_obj = {k: _load(v) for k, v in obj.items()}
             return reviver(loaded_obj)
         if isinstance(obj, list):
```

### Comparing `langchain_core-0.1.9/langchain_core/load/serializable.py` & `langchain_core-0.2.0rc1/langchain_core/load/serializable.py`

 * *Files 7% similar despite different names*

```diff
@@ -1,18 +1,31 @@
 from abc import ABC
-from typing import Any, Dict, List, Literal, Optional, TypedDict, Union, cast
+from typing import (
+    Any,
+    Dict,
+    List,
+    Literal,
+    Optional,
+    TypedDict,
+    Union,
+    cast,
+)
 
-from langchain_core.pydantic_v1 import BaseModel, PrivateAttr
+from typing_extensions import NotRequired
+
+from langchain_core.pydantic_v1 import BaseModel
 
 
 class BaseSerialized(TypedDict):
     """Base class for serialized objects."""
 
     lc: int
     id: List[str]
+    name: NotRequired[str]
+    graph: NotRequired[Dict[str, Any]]
 
 
 class SerializedConstructor(BaseSerialized):
     """Serialized constructor."""
 
     type: Literal["constructor"]
     kwargs: Dict[str, Any]
@@ -97,30 +110,25 @@
     def __repr_args__(self) -> Any:
         return [
             (k, v)
             for k, v in super().__repr_args__()
             if (k not in self.__fields__ or try_neq_default(v, k, self))
         ]
 
-    _lc_kwargs = PrivateAttr(default_factory=dict)
-
-    def __init__(self, **kwargs: Any) -> None:
-        super().__init__(**kwargs)
-        self._lc_kwargs = kwargs
-
     def to_json(self) -> Union[SerializedConstructor, SerializedNotImplemented]:
         if not self.is_lc_serializable():
             return self.to_json_not_implemented()
 
         secrets = dict()
         # Get latest values for kwargs if there is an attribute with same name
         lc_kwargs = {
             k: getattr(self, k, v)
-            for k, v in self._lc_kwargs.items()
+            for k, v in self
             if not (self.__exclude_fields__ or {}).get(k, False)  # type: ignore
+            and _is_field_useful(self, k, v)
         }
 
         # Merge the lc_secrets and lc_attributes from every class in the MRO
         for cls in [None, *self.__class__.mro()]:
             # Once we get to Serializable, we're done
             if cls is Serializable:
                 break
@@ -139,14 +147,22 @@
                             f"classmethod instead."
                         )
 
             # Get a reference to self bound to each class in the MRO
             this = cast(Serializable, self if cls is None else super(cls, self))
 
             secrets.update(this.lc_secrets)
+            # Now also add the aliases for the secrets
+            # This ensures known secret aliases are hidden.
+            # Note: this does NOT hide any other extra kwargs
+            # that are not present in the fields.
+            for key in list(secrets):
+                value = secrets[key]
+                if key in this.__fields__:
+                    secrets[this.__fields__[key].alias] = value
             lc_kwargs.update(this.lc_attributes)
 
         # include all secrets, even if not specified in kwargs
         # as these secrets may be passed as an environment variable instead
         for key in secrets.keys():
             secret_value = getattr(self, key, None) or lc_kwargs.get(key)
             if secret_value is not None:
@@ -161,14 +177,31 @@
             else _replace_secrets(lc_kwargs, secrets),
         }
 
     def to_json_not_implemented(self) -> SerializedNotImplemented:
         return to_json_not_implemented(self)
 
 
+def _is_field_useful(inst: Serializable, key: str, value: Any) -> bool:
+    """Check if a field is useful as a constructor argument.
+
+    Args:
+        inst: The instance.
+        key: The key.
+        value: The value.
+
+    Returns:
+        Whether the field is useful.
+    """
+    field = inst.__fields__.get(key)
+    if not field:
+        return False
+    return field.required is True or value or field.get_default() != value
+
+
 def _replace_secrets(
     root: Dict[Any, Any], secrets_map: Dict[str, str]
 ) -> Dict[Any, Any]:
     result = root.copy()
     for path, secret_id in secrets_map.items():
         [*parts, last] = path.split(".")
         current = result
```

### Comparing `langchain_core-0.1.9/langchain_core/memory.py` & `langchain_core-0.2.0rc1/langchain_core/memory.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,13 +1,23 @@
+"""**Memory** maintains Chain state, incorporating context from past runs.
+
+**Class hierarchy for Memory:**
+
+.. code-block::
+
+    BaseMemory --> <name>Memory --> <name>Memory  # Examples: BaseChatMemory -> MotorheadMemory
+
+"""  # noqa: E501
 from __future__ import annotations
 
 from abc import ABC, abstractmethod
 from typing import Any, Dict, List
 
 from langchain_core.load.serializable import Serializable
+from langchain_core.runnables import run_in_executor
 
 
 class BaseMemory(Serializable, ABC):
     """Abstract base class for memory in Chains.
 
     Memory refers to state in Chains. Memory can be used to store information about
         past executions of a Chain and inject that information into the inputs of
@@ -46,14 +56,28 @@
     def memory_variables(self) -> List[str]:
         """The string keys this memory class will add to chain inputs."""
 
     @abstractmethod
     def load_memory_variables(self, inputs: Dict[str, Any]) -> Dict[str, Any]:
         """Return key-value pairs given the text input to the chain."""
 
+    async def aload_memory_variables(self, inputs: Dict[str, Any]) -> Dict[str, Any]:
+        """Return key-value pairs given the text input to the chain."""
+        return await run_in_executor(None, self.load_memory_variables, inputs)
+
     @abstractmethod
     def save_context(self, inputs: Dict[str, Any], outputs: Dict[str, str]) -> None:
         """Save the context of this chain run to memory."""
 
+    async def asave_context(
+        self, inputs: Dict[str, Any], outputs: Dict[str, str]
+    ) -> None:
+        """Save the context of this chain run to memory."""
+        await run_in_executor(None, self.save_context, inputs, outputs)
+
     @abstractmethod
     def clear(self) -> None:
         """Clear memory contents."""
+
+    async def aclear(self) -> None:
+        """Clear memory contents."""
+        await run_in_executor(None, self.clear)
```

### Comparing `langchain_core-0.1.9/langchain_core/messages/ai.py` & `langchain_core-0.2.0rc1/langchain_core/messages/function.py`

 * *Files 15% similar despite different names*

```diff
@@ -1,57 +1,60 @@
 from typing import Any, List, Literal
 
 from langchain_core.messages.base import (
     BaseMessage,
     BaseMessageChunk,
     merge_content,
 )
+from langchain_core.utils._merge import merge_dicts
 
 
-class AIMessage(BaseMessage):
-    """A Message from an AI."""
+class FunctionMessage(BaseMessage):
+    """Message for passing the result of executing a function back to a model."""
 
-    example: bool = False
-    """Whether this Message is being passed in to the model as part of an example 
-        conversation.
-    """
+    name: str
+    """The name of the function that was executed."""
 
-    type: Literal["ai"] = "ai"
+    type: Literal["function"] = "function"
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "messages"]
 
 
-AIMessage.update_forward_refs()
+FunctionMessage.update_forward_refs()
 
 
-class AIMessageChunk(AIMessage, BaseMessageChunk):
-    """A Message chunk from an AI."""
+class FunctionMessageChunk(FunctionMessage, BaseMessageChunk):
+    """Function Message chunk."""
 
     # Ignoring mypy re-assignment here since we're overriding the value
     # to make sure that the chunk variant can be discriminated from the
     # non-chunk variant.
-    type: Literal["AIMessageChunk"] = "AIMessageChunk"  # type: ignore[assignment] # noqa: E501
+    type: Literal["FunctionMessageChunk"] = "FunctionMessageChunk"  # type: ignore[assignment]
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "messages"]
 
     def __add__(self, other: Any) -> BaseMessageChunk:  # type: ignore
-        if isinstance(other, AIMessageChunk):
-            if self.example != other.example:
+        if isinstance(other, FunctionMessageChunk):
+            if self.name != other.name:
                 raise ValueError(
-                    "Cannot concatenate AIMessageChunks with different example values."
+                    "Cannot concatenate FunctionMessageChunks with different names."
                 )
 
             return self.__class__(
-                example=self.example,
+                name=self.name,
                 content=merge_content(self.content, other.content),
-                additional_kwargs=self._merge_kwargs_dict(
+                additional_kwargs=merge_dicts(
                     self.additional_kwargs, other.additional_kwargs
                 ),
+                response_metadata=merge_dicts(
+                    self.response_metadata, other.response_metadata
+                ),
+                id=self.id,
             )
 
         return super().__add__(other)
```

### Comparing `langchain_core-0.1.9/langchain_core/messages/base.py` & `langchain_core-0.2.0rc1/langchain_core/messages/base.py`

 * *Files 16% similar despite different names*

```diff
@@ -1,51 +1,81 @@
 from __future__ import annotations
 
-from typing import TYPE_CHECKING, Any, Dict, List, Sequence, Union
+from typing import TYPE_CHECKING, Any, Dict, List, Optional, Sequence, Union
 
 from langchain_core.load.serializable import Serializable
 from langchain_core.pydantic_v1 import Extra, Field
+from langchain_core.utils import get_bolded_text
+from langchain_core.utils._merge import merge_dicts
+from langchain_core.utils.interactive_env import is_interactive_env
 
 if TYPE_CHECKING:
     from langchain_core.prompts.chat import ChatPromptTemplate
 
 
 class BaseMessage(Serializable):
-    """The base abstract Message class.
+    """Base abstract Message class.
 
     Messages are the inputs and outputs of ChatModels.
     """
 
     content: Union[str, List[Union[str, Dict]]]
     """The string contents of the message."""
 
     additional_kwargs: dict = Field(default_factory=dict)
-    """Any additional information."""
+    """Reserved for additional payload data associated with the message.
+    
+    For example, for a message from an AI, this could include tool calls."""
+
+    response_metadata: dict = Field(default_factory=dict)
+    """Response metadata. For example: response headers, logprobs, token counts."""
 
     type: str
 
+    name: Optional[str] = None
+
+    id: Optional[str] = None
+    """An optional unique identifier for the message. This should ideally be
+    provided by the provider/model which created the message."""
+
     class Config:
         extra = Extra.allow
 
+    def __init__(
+        self, content: Union[str, List[Union[str, Dict]]], **kwargs: Any
+    ) -> None:
+        """Pass in content as positional arg."""
+        return super().__init__(content=content, **kwargs)
+
     @classmethod
     def is_lc_serializable(cls) -> bool:
         """Return whether this class is serializable."""
         return True
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "messages"]
 
     def __add__(self, other: Any) -> ChatPromptTemplate:
         from langchain_core.prompts.chat import ChatPromptTemplate
 
-        prompt = ChatPromptTemplate(messages=[self])
+        prompt = ChatPromptTemplate(messages=[self])  # type: ignore[call-arg]
         return prompt + other
 
+    def pretty_repr(self, html: bool = False) -> str:
+        title = get_msg_title_repr(self.type.title() + " Message", bold=html)
+        # TODO: handle non-string content.
+        if self.name is not None:
+            title += f"\nName: {self.name}"
+        return f"{title}\n\n{self.content}"
+
+    def pretty_print(self) -> None:
+        print(self.pretty_repr(html=is_interactive_env()))  # noqa: T201
+
 
 def merge_content(
     first_content: Union[str, List[Union[str, Dict]]],
     second_content: Union[str, List[Union[str, Dict]]],
 ) -> Union[str, List[Union[str, Dict]]]:
     """Merge two message contents.
 
@@ -76,79 +106,35 @@
             return first_content[:-1] + [first_content[-1] + second_content]
         else:
             # Otherwise, add the second content as a new element of the list
             return first_content + [second_content]
 
 
 class BaseMessageChunk(BaseMessage):
-    """A Message chunk, which can be concatenated with other Message chunks."""
+    """Message chunk, which can be concatenated with other Message chunks."""
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "messages"]
 
-    def _merge_kwargs_dict(
-        self, left: Dict[str, Any], right: Dict[str, Any]
-    ) -> Dict[str, Any]:
-        """Merge additional_kwargs from another BaseMessageChunk into this one,
-        handling specific scenarios where a key exists in both dictionaries
-        but has a value of None in 'left'. In such cases, the method uses the
-        value from 'right' for that key in the merged dictionary.
-        Example:
-        If left = {"function_call": {"arguments": None}} and
-        right = {"function_call": {"arguments": "{\n"}}
-        then, after merging, for the key "function_call",
-        the value from 'right' is used,
-        resulting in merged = {"function_call": {"arguments": "{\n"}}.
-        """
-        merged = left.copy()
-        for k, v in right.items():
-            if k not in merged:
-                merged[k] = v
-            elif merged[k] is None and v:
-                merged[k] = v
-            elif v is None:
-                continue
-            elif merged[k] == v:
-                continue
-            elif type(merged[k]) != type(v):
-                raise TypeError(
-                    f'additional_kwargs["{k}"] already exists in this message,'
-                    " but with a different type."
-                )
-            elif isinstance(merged[k], str):
-                merged[k] += v
-            elif isinstance(merged[k], dict):
-                merged[k] = self._merge_kwargs_dict(merged[k], v)
-            elif isinstance(merged[k], list):
-                merged[k] = merged[k].copy()
-                for i, e in enumerate(v):
-                    if isinstance(e, dict) and isinstance(e.get("index"), int):
-                        i = e["index"]
-                    if i < len(merged[k]):
-                        merged[k][i] = self._merge_kwargs_dict(merged[k][i], e)
-                    else:
-                        merged[k] = merged[k] + [e]
-            else:
-                raise TypeError(
-                    f"Additional kwargs key {k} already exists in this message."
-                )
-        return merged
-
     def __add__(self, other: Any) -> BaseMessageChunk:  # type: ignore
         if isinstance(other, BaseMessageChunk):
             # If both are (subclasses of) BaseMessageChunk,
             # concat into a single BaseMessageChunk
 
-            return self.__class__(
+            return self.__class__(  # type: ignore[call-arg]
+                id=self.id,
                 content=merge_content(self.content, other.content),
-                additional_kwargs=self._merge_kwargs_dict(
+                additional_kwargs=merge_dicts(
                     self.additional_kwargs, other.additional_kwargs
                 ),
+                response_metadata=merge_dicts(
+                    self.response_metadata, other.response_metadata
+                ),
             )
         else:
             raise TypeError(
                 'unsupported operand type(s) for +: "'
                 f"{self.__class__.__name__}"
                 f'" and "{other.__class__.__name__}"'
             )
@@ -172,7 +158,26 @@
     Args:
         messages: Sequence of messages (as BaseMessages) to convert.
 
     Returns:
         List of messages as dicts.
     """
     return [message_to_dict(m) for m in messages]
+
+
+def get_msg_title_repr(title: str, *, bold: bool = False) -> str:
+    """Get a title representation for a message.
+
+    Args:
+        title: The title.
+        bold: Whether to bold the title.
+
+    Returns:
+        The title representation.
+    """
+    padded = " " + title + " "
+    sep_len = (80 - len(padded)) // 2
+    sep = "=" * sep_len
+    second_sep = sep + "=" if len(padded) % 2 else sep
+    if bold:
+        padded = get_bolded_text(padded)
+    return f"{sep}{padded}{second_sep}"
```

### Comparing `langchain_core-0.1.9/langchain_core/messages/chat.py` & `langchain_core-0.2.0rc1/langchain_core/messages/chat.py`

 * *Files 16% similar despite different names*

```diff
@@ -1,18 +1,19 @@
 from typing import Any, List, Literal
 
 from langchain_core.messages.base import (
     BaseMessage,
     BaseMessageChunk,
     merge_content,
 )
+from langchain_core.utils._merge import merge_dicts
 
 
 class ChatMessage(BaseMessage):
-    """A Message that can be assigned an arbitrary speaker (i.e. role)."""
+    """Message that can be assigned an arbitrary speaker (i.e. role)."""
 
     role: str
     """The speaker / role of the Message."""
 
     type: Literal["chat"] = "chat"
 
     @classmethod
@@ -21,15 +22,15 @@
         return ["langchain", "schema", "messages"]
 
 
 ChatMessage.update_forward_refs()
 
 
 class ChatMessageChunk(ChatMessage, BaseMessageChunk):
-    """A Chat Message chunk."""
+    """Chat Message chunk."""
 
     # Ignoring mypy re-assignment here since we're overriding the value
     # to make sure that the chunk variant can be discriminated from the
     # non-chunk variant.
     type: Literal["ChatMessageChunk"] = "ChatMessageChunk"  # type: ignore
 
     @classmethod
@@ -43,21 +44,29 @@
                 raise ValueError(
                     "Cannot concatenate ChatMessageChunks with different roles."
                 )
 
             return self.__class__(
                 role=self.role,
                 content=merge_content(self.content, other.content),
-                additional_kwargs=self._merge_kwargs_dict(
+                additional_kwargs=merge_dicts(
                     self.additional_kwargs, other.additional_kwargs
                 ),
+                response_metadata=merge_dicts(
+                    self.response_metadata, other.response_metadata
+                ),
+                id=self.id,
             )
         elif isinstance(other, BaseMessageChunk):
             return self.__class__(
                 role=self.role,
                 content=merge_content(self.content, other.content),
-                additional_kwargs=self._merge_kwargs_dict(
+                additional_kwargs=merge_dicts(
                     self.additional_kwargs, other.additional_kwargs
                 ),
+                response_metadata=merge_dicts(
+                    self.response_metadata, other.response_metadata
+                ),
+                id=self.id,
             )
         else:
             return super().__add__(other)
```

### Comparing `langchain_core-0.1.9/langchain_core/messages/human.py` & `langchain_core-0.2.0rc1/langchain_core/messages/human.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 from typing import List, Literal
 
 from langchain_core.messages.base import BaseMessage, BaseMessageChunk
 
 
 class HumanMessage(BaseMessage):
-    """A Message from a human."""
+    """Message from a human."""
 
     example: bool = False
     """Whether this Message is being passed in to the model as part of an example 
         conversation.
     """
 
     type: Literal["human"] = "human"
@@ -19,15 +19,15 @@
         return ["langchain", "schema", "messages"]
 
 
 HumanMessage.update_forward_refs()
 
 
 class HumanMessageChunk(HumanMessage, BaseMessageChunk):
-    """A Human Message chunk."""
+    """Human Message chunk."""
 
     # Ignoring mypy re-assignment here since we're overriding the value
     # to make sure that the chunk variant can be discriminated from the
     # non-chunk variant.
     type: Literal["HumanMessageChunk"] = "HumanMessageChunk"  # type: ignore[assignment] # noqa: E501
 
     @classmethod
```

### Comparing `langchain_core-0.1.9/langchain_core/messages/system.py` & `langchain_core-0.2.0rc1/langchain_core/messages/system.py`

 * *Files 10% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 from typing import List, Literal
 
 from langchain_core.messages.base import BaseMessage, BaseMessageChunk
 
 
 class SystemMessage(BaseMessage):
-    """A Message for priming AI behavior, usually passed in as the first of a sequence
+    """Message for priming AI behavior, usually passed in as the first of a sequence
     of input messages.
     """
 
     type: Literal["system"] = "system"
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
@@ -16,15 +16,15 @@
         return ["langchain", "schema", "messages"]
 
 
 SystemMessage.update_forward_refs()
 
 
 class SystemMessageChunk(SystemMessage, BaseMessageChunk):
-    """A System Message chunk."""
+    """System Message chunk."""
 
     # Ignoring mypy re-assignment here since we're overriding the value
     # to make sure that the chunk variant can be discriminated from the
     # non-chunk variant.
     type: Literal["SystemMessageChunk"] = "SystemMessageChunk"  # type: ignore[assignment] # noqa: E501
 
     @classmethod
```

### Comparing `langchain_core-0.1.9/langchain_core/output_parsers/base.py` & `langchain_core-0.2.0rc1/langchain_core/output_parsers/base.py`

 * *Files 3% similar despite different names*

```diff
@@ -11,23 +11,25 @@
     Type,
     TypeVar,
     Union,
 )
 
 from typing_extensions import get_args
 
+from langchain_core.language_models import LanguageModelOutput
 from langchain_core.messages import AnyMessage, BaseMessage
 from langchain_core.outputs import ChatGeneration, Generation
-from langchain_core.runnables import RunnableConfig, RunnableSerializable
+from langchain_core.runnables import Runnable, RunnableConfig, RunnableSerializable
 from langchain_core.runnables.config import run_in_executor
 
 if TYPE_CHECKING:
     from langchain_core.prompt_values import PromptValue
 
 T = TypeVar("T")
+OutputParserLike = Runnable[LanguageModelOutput, T]
 
 
 class BaseLLMOutputParser(Generic[T], ABC):
     """Abstract base class for parsing the outputs of a model."""
 
     @abstractmethod
     def parse_result(self, result: List[Generation], *, partial: bool = False) -> T:
@@ -53,15 +55,15 @@
         Returns:
             Structured output.
         """
         return await run_in_executor(None, self.parse_result, result)
 
 
 class BaseGenerationOutputParser(
-    BaseLLMOutputParser, RunnableSerializable[Union[str, BaseMessage], T]
+    BaseLLMOutputParser, RunnableSerializable[LanguageModelOutput, T]
 ):
     """Base class to parse the output of an LLM call."""
 
     @property
     def InputType(self) -> Any:
         return Union[str, AnyMessage]
 
@@ -112,15 +114,15 @@
                 input,
                 config,
                 run_type="parser",
             )
 
 
 class BaseOutputParser(
-    BaseLLMOutputParser, RunnableSerializable[Union[str, BaseMessage], T]
+    BaseLLMOutputParser, RunnableSerializable[LanguageModelOutput, T]
 ):
     """Base class to parse the output of an LLM call.
 
     Output parsers help structure language model responses.
 
     Example:
         .. code-block:: python
@@ -135,17 +137,17 @@
                         raise OutputParserException(
                             f"BooleanOutputParser expected output value to either be "
                             f"{self.true_val} or {self.false_val} (case-insensitive). "
                             f"Received {cleaned_text}."
                         )
                     return cleaned_text == self.true_val.upper()
 
-                    @property
-                    def _type(self) -> str:
-                            return "boolean_output_parser"
+                @property
+                def _type(self) -> str:
+                    return "boolean_output_parser"
     """  # noqa: E501
 
     @property
     def InputType(self) -> Any:
         return Union[str, AnyMessage]
 
     @property
```

### Comparing `langchain_core-0.1.9/langchain_core/output_parsers/format_instructions.py` & `langchain_core-0.2.0rc1/langchain_core/output_parsers/format_instructions.py`

 * *Files identical despite different names*

### Comparing `langchain_core-0.1.9/langchain_core/output_parsers/json.py` & `langchain_core-0.2.0rc1/langchain_core/utils/json.py`

 * *Files 19% similar despite different names*

```diff
@@ -1,21 +1,14 @@
 from __future__ import annotations
 
 import json
 import re
-from json import JSONDecodeError
-from typing import Any, Callable, List, Optional, Type
-
-import jsonpatch  # type: ignore[import]
+from typing import Any, Callable, List
 
 from langchain_core.exceptions import OutputParserException
-from langchain_core.output_parsers.format_instructions import JSON_FORMAT_INSTRUCTIONS
-from langchain_core.output_parsers.transform import BaseCumulativeTransformOutputParser
-from langchain_core.outputs import Generation
-from langchain_core.pydantic_v1 import BaseModel
 
 
 def _replace_new_line(match: re.Match[str]) -> str:
     value = match.group(2)
     value = re.sub(r"\n", r"\\n", value)
     value = re.sub(r"\r", r"\\r", value)
     value = re.sub(r"\t", r"\\t", value)
@@ -31,25 +24,27 @@
     replaces those characters with their escaped counterparts.
     (newlines in JSON must be double-escaped: `\\n`)
     """
     if isinstance(multiline_string, (bytes, bytearray)):
         multiline_string = multiline_string.decode()
 
     multiline_string = re.sub(
-        r'("action_input"\:\s*")(.*)(")',
+        r'("action_input"\:\s*")(.*?)(")',
         _replace_new_line,
         multiline_string,
         flags=re.DOTALL,
     )
 
     return multiline_string
 
 
-# Adapted from https://github.com/KillianLucas/open-interpreter/blob/main/interpreter/utils/parse_partial_json.py
+# Adapted from https://github.com/KillianLucas/open-interpreter/blob/5b6080fae1f8c68938a1e4fa8667e3744084ee21/interpreter/utils/parse_partial_json.py
 # MIT License
+
+
 def parse_partial_json(s: str, *, strict: bool = False) -> Any:
     """Parse a JSON string that may be missing closing braces.
 
     Args:
         s: The JSON string to parse.
         strict: Whether to use strict parsing. Defaults to False.
 
@@ -133,34 +128,40 @@
 
     Args:
         json_string: The Markdown string.
 
     Returns:
         The parsed JSON object as a Python dictionary.
     """
-    # Try to find JSON string within triple backticks
-    match = re.search(r"```(json)?(.*)```", json_string, re.DOTALL)
+    try:
+        return _parse_json(json_string, parser=parser)
+    except json.JSONDecodeError:
+        # Try to find JSON string within triple backticks
+        match = re.search(r"```(json)?(.*)", json_string, re.DOTALL)
 
-    # If no match found, assume the entire string is a JSON string
-    if match is None:
-        json_str = json_string
-    else:
-        # If match found, use the content within the backticks
-        json_str = match.group(2)
+        # If no match found, assume the entire string is a JSON string
+        if match is None:
+            json_str = json_string
+        else:
+            # If match found, use the content within the backticks
+            json_str = match.group(2)
+    return _parse_json(json_str, parser=parser)
 
+
+def _parse_json(
+    json_str: str, *, parser: Callable[[str], Any] = parse_partial_json
+) -> dict:
     # Strip whitespace and newlines from the start and end
-    json_str = json_str.strip()
+    json_str = json_str.strip().strip("`")
 
     # handle newlines and other special characters inside the returned value
     json_str = _custom_parser(json_str)
 
     # Parse the JSON string into a Python dictionary
-    parsed = parser(json_str)
-
-    return parsed
+    return parser(json_str)
 
 
 def parse_and_check_json_markdown(text: str, expected_keys: List[str]) -> dict:
     """
     Parse a JSON string from a Markdown string and check that it
     contains the expected keys.
 
@@ -178,64 +179,7 @@
     for key in expected_keys:
         if key not in json_obj:
             raise OutputParserException(
                 f"Got invalid return object. Expected key `{key}` "
                 f"to be present, but got {json_obj}"
             )
     return json_obj
-
-
-class JsonOutputParser(BaseCumulativeTransformOutputParser[Any]):
-    """Parse the output of an LLM call to a JSON object.
-
-    When used in streaming mode, it will yield partial JSON objects containing
-    all the keys that have been returned so far.
-
-    In streaming, if `diff` is set to `True`, yields JSONPatch operations
-    describing the difference between the previous and the current object.
-    """
-
-    pydantic_object: Optional[Type[BaseModel]] = None
-
-    def _diff(self, prev: Optional[Any], next: Any) -> Any:
-        return jsonpatch.make_patch(prev, next).patch
-
-    def parse_result(self, result: List[Generation], *, partial: bool = False) -> Any:
-        text = result[0].text
-        text = text.strip()
-        if partial:
-            try:
-                return parse_json_markdown(text)
-            except JSONDecodeError:
-                return None
-        else:
-            try:
-                return parse_json_markdown(text)
-            except JSONDecodeError as e:
-                raise OutputParserException(f"Invalid json output: {text}") from e
-
-    def parse(self, text: str) -> Any:
-        return self.parse_result([Generation(text=text)])
-
-    def get_format_instructions(self) -> str:
-        if self.pydantic_object is None:
-            return "Return a JSON object."
-        else:
-            schema = self.pydantic_object.schema()
-
-            # Remove extraneous fields.
-            reduced_schema = schema
-            if "title" in reduced_schema:
-                del reduced_schema["title"]
-            if "type" in reduced_schema:
-                del reduced_schema["type"]
-            # Ensure json in context is well-formed with double quotes.
-            schema_str = json.dumps(reduced_schema)
-            return JSON_FORMAT_INSTRUCTIONS.format(schema=schema_str)
-
-    @property
-    def _type(self) -> str:
-        return "simple_json_output_parser"
-
-
-# For backwards compatibility
-SimpleJsonOutputParser = JsonOutputParser
```

### Comparing `langchain_core-0.1.9/langchain_core/output_parsers/list.py` & `langchain_core-0.2.0rc1/langchain_core/output_parsers/list.py`

 * *Files 2% similar despite different names*

```diff
@@ -111,20 +111,20 @@
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "output_parsers", "list"]
 
     def get_format_instructions(self) -> str:
         return (
             "Your response should be a list of comma separated values, "
-            "eg: `foo, bar, baz`"
+            "eg: `foo, bar, baz` or `foo,bar,baz`"
         )
 
     def parse(self, text: str) -> List[str]:
         """Parse the output of an LLM call."""
-        return text.strip().split(", ")
+        return [part.strip() for part in text.split(",")]
 
     @property
     def _type(self) -> str:
         return "comma-separated-list"
 
 
 class NumberedListOutputParser(ListOutputParser):
```

### Comparing `langchain_core-0.1.9/langchain_core/output_parsers/string.py` & `langchain_core-0.2.0rc1/langchain_core/output_parsers/string.py`

 * *Files identical despite different names*

### Comparing `langchain_core-0.1.9/langchain_core/output_parsers/transform.py` & `langchain_core-0.2.0rc1/langchain_core/output_parsers/transform.py`

 * *Files identical despite different names*

### Comparing `langchain_core-0.1.9/langchain_core/outputs/chat_generation.py` & `langchain_core-0.2.0rc1/langchain_core/outputs/chat_generation.py`

 * *Files 19% similar despite different names*

```diff
@@ -1,14 +1,15 @@
 from __future__ import annotations
 
 from typing import Any, Dict, List, Literal
 
 from langchain_core.messages import BaseMessage, BaseMessageChunk
 from langchain_core.outputs.generation import Generation
 from langchain_core.pydantic_v1 import root_validator
+from langchain_core.utils._merge import merge_dicts
 
 
 class ChatGeneration(Generation):
     """A single chat generation output."""
 
     text: str = ""
     """*SHOULD NOT BE SET DIRECTLY* The text contents of the output message."""
@@ -18,27 +19,44 @@
     type: Literal["ChatGeneration"] = "ChatGeneration"  # type: ignore[assignment]
     """Type is used exclusively for serialization purposes."""
 
     @root_validator
     def set_text(cls, values: Dict[str, Any]) -> Dict[str, Any]:
         """Set the text attribute to be the contents of the message."""
         try:
-            values["text"] = values["message"].content
+            text = ""
+            if isinstance(values["message"].content, str):
+                text = values["message"].content
+            # HACK: Assumes text in content blocks in OpenAI format.
+            # Uses first text block.
+            elif isinstance(values["message"].content, list):
+                for block in values["message"].content:
+                    if isinstance(block, str):
+                        text = block
+                        break
+                    elif isinstance(block, dict) and "text" in block:
+                        text = block["text"]
+                        break
+                    else:
+                        pass
+            else:
+                pass
+            values["text"] = text
         except (KeyError, AttributeError) as e:
             raise ValueError("Error while initializing ChatGeneration") from e
         return values
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "output"]
 
 
 class ChatGenerationChunk(ChatGeneration):
-    """A ChatGeneration chunk, which can be concatenated with other
+    """ChatGeneration chunk, which can be concatenated with other
       ChatGeneration chunks.
 
     Attributes:
         message: The message chunk output by the chat model.
     """
 
     message: BaseMessageChunk
@@ -49,20 +67,19 @@
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "output"]
 
     def __add__(self, other: ChatGenerationChunk) -> ChatGenerationChunk:
         if isinstance(other, ChatGenerationChunk):
-            generation_info = (
-                {**(self.generation_info or {}), **(other.generation_info or {})}
-                if self.generation_info is not None or other.generation_info is not None
-                else None
+            generation_info = merge_dicts(
+                self.generation_info or {},
+                other.generation_info or {},
             )
             return ChatGenerationChunk(
                 message=self.message + other.message,
-                generation_info=generation_info,
+                generation_info=generation_info or None,
             )
         else:
             raise TypeError(
                 f"unsupported operand type(s) for +: '{type(self)}' and '{type(other)}'"
             )
```

### Comparing `langchain_core-0.1.9/langchain_core/outputs/generation.py` & `langchain_core-0.2.0rc1/langchain_core/outputs/generation.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,12 +1,13 @@
 from __future__ import annotations
 
 from typing import Any, Dict, List, Literal, Optional
 
 from langchain_core.load import Serializable
+from langchain_core.utils._merge import merge_dicts
 
 
 class Generation(Serializable):
     """A single text generation output."""
 
     text: str
     """Generated text output."""
@@ -27,29 +28,28 @@
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "output"]
 
 
 class GenerationChunk(Generation):
-    """A Generation chunk, which can be concatenated with other Generation chunks."""
+    """Generation chunk, which can be concatenated with other Generation chunks."""
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "output"]
 
     def __add__(self, other: GenerationChunk) -> GenerationChunk:
         if isinstance(other, GenerationChunk):
-            generation_info = (
-                {**(self.generation_info or {}), **(other.generation_info or {})}
-                if self.generation_info is not None or other.generation_info is not None
-                else None
+            generation_info = merge_dicts(
+                self.generation_info or {},
+                other.generation_info or {},
             )
             return GenerationChunk(
                 text=self.text + other.text,
-                generation_info=generation_info,
+                generation_info=generation_info or None,
             )
         else:
             raise TypeError(
                 f"unsupported operand type(s) for +: '{type(self)}' and '{type(other)}'"
             )
```

### Comparing `langchain_core-0.1.9/langchain_core/outputs/llm_result.py` & `langchain_core-0.2.0rc1/langchain_core/outputs/llm_result.py`

 * *Files identical despite different names*

### Comparing `langchain_core-0.1.9/langchain_core/prompt_values.py` & `langchain_core-0.2.0rc1/langchain_core/prompt_values.py`

 * *Files 27% similar despite different names*

```diff
@@ -1,11 +1,18 @@
+"""**Prompt values** for language model prompts.
+
+Prompt values are used to represent different pieces of prompts.
+They can be used to represent text, images, or chat message pieces.
+"""
 from __future__ import annotations
 
 from abc import ABC, abstractmethod
-from typing import List, Literal, Sequence
+from typing import List, Literal, Sequence, cast
+
+from typing_extensions import TypedDict
 
 from langchain_core.load.serializable import Serializable
 from langchain_core.messages import (
     AnyMessage,
     BaseMessage,
     HumanMessage,
     get_buffer_string,
@@ -78,14 +85,40 @@
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "prompts", "chat"]
 
 
+class ImageURL(TypedDict, total=False):
+    """Image URL."""
+
+    detail: Literal["auto", "low", "high"]
+    """Specifies the detail level of the image."""
+
+    url: str
+    """Either a URL of the image or the base64 encoded image data."""
+
+
+class ImagePromptValue(PromptValue):
+    """Image prompt value."""
+
+    image_url: ImageURL
+    """Prompt image."""
+    type: Literal["ImagePromptValue"] = "ImagePromptValue"
+
+    def to_string(self) -> str:
+        """Return prompt as string."""
+        return self.image_url["url"]
+
+    def to_messages(self) -> List[BaseMessage]:
+        """Return prompt as messages."""
+        return [HumanMessage(content=[cast(dict, self.image_url)])]
+
+
 class ChatPromptValueConcrete(ChatPromptValue):
     """Chat prompt value which explicitly lists out the message types it accepts.
     For use in external schemas."""
 
     messages: Sequence[AnyMessage]
 
     type: Literal["ChatPromptValueConcrete"] = "ChatPromptValueConcrete"
```

### Comparing `langchain_core-0.1.9/langchain_core/prompts/__init__.py` & `langchain_core-0.2.0rc1/langchain_core/prompts/__init__.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,11 +1,11 @@
 """**Prompt** is the input to the model.
 
 Prompt is often constructed
-from multiple components. Prompt classes and functions make constructing
+from multiple components and prompt values. Prompt classes and functions make constructing
  and working with prompts easy.
 
 **Class hierarchy:**
 
 .. code-block::
 
     BasePromptTemplate --> PipelinePromptTemplate
@@ -20,15 +20,19 @@
     BaseMessagePromptTemplate --> MessagesPlaceholder
                                   BaseStringMessagePromptTemplate --> ChatMessagePromptTemplate
                                                                       HumanMessagePromptTemplate
                                                                       AIMessagePromptTemplate
                                                                       SystemMessagePromptTemplate
 
 """  # noqa: E501
-from langchain_core.prompts.base import BasePromptTemplate, format_document
+from langchain_core.prompts.base import (
+    BasePromptTemplate,
+    aformat_document,
+    format_document,
+)
 from langchain_core.prompts.chat import (
     AIMessagePromptTemplate,
     BaseChatPromptTemplate,
     ChatMessagePromptTemplate,
     ChatPromptTemplate,
     HumanMessagePromptTemplate,
     MessagesPlaceholder,
@@ -63,12 +67,13 @@
     "MessagesPlaceholder",
     "PipelinePromptTemplate",
     "PromptTemplate",
     "StringPromptTemplate",
     "SystemMessagePromptTemplate",
     "load_prompt",
     "format_document",
+    "aformat_document",
     "check_valid_template",
     "get_template_variables",
     "jinja2_formatter",
     "validate_jinja2",
 ]
```

### Comparing `langchain_core-0.1.9/langchain_core/prompts/few_shot.py` & `langchain_core-0.2.0rc1/langchain_core/prompts/few_shot.py`

 * *Files 14% similar despite different names*

```diff
@@ -1,13 +1,15 @@
 """Prompt template that contains few shot examples."""
+
 from __future__ import annotations
 
 from pathlib import Path
 from typing import Any, Dict, List, Literal, Optional, Union
 
+from langchain_core.example_selectors import BaseExampleSelector
 from langchain_core.messages import BaseMessage, get_buffer_string
 from langchain_core.prompts.chat import (
     BaseChatPromptTemplate,
     BaseMessagePromptTemplate,
 )
 from langchain_core.prompts.prompt import PromptTemplate
 from langchain_core.prompts.string import (
@@ -22,15 +24,15 @@
 class _FewShotPromptTemplateMixin(BaseModel):
     """Prompt template that contains few shot examples."""
 
     examples: Optional[List[dict]] = None
     """Examples to format into the prompt.
     Either this or example_selector should be provided."""
 
-    example_selector: Any = None
+    example_selector: Optional[BaseExampleSelector] = None
     """ExampleSelector to choose the examples to format into the prompt.
     Either this or examples should be provided."""
 
     class Config:
         """Configuration for this pydantic object."""
 
         extra = Extra.forbid
@@ -67,14 +69,32 @@
         elif self.example_selector is not None:
             return self.example_selector.select_examples(kwargs)
         else:
             raise ValueError(
                 "One of 'examples' and 'example_selector' should be provided"
             )
 
+    async def _aget_examples(self, **kwargs: Any) -> List[dict]:
+        """Get the examples to use for formatting the prompt.
+
+        Args:
+            **kwargs: Keyword arguments to be passed to the example selector.
+
+        Returns:
+            List of examples.
+        """
+        if self.examples is not None:
+            return self.examples
+        elif self.example_selector is not None:
+            return await self.example_selector.aselect_examples(kwargs)
+        else:
+            raise ValueError(
+                "One of 'examples' and 'example_selector' should be provided"
+            )
+
 
 class FewShotPromptTemplate(_FewShotPromptTemplateMixin, StringPromptTemplate):
     """Prompt template that contains few shot examples."""
 
     @classmethod
     def is_lc_serializable(cls) -> bool:
         """Return whether or not the class is serializable."""
@@ -123,28 +143,14 @@
     class Config:
         """Configuration for this pydantic object."""
 
         extra = Extra.forbid
         arbitrary_types_allowed = True
 
     def format(self, **kwargs: Any) -> str:
-        """Format the prompt with the inputs.
-
-        Args:
-            **kwargs: Any arguments to be passed to the prompt template.
-
-        Returns:
-            A formatted string.
-
-        Example:
-
-        .. code-block:: python
-
-            prompt.format(variable1="foo")
-        """
         kwargs = self._merge_partial_and_user_variables(**kwargs)
         # Get the examples to use.
         examples = self._get_examples(**kwargs)
         examples = [
             {k: e[k] for k in self.example_prompt.input_variables} for e in examples
         ]
         # Format the examples.
@@ -154,14 +160,32 @@
         # Create the overall template.
         pieces = [self.prefix, *example_strings, self.suffix]
         template = self.example_separator.join([piece for piece in pieces if piece])
 
         # Format the template with the input variables.
         return DEFAULT_FORMATTER_MAPPING[self.template_format](template, **kwargs)
 
+    async def aformat(self, **kwargs: Any) -> str:
+        kwargs = self._merge_partial_and_user_variables(**kwargs)
+        # Get the examples to use.
+        examples = await self._aget_examples(**kwargs)
+        examples = [
+            {k: e[k] for k in self.example_prompt.input_variables} for e in examples
+        ]
+        # Format the examples.
+        example_strings = [
+            await self.example_prompt.aformat(**example) for example in examples
+        ]
+        # Create the overall template.
+        pieces = [self.prefix, *example_strings, self.suffix]
+        template = self.example_separator.join([piece for piece in pieces if piece])
+
+        # Format the template with the input variables.
+        return DEFAULT_FORMATTER_MAPPING[self.template_format](template, **kwargs)
+
     @property
     def _prompt_type(self) -> str:
         """Return the prompt type key."""
         return "few_shot"
 
     def save(self, file_path: Union[Path, str]) -> None:
         if self.example_selector:
@@ -273,15 +297,15 @@
                 SystemMessagePromptTemplate.from_template(
                     "You are a helpful AI Assistant"
                 )
                 + few_shot_prompt
                 + HumanMessagePromptTemplate.from_template("{input}")
             )
             # Show the prompt
-            print(final_prompt.format_messages(input="What's 3+3?"))
+            print(final_prompt.format_messages(input="What's 3+3?"))  # noqa: T201
 
             # Use within an LLM
             from langchain_core.chat_models import ChatAnthropic
             chain = final_prompt | ChatAnthropic()
             chain.invoke({"input": "What's 3+3?"})
     """
 
@@ -320,14 +344,36 @@
         messages = [
             message
             for example in examples
             for message in self.example_prompt.format_messages(**example)
         ]
         return messages
 
+    async def aformat_messages(self, **kwargs: Any) -> List[BaseMessage]:
+        """Format kwargs into a list of messages.
+
+        Args:
+            **kwargs: keyword arguments to use for filling in templates in messages.
+
+        Returns:
+            A list of formatted messages with all template variables filled in.
+        """
+        # Get the examples to use.
+        examples = await self._aget_examples(**kwargs)
+        examples = [
+            {k: e[k] for k in self.example_prompt.input_variables} for e in examples
+        ]
+        # Format the examples.
+        messages = [
+            message
+            for example in examples
+            for message in await self.example_prompt.aformat_messages(**example)
+        ]
+        return messages
+
     def format(self, **kwargs: Any) -> str:
         """Format the prompt with inputs generating a string.
 
         Use this method to generate a string representation of a prompt consisting
         of chat messages.
 
         Useful for feeding into a string based completion language model or debugging.
@@ -336,7 +382,14 @@
             **kwargs: keyword arguments to use for formatting.
 
         Returns:
             A string representation of the prompt
         """
         messages = self.format_messages(**kwargs)
         return get_buffer_string(messages)
+
+    async def aformat(self, **kwargs: Any) -> str:
+        messages = await self.aformat_messages(**kwargs)
+        return get_buffer_string(messages)
+
+    def pretty_repr(self, html: bool = False) -> str:
+        raise NotImplementedError()
```

### Comparing `langchain_core-0.1.9/langchain_core/prompts/loading.py` & `langchain_core-0.2.0rc1/langchain_core/prompts/loading.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,21 +1,21 @@
 """Load prompts."""
+
 import json
 import logging
 from pathlib import Path
 from typing import Callable, Dict, Union
 
 import yaml
 
 from langchain_core.output_parsers.string import StrOutputParser
 from langchain_core.prompts.base import BasePromptTemplate
 from langchain_core.prompts.chat import ChatPromptTemplate
 from langchain_core.prompts.few_shot import FewShotPromptTemplate
 from langchain_core.prompts.prompt import PromptTemplate
-from langchain_core.utils import try_load_from_hub
 
 URL_BASE = "https://raw.githubusercontent.com/hwchase17/langchain-hub/master/prompts/"
 logger = logging.getLogger(__name__)
 
 
 def load_prompt_from_config(config: dict) -> BasePromptTemplate:
     """Load prompt from Config Dict."""
@@ -123,34 +123,35 @@
         )
 
     return PromptTemplate(**config)
 
 
 def load_prompt(path: Union[str, Path]) -> BasePromptTemplate:
     """Unified method for loading a prompt from LangChainHub or local fs."""
-    if hub_result := try_load_from_hub(
-        path, _load_prompt_from_file, "prompts", {"py", "json", "yaml"}
-    ):
-        return hub_result
-    else:
-        return _load_prompt_from_file(path)
+    if isinstance(path, str) and path.startswith("lc://"):
+        raise RuntimeError(
+            "Loading from the deprecated github-based Hub is no longer supported. "
+            "Please use the new LangChain Hub at https://smith.langchain.com/hub "
+            "instead."
+        )
+    return _load_prompt_from_file(path)
 
 
 def _load_prompt_from_file(file: Union[str, Path]) -> BasePromptTemplate:
     """Load prompt from file."""
     # Convert file to a Path object.
     if isinstance(file, str):
         file_path = Path(file)
     else:
         file_path = file
     # Load from either json or yaml.
     if file_path.suffix == ".json":
         with open(file_path) as f:
             config = json.load(f)
-    elif file_path.suffix == ".yaml":
+    elif file_path.suffix.endswith((".yaml", ".yml")):
         with open(file_path, "r") as f:
             config = yaml.safe_load(f)
     else:
         raise ValueError(f"Got unsupported file type {file_path.suffix}")
     # Load the prompt from the config now.
     return load_prompt_from_config(config)
```

### Comparing `langchain_core-0.1.9/langchain_core/prompts/pipeline.py` & `langchain_core-0.2.0rc1/langchain_core/prompts/pipeline.py`

 * *Files 14% similar despite different names*

```diff
@@ -7,15 +7,15 @@
 
 
 def _get_inputs(inputs: dict, input_variables: List[str]) -> dict:
     return {k: inputs[k] for k in input_variables}
 
 
 class PipelinePromptTemplate(BasePromptTemplate):
-    """A prompt template for composing multiple prompt templates together.
+    """Prompt template for composing multiple prompt templates together.
 
     This can be useful when you want to reuse parts of prompts.
     A PipelinePrompt consists of two main parts:
         - final_prompt: This is the final prompt that is returned
         - pipeline_prompts: This is a list of tuples, consisting
             of a string (`name`) and a Prompt Template.
             Each PromptTemplate will be formatted and then passed
@@ -50,13 +50,26 @@
             if isinstance(prompt, BaseChatPromptTemplate):
                 kwargs[k] = prompt.format_messages(**_inputs)
             else:
                 kwargs[k] = prompt.format(**_inputs)
         _inputs = _get_inputs(kwargs, self.final_prompt.input_variables)
         return self.final_prompt.format_prompt(**_inputs)
 
+    async def aformat_prompt(self, **kwargs: Any) -> PromptValue:
+        for k, prompt in self.pipeline_prompts:
+            _inputs = _get_inputs(kwargs, prompt.input_variables)
+            if isinstance(prompt, BaseChatPromptTemplate):
+                kwargs[k] = await prompt.aformat_messages(**_inputs)
+            else:
+                kwargs[k] = await prompt.aformat(**_inputs)
+        _inputs = _get_inputs(kwargs, self.final_prompt.input_variables)
+        return await self.final_prompt.aformat_prompt(**_inputs)
+
     def format(self, **kwargs: Any) -> str:
         return self.format_prompt(**kwargs).to_string()
 
+    async def aformat(self, **kwargs: Any) -> str:
+        return (await self.aformat_prompt(**kwargs)).to_string()
+
     @property
     def _prompt_type(self) -> str:
         raise ValueError
```

### Comparing `langchain_core-0.1.9/langchain_core/prompts/prompt.py` & `langchain_core-0.2.0rc1/langchain_core/prompts/prompt.py`

 * *Files 9% similar despite different names*

```diff
@@ -6,20 +6,22 @@
 from typing import Any, Dict, List, Literal, Optional, Union
 
 from langchain_core.prompts.string import (
     DEFAULT_FORMATTER_MAPPING,
     StringPromptTemplate,
     check_valid_template,
     get_template_variables,
+    mustache_schema,
 )
-from langchain_core.pydantic_v1 import root_validator
+from langchain_core.pydantic_v1 import BaseModel, root_validator
+from langchain_core.runnables.config import RunnableConfig
 
 
 class PromptTemplate(StringPromptTemplate):
-    """A prompt template for a language model.
+    """Prompt template for a language model.
 
     A prompt template consists of a string template. It accepts a set of parameters
     from the user that can be used to generate a prompt for a language model.
 
     The template can be formatted using either f-strings (default) or jinja2 syntax.
 
     *Security warning*: Prefer using `template_format="f-string"` instead of
@@ -61,20 +63,27 @@
 
     input_variables: List[str]
     """A list of the names of the variables the prompt template expects."""
 
     template: str
     """The prompt template."""
 
-    template_format: Literal["f-string", "jinja2"] = "f-string"
-    """The format of the prompt template. Options are: 'f-string', 'jinja2'."""
+    template_format: Literal["f-string", "mustache", "jinja2"] = "f-string"
+    """The format of the prompt template.
+    Options are: 'f-string', 'mustache', 'jinja2'."""
 
     validate_template: bool = False
     """Whether or not to try validating the template."""
 
+    def get_input_schema(self, config: RunnableConfig | None = None) -> type[BaseModel]:
+        if self.template_format != "mustache":
+            return super().get_input_schema(config)
+
+        return mustache_schema(self.template)
+
     def __add__(self, other: Any) -> PromptTemplate:
         """Override the + operator to allow for combining prompt templates."""
         # Allow for easy combining
         if isinstance(other, PromptTemplate):
             if self.template_format != "f-string":
                 raise ValueError(
                     "Adding prompt templates only supported for f-strings."
@@ -110,35 +119,23 @@
 
     @property
     def _prompt_type(self) -> str:
         """Return the prompt type key."""
         return "prompt"
 
     def format(self, **kwargs: Any) -> str:
-        """Format the prompt with the inputs.
-
-        Args:
-            kwargs: Any arguments to be passed to the prompt template.
-
-        Returns:
-            A formatted string.
-
-        Example:
-
-            .. code-block:: python
-
-                prompt.format(variable1="foo")
-        """
         kwargs = self._merge_partial_and_user_variables(**kwargs)
         return DEFAULT_FORMATTER_MAPPING[self.template_format](self.template, **kwargs)
 
     @root_validator()
     def template_is_valid(cls, values: Dict) -> Dict:
         """Check that template and input variables are consistent."""
         if values["validate_template"]:
+            if values["template_format"] == "mustache":
+                raise ValueError("Mustache templates cannot be validated.")
             all_inputs = values["input_variables"] + list(values["partial_variables"])
             check_valid_template(
                 values["template"], values["template_format"], all_inputs
             )
         elif values.get("template_format"):
             values["input_variables"] = [
                 var
@@ -251,11 +248,11 @@
             input_variables = [
                 var for var in input_variables if var not in _partial_variables
             ]
 
         return cls(
             input_variables=input_variables,
             template=template,
-            template_format=template_format,
+            template_format=template_format,  # type: ignore[arg-type]
             partial_variables=_partial_variables,
             **kwargs,
         )
```

### Comparing `langchain_core-0.1.9/langchain_core/pydantic_v1/__init__.py` & `langchain_core-0.2.0rc1/langchain_core/pydantic_v1/__init__.py`

 * *Files identical despite different names*

### Comparing `langchain_core-0.1.9/langchain_core/runnables/__init__.py` & `langchain_core-0.2.0rc1/langchain_core/runnables/__init__.py`

 * *Files 2% similar despite different names*

```diff
@@ -5,15 +5,17 @@
 
 Programs created using LCEL and LangChain Runnables inherently support
 synchronous, asynchronous, batch, and streaming operations.
 
 Support for **async** allows servers hosting LCEL based programs to scale better
 for higher concurrent loads.
 
-**Streaming** of intermediate outputs as they're being generated allows for
+**Batch** operations allow for processing multiple inputs in parallel.
+
+**Streaming** of intermediate outputs, as they're being generated, allows for
 creating more responsive UX.
 
 This module contains schema and implementation of LangChain Runnables primitives.
 """
 from langchain_core.runnables.base import (
     Runnable,
     RunnableBinding,
```

### Comparing `langchain_core-0.1.9/langchain_core/runnables/base.py` & `langchain_core-0.2.0rc1/langchain_core/runnables/base.py`

 * *Files 14% similar despite different names*

```diff
@@ -8,8982 +8,11712 @@
 00000070: 6d70 6f72 7420 4142 432c 2061 6273 7472  mport ABC, abstr
 00000080: 6163 746d 6574 686f 640a 6672 6f6d 2063  actmethod.from c
 00000090: 6f6e 6375 7272 656e 742e 6675 7475 7265  oncurrent.future
 000000a0: 7320 696d 706f 7274 2046 4952 5354 5f43  s import FIRST_C
 000000b0: 4f4d 504c 4554 4544 2c20 7761 6974 0a66  OMPLETED, wait.f
 000000c0: 726f 6d20 636f 6e74 6578 7476 6172 7320  rom contextvars 
 000000d0: 696d 706f 7274 2063 6f70 795f 636f 6e74  import copy_cont
-000000e0: 6578 740a 6672 6f6d 2063 6f70 7920 696d  ext.from copy im
-000000f0: 706f 7274 2064 6565 7063 6f70 790a 6672  port deepcopy.fr
-00000100: 6f6d 2066 756e 6374 6f6f 6c73 2069 6d70  om functools imp
-00000110: 6f72 7420 7772 6170 730a 6672 6f6d 2069  ort wraps.from i
-00000120: 7465 7274 6f6f 6c73 2069 6d70 6f72 7420  tertools import 
-00000130: 6772 6f75 7062 792c 2074 6565 0a66 726f  groupby, tee.fro
-00000140: 6d20 6f70 6572 6174 6f72 2069 6d70 6f72  m operator impor
-00000150: 7420 6974 656d 6765 7474 6572 0a66 726f  t itemgetter.fro
-00000160: 6d20 7479 7069 6e67 2069 6d70 6f72 7420  m typing import 
-00000170: 280a 2020 2020 5459 5045 5f43 4845 434b  (.    TYPE_CHECK
-00000180: 494e 472c 0a20 2020 2041 6e79 2c0a 2020  ING,.    Any,.  
-00000190: 2020 4173 796e 6349 7465 7261 746f 722c    AsyncIterator,
-000001a0: 0a20 2020 2041 7761 6974 6162 6c65 2c0a  .    Awaitable,.
-000001b0: 2020 2020 4361 6c6c 6162 6c65 2c0a 2020      Callable,.  
-000001c0: 2020 436f 726f 7574 696e 652c 0a20 2020    Coroutine,.   
-000001d0: 2044 6963 742c 0a20 2020 2047 656e 6572   Dict,.    Gener
-000001e0: 6963 2c0a 2020 2020 4974 6572 6174 6f72  ic,.    Iterator
-000001f0: 2c0a 2020 2020 4c69 7374 2c0a 2020 2020  ,.    List,.    
-00000200: 4d61 7070 696e 672c 0a20 2020 204f 7074  Mapping,.    Opt
-00000210: 696f 6e61 6c2c 0a20 2020 2053 6571 7565  ional,.    Seque
-00000220: 6e63 652c 0a20 2020 2053 6574 2c0a 2020  nce,.    Set,.  
-00000230: 2020 5475 706c 652c 0a20 2020 2054 7970    Tuple,.    Typ
-00000240: 652c 0a20 2020 2054 7970 6556 6172 2c0a  e,.    TypeVar,.
-00000250: 2020 2020 556e 696f 6e2c 0a20 2020 2063      Union,.    c
-00000260: 6173 742c 0a20 2020 206f 7665 726c 6f61  ast,.    overloa
-00000270: 642c 0a29 0a0a 6672 6f6d 2074 7970 696e  d,.)..from typin
-00000280: 675f 6578 7465 6e73 696f 6e73 2069 6d70  g_extensions imp
-00000290: 6f72 7420 4c69 7465 7261 6c2c 2067 6574  ort Literal, get
-000002a0: 5f61 7267 730a 0a66 726f 6d20 6c61 6e67  _args..from lang
-000002b0: 6368 6169 6e5f 636f 7265 2e6c 6f61 642e  chain_core.load.
-000002c0: 6475 6d70 2069 6d70 6f72 7420 6475 6d70  dump import dump
-000002d0: 642c 2064 756d 7073 0a66 726f 6d20 6c61  d, dumps.from la
-000002e0: 6e67 6368 6169 6e5f 636f 7265 2e6c 6f61  ngchain_core.loa
-000002f0: 642e 7365 7269 616c 697a 6162 6c65 2069  d.serializable i
-00000300: 6d70 6f72 7420 5365 7269 616c 697a 6162  mport Serializab
-00000310: 6c65 0a66 726f 6d20 6c61 6e67 6368 6169  le.from langchai
-00000320: 6e5f 636f 7265 2e70 7964 616e 7469 635f  n_core.pydantic_
-00000330: 7631 2069 6d70 6f72 7420 4261 7365 436f  v1 import BaseCo
-00000340: 6e66 6967 2c20 4261 7365 4d6f 6465 6c2c  nfig, BaseModel,
-00000350: 2046 6965 6c64 2c20 6372 6561 7465 5f6d   Field, create_m
-00000360: 6f64 656c 0a66 726f 6d20 6c61 6e67 6368  odel.from langch
-00000370: 6169 6e5f 636f 7265 2e72 756e 6e61 626c  ain_core.runnabl
-00000380: 6573 2e63 6f6e 6669 6720 696d 706f 7274  es.config import
-00000390: 2028 0a20 2020 2052 756e 6e61 626c 6543   (.    RunnableC
-000003a0: 6f6e 6669 672c 0a20 2020 2061 6361 6c6c  onfig,.    acall
-000003b0: 5f66 756e 635f 7769 7468 5f76 6172 6961  _func_with_varia
-000003c0: 626c 655f 6172 6773 2c0a 2020 2020 6361  ble_args,.    ca
-000003d0: 6c6c 5f66 756e 635f 7769 7468 5f76 6172  ll_func_with_var
-000003e0: 6961 626c 655f 6172 6773 2c0a 2020 2020  iable_args,.    
-000003f0: 656e 7375 7265 5f63 6f6e 6669 672c 0a20  ensure_config,. 
-00000400: 2020 2067 6574 5f61 7379 6e63 5f63 616c     get_async_cal
-00000410: 6c62 6163 6b5f 6d61 6e61 6765 725f 666f  lback_manager_fo
-00000420: 725f 636f 6e66 6967 2c0a 2020 2020 6765  r_config,.    ge
-00000430: 745f 6361 6c6c 6261 636b 5f6d 616e 6167  t_callback_manag
-00000440: 6572 5f66 6f72 5f63 6f6e 6669 672c 0a20  er_for_config,. 
-00000450: 2020 2067 6574 5f63 6f6e 6669 675f 6c69     get_config_li
-00000460: 7374 2c0a 2020 2020 6765 745f 6578 6563  st,.    get_exec
-00000470: 7574 6f72 5f66 6f72 5f63 6f6e 6669 672c  utor_for_config,
-00000480: 0a20 2020 206d 6572 6765 5f63 6f6e 6669  .    merge_confi
-00000490: 6773 2c0a 2020 2020 7061 7463 685f 636f  gs,.    patch_co
-000004a0: 6e66 6967 2c0a 2020 2020 7275 6e5f 696e  nfig,.    run_in
-000004b0: 5f65 7865 6375 746f 722c 0a20 2020 2076  _executor,.    v
-000004c0: 6172 5f63 6869 6c64 5f72 756e 6e61 626c  ar_child_runnabl
-000004d0: 655f 636f 6e66 6967 2c0a 290a 6672 6f6d  e_config,.).from
-000004e0: 206c 616e 6763 6861 696e 5f63 6f72 652e   langchain_core.
-000004f0: 7275 6e6e 6162 6c65 732e 6772 6170 6820  runnables.graph 
-00000500: 696d 706f 7274 2047 7261 7068 0a66 726f  import Graph.fro
-00000510: 6d20 6c61 6e67 6368 6169 6e5f 636f 7265  m langchain_core
-00000520: 2e72 756e 6e61 626c 6573 2e75 7469 6c73  .runnables.utils
-00000530: 2069 6d70 6f72 7420 280a 2020 2020 4164   import (.    Ad
-00000540: 6461 626c 6544 6963 742c 0a20 2020 2041  dableDict,.    A
-00000550: 6e79 436f 6e66 6967 7572 6162 6c65 4669  nyConfigurableFi
-00000560: 656c 642c 0a20 2020 2043 6f6e 6669 6775  eld,.    Configu
-00000570: 7261 626c 6546 6965 6c64 2c0a 2020 2020  rableField,.    
-00000580: 436f 6e66 6967 7572 6162 6c65 4669 656c  ConfigurableFiel
-00000590: 6453 7065 632c 0a20 2020 2049 6e70 7574  dSpec,.    Input
-000005a0: 2c0a 2020 2020 4f75 7470 7574 2c0a 2020  ,.    Output,.  
-000005b0: 2020 6163 6365 7074 735f 636f 6e66 6967    accepts_config
-000005c0: 2c0a 2020 2020 6163 6365 7074 735f 636f  ,.    accepts_co
-000005d0: 6e74 6578 742c 0a20 2020 2061 6363 6570  ntext,.    accep
-000005e0: 7473 5f72 756e 5f6d 616e 6167 6572 2c0a  ts_run_manager,.
-000005f0: 2020 2020 6761 7468 6572 5f77 6974 685f      gather_with_
-00000600: 636f 6e63 7572 7265 6e63 792c 0a20 2020  concurrency,.   
-00000610: 2067 6574 5f66 756e 6374 696f 6e5f 6669   get_function_fi
-00000620: 7273 745f 6172 675f 6469 6374 5f6b 6579  rst_arg_dict_key
-00000630: 732c 0a20 2020 2067 6574 5f66 756e 6374  s,.    get_funct
-00000640: 696f 6e5f 6e6f 6e6c 6f63 616c 732c 0a20  ion_nonlocals,. 
-00000650: 2020 2067 6574 5f6c 616d 6264 615f 736f     get_lambda_so
-00000660: 7572 6365 2c0a 2020 2020 6765 745f 756e  urce,.    get_un
-00000670: 6971 7565 5f63 6f6e 6669 675f 7370 6563  ique_config_spec
-00000680: 732c 0a20 2020 2069 6e64 656e 745f 6c69  s,.    indent_li
-00000690: 6e65 735f 6166 7465 725f 6669 7273 742c  nes_after_first,
-000006a0: 0a29 0a66 726f 6d20 6c61 6e67 6368 6169  .).from langchai
-000006b0: 6e5f 636f 7265 2e75 7469 6c73 2e61 6974  n_core.utils.ait
-000006c0: 6572 2069 6d70 6f72 7420 6174 6565 2c20  er import atee, 
-000006d0: 7079 5f61 6e65 7874 0a66 726f 6d20 6c61  py_anext.from la
-000006e0: 6e67 6368 6169 6e5f 636f 7265 2e75 7469  ngchain_core.uti
-000006f0: 6c73 2e69 7465 7220 696d 706f 7274 2073  ls.iter import s
-00000700: 6166 6574 6565 0a0a 6966 2054 5950 455f  afetee..if TYPE_
-00000710: 4348 4543 4b49 4e47 3a0a 2020 2020 6672  CHECKING:.    fr
-00000720: 6f6d 206c 616e 6763 6861 696e 5f63 6f72  om langchain_cor
-00000730: 652e 6361 6c6c 6261 636b 732e 6d61 6e61  e.callbacks.mana
-00000740: 6765 7220 696d 706f 7274 2028 0a20 2020  ger import (.   
-00000750: 2020 2020 2041 7379 6e63 4361 6c6c 6261       AsyncCallba
-00000760: 636b 4d61 6e61 6765 7246 6f72 4368 6169  ckManagerForChai
-00000770: 6e52 756e 2c0a 2020 2020 2020 2020 4361  nRun,.        Ca
-00000780: 6c6c 6261 636b 4d61 6e61 6765 7246 6f72  llbackManagerFor
-00000790: 4368 6169 6e52 756e 2c0a 2020 2020 290a  ChainRun,.    ).
-000007a0: 2020 2020 6672 6f6d 206c 616e 6763 6861      from langcha
-000007b0: 696e 5f63 6f72 652e 7072 6f6d 7074 732e  in_core.prompts.
-000007c0: 6261 7365 2069 6d70 6f72 7420 4261 7365  base import Base
-000007d0: 5072 6f6d 7074 5465 6d70 6c61 7465 0a20  PromptTemplate. 
-000007e0: 2020 2066 726f 6d20 6c61 6e67 6368 6169     from langchai
-000007f0: 6e5f 636f 7265 2e72 756e 6e61 626c 6573  n_core.runnables
-00000800: 2e66 616c 6c62 6163 6b73 2069 6d70 6f72  .fallbacks impor
-00000810: 7420 280a 2020 2020 2020 2020 5275 6e6e  t (.        Runn
-00000820: 6162 6c65 5769 7468 4661 6c6c 6261 636b  ableWithFallback
-00000830: 7320 6173 2052 756e 6e61 626c 6557 6974  s as RunnableWit
-00000840: 6846 616c 6c62 6163 6b73 542c 0a20 2020  hFallbacksT,.   
-00000850: 2029 0a20 2020 2066 726f 6d20 6c61 6e67   ).    from lang
-00000860: 6368 6169 6e5f 636f 7265 2e74 7261 6365  chain_core.trace
-00000870: 7273 2e6c 6f67 5f73 7472 6561 6d20 696d  rs.log_stream im
-00000880: 706f 7274 2052 756e 4c6f 672c 2052 756e  port RunLog, Run
-00000890: 4c6f 6750 6174 6368 0a20 2020 2066 726f  LogPatch.    fro
-000008a0: 6d20 6c61 6e67 6368 6169 6e5f 636f 7265  m langchain_core
-000008b0: 2e74 7261 6365 7273 2e72 6f6f 745f 6c69  .tracers.root_li
-000008c0: 7374 656e 6572 7320 696d 706f 7274 204c  steners import L
-000008d0: 6973 7465 6e65 720a 0a0a 4f74 6865 7220  istener...Other 
-000008e0: 3d20 5479 7065 5661 7228 224f 7468 6572  = TypeVar("Other
-000008f0: 2229 0a0a 0a63 6c61 7373 205f 5363 6865  ")...class _Sche
-00000900: 6d61 436f 6e66 6967 2842 6173 6543 6f6e  maConfig(BaseCon
-00000910: 6669 6729 3a0a 2020 2020 6172 6269 7472  fig):.    arbitr
-00000920: 6172 795f 7479 7065 735f 616c 6c6f 7765  ary_types_allowe
-00000930: 6420 3d20 5472 7565 0a0a 0a63 6c61 7373  d = True...class
-00000940: 2052 756e 6e61 626c 6528 4765 6e65 7269   Runnable(Generi
-00000950: 635b 496e 7075 742c 204f 7574 7075 745d  c[Input, Output]
-00000960: 2c20 4142 4329 3a0a 2020 2020 2222 2241  , ABC):.    """A
-00000970: 2075 6e69 7420 6f66 2077 6f72 6b20 7468   unit of work th
-00000980: 6174 2063 616e 2062 6520 696e 766f 6b65  at can be invoke
-00000990: 642c 2062 6174 6368 6564 2c20 7374 7265  d, batched, stre
-000009a0: 616d 6564 2c20 7472 616e 7366 6f72 6d65  amed, transforme
-000009b0: 6420 616e 6420 636f 6d70 6f73 6564 2e0a  d and composed..
-000009c0: 0a20 2020 2020 4b65 7920 4d65 7468 6f64  .     Key Method
-000009d0: 730a 2020 2020 203d 3d3d 3d3d 3d3d 3d3d  s.     =========
-000009e0: 3d3d 0a0a 2020 2020 2a20 696e 766f 6b65  ==..    * invoke
-000009f0: 2f61 696e 766f 6b65 3a20 5472 616e 7366  /ainvoke: Transf
-00000a00: 6f72 6d73 2061 2073 696e 676c 6520 696e  orms a single in
-00000a10: 7075 7420 696e 746f 2061 6e20 6f75 7470  put into an outp
-00000a20: 7574 2e0a 2020 2020 2a20 6261 7463 682f  ut..    * batch/
-00000a30: 6162 6174 6368 3a20 4566 6669 6369 656e  abatch: Efficien
-00000a40: 746c 7920 7472 616e 7366 6f72 6d73 206d  tly transforms m
-00000a50: 756c 7469 706c 6520 696e 7075 7473 2069  ultiple inputs i
-00000a60: 6e74 6f20 6f75 7470 7574 732e 0a20 2020  nto outputs..   
-00000a70: 202a 2073 7472 6561 6d2f 6173 7472 6561   * stream/astrea
-00000a80: 6d3a 2053 7472 6561 6d73 206f 7574 7075  m: Streams outpu
-00000a90: 7420 6672 6f6d 2061 2073 696e 676c 6520  t from a single 
-00000aa0: 696e 7075 7420 6173 2069 7427 7320 7072  input as it's pr
-00000ab0: 6f64 7563 6564 2e0a 2020 2020 2a20 6173  oduced..    * as
-00000ac0: 7472 6561 6d5f 6c6f 673a 2053 7472 6561  tream_log: Strea
-00000ad0: 6d73 206f 7574 7075 7420 616e 6420 7365  ms output and se
-00000ae0: 6c65 6374 6564 2069 6e74 6572 6d65 6469  lected intermedi
-00000af0: 6174 6520 7265 7375 6c74 7320 6672 6f6d  ate results from
-00000b00: 2061 6e20 696e 7075 742e 0a0a 2020 2020   an input...    
-00000b10: 4275 696c 742d 696e 206f 7074 696d 697a  Built-in optimiz
-00000b20: 6174 696f 6e73 3a0a 0a20 2020 202a 2042  ations:..    * B
-00000b30: 6174 6368 3a20 4279 2064 6566 6175 6c74  atch: By default
-00000b40: 2c20 6261 7463 6820 7275 6e73 2069 6e76  , batch runs inv
-00000b50: 6f6b 6528 2920 696e 2070 6172 616c 6c65  oke() in paralle
-00000b60: 6c20 7573 696e 6720 6120 7468 7265 6164  l using a thread
-00000b70: 2070 6f6f 6c20 6578 6563 7574 6f72 2e0a   pool executor..
-00000b80: 2020 2020 2020 2020 2020 2020 204f 7665               Ove
-00000b90: 7272 6964 6520 746f 206f 7074 696d 697a  rride to optimiz
-00000ba0: 6520 6261 7463 6869 6e67 2e0a 0a20 2020  e batching...   
-00000bb0: 202a 2041 7379 6e63 3a20 4d65 7468 6f64   * Async: Method
-00000bc0: 7320 7769 7468 2022 6122 2073 7566 6669  s with "a" suffi
-00000bd0: 7820 6172 6520 6173 796e 6368 726f 6e6f  x are asynchrono
-00000be0: 7573 2e20 4279 2064 6566 6175 6c74 2c20  us. By default, 
-00000bf0: 7468 6579 2065 7865 6375 7465 0a20 2020  they execute.   
-00000c00: 2020 2020 2020 2020 2020 7468 6520 7379            the sy
-00000c10: 6e63 2063 6f75 6e74 6572 7061 7274 2075  nc counterpart u
-00000c20: 7369 6e67 2061 7379 6e63 696f 2773 2074  sing asyncio's t
-00000c30: 6872 6561 6420 706f 6f6c 2e0a 2020 2020  hread pool..    
-00000c40: 2020 2020 2020 2020 204f 7665 7272 6964           Overrid
-00000c50: 6520 666f 7220 6e61 7469 7665 2061 7379  e for native asy
-00000c60: 6e63 2e0a 0a20 2020 2041 6c6c 206d 6574  nc...    All met
-00000c70: 686f 6473 2061 6363 6570 7420 616e 206f  hods accept an o
-00000c80: 7074 696f 6e61 6c20 636f 6e66 6967 2061  ptional config a
-00000c90: 7267 756d 656e 742c 2077 6869 6368 2063  rgument, which c
-00000ca0: 616e 2062 6520 7573 6564 2074 6f20 636f  an be used to co
-00000cb0: 6e66 6967 7572 650a 2020 2020 6578 6563  nfigure.    exec
-00000cc0: 7574 696f 6e2c 2061 6464 2074 6167 7320  ution, add tags 
-00000cd0: 616e 6420 6d65 7461 6461 7461 2066 6f72  and metadata for
-00000ce0: 2074 7261 6369 6e67 2061 6e64 2064 6562   tracing and deb
-00000cf0: 7567 6769 6e67 2065 7463 2e0a 0a20 2020  ugging etc...   
-00000d00: 2052 756e 6e61 626c 6573 2065 7870 6f73   Runnables expos
-00000d10: 6520 7363 6865 6d61 7469 6320 696e 666f  e schematic info
-00000d20: 726d 6174 696f 6e20 6162 6f75 7420 7468  rmation about th
-00000d30: 6569 7220 696e 7075 742c 206f 7574 7075  eir input, outpu
-00000d40: 7420 616e 6420 636f 6e66 6967 2076 6961  t and config via
-00000d50: 0a20 2020 2074 6865 2069 6e70 7574 5f73  .    the input_s
-00000d60: 6368 656d 6120 7072 6f70 6572 7479 2c20  chema property, 
-00000d70: 7468 6520 6f75 7470 7574 5f73 6368 656d  the output_schem
-00000d80: 6120 7072 6f70 6572 7479 2061 6e64 2063  a property and c
-00000d90: 6f6e 6669 675f 7363 6865 6d61 206d 6574  onfig_schema met
-00000da0: 686f 642e 0a0a 2020 2020 4c43 454c 2061  hod...    LCEL a
-00000db0: 6e64 2043 6f6d 706f 7369 7469 6f6e 0a20  nd Composition. 
-00000dc0: 2020 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d     =============
-00000dd0: 3d3d 3d3d 3d3d 3d0a 0a20 2020 2054 6865  =======..    The
-00000de0: 204c 616e 6743 6861 696e 2045 7870 7265   LangChain Expre
-00000df0: 7373 696f 6e20 4c61 6e67 7561 6765 2028  ssion Language (
-00000e00: 4c43 454c 2920 6973 2061 2064 6563 6c61  LCEL) is a decla
-00000e10: 7261 7469 7665 2077 6179 2074 6f20 636f  rative way to co
-00000e20: 6d70 6f73 6520 5275 6e6e 6162 6c65 730a  mpose Runnables.
-00000e30: 2020 2020 696e 746f 2063 6861 696e 732e      into chains.
-00000e40: 2041 6e79 2063 6861 696e 2063 6f6e 7374   Any chain const
-00000e50: 7275 6374 6564 2074 6869 7320 7761 7920  ructed this way 
-00000e60: 7769 6c6c 2061 7574 6f6d 6174 6963 616c  will automatical
-00000e70: 6c79 2068 6176 6520 7379 6e63 2c20 6173  ly have sync, as
-00000e80: 796e 632c 0a20 2020 2062 6174 6368 2c20  ync,.    batch, 
-00000e90: 616e 6420 7374 7265 616d 696e 6720 7375  and streaming su
-00000ea0: 7070 6f72 742e 0a0a 2020 2020 5468 6520  pport...    The 
-00000eb0: 6d61 696e 2063 6f6d 706f 7369 7469 6f6e  main composition
-00000ec0: 2070 7269 6d69 7469 7665 7320 6172 6520   primitives are 
-00000ed0: 5275 6e6e 6162 6c65 5365 7175 656e 6365  RunnableSequence
-00000ee0: 2061 6e64 2052 756e 6e61 626c 6550 6172   and RunnablePar
-00000ef0: 616c 6c65 6c2e 0a0a 2020 2020 5275 6e6e  allel...    Runn
-00000f00: 6162 6c65 5365 7175 656e 6365 2069 6e76  ableSequence inv
-00000f10: 6f6b 6573 2061 2073 6572 6965 7320 6f66  okes a series of
-00000f20: 2072 756e 6e61 626c 6573 2073 6571 7565   runnables seque
-00000f30: 6e74 6961 6c6c 792c 2077 6974 6820 6f6e  ntially, with on
-00000f40: 6520 7275 6e6e 6162 6c65 2773 0a20 2020  e runnable's.   
-00000f50: 206f 7574 7075 7420 7365 7276 696e 6720   output serving 
-00000f60: 6173 2074 6865 206e 6578 7427 7320 696e  as the next's in
-00000f70: 7075 742e 2043 6f6e 7374 7275 6374 2075  put. Construct u
-00000f80: 7369 6e67 2074 6865 2060 7c60 206f 7065  sing the `|` ope
-00000f90: 7261 746f 7220 6f72 2062 790a 2020 2020  rator or by.    
-00000fa0: 7061 7373 696e 6720 6120 6c69 7374 206f  passing a list o
-00000fb0: 6620 7275 6e6e 6162 6c65 7320 746f 2052  f runnables to R
-00000fc0: 756e 6e61 626c 6553 6571 7565 6e63 652e  unnableSequence.
-00000fd0: 0a0a 2020 2020 5275 6e6e 6162 6c65 5061  ..    RunnablePa
-00000fe0: 7261 6c6c 656c 2069 6e76 6f6b 6573 2072  rallel invokes r
-00000ff0: 756e 6e61 626c 6573 2063 6f6e 6375 7272  unnables concurr
-00001000: 656e 746c 792c 2070 726f 7669 6469 6e67  ently, providing
-00001010: 2074 6865 2073 616d 6520 696e 7075 740a   the same input.
-00001020: 2020 2020 746f 2065 6163 682e 2043 6f6e      to each. Con
-00001030: 7374 7275 6374 2069 7420 7573 696e 6720  struct it using 
-00001040: 6120 6469 6374 206c 6974 6572 616c 2077  a dict literal w
-00001050: 6974 6869 6e20 6120 7365 7175 656e 6365  ithin a sequence
-00001060: 206f 7220 6279 2070 6173 7369 6e67 2061   or by passing a
-00001070: 0a20 2020 2064 6963 7420 746f 2052 756e  .    dict to Run
-00001080: 6e61 626c 6550 6172 616c 6c65 6c2e 0a0a  nableParallel...
-00001090: 0a20 2020 2046 6f72 2065 7861 6d70 6c65  .    For example
-000010a0: 2c0a 0a20 2020 202e 2e20 636f 6465 2d62  ,..    .. code-b
-000010b0: 6c6f 636b 3a3a 2070 7974 686f 6e0a 0a20  lock:: python.. 
-000010c0: 2020 2020 2020 2066 726f 6d20 6c61 6e67         from lang
-000010d0: 6368 6169 6e5f 636f 7265 2e72 756e 6e61  chain_core.runna
-000010e0: 626c 6573 2069 6d70 6f72 7420 5275 6e6e  bles import Runn
-000010f0: 6162 6c65 4c61 6d62 6461 0a0a 2020 2020  ableLambda..    
-00001100: 2020 2020 2320 4120 5275 6e6e 6162 6c65      # A Runnable
-00001110: 5365 7175 656e 6365 2063 6f6e 7374 7275  Sequence constru
-00001120: 6374 6564 2075 7369 6e67 2074 6865 2060  cted using the `
-00001130: 7c60 206f 7065 7261 746f 720a 2020 2020  |` operator.    
-00001140: 2020 2020 7365 7175 656e 6365 203d 2052      sequence = R
-00001150: 756e 6e61 626c 654c 616d 6264 6128 6c61  unnableLambda(la
-00001160: 6d62 6461 2078 3a20 7820 2b20 3129 207c  mbda x: x + 1) |
-00001170: 2052 756e 6e61 626c 654c 616d 6264 6128   RunnableLambda(
-00001180: 6c61 6d62 6461 2078 3a20 7820 2a20 3229  lambda x: x * 2)
-00001190: 0a20 2020 2020 2020 2073 6571 7565 6e63  .        sequenc
-000011a0: 652e 696e 766f 6b65 2831 2920 2320 340a  e.invoke(1) # 4.
-000011b0: 2020 2020 2020 2020 7365 7175 656e 6365          sequence
-000011c0: 2e62 6174 6368 285b 312c 2032 2c20 335d  .batch([1, 2, 3]
-000011d0: 2920 2320 5b34 2c20 362c 2038 5d0a 0a0a  ) # [4, 6, 8]...
-000011e0: 2020 2020 2020 2020 2320 4120 7365 7175          # A sequ
-000011f0: 656e 6365 2074 6861 7420 636f 6e74 6169  ence that contai
-00001200: 6e73 2061 2052 756e 6e61 626c 6550 6172  ns a RunnablePar
-00001210: 616c 6c65 6c20 636f 6e73 7472 7563 7465  allel constructe
-00001220: 6420 7573 696e 6720 6120 6469 6374 206c  d using a dict l
-00001230: 6974 6572 616c 0a20 2020 2020 2020 2073  iteral.        s
-00001240: 6571 7565 6e63 6520 3d20 5275 6e6e 6162  equence = Runnab
-00001250: 6c65 4c61 6d62 6461 286c 616d 6264 6120  leLambda(lambda 
-00001260: 783a 2078 202b 2031 2920 7c20 7b0a 2020  x: x + 1) | {.  
-00001270: 2020 2020 2020 2020 2020 276d 756c 5f32            'mul_2
-00001280: 273a 2052 756e 6e61 626c 654c 616d 6264  ': RunnableLambd
-00001290: 6128 6c61 6d62 6461 2078 3a20 7820 2a20  a(lambda x: x * 
-000012a0: 3229 2c0a 2020 2020 2020 2020 2020 2020  2),.            
-000012b0: 276d 756c 5f35 273a 2052 756e 6e61 626c  'mul_5': Runnabl
-000012c0: 654c 616d 6264 6128 6c61 6d62 6461 2078  eLambda(lambda x
-000012d0: 3a20 7820 2a20 3529 0a20 2020 2020 2020  : x * 5).       
-000012e0: 207d 0a20 2020 2020 2020 2073 6571 7565   }.        seque
-000012f0: 6e63 652e 696e 766f 6b65 2831 2920 2320  nce.invoke(1) # 
-00001300: 7b27 6d75 6c5f 3227 3a20 342c 2027 6d75  {'mul_2': 4, 'mu
-00001310: 6c5f 3527 3a20 3130 7d0a 0a20 2020 2053  l_5': 10}..    S
-00001320: 7461 6e64 6172 6420 4d65 7468 6f64 730a  tandard Methods.
-00001330: 2020 2020 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d      ============
-00001340: 3d3d 3d3d 0a0a 2020 2020 416c 6c20 5275  ====..    All Ru
-00001350: 6e6e 6162 6c65 7320 6578 706f 7365 2061  nnables expose a
-00001360: 6464 6974 696f 6e61 6c20 6d65 7468 6f64  dditional method
-00001370: 7320 7468 6174 2063 616e 2062 6520 7573  s that can be us
-00001380: 6564 2074 6f20 6d6f 6469 6679 2074 6865  ed to modify the
-00001390: 6972 2062 6568 6176 696f 720a 2020 2020  ir behavior.    
-000013a0: 2865 2e67 2e2c 2061 6464 2061 2072 6574  (e.g., add a ret
-000013b0: 7279 2070 6f6c 6963 792c 2061 6464 206c  ry policy, add l
-000013c0: 6966 6563 7963 6c65 206c 6973 7465 6e65  ifecycle listene
-000013d0: 7273 2c20 6d61 6b65 2074 6865 6d20 636f  rs, make them co
-000013e0: 6e66 6967 7572 6162 6c65 2c20 6574 632e  nfigurable, etc.
-000013f0: 292e 0a0a 2020 2020 5468 6573 6520 6d65  )...    These me
-00001400: 7468 6f64 7320 7769 6c6c 2077 6f72 6b20  thods will work 
-00001410: 6f6e 2061 6e79 2052 756e 6e61 626c 652c  on any Runnable,
-00001420: 2069 6e63 6c75 6469 6e67 2052 756e 6e61   including Runna
-00001430: 626c 6520 6368 6169 6e73 2063 6f6e 7374  ble chains const
-00001440: 7275 6374 6564 0a20 2020 2062 7920 636f  ructed.    by co
-00001450: 6d70 6f73 696e 6720 6f74 6865 7220 5275  mposing other Ru
-00001460: 6e6e 6162 6c65 732e 2053 6565 2074 6865  nnables. See the
-00001470: 2069 6e64 6976 6964 7561 6c20 6d65 7468   individual meth
-00001480: 6f64 7320 666f 7220 6465 7461 696c 732e  ods for details.
-00001490: 0a0a 2020 2020 466f 7220 6578 616d 706c  ..    For exampl
-000014a0: 652c 0a0a 2020 2020 2e2e 2063 6f64 652d  e,..    .. code-
-000014b0: 626c 6f63 6b3a 3a20 7079 7468 6f6e 0a0a  block:: python..
-000014c0: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
-000014d0: 6763 6861 696e 5f63 6f72 652e 7275 6e6e  gchain_core.runn
-000014e0: 6162 6c65 7320 696d 706f 7274 2052 756e  ables import Run
-000014f0: 6e61 626c 654c 616d 6264 610a 0a20 2020  nableLambda..   
-00001500: 2020 2020 2069 6d70 6f72 7420 7261 6e64       import rand
-00001510: 6f6d 0a0a 2020 2020 2020 2020 6465 6620  om..        def 
-00001520: 6164 645f 6f6e 6528 783a 2069 6e74 2920  add_one(x: int) 
-00001530: 2d3e 2069 6e74 3a0a 2020 2020 2020 2020  -> int:.        
-00001540: 2020 2020 7265 7475 726e 2078 202b 2031      return x + 1
-00001550: 0a0a 0a20 2020 2020 2020 2064 6566 2062  ...        def b
-00001560: 7567 6779 5f64 6f75 626c 6528 793a 2069  uggy_double(y: i
-00001570: 6e74 2920 2d3e 2069 6e74 3a0a 2020 2020  nt) -> int:.    
-00001580: 2020 2020 2020 2020 2727 2742 7567 6779          '''Buggy
-00001590: 2063 6f64 6520 7468 6174 2077 696c 6c20   code that will 
-000015a0: 6661 696c 2037 3025 206f 6620 7468 6520  fail 70% of the 
-000015b0: 7469 6d65 2727 270a 2020 2020 2020 2020  time'''.        
-000015c0: 2020 2020 6966 2072 616e 646f 6d2e 7261      if random.ra
-000015d0: 6e64 6f6d 2829 203e 2030 2e33 3a0a 2020  ndom() > 0.3:.  
-000015e0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-000015f0: 696e 7428 2754 6869 7320 636f 6465 2066  int('This code f
-00001600: 6169 6c65 642c 2061 6e64 2077 696c 6c20  ailed, and will 
-00001610: 7072 6f62 6162 6c79 2062 6520 7265 7472  probably be retr
-00001620: 6965 6421 2729 0a20 2020 2020 2020 2020  ied!').         
-00001630: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00001640: 7565 4572 726f 7228 2754 7269 6767 6572  ueError('Trigger
-00001650: 6564 2062 7567 6779 2063 6f64 6527 290a  ed buggy code').
-00001660: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00001670: 726e 2079 202a 2032 0a0a 2020 2020 2020  rn y * 2..      
-00001680: 2020 7365 7175 656e 6365 203d 2028 0a20    sequence = (. 
-00001690: 2020 2020 2020 2020 2020 2052 756e 6e61             Runna
-000016a0: 626c 654c 616d 6264 6128 6164 645f 6f6e  bleLambda(add_on
-000016b0: 6529 207c 0a20 2020 2020 2020 2020 2020  e) |.           
-000016c0: 2052 756e 6e61 626c 654c 616d 6264 6128   RunnableLambda(
-000016d0: 6275 6767 795f 646f 7562 6c65 292e 7769  buggy_double).wi
-000016e0: 7468 5f72 6574 7279 2820 2320 5265 7472  th_retry( # Retr
-000016f0: 7920 6f6e 2066 6169 6c75 7265 0a20 2020  y on failure.   
-00001700: 2020 2020 2020 2020 2020 2020 2073 746f               sto
-00001710: 705f 6166 7465 725f 6174 7465 6d70 743d  p_after_attempt=
-00001720: 3130 2c0a 2020 2020 2020 2020 2020 2020  10,.            
-00001730: 2020 2020 7761 6974 5f65 7870 6f6e 656e      wait_exponen
-00001740: 7469 616c 5f6a 6974 7465 723d 4661 6c73  tial_jitter=Fals
-00001750: 650a 2020 2020 2020 2020 2020 2020 290a  e.            ).
-00001760: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00001770: 2020 2070 7269 6e74 2873 6571 7565 6e63     print(sequenc
-00001780: 652e 696e 7075 745f 7363 6865 6d61 2e73  e.input_schema.s
-00001790: 6368 656d 6128 2929 2023 2053 686f 7720  chema()) # Show 
-000017a0: 696e 6665 7272 6564 2069 6e70 7574 2073  inferred input s
-000017b0: 6368 656d 610a 2020 2020 2020 2020 7072  chema.        pr
-000017c0: 696e 7428 7365 7175 656e 6365 2e6f 7574  int(sequence.out
-000017d0: 7075 745f 7363 6865 6d61 2e73 6368 656d  put_schema.schem
-000017e0: 6128 2929 2023 2053 686f 7720 696e 6665  a()) # Show infe
-000017f0: 7272 6564 206f 7574 7075 7420 7363 6865  rred output sche
-00001800: 6d61 0a20 2020 2020 2020 2070 7269 6e74  ma.        print
-00001810: 2873 6571 7565 6e63 652e 696e 766f 6b65  (sequence.invoke
-00001820: 2832 2929 2023 2069 6e76 6f6b 6520 7468  (2)) # invoke th
-00001830: 6520 7365 7175 656e 6365 2028 6e6f 7465  e sequence (note
-00001840: 2074 6865 2072 6574 7279 2061 626f 7665   the retry above
-00001850: 2121 290a 0a20 2020 2044 6562 7567 6769  !!)..    Debuggi
-00001860: 6e67 2061 6e64 2074 7261 6369 6e67 0a20  ng and tracing. 
-00001870: 2020 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d     =============
-00001880: 3d3d 3d3d 3d3d 3d3d 0a0a 2020 2020 4173  ========..    As
-00001890: 2074 6865 2063 6861 696e 7320 6765 7420   the chains get 
-000018a0: 6c6f 6e67 6572 2c20 6974 2063 616e 2062  longer, it can b
-000018b0: 6520 7573 6566 756c 2074 6f20 6265 2061  e useful to be a
-000018c0: 626c 6520 746f 2073 6565 2069 6e74 6572  ble to see inter
-000018d0: 6d65 6469 6174 6520 7265 7375 6c74 730a  mediate results.
-000018e0: 2020 2020 746f 2064 6562 7567 2061 6e64      to debug and
-000018f0: 2074 7261 6365 2074 6865 2063 6861 696e   trace the chain
-00001900: 2e0a 0a20 2020 2059 6f75 2063 616e 2073  ...    You can s
-00001910: 6574 2074 6865 2067 6c6f 6261 6c20 6465  et the global de
-00001920: 6275 6720 666c 6167 2074 6f20 5472 7565  bug flag to True
-00001930: 2074 6f20 656e 6162 6c65 2064 6562 7567   to enable debug
-00001940: 206f 7574 7075 7420 666f 7220 616c 6c20   output for all 
-00001950: 6368 6169 6e73 3a0a 0a20 2020 2020 2020  chains:..       
-00001960: 202e 2e20 636f 6465 2d62 6c6f 636b 3a3a   .. code-block::
-00001970: 2070 7974 686f 6e0a 0a20 2020 2020 2020   python..       
-00001980: 2020 2020 2066 726f 6d20 6c61 6e67 6368       from langch
-00001990: 6169 6e5f 636f 7265 2e67 6c6f 6261 6c73  ain_core.globals
-000019a0: 2069 6d70 6f72 7420 7365 745f 6465 6275   import set_debu
-000019b0: 670a 2020 2020 2020 2020 2020 2020 7365  g.            se
-000019c0: 745f 6465 6275 6728 5472 7565 290a 0a20  t_debug(True).. 
-000019d0: 2020 2041 6c74 6572 6e61 7469 7665 6c79     Alternatively
-000019e0: 2c20 796f 7520 6361 6e20 7061 7373 2065  , you can pass e
-000019f0: 7869 7374 696e 6720 6f72 2063 7573 746f  xisting or custo
-00001a00: 6d20 6361 6c6c 6261 636b 7320 746f 2061  m callbacks to a
-00001a10: 6e79 2067 6976 656e 2063 6861 696e 3a0a  ny given chain:.
-00001a20: 0a20 2020 2020 2020 202e 2e20 636f 6465  .        .. code
-00001a30: 2d62 6c6f 636b 3a3a 2070 7974 686f 6e0a  -block:: python.
-00001a40: 0a20 2020 2020 2020 2020 2020 2066 726f  .            fro
-00001a50: 6d20 6c61 6e67 6368 6169 6e5f 636f 7265  m langchain_core
-00001a60: 2e74 7261 6365 7273 2069 6d70 6f72 7420  .tracers import 
-00001a70: 436f 6e73 6f6c 6543 616c 6c62 6163 6b48  ConsoleCallbackH
-00001a80: 616e 646c 6572 0a0a 2020 2020 2020 2020  andler..        
-00001a90: 2020 2020 6368 6169 6e2e 696e 766f 6b65      chain.invoke
-00001aa0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00001ab0: 2020 2e2e 2e2c 0a20 2020 2020 2020 2020    ...,.         
-00001ac0: 2020 2020 2020 2063 6f6e 6669 673d 7b27         config={'
-00001ad0: 6361 6c6c 6261 636b 7327 3a20 5b43 6f6e  callbacks': [Con
-00001ae0: 736f 6c65 4361 6c6c 6261 636b 4861 6e64  soleCallbackHand
-00001af0: 6c65 7228 295d 7d0a 2020 2020 2020 2020  ler()]}.        
-00001b00: 2020 2020 290a 0a20 2020 2046 6f72 2061      )..    For a
-00001b10: 2055 4920 2861 6e64 206d 7563 6820 6d6f   UI (and much mo
-00001b20: 7265 2920 6368 6563 6b6f 7574 204c 616e  re) checkout Lan
-00001b30: 6753 6d69 7468 3a20 6874 7470 733a 2f2f  gSmith: https://
-00001b40: 646f 6373 2e73 6d69 7468 2e6c 616e 6763  docs.smith.langc
-00001b50: 6861 696e 2e63 6f6d 2f0a 2020 2020 2222  hain.com/.    ""
-00001b60: 220a 0a20 2020 206e 616d 653a 204f 7074  "..    name: Opt
-00001b70: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
-00001b80: 650a 2020 2020 2222 2254 6865 206e 616d  e.    """The nam
-00001b90: 6520 6f66 2074 6865 2072 756e 6e61 626c  e of the runnabl
-00001ba0: 652e 2055 7365 6420 666f 7220 6465 6275  e. Used for debu
-00001bb0: 6767 696e 6720 616e 6420 7472 6163 696e  gging and tracin
-00001bc0: 672e 2222 220a 0a20 2020 2064 6566 2067  g."""..    def g
-00001bd0: 6574 5f6e 616d 6528 0a20 2020 2020 2020  et_name(.       
-00001be0: 2073 656c 662c 2073 7566 6669 783a 204f   self, suffix: O
-00001bf0: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
-00001c00: 6f6e 652c 202a 2c20 6e61 6d65 3a20 4f70  one, *, name: Op
-00001c10: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
-00001c20: 6e65 0a20 2020 2029 202d 3e20 7374 723a  ne.    ) -> str:
-00001c30: 0a20 2020 2020 2020 2022 2222 4765 7420  .        """Get 
-00001c40: 7468 6520 6e61 6d65 206f 6620 7468 6520  the name of the 
-00001c50: 7275 6e6e 6162 6c65 2e22 2222 0a20 2020  runnable.""".   
-00001c60: 2020 2020 206e 616d 6520 3d20 6e61 6d65       name = name
-00001c70: 206f 7220 7365 6c66 2e6e 616d 6520 6f72   or self.name or
-00001c80: 2073 656c 662e 5f5f 636c 6173 735f 5f2e   self.__class__.
-00001c90: 5f5f 6e61 6d65 5f5f 0a20 2020 2020 2020  __name__.       
-00001ca0: 2069 6620 7375 6666 6978 3a0a 2020 2020   if suffix:.    
-00001cb0: 2020 2020 2020 2020 6966 206e 616d 655b          if name[
-00001cc0: 305d 2e69 7375 7070 6572 2829 3a0a 2020  0].isupper():.  
-00001cd0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00001ce0: 7475 726e 206e 616d 6520 2b20 7375 6666  turn name + suff
-00001cf0: 6978 2e74 6974 6c65 2829 0a20 2020 2020  ix.title().     
-00001d00: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00001d10: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00001d20: 7572 6e20 6e61 6d65 202b 2022 5f22 202b  urn name + "_" +
-00001d30: 2073 7566 6669 782e 6c6f 7765 7228 290a   suffix.lower().
-00001d40: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00001d50: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00001d60: 206e 616d 650a 0a20 2020 2040 7072 6f70   name..    @prop
-00001d70: 6572 7479 0a20 2020 2064 6566 2049 6e70  erty.    def Inp
-00001d80: 7574 5479 7065 2873 656c 6629 202d 3e20  utType(self) -> 
-00001d90: 5479 7065 5b49 6e70 7574 5d3a 0a20 2020  Type[Input]:.   
-00001da0: 2020 2020 2022 2222 5468 6520 7479 7065       """The type
-00001db0: 206f 6620 696e 7075 7420 7468 6973 2072   of input this r
-00001dc0: 756e 6e61 626c 6520 6163 6365 7074 7320  unnable accepts 
-00001dd0: 7370 6563 6966 6965 6420 6173 2061 2074  specified as a t
-00001de0: 7970 6520 616e 6e6f 7461 7469 6f6e 2e22  ype annotation."
-00001df0: 2222 0a20 2020 2020 2020 2066 6f72 2063  "".        for c
-00001e00: 6c73 2069 6e20 7365 6c66 2e5f 5f63 6c61  ls in self.__cla
-00001e10: 7373 5f5f 2e5f 5f6f 7269 675f 6261 7365  ss__.__orig_base
-00001e20: 735f 5f3a 2020 2320 7479 7065 3a20 6967  s__:  # type: ig
-00001e30: 6e6f 7265 5b61 7474 722d 6465 6669 6e65  nore[attr-define
-00001e40: 645d 0a20 2020 2020 2020 2020 2020 2074  d].            t
-00001e50: 7970 655f 6172 6773 203d 2067 6574 5f61  ype_args = get_a
-00001e60: 7267 7328 636c 7329 0a20 2020 2020 2020  rgs(cls).       
-00001e70: 2020 2020 2069 6620 7479 7065 5f61 7267       if type_arg
-00001e80: 7320 616e 6420 6c65 6e28 7479 7065 5f61  s and len(type_a
-00001e90: 7267 7329 203d 3d20 323a 0a20 2020 2020  rgs) == 2:.     
-00001ea0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00001eb0: 6e20 7479 7065 5f61 7267 735b 305d 0a0a  n type_args[0]..
-00001ec0: 2020 2020 2020 2020 7261 6973 6520 5479          raise Ty
-00001ed0: 7065 4572 726f 7228 0a20 2020 2020 2020  peError(.       
-00001ee0: 2020 2020 2066 2252 756e 6e61 626c 6520       f"Runnable 
-00001ef0: 7b73 656c 662e 6765 745f 6e61 6d65 2829  {self.get_name()
-00001f00: 7d20 646f 6573 6e27 7420 6861 7665 2061  } doesn't have a
-00001f10: 6e20 696e 6665 7261 626c 6520 496e 7075  n inferable Inpu
-00001f20: 7454 7970 652e 2022 0a20 2020 2020 2020  tType. ".       
-00001f30: 2020 2020 2022 4f76 6572 7269 6465 2074       "Override t
-00001f40: 6865 2049 6e70 7574 5479 7065 2070 726f  he InputType pro
-00001f50: 7065 7274 7920 746f 2073 7065 6369 6679  perty to specify
-00001f60: 2074 6865 2069 6e70 7574 2074 7970 652e   the input type.
-00001f70: 220a 2020 2020 2020 2020 290a 0a20 2020  ".        )..   
-00001f80: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-00001f90: 6566 204f 7574 7075 7454 7970 6528 7365  ef OutputType(se
-00001fa0: 6c66 2920 2d3e 2054 7970 655b 4f75 7470  lf) -> Type[Outp
-00001fb0: 7574 5d3a 0a20 2020 2020 2020 2022 2222  ut]:.        """
-00001fc0: 5468 6520 7479 7065 206f 6620 6f75 7470  The type of outp
-00001fd0: 7574 2074 6869 7320 7275 6e6e 6162 6c65  ut this runnable
-00001fe0: 2070 726f 6475 6365 7320 7370 6563 6966   produces specif
-00001ff0: 6965 6420 6173 2061 2074 7970 6520 616e  ied as a type an
-00002000: 6e6f 7461 7469 6f6e 2e22 2222 0a20 2020  notation.""".   
-00002010: 2020 2020 2066 6f72 2063 6c73 2069 6e20       for cls in 
-00002020: 7365 6c66 2e5f 5f63 6c61 7373 5f5f 2e5f  self.__class__._
-00002030: 5f6f 7269 675f 6261 7365 735f 5f3a 2020  _orig_bases__:  
-00002040: 2320 7479 7065 3a20 6967 6e6f 7265 5b61  # type: ignore[a
-00002050: 7474 722d 6465 6669 6e65 645d 0a20 2020  ttr-defined].   
-00002060: 2020 2020 2020 2020 2074 7970 655f 6172           type_ar
-00002070: 6773 203d 2067 6574 5f61 7267 7328 636c  gs = get_args(cl
-00002080: 7329 0a20 2020 2020 2020 2020 2020 2069  s).            i
-00002090: 6620 7479 7065 5f61 7267 7320 616e 6420  f type_args and 
-000020a0: 6c65 6e28 7479 7065 5f61 7267 7329 203d  len(type_args) =
-000020b0: 3d20 323a 0a20 2020 2020 2020 2020 2020  = 2:.           
-000020c0: 2020 2020 2072 6574 7572 6e20 7479 7065       return type
-000020d0: 5f61 7267 735b 315d 0a0a 2020 2020 2020  _args[1]..      
-000020e0: 2020 7261 6973 6520 5479 7065 4572 726f    raise TypeErro
-000020f0: 7228 0a20 2020 2020 2020 2020 2020 2066  r(.            f
-00002100: 2252 756e 6e61 626c 6520 7b73 656c 662e  "Runnable {self.
-00002110: 6765 745f 6e61 6d65 2829 7d20 646f 6573  get_name()} does
-00002120: 6e27 7420 6861 7665 2061 6e20 696e 6665  n't have an infe
-00002130: 7261 626c 6520 4f75 7470 7574 5479 7065  rable OutputType
-00002140: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
-00002150: 224f 7665 7272 6964 6520 7468 6520 4f75  "Override the Ou
-00002160: 7470 7574 5479 7065 2070 726f 7065 7274  tputType propert
-00002170: 7920 746f 2073 7065 6369 6679 2074 6865  y to specify the
-00002180: 206f 7574 7075 7420 7479 7065 2e22 0a20   output type.". 
-00002190: 2020 2020 2020 2029 0a0a 2020 2020 4070         )..    @p
-000021a0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-000021b0: 696e 7075 745f 7363 6865 6d61 2873 656c  input_schema(sel
-000021c0: 6629 202d 3e20 5479 7065 5b42 6173 654d  f) -> Type[BaseM
-000021d0: 6f64 656c 5d3a 0a20 2020 2020 2020 2022  odel]:.        "
-000021e0: 2222 5468 6520 7479 7065 206f 6620 696e  ""The type of in
-000021f0: 7075 7420 7468 6973 2072 756e 6e61 626c  put this runnabl
-00002200: 6520 6163 6365 7074 7320 7370 6563 6966  e accepts specif
-00002210: 6965 6420 6173 2061 2070 7964 616e 7469  ied as a pydanti
-00002220: 6320 6d6f 6465 6c2e 2222 220a 2020 2020  c model.""".    
-00002230: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-00002240: 6765 745f 696e 7075 745f 7363 6865 6d61  get_input_schema
-00002250: 2829 0a0a 2020 2020 6465 6620 6765 745f  ()..    def get_
-00002260: 696e 7075 745f 7363 6865 6d61 280a 2020  input_schema(.  
-00002270: 2020 2020 2020 7365 6c66 2c20 636f 6e66        self, conf
-00002280: 6967 3a20 4f70 7469 6f6e 616c 5b52 756e  ig: Optional[Run
-00002290: 6e61 626c 6543 6f6e 6669 675d 203d 204e  nableConfig] = N
-000022a0: 6f6e 650a 2020 2020 2920 2d3e 2054 7970  one.    ) -> Typ
-000022b0: 655b 4261 7365 4d6f 6465 6c5d 3a0a 2020  e[BaseModel]:.  
-000022c0: 2020 2020 2020 2222 2247 6574 2061 2070        """Get a p
-000022d0: 7964 616e 7469 6320 6d6f 6465 6c20 7468  ydantic model th
-000022e0: 6174 2063 616e 2062 6520 7573 6564 2074  at can be used t
-000022f0: 6f20 7661 6c69 6461 7465 2069 6e70 7574  o validate input
-00002300: 2074 6f20 7468 6520 7275 6e6e 6162 6c65   to the runnable
-00002310: 2e0a 0a20 2020 2020 2020 2052 756e 6e61  ...        Runna
-00002320: 626c 6573 2074 6861 7420 6c65 7665 7261  bles that levera
-00002330: 6765 2074 6865 2063 6f6e 6669 6775 7261  ge the configura
-00002340: 626c 655f 6669 656c 6473 2061 6e64 2063  ble_fields and c
-00002350: 6f6e 6669 6775 7261 626c 655f 616c 7465  onfigurable_alte
-00002360: 726e 6174 6976 6573 0a20 2020 2020 2020  rnatives.       
-00002370: 206d 6574 686f 6473 2077 696c 6c20 6861   methods will ha
-00002380: 7665 2061 2064 796e 616d 6963 2069 6e70  ve a dynamic inp
-00002390: 7574 2073 6368 656d 6120 7468 6174 2064  ut schema that d
-000023a0: 6570 656e 6473 206f 6e20 7768 6963 680a  epends on which.
-000023b0: 2020 2020 2020 2020 636f 6e66 6967 7572          configur
-000023c0: 6174 696f 6e20 7468 6520 7275 6e6e 6162  ation the runnab
-000023d0: 6c65 2069 7320 696e 766f 6b65 6420 7769  le is invoked wi
-000023e0: 7468 2e0a 0a20 2020 2020 2020 2054 6869  th...        Thi
-000023f0: 7320 6d65 7468 6f64 2061 6c6c 6f77 7320  s method allows 
-00002400: 746f 2067 6574 2061 6e20 696e 7075 7420  to get an input 
-00002410: 7363 6865 6d61 2066 6f72 2061 2073 7065  schema for a spe
-00002420: 6369 6669 6320 636f 6e66 6967 7572 6174  cific configurat
-00002430: 696f 6e2e 0a0a 2020 2020 2020 2020 4172  ion...        Ar
-00002440: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-00002450: 636f 6e66 6967 3a20 4120 636f 6e66 6967  config: A config
-00002460: 2074 6f20 7573 6520 7768 656e 2067 656e   to use when gen
-00002470: 6572 6174 696e 6720 7468 6520 7363 6865  erating the sche
-00002480: 6d61 2e0a 0a20 2020 2020 2020 2052 6574  ma...        Ret
-00002490: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
-000024a0: 2020 4120 7079 6461 6e74 6963 206d 6f64    A pydantic mod
-000024b0: 656c 2074 6861 7420 6361 6e20 6265 2075  el that can be u
-000024c0: 7365 6420 746f 2076 616c 6964 6174 6520  sed to validate 
-000024d0: 696e 7075 742e 0a20 2020 2020 2020 2022  input..        "
-000024e0: 2222 0a20 2020 2020 2020 2072 6f6f 745f  "".        root_
-000024f0: 7479 7065 203d 2073 656c 662e 496e 7075  type = self.Inpu
-00002500: 7454 7970 650a 0a20 2020 2020 2020 2069  tType..        i
-00002510: 6620 696e 7370 6563 742e 6973 636c 6173  f inspect.isclas
-00002520: 7328 726f 6f74 5f74 7970 6529 2061 6e64  s(root_type) and
-00002530: 2069 7373 7562 636c 6173 7328 726f 6f74   issubclass(root
-00002540: 5f74 7970 652c 2042 6173 654d 6f64 656c  _type, BaseModel
-00002550: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00002560: 6574 7572 6e20 726f 6f74 5f74 7970 650a  eturn root_type.
-00002570: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00002580: 6372 6561 7465 5f6d 6f64 656c 280a 2020  create_model(.  
-00002590: 2020 2020 2020 2020 2020 7365 6c66 2e67            self.g
-000025a0: 6574 5f6e 616d 6528 2249 6e70 7574 2229  et_name("Input")
-000025b0: 2c0a 2020 2020 2020 2020 2020 2020 5f5f  ,.            __
-000025c0: 726f 6f74 5f5f 3d28 726f 6f74 5f74 7970  root__=(root_typ
-000025d0: 652c 204e 6f6e 6529 2c0a 2020 2020 2020  e, None),.      
-000025e0: 2020 2020 2020 5f5f 636f 6e66 6967 5f5f        __config__
-000025f0: 3d5f 5363 6865 6d61 436f 6e66 6967 2c0a  =_SchemaConfig,.
-00002600: 2020 2020 2020 2020 290a 0a20 2020 2040          )..    @
-00002610: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00002620: 206f 7574 7075 745f 7363 6865 6d61 2873   output_schema(s
-00002630: 656c 6629 202d 3e20 5479 7065 5b42 6173  elf) -> Type[Bas
-00002640: 654d 6f64 656c 5d3a 0a20 2020 2020 2020  eModel]:.       
-00002650: 2022 2222 5468 6520 7479 7065 206f 6620   """The type of 
-00002660: 6f75 7470 7574 2074 6869 7320 7275 6e6e  output this runn
-00002670: 6162 6c65 2070 726f 6475 6365 7320 7370  able produces sp
-00002680: 6563 6966 6965 6420 6173 2061 2070 7964  ecified as a pyd
-00002690: 616e 7469 6320 6d6f 6465 6c2e 2222 220a  antic model.""".
-000026a0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-000026b0: 656c 662e 6765 745f 6f75 7470 7574 5f73  elf.get_output_s
-000026c0: 6368 656d 6128 290a 0a20 2020 2064 6566  chema()..    def
-000026d0: 2067 6574 5f6f 7574 7075 745f 7363 6865   get_output_sche
-000026e0: 6d61 280a 2020 2020 2020 2020 7365 6c66  ma(.        self
-000026f0: 2c20 636f 6e66 6967 3a20 4f70 7469 6f6e  , config: Option
-00002700: 616c 5b52 756e 6e61 626c 6543 6f6e 6669  al[RunnableConfi
-00002710: 675d 203d 204e 6f6e 650a 2020 2020 2920  g] = None.    ) 
-00002720: 2d3e 2054 7970 655b 4261 7365 4d6f 6465  -> Type[BaseMode
-00002730: 6c5d 3a0a 2020 2020 2020 2020 2222 2247  l]:.        """G
-00002740: 6574 2061 2070 7964 616e 7469 6320 6d6f  et a pydantic mo
-00002750: 6465 6c20 7468 6174 2063 616e 2062 6520  del that can be 
-00002760: 7573 6564 2074 6f20 7661 6c69 6461 7465  used to validate
-00002770: 206f 7574 7075 7420 746f 2074 6865 2072   output to the r
-00002780: 756e 6e61 626c 652e 0a0a 2020 2020 2020  unnable...      
-00002790: 2020 5275 6e6e 6162 6c65 7320 7468 6174    Runnables that
-000027a0: 206c 6576 6572 6167 6520 7468 6520 636f   leverage the co
-000027b0: 6e66 6967 7572 6162 6c65 5f66 6965 6c64  nfigurable_field
-000027c0: 7320 616e 6420 636f 6e66 6967 7572 6162  s and configurab
-000027d0: 6c65 5f61 6c74 6572 6e61 7469 7665 730a  le_alternatives.
-000027e0: 2020 2020 2020 2020 6d65 7468 6f64 7320          methods 
-000027f0: 7769 6c6c 2068 6176 6520 6120 6479 6e61  will have a dyna
-00002800: 6d69 6320 6f75 7470 7574 2073 6368 656d  mic output schem
-00002810: 6120 7468 6174 2064 6570 656e 6473 206f  a that depends o
-00002820: 6e20 7768 6963 680a 2020 2020 2020 2020  n which.        
-00002830: 636f 6e66 6967 7572 6174 696f 6e20 7468  configuration th
-00002840: 6520 7275 6e6e 6162 6c65 2069 7320 696e  e runnable is in
-00002850: 766f 6b65 6420 7769 7468 2e0a 0a20 2020  voked with...   
-00002860: 2020 2020 2054 6869 7320 6d65 7468 6f64       This method
-00002870: 2061 6c6c 6f77 7320 746f 2067 6574 2061   allows to get a
-00002880: 6e20 6f75 7470 7574 2073 6368 656d 6120  n output schema 
-00002890: 666f 7220 6120 7370 6563 6966 6963 2063  for a specific c
-000028a0: 6f6e 6669 6775 7261 7469 6f6e 2e0a 0a20  onfiguration... 
-000028b0: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
-000028c0: 2020 2020 2020 2020 2063 6f6e 6669 673a           config:
-000028d0: 2041 2063 6f6e 6669 6720 746f 2075 7365   A config to use
-000028e0: 2077 6865 6e20 6765 6e65 7261 7469 6e67   when generating
-000028f0: 2074 6865 2073 6368 656d 612e 0a0a 2020   the schema...  
-00002900: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
-00002910: 2020 2020 2020 2020 2020 2041 2070 7964             A pyd
-00002920: 616e 7469 6320 6d6f 6465 6c20 7468 6174  antic model that
-00002930: 2063 616e 2062 6520 7573 6564 2074 6f20   can be used to 
-00002940: 7661 6c69 6461 7465 206f 7574 7075 742e  validate output.
-00002950: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00002960: 2020 2020 2072 6f6f 745f 7479 7065 203d       root_type =
-00002970: 2073 656c 662e 4f75 7470 7574 5479 7065   self.OutputType
-00002980: 0a0a 2020 2020 2020 2020 6966 2069 6e73  ..        if ins
-00002990: 7065 6374 2e69 7363 6c61 7373 2872 6f6f  pect.isclass(roo
-000029a0: 745f 7479 7065 2920 616e 6420 6973 7375  t_type) and issu
-000029b0: 6263 6c61 7373 2872 6f6f 745f 7479 7065  bclass(root_type
-000029c0: 2c20 4261 7365 4d6f 6465 6c29 3a0a 2020  , BaseModel):.  
-000029d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000029e0: 2072 6f6f 745f 7479 7065 0a0a 2020 2020   root_type..    
-000029f0: 2020 2020 7265 7475 726e 2063 7265 6174      return creat
-00002a00: 655f 6d6f 6465 6c28 0a20 2020 2020 2020  e_model(.       
-00002a10: 2020 2020 2073 656c 662e 6765 745f 6e61       self.get_na
-00002a20: 6d65 2822 4f75 7470 7574 2229 2c0a 2020  me("Output"),.  
-00002a30: 2020 2020 2020 2020 2020 5f5f 726f 6f74            __root
-00002a40: 5f5f 3d28 726f 6f74 5f74 7970 652c 204e  __=(root_type, N
-00002a50: 6f6e 6529 2c0a 2020 2020 2020 2020 2020  one),.          
-00002a60: 2020 5f5f 636f 6e66 6967 5f5f 3d5f 5363    __config__=_Sc
-00002a70: 6865 6d61 436f 6e66 6967 2c0a 2020 2020  hemaConfig,.    
-00002a80: 2020 2020 290a 0a20 2020 2040 7072 6f70      )..    @prop
-00002a90: 6572 7479 0a20 2020 2064 6566 2063 6f6e  erty.    def con
-00002aa0: 6669 675f 7370 6563 7328 7365 6c66 2920  fig_specs(self) 
-00002ab0: 2d3e 204c 6973 745b 436f 6e66 6967 7572  -> List[Configur
-00002ac0: 6162 6c65 4669 656c 6453 7065 635d 3a0a  ableFieldSpec]:.
-00002ad0: 2020 2020 2020 2020 2222 224c 6973 7420          """List 
-00002ae0: 636f 6e66 6967 7572 6162 6c65 2066 6965  configurable fie
-00002af0: 6c64 7320 666f 7220 7468 6973 2072 756e  lds for this run
-00002b00: 6e61 626c 652e 2222 220a 2020 2020 2020  nable.""".      
-00002b10: 2020 7265 7475 726e 205b 5d0a 0a20 2020    return []..   
-00002b20: 2064 6566 2063 6f6e 6669 675f 7363 6865   def config_sche
-00002b30: 6d61 280a 2020 2020 2020 2020 7365 6c66  ma(.        self
-00002b40: 2c20 2a2c 2069 6e63 6c75 6465 3a20 4f70  , *, include: Op
-00002b50: 7469 6f6e 616c 5b53 6571 7565 6e63 655b  tional[Sequence[
-00002b60: 7374 725d 5d20 3d20 4e6f 6e65 0a20 2020  str]] = None.   
-00002b70: 2029 202d 3e20 5479 7065 5b42 6173 654d   ) -> Type[BaseM
-00002b80: 6f64 656c 5d3a 0a20 2020 2020 2020 2022  odel]:.        "
-00002b90: 2222 5468 6520 7479 7065 206f 6620 636f  ""The type of co
-00002ba0: 6e66 6967 2074 6869 7320 7275 6e6e 6162  nfig this runnab
-00002bb0: 6c65 2061 6363 6570 7473 2073 7065 6369  le accepts speci
-00002bc0: 6669 6564 2061 7320 6120 7079 6461 6e74  fied as a pydant
-00002bd0: 6963 206d 6f64 656c 2e0a 0a20 2020 2020  ic model...     
-00002be0: 2020 2054 6f20 6d61 726b 2061 2066 6965     To mark a fie
-00002bf0: 6c64 2061 7320 636f 6e66 6967 7572 6162  ld as configurab
-00002c00: 6c65 2c20 7365 6520 7468 6520 6063 6f6e  le, see the `con
-00002c10: 6669 6775 7261 626c 655f 6669 656c 6473  figurable_fields
-00002c20: 600a 2020 2020 2020 2020 616e 6420 6063  `.        and `c
-00002c30: 6f6e 6669 6775 7261 626c 655f 616c 7465  onfigurable_alte
-00002c40: 726e 6174 6976 6573 6020 6d65 7468 6f64  rnatives` method
-00002c50: 732e 0a0a 2020 2020 2020 2020 4172 6773  s...        Args
-00002c60: 3a0a 2020 2020 2020 2020 2020 2020 696e  :.            in
-00002c70: 636c 7564 653a 2041 206c 6973 7420 6f66  clude: A list of
-00002c80: 2066 6965 6c64 7320 746f 2069 6e63 6c75   fields to inclu
-00002c90: 6465 2069 6e20 7468 6520 636f 6e66 6967  de in the config
-00002ca0: 2073 6368 656d 612e 0a0a 2020 2020 2020   schema...      
-00002cb0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-00002cc0: 2020 2020 2020 2041 2070 7964 616e 7469         A pydanti
-00002cd0: 6320 6d6f 6465 6c20 7468 6174 2063 616e  c model that can
-00002ce0: 2062 6520 7573 6564 2074 6f20 7661 6c69   be used to vali
-00002cf0: 6461 7465 2063 6f6e 6669 672e 0a20 2020  date config..   
-00002d00: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
-00002d10: 2020 696e 636c 7564 6520 3d20 696e 636c    include = incl
-00002d20: 7564 6520 6f72 205b 5d0a 2020 2020 2020  ude or [].      
-00002d30: 2020 636f 6e66 6967 5f73 7065 6373 203d    config_specs =
-00002d40: 2073 656c 662e 636f 6e66 6967 5f73 7065   self.config_spe
-00002d50: 6373 0a20 2020 2020 2020 2063 6f6e 6669  cs.        confi
-00002d60: 6775 7261 626c 6520 3d20 280a 2020 2020  gurable = (.    
-00002d70: 2020 2020 2020 2020 6372 6561 7465 5f6d          create_m
-00002d80: 6f64 656c 2820 2023 2074 7970 653a 2069  odel(  # type: i
-00002d90: 676e 6f72 655b 6361 6c6c 2d6f 7665 726c  gnore[call-overl
-00002da0: 6f61 645d 0a20 2020 2020 2020 2020 2020  oad].           
-00002db0: 2020 2020 2022 436f 6e66 6967 7572 6162       "Configurab
-00002dc0: 6c65 222c 0a20 2020 2020 2020 2020 2020  le",.           
-00002dd0: 2020 2020 202a 2a7b 0a20 2020 2020 2020       **{.       
-00002de0: 2020 2020 2020 2020 2020 2020 2073 7065               spe
-00002df0: 632e 6964 3a20 280a 2020 2020 2020 2020  c.id: (.        
-00002e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002e10: 7370 6563 2e61 6e6e 6f74 6174 696f 6e2c  spec.annotation,
-00002e20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002e30: 2020 2020 2020 2020 2046 6965 6c64 280a           Field(.
-00002e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002e50: 2020 2020 2020 2020 2020 2020 7370 6563              spec
-00002e60: 2e64 6566 6175 6c74 2c20 7469 746c 653d  .default, title=
-00002e70: 7370 6563 2e6e 616d 652c 2064 6573 6372  spec.name, descr
-00002e80: 6970 7469 6f6e 3d73 7065 632e 6465 7363  iption=spec.desc
-00002e90: 7269 7074 696f 6e0a 2020 2020 2020 2020  ription.        
+000000e0: 6578 740a 6672 6f6d 2066 756e 6374 6f6f  ext.from functoo
+000000f0: 6c73 2069 6d70 6f72 7420 7772 6170 730a  ls import wraps.
+00000100: 6672 6f6d 2069 7465 7274 6f6f 6c73 2069  from itertools i
+00000110: 6d70 6f72 7420 6772 6f75 7062 792c 2074  mport groupby, t
+00000120: 6565 0a66 726f 6d20 6f70 6572 6174 6f72  ee.from operator
+00000130: 2069 6d70 6f72 7420 6974 656d 6765 7474   import itemgett
+00000140: 6572 0a66 726f 6d20 7479 7069 6e67 2069  er.from typing i
+00000150: 6d70 6f72 7420 280a 2020 2020 5459 5045  mport (.    TYPE
+00000160: 5f43 4845 434b 494e 472c 0a20 2020 2041  _CHECKING,.    A
+00000170: 6e79 2c0a 2020 2020 4173 796e 6349 7465  ny,.    AsyncIte
+00000180: 7261 746f 722c 0a20 2020 2041 7761 6974  rator,.    Await
+00000190: 6162 6c65 2c0a 2020 2020 4361 6c6c 6162  able,.    Callab
+000001a0: 6c65 2c0a 2020 2020 436f 726f 7574 696e  le,.    Coroutin
+000001b0: 652c 0a20 2020 2044 6963 742c 0a20 2020  e,.    Dict,.   
+000001c0: 2047 656e 6572 6963 2c0a 2020 2020 4974   Generic,.    It
+000001d0: 6572 6174 6f72 2c0a 2020 2020 4c69 7374  erator,.    List
+000001e0: 2c0a 2020 2020 4d61 7070 696e 672c 0a20  ,.    Mapping,. 
+000001f0: 2020 204f 7074 696f 6e61 6c2c 0a20 2020     Optional,.   
+00000200: 2053 6571 7565 6e63 652c 0a20 2020 2053   Sequence,.    S
+00000210: 6574 2c0a 2020 2020 5475 706c 652c 0a20  et,.    Tuple,. 
+00000220: 2020 2054 7970 652c 0a20 2020 2054 7970     Type,.    Typ
+00000230: 6556 6172 2c0a 2020 2020 556e 696f 6e2c  eVar,.    Union,
+00000240: 0a20 2020 2063 6173 742c 0a20 2020 206f  .    cast,.    o
+00000250: 7665 726c 6f61 642c 0a29 0a0a 6672 6f6d  verload,.)..from
+00000260: 2074 7970 696e 675f 6578 7465 6e73 696f   typing_extensio
+00000270: 6e73 2069 6d70 6f72 7420 4c69 7465 7261  ns import Litera
+00000280: 6c2c 2067 6574 5f61 7267 730a 0a66 726f  l, get_args..fro
+00000290: 6d20 6c61 6e67 6368 6169 6e5f 636f 7265  m langchain_core
+000002a0: 2e5f 6170 6920 696d 706f 7274 2062 6574  ._api import bet
+000002b0: 615f 6465 636f 7261 746f 720a 6672 6f6d  a_decorator.from
+000002c0: 206c 616e 6763 6861 696e 5f63 6f72 652e   langchain_core.
+000002d0: 6c6f 6164 2e64 756d 7020 696d 706f 7274  load.dump import
+000002e0: 2064 756d 7064 0a66 726f 6d20 6c61 6e67   dumpd.from lang
+000002f0: 6368 6169 6e5f 636f 7265 2e6c 6f61 642e  chain_core.load.
+00000300: 7365 7269 616c 697a 6162 6c65 2069 6d70  serializable imp
+00000310: 6f72 7420 280a 2020 2020 5365 7269 616c  ort (.    Serial
+00000320: 697a 6162 6c65 2c0a 2020 2020 5365 7269  izable,.    Seri
+00000330: 616c 697a 6564 436f 6e73 7472 7563 746f  alizedConstructo
+00000340: 722c 0a20 2020 2053 6572 6961 6c69 7a65  r,.    Serialize
+00000350: 644e 6f74 496d 706c 656d 656e 7465 642c  dNotImplemented,
+00000360: 0a29 0a66 726f 6d20 6c61 6e67 6368 6169  .).from langchai
+00000370: 6e5f 636f 7265 2e70 7964 616e 7469 635f  n_core.pydantic_
+00000380: 7631 2069 6d70 6f72 7420 4261 7365 4d6f  v1 import BaseMo
+00000390: 6465 6c2c 2046 6965 6c64 0a66 726f 6d20  del, Field.from 
+000003a0: 6c61 6e67 6368 6169 6e5f 636f 7265 2e72  langchain_core.r
+000003b0: 756e 6e61 626c 6573 2e63 6f6e 6669 6720  unnables.config 
+000003c0: 696d 706f 7274 2028 0a20 2020 2052 756e  import (.    Run
+000003d0: 6e61 626c 6543 6f6e 6669 672c 0a20 2020  nableConfig,.   
+000003e0: 2061 6361 6c6c 5f66 756e 635f 7769 7468   acall_func_with
+000003f0: 5f76 6172 6961 626c 655f 6172 6773 2c0a  _variable_args,.
+00000400: 2020 2020 6361 6c6c 5f66 756e 635f 7769      call_func_wi
+00000410: 7468 5f76 6172 6961 626c 655f 6172 6773  th_variable_args
+00000420: 2c0a 2020 2020 656e 7375 7265 5f63 6f6e  ,.    ensure_con
+00000430: 6669 672c 0a20 2020 2067 6574 5f61 7379  fig,.    get_asy
+00000440: 6e63 5f63 616c 6c62 6163 6b5f 6d61 6e61  nc_callback_mana
+00000450: 6765 725f 666f 725f 636f 6e66 6967 2c0a  ger_for_config,.
+00000460: 2020 2020 6765 745f 6361 6c6c 6261 636b      get_callback
+00000470: 5f6d 616e 6167 6572 5f66 6f72 5f63 6f6e  _manager_for_con
+00000480: 6669 672c 0a20 2020 2067 6574 5f63 6f6e  fig,.    get_con
+00000490: 6669 675f 6c69 7374 2c0a 2020 2020 6765  fig_list,.    ge
+000004a0: 745f 6578 6563 7574 6f72 5f66 6f72 5f63  t_executor_for_c
+000004b0: 6f6e 6669 672c 0a20 2020 206d 6572 6765  onfig,.    merge
+000004c0: 5f63 6f6e 6669 6773 2c0a 2020 2020 7061  _configs,.    pa
+000004d0: 7463 685f 636f 6e66 6967 2c0a 2020 2020  tch_config,.    
+000004e0: 7275 6e5f 696e 5f65 7865 6375 746f 722c  run_in_executor,
+000004f0: 0a20 2020 2076 6172 5f63 6869 6c64 5f72  .    var_child_r
+00000500: 756e 6e61 626c 655f 636f 6e66 6967 2c0a  unnable_config,.
+00000510: 290a 6672 6f6d 206c 616e 6763 6861 696e  ).from langchain
+00000520: 5f63 6f72 652e 7275 6e6e 6162 6c65 732e  _core.runnables.
+00000530: 6772 6170 6820 696d 706f 7274 2047 7261  graph import Gra
+00000540: 7068 0a66 726f 6d20 6c61 6e67 6368 6169  ph.from langchai
+00000550: 6e5f 636f 7265 2e72 756e 6e61 626c 6573  n_core.runnables
+00000560: 2e73 6368 656d 6120 696d 706f 7274 2045  .schema import E
+00000570: 7665 6e74 4461 7461 2c20 5374 7265 616d  ventData, Stream
+00000580: 4576 656e 740a 6672 6f6d 206c 616e 6763  Event.from langc
+00000590: 6861 696e 5f63 6f72 652e 7275 6e6e 6162  hain_core.runnab
+000005a0: 6c65 732e 7574 696c 7320 696d 706f 7274  les.utils import
+000005b0: 2028 0a20 2020 2041 6464 6162 6c65 4469   (.    AddableDi
+000005c0: 6374 2c0a 2020 2020 416e 7943 6f6e 6669  ct,.    AnyConfi
+000005d0: 6775 7261 626c 6546 6965 6c64 2c0a 2020  gurableField,.  
+000005e0: 2020 436f 6e66 6967 7572 6162 6c65 4669    ConfigurableFi
+000005f0: 656c 642c 0a20 2020 2043 6f6e 6669 6775  eld,.    Configu
+00000600: 7261 626c 6546 6965 6c64 5370 6563 2c0a  rableFieldSpec,.
+00000610: 2020 2020 496e 7075 742c 0a20 2020 204f      Input,.    O
+00000620: 7574 7075 742c 0a20 2020 2061 6363 6570  utput,.    accep
+00000630: 7473 5f63 6f6e 6669 672c 0a20 2020 2061  ts_config,.    a
+00000640: 6363 6570 7473 5f63 6f6e 7465 7874 2c0a  ccepts_context,.
+00000650: 2020 2020 6163 6365 7074 735f 7275 6e5f      accepts_run_
+00000660: 6d61 6e61 6765 722c 0a20 2020 2063 7265  manager,.    cre
+00000670: 6174 655f 6d6f 6465 6c2c 0a20 2020 2067  ate_model,.    g
+00000680: 6174 6865 725f 7769 7468 5f63 6f6e 6375  ather_with_concu
+00000690: 7272 656e 6379 2c0a 2020 2020 6765 745f  rrency,.    get_
+000006a0: 6675 6e63 7469 6f6e 5f66 6972 7374 5f61  function_first_a
+000006b0: 7267 5f64 6963 745f 6b65 7973 2c0a 2020  rg_dict_keys,.  
+000006c0: 2020 6765 745f 6675 6e63 7469 6f6e 5f6e    get_function_n
+000006d0: 6f6e 6c6f 6361 6c73 2c0a 2020 2020 6765  onlocals,.    ge
+000006e0: 745f 6c61 6d62 6461 5f73 6f75 7263 652c  t_lambda_source,
+000006f0: 0a20 2020 2067 6574 5f75 6e69 7175 655f  .    get_unique_
+00000700: 636f 6e66 6967 5f73 7065 6373 2c0a 2020  config_specs,.  
+00000710: 2020 696e 6465 6e74 5f6c 696e 6573 5f61    indent_lines_a
+00000720: 6674 6572 5f66 6972 7374 2c0a 290a 6672  fter_first,.).fr
+00000730: 6f6d 206c 616e 6763 6861 696e 5f63 6f72  om langchain_cor
+00000740: 652e 7574 696c 732e 6169 7465 7220 696d  e.utils.aiter im
+00000750: 706f 7274 2061 7465 652c 2070 795f 616e  port atee, py_an
+00000760: 6578 740a 6672 6f6d 206c 616e 6763 6861  ext.from langcha
+00000770: 696e 5f63 6f72 652e 7574 696c 732e 6974  in_core.utils.it
+00000780: 6572 2069 6d70 6f72 7420 7361 6665 7465  er import safete
+00000790: 650a 0a69 6620 5459 5045 5f43 4845 434b  e..if TYPE_CHECK
+000007a0: 494e 473a 0a20 2020 2066 726f 6d20 6c61  ING:.    from la
+000007b0: 6e67 6368 6169 6e5f 636f 7265 2e63 616c  ngchain_core.cal
+000007c0: 6c62 6163 6b73 2e6d 616e 6167 6572 2069  lbacks.manager i
+000007d0: 6d70 6f72 7420 280a 2020 2020 2020 2020  mport (.        
+000007e0: 4173 796e 6343 616c 6c62 6163 6b4d 616e  AsyncCallbackMan
+000007f0: 6167 6572 466f 7243 6861 696e 5275 6e2c  agerForChainRun,
+00000800: 0a20 2020 2020 2020 2043 616c 6c62 6163  .        Callbac
+00000810: 6b4d 616e 6167 6572 466f 7243 6861 696e  kManagerForChain
+00000820: 5275 6e2c 0a20 2020 2029 0a20 2020 2066  Run,.    ).    f
+00000830: 726f 6d20 6c61 6e67 6368 6169 6e5f 636f  rom langchain_co
+00000840: 7265 2e70 726f 6d70 7473 2e62 6173 6520  re.prompts.base 
+00000850: 696d 706f 7274 2042 6173 6550 726f 6d70  import BasePromp
+00000860: 7454 656d 706c 6174 650a 2020 2020 6672  tTemplate.    fr
+00000870: 6f6d 206c 616e 6763 6861 696e 5f63 6f72  om langchain_cor
+00000880: 652e 7275 6e6e 6162 6c65 732e 6661 6c6c  e.runnables.fall
+00000890: 6261 636b 7320 696d 706f 7274 2028 0a20  backs import (. 
+000008a0: 2020 2020 2020 2052 756e 6e61 626c 6557         RunnableW
+000008b0: 6974 6846 616c 6c62 6163 6b73 2061 7320  ithFallbacks as 
+000008c0: 5275 6e6e 6162 6c65 5769 7468 4661 6c6c  RunnableWithFall
+000008d0: 6261 636b 7354 2c0a 2020 2020 290a 2020  backsT,.    ).  
+000008e0: 2020 6672 6f6d 206c 616e 6763 6861 696e    from langchain
+000008f0: 5f63 6f72 652e 7472 6163 6572 732e 6c6f  _core.tracers.lo
+00000900: 675f 7374 7265 616d 2069 6d70 6f72 7420  g_stream import 
+00000910: 280a 2020 2020 2020 2020 4c6f 6745 6e74  (.        LogEnt
+00000920: 7279 2c0a 2020 2020 2020 2020 5275 6e4c  ry,.        RunL
+00000930: 6f67 2c0a 2020 2020 2020 2020 5275 6e4c  og,.        RunL
+00000940: 6f67 5061 7463 682c 0a20 2020 2029 0a20  ogPatch,.    ). 
+00000950: 2020 2066 726f 6d20 6c61 6e67 6368 6169     from langchai
+00000960: 6e5f 636f 7265 2e74 7261 6365 7273 2e72  n_core.tracers.r
+00000970: 6f6f 745f 6c69 7374 656e 6572 7320 696d  oot_listeners im
+00000980: 706f 7274 204c 6973 7465 6e65 720a 0a0a  port Listener...
+00000990: 4f74 6865 7220 3d20 5479 7065 5661 7228  Other = TypeVar(
+000009a0: 224f 7468 6572 2229 0a0a 0a63 6c61 7373  "Other")...class
+000009b0: 2052 756e 6e61 626c 6528 4765 6e65 7269   Runnable(Generi
+000009c0: 635b 496e 7075 742c 204f 7574 7075 745d  c[Input, Output]
+000009d0: 2c20 4142 4329 3a0a 2020 2020 2222 2241  , ABC):.    """A
+000009e0: 2075 6e69 7420 6f66 2077 6f72 6b20 7468   unit of work th
+000009f0: 6174 2063 616e 2062 6520 696e 766f 6b65  at can be invoke
+00000a00: 642c 2062 6174 6368 6564 2c20 7374 7265  d, batched, stre
+00000a10: 616d 6564 2c20 7472 616e 7366 6f72 6d65  amed, transforme
+00000a20: 6420 616e 6420 636f 6d70 6f73 6564 2e0a  d and composed..
+00000a30: 0a20 2020 2020 4b65 7920 4d65 7468 6f64  .     Key Method
+00000a40: 730a 2020 2020 203d 3d3d 3d3d 3d3d 3d3d  s.     =========
+00000a50: 3d3d 0a0a 2020 2020 2d20 2a2a 696e 766f  ==..    - **invo
+00000a60: 6b65 2f61 696e 766f 6b65 2a2a 3a20 5472  ke/ainvoke**: Tr
+00000a70: 616e 7366 6f72 6d73 2061 2073 696e 676c  ansforms a singl
+00000a80: 6520 696e 7075 7420 696e 746f 2061 6e20  e input into an 
+00000a90: 6f75 7470 7574 2e0a 2020 2020 2d20 2a2a  output..    - **
+00000aa0: 6261 7463 682f 6162 6174 6368 2a2a 3a20  batch/abatch**: 
+00000ab0: 4566 6669 6369 656e 746c 7920 7472 616e  Efficiently tran
+00000ac0: 7366 6f72 6d73 206d 756c 7469 706c 6520  sforms multiple 
+00000ad0: 696e 7075 7473 2069 6e74 6f20 6f75 7470  inputs into outp
+00000ae0: 7574 732e 0a20 2020 202d 202a 2a73 7472  uts..    - **str
+00000af0: 6561 6d2f 6173 7472 6561 6d2a 2a3a 2053  eam/astream**: S
+00000b00: 7472 6561 6d73 206f 7574 7075 7420 6672  treams output fr
+00000b10: 6f6d 2061 2073 696e 676c 6520 696e 7075  om a single inpu
+00000b20: 7420 6173 2069 7427 7320 7072 6f64 7563  t as it's produc
+00000b30: 6564 2e0a 2020 2020 2d20 2a2a 6173 7472  ed..    - **astr
+00000b40: 6561 6d5f 6c6f 672a 2a3a 2053 7472 6561  eam_log**: Strea
+00000b50: 6d73 206f 7574 7075 7420 616e 6420 7365  ms output and se
+00000b60: 6c65 6374 6564 2069 6e74 6572 6d65 6469  lected intermedi
+00000b70: 6174 6520 7265 7375 6c74 7320 6672 6f6d  ate results from
+00000b80: 2061 6e20 696e 7075 742e 0a0a 2020 2020   an input...    
+00000b90: 4275 696c 742d 696e 206f 7074 696d 697a  Built-in optimiz
+00000ba0: 6174 696f 6e73 3a0a 0a20 2020 202d 202a  ations:..    - *
+00000bb0: 2a42 6174 6368 2a2a 3a20 4279 2064 6566  *Batch**: By def
+00000bc0: 6175 6c74 2c20 6261 7463 6820 7275 6e73  ault, batch runs
+00000bd0: 2069 6e76 6f6b 6528 2920 696e 2070 6172   invoke() in par
+00000be0: 616c 6c65 6c20 7573 696e 6720 6120 7468  allel using a th
+00000bf0: 7265 6164 2070 6f6f 6c20 6578 6563 7574  read pool execut
+00000c00: 6f72 2e0a 2020 2020 2020 2020 2020 2020  or..            
+00000c10: 204f 7665 7272 6964 6520 746f 206f 7074   Override to opt
+00000c20: 696d 697a 6520 6261 7463 6869 6e67 2e0a  imize batching..
+00000c30: 0a20 2020 202d 202a 2a41 7379 6e63 2a2a  .    - **Async**
+00000c40: 3a20 4d65 7468 6f64 7320 7769 7468 2022  : Methods with "
+00000c50: 6122 2073 7566 6669 7820 6172 6520 6173  a" suffix are as
+00000c60: 796e 6368 726f 6e6f 7573 2e20 4279 2064  ynchronous. By d
+00000c70: 6566 6175 6c74 2c20 7468 6579 2065 7865  efault, they exe
+00000c80: 6375 7465 0a20 2020 2020 2020 2020 2020  cute.           
+00000c90: 2020 7468 6520 7379 6e63 2063 6f75 6e74    the sync count
+00000ca0: 6572 7061 7274 2075 7369 6e67 2061 7379  erpart using asy
+00000cb0: 6e63 696f 2773 2074 6872 6561 6420 706f  ncio's thread po
+00000cc0: 6f6c 2e0a 2020 2020 2020 2020 2020 2020  ol..            
+00000cd0: 204f 7665 7272 6964 6520 666f 7220 6e61   Override for na
+00000ce0: 7469 7665 2061 7379 6e63 2e0a 0a20 2020  tive async...   
+00000cf0: 2041 6c6c 206d 6574 686f 6473 2061 6363   All methods acc
+00000d00: 6570 7420 616e 206f 7074 696f 6e61 6c20  ept an optional 
+00000d10: 636f 6e66 6967 2061 7267 756d 656e 742c  config argument,
+00000d20: 2077 6869 6368 2063 616e 2062 6520 7573   which can be us
+00000d30: 6564 2074 6f20 636f 6e66 6967 7572 650a  ed to configure.
+00000d40: 2020 2020 6578 6563 7574 696f 6e2c 2061      execution, a
+00000d50: 6464 2074 6167 7320 616e 6420 6d65 7461  dd tags and meta
+00000d60: 6461 7461 2066 6f72 2074 7261 6369 6e67  data for tracing
+00000d70: 2061 6e64 2064 6562 7567 6769 6e67 2065   and debugging e
+00000d80: 7463 2e0a 0a20 2020 2052 756e 6e61 626c  tc...    Runnabl
+00000d90: 6573 2065 7870 6f73 6520 7363 6865 6d61  es expose schema
+00000da0: 7469 6320 696e 666f 726d 6174 696f 6e20  tic information 
+00000db0: 6162 6f75 7420 7468 6569 7220 696e 7075  about their inpu
+00000dc0: 742c 206f 7574 7075 7420 616e 6420 636f  t, output and co
+00000dd0: 6e66 6967 2076 6961 0a20 2020 2074 6865  nfig via.    the
+00000de0: 2069 6e70 7574 5f73 6368 656d 6120 7072   input_schema pr
+00000df0: 6f70 6572 7479 2c20 7468 6520 6f75 7470  operty, the outp
+00000e00: 7574 5f73 6368 656d 6120 7072 6f70 6572  ut_schema proper
+00000e10: 7479 2061 6e64 2063 6f6e 6669 675f 7363  ty and config_sc
+00000e20: 6865 6d61 206d 6574 686f 642e 0a0a 2020  hema method...  
+00000e30: 2020 4c43 454c 2061 6e64 2043 6f6d 706f    LCEL and Compo
+00000e40: 7369 7469 6f6e 0a20 2020 203d 3d3d 3d3d  sition.    =====
+00000e50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
+00000e60: 0a20 2020 2054 6865 204c 616e 6743 6861  .    The LangCha
+00000e70: 696e 2045 7870 7265 7373 696f 6e20 4c61  in Expression La
+00000e80: 6e67 7561 6765 2028 4c43 454c 2920 6973  nguage (LCEL) is
+00000e90: 2061 2064 6563 6c61 7261 7469 7665 2077   a declarative w
+00000ea0: 6179 2074 6f20 636f 6d70 6f73 6520 5275  ay to compose Ru
+00000eb0: 6e6e 6162 6c65 730a 2020 2020 696e 746f  nnables.    into
+00000ec0: 2063 6861 696e 732e 2041 6e79 2063 6861   chains. Any cha
+00000ed0: 696e 2063 6f6e 7374 7275 6374 6564 2074  in constructed t
+00000ee0: 6869 7320 7761 7920 7769 6c6c 2061 7574  his way will aut
+00000ef0: 6f6d 6174 6963 616c 6c79 2068 6176 6520  omatically have 
+00000f00: 7379 6e63 2c20 6173 796e 632c 0a20 2020  sync, async,.   
+00000f10: 2062 6174 6368 2c20 616e 6420 7374 7265   batch, and stre
+00000f20: 616d 696e 6720 7375 7070 6f72 742e 0a0a  aming support...
+00000f30: 2020 2020 5468 6520 6d61 696e 2063 6f6d      The main com
+00000f40: 706f 7369 7469 6f6e 2070 7269 6d69 7469  position primiti
+00000f50: 7665 7320 6172 6520 5275 6e6e 6162 6c65  ves are Runnable
+00000f60: 5365 7175 656e 6365 2061 6e64 2052 756e  Sequence and Run
+00000f70: 6e61 626c 6550 6172 616c 6c65 6c2e 0a0a  nableParallel...
+00000f80: 2020 2020 5275 6e6e 6162 6c65 5365 7175      RunnableSequ
+00000f90: 656e 6365 2069 6e76 6f6b 6573 2061 2073  ence invokes a s
+00000fa0: 6572 6965 7320 6f66 2072 756e 6e61 626c  eries of runnabl
+00000fb0: 6573 2073 6571 7565 6e74 6961 6c6c 792c  es sequentially,
+00000fc0: 2077 6974 6820 6f6e 6520 7275 6e6e 6162   with one runnab
+00000fd0: 6c65 2773 0a20 2020 206f 7574 7075 7420  le's.    output 
+00000fe0: 7365 7276 696e 6720 6173 2074 6865 206e  serving as the n
+00000ff0: 6578 7427 7320 696e 7075 742e 2043 6f6e  ext's input. Con
+00001000: 7374 7275 6374 2075 7369 6e67 2074 6865  struct using the
+00001010: 2060 7c60 206f 7065 7261 746f 7220 6f72   `|` operator or
+00001020: 2062 790a 2020 2020 7061 7373 696e 6720   by.    passing 
+00001030: 6120 6c69 7374 206f 6620 7275 6e6e 6162  a list of runnab
+00001040: 6c65 7320 746f 2052 756e 6e61 626c 6553  les to RunnableS
+00001050: 6571 7565 6e63 652e 0a0a 2020 2020 5275  equence...    Ru
+00001060: 6e6e 6162 6c65 5061 7261 6c6c 656c 2069  nnableParallel i
+00001070: 6e76 6f6b 6573 2072 756e 6e61 626c 6573  nvokes runnables
+00001080: 2063 6f6e 6375 7272 656e 746c 792c 2070   concurrently, p
+00001090: 726f 7669 6469 6e67 2074 6865 2073 616d  roviding the sam
+000010a0: 6520 696e 7075 740a 2020 2020 746f 2065  e input.    to e
+000010b0: 6163 682e 2043 6f6e 7374 7275 6374 2069  ach. Construct i
+000010c0: 7420 7573 696e 6720 6120 6469 6374 206c  t using a dict l
+000010d0: 6974 6572 616c 2077 6974 6869 6e20 6120  iteral within a 
+000010e0: 7365 7175 656e 6365 206f 7220 6279 2070  sequence or by p
+000010f0: 6173 7369 6e67 2061 0a20 2020 2064 6963  assing a.    dic
+00001100: 7420 746f 2052 756e 6e61 626c 6550 6172  t to RunnablePar
+00001110: 616c 6c65 6c2e 0a0a 0a20 2020 2046 6f72  allel....    For
+00001120: 2065 7861 6d70 6c65 2c0a 0a20 2020 202e   example,..    .
+00001130: 2e20 636f 6465 2d62 6c6f 636b 3a3a 2070  . code-block:: p
+00001140: 7974 686f 6e0a 0a20 2020 2020 2020 2066  ython..        f
+00001150: 726f 6d20 6c61 6e67 6368 6169 6e5f 636f  rom langchain_co
+00001160: 7265 2e72 756e 6e61 626c 6573 2069 6d70  re.runnables imp
+00001170: 6f72 7420 5275 6e6e 6162 6c65 4c61 6d62  ort RunnableLamb
+00001180: 6461 0a0a 2020 2020 2020 2020 2320 4120  da..        # A 
+00001190: 5275 6e6e 6162 6c65 5365 7175 656e 6365  RunnableSequence
+000011a0: 2063 6f6e 7374 7275 6374 6564 2075 7369   constructed usi
+000011b0: 6e67 2074 6865 2060 7c60 206f 7065 7261  ng the `|` opera
+000011c0: 746f 720a 2020 2020 2020 2020 7365 7175  tor.        sequ
+000011d0: 656e 6365 203d 2052 756e 6e61 626c 654c  ence = RunnableL
+000011e0: 616d 6264 6128 6c61 6d62 6461 2078 3a20  ambda(lambda x: 
+000011f0: 7820 2b20 3129 207c 2052 756e 6e61 626c  x + 1) | Runnabl
+00001200: 654c 616d 6264 6128 6c61 6d62 6461 2078  eLambda(lambda x
+00001210: 3a20 7820 2a20 3229 0a20 2020 2020 2020  : x * 2).       
+00001220: 2073 6571 7565 6e63 652e 696e 766f 6b65   sequence.invoke
+00001230: 2831 2920 2320 340a 2020 2020 2020 2020  (1) # 4.        
+00001240: 7365 7175 656e 6365 2e62 6174 6368 285b  sequence.batch([
+00001250: 312c 2032 2c20 335d 2920 2320 5b34 2c20  1, 2, 3]) # [4, 
+00001260: 362c 2038 5d0a 0a0a 2020 2020 2020 2020  6, 8]...        
+00001270: 2320 4120 7365 7175 656e 6365 2074 6861  # A sequence tha
+00001280: 7420 636f 6e74 6169 6e73 2061 2052 756e  t contains a Run
+00001290: 6e61 626c 6550 6172 616c 6c65 6c20 636f  nableParallel co
+000012a0: 6e73 7472 7563 7465 6420 7573 696e 6720  nstructed using 
+000012b0: 6120 6469 6374 206c 6974 6572 616c 0a20  a dict literal. 
+000012c0: 2020 2020 2020 2073 6571 7565 6e63 6520         sequence 
+000012d0: 3d20 5275 6e6e 6162 6c65 4c61 6d62 6461  = RunnableLambda
+000012e0: 286c 616d 6264 6120 783a 2078 202b 2031  (lambda x: x + 1
+000012f0: 2920 7c20 7b0a 2020 2020 2020 2020 2020  ) | {.          
+00001300: 2020 276d 756c 5f32 273a 2052 756e 6e61    'mul_2': Runna
+00001310: 626c 654c 616d 6264 6128 6c61 6d62 6461  bleLambda(lambda
+00001320: 2078 3a20 7820 2a20 3229 2c0a 2020 2020   x: x * 2),.    
+00001330: 2020 2020 2020 2020 276d 756c 5f35 273a          'mul_5':
+00001340: 2052 756e 6e61 626c 654c 616d 6264 6128   RunnableLambda(
+00001350: 6c61 6d62 6461 2078 3a20 7820 2a20 3529  lambda x: x * 5)
+00001360: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+00001370: 2020 2073 6571 7565 6e63 652e 696e 766f     sequence.invo
+00001380: 6b65 2831 2920 2320 7b27 6d75 6c5f 3227  ke(1) # {'mul_2'
+00001390: 3a20 342c 2027 6d75 6c5f 3527 3a20 3130  : 4, 'mul_5': 10
+000013a0: 7d0a 0a20 2020 2053 7461 6e64 6172 6420  }..    Standard 
+000013b0: 4d65 7468 6f64 730a 2020 2020 3d3d 3d3d  Methods.    ====
+000013c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a 2020  ============..  
+000013d0: 2020 416c 6c20 5275 6e6e 6162 6c65 7320    All Runnables 
+000013e0: 6578 706f 7365 2061 6464 6974 696f 6e61  expose additiona
+000013f0: 6c20 6d65 7468 6f64 7320 7468 6174 2063  l methods that c
+00001400: 616e 2062 6520 7573 6564 2074 6f20 6d6f  an be used to mo
+00001410: 6469 6679 2074 6865 6972 2062 6568 6176  dify their behav
+00001420: 696f 720a 2020 2020 2865 2e67 2e2c 2061  ior.    (e.g., a
+00001430: 6464 2061 2072 6574 7279 2070 6f6c 6963  dd a retry polic
+00001440: 792c 2061 6464 206c 6966 6563 7963 6c65  y, add lifecycle
+00001450: 206c 6973 7465 6e65 7273 2c20 6d61 6b65   listeners, make
+00001460: 2074 6865 6d20 636f 6e66 6967 7572 6162   them configurab
+00001470: 6c65 2c20 6574 632e 292e 0a0a 2020 2020  le, etc.)...    
+00001480: 5468 6573 6520 6d65 7468 6f64 7320 7769  These methods wi
+00001490: 6c6c 2077 6f72 6b20 6f6e 2061 6e79 2052  ll work on any R
+000014a0: 756e 6e61 626c 652c 2069 6e63 6c75 6469  unnable, includi
+000014b0: 6e67 2052 756e 6e61 626c 6520 6368 6169  ng Runnable chai
+000014c0: 6e73 2063 6f6e 7374 7275 6374 6564 0a20  ns constructed. 
+000014d0: 2020 2062 7920 636f 6d70 6f73 696e 6720     by composing 
+000014e0: 6f74 6865 7220 5275 6e6e 6162 6c65 732e  other Runnables.
+000014f0: 2053 6565 2074 6865 2069 6e64 6976 6964   See the individ
+00001500: 7561 6c20 6d65 7468 6f64 7320 666f 7220  ual methods for 
+00001510: 6465 7461 696c 732e 0a0a 2020 2020 466f  details...    Fo
+00001520: 7220 6578 616d 706c 652c 0a0a 2020 2020  r example,..    
+00001530: 2e2e 2063 6f64 652d 626c 6f63 6b3a 3a20  .. code-block:: 
+00001540: 7079 7468 6f6e 0a0a 2020 2020 2020 2020  python..        
+00001550: 6672 6f6d 206c 616e 6763 6861 696e 5f63  from langchain_c
+00001560: 6f72 652e 7275 6e6e 6162 6c65 7320 696d  ore.runnables im
+00001570: 706f 7274 2052 756e 6e61 626c 654c 616d  port RunnableLam
+00001580: 6264 610a 0a20 2020 2020 2020 2069 6d70  bda..        imp
+00001590: 6f72 7420 7261 6e64 6f6d 0a0a 2020 2020  ort random..    
+000015a0: 2020 2020 6465 6620 6164 645f 6f6e 6528      def add_one(
+000015b0: 783a 2069 6e74 2920 2d3e 2069 6e74 3a0a  x: int) -> int:.
+000015c0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000015d0: 726e 2078 202b 2031 0a0a 0a20 2020 2020  rn x + 1...     
+000015e0: 2020 2064 6566 2062 7567 6779 5f64 6f75     def buggy_dou
+000015f0: 626c 6528 793a 2069 6e74 2920 2d3e 2069  ble(y: int) -> i
+00001600: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
+00001610: 2727 2742 7567 6779 2063 6f64 6520 7468  '''Buggy code th
+00001620: 6174 2077 696c 6c20 6661 696c 2037 3025  at will fail 70%
+00001630: 206f 6620 7468 6520 7469 6d65 2727 270a   of the time'''.
+00001640: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+00001650: 616e 646f 6d2e 7261 6e64 6f6d 2829 203e  andom.random() >
+00001660: 2030 2e33 3a0a 2020 2020 2020 2020 2020   0.3:.          
+00001670: 2020 2020 2020 7072 696e 7428 2754 6869        print('Thi
+00001680: 7320 636f 6465 2066 6169 6c65 642c 2061  s code failed, a
+00001690: 6e64 2077 696c 6c20 7072 6f62 6162 6c79  nd will probably
+000016a0: 2062 6520 7265 7472 6965 6421 2729 2020   be retried!')  
+000016b0: 2320 6e6f 7161 3a20 5432 3031 0a20 2020  # noqa: T201.   
+000016c0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+000016d0: 7365 2056 616c 7565 4572 726f 7228 2754  se ValueError('T
+000016e0: 7269 6767 6572 6564 2062 7567 6779 2063  riggered buggy c
+000016f0: 6f64 6527 290a 2020 2020 2020 2020 2020  ode').          
+00001700: 2020 7265 7475 726e 2079 202a 2032 0a0a    return y * 2..
+00001710: 2020 2020 2020 2020 7365 7175 656e 6365          sequence
+00001720: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+00001730: 2052 756e 6e61 626c 654c 616d 6264 6128   RunnableLambda(
+00001740: 6164 645f 6f6e 6529 207c 0a20 2020 2020  add_one) |.     
+00001750: 2020 2020 2020 2052 756e 6e61 626c 654c         RunnableL
+00001760: 616d 6264 6128 6275 6767 795f 646f 7562  ambda(buggy_doub
+00001770: 6c65 292e 7769 7468 5f72 6574 7279 2820  le).with_retry( 
+00001780: 2320 5265 7472 7920 6f6e 2066 6169 6c75  # Retry on failu
+00001790: 7265 0a20 2020 2020 2020 2020 2020 2020  re.             
+000017a0: 2020 2073 746f 705f 6166 7465 725f 6174     stop_after_at
+000017b0: 7465 6d70 743d 3130 2c0a 2020 2020 2020  tempt=10,.      
+000017c0: 2020 2020 2020 2020 2020 7761 6974 5f65            wait_e
+000017d0: 7870 6f6e 656e 7469 616c 5f6a 6974 7465  xponential_jitte
+000017e0: 723d 4661 6c73 650a 2020 2020 2020 2020  r=False.        
+000017f0: 2020 2020 290a 2020 2020 2020 2020 290a      ).        ).
+00001800: 0a20 2020 2020 2020 2070 7269 6e74 2873  .        print(s
+00001810: 6571 7565 6e63 652e 696e 7075 745f 7363  equence.input_sc
+00001820: 6865 6d61 2e73 6368 656d 6128 2929 2023  hema.schema()) #
+00001830: 2053 686f 7720 696e 6665 7272 6564 2069   Show inferred i
+00001840: 6e70 7574 2073 6368 656d 610a 2020 2020  nput schema.    
+00001850: 2020 2020 7072 696e 7428 7365 7175 656e      print(sequen
+00001860: 6365 2e6f 7574 7075 745f 7363 6865 6d61  ce.output_schema
+00001870: 2e73 6368 656d 6128 2929 2023 2053 686f  .schema()) # Sho
+00001880: 7720 696e 6665 7272 6564 206f 7574 7075  w inferred outpu
+00001890: 7420 7363 6865 6d61 0a20 2020 2020 2020  t schema.       
+000018a0: 2070 7269 6e74 2873 6571 7565 6e63 652e   print(sequence.
+000018b0: 696e 766f 6b65 2832 2929 2023 2069 6e76  invoke(2)) # inv
+000018c0: 6f6b 6520 7468 6520 7365 7175 656e 6365  oke the sequence
+000018d0: 2028 6e6f 7465 2074 6865 2072 6574 7279   (note the retry
+000018e0: 2061 626f 7665 2121 290a 0a20 2020 2044   above!!)..    D
+000018f0: 6562 7567 6769 6e67 2061 6e64 2074 7261  ebugging and tra
+00001900: 6369 6e67 0a20 2020 203d 3d3d 3d3d 3d3d  cing.    =======
+00001910: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a  ==============..
+00001920: 2020 2020 4173 2074 6865 2063 6861 696e      As the chain
+00001930: 7320 6765 7420 6c6f 6e67 6572 2c20 6974  s get longer, it
+00001940: 2063 616e 2062 6520 7573 6566 756c 2074   can be useful t
+00001950: 6f20 6265 2061 626c 6520 746f 2073 6565  o be able to see
+00001960: 2069 6e74 6572 6d65 6469 6174 6520 7265   intermediate re
+00001970: 7375 6c74 730a 2020 2020 746f 2064 6562  sults.    to deb
+00001980: 7567 2061 6e64 2074 7261 6365 2074 6865  ug and trace the
+00001990: 2063 6861 696e 2e0a 0a20 2020 2059 6f75   chain...    You
+000019a0: 2063 616e 2073 6574 2074 6865 2067 6c6f   can set the glo
+000019b0: 6261 6c20 6465 6275 6720 666c 6167 2074  bal debug flag t
+000019c0: 6f20 5472 7565 2074 6f20 656e 6162 6c65  o True to enable
+000019d0: 2064 6562 7567 206f 7574 7075 7420 666f   debug output fo
+000019e0: 7220 616c 6c20 6368 6169 6e73 3a0a 0a20  r all chains:.. 
+000019f0: 2020 2020 2020 202e 2e20 636f 6465 2d62         .. code-b
+00001a00: 6c6f 636b 3a3a 2070 7974 686f 6e0a 0a20  lock:: python.. 
+00001a10: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
+00001a20: 6c61 6e67 6368 6169 6e5f 636f 7265 2e67  langchain_core.g
+00001a30: 6c6f 6261 6c73 2069 6d70 6f72 7420 7365  lobals import se
+00001a40: 745f 6465 6275 670a 2020 2020 2020 2020  t_debug.        
+00001a50: 2020 2020 7365 745f 6465 6275 6728 5472      set_debug(Tr
+00001a60: 7565 290a 0a20 2020 2041 6c74 6572 6e61  ue)..    Alterna
+00001a70: 7469 7665 6c79 2c20 796f 7520 6361 6e20  tively, you can 
+00001a80: 7061 7373 2065 7869 7374 696e 6720 6f72  pass existing or
+00001a90: 2063 7573 746f 6d20 6361 6c6c 6261 636b   custom callback
+00001aa0: 7320 746f 2061 6e79 2067 6976 656e 2063  s to any given c
+00001ab0: 6861 696e 3a0a 0a20 2020 2020 2020 202e  hain:..        .
+00001ac0: 2e20 636f 6465 2d62 6c6f 636b 3a3a 2070  . code-block:: p
+00001ad0: 7974 686f 6e0a 0a20 2020 2020 2020 2020  ython..         
+00001ae0: 2020 2066 726f 6d20 6c61 6e67 6368 6169     from langchai
+00001af0: 6e5f 636f 7265 2e74 7261 6365 7273 2069  n_core.tracers i
+00001b00: 6d70 6f72 7420 436f 6e73 6f6c 6543 616c  mport ConsoleCal
+00001b10: 6c62 6163 6b48 616e 646c 6572 0a0a 2020  lbackHandler..  
+00001b20: 2020 2020 2020 2020 2020 6368 6169 6e2e            chain.
+00001b30: 696e 766f 6b65 280a 2020 2020 2020 2020  invoke(.        
+00001b40: 2020 2020 2020 2020 2e2e 2e2c 0a20 2020          ...,.   
+00001b50: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00001b60: 6669 673d 7b27 6361 6c6c 6261 636b 7327  fig={'callbacks'
+00001b70: 3a20 5b43 6f6e 736f 6c65 4361 6c6c 6261  : [ConsoleCallba
+00001b80: 636b 4861 6e64 6c65 7228 295d 7d0a 2020  ckHandler()]}.  
+00001b90: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00001ba0: 2046 6f72 2061 2055 4920 2861 6e64 206d   For a UI (and m
+00001bb0: 7563 6820 6d6f 7265 2920 6368 6563 6b6f  uch more) checko
+00001bc0: 7574 204c 616e 6753 6d69 7468 3a20 6874  ut LangSmith: ht
+00001bd0: 7470 733a 2f2f 646f 6373 2e73 6d69 7468  tps://docs.smith
+00001be0: 2e6c 616e 6763 6861 696e 2e63 6f6d 2f0a  .langchain.com/.
+00001bf0: 2020 2020 2222 2220 2023 206e 6f71 613a      """  # noqa:
+00001c00: 2045 3530 310a 0a20 2020 206e 616d 653a   E501..    name:
+00001c10: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
+00001c20: 204e 6f6e 650a 2020 2020 2222 2254 6865   None.    """The
+00001c30: 206e 616d 6520 6f66 2074 6865 2072 756e   name of the run
+00001c40: 6e61 626c 652e 2055 7365 6420 666f 7220  nable. Used for 
+00001c50: 6465 6275 6767 696e 6720 616e 6420 7472  debugging and tr
+00001c60: 6163 696e 672e 2222 220a 0a20 2020 2064  acing."""..    d
+00001c70: 6566 2067 6574 5f6e 616d 6528 0a20 2020  ef get_name(.   
+00001c80: 2020 2020 2073 656c 662c 2073 7566 6669       self, suffi
+00001c90: 783a 204f 7074 696f 6e61 6c5b 7374 725d  x: Optional[str]
+00001ca0: 203d 204e 6f6e 652c 202a 2c20 6e61 6d65   = None, *, name
+00001cb0: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+00001cc0: 3d20 4e6f 6e65 0a20 2020 2029 202d 3e20  = None.    ) -> 
+00001cd0: 7374 723a 0a20 2020 2020 2020 2022 2222  str:.        """
+00001ce0: 4765 7420 7468 6520 6e61 6d65 206f 6620  Get the name of 
+00001cf0: 7468 6520 7275 6e6e 6162 6c65 2e22 2222  the runnable."""
+00001d00: 0a20 2020 2020 2020 206e 616d 6520 3d20  .        name = 
+00001d10: 6e61 6d65 206f 7220 7365 6c66 2e6e 616d  name or self.nam
+00001d20: 6520 6f72 2073 656c 662e 5f5f 636c 6173  e or self.__clas
+00001d30: 735f 5f2e 5f5f 6e61 6d65 5f5f 0a20 2020  s__.__name__.   
+00001d40: 2020 2020 2069 6620 7375 6666 6978 3a0a       if suffix:.
+00001d50: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00001d60: 616d 655b 305d 2e69 7375 7070 6572 2829  ame[0].isupper()
+00001d70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00001d80: 2020 7265 7475 726e 206e 616d 6520 2b20    return name + 
+00001d90: 7375 6666 6978 2e74 6974 6c65 2829 0a20  suffix.title(). 
+00001da0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00001db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001dc0: 2072 6574 7572 6e20 6e61 6d65 202b 2022   return name + "
+00001dd0: 5f22 202b 2073 7566 6669 782e 6c6f 7765  _" + suffix.lowe
+00001de0: 7228 290a 2020 2020 2020 2020 656c 7365  r().        else
+00001df0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00001e00: 7475 726e 206e 616d 650a 0a20 2020 2040  turn name..    @
+00001e10: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+00001e20: 2049 6e70 7574 5479 7065 2873 656c 6629   InputType(self)
+00001e30: 202d 3e20 5479 7065 5b49 6e70 7574 5d3a   -> Type[Input]:
+00001e40: 0a20 2020 2020 2020 2022 2222 5468 6520  .        """The 
+00001e50: 7479 7065 206f 6620 696e 7075 7420 7468  type of input th
+00001e60: 6973 2072 756e 6e61 626c 6520 6163 6365  is runnable acce
+00001e70: 7074 7320 7370 6563 6966 6965 6420 6173  pts specified as
+00001e80: 2061 2074 7970 6520 616e 6e6f 7461 7469   a type annotati
+00001e90: 6f6e 2e22 2222 0a20 2020 2020 2020 2066  on.""".        f
+00001ea0: 6f72 2063 6c73 2069 6e20 7365 6c66 2e5f  or cls in self._
+00001eb0: 5f63 6c61 7373 5f5f 2e5f 5f6f 7269 675f  _class__.__orig_
+00001ec0: 6261 7365 735f 5f3a 2020 2320 7479 7065  bases__:  # type
+00001ed0: 3a20 6967 6e6f 7265 5b61 7474 722d 6465  : ignore[attr-de
+00001ee0: 6669 6e65 645d 0a20 2020 2020 2020 2020  fined].         
+00001ef0: 2020 2074 7970 655f 6172 6773 203d 2067     type_args = g
+00001f00: 6574 5f61 7267 7328 636c 7329 0a20 2020  et_args(cls).   
+00001f10: 2020 2020 2020 2020 2069 6620 7479 7065           if type
+00001f20: 5f61 7267 7320 616e 6420 6c65 6e28 7479  _args and len(ty
+00001f30: 7065 5f61 7267 7329 203d 3d20 323a 0a20  pe_args) == 2:. 
+00001f40: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00001f50: 6574 7572 6e20 7479 7065 5f61 7267 735b  eturn type_args[
+00001f60: 305d 0a0a 2020 2020 2020 2020 7261 6973  0]..        rais
+00001f70: 6520 5479 7065 4572 726f 7228 0a20 2020  e TypeError(.   
+00001f80: 2020 2020 2020 2020 2066 2252 756e 6e61           f"Runna
+00001f90: 626c 6520 7b73 656c 662e 6765 745f 6e61  ble {self.get_na
+00001fa0: 6d65 2829 7d20 646f 6573 6e27 7420 6861  me()} doesn't ha
+00001fb0: 7665 2061 6e20 696e 6665 7261 626c 6520  ve an inferable 
+00001fc0: 496e 7075 7454 7970 652e 2022 0a20 2020  InputType. ".   
+00001fd0: 2020 2020 2020 2020 2022 4f76 6572 7269           "Overri
+00001fe0: 6465 2074 6865 2049 6e70 7574 5479 7065  de the InputType
+00001ff0: 2070 726f 7065 7274 7920 746f 2073 7065   property to spe
+00002000: 6369 6679 2074 6865 2069 6e70 7574 2074  cify the input t
+00002010: 7970 652e 220a 2020 2020 2020 2020 290a  ype.".        ).
+00002020: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+00002030: 2020 2064 6566 204f 7574 7075 7454 7970     def OutputTyp
+00002040: 6528 7365 6c66 2920 2d3e 2054 7970 655b  e(self) -> Type[
+00002050: 4f75 7470 7574 5d3a 0a20 2020 2020 2020  Output]:.       
+00002060: 2022 2222 5468 6520 7479 7065 206f 6620   """The type of 
+00002070: 6f75 7470 7574 2074 6869 7320 7275 6e6e  output this runn
+00002080: 6162 6c65 2070 726f 6475 6365 7320 7370  able produces sp
+00002090: 6563 6966 6965 6420 6173 2061 2074 7970  ecified as a typ
+000020a0: 6520 616e 6e6f 7461 7469 6f6e 2e22 2222  e annotation."""
+000020b0: 0a20 2020 2020 2020 2066 6f72 2063 6c73  .        for cls
+000020c0: 2069 6e20 7365 6c66 2e5f 5f63 6c61 7373   in self.__class
+000020d0: 5f5f 2e5f 5f6f 7269 675f 6261 7365 735f  __.__orig_bases_
+000020e0: 5f3a 2020 2320 7479 7065 3a20 6967 6e6f  _:  # type: igno
+000020f0: 7265 5b61 7474 722d 6465 6669 6e65 645d  re[attr-defined]
+00002100: 0a20 2020 2020 2020 2020 2020 2074 7970  .            typ
+00002110: 655f 6172 6773 203d 2067 6574 5f61 7267  e_args = get_arg
+00002120: 7328 636c 7329 0a20 2020 2020 2020 2020  s(cls).         
+00002130: 2020 2069 6620 7479 7065 5f61 7267 7320     if type_args 
+00002140: 616e 6420 6c65 6e28 7479 7065 5f61 7267  and len(type_arg
+00002150: 7329 203d 3d20 323a 0a20 2020 2020 2020  s) == 2:.       
+00002160: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00002170: 7479 7065 5f61 7267 735b 315d 0a0a 2020  type_args[1]..  
+00002180: 2020 2020 2020 7261 6973 6520 5479 7065        raise Type
+00002190: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+000021a0: 2020 2066 2252 756e 6e61 626c 6520 7b73     f"Runnable {s
+000021b0: 656c 662e 6765 745f 6e61 6d65 2829 7d20  elf.get_name()} 
+000021c0: 646f 6573 6e27 7420 6861 7665 2061 6e20  doesn't have an 
+000021d0: 696e 6665 7261 626c 6520 4f75 7470 7574  inferable Output
+000021e0: 5479 7065 2e20 220a 2020 2020 2020 2020  Type. ".        
+000021f0: 2020 2020 224f 7665 7272 6964 6520 7468      "Override th
+00002200: 6520 4f75 7470 7574 5479 7065 2070 726f  e OutputType pro
+00002210: 7065 7274 7920 746f 2073 7065 6369 6679  perty to specify
+00002220: 2074 6865 206f 7574 7075 7420 7479 7065   the output type
+00002230: 2e22 0a20 2020 2020 2020 2029 0a0a 2020  .".        )..  
+00002240: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+00002250: 6465 6620 696e 7075 745f 7363 6865 6d61  def input_schema
+00002260: 2873 656c 6629 202d 3e20 5479 7065 5b42  (self) -> Type[B
+00002270: 6173 654d 6f64 656c 5d3a 0a20 2020 2020  aseModel]:.     
+00002280: 2020 2022 2222 5468 6520 7479 7065 206f     """The type o
+00002290: 6620 696e 7075 7420 7468 6973 2072 756e  f input this run
+000022a0: 6e61 626c 6520 6163 6365 7074 7320 7370  nable accepts sp
+000022b0: 6563 6966 6965 6420 6173 2061 2070 7964  ecified as a pyd
+000022c0: 616e 7469 6320 6d6f 6465 6c2e 2222 220a  antic model.""".
+000022d0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+000022e0: 656c 662e 6765 745f 696e 7075 745f 7363  elf.get_input_sc
+000022f0: 6865 6d61 2829 0a0a 2020 2020 6465 6620  hema()..    def 
+00002300: 6765 745f 696e 7075 745f 7363 6865 6d61  get_input_schema
+00002310: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+00002320: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
+00002330: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+00002340: 203d 204e 6f6e 650a 2020 2020 2920 2d3e   = None.    ) ->
+00002350: 2054 7970 655b 4261 7365 4d6f 6465 6c5d   Type[BaseModel]
+00002360: 3a0a 2020 2020 2020 2020 2222 2247 6574  :.        """Get
+00002370: 2061 2070 7964 616e 7469 6320 6d6f 6465   a pydantic mode
+00002380: 6c20 7468 6174 2063 616e 2062 6520 7573  l that can be us
+00002390: 6564 2074 6f20 7661 6c69 6461 7465 2069  ed to validate i
+000023a0: 6e70 7574 2074 6f20 7468 6520 7275 6e6e  nput to the runn
+000023b0: 6162 6c65 2e0a 0a20 2020 2020 2020 2052  able...        R
+000023c0: 756e 6e61 626c 6573 2074 6861 7420 6c65  unnables that le
+000023d0: 7665 7261 6765 2074 6865 2063 6f6e 6669  verage the confi
+000023e0: 6775 7261 626c 655f 6669 656c 6473 2061  gurable_fields a
+000023f0: 6e64 2063 6f6e 6669 6775 7261 626c 655f  nd configurable_
+00002400: 616c 7465 726e 6174 6976 6573 0a20 2020  alternatives.   
+00002410: 2020 2020 206d 6574 686f 6473 2077 696c       methods wil
+00002420: 6c20 6861 7665 2061 2064 796e 616d 6963  l have a dynamic
+00002430: 2069 6e70 7574 2073 6368 656d 6120 7468   input schema th
+00002440: 6174 2064 6570 656e 6473 206f 6e20 7768  at depends on wh
+00002450: 6963 680a 2020 2020 2020 2020 636f 6e66  ich.        conf
+00002460: 6967 7572 6174 696f 6e20 7468 6520 7275  iguration the ru
+00002470: 6e6e 6162 6c65 2069 7320 696e 766f 6b65  nnable is invoke
+00002480: 6420 7769 7468 2e0a 0a20 2020 2020 2020  d with...       
+00002490: 2054 6869 7320 6d65 7468 6f64 2061 6c6c   This method all
+000024a0: 6f77 7320 746f 2067 6574 2061 6e20 696e  ows to get an in
+000024b0: 7075 7420 7363 6865 6d61 2066 6f72 2061  put schema for a
+000024c0: 2073 7065 6369 6669 6320 636f 6e66 6967   specific config
+000024d0: 7572 6174 696f 6e2e 0a0a 2020 2020 2020  uration...      
+000024e0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+000024f0: 2020 2020 636f 6e66 6967 3a20 4120 636f      config: A co
+00002500: 6e66 6967 2074 6f20 7573 6520 7768 656e  nfig to use when
+00002510: 2067 656e 6572 6174 696e 6720 7468 6520   generating the 
+00002520: 7363 6865 6d61 2e0a 0a20 2020 2020 2020  schema...       
+00002530: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+00002540: 2020 2020 2020 4120 7079 6461 6e74 6963        A pydantic
+00002550: 206d 6f64 656c 2074 6861 7420 6361 6e20   model that can 
+00002560: 6265 2075 7365 6420 746f 2076 616c 6964  be used to valid
+00002570: 6174 6520 696e 7075 742e 0a20 2020 2020  ate input..     
+00002580: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+00002590: 6f6f 745f 7479 7065 203d 2073 656c 662e  oot_type = self.
+000025a0: 496e 7075 7454 7970 650a 0a20 2020 2020  InputType..     
+000025b0: 2020 2069 6620 696e 7370 6563 742e 6973     if inspect.is
+000025c0: 636c 6173 7328 726f 6f74 5f74 7970 6529  class(root_type)
+000025d0: 2061 6e64 2069 7373 7562 636c 6173 7328   and issubclass(
+000025e0: 726f 6f74 5f74 7970 652c 2042 6173 654d  root_type, BaseM
+000025f0: 6f64 656c 293a 0a20 2020 2020 2020 2020  odel):.         
+00002600: 2020 2072 6574 7572 6e20 726f 6f74 5f74     return root_t
+00002610: 7970 650a 0a20 2020 2020 2020 2072 6574  ype..        ret
+00002620: 7572 6e20 6372 6561 7465 5f6d 6f64 656c  urn create_model
+00002630: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+00002640: 6c66 2e67 6574 5f6e 616d 6528 2249 6e70  lf.get_name("Inp
+00002650: 7574 2229 2c0a 2020 2020 2020 2020 2020  ut"),.          
+00002660: 2020 5f5f 726f 6f74 5f5f 3d28 726f 6f74    __root__=(root
+00002670: 5f74 7970 652c 204e 6f6e 6529 2c0a 2020  _type, None),.  
+00002680: 2020 2020 2020 290a 0a20 2020 2040 7072        )..    @pr
+00002690: 6f70 6572 7479 0a20 2020 2064 6566 206f  operty.    def o
+000026a0: 7574 7075 745f 7363 6865 6d61 2873 656c  utput_schema(sel
+000026b0: 6629 202d 3e20 5479 7065 5b42 6173 654d  f) -> Type[BaseM
+000026c0: 6f64 656c 5d3a 0a20 2020 2020 2020 2022  odel]:.        "
+000026d0: 2222 5468 6520 7479 7065 206f 6620 6f75  ""The type of ou
+000026e0: 7470 7574 2074 6869 7320 7275 6e6e 6162  tput this runnab
+000026f0: 6c65 2070 726f 6475 6365 7320 7370 6563  le produces spec
+00002700: 6966 6965 6420 6173 2061 2070 7964 616e  ified as a pydan
+00002710: 7469 6320 6d6f 6465 6c2e 2222 220a 2020  tic model.""".  
+00002720: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00002730: 662e 6765 745f 6f75 7470 7574 5f73 6368  f.get_output_sch
+00002740: 656d 6128 290a 0a20 2020 2064 6566 2067  ema()..    def g
+00002750: 6574 5f6f 7574 7075 745f 7363 6865 6d61  et_output_schema
+00002760: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+00002770: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
+00002780: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+00002790: 203d 204e 6f6e 650a 2020 2020 2920 2d3e   = None.    ) ->
+000027a0: 2054 7970 655b 4261 7365 4d6f 6465 6c5d   Type[BaseModel]
+000027b0: 3a0a 2020 2020 2020 2020 2222 2247 6574  :.        """Get
+000027c0: 2061 2070 7964 616e 7469 6320 6d6f 6465   a pydantic mode
+000027d0: 6c20 7468 6174 2063 616e 2062 6520 7573  l that can be us
+000027e0: 6564 2074 6f20 7661 6c69 6461 7465 206f  ed to validate o
+000027f0: 7574 7075 7420 746f 2074 6865 2072 756e  utput to the run
+00002800: 6e61 626c 652e 0a0a 2020 2020 2020 2020  nable...        
+00002810: 5275 6e6e 6162 6c65 7320 7468 6174 206c  Runnables that l
+00002820: 6576 6572 6167 6520 7468 6520 636f 6e66  everage the conf
+00002830: 6967 7572 6162 6c65 5f66 6965 6c64 7320  igurable_fields 
+00002840: 616e 6420 636f 6e66 6967 7572 6162 6c65  and configurable
+00002850: 5f61 6c74 6572 6e61 7469 7665 730a 2020  _alternatives.  
+00002860: 2020 2020 2020 6d65 7468 6f64 7320 7769        methods wi
+00002870: 6c6c 2068 6176 6520 6120 6479 6e61 6d69  ll have a dynami
+00002880: 6320 6f75 7470 7574 2073 6368 656d 6120  c output schema 
+00002890: 7468 6174 2064 6570 656e 6473 206f 6e20  that depends on 
+000028a0: 7768 6963 680a 2020 2020 2020 2020 636f  which.        co
+000028b0: 6e66 6967 7572 6174 696f 6e20 7468 6520  nfiguration the 
+000028c0: 7275 6e6e 6162 6c65 2069 7320 696e 766f  runnable is invo
+000028d0: 6b65 6420 7769 7468 2e0a 0a20 2020 2020  ked with...     
+000028e0: 2020 2054 6869 7320 6d65 7468 6f64 2061     This method a
+000028f0: 6c6c 6f77 7320 746f 2067 6574 2061 6e20  llows to get an 
+00002900: 6f75 7470 7574 2073 6368 656d 6120 666f  output schema fo
+00002910: 7220 6120 7370 6563 6966 6963 2063 6f6e  r a specific con
+00002920: 6669 6775 7261 7469 6f6e 2e0a 0a20 2020  figuration...   
+00002930: 2020 2020 2041 7267 733a 0a20 2020 2020       Args:.     
+00002940: 2020 2020 2020 2063 6f6e 6669 673a 2041         config: A
+00002950: 2063 6f6e 6669 6720 746f 2075 7365 2077   config to use w
+00002960: 6865 6e20 6765 6e65 7261 7469 6e67 2074  hen generating t
+00002970: 6865 2073 6368 656d 612e 0a0a 2020 2020  he schema...    
+00002980: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+00002990: 2020 2020 2020 2020 2041 2070 7964 616e           A pydan
+000029a0: 7469 6320 6d6f 6465 6c20 7468 6174 2063  tic model that c
+000029b0: 616e 2062 6520 7573 6564 2074 6f20 7661  an be used to va
+000029c0: 6c69 6461 7465 206f 7574 7075 742e 0a20  lidate output.. 
+000029d0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000029e0: 2020 2072 6f6f 745f 7479 7065 203d 2073     root_type = s
+000029f0: 656c 662e 4f75 7470 7574 5479 7065 0a0a  elf.OutputType..
+00002a00: 2020 2020 2020 2020 6966 2069 6e73 7065          if inspe
+00002a10: 6374 2e69 7363 6c61 7373 2872 6f6f 745f  ct.isclass(root_
+00002a20: 7479 7065 2920 616e 6420 6973 7375 6263  type) and issubc
+00002a30: 6c61 7373 2872 6f6f 745f 7479 7065 2c20  lass(root_type, 
+00002a40: 4261 7365 4d6f 6465 6c29 3a0a 2020 2020  BaseModel):.    
+00002a50: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+00002a60: 6f6f 745f 7479 7065 0a0a 2020 2020 2020  oot_type..      
+00002a70: 2020 7265 7475 726e 2063 7265 6174 655f    return create_
+00002a80: 6d6f 6465 6c28 0a20 2020 2020 2020 2020  model(.         
+00002a90: 2020 2073 656c 662e 6765 745f 6e61 6d65     self.get_name
+00002aa0: 2822 4f75 7470 7574 2229 2c0a 2020 2020  ("Output"),.    
+00002ab0: 2020 2020 2020 2020 5f5f 726f 6f74 5f5f          __root__
+00002ac0: 3d28 726f 6f74 5f74 7970 652c 204e 6f6e  =(root_type, Non
+00002ad0: 6529 2c0a 2020 2020 2020 2020 290a 0a20  e),.        ).. 
+00002ae0: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+00002af0: 2064 6566 2063 6f6e 6669 675f 7370 6563   def config_spec
+00002b00: 7328 7365 6c66 2920 2d3e 204c 6973 745b  s(self) -> List[
+00002b10: 436f 6e66 6967 7572 6162 6c65 4669 656c  ConfigurableFiel
+00002b20: 6453 7065 635d 3a0a 2020 2020 2020 2020  dSpec]:.        
+00002b30: 2222 224c 6973 7420 636f 6e66 6967 7572  """List configur
+00002b40: 6162 6c65 2066 6965 6c64 7320 666f 7220  able fields for 
+00002b50: 7468 6973 2072 756e 6e61 626c 652e 2222  this runnable.""
+00002b60: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
+00002b70: 205b 5d0a 0a20 2020 2064 6566 2063 6f6e   []..    def con
+00002b80: 6669 675f 7363 6865 6d61 280a 2020 2020  fig_schema(.    
+00002b90: 2020 2020 7365 6c66 2c20 2a2c 2069 6e63      self, *, inc
+00002ba0: 6c75 6465 3a20 4f70 7469 6f6e 616c 5b53  lude: Optional[S
+00002bb0: 6571 7565 6e63 655b 7374 725d 5d20 3d20  equence[str]] = 
+00002bc0: 4e6f 6e65 0a20 2020 2029 202d 3e20 5479  None.    ) -> Ty
+00002bd0: 7065 5b42 6173 654d 6f64 656c 5d3a 0a20  pe[BaseModel]:. 
+00002be0: 2020 2020 2020 2022 2222 5468 6520 7479         """The ty
+00002bf0: 7065 206f 6620 636f 6e66 6967 2074 6869  pe of config thi
+00002c00: 7320 7275 6e6e 6162 6c65 2061 6363 6570  s runnable accep
+00002c10: 7473 2073 7065 6369 6669 6564 2061 7320  ts specified as 
+00002c20: 6120 7079 6461 6e74 6963 206d 6f64 656c  a pydantic model
+00002c30: 2e0a 0a20 2020 2020 2020 2054 6f20 6d61  ...        To ma
+00002c40: 726b 2061 2066 6965 6c64 2061 7320 636f  rk a field as co
+00002c50: 6e66 6967 7572 6162 6c65 2c20 7365 6520  nfigurable, see 
+00002c60: 7468 6520 6063 6f6e 6669 6775 7261 626c  the `configurabl
+00002c70: 655f 6669 656c 6473 600a 2020 2020 2020  e_fields`.      
+00002c80: 2020 616e 6420 6063 6f6e 6669 6775 7261    and `configura
+00002c90: 626c 655f 616c 7465 726e 6174 6976 6573  ble_alternatives
+00002ca0: 6020 6d65 7468 6f64 732e 0a0a 2020 2020  ` methods...    
+00002cb0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00002cc0: 2020 2020 2020 696e 636c 7564 653a 2041        include: A
+00002cd0: 206c 6973 7420 6f66 2066 6965 6c64 7320   list of fields 
+00002ce0: 746f 2069 6e63 6c75 6465 2069 6e20 7468  to include in th
+00002cf0: 6520 636f 6e66 6967 2073 6368 656d 612e  e config schema.
+00002d00: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+00002d10: 733a 0a20 2020 2020 2020 2020 2020 2041  s:.            A
+00002d20: 2070 7964 616e 7469 6320 6d6f 6465 6c20   pydantic model 
+00002d30: 7468 6174 2063 616e 2062 6520 7573 6564  that can be used
+00002d40: 2074 6f20 7661 6c69 6461 7465 2063 6f6e   to validate con
+00002d50: 6669 672e 0a20 2020 2020 2020 2022 2222  fig..        """
+00002d60: 0a0a 2020 2020 2020 2020 696e 636c 7564  ..        includ
+00002d70: 6520 3d20 696e 636c 7564 6520 6f72 205b  e = include or [
+00002d80: 5d0a 2020 2020 2020 2020 636f 6e66 6967  ].        config
+00002d90: 5f73 7065 6373 203d 2073 656c 662e 636f  _specs = self.co
+00002da0: 6e66 6967 5f73 7065 6373 0a20 2020 2020  nfig_specs.     
+00002db0: 2020 2063 6f6e 6669 6775 7261 626c 6520     configurable 
+00002dc0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+00002dd0: 6372 6561 7465 5f6d 6f64 656c 2820 2023  create_model(  #
+00002de0: 2074 7970 653a 2069 676e 6f72 655b 6361   type: ignore[ca
+00002df0: 6c6c 2d6f 7665 726c 6f61 645d 0a20 2020  ll-overload].   
+00002e00: 2020 2020 2020 2020 2020 2020 2022 436f               "Co
+00002e10: 6e66 6967 7572 6162 6c65 222c 0a20 2020  nfigurable",.   
+00002e20: 2020 2020 2020 2020 2020 2020 202a 2a7b               **{
+00002e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002e40: 2020 2020 2073 7065 632e 6964 3a20 280a       spec.id: (.
+00002e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002e60: 2020 2020 2020 2020 7370 6563 2e61 6e6e          spec.ann
+00002e70: 6f74 6174 696f 6e2c 0a20 2020 2020 2020  otation,.       
+00002e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002e90: 2046 6965 6c64 280a 2020 2020 2020 2020   Field(.        
 00002ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002eb0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00002ec0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00002ed0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00002ee0: 2073 7065 6320 696e 2063 6f6e 6669 675f   spec in config_
-00002ef0: 7370 6563 730a 2020 2020 2020 2020 2020  specs.          
-00002f00: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-00002f10: 2020 2020 2020 2020 205f 5f63 6f6e 6669           __confi
-00002f20: 675f 5f3d 5f53 6368 656d 6143 6f6e 6669  g__=_SchemaConfi
-00002f30: 672c 0a20 2020 2020 2020 2020 2020 2029  g,.            )
-00002f40: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00002f50: 636f 6e66 6967 5f73 7065 6373 0a20 2020  config_specs.   
-00002f60: 2020 2020 2020 2020 2065 6c73 6520 4e6f           else No
-00002f70: 6e65 0a20 2020 2020 2020 2029 0a0a 2020  ne.        )..  
-00002f80: 2020 2020 2020 7265 7475 726e 2063 7265        return cre
-00002f90: 6174 655f 6d6f 6465 6c28 2020 2320 7479  ate_model(  # ty
-00002fa0: 7065 3a20 6967 6e6f 7265 5b63 616c 6c2d  pe: ignore[call-
-00002fb0: 6f76 6572 6c6f 6164 5d0a 2020 2020 2020  overload].      
-00002fc0: 2020 2020 2020 7365 6c66 2e67 6574 5f6e        self.get_n
-00002fd0: 616d 6528 2243 6f6e 6669 6722 292c 0a20  ame("Config"),. 
-00002fe0: 2020 2020 2020 2020 2020 205f 5f63 6f6e             __con
-00002ff0: 6669 675f 5f3d 5f53 6368 656d 6143 6f6e  fig__=_SchemaCon
-00003000: 6669 672c 0a20 2020 2020 2020 2020 2020  fig,.           
-00003010: 202a 2a28 7b22 636f 6e66 6967 7572 6162   **({"configurab
-00003020: 6c65 223a 2028 636f 6e66 6967 7572 6162  le": (configurab
-00003030: 6c65 2c20 4e6f 6e65 297d 2069 6620 636f  le, None)} if co
-00003040: 6e66 6967 7572 6162 6c65 2065 6c73 6520  nfigurable else 
-00003050: 7b7d 292c 0a20 2020 2020 2020 2020 2020  {}),.           
-00003060: 202a 2a7b 0a20 2020 2020 2020 2020 2020   **{.           
-00003070: 2020 2020 2066 6965 6c64 5f6e 616d 653a       field_name:
-00003080: 2028 6669 656c 645f 7479 7065 2c20 4e6f   (field_type, No
-00003090: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
-000030a0: 2020 2020 666f 7220 6669 656c 645f 6e61      for field_na
-000030b0: 6d65 2c20 6669 656c 645f 7479 7065 2069  me, field_type i
-000030c0: 6e20 5275 6e6e 6162 6c65 436f 6e66 6967  n RunnableConfig
-000030d0: 2e5f 5f61 6e6e 6f74 6174 696f 6e73 5f5f  .__annotations__
-000030e0: 2e69 7465 6d73 2829 0a20 2020 2020 2020  .items().       
-000030f0: 2020 2020 2020 2020 2069 6620 6669 656c           if fiel
-00003100: 645f 6e61 6d65 2069 6e20 5b69 2066 6f72  d_name in [i for
-00003110: 2069 2069 6e20 696e 636c 7564 6520 6966   i in include if
-00003120: 2069 2021 3d20 2263 6f6e 6669 6775 7261   i != "configura
-00003130: 626c 6522 5d0a 2020 2020 2020 2020 2020  ble"].          
-00003140: 2020 7d2c 0a20 2020 2020 2020 2029 0a0a    },.        )..
-00003150: 2020 2020 6465 6620 6765 745f 6772 6170      def get_grap
-00003160: 6828 7365 6c66 2c20 636f 6e66 6967 3a20  h(self, config: 
-00003170: 4f70 7469 6f6e 616c 5b52 756e 6e61 626c  Optional[Runnabl
-00003180: 6543 6f6e 6669 675d 203d 204e 6f6e 6529  eConfig] = None)
-00003190: 202d 3e20 4772 6170 683a 0a20 2020 2020   -> Graph:.     
-000031a0: 2020 2022 2222 5265 7475 726e 2061 2067     """Return a g
-000031b0: 7261 7068 2072 6570 7265 7365 6e74 6174  raph representat
-000031c0: 696f 6e20 6f66 2074 6869 7320 7275 6e6e  ion of this runn
-000031d0: 6162 6c65 2e22 2222 0a20 2020 2020 2020  able.""".       
-000031e0: 2066 726f 6d20 6c61 6e67 6368 6169 6e5f   from langchain_
-000031f0: 636f 7265 2e72 756e 6e61 626c 6573 2e67  core.runnables.g
-00003200: 7261 7068 2069 6d70 6f72 7420 4772 6170  raph import Grap
-00003210: 680a 0a20 2020 2020 2020 2067 7261 7068  h..        graph
-00003220: 203d 2047 7261 7068 2829 0a20 2020 2020   = Graph().     
-00003230: 2020 2069 6e70 7574 5f6e 6f64 6520 3d20     input_node = 
-00003240: 6772 6170 682e 6164 645f 6e6f 6465 2873  graph.add_node(s
-00003250: 656c 662e 6765 745f 696e 7075 745f 7363  elf.get_input_sc
-00003260: 6865 6d61 2863 6f6e 6669 6729 290a 2020  hema(config)).  
-00003270: 2020 2020 2020 7275 6e6e 6162 6c65 5f6e        runnable_n
-00003280: 6f64 6520 3d20 6772 6170 682e 6164 645f  ode = graph.add_
-00003290: 6e6f 6465 2873 656c 6629 0a20 2020 2020  node(self).     
-000032a0: 2020 206f 7574 7075 745f 6e6f 6465 203d     output_node =
-000032b0: 2067 7261 7068 2e61 6464 5f6e 6f64 6528   graph.add_node(
-000032c0: 7365 6c66 2e67 6574 5f6f 7574 7075 745f  self.get_output_
-000032d0: 7363 6865 6d61 2863 6f6e 6669 6729 290a  schema(config)).
-000032e0: 2020 2020 2020 2020 6772 6170 682e 6164          graph.ad
-000032f0: 645f 6564 6765 2869 6e70 7574 5f6e 6f64  d_edge(input_nod
-00003300: 652c 2072 756e 6e61 626c 655f 6e6f 6465  e, runnable_node
-00003310: 290a 2020 2020 2020 2020 6772 6170 682e  ).        graph.
-00003320: 6164 645f 6564 6765 2872 756e 6e61 626c  add_edge(runnabl
-00003330: 655f 6e6f 6465 2c20 6f75 7470 7574 5f6e  e_node, output_n
-00003340: 6f64 6529 0a20 2020 2020 2020 2072 6574  ode).        ret
-00003350: 7572 6e20 6772 6170 680a 0a20 2020 2064  urn graph..    d
-00003360: 6566 2067 6574 5f70 726f 6d70 7473 280a  ef get_prompts(.
-00003370: 2020 2020 2020 2020 7365 6c66 2c20 636f          self, co
-00003380: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
-00003390: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
-000033a0: 204e 6f6e 650a 2020 2020 2920 2d3e 204c   None.    ) -> L
-000033b0: 6973 745b 4261 7365 5072 6f6d 7074 5465  ist[BasePromptTe
-000033c0: 6d70 6c61 7465 5d3a 0a20 2020 2020 2020  mplate]:.       
-000033d0: 2066 726f 6d20 6c61 6e67 6368 6169 6e5f   from langchain_
-000033e0: 636f 7265 2e70 726f 6d70 7473 2e62 6173  core.prompts.bas
-000033f0: 6520 696d 706f 7274 2042 6173 6550 726f  e import BasePro
-00003400: 6d70 7454 656d 706c 6174 650a 0a20 2020  mptTemplate..   
-00003410: 2020 2020 2070 726f 6d70 7473 203d 205b       prompts = [
-00003420: 5d0a 2020 2020 2020 2020 666f 7220 5f2c  ].        for _,
-00003430: 206e 6f64 6520 696e 2073 656c 662e 6765   node in self.ge
-00003440: 745f 6772 6170 6828 636f 6e66 6967 3d63  t_graph(config=c
-00003450: 6f6e 6669 6729 2e6e 6f64 6573 2e69 7465  onfig).nodes.ite
-00003460: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-00003470: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00003480: 6e6f 6465 2e64 6174 612c 2042 6173 6550  node.data, BaseP
-00003490: 726f 6d70 7454 656d 706c 6174 6529 3a0a  romptTemplate):.
-000034a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000034b0: 7072 6f6d 7074 732e 6170 7065 6e64 286e  prompts.append(n
-000034c0: 6f64 652e 6461 7461 290a 2020 2020 2020  ode.data).      
-000034d0: 2020 7265 7475 726e 2070 726f 6d70 7473    return prompts
-000034e0: 0a0a 2020 2020 6465 6620 5f5f 6f72 5f5f  ..    def __or__
-000034f0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00003500: 2020 2020 2020 2020 6f74 6865 723a 2055          other: U
-00003510: 6e69 6f6e 5b0a 2020 2020 2020 2020 2020  nion[.          
-00003520: 2020 5275 6e6e 6162 6c65 5b41 6e79 2c20    Runnable[Any, 
-00003530: 4f74 6865 725d 2c0a 2020 2020 2020 2020  Other],.        
-00003540: 2020 2020 4361 6c6c 6162 6c65 5b5b 416e      Callable[[An
-00003550: 795d 2c20 4f74 6865 725d 2c0a 2020 2020  y], Other],.    
-00003560: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
-00003570: 5b5b 4974 6572 6174 6f72 5b41 6e79 5d5d  [[Iterator[Any]]
-00003580: 2c20 4974 6572 6174 6f72 5b4f 7468 6572  , Iterator[Other
-00003590: 5d5d 2c0a 2020 2020 2020 2020 2020 2020  ]],.            
-000035a0: 4d61 7070 696e 675b 7374 722c 2055 6e69  Mapping[str, Uni
-000035b0: 6f6e 5b52 756e 6e61 626c 655b 416e 792c  on[Runnable[Any,
-000035c0: 204f 7468 6572 5d2c 2043 616c 6c61 626c   Other], Callabl
-000035d0: 655b 5b41 6e79 5d2c 204f 7468 6572 5d2c  e[[Any], Other],
-000035e0: 2041 6e79 5d5d 2c0a 2020 2020 2020 2020   Any]],.        
-000035f0: 5d2c 0a20 2020 2029 202d 3e20 5275 6e6e  ],.    ) -> Runn
-00003600: 6162 6c65 5365 7269 616c 697a 6162 6c65  ableSerializable
-00003610: 5b49 6e70 7574 2c20 4f74 6865 725d 3a0a  [Input, Other]:.
-00003620: 2020 2020 2020 2020 2222 2243 6f6d 706f          """Compo
-00003630: 7365 2074 6869 7320 7275 6e6e 6162 6c65  se this runnable
-00003640: 2077 6974 6820 616e 6f74 6865 7220 6f62   with another ob
-00003650: 6a65 6374 2074 6f20 6372 6561 7465 2061  ject to create a
-00003660: 2052 756e 6e61 626c 6553 6571 7565 6e63   RunnableSequenc
-00003670: 652e 2222 220a 2020 2020 2020 2020 7265  e.""".        re
-00003680: 7475 726e 2052 756e 6e61 626c 6553 6571  turn RunnableSeq
-00003690: 7565 6e63 6528 7365 6c66 2c20 636f 6572  uence(self, coer
-000036a0: 6365 5f74 6f5f 7275 6e6e 6162 6c65 286f  ce_to_runnable(o
-000036b0: 7468 6572 2929 0a0a 2020 2020 6465 6620  ther))..    def 
-000036c0: 5f5f 726f 725f 5f28 0a20 2020 2020 2020  __ror__(.       
-000036d0: 2073 656c 662c 0a20 2020 2020 2020 206f   self,.        o
-000036e0: 7468 6572 3a20 556e 696f 6e5b 0a20 2020  ther: Union[.   
-000036f0: 2020 2020 2020 2020 2052 756e 6e61 626c           Runnabl
-00003700: 655b 4f74 6865 722c 2041 6e79 5d2c 0a20  e[Other, Any],. 
-00003710: 2020 2020 2020 2020 2020 2043 616c 6c61             Calla
-00003720: 626c 655b 5b4f 7468 6572 5d2c 2041 6e79  ble[[Other], Any
-00003730: 5d2c 0a20 2020 2020 2020 2020 2020 2043  ],.            C
-00003740: 616c 6c61 626c 655b 5b49 7465 7261 746f  allable[[Iterato
-00003750: 725b 4f74 6865 725d 5d2c 2049 7465 7261  r[Other]], Itera
-00003760: 746f 725b 416e 795d 5d2c 0a20 2020 2020  tor[Any]],.     
-00003770: 2020 2020 2020 204d 6170 7069 6e67 5b73         Mapping[s
-00003780: 7472 2c20 556e 696f 6e5b 5275 6e6e 6162  tr, Union[Runnab
-00003790: 6c65 5b4f 7468 6572 2c20 416e 795d 2c20  le[Other, Any], 
-000037a0: 4361 6c6c 6162 6c65 5b5b 4f74 6865 725d  Callable[[Other]
-000037b0: 2c20 416e 795d 2c20 416e 795d 5d2c 0a20  , Any], Any]],. 
-000037c0: 2020 2020 2020 205d 2c0a 2020 2020 2920         ],.    ) 
-000037d0: 2d3e 2052 756e 6e61 626c 6553 6572 6961  -> RunnableSeria
-000037e0: 6c69 7a61 626c 655b 4f74 6865 722c 204f  lizable[Other, O
-000037f0: 7574 7075 745d 3a0a 2020 2020 2020 2020  utput]:.        
-00003800: 2222 2243 6f6d 706f 7365 2074 6869 7320  """Compose this 
-00003810: 7275 6e6e 6162 6c65 2077 6974 6820 616e  runnable with an
-00003820: 6f74 6865 7220 6f62 6a65 6374 2074 6f20  other object to 
-00003830: 6372 6561 7465 2061 2052 756e 6e61 626c  create a Runnabl
-00003840: 6553 6571 7565 6e63 652e 2222 220a 2020  eSequence.""".  
-00003850: 2020 2020 2020 7265 7475 726e 2052 756e        return Run
-00003860: 6e61 626c 6553 6571 7565 6e63 6528 636f  nableSequence(co
-00003870: 6572 6365 5f74 6f5f 7275 6e6e 6162 6c65  erce_to_runnable
-00003880: 286f 7468 6572 292c 2073 656c 6629 0a0a  (other), self)..
-00003890: 2020 2020 6465 6620 7069 7065 280a 2020      def pipe(.  
-000038a0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-000038b0: 2020 2020 2a6f 7468 6572 733a 2055 6e69      *others: Uni
-000038c0: 6f6e 5b52 756e 6e61 626c 655b 416e 792c  on[Runnable[Any,
-000038d0: 204f 7468 6572 5d2c 2043 616c 6c61 626c   Other], Callabl
-000038e0: 655b 5b41 6e79 5d2c 204f 7468 6572 5d5d  e[[Any], Other]]
-000038f0: 2c0a 2020 2020 2020 2020 6e61 6d65 3a20  ,.        name: 
-00003900: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
-00003910: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 2052  None,.    ) -> R
-00003920: 756e 6e61 626c 6553 6572 6961 6c69 7a61  unnableSerializa
-00003930: 626c 655b 496e 7075 742c 204f 7468 6572  ble[Input, Other
-00003940: 5d3a 0a20 2020 2020 2020 2022 2222 436f  ]:.        """Co
-00003950: 6d70 6f73 6520 7468 6973 2072 756e 6e61  mpose this runna
-00003960: 626c 6520 7769 7468 2061 6e6f 7468 6572  ble with another
-00003970: 206f 626a 6563 7420 746f 2063 7265 6174   object to creat
-00003980: 6520 6120 5275 6e6e 6162 6c65 5365 7175  e a RunnableSequ
-00003990: 656e 6365 2e22 2222 0a20 2020 2020 2020  ence.""".       
-000039a0: 2072 6574 7572 6e20 5275 6e6e 6162 6c65   return Runnable
-000039b0: 5365 7175 656e 6365 2873 656c 662c 202a  Sequence(self, *
-000039c0: 6f74 6865 7273 2c20 6e61 6d65 3d6e 616d  others, name=nam
-000039d0: 6529 0a0a 2020 2020 6465 6620 7069 636b  e)..    def pick
-000039e0: 2873 656c 662c 206b 6579 733a 2055 6e69  (self, keys: Uni
-000039f0: 6f6e 5b73 7472 2c20 4c69 7374 5b73 7472  on[str, List[str
-00003a00: 5d5d 2920 2d3e 2052 756e 6e61 626c 6553  ]]) -> RunnableS
-00003a10: 6572 6961 6c69 7a61 626c 655b 416e 792c  erializable[Any,
-00003a20: 2041 6e79 5d3a 0a20 2020 2020 2020 2022   Any]:.        "
-00003a30: 2222 5069 636b 206b 6579 7320 6672 6f6d  ""Pick keys from
-00003a40: 2074 6865 2064 6963 7420 6f75 7470 7574   the dict output
-00003a50: 206f 6620 7468 6973 2072 756e 6e61 626c   of this runnabl
-00003a60: 652e 0a20 2020 2020 2020 2052 6574 7572  e..        Retur
-00003a70: 6e73 2061 206e 6577 2072 756e 6e61 626c  ns a new runnabl
-00003a80: 652e 2222 220a 2020 2020 2020 2020 6672  e.""".        fr
-00003a90: 6f6d 206c 616e 6763 6861 696e 5f63 6f72  om langchain_cor
-00003aa0: 652e 7275 6e6e 6162 6c65 732e 7061 7373  e.runnables.pass
-00003ab0: 7468 726f 7567 6820 696d 706f 7274 2052  through import R
-00003ac0: 756e 6e61 626c 6550 6963 6b0a 0a20 2020  unnablePick..   
-00003ad0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00003ae0: 207c 2052 756e 6e61 626c 6550 6963 6b28   | RunnablePick(
-00003af0: 6b65 7973 290a 0a20 2020 2064 6566 2061  keys)..    def a
-00003b00: 7373 6967 6e28 0a20 2020 2020 2020 2073  ssign(.        s
-00003b10: 656c 662c 0a20 2020 2020 2020 202a 2a6b  elf,.        **k
-00003b20: 7761 7267 733a 2055 6e69 6f6e 5b0a 2020  wargs: Union[.  
-00003b30: 2020 2020 2020 2020 2020 5275 6e6e 6162            Runnab
-00003b40: 6c65 5b44 6963 745b 7374 722c 2041 6e79  le[Dict[str, Any
-00003b50: 5d2c 2041 6e79 5d2c 0a20 2020 2020 2020  ], Any],.       
-00003b60: 2020 2020 2043 616c 6c61 626c 655b 5b44       Callable[[D
-00003b70: 6963 745b 7374 722c 2041 6e79 5d5d 2c20  ict[str, Any]], 
-00003b80: 416e 795d 2c0a 2020 2020 2020 2020 2020  Any],.          
-00003b90: 2020 4d61 7070 696e 675b 0a20 2020 2020    Mapping[.     
-00003ba0: 2020 2020 2020 2020 2020 2073 7472 2c0a             str,.
+00002eb0: 2020 2020 7370 6563 2e64 6566 6175 6c74      spec.default
+00002ec0: 2c20 7469 746c 653d 7370 6563 2e6e 616d  , title=spec.nam
+00002ed0: 652c 2064 6573 6372 6970 7469 6f6e 3d73  e, description=s
+00002ee0: 7065 632e 6465 7363 7269 7074 696f 6e0a  pec.description.
+00002ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002f00: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
+00002f10: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00002f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002f30: 2020 2020 2066 6f72 2073 7065 6320 696e       for spec in
+00002f40: 2063 6f6e 6669 675f 7370 6563 730a 2020   config_specs.  
+00002f50: 2020 2020 2020 2020 2020 2020 2020 7d2c                },
+00002f60: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00002f70: 2020 2020 2020 2020 2020 2069 6620 636f             if co
+00002f80: 6e66 6967 5f73 7065 6373 0a20 2020 2020  nfig_specs.     
+00002f90: 2020 2020 2020 2065 6c73 6520 4e6f 6e65         else None
+00002fa0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00002fb0: 2020 2020 7265 7475 726e 2063 7265 6174      return creat
+00002fc0: 655f 6d6f 6465 6c28 2020 2320 7479 7065  e_model(  # type
+00002fd0: 3a20 6967 6e6f 7265 5b63 616c 6c2d 6f76  : ignore[call-ov
+00002fe0: 6572 6c6f 6164 5d0a 2020 2020 2020 2020  erload].        
+00002ff0: 2020 2020 7365 6c66 2e67 6574 5f6e 616d      self.get_nam
+00003000: 6528 2243 6f6e 6669 6722 292c 0a20 2020  e("Config"),.   
+00003010: 2020 2020 2020 2020 202a 2a28 7b22 636f           **({"co
+00003020: 6e66 6967 7572 6162 6c65 223a 2028 636f  nfigurable": (co
+00003030: 6e66 6967 7572 6162 6c65 2c20 4e6f 6e65  nfigurable, None
+00003040: 297d 2069 6620 636f 6e66 6967 7572 6162  )} if configurab
+00003050: 6c65 2065 6c73 6520 7b7d 292c 0a20 2020  le else {}),.   
+00003060: 2020 2020 2020 2020 202a 2a7b 0a20 2020           **{.   
+00003070: 2020 2020 2020 2020 2020 2020 2066 6965               fie
+00003080: 6c64 5f6e 616d 653a 2028 6669 656c 645f  ld_name: (field_
+00003090: 7479 7065 2c20 4e6f 6e65 290a 2020 2020  type, None).    
+000030a0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000030b0: 6669 656c 645f 6e61 6d65 2c20 6669 656c  field_name, fiel
+000030c0: 645f 7479 7065 2069 6e20 5275 6e6e 6162  d_type in Runnab
+000030d0: 6c65 436f 6e66 6967 2e5f 5f61 6e6e 6f74  leConfig.__annot
+000030e0: 6174 696f 6e73 5f5f 2e69 7465 6d73 2829  ations__.items()
+000030f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003100: 2069 6620 6669 656c 645f 6e61 6d65 2069   if field_name i
+00003110: 6e20 5b69 2066 6f72 2069 2069 6e20 696e  n [i for i in in
+00003120: 636c 7564 6520 6966 2069 2021 3d20 2263  clude if i != "c
+00003130: 6f6e 6669 6775 7261 626c 6522 5d0a 2020  onfigurable"].  
+00003140: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+00003150: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+00003160: 6765 745f 6772 6170 6828 7365 6c66 2c20  get_graph(self, 
+00003170: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
+00003180: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+00003190: 203d 204e 6f6e 6529 202d 3e20 4772 6170   = None) -> Grap
+000031a0: 683a 0a20 2020 2020 2020 2022 2222 5265  h:.        """Re
+000031b0: 7475 726e 2061 2067 7261 7068 2072 6570  turn a graph rep
+000031c0: 7265 7365 6e74 6174 696f 6e20 6f66 2074  resentation of t
+000031d0: 6869 7320 7275 6e6e 6162 6c65 2e22 2222  his runnable."""
+000031e0: 0a20 2020 2020 2020 2066 726f 6d20 6c61  .        from la
+000031f0: 6e67 6368 6169 6e5f 636f 7265 2e72 756e  ngchain_core.run
+00003200: 6e61 626c 6573 2e67 7261 7068 2069 6d70  nables.graph imp
+00003210: 6f72 7420 4772 6170 680a 0a20 2020 2020  ort Graph..     
+00003220: 2020 2067 7261 7068 203d 2047 7261 7068     graph = Graph
+00003230: 2829 0a20 2020 2020 2020 2069 6e70 7574  ().        input
+00003240: 5f6e 6f64 6520 3d20 6772 6170 682e 6164  _node = graph.ad
+00003250: 645f 6e6f 6465 2873 656c 662e 6765 745f  d_node(self.get_
+00003260: 696e 7075 745f 7363 6865 6d61 2863 6f6e  input_schema(con
+00003270: 6669 6729 290a 2020 2020 2020 2020 7275  fig)).        ru
+00003280: 6e6e 6162 6c65 5f6e 6f64 6520 3d20 6772  nnable_node = gr
+00003290: 6170 682e 6164 645f 6e6f 6465 2873 656c  aph.add_node(sel
+000032a0: 6629 0a20 2020 2020 2020 206f 7574 7075  f).        outpu
+000032b0: 745f 6e6f 6465 203d 2067 7261 7068 2e61  t_node = graph.a
+000032c0: 6464 5f6e 6f64 6528 7365 6c66 2e67 6574  dd_node(self.get
+000032d0: 5f6f 7574 7075 745f 7363 6865 6d61 2863  _output_schema(c
+000032e0: 6f6e 6669 6729 290a 2020 2020 2020 2020  onfig)).        
+000032f0: 6772 6170 682e 6164 645f 6564 6765 2869  graph.add_edge(i
+00003300: 6e70 7574 5f6e 6f64 652c 2072 756e 6e61  nput_node, runna
+00003310: 626c 655f 6e6f 6465 290a 2020 2020 2020  ble_node).      
+00003320: 2020 6772 6170 682e 6164 645f 6564 6765    graph.add_edge
+00003330: 2872 756e 6e61 626c 655f 6e6f 6465 2c20  (runnable_node, 
+00003340: 6f75 7470 7574 5f6e 6f64 6529 0a20 2020  output_node).   
+00003350: 2020 2020 2072 6574 7572 6e20 6772 6170       return grap
+00003360: 680a 0a20 2020 2064 6566 2067 6574 5f70  h..    def get_p
+00003370: 726f 6d70 7473 280a 2020 2020 2020 2020  rompts(.        
+00003380: 7365 6c66 2c20 636f 6e66 6967 3a20 4f70  self, config: Op
+00003390: 7469 6f6e 616c 5b52 756e 6e61 626c 6543  tional[RunnableC
+000033a0: 6f6e 6669 675d 203d 204e 6f6e 650a 2020  onfig] = None.  
+000033b0: 2020 2920 2d3e 204c 6973 745b 4261 7365    ) -> List[Base
+000033c0: 5072 6f6d 7074 5465 6d70 6c61 7465 5d3a  PromptTemplate]:
+000033d0: 0a20 2020 2020 2020 2066 726f 6d20 6c61  .        from la
+000033e0: 6e67 6368 6169 6e5f 636f 7265 2e70 726f  ngchain_core.pro
+000033f0: 6d70 7473 2e62 6173 6520 696d 706f 7274  mpts.base import
+00003400: 2042 6173 6550 726f 6d70 7454 656d 706c   BasePromptTempl
+00003410: 6174 650a 0a20 2020 2020 2020 2070 726f  ate..        pro
+00003420: 6d70 7473 203d 205b 5d0a 2020 2020 2020  mpts = [].      
+00003430: 2020 666f 7220 5f2c 206e 6f64 6520 696e    for _, node in
+00003440: 2073 656c 662e 6765 745f 6772 6170 6828   self.get_graph(
+00003450: 636f 6e66 6967 3d63 6f6e 6669 6729 2e6e  config=config).n
+00003460: 6f64 6573 2e69 7465 6d73 2829 3a0a 2020  odes.items():.  
+00003470: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
+00003480: 6e73 7461 6e63 6528 6e6f 6465 2e64 6174  nstance(node.dat
+00003490: 612c 2042 6173 6550 726f 6d70 7454 656d  a, BasePromptTem
+000034a0: 706c 6174 6529 3a0a 2020 2020 2020 2020  plate):.        
+000034b0: 2020 2020 2020 2020 7072 6f6d 7074 732e          prompts.
+000034c0: 6170 7065 6e64 286e 6f64 652e 6461 7461  append(node.data
+000034d0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+000034e0: 2070 726f 6d70 7473 0a0a 2020 2020 6465   prompts..    de
+000034f0: 6620 5f5f 6f72 5f5f 280a 2020 2020 2020  f __or__(.      
+00003500: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00003510: 6f74 6865 723a 2055 6e69 6f6e 5b0a 2020  other: Union[.  
+00003520: 2020 2020 2020 2020 2020 5275 6e6e 6162            Runnab
+00003530: 6c65 5b41 6e79 2c20 4f74 6865 725d 2c0a  le[Any, Other],.
+00003540: 2020 2020 2020 2020 2020 2020 4361 6c6c              Call
+00003550: 6162 6c65 5b5b 416e 795d 2c20 4f74 6865  able[[Any], Othe
+00003560: 725d 2c0a 2020 2020 2020 2020 2020 2020  r],.            
+00003570: 4361 6c6c 6162 6c65 5b5b 4974 6572 6174  Callable[[Iterat
+00003580: 6f72 5b41 6e79 5d5d 2c20 4974 6572 6174  or[Any]], Iterat
+00003590: 6f72 5b4f 7468 6572 5d5d 2c0a 2020 2020  or[Other]],.    
+000035a0: 2020 2020 2020 2020 4d61 7070 696e 675b          Mapping[
+000035b0: 7374 722c 2055 6e69 6f6e 5b52 756e 6e61  str, Union[Runna
+000035c0: 626c 655b 416e 792c 204f 7468 6572 5d2c  ble[Any, Other],
+000035d0: 2043 616c 6c61 626c 655b 5b41 6e79 5d2c   Callable[[Any],
+000035e0: 204f 7468 6572 5d2c 2041 6e79 5d5d 2c0a   Other], Any]],.
+000035f0: 2020 2020 2020 2020 5d2c 0a20 2020 2029          ],.    )
+00003600: 202d 3e20 5275 6e6e 6162 6c65 5365 7269   -> RunnableSeri
+00003610: 616c 697a 6162 6c65 5b49 6e70 7574 2c20  alizable[Input, 
+00003620: 4f74 6865 725d 3a0a 2020 2020 2020 2020  Other]:.        
+00003630: 2222 2243 6f6d 706f 7365 2074 6869 7320  """Compose this 
+00003640: 7275 6e6e 6162 6c65 2077 6974 6820 616e  runnable with an
+00003650: 6f74 6865 7220 6f62 6a65 6374 2074 6f20  other object to 
+00003660: 6372 6561 7465 2061 2052 756e 6e61 626c  create a Runnabl
+00003670: 6553 6571 7565 6e63 652e 2222 220a 2020  eSequence.""".  
+00003680: 2020 2020 2020 7265 7475 726e 2052 756e        return Run
+00003690: 6e61 626c 6553 6571 7565 6e63 6528 7365  nableSequence(se
+000036a0: 6c66 2c20 636f 6572 6365 5f74 6f5f 7275  lf, coerce_to_ru
+000036b0: 6e6e 6162 6c65 286f 7468 6572 2929 0a0a  nnable(other))..
+000036c0: 2020 2020 6465 6620 5f5f 726f 725f 5f28      def __ror__(
+000036d0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+000036e0: 2020 2020 2020 206f 7468 6572 3a20 556e         other: Un
+000036f0: 696f 6e5b 0a20 2020 2020 2020 2020 2020  ion[.           
+00003700: 2052 756e 6e61 626c 655b 4f74 6865 722c   Runnable[Other,
+00003710: 2041 6e79 5d2c 0a20 2020 2020 2020 2020   Any],.         
+00003720: 2020 2043 616c 6c61 626c 655b 5b4f 7468     Callable[[Oth
+00003730: 6572 5d2c 2041 6e79 5d2c 0a20 2020 2020  er], Any],.     
+00003740: 2020 2020 2020 2043 616c 6c61 626c 655b         Callable[
+00003750: 5b49 7465 7261 746f 725b 4f74 6865 725d  [Iterator[Other]
+00003760: 5d2c 2049 7465 7261 746f 725b 416e 795d  ], Iterator[Any]
+00003770: 5d2c 0a20 2020 2020 2020 2020 2020 204d  ],.            M
+00003780: 6170 7069 6e67 5b73 7472 2c20 556e 696f  apping[str, Unio
+00003790: 6e5b 5275 6e6e 6162 6c65 5b4f 7468 6572  n[Runnable[Other
+000037a0: 2c20 416e 795d 2c20 4361 6c6c 6162 6c65  , Any], Callable
+000037b0: 5b5b 4f74 6865 725d 2c20 416e 795d 2c20  [[Other], Any], 
+000037c0: 416e 795d 5d2c 0a20 2020 2020 2020 205d  Any]],.        ]
+000037d0: 2c0a 2020 2020 2920 2d3e 2052 756e 6e61  ,.    ) -> Runna
+000037e0: 626c 6553 6572 6961 6c69 7a61 626c 655b  bleSerializable[
+000037f0: 4f74 6865 722c 204f 7574 7075 745d 3a0a  Other, Output]:.
+00003800: 2020 2020 2020 2020 2222 2243 6f6d 706f          """Compo
+00003810: 7365 2074 6869 7320 7275 6e6e 6162 6c65  se this runnable
+00003820: 2077 6974 6820 616e 6f74 6865 7220 6f62   with another ob
+00003830: 6a65 6374 2074 6f20 6372 6561 7465 2061  ject to create a
+00003840: 2052 756e 6e61 626c 6553 6571 7565 6e63   RunnableSequenc
+00003850: 652e 2222 220a 2020 2020 2020 2020 7265  e.""".        re
+00003860: 7475 726e 2052 756e 6e61 626c 6553 6571  turn RunnableSeq
+00003870: 7565 6e63 6528 636f 6572 6365 5f74 6f5f  uence(coerce_to_
+00003880: 7275 6e6e 6162 6c65 286f 7468 6572 292c  runnable(other),
+00003890: 2073 656c 6629 0a0a 2020 2020 6465 6620   self)..    def 
+000038a0: 7069 7065 280a 2020 2020 2020 2020 7365  pipe(.        se
+000038b0: 6c66 2c0a 2020 2020 2020 2020 2a6f 7468  lf,.        *oth
+000038c0: 6572 733a 2055 6e69 6f6e 5b52 756e 6e61  ers: Union[Runna
+000038d0: 626c 655b 416e 792c 204f 7468 6572 5d2c  ble[Any, Other],
+000038e0: 2043 616c 6c61 626c 655b 5b41 6e79 5d2c   Callable[[Any],
+000038f0: 204f 7468 6572 5d5d 2c0a 2020 2020 2020   Other]],.      
+00003900: 2020 6e61 6d65 3a20 4f70 7469 6f6e 616c    name: Optional
+00003910: 5b73 7472 5d20 3d20 4e6f 6e65 2c0a 2020  [str] = None,.  
+00003920: 2020 2920 2d3e 2052 756e 6e61 626c 6553    ) -> RunnableS
+00003930: 6572 6961 6c69 7a61 626c 655b 496e 7075  erializable[Inpu
+00003940: 742c 204f 7468 6572 5d3a 0a20 2020 2020  t, Other]:.     
+00003950: 2020 2022 2222 436f 6d70 6f73 6520 7468     """Compose th
+00003960: 6973 2052 756e 6e61 626c 6520 7769 7468  is Runnable with
+00003970: 2052 756e 6e61 626c 652d 6c69 6b65 206f   Runnable-like o
+00003980: 626a 6563 7473 2074 6f20 6d61 6b65 2061  bjects to make a
+00003990: 2052 756e 6e61 626c 6553 6571 7565 6e63   RunnableSequenc
+000039a0: 652e 0a0a 2020 2020 2020 2020 4571 7569  e...        Equi
+000039b0: 7661 6c65 6e74 2074 6f20 6052 756e 6e61  valent to `Runna
+000039c0: 626c 6553 6571 7565 6e63 6528 7365 6c66  bleSequence(self
+000039d0: 2c20 2a6f 7468 6572 7329 6020 6f72 2060  , *others)` or `
+000039e0: 7365 6c66 207c 206f 7468 6572 735b 305d  self | others[0]
+000039f0: 207c 202e 2e2e 600a 0a20 2020 2020 2020   | ...`..       
+00003a00: 2045 7861 6d70 6c65 3a0a 2020 2020 2020   Example:.      
+00003a10: 2020 2020 2020 2e2e 2063 6f64 652d 626c        .. code-bl
+00003a20: 6f63 6b3a 3a20 7079 7468 6f6e 0a0a 2020  ock:: python..  
+00003a30: 2020 2020 2020 2020 2020 2020 2020 6672                fr
+00003a40: 6f6d 206c 616e 6763 6861 696e 5f63 6f72  om langchain_cor
+00003a50: 652e 7275 6e6e 6162 6c65 7320 696d 706f  e.runnables impo
+00003a60: 7274 2052 756e 6e61 626c 654c 616d 6264  rt RunnableLambd
+00003a70: 610a 0a20 2020 2020 2020 2020 2020 2020  a..             
+00003a80: 2020 2064 6566 2061 6464 5f6f 6e65 2878     def add_one(x
+00003a90: 3a20 696e 7429 202d 3e20 696e 743a 0a20  : int) -> int:. 
+00003aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ab0: 2020 2072 6574 7572 6e20 7820 2b20 310a     return x + 1.
+00003ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003ad0: 2064 6566 206d 756c 5f74 776f 2878 3a20   def mul_two(x: 
+00003ae0: 696e 7429 202d 3e20 696e 743a 0a20 2020  int) -> int:.   
+00003af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003b00: 2072 6574 7572 6e20 7820 2a20 320a 0a20   return x * 2.. 
+00003b10: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00003b20: 756e 6e61 626c 655f 3120 3d20 5275 6e6e  unnable_1 = Runn
+00003b30: 6162 6c65 4c61 6d62 6461 2861 6464 5f6f  ableLambda(add_o
+00003b40: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
+00003b50: 2020 2020 7275 6e6e 6162 6c65 5f32 203d      runnable_2 =
+00003b60: 2052 756e 6e61 626c 654c 616d 6264 6128   RunnableLambda(
+00003b70: 6d75 6c5f 7477 6f29 0a20 2020 2020 2020  mul_two).       
+00003b80: 2020 2020 2020 2020 2073 6571 7565 6e63           sequenc
+00003b90: 6520 3d20 7275 6e6e 6162 6c65 5f31 2e70  e = runnable_1.p
+00003ba0: 6970 6528 7275 6e6e 6162 6c65 5f32 290a  ipe(runnable_2).
 00003bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003bc0: 556e 696f 6e5b 5275 6e6e 6162 6c65 5b44  Union[Runnable[D
-00003bd0: 6963 745b 7374 722c 2041 6e79 5d2c 2041  ict[str, Any], A
-00003be0: 6e79 5d2c 2043 616c 6c61 626c 655b 5b44  ny], Callable[[D
-00003bf0: 6963 745b 7374 722c 2041 6e79 5d5d 2c20  ict[str, Any]], 
-00003c00: 416e 795d 5d2c 0a20 2020 2020 2020 2020  Any]],.         
-00003c10: 2020 205d 2c0a 2020 2020 2020 2020 5d2c     ],.        ],
-00003c20: 0a20 2020 2029 202d 3e20 5275 6e6e 6162  .    ) -> Runnab
-00003c30: 6c65 5365 7269 616c 697a 6162 6c65 5b41  leSerializable[A
-00003c40: 6e79 2c20 416e 795d 3a0a 2020 2020 2020  ny, Any]:.      
-00003c50: 2020 2222 2241 7373 6967 6e73 206e 6577    """Assigns new
-00003c60: 2066 6965 6c64 7320 746f 2074 6865 2064   fields to the d
-00003c70: 6963 7420 6f75 7470 7574 206f 6620 7468  ict output of th
-00003c80: 6973 2072 756e 6e61 626c 652e 0a20 2020  is runnable..   
-00003c90: 2020 2020 2052 6574 7572 6e73 2061 206e       Returns a n
-00003ca0: 6577 2072 756e 6e61 626c 652e 2222 220a  ew runnable.""".
-00003cb0: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
-00003cc0: 6763 6861 696e 5f63 6f72 652e 7275 6e6e  gchain_core.runn
-00003cd0: 6162 6c65 732e 7061 7373 7468 726f 7567  ables.passthroug
-00003ce0: 6820 696d 706f 7274 2052 756e 6e61 626c  h import Runnabl
-00003cf0: 6541 7373 6967 6e0a 0a20 2020 2020 2020  eAssign..       
-00003d00: 2072 6574 7572 6e20 7365 6c66 207c 2052   return self | R
-00003d10: 756e 6e61 626c 6541 7373 6967 6e28 5275  unnableAssign(Ru
-00003d20: 6e6e 6162 6c65 5061 7261 6c6c 656c 286b  nnableParallel(k
-00003d30: 7761 7267 7329 290a 0a20 2020 2022 2222  wargs))..    """
-00003d40: 202d 2d2d 2050 7562 6c69 6320 4150 4920   --- Public API 
-00003d50: 2d2d 2d20 2222 220a 0a20 2020 2040 6162  --- """..    @ab
-00003d60: 7374 7261 6374 6d65 7468 6f64 0a20 2020  stractmethod.   
-00003d70: 2064 6566 2069 6e76 6f6b 6528 7365 6c66   def invoke(self
-00003d80: 2c20 696e 7075 743a 2049 6e70 7574 2c20  , input: Input, 
-00003d90: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
-00003da0: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
-00003db0: 203d 204e 6f6e 6529 202d 3e20 4f75 7470   = None) -> Outp
-00003dc0: 7574 3a0a 2020 2020 2020 2020 2222 2254  ut:.        """T
-00003dd0: 7261 6e73 666f 726d 2061 2073 696e 676c  ransform a singl
-00003de0: 6520 696e 7075 7420 696e 746f 2061 6e20  e input into an 
-00003df0: 6f75 7470 7574 2e20 4f76 6572 7269 6465  output. Override
-00003e00: 2074 6f20 696d 706c 656d 656e 742e 0a0a   to implement...
-00003e10: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
-00003e20: 2020 2020 2020 2020 2020 696e 7075 743a            input:
-00003e30: 2054 6865 2069 6e70 7574 2074 6f20 7468   The input to th
-00003e40: 6520 7275 6e6e 6162 6c65 2e0a 2020 2020  e runnable..    
-00003e50: 2020 2020 2020 2020 636f 6e66 6967 3a20          config: 
-00003e60: 4120 636f 6e66 6967 2074 6f20 7573 6520  A config to use 
-00003e70: 7768 656e 2069 6e76 6f6b 696e 6720 7468  when invoking th
-00003e80: 6520 7275 6e6e 6162 6c65 2e0a 2020 2020  e runnable..    
-00003e90: 2020 2020 2020 2020 2020 2054 6865 2063             The c
-00003ea0: 6f6e 6669 6720 7375 7070 6f72 7473 2073  onfig supports s
-00003eb0: 7461 6e64 6172 6420 6b65 7973 206c 696b  tandard keys lik
-00003ec0: 6520 2774 6167 7327 2c20 276d 6574 6164  e 'tags', 'metad
-00003ed0: 6174 6127 2066 6f72 2074 7261 6369 6e67  ata' for tracing
-00003ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003ef0: 7075 7270 6f73 6573 2c20 276d 6178 5f63  purposes, 'max_c
-00003f00: 6f6e 6375 7272 656e 6379 2720 666f 7220  oncurrency' for 
-00003f10: 636f 6e74 726f 6c6c 696e 6720 686f 7720  controlling how 
-00003f20: 6d75 6368 2077 6f72 6b20 746f 2064 6f0a  much work to do.
-00003f30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00003f40: 6e20 7061 7261 6c6c 656c 2c20 616e 6420  n parallel, and 
-00003f50: 6f74 6865 7220 6b65 7973 2e20 506c 6561  other keys. Plea
-00003f60: 7365 2072 6566 6572 2074 6f20 7468 6520  se refer to the 
-00003f70: 5275 6e6e 6162 6c65 436f 6e66 6967 0a20  RunnableConfig. 
-00003f80: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00003f90: 7220 6d6f 7265 2064 6574 6169 6c73 2e0a  r more details..
-00003fa0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-00003fb0: 3a0a 2020 2020 2020 2020 2020 2020 5468  :.            Th
-00003fc0: 6520 6f75 7470 7574 206f 6620 7468 6520  e output of the 
-00003fd0: 7275 6e6e 6162 6c65 2e0a 2020 2020 2020  runnable..      
-00003fe0: 2020 2222 220a 0a20 2020 2061 7379 6e63    """..    async
-00003ff0: 2064 6566 2061 696e 766f 6b65 280a 2020   def ainvoke(.  
-00004000: 2020 2020 2020 7365 6c66 2c20 696e 7075        self, inpu
-00004010: 743a 2049 6e70 7574 2c20 636f 6e66 6967  t: Input, config
-00004020: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
-00004030: 626c 6543 6f6e 6669 675d 203d 204e 6f6e  bleConfig] = Non
-00004040: 652c 202a 2a6b 7761 7267 733a 2041 6e79  e, **kwargs: Any
-00004050: 0a20 2020 2029 202d 3e20 4f75 7470 7574  .    ) -> Output
-00004060: 3a0a 2020 2020 2020 2020 2222 2244 6566  :.        """Def
-00004070: 6175 6c74 2069 6d70 6c65 6d65 6e74 6174  ault implementat
-00004080: 696f 6e20 6f66 2061 696e 766f 6b65 2c20  ion of ainvoke, 
-00004090: 6361 6c6c 7320 696e 766f 6b65 2066 726f  calls invoke fro
-000040a0: 6d20 6120 7468 7265 6164 2e0a 0a20 2020  m a thread...   
-000040b0: 2020 2020 2054 6865 2064 6566 6175 6c74       The default
-000040c0: 2069 6d70 6c65 6d65 6e74 6174 696f 6e20   implementation 
-000040d0: 616c 6c6f 7773 2075 7361 6765 206f 6620  allows usage of 
-000040e0: 6173 796e 6320 636f 6465 2065 7665 6e20  async code even 
-000040f0: 6966 0a20 2020 2020 2020 2074 6865 2072  if.        the r
-00004100: 756e 6e61 626c 6520 6469 6420 6e6f 7420  unnable did not 
-00004110: 696d 706c 656d 656e 7420 6120 6e61 7469  implement a nati
-00004120: 7665 2061 7379 6e63 2076 6572 7369 6f6e  ve async version
-00004130: 206f 6620 696e 766f 6b65 2e0a 0a20 2020   of invoke...   
-00004140: 2020 2020 2053 7562 636c 6173 7365 7320       Subclasses 
-00004150: 7368 6f75 6c64 206f 7665 7272 6964 6520  should override 
-00004160: 7468 6973 206d 6574 686f 6420 6966 2074  this method if t
-00004170: 6865 7920 6361 6e20 7275 6e20 6173 796e  hey can run asyn
-00004180: 6368 726f 6e6f 7573 6c79 2e0a 2020 2020  chronously..    
-00004190: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-000041a0: 7265 7475 726e 2061 7761 6974 2072 756e  return await run
-000041b0: 5f69 6e5f 6578 6563 7574 6f72 2863 6f6e  _in_executor(con
-000041c0: 6669 672c 2073 656c 662e 696e 766f 6b65  fig, self.invoke
-000041d0: 2c20 696e 7075 742c 2063 6f6e 6669 672c  , input, config,
-000041e0: 202a 2a6b 7761 7267 7329 0a0a 2020 2020   **kwargs)..    
-000041f0: 6465 6620 6261 7463 6828 0a20 2020 2020  def batch(.     
-00004200: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00004210: 2069 6e70 7574 733a 204c 6973 745b 496e   inputs: List[In
-00004220: 7075 745d 2c0a 2020 2020 2020 2020 636f  put],.        co
-00004230: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b55  nfig: Optional[U
-00004240: 6e69 6f6e 5b52 756e 6e61 626c 6543 6f6e  nion[RunnableCon
-00004250: 6669 672c 204c 6973 745b 5275 6e6e 6162  fig, List[Runnab
-00004260: 6c65 436f 6e66 6967 5d5d 5d20 3d20 4e6f  leConfig]]] = No
-00004270: 6e65 2c0a 2020 2020 2020 2020 2a2c 0a20  ne,.        *,. 
-00004280: 2020 2020 2020 2072 6574 7572 6e5f 6578         return_ex
-00004290: 6365 7074 696f 6e73 3a20 626f 6f6c 203d  ceptions: bool =
-000042a0: 2046 616c 7365 2c0a 2020 2020 2020 2020   False,.        
-000042b0: 2a2a 6b77 6172 6773 3a20 4f70 7469 6f6e  **kwargs: Option
-000042c0: 616c 5b41 6e79 5d2c 0a20 2020 2029 202d  al[Any],.    ) -
-000042d0: 3e20 4c69 7374 5b4f 7574 7075 745d 3a0a  > List[Output]:.
-000042e0: 2020 2020 2020 2020 2222 2244 6566 6175          """Defau
-000042f0: 6c74 2069 6d70 6c65 6d65 6e74 6174 696f  lt implementatio
-00004300: 6e20 7275 6e73 2069 6e76 6f6b 6520 696e  n runs invoke in
-00004310: 2070 6172 616c 6c65 6c20 7573 696e 6720   parallel using 
-00004320: 6120 7468 7265 6164 2070 6f6f 6c20 6578  a thread pool ex
-00004330: 6563 7574 6f72 2e0a 0a20 2020 2020 2020  ecutor...       
-00004340: 2054 6865 2064 6566 6175 6c74 2069 6d70   The default imp
-00004350: 6c65 6d65 6e74 6174 696f 6e20 6f66 2062  lementation of b
-00004360: 6174 6368 2077 6f72 6b73 2077 656c 6c20  atch works well 
-00004370: 666f 7220 494f 2062 6f75 6e64 2072 756e  for IO bound run
-00004380: 6e61 626c 6573 2e0a 0a20 2020 2020 2020  nables...       
-00004390: 2053 7562 636c 6173 7365 7320 7368 6f75   Subclasses shou
-000043a0: 6c64 206f 7665 7272 6964 6520 7468 6973  ld override this
-000043b0: 206d 6574 686f 6420 6966 2074 6865 7920   method if they 
-000043c0: 6361 6e20 6261 7463 6820 6d6f 7265 2065  can batch more e
-000043d0: 6666 6963 6965 6e74 6c79 3b0a 2020 2020  fficiently;.    
-000043e0: 2020 2020 652e 672e 2c20 6966 2074 6865      e.g., if the
-000043f0: 2075 6e64 6572 6c79 696e 6720 7275 6e6e   underlying runn
-00004400: 6162 6c65 2075 7365 7320 616e 2041 5049  able uses an API
-00004410: 2077 6869 6368 2073 7570 706f 7274 7320   which supports 
-00004420: 6120 6261 7463 6820 6d6f 6465 2e0a 2020  a batch mode..  
-00004430: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00004440: 2020 6966 206e 6f74 2069 6e70 7574 733a    if not inputs:
-00004450: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00004460: 7572 6e20 5b5d 0a0a 2020 2020 2020 2020  urn []..        
-00004470: 636f 6e66 6967 7320 3d20 6765 745f 636f  configs = get_co
-00004480: 6e66 6967 5f6c 6973 7428 636f 6e66 6967  nfig_list(config
-00004490: 2c20 6c65 6e28 696e 7075 7473 2929 0a0a  , len(inputs))..
-000044a0: 2020 2020 2020 2020 6465 6620 696e 766f          def invo
-000044b0: 6b65 2869 6e70 7574 3a20 496e 7075 742c  ke(input: Input,
-000044c0: 2063 6f6e 6669 673a 2052 756e 6e61 626c   config: Runnabl
-000044d0: 6543 6f6e 6669 6729 202d 3e20 556e 696f  eConfig) -> Unio
-000044e0: 6e5b 4f75 7470 7574 2c20 4578 6365 7074  n[Output, Except
-000044f0: 696f 6e5d 3a0a 2020 2020 2020 2020 2020  ion]:.          
-00004500: 2020 6966 2072 6574 7572 6e5f 6578 6365    if return_exce
-00004510: 7074 696f 6e73 3a0a 2020 2020 2020 2020  ptions:.        
-00004520: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00004530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004540: 2072 6574 7572 6e20 7365 6c66 2e69 6e76   return self.inv
-00004550: 6f6b 6528 696e 7075 742c 2063 6f6e 6669  oke(input, confi
-00004560: 672c 202a 2a6b 7761 7267 7329 0a20 2020  g, **kwargs).   
-00004570: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-00004580: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-00004590: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-000045a0: 2020 2020 2020 2020 7265 7475 726e 2065          return e
-000045b0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-000045c0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000045d0: 2020 2072 6574 7572 6e20 7365 6c66 2e69     return self.i
-000045e0: 6e76 6f6b 6528 696e 7075 742c 2063 6f6e  nvoke(input, con
-000045f0: 6669 672c 202a 2a6b 7761 7267 7329 0a0a  fig, **kwargs)..
-00004600: 2020 2020 2020 2020 2320 4966 2074 6865          # If the
-00004610: 7265 2773 206f 6e6c 7920 6f6e 6520 696e  re's only one in
-00004620: 7075 742c 2064 6f6e 2774 2062 6f74 6865  put, don't bothe
-00004630: 7220 7769 7468 2074 6865 2065 7865 6375  r with the execu
-00004640: 746f 720a 2020 2020 2020 2020 6966 206c  tor.        if l
-00004650: 656e 2869 6e70 7574 7329 203d 3d20 313a  en(inputs) == 1:
-00004660: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00004670: 7572 6e20 6361 7374 284c 6973 745b 4f75  urn cast(List[Ou
-00004680: 7470 7574 5d2c 205b 696e 766f 6b65 2869  tput], [invoke(i
-00004690: 6e70 7574 735b 305d 2c20 636f 6e66 6967  nputs[0], config
-000046a0: 735b 305d 295d 290a 0a20 2020 2020 2020  s[0])])..       
-000046b0: 2077 6974 6820 6765 745f 6578 6563 7574   with get_execut
-000046c0: 6f72 5f66 6f72 5f63 6f6e 6669 6728 636f  or_for_config(co
-000046d0: 6e66 6967 735b 305d 2920 6173 2065 7865  nfigs[0]) as exe
-000046e0: 6375 746f 723a 0a20 2020 2020 2020 2020  cutor:.         
-000046f0: 2020 2072 6574 7572 6e20 6361 7374 284c     return cast(L
-00004700: 6973 745b 4f75 7470 7574 5d2c 206c 6973  ist[Output], lis
-00004710: 7428 6578 6563 7574 6f72 2e6d 6170 2869  t(executor.map(i
-00004720: 6e76 6f6b 652c 2069 6e70 7574 732c 2063  nvoke, inputs, c
-00004730: 6f6e 6669 6773 2929 290a 0a20 2020 2061  onfigs)))..    a
-00004740: 7379 6e63 2064 6566 2061 6261 7463 6828  sync def abatch(
-00004750: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00004760: 2020 2020 2020 2069 6e70 7574 733a 204c         inputs: L
-00004770: 6973 745b 496e 7075 745d 2c0a 2020 2020  ist[Input],.    
-00004780: 2020 2020 636f 6e66 6967 3a20 4f70 7469      config: Opti
-00004790: 6f6e 616c 5b55 6e69 6f6e 5b52 756e 6e61  onal[Union[Runna
-000047a0: 626c 6543 6f6e 6669 672c 204c 6973 745b  bleConfig, List[
-000047b0: 5275 6e6e 6162 6c65 436f 6e66 6967 5d5d  RunnableConfig]]
-000047c0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-000047d0: 2020 2a2c 0a20 2020 2020 2020 2072 6574    *,.        ret
-000047e0: 7572 6e5f 6578 6365 7074 696f 6e73 3a20  urn_exceptions: 
-000047f0: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
-00004800: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
-00004810: 4f70 7469 6f6e 616c 5b41 6e79 5d2c 0a20  Optional[Any],. 
-00004820: 2020 2029 202d 3e20 4c69 7374 5b4f 7574     ) -> List[Out
-00004830: 7075 745d 3a0a 2020 2020 2020 2020 2222  put]:.        ""
-00004840: 2244 6566 6175 6c74 2069 6d70 6c65 6d65  "Default impleme
-00004850: 6e74 6174 696f 6e20 7275 6e73 2061 696e  ntation runs ain
-00004860: 766f 6b65 2069 6e20 7061 7261 6c6c 656c  voke in parallel
-00004870: 2075 7369 6e67 2061 7379 6e63 696f 2e67   using asyncio.g
-00004880: 6174 6865 722e 0a0a 2020 2020 2020 2020  ather...        
-00004890: 5468 6520 6465 6661 756c 7420 696d 706c  The default impl
-000048a0: 656d 656e 7461 7469 6f6e 206f 6620 6261  ementation of ba
-000048b0: 7463 6820 776f 726b 7320 7765 6c6c 2066  tch works well f
-000048c0: 6f72 2049 4f20 626f 756e 6420 7275 6e6e  or IO bound runn
-000048d0: 6162 6c65 732e 0a0a 2020 2020 2020 2020  ables...        
-000048e0: 5375 6263 6c61 7373 6573 2073 686f 756c  Subclasses shoul
-000048f0: 6420 6f76 6572 7269 6465 2074 6869 7320  d override this 
-00004900: 6d65 7468 6f64 2069 6620 7468 6579 2063  method if they c
-00004910: 616e 2062 6174 6368 206d 6f72 6520 6566  an batch more ef
-00004920: 6669 6369 656e 746c 793b 0a20 2020 2020  ficiently;.     
-00004930: 2020 2065 2e67 2e2c 2069 6620 7468 6520     e.g., if the 
-00004940: 756e 6465 726c 7969 6e67 2072 756e 6e61  underlying runna
-00004950: 626c 6520 7573 6573 2061 6e20 4150 4920  ble uses an API 
-00004960: 7768 6963 6820 7375 7070 6f72 7473 2061  which supports a
-00004970: 2062 6174 6368 206d 6f64 652e 0a20 2020   batch mode..   
-00004980: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00004990: 2069 6620 6e6f 7420 696e 7075 7473 3a0a   if not inputs:.
-000049a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000049b0: 726e 205b 5d0a 0a20 2020 2020 2020 2063  rn []..        c
-000049c0: 6f6e 6669 6773 203d 2067 6574 5f63 6f6e  onfigs = get_con
-000049d0: 6669 675f 6c69 7374 2863 6f6e 6669 672c  fig_list(config,
-000049e0: 206c 656e 2869 6e70 7574 7329 290a 0a20   len(inputs)).. 
-000049f0: 2020 2020 2020 2061 7379 6e63 2064 6566         async def
-00004a00: 2061 696e 766f 6b65 280a 2020 2020 2020   ainvoke(.      
-00004a10: 2020 2020 2020 696e 7075 743a 2049 6e70        input: Inp
-00004a20: 7574 2c20 636f 6e66 6967 3a20 5275 6e6e  ut, config: Runn
-00004a30: 6162 6c65 436f 6e66 6967 0a20 2020 2020  ableConfig.     
-00004a40: 2020 2029 202d 3e20 556e 696f 6e5b 4f75     ) -> Union[Ou
-00004a50: 7470 7574 2c20 4578 6365 7074 696f 6e5d  tput, Exception]
-00004a60: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00004a70: 2072 6574 7572 6e5f 6578 6365 7074 696f   return_exceptio
-00004a80: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-00004a90: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00004aa0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00004ab0: 7572 6e20 6177 6169 7420 7365 6c66 2e61  urn await self.a
-00004ac0: 696e 766f 6b65 2869 6e70 7574 2c20 636f  invoke(input, co
-00004ad0: 6e66 6967 2c20 2a2a 6b77 6172 6773 290a  nfig, **kwargs).
-00004ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004af0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00004b00: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-00004b10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00004b20: 6e20 650a 2020 2020 2020 2020 2020 2020  n e.            
-00004b30: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00004b40: 2020 2020 2020 7265 7475 726e 2061 7761        return awa
-00004b50: 6974 2073 656c 662e 6169 6e76 6f6b 6528  it self.ainvoke(
-00004b60: 696e 7075 742c 2063 6f6e 6669 672c 202a  input, config, *
-00004b70: 2a6b 7761 7267 7329 0a0a 2020 2020 2020  *kwargs)..      
-00004b80: 2020 636f 726f 7320 3d20 6d61 7028 6169    coros = map(ai
-00004b90: 6e76 6f6b 652c 2069 6e70 7574 732c 2063  nvoke, inputs, c
-00004ba0: 6f6e 6669 6773 290a 2020 2020 2020 2020  onfigs).        
-00004bb0: 7265 7475 726e 2061 7761 6974 2067 6174  return await gat
-00004bc0: 6865 725f 7769 7468 5f63 6f6e 6375 7272  her_with_concurr
-00004bd0: 656e 6379 2863 6f6e 6669 6773 5b30 5d2e  ency(configs[0].
-00004be0: 6765 7428 226d 6178 5f63 6f6e 6375 7272  get("max_concurr
-00004bf0: 656e 6379 2229 2c20 2a63 6f72 6f73 290a  ency"), *coros).
-00004c00: 0a20 2020 2064 6566 2073 7472 6561 6d28  .    def stream(
-00004c10: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00004c20: 2020 2020 2020 2069 6e70 7574 3a20 496e         input: In
-00004c30: 7075 742c 0a20 2020 2020 2020 2063 6f6e  put,.        con
-00004c40: 6669 673a 204f 7074 696f 6e61 6c5b 5275  fig: Optional[Ru
-00004c50: 6e6e 6162 6c65 436f 6e66 6967 5d20 3d20  nnableConfig] = 
-00004c60: 4e6f 6e65 2c0a 2020 2020 2020 2020 2a2a  None,.        **
-00004c70: 6b77 6172 6773 3a20 4f70 7469 6f6e 616c  kwargs: Optional
-00004c80: 5b41 6e79 5d2c 0a20 2020 2029 202d 3e20  [Any],.    ) -> 
-00004c90: 4974 6572 6174 6f72 5b4f 7574 7075 745d  Iterator[Output]
-00004ca0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00004cb0: 2020 2020 2020 4465 6661 756c 7420 696d        Default im
-00004cc0: 706c 656d 656e 7461 7469 6f6e 206f 6620  plementation of 
-00004cd0: 7374 7265 616d 2c20 7768 6963 6820 6361  stream, which ca
-00004ce0: 6c6c 7320 696e 766f 6b65 2e0a 2020 2020  lls invoke..    
-00004cf0: 2020 2020 5375 6263 6c61 7373 6573 2073      Subclasses s
-00004d00: 686f 756c 6420 6f76 6572 7269 6465 2074  hould override t
-00004d10: 6869 7320 6d65 7468 6f64 2069 6620 7468  his method if th
-00004d20: 6579 2073 7570 706f 7274 2073 7472 6561  ey support strea
-00004d30: 6d69 6e67 206f 7574 7075 742e 0a20 2020  ming output..   
-00004d40: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00004d50: 2079 6965 6c64 2073 656c 662e 696e 766f   yield self.invo
-00004d60: 6b65 2869 6e70 7574 2c20 636f 6e66 6967  ke(input, config
-00004d70: 2c20 2a2a 6b77 6172 6773 290a 0a20 2020  , **kwargs)..   
-00004d80: 2061 7379 6e63 2064 6566 2061 7374 7265   async def astre
-00004d90: 616d 280a 2020 2020 2020 2020 7365 6c66  am(.        self
-00004da0: 2c0a 2020 2020 2020 2020 696e 7075 743a  ,.        input:
-00004db0: 2049 6e70 7574 2c0a 2020 2020 2020 2020   Input,.        
-00004dc0: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
-00004dd0: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
-00004de0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00004df0: 202a 2a6b 7761 7267 733a 204f 7074 696f   **kwargs: Optio
-00004e00: 6e61 6c5b 416e 795d 2c0a 2020 2020 2920  nal[Any],.    ) 
-00004e10: 2d3e 2041 7379 6e63 4974 6572 6174 6f72  -> AsyncIterator
-00004e20: 5b4f 7574 7075 745d 3a0a 2020 2020 2020  [Output]:.      
-00004e30: 2020 2222 220a 2020 2020 2020 2020 4465    """.        De
-00004e40: 6661 756c 7420 696d 706c 656d 656e 7461  fault implementa
-00004e50: 7469 6f6e 206f 6620 6173 7472 6561 6d2c  tion of astream,
-00004e60: 2077 6869 6368 2063 616c 6c73 2061 696e   which calls ain
-00004e70: 766f 6b65 2e0a 2020 2020 2020 2020 5375  voke..        Su
-00004e80: 6263 6c61 7373 6573 2073 686f 756c 6420  bclasses should 
-00004e90: 6f76 6572 7269 6465 2074 6869 7320 6d65  override this me
-00004ea0: 7468 6f64 2069 6620 7468 6579 2073 7570  thod if they sup
-00004eb0: 706f 7274 2073 7472 6561 6d69 6e67 206f  port streaming o
-00004ec0: 7574 7075 742e 0a20 2020 2020 2020 2022  utput..        "
-00004ed0: 2222 0a20 2020 2020 2020 2079 6965 6c64  "".        yield
-00004ee0: 2061 7761 6974 2073 656c 662e 6169 6e76   await self.ainv
-00004ef0: 6f6b 6528 696e 7075 742c 2063 6f6e 6669  oke(input, confi
-00004f00: 672c 202a 2a6b 7761 7267 7329 0a0a 2020  g, **kwargs)..  
-00004f10: 2020 406f 7665 726c 6f61 640a 2020 2020    @overload.    
-00004f20: 6465 6620 6173 7472 6561 6d5f 6c6f 6728  def astream_log(
-00004f30: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00004f40: 2020 2020 2020 2069 6e70 7574 3a20 416e         input: An
-00004f50: 792c 0a20 2020 2020 2020 2063 6f6e 6669  y,.        confi
-00004f60: 673a 204f 7074 696f 6e61 6c5b 5275 6e6e  g: Optional[Runn
-00004f70: 6162 6c65 436f 6e66 6967 5d20 3d20 4e6f  ableConfig] = No
-00004f80: 6e65 2c0a 2020 2020 2020 2020 2a2c 0a20  ne,.        *,. 
-00004f90: 2020 2020 2020 2064 6966 663a 204c 6974         diff: Lit
-00004fa0: 6572 616c 5b54 7275 655d 203d 2054 7275  eral[True] = Tru
-00004fb0: 652c 0a20 2020 2020 2020 2077 6974 685f  e,.        with_
-00004fc0: 7374 7265 616d 6564 5f6f 7574 7075 745f  streamed_output_
-00004fd0: 6c69 7374 3a20 626f 6f6c 203d 2054 7275  list: bool = Tru
-00004fe0: 652c 0a20 2020 2020 2020 2069 6e63 6c75  e,.        inclu
-00004ff0: 6465 5f6e 616d 6573 3a20 4f70 7469 6f6e  de_names: Option
-00005000: 616c 5b53 6571 7565 6e63 655b 7374 725d  al[Sequence[str]
-00005010: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-00005020: 2020 696e 636c 7564 655f 7479 7065 733a    include_types:
-00005030: 204f 7074 696f 6e61 6c5b 5365 7175 656e   Optional[Sequen
-00005040: 6365 5b73 7472 5d5d 203d 204e 6f6e 652c  ce[str]] = None,
-00005050: 0a20 2020 2020 2020 2069 6e63 6c75 6465  .        include
-00005060: 5f74 6167 733a 204f 7074 696f 6e61 6c5b  _tags: Optional[
-00005070: 5365 7175 656e 6365 5b73 7472 5d5d 203d  Sequence[str]] =
-00005080: 204e 6f6e 652c 0a20 2020 2020 2020 2065   None,.        e
-00005090: 7863 6c75 6465 5f6e 616d 6573 3a20 4f70  xclude_names: Op
-000050a0: 7469 6f6e 616c 5b53 6571 7565 6e63 655b  tional[Sequence[
-000050b0: 7374 725d 5d20 3d20 4e6f 6e65 2c0a 2020  str]] = None,.  
-000050c0: 2020 2020 2020 6578 636c 7564 655f 7479        exclude_ty
-000050d0: 7065 733a 204f 7074 696f 6e61 6c5b 5365  pes: Optional[Se
-000050e0: 7175 656e 6365 5b73 7472 5d5d 203d 204e  quence[str]] = N
-000050f0: 6f6e 652c 0a20 2020 2020 2020 2065 7863  one,.        exc
-00005100: 6c75 6465 5f74 6167 733a 204f 7074 696f  lude_tags: Optio
-00005110: 6e61 6c5b 5365 7175 656e 6365 5b73 7472  nal[Sequence[str
-00005120: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
-00005130: 2020 202a 2a6b 7761 7267 733a 204f 7074     **kwargs: Opt
-00005140: 696f 6e61 6c5b 416e 795d 2c0a 2020 2020  ional[Any],.    
-00005150: 2920 2d3e 2041 7379 6e63 4974 6572 6174  ) -> AsyncIterat
-00005160: 6f72 5b52 756e 4c6f 6750 6174 6368 5d3a  or[RunLogPatch]:
-00005170: 0a20 2020 2020 2020 202e 2e2e 0a0a 2020  .        .....  
-00005180: 2020 406f 7665 726c 6f61 640a 2020 2020    @overload.    
-00005190: 6465 6620 6173 7472 6561 6d5f 6c6f 6728  def astream_log(
-000051a0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-000051b0: 2020 2020 2020 2069 6e70 7574 3a20 416e         input: An
-000051c0: 792c 0a20 2020 2020 2020 2063 6f6e 6669  y,.        confi
-000051d0: 673a 204f 7074 696f 6e61 6c5b 5275 6e6e  g: Optional[Runn
-000051e0: 6162 6c65 436f 6e66 6967 5d20 3d20 4e6f  ableConfig] = No
-000051f0: 6e65 2c0a 2020 2020 2020 2020 2a2c 0a20  ne,.        *,. 
-00005200: 2020 2020 2020 2064 6966 663a 204c 6974         diff: Lit
-00005210: 6572 616c 5b46 616c 7365 5d2c 0a20 2020  eral[False],.   
-00005220: 2020 2020 2077 6974 685f 7374 7265 616d       with_stream
-00005230: 6564 5f6f 7574 7075 745f 6c69 7374 3a20  ed_output_list: 
-00005240: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
-00005250: 2020 2020 2069 6e63 6c75 6465 5f6e 616d       include_nam
-00005260: 6573 3a20 4f70 7469 6f6e 616c 5b53 6571  es: Optional[Seq
-00005270: 7565 6e63 655b 7374 725d 5d20 3d20 4e6f  uence[str]] = No
-00005280: 6e65 2c0a 2020 2020 2020 2020 696e 636c  ne,.        incl
-00005290: 7564 655f 7479 7065 733a 204f 7074 696f  ude_types: Optio
-000052a0: 6e61 6c5b 5365 7175 656e 6365 5b73 7472  nal[Sequence[str
-000052b0: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
-000052c0: 2020 2069 6e63 6c75 6465 5f74 6167 733a     include_tags:
-000052d0: 204f 7074 696f 6e61 6c5b 5365 7175 656e   Optional[Sequen
-000052e0: 6365 5b73 7472 5d5d 203d 204e 6f6e 652c  ce[str]] = None,
-000052f0: 0a20 2020 2020 2020 2065 7863 6c75 6465  .        exclude
-00005300: 5f6e 616d 6573 3a20 4f70 7469 6f6e 616c  _names: Optional
-00005310: 5b53 6571 7565 6e63 655b 7374 725d 5d20  [Sequence[str]] 
-00005320: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00005330: 6578 636c 7564 655f 7479 7065 733a 204f  exclude_types: O
-00005340: 7074 696f 6e61 6c5b 5365 7175 656e 6365  ptional[Sequence
-00005350: 5b73 7472 5d5d 203d 204e 6f6e 652c 0a20  [str]] = None,. 
-00005360: 2020 2020 2020 2065 7863 6c75 6465 5f74         exclude_t
-00005370: 6167 733a 204f 7074 696f 6e61 6c5b 5365  ags: Optional[Se
-00005380: 7175 656e 6365 5b73 7472 5d5d 203d 204e  quence[str]] = N
-00005390: 6f6e 652c 0a20 2020 2020 2020 202a 2a6b  one,.        **k
-000053a0: 7761 7267 733a 204f 7074 696f 6e61 6c5b  wargs: Optional[
-000053b0: 416e 795d 2c0a 2020 2020 2920 2d3e 2041  Any],.    ) -> A
-000053c0: 7379 6e63 4974 6572 6174 6f72 5b52 756e  syncIterator[Run
-000053d0: 4c6f 675d 3a0a 2020 2020 2020 2020 2e2e  Log]:.        ..
-000053e0: 2e0a 0a20 2020 2061 7379 6e63 2064 6566  ...    async def
-000053f0: 2061 7374 7265 616d 5f6c 6f67 280a 2020   astream_log(.  
-00005400: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-00005410: 2020 2020 696e 7075 743a 2041 6e79 2c0a      input: Any,.
-00005420: 2020 2020 2020 2020 636f 6e66 6967 3a20          config: 
-00005430: 4f70 7469 6f6e 616c 5b52 756e 6e61 626c  Optional[Runnabl
-00005440: 6543 6f6e 6669 675d 203d 204e 6f6e 652c  eConfig] = None,
-00005450: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
-00005460: 2020 2020 6469 6666 3a20 626f 6f6c 203d      diff: bool =
-00005470: 2054 7275 652c 0a20 2020 2020 2020 2077   True,.        w
-00005480: 6974 685f 7374 7265 616d 6564 5f6f 7574  ith_streamed_out
-00005490: 7075 745f 6c69 7374 3a20 626f 6f6c 203d  put_list: bool =
-000054a0: 2054 7275 652c 0a20 2020 2020 2020 2069   True,.        i
-000054b0: 6e63 6c75 6465 5f6e 616d 6573 3a20 4f70  nclude_names: Op
-000054c0: 7469 6f6e 616c 5b53 6571 7565 6e63 655b  tional[Sequence[
-000054d0: 7374 725d 5d20 3d20 4e6f 6e65 2c0a 2020  str]] = None,.  
-000054e0: 2020 2020 2020 696e 636c 7564 655f 7479        include_ty
-000054f0: 7065 733a 204f 7074 696f 6e61 6c5b 5365  pes: Optional[Se
-00005500: 7175 656e 6365 5b73 7472 5d5d 203d 204e  quence[str]] = N
-00005510: 6f6e 652c 0a20 2020 2020 2020 2069 6e63  one,.        inc
-00005520: 6c75 6465 5f74 6167 733a 204f 7074 696f  lude_tags: Optio
-00005530: 6e61 6c5b 5365 7175 656e 6365 5b73 7472  nal[Sequence[str
-00005540: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
-00005550: 2020 2065 7863 6c75 6465 5f6e 616d 6573     exclude_names
-00005560: 3a20 4f70 7469 6f6e 616c 5b53 6571 7565  : Optional[Seque
-00005570: 6e63 655b 7374 725d 5d20 3d20 4e6f 6e65  nce[str]] = None
-00005580: 2c0a 2020 2020 2020 2020 6578 636c 7564  ,.        exclud
-00005590: 655f 7479 7065 733a 204f 7074 696f 6e61  e_types: Optiona
-000055a0: 6c5b 5365 7175 656e 6365 5b73 7472 5d5d  l[Sequence[str]]
-000055b0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-000055c0: 2065 7863 6c75 6465 5f74 6167 733a 204f   exclude_tags: O
-000055d0: 7074 696f 6e61 6c5b 5365 7175 656e 6365  ptional[Sequence
-000055e0: 5b73 7472 5d5d 203d 204e 6f6e 652c 0a20  [str]] = None,. 
-000055f0: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
-00005600: 204f 7074 696f 6e61 6c5b 416e 795d 2c0a   Optional[Any],.
-00005610: 2020 2020 2920 2d3e 2055 6e69 6f6e 5b41      ) -> Union[A
-00005620: 7379 6e63 4974 6572 6174 6f72 5b52 756e  syncIterator[Run
-00005630: 4c6f 6750 6174 6368 5d2c 2041 7379 6e63  LogPatch], Async
-00005640: 4974 6572 6174 6f72 5b52 756e 4c6f 675d  Iterator[RunLog]
-00005650: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
-00005660: 2020 2020 2020 2053 7472 6561 6d20 616c         Stream al
-00005670: 6c20 6f75 7470 7574 2066 726f 6d20 6120  l output from a 
-00005680: 7275 6e6e 6162 6c65 2c20 6173 2072 6570  runnable, as rep
-00005690: 6f72 7465 6420 746f 2074 6865 2063 616c  orted to the cal
-000056a0: 6c62 6163 6b20 7379 7374 656d 2e0a 2020  lback system..  
-000056b0: 2020 2020 2020 5468 6973 2069 6e63 6c75        This inclu
-000056c0: 6465 7320 616c 6c20 696e 6e65 7220 7275  des all inner ru
-000056d0: 6e73 206f 6620 4c4c 4d73 2c20 5265 7472  ns of LLMs, Retr
-000056e0: 6965 7665 7273 2c20 546f 6f6c 732c 2065  ievers, Tools, e
-000056f0: 7463 2e0a 0a20 2020 2020 2020 204f 7574  tc...        Out
-00005700: 7075 7420 6973 2073 7472 6561 6d65 6420  put is streamed 
-00005710: 6173 204c 6f67 206f 626a 6563 7473 2c20  as Log objects, 
-00005720: 7768 6963 6820 696e 636c 7564 6520 6120  which include a 
-00005730: 6c69 7374 206f 660a 2020 2020 2020 2020  list of.        
-00005740: 6a73 6f6e 7061 7463 6820 6f70 7320 7468  jsonpatch ops th
-00005750: 6174 2064 6573 6372 6962 6520 686f 7720  at describe how 
-00005760: 7468 6520 7374 6174 6520 6f66 2074 6865  the state of the
-00005770: 2072 756e 2068 6173 2063 6861 6e67 6564   run has changed
-00005780: 2069 6e20 6561 6368 0a20 2020 2020 2020   in each.       
-00005790: 2073 7465 702c 2061 6e64 2074 6865 2066   step, and the f
-000057a0: 696e 616c 2073 7461 7465 206f 6620 7468  inal state of th
-000057b0: 6520 7275 6e2e 0a0a 2020 2020 2020 2020  e run...        
-000057c0: 5468 6520 6a73 6f6e 7061 7463 6820 6f70  The jsonpatch op
-000057d0: 7320 6361 6e20 6265 2061 7070 6c69 6564  s can be applied
-000057e0: 2069 6e20 6f72 6465 7220 746f 2063 6f6e   in order to con
-000057f0: 7374 7275 6374 2073 7461 7465 2e0a 0a20  struct state... 
-00005800: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
-00005810: 2020 2020 2020 2020 2069 6e70 7574 3a20           input: 
-00005820: 5468 6520 696e 7075 7420 746f 2074 6865  The input to the
-00005830: 2072 756e 6e61 626c 652e 0a20 2020 2020   runnable..     
-00005840: 2020 2020 2020 2063 6f6e 6669 673a 2054         config: T
-00005850: 6865 2063 6f6e 6669 6720 746f 2075 7365  he config to use
-00005860: 2066 6f72 2074 6865 2072 756e 6e61 626c   for the runnabl
-00005870: 652e 0a20 2020 2020 2020 2020 2020 2064  e..            d
-00005880: 6966 663a 2057 6865 7468 6572 2074 6f20  iff: Whether to 
-00005890: 7969 656c 6420 6469 6666 7320 6265 7477  yield diffs betw
-000058a0: 6565 6e20 6561 6368 2073 7465 702c 206f  een each step, o
-000058b0: 7220 7468 6520 6375 7272 656e 7420 7374  r the current st
-000058c0: 6174 652e 0a20 2020 2020 2020 2020 2020  ate..           
-000058d0: 2077 6974 685f 7374 7265 616d 6564 5f6f   with_streamed_o
-000058e0: 7574 7075 745f 6c69 7374 3a20 5768 6574  utput_list: Whet
-000058f0: 6865 7220 746f 2079 6965 6c64 2074 6865  her to yield the
-00005900: 2073 7472 6561 6d65 645f 6f75 7470 7574   streamed_output
-00005910: 206c 6973 742e 0a20 2020 2020 2020 2020   list..         
-00005920: 2020 2069 6e63 6c75 6465 5f6e 616d 6573     include_names
-00005930: 3a20 4f6e 6c79 2069 6e63 6c75 6465 206c  : Only include l
-00005940: 6f67 7320 7769 7468 2074 6865 7365 206e  ogs with these n
-00005950: 616d 6573 2e0a 2020 2020 2020 2020 2020  ames..          
-00005960: 2020 696e 636c 7564 655f 7479 7065 733a    include_types:
-00005970: 204f 6e6c 7920 696e 636c 7564 6520 6c6f   Only include lo
-00005980: 6773 2077 6974 6820 7468 6573 6520 7479  gs with these ty
-00005990: 7065 732e 0a20 2020 2020 2020 2020 2020  pes..           
-000059a0: 2069 6e63 6c75 6465 5f74 6167 733a 204f   include_tags: O
-000059b0: 6e6c 7920 696e 636c 7564 6520 6c6f 6773  nly include logs
-000059c0: 2077 6974 6820 7468 6573 6520 7461 6773   with these tags
-000059d0: 2e0a 2020 2020 2020 2020 2020 2020 6578  ..            ex
-000059e0: 636c 7564 655f 6e61 6d65 733a 2045 7863  clude_names: Exc
-000059f0: 6c75 6465 206c 6f67 7320 7769 7468 2074  lude logs with t
-00005a00: 6865 7365 206e 616d 6573 2e0a 2020 2020  hese names..    
-00005a10: 2020 2020 2020 2020 6578 636c 7564 655f          exclude_
-00005a20: 7479 7065 733a 2045 7863 6c75 6465 206c  types: Exclude l
-00005a30: 6f67 7320 7769 7468 2074 6865 7365 2074  ogs with these t
-00005a40: 7970 6573 2e0a 2020 2020 2020 2020 2020  ypes..          
-00005a50: 2020 6578 636c 7564 655f 7461 6773 3a20    exclude_tags: 
-00005a60: 4578 636c 7564 6520 6c6f 6773 2077 6974  Exclude logs wit
-00005a70: 6820 7468 6573 6520 7461 6773 2e0a 2020  h these tags..  
-00005a80: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00005a90: 2020 696d 706f 7274 206a 736f 6e70 6174    import jsonpat
-00005aa0: 6368 2020 2320 7479 7065 3a20 6967 6e6f  ch  # type: igno
-00005ab0: 7265 5b69 6d70 6f72 745d 0a0a 2020 2020  re[import]..    
-00005ac0: 2020 2020 6672 6f6d 206c 616e 6763 6861      from langcha
-00005ad0: 696e 5f63 6f72 652e 6361 6c6c 6261 636b  in_core.callback
-00005ae0: 732e 6261 7365 2069 6d70 6f72 7420 4261  s.base import Ba
-00005af0: 7365 4361 6c6c 6261 636b 4d61 6e61 6765  seCallbackManage
-00005b00: 720a 2020 2020 2020 2020 6672 6f6d 206c  r.        from l
-00005b10: 616e 6763 6861 696e 5f63 6f72 652e 7472  angchain_core.tr
-00005b20: 6163 6572 732e 6c6f 675f 7374 7265 616d  acers.log_stream
-00005b30: 2069 6d70 6f72 7420 280a 2020 2020 2020   import (.      
-00005b40: 2020 2020 2020 4c6f 6753 7472 6561 6d43        LogStreamC
-00005b50: 616c 6c62 6163 6b48 616e 646c 6572 2c0a  allbackHandler,.
-00005b60: 2020 2020 2020 2020 2020 2020 5275 6e4c              RunL
-00005b70: 6f67 2c0a 2020 2020 2020 2020 2020 2020  og,.            
-00005b80: 5275 6e4c 6f67 5061 7463 682c 0a20 2020  RunLogPatch,.   
-00005b90: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00005ba0: 2320 4372 6561 7465 2061 2073 7472 6561  # Create a strea
-00005bb0: 6d20 6861 6e64 6c65 7220 7468 6174 2077  m handler that w
-00005bc0: 696c 6c20 656d 6974 204c 6f67 206f 626a  ill emit Log obj
-00005bd0: 6563 7473 0a20 2020 2020 2020 2073 7472  ects.        str
-00005be0: 6561 6d20 3d20 4c6f 6753 7472 6561 6d43  eam = LogStreamC
-00005bf0: 616c 6c62 6163 6b48 616e 646c 6572 280a  allbackHandler(.
-00005c00: 2020 2020 2020 2020 2020 2020 6175 746f              auto
-00005c10: 5f63 6c6f 7365 3d46 616c 7365 2c0a 2020  _close=False,.  
-00005c20: 2020 2020 2020 2020 2020 696e 636c 7564            includ
-00005c30: 655f 6e61 6d65 733d 696e 636c 7564 655f  e_names=include_
-00005c40: 6e61 6d65 732c 0a20 2020 2020 2020 2020  names,.         
-00005c50: 2020 2069 6e63 6c75 6465 5f74 7970 6573     include_types
-00005c60: 3d69 6e63 6c75 6465 5f74 7970 6573 2c0a  =include_types,.
-00005c70: 2020 2020 2020 2020 2020 2020 696e 636c              incl
-00005c80: 7564 655f 7461 6773 3d69 6e63 6c75 6465  ude_tags=include
-00005c90: 5f74 6167 732c 0a20 2020 2020 2020 2020  _tags,.         
-00005ca0: 2020 2065 7863 6c75 6465 5f6e 616d 6573     exclude_names
-00005cb0: 3d65 7863 6c75 6465 5f6e 616d 6573 2c0a  =exclude_names,.
-00005cc0: 2020 2020 2020 2020 2020 2020 6578 636c              excl
-00005cd0: 7564 655f 7479 7065 733d 6578 636c 7564  ude_types=exclud
-00005ce0: 655f 7479 7065 732c 0a20 2020 2020 2020  e_types,.       
-00005cf0: 2020 2020 2065 7863 6c75 6465 5f74 6167       exclude_tag
-00005d00: 733d 6578 636c 7564 655f 7461 6773 2c0a  s=exclude_tags,.
-00005d10: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00005d20: 2020 2023 2041 7373 6967 6e20 7468 6520     # Assign the 
-00005d30: 7374 7265 616d 2068 616e 646c 6572 2074  stream handler t
-00005d40: 6f20 7468 6520 636f 6e66 6967 0a20 2020  o the config.   
-00005d50: 2020 2020 2063 6f6e 6669 6720 3d20 656e       config = en
-00005d60: 7375 7265 5f63 6f6e 6669 6728 636f 6e66  sure_config(conf
-00005d70: 6967 290a 2020 2020 2020 2020 6361 6c6c  ig).        call
-00005d80: 6261 636b 7320 3d20 636f 6e66 6967 2e67  backs = config.g
-00005d90: 6574 2822 6361 6c6c 6261 636b 7322 290a  et("callbacks").
-00005da0: 2020 2020 2020 2020 6966 2063 616c 6c62          if callb
-00005db0: 6163 6b73 2069 7320 4e6f 6e65 3a0a 2020  acks is None:.  
-00005dc0: 2020 2020 2020 2020 2020 636f 6e66 6967            config
-00005dd0: 5b22 6361 6c6c 6261 636b 7322 5d20 3d20  ["callbacks"] = 
-00005de0: 5b73 7472 6561 6d5d 0a20 2020 2020 2020  [stream].       
-00005df0: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
-00005e00: 2863 616c 6c62 6163 6b73 2c20 6c69 7374  (callbacks, list
-00005e10: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-00005e20: 6f6e 6669 675b 2263 616c 6c62 6163 6b73  onfig["callbacks
-00005e30: 225d 203d 2063 616c 6c62 6163 6b73 202b  "] = callbacks +
-00005e40: 205b 7374 7265 616d 5d0a 2020 2020 2020   [stream].      
-00005e50: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
-00005e60: 6528 6361 6c6c 6261 636b 732c 2042 6173  e(callbacks, Bas
-00005e70: 6543 616c 6c62 6163 6b4d 616e 6167 6572  eCallbackManager
-00005e80: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-00005e90: 616c 6c62 6163 6b73 203d 2063 616c 6c62  allbacks = callb
-00005ea0: 6163 6b73 2e63 6f70 7928 290a 2020 2020  acks.copy().    
-00005eb0: 2020 2020 2020 2020 6361 6c6c 6261 636b          callback
-00005ec0: 732e 6164 645f 6861 6e64 6c65 7228 7374  s.add_handler(st
-00005ed0: 7265 616d 2c20 696e 6865 7269 743d 5472  ream, inherit=Tr
-00005ee0: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
-00005ef0: 636f 6e66 6967 5b22 6361 6c6c 6261 636b  config["callback
-00005f00: 7322 5d20 3d20 6361 6c6c 6261 636b 730a  s"] = callbacks.
-00005f10: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00005f20: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00005f30: 5661 6c75 6545 7272 6f72 280a 2020 2020  ValueError(.    
-00005f40: 2020 2020 2020 2020 2020 2020 6622 556e              f"Un
-00005f50: 6578 7065 6374 6564 2074 7970 6520 666f  expected type fo
-00005f60: 7220 6361 6c6c 6261 636b 733a 207b 6361  r callbacks: {ca
-00005f70: 6c6c 6261 636b 737d 2e22 0a20 2020 2020  llbacks}.".     
-00005f80: 2020 2020 2020 2020 2020 2022 4578 7065             "Expe
-00005f90: 6374 6564 204e 6f6e 652c 206c 6973 7420  cted None, list 
-00005fa0: 6f72 2041 7379 6e63 4361 6c6c 6261 636b  or AsyncCallback
-00005fb0: 4d61 6e61 6765 722e 220a 2020 2020 2020  Manager.".      
-00005fc0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00005fd0: 2023 2043 616c 6c20 7468 6520 7275 6e6e   # Call the runn
-00005fe0: 6162 6c65 2069 6e20 7374 7265 616d 696e  able in streamin
-00005ff0: 6720 6d6f 6465 2c0a 2020 2020 2020 2020  g mode,.        
-00006000: 2320 6164 6420 6561 6368 2063 6875 6e6b  # add each chunk
-00006010: 2074 6f20 7468 6520 6f75 7470 7574 2073   to the output s
-00006020: 7472 6561 6d0a 2020 2020 2020 2020 6173  tream.        as
-00006030: 796e 6320 6465 6620 636f 6e73 756d 655f  ync def consume_
-00006040: 6173 7472 6561 6d28 2920 2d3e 204e 6f6e  astream() -> Non
-00006050: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
-00006060: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00006070: 2020 2020 7072 6576 5f66 696e 616c 5f6f      prev_final_o
-00006080: 7574 7075 743a 204f 7074 696f 6e61 6c5b  utput: Optional[
-00006090: 4f75 7470 7574 5d20 3d20 4e6f 6e65 0a20  Output] = None. 
-000060a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000060b0: 696e 616c 5f6f 7574 7075 743a 204f 7074  inal_output: Opt
-000060c0: 696f 6e61 6c5b 4f75 7470 7574 5d20 3d20  ional[Output] = 
-000060d0: 4e6f 6e65 0a0a 2020 2020 2020 2020 2020  None..          
-000060e0: 2020 2020 2020 6173 796e 6320 666f 7220        async for 
-000060f0: 6368 756e 6b20 696e 2073 656c 662e 6173  chunk in self.as
-00006100: 7472 6561 6d28 696e 7075 742c 2063 6f6e  tream(input, con
-00006110: 6669 672c 202a 2a6b 7761 7267 7329 3a0a  fig, **kwargs):.
-00006120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006130: 2020 2020 7072 6576 5f66 696e 616c 5f6f      prev_final_o
-00006140: 7574 7075 7420 3d20 6669 6e61 6c5f 6f75  utput = final_ou
-00006150: 7470 7574 0a20 2020 2020 2020 2020 2020  tput.           
-00006160: 2020 2020 2020 2020 2069 6620 6669 6e61           if fina
-00006170: 6c5f 6f75 7470 7574 2069 7320 4e6f 6e65  l_output is None
-00006180: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00006190: 2020 2020 2020 2020 2020 6669 6e61 6c5f            final_
-000061a0: 6f75 7470 7574 203d 2063 6875 6e6b 0a20  output = chunk. 
-000061b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000061c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000061d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000061e0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-000061f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006200: 2020 6669 6e61 6c5f 6f75 7470 7574 203d    final_output =
-00006210: 2066 696e 616c 5f6f 7574 7075 7420 2b20   final_output + 
-00006220: 6368 756e 6b20 2023 2074 7970 653a 2069  chunk  # type: i
-00006230: 676e 6f72 650a 2020 2020 2020 2020 2020  gnore.          
-00006240: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-00006250: 6365 7074 2054 7970 6545 7272 6f72 3a0a  cept TypeError:.
-00006260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006270: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
-00006280: 6c5f 6f75 7470 7574 203d 2063 6875 6e6b  l_output = chunk
-00006290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000062a0: 2020 2020 2070 6174 6368 6573 3a20 4c69       patches: Li
-000062b0: 7374 5b44 6963 745b 7374 722c 2041 6e79  st[Dict[str, Any
-000062c0: 5d5d 203d 205b 5d0a 2020 2020 2020 2020  ]] = [].        
-000062d0: 2020 2020 2020 2020 2020 2020 6966 2077              if w
-000062e0: 6974 685f 7374 7265 616d 6564 5f6f 7574  ith_streamed_out
-000062f0: 7075 745f 6c69 7374 3a0a 2020 2020 2020  put_list:.      
-00006300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006310: 2020 7061 7463 6865 732e 6170 7065 6e64    patches.append
-00006320: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00006330: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
-00006340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006360: 226f 7022 3a20 2261 6464 222c 0a20 2020  "op": "add",.   
-00006370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006380: 2020 2020 2020 2020 2020 2020 2022 7061               "pa
-00006390: 7468 223a 2022 2f73 7472 6561 6d65 645f  th": "/streamed_
-000063a0: 6f75 7470 7574 2f2d 222c 0a20 2020 2020  output/-",.     
-000063b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000063c0: 2020 2020 2020 2020 2020 2023 2063 6875             # chu
-000063d0: 6e6b 2063 616e 6e6f 7420 6265 2073 6861  nk cannot be sha
-000063e0: 7265 6420 6265 7477 6565 6e0a 2020 2020  red between.    
-000063f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006400: 2020 2020 2020 2020 2020 2020 2320 7374              # st
-00006410: 7265 616d 6564 5f6f 7574 7075 7420 616e  reamed_output an
-00006420: 6420 6669 6e61 6c5f 6f75 7470 7574 0a20  d final_output. 
-00006430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006440: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00006450: 206f 7468 6572 7769 7365 206a 736f 6e70   otherwise jsonp
-00006460: 6174 6368 2e61 7070 6c79 2077 696c 6c0a  atch.apply will.
-00006470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006490: 2320 6d6f 6469 6679 2062 6f74 680a 2020  # modify both.  
-000064a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000064b0: 2020 2020 2020 2020 2020 2020 2020 2276                "v
-000064c0: 616c 7565 223a 2064 6565 7063 6f70 7928  alue": deepcopy(
-000064d0: 6368 756e 6b29 2c0a 2020 2020 2020 2020  chunk),.        
-000064e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000064f0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00006500: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00006510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006520: 2020 2020 666f 7220 6f70 2069 6e20 6a73      for op in js
-00006530: 6f6e 7061 7463 682e 4a73 6f6e 5061 7463  onpatch.JsonPatc
-00006540: 682e 6672 6f6d 5f64 6966 6628 0a20 2020  h.from_diff(.   
-00006550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006560: 2020 2020 2070 7265 765f 6669 6e61 6c5f       prev_final_
-00006570: 6f75 7470 7574 2c20 6669 6e61 6c5f 6f75  output, final_ou
-00006580: 7470 7574 2c20 6475 6d70 733d 6475 6d70  tput, dumps=dump
-00006590: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-000065a0: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
-000065b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000065c0: 2070 6174 6368 6573 2e61 7070 656e 6428   patches.append(
-000065d0: 7b2a 2a6f 702c 2022 7061 7468 223a 2066  {**op, "path": f
-000065e0: 222f 6669 6e61 6c5f 6f75 7470 7574 7b6f  "/final_output{o
-000065f0: 705b 2770 6174 6827 5d7d 227d 290a 2020  p['path']}"}).  
-00006600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006610: 2020 6177 6169 7420 7374 7265 616d 2e73    await stream.s
-00006620: 656e 645f 7374 7265 616d 2e73 656e 6428  end_stream.send(
-00006630: 5275 6e4c 6f67 5061 7463 6828 2a70 6174  RunLogPatch(*pat
-00006640: 6368 6573 2929 0a20 2020 2020 2020 2020  ches)).         
-00006650: 2020 2066 696e 616c 6c79 3a0a 2020 2020     finally:.    
-00006660: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00006670: 7420 7374 7265 616d 2e73 656e 645f 7374  t stream.send_st
-00006680: 7265 616d 2e61 636c 6f73 6528 290a 0a20  ream.aclose().. 
-00006690: 2020 2020 2020 2023 2053 7461 7274 2074         # Start t
-000066a0: 6865 2072 756e 6e61 626c 6520 696e 2061  he runnable in a
-000066b0: 2074 6173 6b2c 2073 6f20 7765 2063 616e   task, so we can
-000066c0: 2073 7461 7274 2063 6f6e 7375 6d69 6e67   start consuming
-000066d0: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
-000066e0: 7461 736b 203d 2061 7379 6e63 696f 2e63  task = asyncio.c
-000066f0: 7265 6174 655f 7461 736b 2863 6f6e 7375  reate_task(consu
-00006700: 6d65 5f61 7374 7265 616d 2829 290a 0a20  me_astream()).. 
-00006710: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00006720: 2020 2020 2020 2020 2320 5969 656c 6420          # Yield 
-00006730: 6561 6368 2063 6875 6e6b 2066 726f 6d20  each chunk from 
-00006740: 7468 6520 6f75 7470 7574 2073 7472 6561  the output strea
-00006750: 6d0a 2020 2020 2020 2020 2020 2020 6966  m.            if
-00006760: 2064 6966 663a 0a20 2020 2020 2020 2020   diff:.         
-00006770: 2020 2020 2020 2061 7379 6e63 2066 6f72         async for
-00006780: 206c 6f67 2069 6e20 7374 7265 616d 3a0a   log in stream:.
-00006790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000067a0: 2020 2020 7969 656c 6420 6c6f 670a 2020      yield log.  
-000067b0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000067c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000067d0: 7374 6174 6520 3d20 5275 6e4c 6f67 2873  state = RunLog(s
-000067e0: 7461 7465 3d4e 6f6e 6529 2020 2320 7479  tate=None)  # ty
-000067f0: 7065 3a20 6967 6e6f 7265 5b61 7267 2d74  pe: ignore[arg-t
-00006800: 7970 655d 0a20 2020 2020 2020 2020 2020  ype].           
-00006810: 2020 2020 2061 7379 6e63 2066 6f72 206c       async for l
-00006820: 6f67 2069 6e20 7374 7265 616d 3a0a 2020  og in stream:.  
-00006830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006840: 2020 7374 6174 6520 3d20 7374 6174 6520    state = state 
-00006850: 2b20 6c6f 670a 2020 2020 2020 2020 2020  + log.          
-00006860: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
-00006870: 7374 6174 650a 2020 2020 2020 2020 6669  state.        fi
-00006880: 6e61 6c6c 793a 0a20 2020 2020 2020 2020  nally:.         
-00006890: 2020 2023 2057 6169 7420 666f 7220 7468     # Wait for th
-000068a0: 6520 7275 6e6e 6162 6c65 2074 6f20 6669  e runnable to fi
-000068b0: 6e69 7368 2c20 6966 206e 6f74 2063 616e  nish, if not can
-000068c0: 6365 6c6c 6564 2028 6567 2e20 6279 2062  celled (eg. by b
-000068d0: 7265 616b 290a 2020 2020 2020 2020 2020  reak).          
-000068e0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-000068f0: 2020 2020 2020 2061 7761 6974 2074 6173         await tas
-00006900: 6b0a 2020 2020 2020 2020 2020 2020 6578  k.            ex
-00006910: 6365 7074 2061 7379 6e63 696f 2e43 616e  cept asyncio.Can
-00006920: 6365 6c6c 6564 4572 726f 723a 0a20 2020  celledError:.   
-00006930: 2020 2020 2020 2020 2020 2020 2070 6173               pas
-00006940: 730a 0a20 2020 2064 6566 2074 7261 6e73  s..    def trans
-00006950: 666f 726d 280a 2020 2020 2020 2020 7365  form(.        se
-00006960: 6c66 2c0a 2020 2020 2020 2020 696e 7075  lf,.        inpu
-00006970: 743a 2049 7465 7261 746f 725b 496e 7075  t: Iterator[Inpu
-00006980: 745d 2c0a 2020 2020 2020 2020 636f 6e66  t],.        conf
-00006990: 6967 3a20 4f70 7469 6f6e 616c 5b52 756e  ig: Optional[Run
-000069a0: 6e61 626c 6543 6f6e 6669 675d 203d 204e  nableConfig] = N
-000069b0: 6f6e 652c 0a20 2020 2020 2020 202a 2a6b  one,.        **k
-000069c0: 7761 7267 733a 204f 7074 696f 6e61 6c5b  wargs: Optional[
-000069d0: 416e 795d 2c0a 2020 2020 2920 2d3e 2049  Any],.    ) -> I
-000069e0: 7465 7261 746f 725b 4f75 7470 7574 5d3a  terator[Output]:
-000069f0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00006a00: 2020 2020 2044 6566 6175 6c74 2069 6d70       Default imp
-00006a10: 6c65 6d65 6e74 6174 696f 6e20 6f66 2074  lementation of t
-00006a20: 7261 6e73 666f 726d 2c20 7768 6963 6820  ransform, which 
-00006a30: 6275 6666 6572 7320 696e 7075 7420 616e  buffers input an
-00006a40: 6420 7468 656e 2063 616c 6c73 2073 7472  d then calls str
-00006a50: 6561 6d2e 0a20 2020 2020 2020 2053 7562  eam..        Sub
-00006a60: 636c 6173 7365 7320 7368 6f75 6c64 206f  classes should o
-00006a70: 7665 7272 6964 6520 7468 6973 206d 6574  verride this met
-00006a80: 686f 6420 6966 2074 6865 7920 6361 6e20  hod if they can 
-00006a90: 7374 6172 7420 7072 6f64 7563 696e 6720  start producing 
-00006aa0: 6f75 7470 7574 2077 6869 6c65 0a20 2020  output while.   
-00006ab0: 2020 2020 2069 6e70 7574 2069 7320 7374       input is st
-00006ac0: 696c 6c20 6265 696e 6720 6765 6e65 7261  ill being genera
-00006ad0: 7465 642e 0a20 2020 2020 2020 2022 2222  ted..        """
-00006ae0: 0a20 2020 2020 2020 2066 696e 616c 3a20  .        final: 
-00006af0: 496e 7075 740a 2020 2020 2020 2020 676f  Input.        go
-00006b00: 745f 6669 7273 745f 7661 6c20 3d20 4661  t_first_val = Fa
-00006b10: 6c73 650a 0a20 2020 2020 2020 2066 6f72  lse..        for
-00006b20: 2063 6875 6e6b 2069 6e20 696e 7075 743a   chunk in input:
-00006b30: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00006b40: 6e6f 7420 676f 745f 6669 7273 745f 7661  not got_first_va
-00006b50: 6c3a 0a20 2020 2020 2020 2020 2020 2020  l:.             
-00006b60: 2020 2066 696e 616c 203d 2063 6875 6e6b     final = chunk
-00006b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006b80: 2067 6f74 5f66 6972 7374 5f76 616c 203d   got_first_val =
-00006b90: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
-00006ba0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00006bb0: 2020 2020 2020 2020 2320 4d61 6b65 2061          # Make a
-00006bc0: 2062 6573 7420 6566 666f 7274 2074 6f20   best effort to 
-00006bd0: 6761 7468 6572 2c20 666f 7220 616e 7920  gather, for any 
-00006be0: 7479 7065 2074 6861 7420 7375 7070 6f72  type that suppor
-00006bf0: 7473 2060 2b60 0a20 2020 2020 2020 2020  ts `+`.         
-00006c00: 2020 2020 2020 2023 2054 6869 7320 6d65         # This me
-00006c10: 7468 6f64 2073 686f 756c 6420 7468 726f  thod should thro
-00006c20: 7720 616e 2065 7272 6f72 2069 6620 6761  w an error if ga
-00006c30: 7468 6572 696e 6720 6661 696c 732e 0a20  thering fails.. 
-00006c40: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00006c50: 696e 616c 203d 2066 696e 616c 202b 2063  inal = final + c
-00006c60: 6875 6e6b 2020 2320 7479 7065 3a20 6967  hunk  # type: ig
-00006c70: 6e6f 7265 5b6f 7065 7261 746f 725d 0a0a  nore[operator]..
-00006c80: 2020 2020 2020 2020 6966 2067 6f74 5f66          if got_f
-00006c90: 6972 7374 5f76 616c 3a0a 2020 2020 2020  irst_val:.      
-00006ca0: 2020 2020 2020 7969 656c 6420 6672 6f6d        yield from
-00006cb0: 2073 656c 662e 7374 7265 616d 2866 696e   self.stream(fin
-00006cc0: 616c 2c20 636f 6e66 6967 2c20 2a2a 6b77  al, config, **kw
-00006cd0: 6172 6773 290a 0a20 2020 2061 7379 6e63  args)..    async
-00006ce0: 2064 6566 2061 7472 616e 7366 6f72 6d28   def atransform(
-00006cf0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00006d00: 2020 2020 2020 2069 6e70 7574 3a20 4173         input: As
-00006d10: 796e 6349 7465 7261 746f 725b 496e 7075  yncIterator[Inpu
-00006d20: 745d 2c0a 2020 2020 2020 2020 636f 6e66  t],.        conf
-00006d30: 6967 3a20 4f70 7469 6f6e 616c 5b52 756e  ig: Optional[Run
-00006d40: 6e61 626c 6543 6f6e 6669 675d 203d 204e  nableConfig] = N
-00006d50: 6f6e 652c 0a20 2020 2020 2020 202a 2a6b  one,.        **k
-00006d60: 7761 7267 733a 204f 7074 696f 6e61 6c5b  wargs: Optional[
-00006d70: 416e 795d 2c0a 2020 2020 2920 2d3e 2041  Any],.    ) -> A
-00006d80: 7379 6e63 4974 6572 6174 6f72 5b4f 7574  syncIterator[Out
-00006d90: 7075 745d 3a0a 2020 2020 2020 2020 2222  put]:.        ""
-00006da0: 220a 2020 2020 2020 2020 4465 6661 756c  ".        Defaul
-00006db0: 7420 696d 706c 656d 656e 7461 7469 6f6e  t implementation
-00006dc0: 206f 6620 6174 7261 6e73 666f 726d 2c20   of atransform, 
-00006dd0: 7768 6963 6820 6275 6666 6572 7320 696e  which buffers in
-00006de0: 7075 7420 616e 6420 6361 6c6c 7320 6173  put and calls as
-00006df0: 7472 6561 6d2e 0a20 2020 2020 2020 2053  tream..        S
-00006e00: 7562 636c 6173 7365 7320 7368 6f75 6c64  ubclasses should
-00006e10: 206f 7665 7272 6964 6520 7468 6973 206d   override this m
-00006e20: 6574 686f 6420 6966 2074 6865 7920 6361  ethod if they ca
-00006e30: 6e20 7374 6172 7420 7072 6f64 7563 696e  n start producin
-00006e40: 6720 6f75 7470 7574 2077 6869 6c65 0a20  g output while. 
-00006e50: 2020 2020 2020 2069 6e70 7574 2069 7320         input is 
-00006e60: 7374 696c 6c20 6265 696e 6720 6765 6e65  still being gene
-00006e70: 7261 7465 642e 0a20 2020 2020 2020 2022  rated..        "
-00006e80: 2222 0a20 2020 2020 2020 2066 696e 616c  "".        final
-00006e90: 3a20 496e 7075 740a 2020 2020 2020 2020  : Input.        
-00006ea0: 676f 745f 6669 7273 745f 7661 6c20 3d20  got_first_val = 
-00006eb0: 4661 6c73 650a 0a20 2020 2020 2020 2061  False..        a
-00006ec0: 7379 6e63 2066 6f72 2063 6875 6e6b 2069  sync for chunk i
-00006ed0: 6e20 696e 7075 743a 0a20 2020 2020 2020  n input:.       
-00006ee0: 2020 2020 2069 6620 6e6f 7420 676f 745f       if not got_
-00006ef0: 6669 7273 745f 7661 6c3a 0a20 2020 2020  first_val:.     
-00006f00: 2020 2020 2020 2020 2020 2066 696e 616c             final
-00006f10: 203d 2063 6875 6e6b 0a20 2020 2020 2020   = chunk.       
-00006f20: 2020 2020 2020 2020 2067 6f74 5f66 6972           got_fir
-00006f30: 7374 5f76 616c 203d 2054 7275 650a 2020  st_val = True.  
-00006f40: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00006f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f60: 2320 4d61 6b65 2061 2062 6573 7420 6566  # Make a best ef
-00006f70: 666f 7274 2074 6f20 6761 7468 6572 2c20  fort to gather, 
-00006f80: 666f 7220 616e 7920 7479 7065 2074 6861  for any type tha
-00006f90: 7420 7375 7070 6f72 7473 2060 2b60 0a20  t supports `+`. 
-00006fa0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00006fb0: 2054 6869 7320 6d65 7468 6f64 2073 686f   This method sho
-00006fc0: 756c 6420 7468 726f 7720 616e 2065 7272  uld throw an err
-00006fd0: 6f72 2069 6620 6761 7468 6572 696e 6720  or if gathering 
-00006fe0: 6661 696c 732e 0a20 2020 2020 2020 2020  fails..         
-00006ff0: 2020 2020 2020 2066 696e 616c 203d 2066         final = f
-00007000: 696e 616c 202b 2063 6875 6e6b 2020 2320  inal + chunk  # 
-00007010: 7479 7065 3a20 6967 6e6f 7265 5b6f 7065  type: ignore[ope
-00007020: 7261 746f 725d 0a0a 2020 2020 2020 2020  rator]..        
-00007030: 6966 2067 6f74 5f66 6972 7374 5f76 616c  if got_first_val
-00007040: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-00007050: 796e 6320 666f 7220 6f75 7470 7574 2069  ync for output i
-00007060: 6e20 7365 6c66 2e61 7374 7265 616d 2866  n self.astream(f
-00007070: 696e 616c 2c20 636f 6e66 6967 2c20 2a2a  inal, config, **
-00007080: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
-00007090: 2020 2020 2020 2020 2079 6965 6c64 206f           yield o
-000070a0: 7574 7075 740a 0a20 2020 2064 6566 2062  utput..    def b
-000070b0: 696e 6428 7365 6c66 2c20 2a2a 6b77 6172  ind(self, **kwar
-000070c0: 6773 3a20 416e 7929 202d 3e20 5275 6e6e  gs: Any) -> Runn
-000070d0: 6162 6c65 5b49 6e70 7574 2c20 4f75 7470  able[Input, Outp
-000070e0: 7574 5d3a 0a20 2020 2020 2020 2022 2222  ut]:.        """
-000070f0: 0a20 2020 2020 2020 2042 696e 6420 6172  .        Bind ar
-00007100: 6775 6d65 6e74 7320 746f 2061 2052 756e  guments to a Run
-00007110: 6e61 626c 652c 2072 6574 7572 6e69 6e67  nable, returning
-00007120: 2061 206e 6577 2052 756e 6e61 626c 652e   a new Runnable.
-00007130: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00007140: 2020 2020 2072 6574 7572 6e20 5275 6e6e       return Runn
-00007150: 6162 6c65 4269 6e64 696e 6728 626f 756e  ableBinding(boun
-00007160: 643d 7365 6c66 2c20 6b77 6172 6773 3d6b  d=self, kwargs=k
-00007170: 7761 7267 732c 2063 6f6e 6669 673d 7b7d  wargs, config={}
-00007180: 290a 0a20 2020 2064 6566 2077 6974 685f  )..    def with_
-00007190: 636f 6e66 6967 280a 2020 2020 2020 2020  config(.        
-000071a0: 7365 6c66 2c0a 2020 2020 2020 2020 636f  self,.        co
-000071b0: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
-000071c0: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
-000071d0: 204e 6f6e 652c 0a20 2020 2020 2020 2023   None,.        #
-000071e0: 2053 6164 6c79 2055 6e70 6163 6b20 6973   Sadly Unpack is
-000071f0: 206e 6f74 2077 656c 6c20 7375 7070 6f72   not well suppor
-00007200: 7465 6420 6279 206d 7970 7920 736f 2074  ted by mypy so t
-00007210: 6869 7320 7769 6c6c 2068 6176 6520 746f  his will have to
-00007220: 2062 6520 756e 7479 7065 640a 2020 2020   be untyped.    
-00007230: 2020 2020 2a2a 6b77 6172 6773 3a20 416e      **kwargs: An
-00007240: 792c 0a20 2020 2029 202d 3e20 5275 6e6e  y,.    ) -> Runn
-00007250: 6162 6c65 5b49 6e70 7574 2c20 4f75 7470  able[Input, Outp
-00007260: 7574 5d3a 0a20 2020 2020 2020 2022 2222  ut]:.        """
-00007270: 0a20 2020 2020 2020 2042 696e 6420 636f  .        Bind co
-00007280: 6e66 6967 2074 6f20 6120 5275 6e6e 6162  nfig to a Runnab
-00007290: 6c65 2c20 7265 7475 726e 696e 6720 6120  le, returning a 
-000072a0: 6e65 7720 5275 6e6e 6162 6c65 2e0a 2020  new Runnable..  
-000072b0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000072c0: 2020 7265 7475 726e 2052 756e 6e61 626c    return Runnabl
-000072d0: 6542 696e 6469 6e67 280a 2020 2020 2020  eBinding(.      
-000072e0: 2020 2020 2020 626f 756e 643d 7365 6c66        bound=self
-000072f0: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
-00007300: 6e66 6967 3d63 6173 7428 0a20 2020 2020  nfig=cast(.     
-00007310: 2020 2020 2020 2020 2020 2052 756e 6e61             Runna
-00007320: 626c 6543 6f6e 6669 672c 0a20 2020 2020  bleConfig,.     
-00007330: 2020 2020 2020 2020 2020 207b 2a2a 2863             {**(c
-00007340: 6f6e 6669 6720 6f72 207b 7d29 2c20 2a2a  onfig or {}), **
-00007350: 6b77 6172 6773 7d2c 0a20 2020 2020 2020  kwargs},.       
-00007360: 2020 2020 2029 2c20 2023 2074 7970 653a       ),  # type:
-00007370: 2069 676e 6f72 655b 6d69 7363 5d0a 2020   ignore[misc].  
-00007380: 2020 2020 2020 2020 2020 6b77 6172 6773            kwargs
-00007390: 3d7b 7d2c 0a20 2020 2020 2020 2029 0a0a  ={},.        )..
-000073a0: 2020 2020 6465 6620 7769 7468 5f6c 6973      def with_lis
-000073b0: 7465 6e65 7273 280a 2020 2020 2020 2020  teners(.        
-000073c0: 7365 6c66 2c0a 2020 2020 2020 2020 2a2c  self,.        *,
-000073d0: 0a20 2020 2020 2020 206f 6e5f 7374 6172  .        on_star
-000073e0: 743a 204f 7074 696f 6e61 6c5b 4c69 7374  t: Optional[List
-000073f0: 656e 6572 5d20 3d20 4e6f 6e65 2c0a 2020  ener] = None,.  
-00007400: 2020 2020 2020 6f6e 5f65 6e64 3a20 4f70        on_end: Op
-00007410: 7469 6f6e 616c 5b4c 6973 7465 6e65 725d  tional[Listener]
-00007420: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00007430: 206f 6e5f 6572 726f 723a 204f 7074 696f   on_error: Optio
-00007440: 6e61 6c5b 4c69 7374 656e 6572 5d20 3d20  nal[Listener] = 
-00007450: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 2052  None,.    ) -> R
-00007460: 756e 6e61 626c 655b 496e 7075 742c 204f  unnable[Input, O
-00007470: 7574 7075 745d 3a0a 2020 2020 2020 2020  utput]:.        
-00007480: 2222 220a 2020 2020 2020 2020 4269 6e64  """.        Bind
-00007490: 206c 6966 6563 7963 6c65 206c 6973 7465   lifecycle liste
-000074a0: 6e65 7273 2074 6f20 6120 5275 6e6e 6162  ners to a Runnab
-000074b0: 6c65 2c20 7265 7475 726e 696e 6720 6120  le, returning a 
-000074c0: 6e65 7720 5275 6e6e 6162 6c65 2e0a 0a20  new Runnable... 
-000074d0: 2020 2020 2020 206f 6e5f 7374 6172 743a         on_start:
-000074e0: 2043 616c 6c65 6420 6265 666f 7265 2074   Called before t
-000074f0: 6865 2072 756e 6e61 626c 6520 7374 6172  he runnable star
-00007500: 7473 2072 756e 6e69 6e67 2c20 7769 7468  ts running, with
-00007510: 2074 6865 2052 756e 206f 626a 6563 742e   the Run object.
-00007520: 0a20 2020 2020 2020 206f 6e5f 656e 643a  .        on_end:
-00007530: 2043 616c 6c65 6420 6166 7465 7220 7468   Called after th
-00007540: 6520 7275 6e6e 6162 6c65 2066 696e 6973  e runnable finis
-00007550: 6865 7320 7275 6e6e 696e 672c 2077 6974  hes running, wit
-00007560: 6820 7468 6520 5275 6e20 6f62 6a65 6374  h the Run object
-00007570: 2e0a 2020 2020 2020 2020 6f6e 5f65 7272  ..        on_err
-00007580: 6f72 3a20 4361 6c6c 6564 2069 6620 7468  or: Called if th
-00007590: 6520 7275 6e6e 6162 6c65 2074 6872 6f77  e runnable throw
-000075a0: 7320 616e 2065 7272 6f72 2c20 7769 7468  s an error, with
-000075b0: 2074 6865 2052 756e 206f 626a 6563 742e   the Run object.
-000075c0: 0a0a 2020 2020 2020 2020 5468 6520 5275  ..        The Ru
-000075d0: 6e20 6f62 6a65 6374 2063 6f6e 7461 696e  n object contain
-000075e0: 7320 696e 666f 726d 6174 696f 6e20 6162  s information ab
-000075f0: 6f75 7420 7468 6520 7275 6e2c 2069 6e63  out the run, inc
-00007600: 6c75 6469 6e67 2069 7473 2069 642c 0a20  luding its id,. 
-00007610: 2020 2020 2020 2074 7970 652c 2069 6e70         type, inp
-00007620: 7574 2c20 6f75 7470 7574 2c20 6572 726f  ut, output, erro
-00007630: 722c 2073 7461 7274 5f74 696d 652c 2065  r, start_time, e
-00007640: 6e64 5f74 696d 652c 2061 6e64 2061 6e79  nd_time, and any
-00007650: 2074 6167 7320 6f72 206d 6574 6164 6174   tags or metadat
-00007660: 610a 2020 2020 2020 2020 6164 6465 6420  a.        added 
-00007670: 746f 2074 6865 2072 756e 2e0a 2020 2020  to the run..    
-00007680: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00007690: 6672 6f6d 206c 616e 6763 6861 696e 5f63  from langchain_c
-000076a0: 6f72 652e 7472 6163 6572 732e 726f 6f74  ore.tracers.root
-000076b0: 5f6c 6973 7465 6e65 7273 2069 6d70 6f72  _listeners impor
-000076c0: 7420 526f 6f74 4c69 7374 656e 6572 7354  t RootListenersT
-000076d0: 7261 6365 720a 0a20 2020 2020 2020 2072  racer..        r
-000076e0: 6574 7572 6e20 5275 6e6e 6162 6c65 4269  eturn RunnableBi
-000076f0: 6e64 696e 6728 0a20 2020 2020 2020 2020  nding(.         
-00007700: 2020 2062 6f75 6e64 3d73 656c 662c 0a20     bound=self,. 
-00007710: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
-00007720: 675f 6661 6374 6f72 6965 733d 5b0a 2020  g_factories=[.  
-00007730: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-00007740: 6d62 6461 2063 6f6e 6669 673a 207b 0a20  mbda config: {. 
-00007750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007760: 2020 2022 6361 6c6c 6261 636b 7322 3a20     "callbacks": 
-00007770: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-00007780: 2020 2020 2020 2020 2020 526f 6f74 4c69            RootLi
-00007790: 7374 656e 6572 7354 7261 6365 7228 0a20  stenersTracer(. 
-000077a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000077b0: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
-000077c0: 673d 636f 6e66 6967 2c0a 2020 2020 2020  g=config,.      
-000077d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000077e0: 2020 2020 2020 6f6e 5f73 7461 7274 3d6f        on_start=o
-000077f0: 6e5f 7374 6172 742c 0a20 2020 2020 2020  n_start,.       
-00007800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007810: 2020 2020 206f 6e5f 656e 643d 6f6e 5f65       on_end=on_e
-00007820: 6e64 2c0a 2020 2020 2020 2020 2020 2020  nd,.            
-00007830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007840: 6f6e 5f65 7272 6f72 3d6f 6e5f 6572 726f  on_error=on_erro
-00007850: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-00007860: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00007870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007880: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
-00007890: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-000078a0: 2020 5d2c 0a20 2020 2020 2020 2029 0a0a    ],.        )..
-000078b0: 2020 2020 6465 6620 7769 7468 5f74 7970      def with_typ
-000078c0: 6573 280a 2020 2020 2020 2020 7365 6c66  es(.        self
-000078d0: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
-000078e0: 2020 2020 2069 6e70 7574 5f74 7970 653a       input_type:
-000078f0: 204f 7074 696f 6e61 6c5b 5479 7065 5b49   Optional[Type[I
-00007900: 6e70 7574 5d5d 203d 204e 6f6e 652c 0a20  nput]] = None,. 
-00007910: 2020 2020 2020 206f 7574 7075 745f 7479         output_ty
-00007920: 7065 3a20 4f70 7469 6f6e 616c 5b54 7970  pe: Optional[Typ
-00007930: 655b 4f75 7470 7574 5d5d 203d 204e 6f6e  e[Output]] = Non
-00007940: 652c 0a20 2020 2029 202d 3e20 5275 6e6e  e,.    ) -> Runn
-00007950: 6162 6c65 5b49 6e70 7574 2c20 4f75 7470  able[Input, Outp
-00007960: 7574 5d3a 0a20 2020 2020 2020 2022 2222  ut]:.        """
-00007970: 0a20 2020 2020 2020 2042 696e 6420 696e  .        Bind in
-00007980: 7075 7420 616e 6420 6f75 7470 7574 2074  put and output t
-00007990: 7970 6573 2074 6f20 6120 5275 6e6e 6162  ypes to a Runnab
-000079a0: 6c65 2c20 7265 7475 726e 696e 6720 6120  le, returning a 
-000079b0: 6e65 7720 5275 6e6e 6162 6c65 2e0a 2020  new Runnable..  
-000079c0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000079d0: 2020 7265 7475 726e 2052 756e 6e61 626c    return Runnabl
-000079e0: 6542 696e 6469 6e67 280a 2020 2020 2020  eBinding(.      
-000079f0: 2020 2020 2020 626f 756e 643d 7365 6c66        bound=self
-00007a00: 2c0a 2020 2020 2020 2020 2020 2020 6375  ,.            cu
-00007a10: 7374 6f6d 5f69 6e70 7574 5f74 7970 653d  stom_input_type=
-00007a20: 696e 7075 745f 7479 7065 2c0a 2020 2020  input_type,.    
-00007a30: 2020 2020 2020 2020 6375 7374 6f6d 5f6f          custom_o
-00007a40: 7574 7075 745f 7479 7065 3d6f 7574 7075  utput_type=outpu
-00007a50: 745f 7479 7065 2c0a 2020 2020 2020 2020  t_type,.        
-00007a60: 2020 2020 6b77 6172 6773 3d7b 7d2c 0a20      kwargs={},. 
-00007a70: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-00007a80: 6620 7769 7468 5f72 6574 7279 280a 2020  f with_retry(.  
-00007a90: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-00007aa0: 2020 2020 2a2c 0a20 2020 2020 2020 2072      *,.        r
-00007ab0: 6574 7279 5f69 665f 6578 6365 7074 696f  etry_if_exceptio
-00007ac0: 6e5f 7479 7065 3a20 5475 706c 655b 5479  n_type: Tuple[Ty
-00007ad0: 7065 5b42 6173 6545 7863 6570 7469 6f6e  pe[BaseException
-00007ae0: 5d2c 202e 2e2e 5d20 3d20 2845 7863 6570  ], ...] = (Excep
-00007af0: 7469 6f6e 2c29 2c0a 2020 2020 2020 2020  tion,),.        
-00007b00: 7761 6974 5f65 7870 6f6e 656e 7469 616c  wait_exponential
-00007b10: 5f6a 6974 7465 723a 2062 6f6f 6c20 3d20  _jitter: bool = 
-00007b20: 5472 7565 2c0a 2020 2020 2020 2020 7374  True,.        st
-00007b30: 6f70 5f61 6674 6572 5f61 7474 656d 7074  op_after_attempt
-00007b40: 3a20 696e 7420 3d20 332c 0a20 2020 2029  : int = 3,.    )
-00007b50: 202d 3e20 5275 6e6e 6162 6c65 5b49 6e70   -> Runnable[Inp
-00007b60: 7574 2c20 4f75 7470 7574 5d3a 0a20 2020  ut, Output]:.   
-00007b70: 2020 2020 2022 2222 4372 6561 7465 2061       """Create a
-00007b80: 206e 6577 2052 756e 6e61 626c 6520 7468   new Runnable th
-00007b90: 6174 2072 6574 7269 6573 2074 6865 206f  at retries the o
-00007ba0: 7269 6769 6e61 6c20 7275 6e6e 6162 6c65  riginal runnable
-00007bb0: 206f 6e20 6578 6365 7074 696f 6e73 2e0a   on exceptions..
-00007bc0: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
-00007bd0: 2020 2020 2020 2020 2020 2072 6574 7279             retry
-00007be0: 5f69 665f 6578 6365 7074 696f 6e5f 7479  _if_exception_ty
-00007bf0: 7065 3a20 4120 7475 706c 6520 6f66 2065  pe: A tuple of e
-00007c00: 7863 6570 7469 6f6e 2074 7970 6573 2074  xception types t
-00007c10: 6f20 7265 7472 7920 6f6e 0a20 2020 2020  o retry on.     
-00007c20: 2020 2020 2020 2077 6169 745f 6578 706f         wait_expo
-00007c30: 6e65 6e74 6961 6c5f 6a69 7474 6572 3a20  nential_jitter: 
-00007c40: 5768 6574 6865 7220 746f 2061 6464 206a  Whether to add j
-00007c50: 6974 7465 7220 746f 2074 6865 2077 6169  itter to the wai
-00007c60: 7420 7469 6d65 0a20 2020 2020 2020 2020  t time.         
-00007c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007c80: 2020 2020 2020 2020 2020 2020 6265 7477              betw
-00007c90: 6565 6e20 7265 7472 6965 730a 2020 2020  een retries.    
-00007ca0: 2020 2020 2020 2020 7374 6f70 5f61 6674          stop_aft
-00007cb0: 6572 5f61 7474 656d 7074 3a20 5468 6520  er_attempt: The 
-00007cc0: 6d61 7869 6d75 6d20 6e75 6d62 6572 206f  maximum number o
-00007cd0: 6620 6174 7465 6d70 7473 2074 6f20 6d61  f attempts to ma
-00007ce0: 6b65 2062 6566 6f72 6520 6769 7669 6e67  ke before giving
-00007cf0: 2075 700a 0a20 2020 2020 2020 2052 6574   up..        Ret
-00007d00: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
-00007d10: 2020 4120 6e65 7720 5275 6e6e 6162 6c65    A new Runnable
-00007d20: 2074 6861 7420 7265 7472 6965 7320 7468   that retries th
-00007d30: 6520 6f72 6967 696e 616c 2072 756e 6e61  e original runna
-00007d40: 626c 6520 6f6e 2065 7863 6570 7469 6f6e  ble on exception
-00007d50: 732e 0a20 2020 2020 2020 2022 2222 0a20  s..        """. 
-00007d60: 2020 2020 2020 2066 726f 6d20 6c61 6e67         from lang
-00007d70: 6368 6169 6e5f 636f 7265 2e72 756e 6e61  chain_core.runna
-00007d80: 626c 6573 2e72 6574 7279 2069 6d70 6f72  bles.retry impor
-00007d90: 7420 5275 6e6e 6162 6c65 5265 7472 790a  t RunnableRetry.
-00007da0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00007db0: 5275 6e6e 6162 6c65 5265 7472 7928 0a20  RunnableRetry(. 
-00007dc0: 2020 2020 2020 2020 2020 2062 6f75 6e64             bound
-00007dd0: 3d73 656c 662c 0a20 2020 2020 2020 2020  =self,.         
-00007de0: 2020 206b 7761 7267 733d 7b7d 2c0a 2020     kwargs={},.  
-00007df0: 2020 2020 2020 2020 2020 636f 6e66 6967            config
-00007e00: 3d7b 7d2c 0a20 2020 2020 2020 2020 2020  ={},.           
-00007e10: 2072 6574 7279 5f65 7863 6570 7469 6f6e   retry_exception
-00007e20: 5f74 7970 6573 3d72 6574 7279 5f69 665f  _types=retry_if_
-00007e30: 6578 6365 7074 696f 6e5f 7479 7065 2c0a  exception_type,.
-00007e40: 2020 2020 2020 2020 2020 2020 7761 6974              wait
-00007e50: 5f65 7870 6f6e 656e 7469 616c 5f6a 6974  _exponential_jit
-00007e60: 7465 723d 7761 6974 5f65 7870 6f6e 656e  ter=wait_exponen
-00007e70: 7469 616c 5f6a 6974 7465 722c 0a20 2020  tial_jitter,.   
-00007e80: 2020 2020 2020 2020 206d 6178 5f61 7474           max_att
-00007e90: 656d 7074 5f6e 756d 6265 723d 7374 6f70  empt_number=stop
-00007ea0: 5f61 6674 6572 5f61 7474 656d 7074 2c0a  _after_attempt,.
-00007eb0: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
-00007ec0: 6566 206d 6170 2873 656c 6629 202d 3e20  ef map(self) -> 
-00007ed0: 5275 6e6e 6162 6c65 5b4c 6973 745b 496e  Runnable[List[In
-00007ee0: 7075 745d 2c20 4c69 7374 5b4f 7574 7075  put], List[Outpu
-00007ef0: 745d 5d3a 0a20 2020 2020 2020 2022 2222  t]]:.        """
-00007f00: 0a20 2020 2020 2020 2052 6574 7572 6e20  .        Return 
-00007f10: 6120 6e65 7720 5275 6e6e 6162 6c65 2074  a new Runnable t
-00007f20: 6861 7420 6d61 7073 2061 206c 6973 7420  hat maps a list 
-00007f30: 6f66 2069 6e70 7574 7320 746f 2061 206c  of inputs to a l
-00007f40: 6973 7420 6f66 206f 7574 7075 7473 2c0a  ist of outputs,.
-00007f50: 2020 2020 2020 2020 6279 2063 616c 6c69          by calli
-00007f60: 6e67 2069 6e76 6f6b 6528 2920 7769 7468  ng invoke() with
-00007f70: 2065 6163 6820 696e 7075 742e 0a20 2020   each input..   
-00007f80: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00007f90: 2072 6574 7572 6e20 5275 6e6e 6162 6c65   return Runnable
-00007fa0: 4561 6368 2862 6f75 6e64 3d73 656c 6629  Each(bound=self)
-00007fb0: 0a0a 2020 2020 6465 6620 7769 7468 5f66  ..    def with_f
-00007fc0: 616c 6c62 6163 6b73 280a 2020 2020 2020  allbacks(.      
-00007fd0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-00007fe0: 6661 6c6c 6261 636b 733a 2053 6571 7565  fallbacks: Seque
-00007ff0: 6e63 655b 5275 6e6e 6162 6c65 5b49 6e70  nce[Runnable[Inp
-00008000: 7574 2c20 4f75 7470 7574 5d5d 2c0a 2020  ut, Output]],.  
-00008010: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
-00008020: 2065 7863 6570 7469 6f6e 735f 746f 5f68   exceptions_to_h
-00008030: 616e 646c 653a 2054 7570 6c65 5b54 7970  andle: Tuple[Typ
-00008040: 655b 4261 7365 4578 6365 7074 696f 6e5d  e[BaseException]
-00008050: 2c20 2e2e 2e5d 203d 2028 4578 6365 7074  , ...] = (Except
-00008060: 696f 6e2c 292c 0a20 2020 2029 202d 3e20  ion,),.    ) -> 
-00008070: 5275 6e6e 6162 6c65 5769 7468 4661 6c6c  RunnableWithFall
-00008080: 6261 636b 7354 5b49 6e70 7574 2c20 4f75  backsT[Input, Ou
-00008090: 7470 7574 5d3a 0a20 2020 2020 2020 2022  tput]:.        "
-000080a0: 2222 4164 6420 6661 6c6c 6261 636b 7320  ""Add fallbacks 
-000080b0: 746f 2061 2072 756e 6e61 626c 652c 2072  to a runnable, r
-000080c0: 6574 7572 6e69 6e67 2061 206e 6577 2052  eturning a new R
-000080d0: 756e 6e61 626c 652e 0a0a 2020 2020 2020  unnable...      
-000080e0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-000080f0: 2020 2020 6661 6c6c 6261 636b 733a 2041      fallbacks: A
-00008100: 2073 6571 7565 6e63 6520 6f66 2072 756e   sequence of run
-00008110: 6e61 626c 6573 2074 6f20 7472 7920 6966  nables to try if
-00008120: 2074 6865 206f 7269 6769 6e61 6c20 7275   the original ru
-00008130: 6e6e 6162 6c65 2066 6169 6c73 2e0a 2020  nnable fails..  
-00008140: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00008150: 696f 6e73 5f74 6f5f 6861 6e64 6c65 3a20  ions_to_handle: 
-00008160: 4120 7475 706c 6520 6f66 2065 7863 6570  A tuple of excep
-00008170: 7469 6f6e 2074 7970 6573 2074 6f20 6861  tion types to ha
-00008180: 6e64 6c65 2e0a 0a20 2020 2020 2020 2052  ndle...        R
-00008190: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-000081a0: 2020 2020 4120 6e65 7720 5275 6e6e 6162      A new Runnab
-000081b0: 6c65 2074 6861 7420 7769 6c6c 2074 7279  le that will try
-000081c0: 2074 6865 206f 7269 6769 6e61 6c20 7275   the original ru
-000081d0: 6e6e 6162 6c65 2c20 616e 6420 7468 656e  nnable, and then
-000081e0: 2065 6163 680a 2020 2020 2020 2020 2020   each.          
-000081f0: 2020 6661 6c6c 6261 636b 2069 6e20 6f72    fallback in or
-00008200: 6465 722c 2075 706f 6e20 6661 696c 7572  der, upon failur
-00008210: 6573 2e0a 2020 2020 2020 2020 2222 220a  es..        """.
-00008220: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
-00008230: 6763 6861 696e 5f63 6f72 652e 7275 6e6e  gchain_core.runn
-00008240: 6162 6c65 732e 6661 6c6c 6261 636b 7320  ables.fallbacks 
-00008250: 696d 706f 7274 2052 756e 6e61 626c 6557  import RunnableW
-00008260: 6974 6846 616c 6c62 6163 6b73 0a0a 2020  ithFallbacks..  
-00008270: 2020 2020 2020 7265 7475 726e 2052 756e        return Run
-00008280: 6e61 626c 6557 6974 6846 616c 6c62 6163  nableWithFallbac
-00008290: 6b73 280a 2020 2020 2020 2020 2020 2020  ks(.            
-000082a0: 7275 6e6e 6162 6c65 3d73 656c 662c 0a20  runnable=self,. 
-000082b0: 2020 2020 2020 2020 2020 2066 616c 6c62             fallb
-000082c0: 6163 6b73 3d66 616c 6c62 6163 6b73 2c0a  acks=fallbacks,.
-000082d0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-000082e0: 7074 696f 6e73 5f74 6f5f 6861 6e64 6c65  ptions_to_handle
-000082f0: 3d65 7863 6570 7469 6f6e 735f 746f 5f68  =exceptions_to_h
-00008300: 616e 646c 652c 0a20 2020 2020 2020 2029  andle,.        )
-00008310: 0a0a 2020 2020 2222 2220 2d2d 2d20 4865  ..    """ --- He
-00008320: 6c70 6572 206d 6574 686f 6473 2066 6f72  lper methods for
-00008330: 2053 7562 636c 6173 7365 7320 2d2d 2d20   Subclasses --- 
-00008340: 2222 220a 0a20 2020 2064 6566 205f 6361  """..    def _ca
-00008350: 6c6c 5f77 6974 685f 636f 6e66 6967 280a  ll_with_config(.
-00008360: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00008370: 2020 2020 2020 6675 6e63 3a20 556e 696f        func: Unio
-00008380: 6e5b 0a20 2020 2020 2020 2020 2020 2043  n[.            C
-00008390: 616c 6c61 626c 655b 5b49 6e70 7574 5d2c  allable[[Input],
-000083a0: 204f 7574 7075 745d 2c0a 2020 2020 2020   Output],.      
-000083b0: 2020 2020 2020 4361 6c6c 6162 6c65 5b5b        Callable[[
-000083c0: 496e 7075 742c 2043 616c 6c62 6163 6b4d  Input, CallbackM
-000083d0: 616e 6167 6572 466f 7243 6861 696e 5275  anagerForChainRu
-000083e0: 6e5d 2c20 4f75 7470 7574 5d2c 0a20 2020  n], Output],.   
-000083f0: 2020 2020 2020 2020 2043 616c 6c61 626c           Callabl
-00008400: 655b 5b49 6e70 7574 2c20 4361 6c6c 6261  e[[Input, Callba
-00008410: 636b 4d61 6e61 6765 7246 6f72 4368 6169  ckManagerForChai
-00008420: 6e52 756e 2c20 5275 6e6e 6162 6c65 436f  nRun, RunnableCo
-00008430: 6e66 6967 5d2c 204f 7574 7075 745d 2c0a  nfig], Output],.
-00008440: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00008450: 2020 2069 6e70 7574 3a20 496e 7075 742c     input: Input,
-00008460: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
-00008470: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
-00008480: 6c65 436f 6e66 6967 5d2c 0a20 2020 2020  leConfig],.     
-00008490: 2020 2072 756e 5f74 7970 653a 204f 7074     run_type: Opt
-000084a0: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
-000084b0: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
-000084c0: 7267 733a 204f 7074 696f 6e61 6c5b 416e  rgs: Optional[An
-000084d0: 795d 2c0a 2020 2020 2920 2d3e 204f 7574  y],.    ) -> Out
-000084e0: 7075 743a 0a20 2020 2020 2020 2022 2222  put:.        """
-000084f0: 4865 6c70 6572 206d 6574 686f 6420 746f  Helper method to
-00008500: 2074 7261 6e73 666f 726d 2061 6e20 496e   transform an In
-00008510: 7075 7420 7661 6c75 6520 746f 2061 6e20  put value to an 
-00008520: 4f75 7470 7574 2076 616c 7565 2c0a 2020  Output value,.  
-00008530: 2020 2020 2020 7769 7468 2063 616c 6c62        with callb
-00008540: 6163 6b73 2e20 5573 6520 7468 6973 206d  acks. Use this m
-00008550: 6574 686f 6420 746f 2069 6d70 6c65 6d65  ethod to impleme
-00008560: 6e74 2069 6e76 6f6b 6528 2920 696e 2073  nt invoke() in s
-00008570: 7562 636c 6173 7365 732e 2222 220a 2020  ubclasses.""".  
-00008580: 2020 2020 2020 636f 6e66 6967 203d 2065        config = e
-00008590: 6e73 7572 655f 636f 6e66 6967 2863 6f6e  nsure_config(con
-000085a0: 6669 6729 0a20 2020 2020 2020 2063 616c  fig).        cal
-000085b0: 6c62 6163 6b5f 6d61 6e61 6765 7220 3d20  lback_manager = 
-000085c0: 6765 745f 6361 6c6c 6261 636b 5f6d 616e  get_callback_man
-000085d0: 6167 6572 5f66 6f72 5f63 6f6e 6669 6728  ager_for_config(
-000085e0: 636f 6e66 6967 290a 2020 2020 2020 2020  config).        
-000085f0: 7275 6e5f 6d61 6e61 6765 7220 3d20 6361  run_manager = ca
-00008600: 6c6c 6261 636b 5f6d 616e 6167 6572 2e6f  llback_manager.o
-00008610: 6e5f 6368 6169 6e5f 7374 6172 7428 0a20  n_chain_start(. 
-00008620: 2020 2020 2020 2020 2020 2064 756d 7064             dumpd
-00008630: 2873 656c 6629 2c0a 2020 2020 2020 2020  (self),.        
-00008640: 2020 2020 696e 7075 742c 0a20 2020 2020      input,.     
-00008650: 2020 2020 2020 2072 756e 5f74 7970 653d         run_type=
-00008660: 7275 6e5f 7479 7065 2c0a 2020 2020 2020  run_type,.      
-00008670: 2020 2020 2020 6e61 6d65 3d63 6f6e 6669        name=confi
-00008680: 672e 6765 7428 2272 756e 5f6e 616d 6522  g.get("run_name"
-00008690: 2920 6f72 2073 656c 662e 6765 745f 6e61  ) or self.get_na
-000086a0: 6d65 2829 2c0a 2020 2020 2020 2020 290a  me(),.        ).
-000086b0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-000086c0: 2020 2020 2020 2020 2063 6869 6c64 5f63           child_c
-000086d0: 6f6e 6669 6720 3d20 7061 7463 685f 636f  onfig = patch_co
-000086e0: 6e66 6967 2863 6f6e 6669 672c 2063 616c  nfig(config, cal
-000086f0: 6c62 6163 6b73 3d72 756e 5f6d 616e 6167  lbacks=run_manag
-00008700: 6572 2e67 6574 5f63 6869 6c64 2829 290a  er.get_child()).
-00008710: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00008720: 6578 7420 3d20 636f 7079 5f63 6f6e 7465  ext = copy_conte
-00008730: 7874 2829 0a20 2020 2020 2020 2020 2020  xt().           
-00008740: 2063 6f6e 7465 7874 2e72 756e 2876 6172   context.run(var
-00008750: 5f63 6869 6c64 5f72 756e 6e61 626c 655f  _child_runnable_
-00008760: 636f 6e66 6967 2e73 6574 2c20 6368 696c  config.set, chil
-00008770: 645f 636f 6e66 6967 290a 2020 2020 2020  d_config).      
-00008780: 2020 2020 2020 6f75 7470 7574 203d 2063        output = c
-00008790: 6173 7428 0a20 2020 2020 2020 2020 2020  ast(.           
-000087a0: 2020 2020 204f 7574 7075 742c 0a20 2020       Output,.   
-000087b0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-000087c0: 7465 7874 2e72 756e 280a 2020 2020 2020  text.run(.      
-000087d0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-000087e0: 6c6c 5f66 756e 635f 7769 7468 5f76 6172  ll_func_with_var
-000087f0: 6961 626c 655f 6172 6773 2c0a 2020 2020  iable_args,.    
-00008800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008810: 6675 6e63 2c20 2023 2074 7970 653a 2069  func,  # type: i
-00008820: 676e 6f72 655b 6172 672d 7479 7065 5d0a  gnore[arg-type].
-00008830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008840: 2020 2020 696e 7075 742c 2020 2320 7479      input,  # ty
-00008850: 7065 3a20 6967 6e6f 7265 5b61 7267 2d74  pe: ignore[arg-t
-00008860: 7970 655d 0a20 2020 2020 2020 2020 2020  ype].           
-00008870: 2020 2020 2020 2020 2063 6f6e 6669 672c           config,
-00008880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008890: 2020 2020 2072 756e 5f6d 616e 6167 6572       run_manager
-000088a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000088b0: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
-000088c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000088d0: 292c 0a20 2020 2020 2020 2020 2020 2029  ),.            )
-000088e0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-000088f0: 4261 7365 4578 6365 7074 696f 6e20 6173  BaseException as
-00008900: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00008910: 7275 6e5f 6d61 6e61 6765 722e 6f6e 5f63  run_manager.on_c
-00008920: 6861 696e 5f65 7272 6f72 2865 290a 2020  hain_error(e).  
-00008930: 2020 2020 2020 2020 2020 7261 6973 650a            raise.
-00008940: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00008950: 2020 2020 2020 2020 2020 7275 6e5f 6d61            run_ma
-00008960: 6e61 6765 722e 6f6e 5f63 6861 696e 5f65  nager.on_chain_e
-00008970: 6e64 2864 756d 7064 286f 7574 7075 7429  nd(dumpd(output)
-00008980: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00008990: 7475 726e 206f 7574 7075 740a 0a20 2020  turn output..   
-000089a0: 2061 7379 6e63 2064 6566 205f 6163 616c   async def _acal
-000089b0: 6c5f 7769 7468 5f63 6f6e 6669 6728 0a20  l_with_config(. 
-000089c0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-000089d0: 2020 2020 2066 756e 633a 2055 6e69 6f6e       func: Union
-000089e0: 5b0a 2020 2020 2020 2020 2020 2020 4361  [.            Ca
-000089f0: 6c6c 6162 6c65 5b5b 496e 7075 745d 2c20  llable[[Input], 
-00008a00: 4177 6169 7461 626c 655b 4f75 7470 7574  Awaitable[Output
-00008a10: 5d5d 2c0a 2020 2020 2020 2020 2020 2020  ]],.            
-00008a20: 4361 6c6c 6162 6c65 5b5b 496e 7075 742c  Callable[[Input,
-00008a30: 2041 7379 6e63 4361 6c6c 6261 636b 4d61   AsyncCallbackMa
-00008a40: 6e61 6765 7246 6f72 4368 6169 6e52 756e  nagerForChainRun
-00008a50: 5d2c 2041 7761 6974 6162 6c65 5b4f 7574  ], Awaitable[Out
-00008a60: 7075 745d 5d2c 0a20 2020 2020 2020 2020  put]],.         
-00008a70: 2020 2043 616c 6c61 626c 655b 0a20 2020     Callable[.   
-00008a80: 2020 2020 2020 2020 2020 2020 205b 496e               [In
-00008a90: 7075 742c 2041 7379 6e63 4361 6c6c 6261  put, AsyncCallba
-00008aa0: 636b 4d61 6e61 6765 7246 6f72 4368 6169  ckManagerForChai
-00008ab0: 6e52 756e 2c20 5275 6e6e 6162 6c65 436f  nRun, RunnableCo
-00008ac0: 6e66 6967 5d2c 0a20 2020 2020 2020 2020  nfig],.         
-00008ad0: 2020 2020 2020 2041 7761 6974 6162 6c65         Awaitable
-00008ae0: 5b4f 7574 7075 745d 2c0a 2020 2020 2020  [Output],.      
-00008af0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00008b00: 205d 2c0a 2020 2020 2020 2020 696e 7075   ],.        inpu
-00008b10: 743a 2049 6e70 7574 2c0a 2020 2020 2020  t: Input,.      
-00008b20: 2020 636f 6e66 6967 3a20 4f70 7469 6f6e    config: Option
-00008b30: 616c 5b52 756e 6e61 626c 6543 6f6e 6669  al[RunnableConfi
-00008b40: 675d 2c0a 2020 2020 2020 2020 7275 6e5f  g],.        run_
-00008b50: 7479 7065 3a20 4f70 7469 6f6e 616c 5b73  type: Optional[s
-00008b60: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
-00008b70: 2020 2020 2a2a 6b77 6172 6773 3a20 4f70      **kwargs: Op
-00008b80: 7469 6f6e 616c 5b41 6e79 5d2c 0a20 2020  tional[Any],.   
-00008b90: 2029 202d 3e20 4f75 7470 7574 3a0a 2020   ) -> Output:.  
-00008ba0: 2020 2020 2020 2222 2248 656c 7065 7220        """Helper 
-00008bb0: 6d65 7468 6f64 2074 6f20 7472 616e 7366  method to transf
-00008bc0: 6f72 6d20 616e 2049 6e70 7574 2076 616c  orm an Input val
-00008bd0: 7565 2074 6f20 616e 204f 7574 7075 7420  ue to an Output 
-00008be0: 7661 6c75 652c 0a20 2020 2020 2020 2077  value,.        w
-00008bf0: 6974 6820 6361 6c6c 6261 636b 732e 2055  ith callbacks. U
-00008c00: 7365 2074 6869 7320 6d65 7468 6f64 2074  se this method t
-00008c10: 6f20 696d 706c 656d 656e 7420 6169 6e76  o implement ainv
-00008c20: 6f6b 6528 2920 696e 2073 7562 636c 6173  oke() in subclas
-00008c30: 7365 732e 2222 220a 2020 2020 2020 2020  ses.""".        
-00008c40: 636f 6e66 6967 203d 2065 6e73 7572 655f  config = ensure_
-00008c50: 636f 6e66 6967 2863 6f6e 6669 6729 0a20  config(config). 
-00008c60: 2020 2020 2020 2063 616c 6c62 6163 6b5f         callback_
-00008c70: 6d61 6e61 6765 7220 3d20 6765 745f 6173  manager = get_as
-00008c80: 796e 635f 6361 6c6c 6261 636b 5f6d 616e  ync_callback_man
-00008c90: 6167 6572 5f66 6f72 5f63 6f6e 6669 6728  ager_for_config(
-00008ca0: 636f 6e66 6967 290a 2020 2020 2020 2020  config).        
-00008cb0: 7275 6e5f 6d61 6e61 6765 7220 3d20 6177  run_manager = aw
-00008cc0: 6169 7420 6361 6c6c 6261 636b 5f6d 616e  ait callback_man
-00008cd0: 6167 6572 2e6f 6e5f 6368 6169 6e5f 7374  ager.on_chain_st
-00008ce0: 6172 7428 0a20 2020 2020 2020 2020 2020  art(.           
-00008cf0: 2064 756d 7064 2873 656c 6629 2c0a 2020   dumpd(self),.  
-00008d00: 2020 2020 2020 2020 2020 696e 7075 742c            input,
-00008d10: 0a20 2020 2020 2020 2020 2020 2072 756e  .            run
-00008d20: 5f74 7970 653d 7275 6e5f 7479 7065 2c0a  _type=run_type,.
-00008d30: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00008d40: 3d63 6f6e 6669 672e 6765 7428 2272 756e  =config.get("run
-00008d50: 5f6e 616d 6522 2920 6f72 2073 656c 662e  _name") or self.
-00008d60: 6765 745f 6e61 6d65 2829 2c0a 2020 2020  get_name(),.    
-00008d70: 2020 2020 290a 2020 2020 2020 2020 7472      ).        tr
-00008d80: 793a 0a20 2020 2020 2020 2020 2020 2063  y:.            c
-00008d90: 6869 6c64 5f63 6f6e 6669 6720 3d20 7061  hild_config = pa
-00008da0: 7463 685f 636f 6e66 6967 2863 6f6e 6669  tch_config(confi
-00008db0: 672c 2063 616c 6c62 6163 6b73 3d72 756e  g, callbacks=run
-00008dc0: 5f6d 616e 6167 6572 2e67 6574 5f63 6869  _manager.get_chi
-00008dd0: 6c64 2829 290a 2020 2020 2020 2020 2020  ld()).          
-00008de0: 2020 636f 6e74 6578 7420 3d20 636f 7079    context = copy
-00008df0: 5f63 6f6e 7465 7874 2829 0a20 2020 2020  _context().     
-00008e00: 2020 2020 2020 2063 6f6e 7465 7874 2e72         context.r
-00008e10: 756e 2876 6172 5f63 6869 6c64 5f72 756e  un(var_child_run
-00008e20: 6e61 626c 655f 636f 6e66 6967 2e73 6574  nable_config.set
-00008e30: 2c20 6368 696c 645f 636f 6e66 6967 290a  , child_config).
-00008e40: 2020 2020 2020 2020 2020 2020 636f 726f              coro
-00008e50: 203d 2061 6361 6c6c 5f66 756e 635f 7769   = acall_func_wi
-00008e60: 7468 5f76 6172 6961 626c 655f 6172 6773  th_variable_args
-00008e70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00008e80: 2020 6675 6e63 2c20 696e 7075 742c 2063    func, input, c
-00008e90: 6f6e 6669 672c 2072 756e 5f6d 616e 6167  onfig, run_manag
-00008ea0: 6572 2c20 2a2a 6b77 6172 6773 0a20 2020  er, **kwargs.   
-00008eb0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00008ec0: 2020 2020 2020 2069 6620 6163 6365 7074         if accept
-00008ed0: 735f 636f 6e74 6578 7428 6173 796e 6369  s_context(asynci
-00008ee0: 6f2e 6372 6561 7465 5f74 6173 6b29 3a0a  o.create_task):.
-00008ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f00: 6f75 7470 7574 3a20 4f75 7470 7574 203d  output: Output =
-00008f10: 2061 7761 6974 2061 7379 6e63 696f 2e63   await asyncio.c
-00008f20: 7265 6174 655f 7461 736b 2863 6f72 6f2c  reate_task(coro,
-00008f30: 2063 6f6e 7465 7874 3d63 6f6e 7465 7874   context=context
-00008f40: 2920 2023 2074 7970 653a 2069 676e 6f72  )  # type: ignor
-00008f50: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
-00008f60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00008f70: 2020 2020 6f75 7470 7574 203d 2061 7761      output = awa
-00008f80: 6974 2063 6f72 6f0a 2020 2020 2020 2020  it coro.        
-00008f90: 6578 6365 7074 2042 6173 6545 7863 6570  except BaseExcep
-00008fa0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-00008fb0: 2020 2020 2020 2061 7761 6974 2072 756e         await run
-00008fc0: 5f6d 616e 6167 6572 2e6f 6e5f 6368 6169  _manager.on_chai
-00008fd0: 6e5f 6572 726f 7228 6529 0a20 2020 2020  n_error(e).     
-00008fe0: 2020 2020 2020 2072 6169 7365 0a20 2020         raise.   
-00008ff0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00009000: 2020 2020 2020 2061 7761 6974 2072 756e         await run
-00009010: 5f6d 616e 6167 6572 2e6f 6e5f 6368 6169  _manager.on_chai
-00009020: 6e5f 656e 6428 6475 6d70 6428 6f75 7470  n_end(dumpd(outp
-00009030: 7574 2929 0a20 2020 2020 2020 2020 2020  ut)).           
-00009040: 2072 6574 7572 6e20 6f75 7470 7574 0a0a   return output..
-00009050: 2020 2020 6465 6620 5f62 6174 6368 5f77      def _batch_w
-00009060: 6974 685f 636f 6e66 6967 280a 2020 2020  ith_config(.    
-00009070: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00009080: 2020 6675 6e63 3a20 556e 696f 6e5b 0a20    func: Union[. 
-00009090: 2020 2020 2020 2020 2020 2043 616c 6c61             Calla
-000090a0: 626c 655b 5b4c 6973 745b 496e 7075 745d  ble[[List[Input]
-000090b0: 5d2c 204c 6973 745b 556e 696f 6e5b 4578  ], List[Union[Ex
-000090c0: 6365 7074 696f 6e2c 204f 7574 7075 745d  ception, Output]
-000090d0: 5d5d 2c0a 2020 2020 2020 2020 2020 2020  ]],.            
-000090e0: 4361 6c6c 6162 6c65 5b0a 2020 2020 2020  Callable[.      
-000090f0: 2020 2020 2020 2020 2020 5b4c 6973 745b            [List[
-00009100: 496e 7075 745d 2c20 4c69 7374 5b43 616c  Input], List[Cal
-00009110: 6c62 6163 6b4d 616e 6167 6572 466f 7243  lbackManagerForC
-00009120: 6861 696e 5275 6e5d 5d2c 0a20 2020 2020  hainRun]],.     
-00009130: 2020 2020 2020 2020 2020 204c 6973 745b             List[
-00009140: 556e 696f 6e5b 4578 6365 7074 696f 6e2c  Union[Exception,
-00009150: 204f 7574 7075 745d 5d2c 0a20 2020 2020   Output]],.     
-00009160: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00009170: 2020 2020 2020 4361 6c6c 6162 6c65 5b0a        Callable[.
-00009180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009190: 5b4c 6973 745b 496e 7075 745d 2c20 4c69  [List[Input], Li
-000091a0: 7374 5b43 616c 6c62 6163 6b4d 616e 6167  st[CallbackManag
-000091b0: 6572 466f 7243 6861 696e 5275 6e5d 2c20  erForChainRun], 
-000091c0: 4c69 7374 5b52 756e 6e61 626c 6543 6f6e  List[RunnableCon
-000091d0: 6669 675d 5d2c 0a20 2020 2020 2020 2020  fig]],.         
-000091e0: 2020 2020 2020 204c 6973 745b 556e 696f         List[Unio
-000091f0: 6e5b 4578 6365 7074 696f 6e2c 204f 7574  n[Exception, Out
-00009200: 7075 745d 5d2c 0a20 2020 2020 2020 2020  put]],.         
-00009210: 2020 205d 2c0a 2020 2020 2020 2020 5d2c     ],.        ],
-00009220: 0a20 2020 2020 2020 2069 6e70 7574 3a20  .        input: 
-00009230: 4c69 7374 5b49 6e70 7574 5d2c 0a20 2020  List[Input],.   
-00009240: 2020 2020 2063 6f6e 6669 673a 204f 7074       config: Opt
-00009250: 696f 6e61 6c5b 556e 696f 6e5b 5275 6e6e  ional[Union[Runn
-00009260: 6162 6c65 436f 6e66 6967 2c20 4c69 7374  ableConfig, List
-00009270: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
-00009280: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
-00009290: 2020 202a 2c0a 2020 2020 2020 2020 7265     *,.        re
-000092a0: 7475 726e 5f65 7863 6570 7469 6f6e 733a  turn_exceptions:
-000092b0: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-000092c0: 2020 2020 2020 2072 756e 5f74 7970 653a         run_type:
-000092d0: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-000092e0: 204e 6f6e 652c 0a20 2020 2020 2020 202a   None,.        *
-000092f0: 2a6b 7761 7267 733a 204f 7074 696f 6e61  *kwargs: Optiona
-00009300: 6c5b 416e 795d 2c0a 2020 2020 2920 2d3e  l[Any],.    ) ->
-00009310: 204c 6973 745b 4f75 7470 7574 5d3a 0a20   List[Output]:. 
-00009320: 2020 2020 2020 2022 2222 4865 6c70 6572         """Helper
-00009330: 206d 6574 686f 6420 746f 2074 7261 6e73   method to trans
-00009340: 666f 726d 2061 6e20 496e 7075 7420 7661  form an Input va
-00009350: 6c75 6520 746f 2061 6e20 4f75 7470 7574  lue to an Output
-00009360: 2076 616c 7565 2c0a 2020 2020 2020 2020   value,.        
-00009370: 7769 7468 2063 616c 6c62 6163 6b73 2e20  with callbacks. 
-00009380: 5573 6520 7468 6973 206d 6574 686f 6420  Use this method 
-00009390: 746f 2069 6d70 6c65 6d65 6e74 2069 6e76  to implement inv
-000093a0: 6f6b 6528 2920 696e 2073 7562 636c 6173  oke() in subclas
-000093b0: 7365 732e 2222 220a 2020 2020 2020 2020  ses.""".        
-000093c0: 6966 206e 6f74 2069 6e70 7574 3a0a 2020  if not input:.  
-000093d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000093e0: 205b 5d0a 0a20 2020 2020 2020 2063 6f6e   []..        con
-000093f0: 6669 6773 203d 2067 6574 5f63 6f6e 6669  figs = get_confi
-00009400: 675f 6c69 7374 2863 6f6e 6669 672c 206c  g_list(config, l
-00009410: 656e 2869 6e70 7574 2929 0a20 2020 2020  en(input)).     
-00009420: 2020 2063 616c 6c62 6163 6b5f 6d61 6e61     callback_mana
-00009430: 6765 7273 203d 205b 6765 745f 6361 6c6c  gers = [get_call
-00009440: 6261 636b 5f6d 616e 6167 6572 5f66 6f72  back_manager_for
-00009450: 5f63 6f6e 6669 6728 6329 2066 6f72 2063  _config(c) for c
-00009460: 2069 6e20 636f 6e66 6967 735d 0a20 2020   in configs].   
-00009470: 2020 2020 2072 756e 5f6d 616e 6167 6572       run_manager
-00009480: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
-00009490: 2020 6361 6c6c 6261 636b 5f6d 616e 6167    callback_manag
-000094a0: 6572 2e6f 6e5f 6368 6169 6e5f 7374 6172  er.on_chain_star
-000094b0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-000094c0: 2020 2064 756d 7064 2873 656c 6629 2c0a     dumpd(self),.
-000094d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000094e0: 696e 7075 742c 0a20 2020 2020 2020 2020  input,.         
-000094f0: 2020 2020 2020 2072 756e 5f74 7970 653d         run_type=
-00009500: 7275 6e5f 7479 7065 2c0a 2020 2020 2020  run_type,.      
-00009510: 2020 2020 2020 2020 2020 6e61 6d65 3d63            name=c
-00009520: 6f6e 6669 672e 6765 7428 2272 756e 5f6e  onfig.get("run_n
-00009530: 616d 6522 2920 6f72 2073 656c 662e 6765  ame") or self.ge
-00009540: 745f 6e61 6d65 2829 2c0a 2020 2020 2020  t_name(),.      
-00009550: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00009560: 2020 2020 666f 7220 6361 6c6c 6261 636b      for callback
-00009570: 5f6d 616e 6167 6572 2c20 696e 7075 742c  _manager, input,
-00009580: 2063 6f6e 6669 6720 696e 207a 6970 280a   config in zip(.
-00009590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000095a0: 6361 6c6c 6261 636b 5f6d 616e 6167 6572  callback_manager
-000095b0: 732c 2069 6e70 7574 2c20 636f 6e66 6967  s, input, config
-000095c0: 730a 2020 2020 2020 2020 2020 2020 290a  s.            ).
-000095d0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-000095e0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-000095f0: 2020 2069 6620 6163 6365 7074 735f 636f     if accepts_co
-00009600: 6e66 6967 2866 756e 6329 3a0a 2020 2020  nfig(func):.    
-00009610: 2020 2020 2020 2020 2020 2020 6b77 6172              kwar
-00009620: 6773 5b22 636f 6e66 6967 225d 203d 205b  gs["config"] = [
-00009630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009640: 2020 2020 2070 6174 6368 5f63 6f6e 6669       patch_confi
-00009650: 6728 632c 2063 616c 6c62 6163 6b73 3d72  g(c, callbacks=r
-00009660: 6d2e 6765 745f 6368 696c 6428 2929 0a20  m.get_child()). 
-00009670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009680: 2020 2066 6f72 2063 2c20 726d 2069 6e20     for c, rm in 
-00009690: 7a69 7028 636f 6e66 6967 732c 2072 756e  zip(configs, run
-000096a0: 5f6d 616e 6167 6572 7329 0a20 2020 2020  _managers).     
-000096b0: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
-000096c0: 2020 2020 2020 2020 2069 6620 6163 6365           if acce
-000096d0: 7074 735f 7275 6e5f 6d61 6e61 6765 7228  pts_run_manager(
-000096e0: 6675 6e63 293a 0a20 2020 2020 2020 2020  func):.         
-000096f0: 2020 2020 2020 206b 7761 7267 735b 2272         kwargs["r
-00009700: 756e 5f6d 616e 6167 6572 225d 203d 2072  un_manager"] = r
-00009710: 756e 5f6d 616e 6167 6572 730a 2020 2020  un_managers.    
-00009720: 2020 2020 2020 2020 6f75 7470 7574 203d          output =
-00009730: 2066 756e 6328 696e 7075 742c 202a 2a6b   func(input, **k
-00009740: 7761 7267 7329 2020 2320 7479 7065 3a20  wargs)  # type: 
-00009750: 6967 6e6f 7265 5b63 616c 6c2d 6172 675d  ignore[call-arg]
-00009760: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00009770: 4261 7365 4578 6365 7074 696f 6e20 6173  BaseException as
-00009780: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00009790: 666f 7220 7275 6e5f 6d61 6e61 6765 7220  for run_manager 
-000097a0: 696e 2072 756e 5f6d 616e 6167 6572 733a  in run_managers:
-000097b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000097c0: 2072 756e 5f6d 616e 6167 6572 2e6f 6e5f   run_manager.on_
-000097d0: 6368 6169 6e5f 6572 726f 7228 6529 0a20  chain_error(e). 
-000097e0: 2020 2020 2020 2020 2020 2069 6620 7265             if re
-000097f0: 7475 726e 5f65 7863 6570 7469 6f6e 733a  turn_exceptions:
-00009800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009810: 2072 6574 7572 6e20 6361 7374 284c 6973   return cast(Lis
-00009820: 745b 4f75 7470 7574 5d2c 205b 6520 666f  t[Output], [e fo
-00009830: 7220 5f20 696e 2069 6e70 7574 5d29 0a20  r _ in input]). 
-00009840: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00009850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009860: 2072 6169 7365 0a20 2020 2020 2020 2065   raise.        e
-00009870: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00009880: 2066 6972 7374 5f65 7863 6570 7469 6f6e   first_exception
-00009890: 3a20 4f70 7469 6f6e 616c 5b45 7863 6570  : Optional[Excep
-000098a0: 7469 6f6e 5d20 3d20 4e6f 6e65 0a20 2020  tion] = None.   
-000098b0: 2020 2020 2020 2020 2066 6f72 2072 756e           for run
-000098c0: 5f6d 616e 6167 6572 2c20 6f75 7420 696e  _manager, out in
-000098d0: 207a 6970 2872 756e 5f6d 616e 6167 6572   zip(run_manager
-000098e0: 732c 206f 7574 7075 7429 3a0a 2020 2020  s, output):.    
-000098f0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00009900: 7369 6e73 7461 6e63 6528 6f75 742c 2045  sinstance(out, E
-00009910: 7863 6570 7469 6f6e 293a 0a20 2020 2020  xception):.     
-00009920: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00009930: 6972 7374 5f65 7863 6570 7469 6f6e 203d  irst_exception =
-00009940: 2066 6972 7374 5f65 7863 6570 7469 6f6e   first_exception
-00009950: 206f 7220 6f75 740a 2020 2020 2020 2020   or out.        
-00009960: 2020 2020 2020 2020 2020 2020 7275 6e5f              run_
-00009970: 6d61 6e61 6765 722e 6f6e 5f63 6861 696e  manager.on_chain
-00009980: 5f65 7272 6f72 286f 7574 290a 2020 2020  _error(out).    
-00009990: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000099a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000099b0: 2020 2020 2020 7275 6e5f 6d61 6e61 6765        run_manage
-000099c0: 722e 6f6e 5f63 6861 696e 5f65 6e64 2864  r.on_chain_end(d
-000099d0: 756d 7064 286f 7574 2929 0a20 2020 2020  umpd(out)).     
-000099e0: 2020 2020 2020 2069 6620 7265 7475 726e         if return
-000099f0: 5f65 7863 6570 7469 6f6e 7320 6f72 2066  _exceptions or f
-00009a00: 6972 7374 5f65 7863 6570 7469 6f6e 2069  irst_exception i
-00009a10: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00009a20: 2020 2020 2020 2020 7265 7475 726e 2063          return c
-00009a30: 6173 7428 4c69 7374 5b4f 7574 7075 745d  ast(List[Output]
-00009a40: 2c20 6f75 7470 7574 290a 2020 2020 2020  , output).      
-00009a50: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00009a60: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00009a70: 6520 6669 7273 745f 6578 6365 7074 696f  e first_exceptio
-00009a80: 6e0a 0a20 2020 2061 7379 6e63 2064 6566  n..    async def
-00009a90: 205f 6162 6174 6368 5f77 6974 685f 636f   _abatch_with_co
-00009aa0: 6e66 6967 280a 2020 2020 2020 2020 7365  nfig(.        se
-00009ab0: 6c66 2c0a 2020 2020 2020 2020 6675 6e63  lf,.        func
-00009ac0: 3a20 556e 696f 6e5b 0a20 2020 2020 2020  : Union[.       
-00009ad0: 2020 2020 2043 616c 6c61 626c 655b 5b4c       Callable[[L
-00009ae0: 6973 745b 496e 7075 745d 5d2c 2041 7761  ist[Input]], Awa
-00009af0: 6974 6162 6c65 5b4c 6973 745b 556e 696f  itable[List[Unio
-00009b00: 6e5b 4578 6365 7074 696f 6e2c 204f 7574  n[Exception, Out
-00009b10: 7075 745d 5d5d 5d2c 0a20 2020 2020 2020  put]]]],.       
-00009b20: 2020 2020 2043 616c 6c61 626c 655b 0a20       Callable[. 
-00009b30: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-00009b40: 4c69 7374 5b49 6e70 7574 5d2c 204c 6973  List[Input], Lis
-00009b50: 745b 4173 796e 6343 616c 6c62 6163 6b4d  t[AsyncCallbackM
-00009b60: 616e 6167 6572 466f 7243 6861 696e 5275  anagerForChainRu
-00009b70: 6e5d 5d2c 0a20 2020 2020 2020 2020 2020  n]],.           
-00009b80: 2020 2020 2041 7761 6974 6162 6c65 5b4c       Awaitable[L
-00009b90: 6973 745b 556e 696f 6e5b 4578 6365 7074  ist[Union[Except
-00009ba0: 696f 6e2c 204f 7574 7075 745d 5d5d 2c0a  ion, Output]]],.
-00009bb0: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
-00009bc0: 2020 2020 2020 2020 2020 2043 616c 6c61             Calla
-00009bd0: 626c 655b 0a20 2020 2020 2020 2020 2020  ble[.           
-00009be0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00009bf0: 2020 2020 2020 2020 2020 204c 6973 745b             List[
-00009c00: 496e 7075 745d 2c0a 2020 2020 2020 2020  Input],.        
-00009c10: 2020 2020 2020 2020 2020 2020 4c69 7374              List
-00009c20: 5b41 7379 6e63 4361 6c6c 6261 636b 4d61  [AsyncCallbackMa
-00009c30: 6e61 6765 7246 6f72 4368 6169 6e52 756e  nagerForChainRun
-00009c40: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00009c50: 2020 2020 2020 204c 6973 745b 5275 6e6e         List[Runn
-00009c60: 6162 6c65 436f 6e66 6967 5d2c 0a20 2020  ableConfig],.   
-00009c70: 2020 2020 2020 2020 2020 2020 205d 2c0a               ],.
-00009c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c90: 4177 6169 7461 626c 655b 4c69 7374 5b55  Awaitable[List[U
-00009ca0: 6e69 6f6e 5b45 7863 6570 7469 6f6e 2c20  nion[Exception, 
-00009cb0: 4f75 7470 7574 5d5d 5d2c 0a20 2020 2020  Output]]],.     
-00009cc0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00009cd0: 2020 5d2c 0a20 2020 2020 2020 2069 6e70    ],.        inp
-00009ce0: 7574 3a20 4c69 7374 5b49 6e70 7574 5d2c  ut: List[Input],
-00009cf0: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
-00009d00: 204f 7074 696f 6e61 6c5b 556e 696f 6e5b   Optional[Union[
-00009d10: 5275 6e6e 6162 6c65 436f 6e66 6967 2c20  RunnableConfig, 
-00009d20: 4c69 7374 5b52 756e 6e61 626c 6543 6f6e  List[RunnableCon
-00009d30: 6669 675d 5d5d 203d 204e 6f6e 652c 0a20  fig]]] = None,. 
-00009d40: 2020 2020 2020 202a 2c0a 2020 2020 2020         *,.      
-00009d50: 2020 7265 7475 726e 5f65 7863 6570 7469    return_excepti
-00009d60: 6f6e 733a 2062 6f6f 6c20 3d20 4661 6c73  ons: bool = Fals
-00009d70: 652c 0a20 2020 2020 2020 2072 756e 5f74  e,.        run_t
-00009d80: 7970 653a 204f 7074 696f 6e61 6c5b 7374  ype: Optional[st
-00009d90: 725d 203d 204e 6f6e 652c 0a20 2020 2020  r] = None,.     
-00009da0: 2020 202a 2a6b 7761 7267 733a 204f 7074     **kwargs: Opt
-00009db0: 696f 6e61 6c5b 416e 795d 2c0a 2020 2020  ional[Any],.    
-00009dc0: 2920 2d3e 204c 6973 745b 4f75 7470 7574  ) -> List[Output
-00009dd0: 5d3a 0a20 2020 2020 2020 2022 2222 4865  ]:.        """He
-00009de0: 6c70 6572 206d 6574 686f 6420 746f 2074  lper method to t
-00009df0: 7261 6e73 666f 726d 2061 6e20 496e 7075  ransform an Inpu
-00009e00: 7420 7661 6c75 6520 746f 2061 6e20 4f75  t value to an Ou
-00009e10: 7470 7574 2076 616c 7565 2c0a 2020 2020  tput value,.    
-00009e20: 2020 2020 7769 7468 2063 616c 6c62 6163      with callbac
-00009e30: 6b73 2e20 5573 6520 7468 6973 206d 6574  ks. Use this met
-00009e40: 686f 6420 746f 2069 6d70 6c65 6d65 6e74  hod to implement
-00009e50: 2069 6e76 6f6b 6528 2920 696e 2073 7562   invoke() in sub
-00009e60: 636c 6173 7365 732e 2222 220a 2020 2020  classes.""".    
-00009e70: 2020 2020 6966 206e 6f74 2069 6e70 7574      if not input
-00009e80: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00009e90: 7475 726e 205b 5d0a 0a20 2020 2020 2020  turn []..       
-00009ea0: 2063 6f6e 6669 6773 203d 2067 6574 5f63   configs = get_c
-00009eb0: 6f6e 6669 675f 6c69 7374 2863 6f6e 6669  onfig_list(confi
-00009ec0: 672c 206c 656e 2869 6e70 7574 2929 0a20  g, len(input)). 
-00009ed0: 2020 2020 2020 2063 616c 6c62 6163 6b5f         callback_
-00009ee0: 6d61 6e61 6765 7273 203d 205b 6765 745f  managers = [get_
-00009ef0: 6173 796e 635f 6361 6c6c 6261 636b 5f6d  async_callback_m
-00009f00: 616e 6167 6572 5f66 6f72 5f63 6f6e 6669  anager_for_confi
-00009f10: 6728 6329 2066 6f72 2063 2069 6e20 636f  g(c) for c in co
-00009f20: 6e66 6967 735d 0a20 2020 2020 2020 2072  nfigs].        r
-00009f30: 756e 5f6d 616e 6167 6572 733a 204c 6973  un_managers: Lis
-00009f40: 745b 4173 796e 6343 616c 6c62 6163 6b4d  t[AsyncCallbackM
-00009f50: 616e 6167 6572 466f 7243 6861 696e 5275  anagerForChainRu
-00009f60: 6e5d 203d 2061 7761 6974 2061 7379 6e63  n] = await async
-00009f70: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
-00009f80: 2020 2020 2020 202a 280a 2020 2020 2020         *(.      
-00009f90: 2020 2020 2020 2020 2020 6361 6c6c 6261            callba
-00009fa0: 636b 5f6d 616e 6167 6572 2e6f 6e5f 6368  ck_manager.on_ch
-00009fb0: 6169 6e5f 7374 6172 7428 0a20 2020 2020  ain_start(.     
-00009fc0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00009fd0: 756d 7064 2873 656c 6629 2c0a 2020 2020  umpd(self),.    
-00009fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ff0: 696e 7075 742c 0a20 2020 2020 2020 2020  input,.         
-0000a000: 2020 2020 2020 2020 2020 2072 756e 5f74             run_t
-0000a010: 7970 653d 7275 6e5f 7479 7065 2c0a 2020  ype=run_type,.  
-0000a020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a030: 2020 6e61 6d65 3d63 6f6e 6669 672e 6765    name=config.ge
-0000a040: 7428 2272 756e 5f6e 616d 6522 2920 6f72  t("run_name") or
-0000a050: 2073 656c 662e 6765 745f 6e61 6d65 2829   self.get_name()
-0000a060: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000a070: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0000a080: 2020 2020 666f 7220 6361 6c6c 6261 636b      for callback
-0000a090: 5f6d 616e 6167 6572 2c20 696e 7075 742c  _manager, input,
-0000a0a0: 2063 6f6e 6669 6720 696e 207a 6970 280a   config in zip(.
-0000a0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a0c0: 2020 2020 6361 6c6c 6261 636b 5f6d 616e      callback_man
-0000a0d0: 6167 6572 732c 2069 6e70 7574 2c20 636f  agers, input, co
-0000a0e0: 6e66 6967 730a 2020 2020 2020 2020 2020  nfigs.          
-0000a0f0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000a100: 2020 2020 290a 2020 2020 2020 2020 290a      ).        ).
-0000a110: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0000a120: 2020 2020 2020 2020 2069 6620 6163 6365           if acce
-0000a130: 7074 735f 636f 6e66 6967 2866 756e 6329  pts_config(func)
-0000a140: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000a150: 2020 6b77 6172 6773 5b22 636f 6e66 6967    kwargs["config
-0000a160: 225d 203d 205b 0a20 2020 2020 2020 2020  "] = [.         
-0000a170: 2020 2020 2020 2020 2020 2070 6174 6368             patch
-0000a180: 5f63 6f6e 6669 6728 632c 2063 616c 6c62  _config(c, callb
-0000a190: 6163 6b73 3d72 6d2e 6765 745f 6368 696c  acks=rm.get_chil
-0000a1a0: 6428 2929 0a20 2020 2020 2020 2020 2020  d()).           
-0000a1b0: 2020 2020 2020 2020 2066 6f72 2063 2c20           for c, 
-0000a1c0: 726d 2069 6e20 7a69 7028 636f 6e66 6967  rm in zip(config
-0000a1d0: 732c 2072 756e 5f6d 616e 6167 6572 7329  s, run_managers)
-0000a1e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a1f0: 205d 0a20 2020 2020 2020 2020 2020 2069   ].            i
-0000a200: 6620 6163 6365 7074 735f 7275 6e5f 6d61  f accepts_run_ma
-0000a210: 6e61 6765 7228 6675 6e63 293a 0a20 2020  nager(func):.   
-0000a220: 2020 2020 2020 2020 2020 2020 206b 7761               kwa
-0000a230: 7267 735b 2272 756e 5f6d 616e 6167 6572  rgs["run_manager
-0000a240: 225d 203d 2072 756e 5f6d 616e 6167 6572  "] = run_manager
-0000a250: 730a 2020 2020 2020 2020 2020 2020 6f75  s.            ou
-0000a260: 7470 7574 203d 2061 7761 6974 2066 756e  tput = await fun
-0000a270: 6328 696e 7075 742c 202a 2a6b 7761 7267  c(input, **kwarg
-0000a280: 7329 2020 2320 7479 7065 3a20 6967 6e6f  s)  # type: igno
-0000a290: 7265 5b63 616c 6c2d 6172 675d 0a20 2020  re[call-arg].   
-0000a2a0: 2020 2020 2065 7863 6570 7420 4261 7365       except Base
-0000a2b0: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
-0000a2c0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-0000a2d0: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
-0000a2e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000a2f0: 2020 2a28 7275 6e5f 6d61 6e61 6765 722e    *(run_manager.
-0000a300: 6f6e 5f63 6861 696e 5f65 7272 6f72 2865  on_chain_error(e
-0000a310: 2920 666f 7220 7275 6e5f 6d61 6e61 6765  ) for run_manage
-0000a320: 7220 696e 2072 756e 5f6d 616e 6167 6572  r in run_manager
-0000a330: 7329 0a20 2020 2020 2020 2020 2020 2029  s).            )
-0000a340: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000a350: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
-0000a360: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0000a370: 2020 2072 6574 7572 6e20 6361 7374 284c     return cast(L
-0000a380: 6973 745b 4f75 7470 7574 5d2c 205b 6520  ist[Output], [e 
-0000a390: 666f 7220 5f20 696e 2069 6e70 7574 5d29  for _ in input])
-0000a3a0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0000a3b0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000a3c0: 2020 2072 6169 7365 0a20 2020 2020 2020     raise.       
-0000a3d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000a3e0: 2020 2066 6972 7374 5f65 7863 6570 7469     first_excepti
-0000a3f0: 6f6e 3a20 4f70 7469 6f6e 616c 5b45 7863  on: Optional[Exc
-0000a400: 6570 7469 6f6e 5d20 3d20 4e6f 6e65 0a20  eption] = None. 
-0000a410: 2020 2020 2020 2020 2020 2063 6f72 6f73             coros
-0000a420: 3a20 4c69 7374 5b41 7761 6974 6162 6c65  : List[Awaitable
-0000a430: 5b4e 6f6e 655d 5d20 3d20 5b5d 0a20 2020  [None]] = [].   
-0000a440: 2020 2020 2020 2020 2066 6f72 2072 756e           for run
-0000a450: 5f6d 616e 6167 6572 2c20 6f75 7420 696e  _manager, out in
-0000a460: 207a 6970 2872 756e 5f6d 616e 6167 6572   zip(run_manager
-0000a470: 732c 206f 7574 7075 7429 3a0a 2020 2020  s, output):.    
-0000a480: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-0000a490: 7369 6e73 7461 6e63 6528 6f75 742c 2045  sinstance(out, E
-0000a4a0: 7863 6570 7469 6f6e 293a 0a20 2020 2020  xception):.     
-0000a4b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000a4c0: 6972 7374 5f65 7863 6570 7469 6f6e 203d  irst_exception =
-0000a4d0: 2066 6972 7374 5f65 7863 6570 7469 6f6e   first_exception
-0000a4e0: 206f 7220 6f75 740a 2020 2020 2020 2020   or out.        
-0000a4f0: 2020 2020 2020 2020 2020 2020 636f 726f              coro
-0000a500: 732e 6170 7065 6e64 2872 756e 5f6d 616e  s.append(run_man
-0000a510: 6167 6572 2e6f 6e5f 6368 6169 6e5f 6572  ager.on_chain_er
-0000a520: 726f 7228 6f75 7429 290a 2020 2020 2020  ror(out)).      
-0000a530: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0000a540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a550: 2020 2020 636f 726f 732e 6170 7065 6e64      coros.append
-0000a560: 2872 756e 5f6d 616e 6167 6572 2e6f 6e5f  (run_manager.on_
-0000a570: 6368 6169 6e5f 656e 6428 6475 6d70 6428  chain_end(dumpd(
-0000a580: 6f75 7429 2929 0a20 2020 2020 2020 2020  out))).         
-0000a590: 2020 2061 7761 6974 2061 7379 6e63 696f     await asyncio
-0000a5a0: 2e67 6174 6865 7228 2a63 6f72 6f73 290a  .gather(*coros).
-0000a5b0: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-0000a5c0: 6574 7572 6e5f 6578 6365 7074 696f 6e73  eturn_exceptions
-0000a5d0: 206f 7220 6669 7273 745f 6578 6365 7074   or first_except
-0000a5e0: 696f 6e20 6973 204e 6f6e 653a 0a20 2020  ion is None:.   
-0000a5f0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0000a600: 7572 6e20 6361 7374 284c 6973 745b 4f75  urn cast(List[Ou
-0000a610: 7470 7574 5d2c 206f 7574 7075 7429 0a20  tput], output). 
-0000a620: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000a630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a640: 2072 6169 7365 2066 6972 7374 5f65 7863   raise first_exc
-0000a650: 6570 7469 6f6e 0a0a 2020 2020 6465 6620  eption..    def 
-0000a660: 5f74 7261 6e73 666f 726d 5f73 7472 6561  _transform_strea
-0000a670: 6d5f 7769 7468 5f63 6f6e 6669 6728 0a20  m_with_config(. 
-0000a680: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-0000a690: 2020 2020 2069 6e70 7574 3a20 4974 6572       input: Iter
-0000a6a0: 6174 6f72 5b49 6e70 7574 5d2c 0a20 2020  ator[Input],.   
-0000a6b0: 2020 2020 2074 7261 6e73 666f 726d 6572       transformer
-0000a6c0: 3a20 556e 696f 6e5b 0a20 2020 2020 2020  : Union[.       
-0000a6d0: 2020 2020 2043 616c 6c61 626c 655b 5b49       Callable[[I
-0000a6e0: 7465 7261 746f 725b 496e 7075 745d 5d2c  terator[Input]],
-0000a6f0: 2049 7465 7261 746f 725b 4f75 7470 7574   Iterator[Output
-0000a700: 5d5d 2c0a 2020 2020 2020 2020 2020 2020  ]],.            
-0000a710: 4361 6c6c 6162 6c65 5b5b 4974 6572 6174  Callable[[Iterat
-0000a720: 6f72 5b49 6e70 7574 5d2c 2043 616c 6c62  or[Input], Callb
-0000a730: 6163 6b4d 616e 6167 6572 466f 7243 6861  ackManagerForCha
-0000a740: 696e 5275 6e5d 2c20 4974 6572 6174 6f72  inRun], Iterator
-0000a750: 5b4f 7574 7075 745d 5d2c 0a20 2020 2020  [Output]],.     
-0000a760: 2020 2020 2020 2043 616c 6c61 626c 655b         Callable[
-0000a770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a780: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-0000a790: 2020 2020 2020 2049 7465 7261 746f 725b         Iterator[
-0000a7a0: 496e 7075 745d 2c0a 2020 2020 2020 2020  Input],.        
-0000a7b0: 2020 2020 2020 2020 2020 2020 4361 6c6c              Call
-0000a7c0: 6261 636b 4d61 6e61 6765 7246 6f72 4368  backManagerForCh
-0000a7d0: 6169 6e52 756e 2c0a 2020 2020 2020 2020  ainRun,.        
-0000a7e0: 2020 2020 2020 2020 2020 2020 5275 6e6e              Runn
-0000a7f0: 6162 6c65 436f 6e66 6967 2c0a 2020 2020  ableConfig,.    
-0000a800: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
-0000a810: 2020 2020 2020 2020 2020 2020 2020 2049                 I
-0000a820: 7465 7261 746f 725b 4f75 7470 7574 5d2c  terator[Output],
-0000a830: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
-0000a840: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-0000a850: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
-0000a860: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-0000a870: 6967 5d2c 0a20 2020 2020 2020 2072 756e  ig],.        run
-0000a880: 5f74 7970 653a 204f 7074 696f 6e61 6c5b  _type: Optional[
-0000a890: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
-0000a8a0: 2020 2020 202a 2a6b 7761 7267 733a 204f       **kwargs: O
-0000a8b0: 7074 696f 6e61 6c5b 416e 795d 2c0a 2020  ptional[Any],.  
-0000a8c0: 2020 2920 2d3e 2049 7465 7261 746f 725b    ) -> Iterator[
-0000a8d0: 4f75 7470 7574 5d3a 0a20 2020 2020 2020  Output]:.       
-0000a8e0: 2022 2222 4865 6c70 6572 206d 6574 686f   """Helper metho
-0000a8f0: 6420 746f 2074 7261 6e73 666f 726d 2061  d to transform a
-0000a900: 6e20 4974 6572 6174 6f72 206f 6620 496e  n Iterator of In
-0000a910: 7075 7420 7661 6c75 6573 2069 6e74 6f20  put values into 
-0000a920: 616e 2049 7465 7261 746f 7220 6f66 0a20  an Iterator of. 
-0000a930: 2020 2020 2020 204f 7574 7075 7420 7661         Output va
-0000a940: 6c75 6573 2c20 7769 7468 2063 616c 6c62  lues, with callb
-0000a950: 6163 6b73 2e0a 2020 2020 2020 2020 5573  acks..        Us
-0000a960: 6520 7468 6973 2074 6f20 696d 706c 656d  e this to implem
-0000a970: 656e 7420 6073 7472 6561 6d28 2960 206f  ent `stream()` o
-0000a980: 7220 6074 7261 6e73 666f 726d 2829 6020  r `transform()` 
-0000a990: 696e 2052 756e 6e61 626c 6520 7375 6263  in Runnable subc
-0000a9a0: 6c61 7373 6573 2e22 2222 0a20 2020 2020  lasses.""".     
-0000a9b0: 2020 2023 2074 6565 2074 6865 2069 6e70     # tee the inp
-0000a9c0: 7574 2073 6f20 7765 2063 616e 2069 7465  ut so we can ite
-0000a9d0: 7261 7465 206f 7665 7220 6974 2074 7769  rate over it twi
-0000a9e0: 6365 0a20 2020 2020 2020 2069 6e70 7574  ce.        input
-0000a9f0: 5f66 6f72 5f74 7261 6369 6e67 2c20 696e  _for_tracing, in
-0000aa00: 7075 745f 666f 725f 7472 616e 7366 6f72  put_for_transfor
-0000aa10: 6d20 3d20 7465 6528 696e 7075 742c 2032  m = tee(input, 2
-0000aa20: 290a 2020 2020 2020 2020 2320 5374 6172  ).        # Star
-0000aa30: 7420 7468 6520 696e 7075 7420 6974 6572  t the input iter
-0000aa40: 6174 6f72 2074 6f20 656e 7375 7265 2074  ator to ensure t
-0000aa50: 6865 2069 6e70 7574 2072 756e 6e61 626c  he input runnabl
-0000aa60: 6520 7374 6172 7473 2062 6566 6f72 6520  e starts before 
-0000aa70: 7468 6973 206f 6e65 0a20 2020 2020 2020  this one.       
-0000aa80: 2066 696e 616c 5f69 6e70 7574 3a20 4f70   final_input: Op
-0000aa90: 7469 6f6e 616c 5b49 6e70 7574 5d20 3d20  tional[Input] = 
-0000aaa0: 6e65 7874 2869 6e70 7574 5f66 6f72 5f74  next(input_for_t
-0000aab0: 7261 6369 6e67 2c20 4e6f 6e65 290a 2020  racing, None).  
-0000aac0: 2020 2020 2020 6669 6e61 6c5f 696e 7075        final_inpu
-0000aad0: 745f 7375 7070 6f72 7465 6420 3d20 5472  t_supported = Tr
-0000aae0: 7565 0a20 2020 2020 2020 2066 696e 616c  ue.        final
-0000aaf0: 5f6f 7574 7075 743a 204f 7074 696f 6e61  _output: Optiona
-0000ab00: 6c5b 4f75 7470 7574 5d20 3d20 4e6f 6e65  l[Output] = None
-0000ab10: 0a20 2020 2020 2020 2066 696e 616c 5f6f  .        final_o
-0000ab20: 7574 7075 745f 7375 7070 6f72 7465 6420  utput_supported 
-0000ab30: 3d20 5472 7565 0a0a 2020 2020 2020 2020  = True..        
-0000ab40: 636f 6e66 6967 203d 2065 6e73 7572 655f  config = ensure_
-0000ab50: 636f 6e66 6967 2863 6f6e 6669 6729 0a20  config(config). 
-0000ab60: 2020 2020 2020 2063 616c 6c62 6163 6b5f         callback_
-0000ab70: 6d61 6e61 6765 7220 3d20 6765 745f 6361  manager = get_ca
-0000ab80: 6c6c 6261 636b 5f6d 616e 6167 6572 5f66  llback_manager_f
-0000ab90: 6f72 5f63 6f6e 6669 6728 636f 6e66 6967  or_config(config
-0000aba0: 290a 2020 2020 2020 2020 7275 6e5f 6d61  ).        run_ma
-0000abb0: 6e61 6765 7220 3d20 6361 6c6c 6261 636b  nager = callback
-0000abc0: 5f6d 616e 6167 6572 2e6f 6e5f 6368 6169  _manager.on_chai
-0000abd0: 6e5f 7374 6172 7428 0a20 2020 2020 2020  n_start(.       
-0000abe0: 2020 2020 2064 756d 7064 2873 656c 6629       dumpd(self)
-0000abf0: 2c0a 2020 2020 2020 2020 2020 2020 7b22  ,.            {"
-0000ac00: 696e 7075 7422 3a20 2222 7d2c 0a20 2020  input": ""},.   
-0000ac10: 2020 2020 2020 2020 2072 756e 5f74 7970           run_typ
-0000ac20: 653d 7275 6e5f 7479 7065 2c0a 2020 2020  e=run_type,.    
-0000ac30: 2020 2020 2020 2020 6e61 6d65 3d63 6f6e          name=con
-0000ac40: 6669 672e 6765 7428 2272 756e 5f6e 616d  fig.get("run_nam
-0000ac50: 6522 2920 6f72 2073 656c 662e 6765 745f  e") or self.get_
-0000ac60: 6e61 6d65 2829 2c0a 2020 2020 2020 2020  name(),.        
-0000ac70: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
-0000ac80: 2020 2020 2020 2020 2020 2063 6869 6c64             child
-0000ac90: 5f63 6f6e 6669 6720 3d20 7061 7463 685f  _config = patch_
-0000aca0: 636f 6e66 6967 2863 6f6e 6669 672c 2063  config(config, c
-0000acb0: 616c 6c62 6163 6b73 3d72 756e 5f6d 616e  allbacks=run_man
-0000acc0: 6167 6572 2e67 6574 5f63 6869 6c64 2829  ager.get_child()
-0000acd0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0000ace0: 2061 6363 6570 7473 5f63 6f6e 6669 6728   accepts_config(
-0000acf0: 7472 616e 7366 6f72 6d65 7229 3a0a 2020  transformer):.  
-0000ad00: 2020 2020 2020 2020 2020 2020 2020 6b77                kw
-0000ad10: 6172 6773 5b22 636f 6e66 6967 225d 203d  args["config"] =
-0000ad20: 2063 6869 6c64 5f63 6f6e 6669 670a 2020   child_config.  
-0000ad30: 2020 2020 2020 2020 2020 6966 2061 6363            if acc
-0000ad40: 6570 7473 5f72 756e 5f6d 616e 6167 6572  epts_run_manager
-0000ad50: 2874 7261 6e73 666f 726d 6572 293a 0a20  (transformer):. 
-0000ad60: 2020 2020 2020 2020 2020 2020 2020 206b                 k
-0000ad70: 7761 7267 735b 2272 756e 5f6d 616e 6167  wargs["run_manag
-0000ad80: 6572 225d 203d 2072 756e 5f6d 616e 6167  er"] = run_manag
-0000ad90: 6572 0a20 2020 2020 2020 2020 2020 2063  er.            c
-0000ada0: 6f6e 7465 7874 203d 2063 6f70 795f 636f  ontext = copy_co
-0000adb0: 6e74 6578 7428 290a 2020 2020 2020 2020  ntext().        
-0000adc0: 2020 2020 636f 6e74 6578 742e 7275 6e28      context.run(
-0000add0: 7661 725f 6368 696c 645f 7275 6e6e 6162  var_child_runnab
-0000ade0: 6c65 5f63 6f6e 6669 672e 7365 742c 2063  le_config.set, c
-0000adf0: 6869 6c64 5f63 6f6e 6669 6729 0a20 2020  hild_config).   
-0000ae00: 2020 2020 2020 2020 2069 7465 7261 746f           iterato
-0000ae10: 7220 3d20 636f 6e74 6578 742e 7275 6e28  r = context.run(
-0000ae20: 7472 616e 7366 6f72 6d65 722c 2069 6e70  transformer, inp
-0000ae30: 7574 5f66 6f72 5f74 7261 6e73 666f 726d  ut_for_transform
-0000ae40: 2c20 2a2a 6b77 6172 6773 2920 2023 2074  , **kwargs)  # t
-0000ae50: 7970 653a 2069 676e 6f72 655b 6172 672d  ype: ignore[arg-
-0000ae60: 7479 7065 5d0a 2020 2020 2020 2020 2020  type].          
-0000ae70: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0000ae80: 2020 2020 2020 2077 6869 6c65 2054 7275         while Tru
-0000ae90: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000aea0: 2020 2020 2020 2063 6875 6e6b 3a20 4f75         chunk: Ou
-0000aeb0: 7470 7574 203d 2063 6f6e 7465 7874 2e72  tput = context.r
-0000aec0: 756e 286e 6578 742c 2069 7465 7261 746f  un(next, iterato
-0000aed0: 7229 2020 2320 7479 7065 3a20 6967 6e6f  r)  # type: igno
-0000aee0: 7265 0a20 2020 2020 2020 2020 2020 2020  re.             
-0000aef0: 2020 2020 2020 2079 6965 6c64 2063 6875         yield chu
-0000af00: 6e6b 0a20 2020 2020 2020 2020 2020 2020  nk.             
-0000af10: 2020 2020 2020 2069 6620 6669 6e61 6c5f         if final_
-0000af20: 6f75 7470 7574 5f73 7570 706f 7274 6564  output_supported
-0000af30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000af40: 2020 2020 2020 2020 2020 6966 2066 696e            if fin
-0000af50: 616c 5f6f 7574 7075 7420 6973 204e 6f6e  al_output is Non
-0000af60: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000af70: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000af80: 696e 616c 5f6f 7574 7075 7420 3d20 6368  inal_output = ch
-0000af90: 756e 6b0a 2020 2020 2020 2020 2020 2020  unk.            
-0000afa0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0000afb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000afc0: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-0000afd0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0000afe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aff0: 2020 2066 696e 616c 5f6f 7574 7075 7420     final_output 
-0000b000: 3d20 6669 6e61 6c5f 6f75 7470 7574 202b  = final_output +
-0000b010: 2063 6875 6e6b 2020 2320 7479 7065 3a20   chunk  # type: 
-0000b020: 6967 6e6f 7265 0a20 2020 2020 2020 2020  ignore.         
-0000b030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b040: 2020 2065 7863 6570 7420 5479 7065 4572     except TypeEr
-0000b050: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-0000b060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b070: 2020 2020 2066 696e 616c 5f6f 7574 7075       final_outpu
-0000b080: 7420 3d20 4e6f 6e65 0a20 2020 2020 2020  t = None.       
-0000b090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b0a0: 2020 2020 2020 2020 2066 696e 616c 5f6f           final_o
-0000b0b0: 7574 7075 745f 7375 7070 6f72 7465 6420  utput_supported 
-0000b0c0: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-0000b0d0: 2020 2020 6578 6365 7074 2053 746f 7049      except StopI
-0000b0e0: 7465 7261 7469 6f6e 3a0a 2020 2020 2020  teration:.      
-0000b0f0: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
-0000b100: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-0000b110: 6368 756e 6b20 696e 2069 6e70 7574 5f66  chunk in input_f
-0000b120: 6f72 5f74 7261 6369 6e67 3a0a 2020 2020  or_tracing:.    
-0000b130: 2020 2020 2020 2020 2020 2020 6966 2066              if f
-0000b140: 696e 616c 5f69 6e70 7574 5f73 7570 706f  inal_input_suppo
-0000b150: 7274 6564 3a0a 2020 2020 2020 2020 2020  rted:.          
-0000b160: 2020 2020 2020 2020 2020 6966 2066 696e            if fin
-0000b170: 616c 5f69 6e70 7574 2069 7320 4e6f 6e65  al_input is None
-0000b180: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000b190: 2020 2020 2020 2020 2020 6669 6e61 6c5f            final_
-0000b1a0: 696e 7075 7420 3d20 6963 6875 6e6b 0a20  input = ichunk. 
-0000b1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b1c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000b1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b1e0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0000b1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b200: 2020 6669 6e61 6c5f 696e 7075 7420 3d20    final_input = 
-0000b210: 6669 6e61 6c5f 696e 7075 7420 2b20 6963  final_input + ic
-0000b220: 6875 6e6b 2020 2320 7479 7065 3a20 6967  hunk  # type: ig
-0000b230: 6e6f 7265 0a20 2020 2020 2020 2020 2020  nore.           
-0000b240: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-0000b250: 6570 7420 5479 7065 4572 726f 723a 0a20  ept TypeError:. 
-0000b260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b270: 2020 2020 2020 2020 2020 2066 696e 616c             final
-0000b280: 5f69 6e70 7574 203d 204e 6f6e 650a 2020  _input = None.  
-0000b290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b2a0: 2020 2020 2020 2020 2020 6669 6e61 6c5f            final_
-0000b2b0: 696e 7075 745f 7375 7070 6f72 7465 6420  input_supported 
-0000b2c0: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-0000b2d0: 6578 6365 7074 2042 6173 6545 7863 6570  except BaseExcep
-0000b2e0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-0000b2f0: 2020 2020 2020 2072 756e 5f6d 616e 6167         run_manag
-0000b300: 6572 2e6f 6e5f 6368 6169 6e5f 6572 726f  er.on_chain_erro
-0000b310: 7228 652c 2069 6e70 7574 733d 6669 6e61  r(e, inputs=fina
-0000b320: 6c5f 696e 7075 7429 0a20 2020 2020 2020  l_input).       
-0000b330: 2020 2020 2072 6169 7365 0a20 2020 2020       raise.     
-0000b340: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000b350: 2020 2020 2072 756e 5f6d 616e 6167 6572       run_manager
-0000b360: 2e6f 6e5f 6368 6169 6e5f 656e 6428 6669  .on_chain_end(fi
-0000b370: 6e61 6c5f 6f75 7470 7574 2c20 696e 7075  nal_output, inpu
-0000b380: 7473 3d66 696e 616c 5f69 6e70 7574 290a  ts=final_input).
-0000b390: 0a20 2020 2061 7379 6e63 2064 6566 205f  .    async def _
-0000b3a0: 6174 7261 6e73 666f 726d 5f73 7472 6561  atransform_strea
-0000b3b0: 6d5f 7769 7468 5f63 6f6e 6669 6728 0a20  m_with_config(. 
-0000b3c0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-0000b3d0: 2020 2020 2069 6e70 7574 3a20 4173 796e       input: Asyn
-0000b3e0: 6349 7465 7261 746f 725b 496e 7075 745d  cIterator[Input]
-0000b3f0: 2c0a 2020 2020 2020 2020 7472 616e 7366  ,.        transf
-0000b400: 6f72 6d65 723a 2055 6e69 6f6e 5b0a 2020  ormer: Union[.  
-0000b410: 2020 2020 2020 2020 2020 4361 6c6c 6162            Callab
-0000b420: 6c65 5b5b 4173 796e 6349 7465 7261 746f  le[[AsyncIterato
-0000b430: 725b 496e 7075 745d 5d2c 2041 7379 6e63  r[Input]], Async
-0000b440: 4974 6572 6174 6f72 5b4f 7574 7075 745d  Iterator[Output]
-0000b450: 5d2c 0a20 2020 2020 2020 2020 2020 2043  ],.            C
-0000b460: 616c 6c61 626c 655b 0a20 2020 2020 2020  allable[.       
-0000b470: 2020 2020 2020 2020 205b 4173 796e 6349           [AsyncI
-0000b480: 7465 7261 746f 725b 496e 7075 745d 2c20  terator[Input], 
-0000b490: 4173 796e 6343 616c 6c62 6163 6b4d 616e  AsyncCallbackMan
-0000b4a0: 6167 6572 466f 7243 6861 696e 5275 6e5d  agerForChainRun]
-0000b4b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000b4c0: 2020 4173 796e 6349 7465 7261 746f 725b    AsyncIterator[
-0000b4d0: 4f75 7470 7574 5d2c 0a20 2020 2020 2020  Output],.       
-0000b4e0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0000b4f0: 2020 2020 4361 6c6c 6162 6c65 5b0a 2020      Callable[.  
-0000b500: 2020 2020 2020 2020 2020 2020 2020 5b0a                [.
-0000b510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b520: 2020 2020 4173 796e 6349 7465 7261 746f      AsyncIterato
-0000b530: 725b 496e 7075 745d 2c0a 2020 2020 2020  r[Input],.      
-0000b540: 2020 2020 2020 2020 2020 2020 2020 4173                As
-0000b550: 796e 6343 616c 6c62 6163 6b4d 616e 6167  yncCallbackManag
-0000b560: 6572 466f 7243 6861 696e 5275 6e2c 0a20  erForChainRun,. 
-0000b570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b580: 2020 2052 756e 6e61 626c 6543 6f6e 6669     RunnableConfi
-0000b590: 672c 0a20 2020 2020 2020 2020 2020 2020  g,.             
-0000b5a0: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
-0000b5b0: 2020 2020 2020 4173 796e 6349 7465 7261        AsyncItera
-0000b5c0: 746f 725b 4f75 7470 7574 5d2c 0a20 2020  tor[Output],.   
-0000b5d0: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
-0000b5e0: 2020 2020 5d2c 0a20 2020 2020 2020 2063      ],.        c
-0000b5f0: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
-0000b600: 5275 6e6e 6162 6c65 436f 6e66 6967 5d2c  RunnableConfig],
-0000b610: 0a20 2020 2020 2020 2072 756e 5f74 7970  .        run_typ
-0000b620: 653a 204f 7074 696f 6e61 6c5b 7374 725d  e: Optional[str]
-0000b630: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-0000b640: 202a 2a6b 7761 7267 733a 204f 7074 696f   **kwargs: Optio
-0000b650: 6e61 6c5b 416e 795d 2c0a 2020 2020 2920  nal[Any],.    ) 
-0000b660: 2d3e 2041 7379 6e63 4974 6572 6174 6f72  -> AsyncIterator
-0000b670: 5b4f 7574 7075 745d 3a0a 2020 2020 2020  [Output]:.      
-0000b680: 2020 2222 2248 656c 7065 7220 6d65 7468    """Helper meth
-0000b690: 6f64 2074 6f20 7472 616e 7366 6f72 6d20  od to transform 
-0000b6a0: 616e 2041 7379 6e63 2049 7465 7261 746f  an Async Iterato
-0000b6b0: 7220 6f66 2049 6e70 7574 2076 616c 7565  r of Input value
-0000b6c0: 7320 696e 746f 2061 6e20 4173 796e 630a  s into an Async.
-0000b6d0: 2020 2020 2020 2020 4974 6572 6174 6f72          Iterator
-0000b6e0: 206f 6620 4f75 7470 7574 2076 616c 7565   of Output value
-0000b6f0: 732c 2077 6974 6820 6361 6c6c 6261 636b  s, with callback
-0000b700: 732e 0a20 2020 2020 2020 2055 7365 2074  s..        Use t
-0000b710: 6869 7320 746f 2069 6d70 6c65 6d65 6e74  his to implement
-0000b720: 2060 6173 7472 6561 6d28 2960 206f 7220   `astream()` or 
-0000b730: 6061 7472 616e 7366 6f72 6d28 2960 2069  `atransform()` i
-0000b740: 6e20 5275 6e6e 6162 6c65 2073 7562 636c  n Runnable subcl
-0000b750: 6173 7365 732e 2222 220a 2020 2020 2020  asses.""".      
-0000b760: 2020 6672 6f6d 206c 616e 6763 6861 696e    from langchain
-0000b770: 5f63 6f72 652e 7472 6163 6572 732e 6c6f  _core.tracers.lo
-0000b780: 675f 7374 7265 616d 2069 6d70 6f72 7420  g_stream import 
-0000b790: 4c6f 6753 7472 6561 6d43 616c 6c62 6163  LogStreamCallbac
-0000b7a0: 6b48 616e 646c 6572 0a0a 2020 2020 2020  kHandler..      
-0000b7b0: 2020 2320 7465 6520 7468 6520 696e 7075    # tee the inpu
-0000b7c0: 7420 736f 2077 6520 6361 6e20 6974 6572  t so we can iter
-0000b7d0: 6174 6520 6f76 6572 2069 7420 7477 6963  ate over it twic
-0000b7e0: 650a 2020 2020 2020 2020 696e 7075 745f  e.        input_
-0000b7f0: 666f 725f 7472 6163 696e 672c 2069 6e70  for_tracing, inp
-0000b800: 7574 5f66 6f72 5f74 7261 6e73 666f 726d  ut_for_transform
-0000b810: 203d 2061 7465 6528 696e 7075 742c 2032   = atee(input, 2
-0000b820: 290a 2020 2020 2020 2020 2320 5374 6172  ).        # Star
-0000b830: 7420 7468 6520 696e 7075 7420 6974 6572  t the input iter
-0000b840: 6174 6f72 2074 6f20 656e 7375 7265 2074  ator to ensure t
-0000b850: 6865 2069 6e70 7574 2072 756e 6e61 626c  he input runnabl
-0000b860: 6520 7374 6172 7473 2062 6566 6f72 6520  e starts before 
-0000b870: 7468 6973 206f 6e65 0a20 2020 2020 2020  this one.       
-0000b880: 2066 696e 616c 5f69 6e70 7574 3a20 4f70   final_input: Op
-0000b890: 7469 6f6e 616c 5b49 6e70 7574 5d20 3d20  tional[Input] = 
-0000b8a0: 6177 6169 7420 7079 5f61 6e65 7874 2869  await py_anext(i
-0000b8b0: 6e70 7574 5f66 6f72 5f74 7261 6369 6e67  nput_for_tracing
-0000b8c0: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
-0000b8d0: 6669 6e61 6c5f 696e 7075 745f 7375 7070  final_input_supp
-0000b8e0: 6f72 7465 6420 3d20 5472 7565 0a20 2020  orted = True.   
-0000b8f0: 2020 2020 2066 696e 616c 5f6f 7574 7075       final_outpu
-0000b900: 743a 204f 7074 696f 6e61 6c5b 4f75 7470  t: Optional[Outp
-0000b910: 7574 5d20 3d20 4e6f 6e65 0a20 2020 2020  ut] = None.     
-0000b920: 2020 2066 696e 616c 5f6f 7574 7075 745f     final_output_
-0000b930: 7375 7070 6f72 7465 6420 3d20 5472 7565  supported = True
-0000b940: 0a0a 2020 2020 2020 2020 636f 6e66 6967  ..        config
-0000b950: 203d 2065 6e73 7572 655f 636f 6e66 6967   = ensure_config
-0000b960: 2863 6f6e 6669 6729 0a20 2020 2020 2020  (config).       
-0000b970: 2063 616c 6c62 6163 6b5f 6d61 6e61 6765   callback_manage
-0000b980: 7220 3d20 6765 745f 6173 796e 635f 6361  r = get_async_ca
-0000b990: 6c6c 6261 636b 5f6d 616e 6167 6572 5f66  llback_manager_f
-0000b9a0: 6f72 5f63 6f6e 6669 6728 636f 6e66 6967  or_config(config
-0000b9b0: 290a 2020 2020 2020 2020 7275 6e5f 6d61  ).        run_ma
-0000b9c0: 6e61 6765 7220 3d20 6177 6169 7420 6361  nager = await ca
-0000b9d0: 6c6c 6261 636b 5f6d 616e 6167 6572 2e6f  llback_manager.o
-0000b9e0: 6e5f 6368 6169 6e5f 7374 6172 7428 0a20  n_chain_start(. 
-0000b9f0: 2020 2020 2020 2020 2020 2064 756d 7064             dumpd
-0000ba00: 2873 656c 6629 2c0a 2020 2020 2020 2020  (self),.        
-0000ba10: 2020 2020 7b22 696e 7075 7422 3a20 2222      {"input": ""
-0000ba20: 7d2c 0a20 2020 2020 2020 2020 2020 2072  },.            r
-0000ba30: 756e 5f74 7970 653d 7275 6e5f 7479 7065  un_type=run_type
-0000ba40: 2c0a 2020 2020 2020 2020 2020 2020 6e61  ,.            na
-0000ba50: 6d65 3d63 6f6e 6669 672e 6765 7428 2272  me=config.get("r
-0000ba60: 756e 5f6e 616d 6522 2920 6f72 2073 656c  un_name") or sel
-0000ba70: 662e 6765 745f 6e61 6d65 2829 2c0a 2020  f.get_name(),.  
-0000ba80: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000ba90: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0000baa0: 2063 6869 6c64 5f63 6f6e 6669 6720 3d20   child_config = 
-0000bab0: 7061 7463 685f 636f 6e66 6967 2863 6f6e  patch_config(con
-0000bac0: 6669 672c 2063 616c 6c62 6163 6b73 3d72  fig, callbacks=r
-0000bad0: 756e 5f6d 616e 6167 6572 2e67 6574 5f63  un_manager.get_c
-0000bae0: 6869 6c64 2829 290a 2020 2020 2020 2020  hild()).        
-0000baf0: 2020 2020 6966 2061 6363 6570 7473 5f63      if accepts_c
-0000bb00: 6f6e 6669 6728 7472 616e 7366 6f72 6d65  onfig(transforme
-0000bb10: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-0000bb20: 2020 2020 6b77 6172 6773 5b22 636f 6e66      kwargs["conf
-0000bb30: 6967 225d 203d 2063 6869 6c64 5f63 6f6e  ig"] = child_con
-0000bb40: 6669 670a 2020 2020 2020 2020 2020 2020  fig.            
-0000bb50: 6966 2061 6363 6570 7473 5f72 756e 5f6d  if accepts_run_m
-0000bb60: 616e 6167 6572 2874 7261 6e73 666f 726d  anager(transform
-0000bb70: 6572 293a 0a20 2020 2020 2020 2020 2020  er):.           
-0000bb80: 2020 2020 206b 7761 7267 735b 2272 756e       kwargs["run
-0000bb90: 5f6d 616e 6167 6572 225d 203d 2072 756e  _manager"] = run
-0000bba0: 5f6d 616e 6167 6572 0a20 2020 2020 2020  _manager.       
-0000bbb0: 2020 2020 2063 6f6e 7465 7874 203d 2063       context = c
-0000bbc0: 6f70 795f 636f 6e74 6578 7428 290a 2020  opy_context().  
-0000bbd0: 2020 2020 2020 2020 2020 636f 6e74 6578            contex
-0000bbe0: 742e 7275 6e28 7661 725f 6368 696c 645f  t.run(var_child_
-0000bbf0: 7275 6e6e 6162 6c65 5f63 6f6e 6669 672e  runnable_config.
-0000bc00: 7365 742c 2063 6869 6c64 5f63 6f6e 6669  set, child_confi
-0000bc10: 6729 0a20 2020 2020 2020 2020 2020 2069  g).            i
-0000bc20: 7465 7261 746f 7220 3d20 636f 6e74 6578  terator = contex
-0000bc30: 742e 7275 6e28 7472 616e 7366 6f72 6d65  t.run(transforme
-0000bc40: 722c 2069 6e70 7574 5f66 6f72 5f74 7261  r, input_for_tra
-0000bc50: 6e73 666f 726d 2c20 2a2a 6b77 6172 6773  nsform, **kwargs
-0000bc60: 2920 2023 2074 7970 653a 2069 676e 6f72  )  # type: ignor
-0000bc70: 655b 6172 672d 7479 7065 5d0a 2020 2020  e[arg-type].    
-0000bc80: 2020 2020 2020 2020 6966 2073 7472 6561          if strea
-0000bc90: 6d5f 6c6f 6720 3a3d 206e 6578 7428 0a20  m_log := next(. 
-0000bca0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-0000bcb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bcc0: 2020 2020 2068 0a20 2020 2020 2020 2020       h.         
-0000bcd0: 2020 2020 2020 2020 2020 2066 6f72 2068             for h
-0000bce0: 2069 6e20 7275 6e5f 6d61 6e61 6765 722e   in run_manager.
-0000bcf0: 6861 6e64 6c65 7273 0a20 2020 2020 2020  handlers.       
-0000bd00: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000bd10: 6973 696e 7374 616e 6365 2868 2c20 4c6f  isinstance(h, Lo
-0000bd20: 6753 7472 6561 6d43 616c 6c62 6163 6b48  gStreamCallbackH
-0000bd30: 616e 646c 6572 290a 2020 2020 2020 2020  andler).        
-0000bd40: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
-0000bd50: 2020 2020 2020 2020 2020 204e 6f6e 652c             None,
-0000bd60: 0a20 2020 2020 2020 2020 2020 2029 3a0a  .            ):.
-0000bd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bd80: 2320 706f 7075 6c61 7465 7320 7374 7265  # populates stre
-0000bd90: 616d 6564 5f6f 7574 7075 7420 696e 2061  amed_output in a
-0000bda0: 7374 7265 616d 5f6c 6f67 2829 206f 7574  stream_log() out
-0000bdb0: 7075 7420 6966 206e 6565 6465 640a 2020  put if needed.  
-0000bdc0: 2020 2020 2020 2020 2020 2020 2020 6974                it
-0000bdd0: 6572 6174 6f72 203d 2073 7472 6561 6d5f  erator = stream_
-0000bde0: 6c6f 672e 7461 705f 6f75 7470 7574 5f61  log.tap_output_a
-0000bdf0: 6974 6572 2872 756e 5f6d 616e 6167 6572  iter(run_manager
-0000be00: 2e72 756e 5f69 642c 2069 7465 7261 746f  .run_id, iterato
-0000be10: 7229 0a20 2020 2020 2020 2020 2020 2074  r).            t
-0000be20: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000be30: 2020 2020 7768 696c 6520 5472 7565 3a0a      while True:.
-0000be40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000be50: 2020 2020 6966 2061 6363 6570 7473 5f63      if accepts_c
-0000be60: 6f6e 7465 7874 2861 7379 6e63 696f 2e63  ontext(asyncio.c
-0000be70: 7265 6174 655f 7461 736b 293a 0a20 2020  reate_task):.   
-0000be80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000be90: 2020 2020 2063 6875 6e6b 3a20 4f75 7470       chunk: Outp
-0000bea0: 7574 203d 2061 7761 6974 2061 7379 6e63  ut = await async
-0000beb0: 696f 2e63 7265 6174 655f 7461 736b 2820  io.create_task( 
-0000bec0: 2023 2074 7970 653a 2069 676e 6f72 655b   # type: ignore[
-0000bed0: 6361 6c6c 2d61 7267 5d0a 2020 2020 2020  call-arg].      
-0000bee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bef0: 2020 2020 2020 7079 5f61 6e65 7874 2869        py_anext(i
-0000bf00: 7465 7261 746f 7229 2c20 2023 2074 7970  terator),  # typ
-0000bf10: 653a 2069 676e 6f72 655b 6172 672d 7479  e: ignore[arg-ty
-0000bf20: 7065 5d0a 2020 2020 2020 2020 2020 2020  pe].            
-0000bf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bf40: 636f 6e74 6578 743d 636f 6e74 6578 742c  context=context,
-0000bf50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bf60: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0000bf70: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000bf80: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000bf90: 2020 2020 2020 2020 2020 2020 2063 6875               chu
-0000bfa0: 6e6b 203d 2063 6173 7428 4f75 7470 7574  nk = cast(Output
-0000bfb0: 2c20 6177 6169 7420 7079 5f61 6e65 7874  , await py_anext
-0000bfc0: 2869 7465 7261 746f 7229 290a 2020 2020  (iterator)).    
-0000bfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bfe0: 7969 656c 6420 6368 756e 6b0a 2020 2020  yield chunk.    
-0000bff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c000: 6966 2066 696e 616c 5f6f 7574 7075 745f  if final_output_
-0000c010: 7375 7070 6f72 7465 643a 0a20 2020 2020  supported:.     
-0000c020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c030: 2020 2069 6620 6669 6e61 6c5f 6f75 7470     if final_outp
-0000c040: 7574 2069 7320 4e6f 6e65 3a0a 2020 2020  ut is None:.    
-0000c050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c060: 2020 2020 2020 2020 6669 6e61 6c5f 6f75          final_ou
-0000c070: 7470 7574 203d 2063 6875 6e6b 0a20 2020  tput = chunk.   
-0000c080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c090: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000c0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c0b0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0000c0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c0d0: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
-0000c0e0: 6c5f 6f75 7470 7574 203d 2066 696e 616c  l_output = final
-0000c0f0: 5f6f 7574 7075 7420 2b20 6368 756e 6b20  _output + chunk 
-0000c100: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
-0000c110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c120: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0000c130: 7074 2054 7970 6545 7272 6f72 3a0a 2020  pt TypeError:.  
+00003bc0: 2320 4f72 2065 7175 6976 616c 656e 746c  # Or equivalentl
+00003bd0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00003be0: 2020 2023 2073 6571 7565 6e63 6520 3d20     # sequence = 
+00003bf0: 7275 6e6e 6162 6c65 5f31 207c 2072 756e  runnable_1 | run
+00003c00: 6e61 626c 655f 320a 2020 2020 2020 2020  nable_2.        
+00003c10: 2020 2020 2020 2020 2320 7365 7175 656e          # sequen
+00003c20: 6365 203d 2052 756e 6e61 626c 6553 6571  ce = RunnableSeq
+00003c30: 7565 6e63 6528 6669 7273 743d 7275 6e6e  uence(first=runn
+00003c40: 6162 6c65 5f31 2c20 6c61 7374 3d72 756e  able_1, last=run
+00003c50: 6e61 626c 655f 3229 0a20 2020 2020 2020  nable_2).       
+00003c60: 2020 2020 2020 2020 2073 6571 7565 6e63           sequenc
+00003c70: 652e 696e 766f 6b65 2831 290a 2020 2020  e.invoke(1).    
+00003c80: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00003c90: 7420 7365 7175 656e 6365 2e61 696e 766f  t sequence.ainvo
+00003ca0: 6b65 2831 290a 2020 2020 2020 2020 2020  ke(1).          
+00003cb0: 2020 2020 2020 2320 2d3e 2034 0a0a 2020        # -> 4..  
+00003cc0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00003cd0: 7175 656e 6365 2e62 6174 6368 285b 312c  quence.batch([1,
+00003ce0: 2032 2c20 335d 290a 2020 2020 2020 2020   2, 3]).        
+00003cf0: 2020 2020 2020 2020 6177 6169 7420 7365          await se
+00003d00: 7175 656e 6365 2e61 6261 7463 6828 5b31  quence.abatch([1
+00003d10: 2c20 322c 2033 5d29 0a20 2020 2020 2020  , 2, 3]).       
+00003d20: 2020 2020 2020 2020 2023 202d 3e20 5b34           # -> [4
+00003d30: 2c20 362c 2038 5d0a 2020 2020 2020 2020  , 6, 8].        
+00003d40: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
+00003d50: 726e 2052 756e 6e61 626c 6553 6571 7565  rn RunnableSeque
+00003d60: 6e63 6528 7365 6c66 2c20 2a6f 7468 6572  nce(self, *other
+00003d70: 732c 206e 616d 653d 6e61 6d65 290a 0a20  s, name=name).. 
+00003d80: 2020 2064 6566 2070 6963 6b28 7365 6c66     def pick(self
+00003d90: 2c20 6b65 7973 3a20 556e 696f 6e5b 7374  , keys: Union[st
+00003da0: 722c 204c 6973 745b 7374 725d 5d29 202d  r, List[str]]) -
+00003db0: 3e20 5275 6e6e 6162 6c65 5365 7269 616c  > RunnableSerial
+00003dc0: 697a 6162 6c65 5b41 6e79 2c20 416e 795d  izable[Any, Any]
+00003dd0: 3a0a 2020 2020 2020 2020 2222 2250 6963  :.        """Pic
+00003de0: 6b20 6b65 7973 2066 726f 6d20 7468 6520  k keys from the 
+00003df0: 6469 6374 206f 7574 7075 7420 6f66 2074  dict output of t
+00003e00: 6869 7320 7275 6e6e 6162 6c65 2e0a 0a20  his runnable... 
+00003e10: 2020 2020 2020 2050 6963 6b20 7369 6e67         Pick sing
+00003e20: 6c65 206b 6579 3a0a 2020 2020 2020 2020  le key:.        
+00003e30: 2020 2020 2e2e 2063 6f64 652d 626c 6f63      .. code-bloc
+00003e40: 6b3a 3a20 7079 7468 6f6e 0a0a 2020 2020  k:: python..    
+00003e50: 2020 2020 2020 2020 2020 2020 696d 706f              impo
+00003e60: 7274 206a 736f 6e0a 0a20 2020 2020 2020  rt json..       
+00003e70: 2020 2020 2020 2020 2066 726f 6d20 6c61           from la
+00003e80: 6e67 6368 6169 6e5f 636f 7265 2e72 756e  ngchain_core.run
+00003e90: 6e61 626c 6573 2069 6d70 6f72 7420 5275  nables import Ru
+00003ea0: 6e6e 6162 6c65 4c61 6d62 6461 2c20 5275  nnableLambda, Ru
+00003eb0: 6e6e 6162 6c65 4d61 700a 0a20 2020 2020  nnableMap..     
+00003ec0: 2020 2020 2020 2020 2020 2061 735f 7374             as_st
+00003ed0: 7220 3d20 5275 6e6e 6162 6c65 4c61 6d62  r = RunnableLamb
+00003ee0: 6461 2873 7472 290a 2020 2020 2020 2020  da(str).        
+00003ef0: 2020 2020 2020 2020 6173 5f6a 736f 6e20          as_json 
+00003f00: 3d20 5275 6e6e 6162 6c65 4c61 6d62 6461  = RunnableLambda
+00003f10: 286a 736f 6e2e 6c6f 6164 7329 0a20 2020  (json.loads).   
+00003f20: 2020 2020 2020 2020 2020 2020 2063 6861               cha
+00003f30: 696e 203d 2052 756e 6e61 626c 654d 6170  in = RunnableMap
+00003f40: 2873 7472 3d61 735f 7374 722c 206a 736f  (str=as_str, jso
+00003f50: 6e3d 6173 5f6a 736f 6e29 0a0a 2020 2020  n=as_json)..    
+00003f60: 2020 2020 2020 2020 2020 2020 6368 6169              chai
+00003f70: 6e2e 696e 766f 6b65 2822 5b31 2c20 322c  n.invoke("[1, 2,
+00003f80: 2033 5d22 290a 2020 2020 2020 2020 2020   3]").          
+00003f90: 2020 2020 2020 2320 2d3e 207b 2273 7472        # -> {"str
+00003fa0: 223a 2022 5b31 2c20 322c 2033 5d22 2c20  ": "[1, 2, 3]", 
+00003fb0: 226a 736f 6e22 3a20 5b31 2c20 322c 2033  "json": [1, 2, 3
+00003fc0: 5d7d 0a0a 2020 2020 2020 2020 2020 2020  ]}..            
+00003fd0: 2020 2020 6a73 6f6e 5f6f 6e6c 795f 6368      json_only_ch
+00003fe0: 6169 6e20 3d20 6368 6169 6e2e 7069 636b  ain = chain.pick
+00003ff0: 2822 6a73 6f6e 2229 0a20 2020 2020 2020  ("json").       
+00004000: 2020 2020 2020 2020 206a 736f 6e5f 6f6e           json_on
+00004010: 6c79 5f63 6861 696e 2e69 6e76 6f6b 6528  ly_chain.invoke(
+00004020: 225b 312c 2032 2c20 335d 2229 0a20 2020  "[1, 2, 3]").   
+00004030: 2020 2020 2020 2020 2020 2020 2023 202d               # -
+00004040: 3e20 5b31 2c20 322c 2033 5d0a 0a20 2020  > [1, 2, 3]..   
+00004050: 2020 2020 2050 6963 6b20 6c69 7374 206f       Pick list o
+00004060: 6620 6b65 7973 3a0a 2020 2020 2020 2020  f keys:.        
+00004070: 2020 2020 2e2e 2063 6f64 652d 626c 6f63      .. code-bloc
+00004080: 6b3a 3a20 7079 7468 6f6e 0a0a 2020 2020  k:: python..    
+00004090: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
+000040a0: 2074 7970 696e 6720 696d 706f 7274 2041   typing import A
+000040b0: 6e79 0a0a 2020 2020 2020 2020 2020 2020  ny..            
+000040c0: 2020 2020 696d 706f 7274 206a 736f 6e0a      import json.
+000040d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000040e0: 2066 726f 6d20 6c61 6e67 6368 6169 6e5f   from langchain_
+000040f0: 636f 7265 2e72 756e 6e61 626c 6573 2069  core.runnables i
+00004100: 6d70 6f72 7420 5275 6e6e 6162 6c65 4c61  mport RunnableLa
+00004110: 6d62 6461 2c20 5275 6e6e 6162 6c65 4d61  mbda, RunnableMa
+00004120: 700a 0a20 2020 2020 2020 2020 2020 2020  p..             
+00004130: 2020 2061 735f 7374 7220 3d20 5275 6e6e     as_str = Runn
+00004140: 6162 6c65 4c61 6d62 6461 2873 7472 290a  ableLambda(str).
+00004150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004160: 6173 5f6a 736f 6e20 3d20 5275 6e6e 6162  as_json = Runnab
+00004170: 6c65 4c61 6d62 6461 286a 736f 6e2e 6c6f  leLambda(json.lo
+00004180: 6164 7329 0a20 2020 2020 2020 2020 2020  ads).           
+00004190: 2020 2020 2064 6566 2061 735f 6279 7465       def as_byte
+000041a0: 7328 783a 2041 6e79 2920 2d3e 2062 7974  s(x: Any) -> byt
+000041b0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+000041c0: 2020 2020 2020 2020 7265 7475 726e 2062          return b
+000041d0: 7974 6573 2878 2c20 2275 7466 2d38 2229  ytes(x, "utf-8")
+000041e0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000041f0: 2020 6368 6169 6e20 3d20 5275 6e6e 6162    chain = Runnab
+00004200: 6c65 4d61 7028 0a20 2020 2020 2020 2020  leMap(.         
+00004210: 2020 2020 2020 2020 2020 2073 7472 3d61             str=a
+00004220: 735f 7374 722c 0a20 2020 2020 2020 2020  s_str,.         
+00004230: 2020 2020 2020 2020 2020 206a 736f 6e3d             json=
+00004240: 6173 5f6a 736f 6e2c 0a20 2020 2020 2020  as_json,.       
+00004250: 2020 2020 2020 2020 2020 2020 2062 7974               byt
+00004260: 6573 3d52 756e 6e61 626c 654c 616d 6264  es=RunnableLambd
+00004270: 6128 6173 5f62 7974 6573 290a 2020 2020  a(as_bytes).    
+00004280: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00004290: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000042a0: 6861 696e 2e69 6e76 6f6b 6528 225b 312c  hain.invoke("[1,
+000042b0: 2032 2c20 335d 2229 0a20 2020 2020 2020   2, 3]").       
+000042c0: 2020 2020 2020 2020 2023 202d 3e20 7b22           # -> {"
+000042d0: 7374 7222 3a20 225b 312c 2032 2c20 335d  str": "[1, 2, 3]
+000042e0: 222c 2022 6a73 6f6e 223a 205b 312c 2032  ", "json": [1, 2
+000042f0: 2c20 335d 2c20 2262 7974 6573 223a 2062  , 3], "bytes": b
+00004300: 225b 312c 2032 2c20 335d 227d 0a0a 2020  "[1, 2, 3]"}..  
+00004310: 2020 2020 2020 2020 2020 2020 2020 6a73                js
+00004320: 6f6e 5f61 6e64 5f62 7974 6573 5f63 6861  on_and_bytes_cha
+00004330: 696e 203d 2063 6861 696e 2e70 6963 6b28  in = chain.pick(
+00004340: 5b22 6a73 6f6e 222c 2022 6279 7465 7322  ["json", "bytes"
+00004350: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00004360: 2020 206a 736f 6e5f 616e 645f 6279 7465     json_and_byte
+00004370: 735f 6368 6169 6e2e 696e 766f 6b65 2822  s_chain.invoke("
+00004380: 5b31 2c20 322c 2033 5d22 290a 2020 2020  [1, 2, 3]").    
+00004390: 2020 2020 2020 2020 2020 2020 2320 2d3e              # ->
+000043a0: 207b 226a 736f 6e22 3a20 5b31 2c20 322c   {"json": [1, 2,
+000043b0: 2033 5d2c 2022 6279 7465 7322 3a20 6222   3], "bytes": b"
+000043c0: 5b31 2c20 322c 2033 5d22 7d0a 0a20 2020  [1, 2, 3]"}..   
+000043d0: 2020 2020 2022 2222 2020 2320 6e6f 7161       """  # noqa
+000043e0: 3a20 4535 3031 0a20 2020 2020 2020 2066  : E501.        f
+000043f0: 726f 6d20 6c61 6e67 6368 6169 6e5f 636f  rom langchain_co
+00004400: 7265 2e72 756e 6e61 626c 6573 2e70 6173  re.runnables.pas
+00004410: 7374 6872 6f75 6768 2069 6d70 6f72 7420  sthrough import 
+00004420: 5275 6e6e 6162 6c65 5069 636b 0a0a 2020  RunnablePick..  
+00004430: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00004440: 6620 7c20 5275 6e6e 6162 6c65 5069 636b  f | RunnablePick
+00004450: 286b 6579 7329 0a0a 2020 2020 6465 6620  (keys)..    def 
+00004460: 6173 7369 676e 280a 2020 2020 2020 2020  assign(.        
+00004470: 7365 6c66 2c0a 2020 2020 2020 2020 2a2a  self,.        **
+00004480: 6b77 6172 6773 3a20 556e 696f 6e5b 0a20  kwargs: Union[. 
+00004490: 2020 2020 2020 2020 2020 2052 756e 6e61             Runna
+000044a0: 626c 655b 4469 6374 5b73 7472 2c20 416e  ble[Dict[str, An
+000044b0: 795d 2c20 416e 795d 2c0a 2020 2020 2020  y], Any],.      
+000044c0: 2020 2020 2020 4361 6c6c 6162 6c65 5b5b        Callable[[
+000044d0: 4469 6374 5b73 7472 2c20 416e 795d 5d2c  Dict[str, Any]],
+000044e0: 2041 6e79 5d2c 0a20 2020 2020 2020 2020   Any],.         
+000044f0: 2020 204d 6170 7069 6e67 5b0a 2020 2020     Mapping[.    
+00004500: 2020 2020 2020 2020 2020 2020 7374 722c              str,
+00004510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004520: 2055 6e69 6f6e 5b52 756e 6e61 626c 655b   Union[Runnable[
+00004530: 4469 6374 5b73 7472 2c20 416e 795d 2c20  Dict[str, Any], 
+00004540: 416e 795d 2c20 4361 6c6c 6162 6c65 5b5b  Any], Callable[[
+00004550: 4469 6374 5b73 7472 2c20 416e 795d 5d2c  Dict[str, Any]],
+00004560: 2041 6e79 5d5d 2c0a 2020 2020 2020 2020   Any]],.        
+00004570: 2020 2020 5d2c 0a20 2020 2020 2020 205d      ],.        ]
+00004580: 2c0a 2020 2020 2920 2d3e 2052 756e 6e61  ,.    ) -> Runna
+00004590: 626c 6553 6572 6961 6c69 7a61 626c 655b  bleSerializable[
+000045a0: 416e 792c 2041 6e79 5d3a 0a20 2020 2020  Any, Any]:.     
+000045b0: 2020 2022 2222 4173 7369 676e 7320 6e65     """Assigns ne
+000045c0: 7720 6669 656c 6473 2074 6f20 7468 6520  w fields to the 
+000045d0: 6469 6374 206f 7574 7075 7420 6f66 2074  dict output of t
+000045e0: 6869 7320 7275 6e6e 6162 6c65 2e0a 2020  his runnable..  
+000045f0: 2020 2020 2020 5265 7475 726e 7320 6120        Returns a 
+00004600: 6e65 7720 7275 6e6e 6162 6c65 2e0a 0a20  new runnable... 
+00004610: 2020 2020 2020 202e 2e20 636f 6465 2d62         .. code-b
+00004620: 6c6f 636b 3a3a 2070 7974 686f 6e0a 0a20  lock:: python.. 
+00004630: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
+00004640: 6c61 6e67 6368 6169 6e5f 636f 6d6d 756e  langchain_commun
+00004650: 6974 792e 6c6c 6d73 2e66 616b 6520 696d  ity.llms.fake im
+00004660: 706f 7274 2046 616b 6553 7472 6561 6d69  port FakeStreami
+00004670: 6e67 4c69 7374 4c4c 4d0a 2020 2020 2020  ngListLLM.      
+00004680: 2020 2020 2020 6672 6f6d 206c 616e 6763        from langc
+00004690: 6861 696e 5f63 6f72 652e 6f75 7470 7574  hain_core.output
+000046a0: 5f70 6172 7365 7273 2069 6d70 6f72 7420  _parsers import 
+000046b0: 5374 724f 7574 7075 7450 6172 7365 720a  StrOutputParser.
+000046c0: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
+000046d0: 206c 616e 6763 6861 696e 5f63 6f72 652e   langchain_core.
+000046e0: 7072 6f6d 7074 7320 696d 706f 7274 2053  prompts import S
+000046f0: 7973 7465 6d4d 6573 7361 6765 5072 6f6d  ystemMessageProm
+00004700: 7074 5465 6d70 6c61 7465 0a20 2020 2020  ptTemplate.     
+00004710: 2020 2020 2020 2066 726f 6d20 6c61 6e67         from lang
+00004720: 6368 6169 6e5f 636f 7265 2e72 756e 6e61  chain_core.runna
+00004730: 626c 6573 2069 6d70 6f72 7420 5275 6e6e  bles import Runn
+00004740: 6162 6c65 0a20 2020 2020 2020 2020 2020  able.           
+00004750: 2066 726f 6d20 6f70 6572 6174 6f72 2069   from operator i
+00004760: 6d70 6f72 7420 6974 656d 6765 7474 6572  mport itemgetter
+00004770: 0a0a 2020 2020 2020 2020 2020 2020 7072  ..            pr
+00004780: 6f6d 7074 203d 2028 0a20 2020 2020 2020  ompt = (.       
+00004790: 2020 2020 2020 2020 2053 7973 7465 6d4d           SystemM
+000047a0: 6573 7361 6765 5072 6f6d 7074 5465 6d70  essagePromptTemp
+000047b0: 6c61 7465 2e66 726f 6d5f 7465 6d70 6c61  late.from_templa
+000047c0: 7465 2822 596f 7520 6172 6520 6120 6e69  te("You are a ni
+000047d0: 6365 2061 7373 6973 7461 6e74 2e22 290a  ce assistant.").
+000047e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000047f0: 2b20 227b 7175 6573 7469 6f6e 7d22 0a20  + "{question}". 
+00004800: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00004810: 2020 2020 2020 2020 206c 6c6d 203d 2046           llm = F
+00004820: 616b 6553 7472 6561 6d69 6e67 4c69 7374  akeStreamingList
+00004830: 4c4c 4d28 7265 7370 6f6e 7365 733d 5b22  LLM(responses=["
+00004840: 666f 6f2d 6c69 7368 225d 290a 0a20 2020  foo-lish"])..   
+00004850: 2020 2020 2020 2020 2063 6861 696e 3a20           chain: 
+00004860: 5275 6e6e 6162 6c65 203d 2070 726f 6d70  Runnable = promp
+00004870: 7420 7c20 6c6c 6d20 7c20 7b22 7374 7222  t | llm | {"str"
+00004880: 3a20 5374 724f 7574 7075 7450 6172 7365  : StrOutputParse
+00004890: 7228 297d 0a0a 2020 2020 2020 2020 2020  r()}..          
+000048a0: 2020 6368 6169 6e5f 7769 7468 5f61 7373    chain_with_ass
+000048b0: 6967 6e20 3d20 6368 6169 6e2e 6173 7369  ign = chain.assi
+000048c0: 676e 2868 656c 6c6f 3d69 7465 6d67 6574  gn(hello=itemget
+000048d0: 7465 7228 2273 7472 2229 207c 206c 6c6d  ter("str") | llm
+000048e0: 290a 0a20 2020 2020 2020 2020 2020 2070  )..            p
+000048f0: 7269 6e74 2863 6861 696e 5f77 6974 685f  rint(chain_with_
+00004900: 6173 7369 676e 2e69 6e70 7574 5f73 6368  assign.input_sch
+00004910: 656d 612e 7363 6865 6d61 2829 290a 2020  ema.schema()).  
+00004920: 2020 2020 2020 2020 2020 2320 7b27 7469            # {'ti
+00004930: 746c 6527 3a20 2750 726f 6d70 7449 6e70  tle': 'PromptInp
+00004940: 7574 272c 2027 7479 7065 273a 2027 6f62  ut', 'type': 'ob
+00004950: 6a65 6374 272c 2027 7072 6f70 6572 7469  ject', 'properti
+00004960: 6573 273a 0a20 2020 2020 2020 2020 2020  es':.           
+00004970: 207b 2771 7565 7374 696f 6e27 3a20 7b27   {'question': {'
+00004980: 7469 746c 6527 3a20 2751 7565 7374 696f  title': 'Questio
+00004990: 6e27 2c20 2774 7970 6527 3a20 2773 7472  n', 'type': 'str
+000049a0: 696e 6727 7d7d 7d0a 2020 2020 2020 2020  ing'}}}.        
+000049b0: 2020 2020 7072 696e 7428 6368 6169 6e5f      print(chain_
+000049c0: 7769 7468 5f61 7373 6967 6e2e 6f75 7470  with_assign.outp
+000049d0: 7574 5f73 6368 656d 612e 7363 6865 6d61  ut_schema.schema
+000049e0: 2829 2920 230a 2020 2020 2020 2020 2020  ()) #.          
+000049f0: 2020 7b27 7469 746c 6527 3a20 2752 756e    {'title': 'Run
+00004a00: 6e61 626c 6553 6571 7565 6e63 654f 7574  nableSequenceOut
+00004a10: 7075 7427 2c20 2774 7970 6527 3a20 276f  put', 'type': 'o
+00004a20: 626a 6563 7427 2c20 2770 726f 7065 7274  bject', 'propert
+00004a30: 6965 7327 3a0a 2020 2020 2020 2020 2020  ies':.          
+00004a40: 2020 7b27 7374 7227 3a20 7b27 7469 746c    {'str': {'titl
+00004a50: 6527 3a20 2753 7472 272c 0a20 2020 2020  e': 'Str',.     
+00004a60: 2020 2020 2020 2027 7479 7065 273a 2027         'type': '
+00004a70: 7374 7269 6e67 277d 2c20 2768 656c 6c6f  string'}, 'hello
+00004a80: 273a 207b 2774 6974 6c65 273a 2027 4865  ': {'title': 'He
+00004a90: 6c6c 6f27 2c20 2774 7970 6527 3a20 2773  llo', 'type': 's
+00004aa0: 7472 696e 6727 7d7d 7d0a 0a20 2020 2020  tring'}}}..     
+00004ab0: 2020 2022 2222 0a20 2020 2020 2020 2066     """.        f
+00004ac0: 726f 6d20 6c61 6e67 6368 6169 6e5f 636f  rom langchain_co
+00004ad0: 7265 2e72 756e 6e61 626c 6573 2e70 6173  re.runnables.pas
+00004ae0: 7374 6872 6f75 6768 2069 6d70 6f72 7420  sthrough import 
+00004af0: 5275 6e6e 6162 6c65 4173 7369 676e 0a0a  RunnableAssign..
+00004b00: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00004b10: 656c 6620 7c20 5275 6e6e 6162 6c65 4173  elf | RunnableAs
+00004b20: 7369 676e 2852 756e 6e61 626c 6550 6172  sign(RunnablePar
+00004b30: 616c 6c65 6c28 6b77 6172 6773 2929 0a0a  allel(kwargs))..
+00004b40: 2020 2020 2222 2220 2d2d 2d20 5075 626c      """ --- Publ
+00004b50: 6963 2041 5049 202d 2d2d 2022 2222 0a0a  ic API --- """..
+00004b60: 2020 2020 4061 6273 7472 6163 746d 6574      @abstractmet
+00004b70: 686f 640a 2020 2020 6465 6620 696e 766f  hod.    def invo
+00004b80: 6b65 2873 656c 662c 2069 6e70 7574 3a20  ke(self, input: 
+00004b90: 496e 7075 742c 2063 6f6e 6669 673a 204f  Input, config: O
+00004ba0: 7074 696f 6e61 6c5b 5275 6e6e 6162 6c65  ptional[Runnable
+00004bb0: 436f 6e66 6967 5d20 3d20 4e6f 6e65 2920  Config] = None) 
+00004bc0: 2d3e 204f 7574 7075 743a 0a20 2020 2020  -> Output:.     
+00004bd0: 2020 2022 2222 5472 616e 7366 6f72 6d20     """Transform 
+00004be0: 6120 7369 6e67 6c65 2069 6e70 7574 2069  a single input i
+00004bf0: 6e74 6f20 616e 206f 7574 7075 742e 204f  nto an output. O
+00004c00: 7665 7272 6964 6520 746f 2069 6d70 6c65  verride to imple
+00004c10: 6d65 6e74 2e0a 0a20 2020 2020 2020 2041  ment...        A
+00004c20: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
+00004c30: 2069 6e70 7574 3a20 5468 6520 696e 7075   input: The inpu
+00004c40: 7420 746f 2074 6865 2072 756e 6e61 626c  t to the runnabl
+00004c50: 652e 0a20 2020 2020 2020 2020 2020 2063  e..            c
+00004c60: 6f6e 6669 673a 2041 2063 6f6e 6669 6720  onfig: A config 
+00004c70: 746f 2075 7365 2077 6865 6e20 696e 766f  to use when invo
+00004c80: 6b69 6e67 2074 6865 2072 756e 6e61 626c  king the runnabl
+00004c90: 652e 0a20 2020 2020 2020 2020 2020 2020  e..             
+00004ca0: 2020 5468 6520 636f 6e66 6967 2073 7570    The config sup
+00004cb0: 706f 7274 7320 7374 616e 6461 7264 206b  ports standard k
+00004cc0: 6579 7320 6c69 6b65 2027 7461 6773 272c  eys like 'tags',
+00004cd0: 2027 6d65 7461 6461 7461 2720 666f 7220   'metadata' for 
+00004ce0: 7472 6163 696e 670a 2020 2020 2020 2020  tracing.        
+00004cf0: 2020 2020 2020 2070 7572 706f 7365 732c         purposes,
+00004d00: 2027 6d61 785f 636f 6e63 7572 7265 6e63   'max_concurrenc
+00004d10: 7927 2066 6f72 2063 6f6e 7472 6f6c 6c69  y' for controlli
+00004d20: 6e67 2068 6f77 206d 7563 6820 776f 726b  ng how much work
+00004d30: 2074 6f20 646f 0a20 2020 2020 2020 2020   to do.         
+00004d40: 2020 2020 2020 696e 2070 6172 616c 6c65        in paralle
+00004d50: 6c2c 2061 6e64 206f 7468 6572 206b 6579  l, and other key
+00004d60: 732e 2050 6c65 6173 6520 7265 6665 7220  s. Please refer 
+00004d70: 746f 2074 6865 2052 756e 6e61 626c 6543  to the RunnableC
+00004d80: 6f6e 6669 670a 2020 2020 2020 2020 2020  onfig.          
+00004d90: 2020 2020 2066 6f72 206d 6f72 6520 6465       for more de
+00004da0: 7461 696c 732e 0a0a 2020 2020 2020 2020  tails...        
+00004db0: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+00004dc0: 2020 2020 2054 6865 206f 7574 7075 7420       The output 
+00004dd0: 6f66 2074 6865 2072 756e 6e61 626c 652e  of the runnable.
+00004de0: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
+00004df0: 2020 6173 796e 6320 6465 6620 6169 6e76    async def ainv
+00004e00: 6f6b 6528 0a20 2020 2020 2020 2073 656c  oke(.        sel
+00004e10: 662c 2069 6e70 7574 3a20 496e 7075 742c  f, input: Input,
+00004e20: 2063 6f6e 6669 673a 204f 7074 696f 6e61   config: Optiona
+00004e30: 6c5b 5275 6e6e 6162 6c65 436f 6e66 6967  l[RunnableConfig
+00004e40: 5d20 3d20 4e6f 6e65 2c20 2a2a 6b77 6172  ] = None, **kwar
+00004e50: 6773 3a20 416e 790a 2020 2020 2920 2d3e  gs: Any.    ) ->
+00004e60: 204f 7574 7075 743a 0a20 2020 2020 2020   Output:.       
+00004e70: 2022 2222 4465 6661 756c 7420 696d 706c   """Default impl
+00004e80: 656d 656e 7461 7469 6f6e 206f 6620 6169  ementation of ai
+00004e90: 6e76 6f6b 652c 2063 616c 6c73 2069 6e76  nvoke, calls inv
+00004ea0: 6f6b 6520 6672 6f6d 2061 2074 6872 6561  oke from a threa
+00004eb0: 642e 0a0a 2020 2020 2020 2020 5468 6520  d...        The 
+00004ec0: 6465 6661 756c 7420 696d 706c 656d 656e  default implemen
+00004ed0: 7461 7469 6f6e 2061 6c6c 6f77 7320 7573  tation allows us
+00004ee0: 6167 6520 6f66 2061 7379 6e63 2063 6f64  age of async cod
+00004ef0: 6520 6576 656e 2069 660a 2020 2020 2020  e even if.      
+00004f00: 2020 7468 6520 7275 6e6e 6162 6c65 2064    the runnable d
+00004f10: 6964 206e 6f74 2069 6d70 6c65 6d65 6e74  id not implement
+00004f20: 2061 206e 6174 6976 6520 6173 796e 6320   a native async 
+00004f30: 7665 7273 696f 6e20 6f66 2069 6e76 6f6b  version of invok
+00004f40: 652e 0a0a 2020 2020 2020 2020 5375 6263  e...        Subc
+00004f50: 6c61 7373 6573 2073 686f 756c 6420 6f76  lasses should ov
+00004f60: 6572 7269 6465 2074 6869 7320 6d65 7468  erride this meth
+00004f70: 6f64 2069 6620 7468 6579 2063 616e 2072  od if they can r
+00004f80: 756e 2061 7379 6e63 6872 6f6e 6f75 736c  un asynchronousl
+00004f90: 792e 0a20 2020 2020 2020 2022 2222 0a20  y..        """. 
+00004fa0: 2020 2020 2020 2072 6574 7572 6e20 6177         return aw
+00004fb0: 6169 7420 7275 6e5f 696e 5f65 7865 6375  ait run_in_execu
+00004fc0: 746f 7228 636f 6e66 6967 2c20 7365 6c66  tor(config, self
+00004fd0: 2e69 6e76 6f6b 652c 2069 6e70 7574 2c20  .invoke, input, 
+00004fe0: 636f 6e66 6967 2c20 2a2a 6b77 6172 6773  config, **kwargs
+00004ff0: 290a 0a20 2020 2064 6566 2062 6174 6368  )..    def batch
+00005000: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00005010: 2020 2020 2020 2020 696e 7075 7473 3a20          inputs: 
+00005020: 4c69 7374 5b49 6e70 7574 5d2c 0a20 2020  List[Input],.   
+00005030: 2020 2020 2063 6f6e 6669 673a 204f 7074       config: Opt
+00005040: 696f 6e61 6c5b 556e 696f 6e5b 5275 6e6e  ional[Union[Runn
+00005050: 6162 6c65 436f 6e66 6967 2c20 4c69 7374  ableConfig, List
+00005060: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+00005070: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
+00005080: 2020 202a 2c0a 2020 2020 2020 2020 7265     *,.        re
+00005090: 7475 726e 5f65 7863 6570 7469 6f6e 733a  turn_exceptions:
+000050a0: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+000050b0: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
+000050c0: 204f 7074 696f 6e61 6c5b 416e 795d 2c0a   Optional[Any],.
+000050d0: 2020 2020 2920 2d3e 204c 6973 745b 4f75      ) -> List[Ou
+000050e0: 7470 7574 5d3a 0a20 2020 2020 2020 2022  tput]:.        "
+000050f0: 2222 4465 6661 756c 7420 696d 706c 656d  ""Default implem
+00005100: 656e 7461 7469 6f6e 2072 756e 7320 696e  entation runs in
+00005110: 766f 6b65 2069 6e20 7061 7261 6c6c 656c  voke in parallel
+00005120: 2075 7369 6e67 2061 2074 6872 6561 6420   using a thread 
+00005130: 706f 6f6c 2065 7865 6375 746f 722e 0a0a  pool executor...
+00005140: 2020 2020 2020 2020 5468 6520 6465 6661          The defa
+00005150: 756c 7420 696d 706c 656d 656e 7461 7469  ult implementati
+00005160: 6f6e 206f 6620 6261 7463 6820 776f 726b  on of batch work
+00005170: 7320 7765 6c6c 2066 6f72 2049 4f20 626f  s well for IO bo
+00005180: 756e 6420 7275 6e6e 6162 6c65 732e 0a0a  und runnables...
+00005190: 2020 2020 2020 2020 5375 6263 6c61 7373          Subclass
+000051a0: 6573 2073 686f 756c 6420 6f76 6572 7269  es should overri
+000051b0: 6465 2074 6869 7320 6d65 7468 6f64 2069  de this method i
+000051c0: 6620 7468 6579 2063 616e 2062 6174 6368  f they can batch
+000051d0: 206d 6f72 6520 6566 6669 6369 656e 746c   more efficientl
+000051e0: 793b 0a20 2020 2020 2020 2065 2e67 2e2c  y;.        e.g.,
+000051f0: 2069 6620 7468 6520 756e 6465 726c 7969   if the underlyi
+00005200: 6e67 2072 756e 6e61 626c 6520 7573 6573  ng runnable uses
+00005210: 2061 6e20 4150 4920 7768 6963 6820 7375   an API which su
+00005220: 7070 6f72 7473 2061 2062 6174 6368 206d  pports a batch m
+00005230: 6f64 652e 0a20 2020 2020 2020 2022 2222  ode..        """
+00005240: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00005250: 696e 7075 7473 3a0a 2020 2020 2020 2020  inputs:.        
+00005260: 2020 2020 7265 7475 726e 205b 5d0a 0a20      return [].. 
+00005270: 2020 2020 2020 2063 6f6e 6669 6773 203d         configs =
+00005280: 2067 6574 5f63 6f6e 6669 675f 6c69 7374   get_config_list
+00005290: 2863 6f6e 6669 672c 206c 656e 2869 6e70  (config, len(inp
+000052a0: 7574 7329 290a 0a20 2020 2020 2020 2064  uts))..        d
+000052b0: 6566 2069 6e76 6f6b 6528 696e 7075 743a  ef invoke(input:
+000052c0: 2049 6e70 7574 2c20 636f 6e66 6967 3a20   Input, config: 
+000052d0: 5275 6e6e 6162 6c65 436f 6e66 6967 2920  RunnableConfig) 
+000052e0: 2d3e 2055 6e69 6f6e 5b4f 7574 7075 742c  -> Union[Output,
+000052f0: 2045 7863 6570 7469 6f6e 5d3a 0a20 2020   Exception]:.   
+00005300: 2020 2020 2020 2020 2069 6620 7265 7475           if retu
+00005310: 726e 5f65 7863 6570 7469 6f6e 733a 0a20  rn_exceptions:. 
+00005320: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00005330: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00005340: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00005350: 656c 662e 696e 766f 6b65 2869 6e70 7574  elf.invoke(input
+00005360: 2c20 636f 6e66 6967 2c20 2a2a 6b77 6172  , config, **kwar
+00005370: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
+00005380: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+00005390: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+000053a0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000053b0: 6574 7572 6e20 650a 2020 2020 2020 2020  eturn e.        
+000053c0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000053d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000053e0: 2073 656c 662e 696e 766f 6b65 2869 6e70   self.invoke(inp
+000053f0: 7574 2c20 636f 6e66 6967 2c20 2a2a 6b77  ut, config, **kw
+00005400: 6172 6773 290a 0a20 2020 2020 2020 2023  args)..        #
+00005410: 2049 6620 7468 6572 6527 7320 6f6e 6c79   If there's only
+00005420: 206f 6e65 2069 6e70 7574 2c20 646f 6e27   one input, don'
+00005430: 7420 626f 7468 6572 2077 6974 6820 7468  t bother with th
+00005440: 6520 6578 6563 7574 6f72 0a20 2020 2020  e executor.     
+00005450: 2020 2069 6620 6c65 6e28 696e 7075 7473     if len(inputs
+00005460: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
+00005470: 2020 2020 7265 7475 726e 2063 6173 7428      return cast(
+00005480: 4c69 7374 5b4f 7574 7075 745d 2c20 5b69  List[Output], [i
+00005490: 6e76 6f6b 6528 696e 7075 7473 5b30 5d2c  nvoke(inputs[0],
+000054a0: 2063 6f6e 6669 6773 5b30 5d29 5d29 0a0a   configs[0])])..
+000054b0: 2020 2020 2020 2020 7769 7468 2067 6574          with get
+000054c0: 5f65 7865 6375 746f 725f 666f 725f 636f  _executor_for_co
+000054d0: 6e66 6967 2863 6f6e 6669 6773 5b30 5d29  nfig(configs[0])
+000054e0: 2061 7320 6578 6563 7574 6f72 3a0a 2020   as executor:.  
+000054f0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00005500: 2063 6173 7428 4c69 7374 5b4f 7574 7075   cast(List[Outpu
+00005510: 745d 2c20 6c69 7374 2865 7865 6375 746f  t], list(executo
+00005520: 722e 6d61 7028 696e 766f 6b65 2c20 696e  r.map(invoke, in
+00005530: 7075 7473 2c20 636f 6e66 6967 7329 2929  puts, configs)))
+00005540: 0a0a 2020 2020 406f 7665 726c 6f61 640a  ..    @overload.
+00005550: 2020 2020 6465 6620 6261 7463 685f 6173      def batch_as
+00005560: 5f63 6f6d 706c 6574 6564 280a 2020 2020  _completed(.    
+00005570: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00005580: 2020 696e 7075 7473 3a20 4c69 7374 5b49    inputs: List[I
+00005590: 6e70 7574 5d2c 0a20 2020 2020 2020 2063  nput],.        c
+000055a0: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
+000055b0: 556e 696f 6e5b 5275 6e6e 6162 6c65 436f  Union[RunnableCo
+000055c0: 6e66 6967 2c20 4c69 7374 5b52 756e 6e61  nfig, List[Runna
+000055d0: 626c 6543 6f6e 6669 675d 5d5d 203d 204e  bleConfig]]] = N
+000055e0: 6f6e 652c 0a20 2020 2020 2020 202a 2c0a  one,.        *,.
+000055f0: 2020 2020 2020 2020 7265 7475 726e 5f65          return_e
+00005600: 7863 6570 7469 6f6e 733a 204c 6974 6572  xceptions: Liter
+00005610: 616c 5b46 616c 7365 5d20 3d20 4661 6c73  al[False] = Fals
+00005620: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
+00005630: 7267 733a 2041 6e79 2c0a 2020 2020 2920  rgs: Any,.    ) 
+00005640: 2d3e 2049 7465 7261 746f 725b 5475 706c  -> Iterator[Tupl
+00005650: 655b 696e 742c 204f 7574 7075 745d 5d3a  e[int, Output]]:
+00005660: 0a20 2020 2020 2020 202e 2e2e 0a0a 2020  .        .....  
+00005670: 2020 406f 7665 726c 6f61 640a 2020 2020    @overload.    
+00005680: 6465 6620 6261 7463 685f 6173 5f63 6f6d  def batch_as_com
+00005690: 706c 6574 6564 280a 2020 2020 2020 2020  pleted(.        
+000056a0: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
+000056b0: 7075 7473 3a20 4c69 7374 5b49 6e70 7574  puts: List[Input
+000056c0: 5d2c 0a20 2020 2020 2020 2063 6f6e 6669  ],.        confi
+000056d0: 673a 204f 7074 696f 6e61 6c5b 556e 696f  g: Optional[Unio
+000056e0: 6e5b 5275 6e6e 6162 6c65 436f 6e66 6967  n[RunnableConfig
+000056f0: 2c20 4c69 7374 5b52 756e 6e61 626c 6543  , List[RunnableC
+00005700: 6f6e 6669 675d 5d5d 203d 204e 6f6e 652c  onfig]]] = None,
+00005710: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
+00005720: 2020 2020 7265 7475 726e 5f65 7863 6570      return_excep
+00005730: 7469 6f6e 733a 204c 6974 6572 616c 5b54  tions: Literal[T
+00005740: 7275 655d 2c0a 2020 2020 2020 2020 2a2a  rue],.        **
+00005750: 6b77 6172 6773 3a20 416e 792c 0a20 2020  kwargs: Any,.   
+00005760: 2029 202d 3e20 4974 6572 6174 6f72 5b54   ) -> Iterator[T
+00005770: 7570 6c65 5b69 6e74 2c20 556e 696f 6e5b  uple[int, Union[
+00005780: 4f75 7470 7574 2c20 4578 6365 7074 696f  Output, Exceptio
+00005790: 6e5d 5d5d 3a0a 2020 2020 2020 2020 2e2e  n]]]:.        ..
+000057a0: 2e0a 0a20 2020 2064 6566 2062 6174 6368  ...    def batch
+000057b0: 5f61 735f 636f 6d70 6c65 7465 6428 0a20  _as_completed(. 
+000057c0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+000057d0: 2020 2020 2069 6e70 7574 733a 204c 6973       inputs: Lis
+000057e0: 745b 496e 7075 745d 2c0a 2020 2020 2020  t[Input],.      
+000057f0: 2020 636f 6e66 6967 3a20 4f70 7469 6f6e    config: Option
+00005800: 616c 5b55 6e69 6f6e 5b52 756e 6e61 626c  al[Union[Runnabl
+00005810: 6543 6f6e 6669 672c 204c 6973 745b 5275  eConfig, List[Ru
+00005820: 6e6e 6162 6c65 436f 6e66 6967 5d5d 5d20  nnableConfig]]] 
+00005830: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00005840: 2a2c 0a20 2020 2020 2020 2072 6574 7572  *,.        retur
+00005850: 6e5f 6578 6365 7074 696f 6e73 3a20 626f  n_exceptions: bo
+00005860: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+00005870: 2020 2020 2a2a 6b77 6172 6773 3a20 4f70      **kwargs: Op
+00005880: 7469 6f6e 616c 5b41 6e79 5d2c 0a20 2020  tional[Any],.   
+00005890: 2029 202d 3e20 4974 6572 6174 6f72 5b54   ) -> Iterator[T
+000058a0: 7570 6c65 5b69 6e74 2c20 556e 696f 6e5b  uple[int, Union[
+000058b0: 4f75 7470 7574 2c20 4578 6365 7074 696f  Output, Exceptio
+000058c0: 6e5d 5d5d 3a0a 2020 2020 2020 2020 2222  n]]]:.        ""
+000058d0: 2252 756e 2069 6e76 6f6b 6520 696e 2070  "Run invoke in p
+000058e0: 6172 616c 6c65 6c20 6f6e 2061 206c 6973  arallel on a lis
+000058f0: 7420 6f66 2069 6e70 7574 732c 0a20 2020  t of inputs,.   
+00005900: 2020 2020 2079 6965 6c64 696e 6720 7265       yielding re
+00005910: 7375 6c74 7320 6173 2074 6865 7920 636f  sults as they co
+00005920: 6d70 6c65 7465 2e22 2222 0a0a 2020 2020  mplete."""..    
+00005930: 2020 2020 6966 206e 6f74 2069 6e70 7574      if not input
+00005940: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
+00005950: 6574 7572 6e0a 0a20 2020 2020 2020 2063  eturn..        c
+00005960: 6f6e 6669 6773 203d 2067 6574 5f63 6f6e  onfigs = get_con
+00005970: 6669 675f 6c69 7374 2863 6f6e 6669 672c  fig_list(config,
+00005980: 206c 656e 2869 6e70 7574 7329 290a 0a20   len(inputs)).. 
+00005990: 2020 2020 2020 2064 6566 2069 6e76 6f6b         def invok
+000059a0: 6528 0a20 2020 2020 2020 2020 2020 2069  e(.            i
+000059b0: 3a20 696e 742c 2069 6e70 7574 3a20 496e  : int, input: In
+000059c0: 7075 742c 2063 6f6e 6669 673a 2052 756e  put, config: Run
+000059d0: 6e61 626c 6543 6f6e 6669 670a 2020 2020  nableConfig.    
+000059e0: 2020 2020 2920 2d3e 2054 7570 6c65 5b69      ) -> Tuple[i
+000059f0: 6e74 2c20 556e 696f 6e5b 4f75 7470 7574  nt, Union[Output
+00005a00: 2c20 4578 6365 7074 696f 6e5d 5d3a 0a20  , Exception]]:. 
+00005a10: 2020 2020 2020 2020 2020 2069 6620 7265             if re
+00005a20: 7475 726e 5f65 7863 6570 7469 6f6e 733a  turn_exceptions:
+00005a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005a40: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00005a50: 2020 2020 2020 2020 2020 6f75 743a 2055            out: U
+00005a60: 6e69 6f6e 5b4f 7574 7075 742c 2045 7863  nion[Output, Exc
+00005a70: 6570 7469 6f6e 5d20 3d20 7365 6c66 2e69  eption] = self.i
+00005a80: 6e76 6f6b 6528 696e 7075 742c 2063 6f6e  nvoke(input, con
+00005a90: 6669 672c 202a 2a6b 7761 7267 7329 0a20  fig, **kwargs). 
+00005aa0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00005ab0: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+00005ac0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+00005ad0: 2020 2020 2020 2020 2020 6f75 7420 3d20            out = 
+00005ae0: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
+00005af0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00005b00: 2020 2020 6f75 7420 3d20 7365 6c66 2e69      out = self.i
+00005b10: 6e76 6f6b 6528 696e 7075 742c 2063 6f6e  nvoke(input, con
+00005b20: 6669 672c 202a 2a6b 7761 7267 7329 0a0a  fig, **kwargs)..
+00005b30: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00005b40: 726e 2028 692c 206f 7574 290a 0a20 2020  rn (i, out)..   
+00005b50: 2020 2020 2069 6620 6c65 6e28 696e 7075       if len(inpu
+00005b60: 7473 2920 3d3d 2031 3a0a 2020 2020 2020  ts) == 1:.      
+00005b70: 2020 2020 2020 7969 656c 6420 696e 766f        yield invo
+00005b80: 6b65 2830 2c20 696e 7075 7473 5b30 5d2c  ke(0, inputs[0],
+00005b90: 2063 6f6e 6669 6773 5b30 5d29 0a20 2020   configs[0]).   
+00005ba0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+00005bb0: 0a20 2020 2020 2020 2077 6974 6820 6765  .        with ge
+00005bc0: 745f 6578 6563 7574 6f72 5f66 6f72 5f63  t_executor_for_c
+00005bd0: 6f6e 6669 6728 636f 6e66 6967 735b 305d  onfig(configs[0]
+00005be0: 2920 6173 2065 7865 6375 746f 723a 0a20  ) as executor:. 
+00005bf0: 2020 2020 2020 2020 2020 2066 7574 7572             futur
+00005c00: 6573 203d 207b 0a20 2020 2020 2020 2020  es = {.         
+00005c10: 2020 2020 2020 2065 7865 6375 746f 722e         executor.
+00005c20: 7375 626d 6974 2869 6e76 6f6b 652c 2069  submit(invoke, i
+00005c30: 2c20 696e 7075 742c 2063 6f6e 6669 6729  , input, config)
+00005c40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005c50: 2066 6f72 2069 2c20 2869 6e70 7574 2c20   for i, (input, 
+00005c60: 636f 6e66 6967 2920 696e 2065 6e75 6d65  config) in enume
+00005c70: 7261 7465 287a 6970 2869 6e70 7574 732c  rate(zip(inputs,
+00005c80: 2063 6f6e 6669 6773 2929 0a20 2020 2020   configs)).     
+00005c90: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00005ca0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00005cb0: 2020 2020 2020 2020 2020 2077 6869 6c65             while
+00005cc0: 2066 7574 7572 6573 3a0a 2020 2020 2020   futures:.      
+00005cd0: 2020 2020 2020 2020 2020 2020 2020 646f                do
+00005ce0: 6e65 2c20 6675 7475 7265 7320 3d20 7761  ne, futures = wa
+00005cf0: 6974 2866 7574 7572 6573 2c20 7265 7475  it(futures, retu
+00005d00: 726e 5f77 6865 6e3d 4649 5253 545f 434f  rn_when=FIRST_CO
+00005d10: 4d50 4c45 5445 4429 0a20 2020 2020 2020  MPLETED).       
+00005d20: 2020 2020 2020 2020 2020 2020 2077 6869               whi
+00005d30: 6c65 2064 6f6e 653a 0a20 2020 2020 2020  le done:.       
+00005d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005d50: 2079 6965 6c64 2064 6f6e 652e 706f 7028   yield done.pop(
+00005d60: 292e 7265 7375 6c74 2829 0a20 2020 2020  ).result().     
+00005d70: 2020 2020 2020 2066 696e 616c 6c79 3a0a         finally:.
+00005d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005d90: 666f 7220 6675 7475 7265 2069 6e20 6675  for future in fu
+00005da0: 7475 7265 733a 0a20 2020 2020 2020 2020  tures:.         
+00005db0: 2020 2020 2020 2020 2020 2066 7574 7572             futur
+00005dc0: 652e 6361 6e63 656c 2829 0a0a 2020 2020  e.cancel()..    
+00005dd0: 6173 796e 6320 6465 6620 6162 6174 6368  async def abatch
+00005de0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00005df0: 2020 2020 2020 2020 696e 7075 7473 3a20          inputs: 
+00005e00: 4c69 7374 5b49 6e70 7574 5d2c 0a20 2020  List[Input],.   
+00005e10: 2020 2020 2063 6f6e 6669 673a 204f 7074       config: Opt
+00005e20: 696f 6e61 6c5b 556e 696f 6e5b 5275 6e6e  ional[Union[Runn
+00005e30: 6162 6c65 436f 6e66 6967 2c20 4c69 7374  ableConfig, List
+00005e40: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+00005e50: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
+00005e60: 2020 202a 2c0a 2020 2020 2020 2020 7265     *,.        re
+00005e70: 7475 726e 5f65 7863 6570 7469 6f6e 733a  turn_exceptions:
+00005e80: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+00005e90: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
+00005ea0: 204f 7074 696f 6e61 6c5b 416e 795d 2c0a   Optional[Any],.
+00005eb0: 2020 2020 2920 2d3e 204c 6973 745b 4f75      ) -> List[Ou
+00005ec0: 7470 7574 5d3a 0a20 2020 2020 2020 2022  tput]:.        "
+00005ed0: 2222 4465 6661 756c 7420 696d 706c 656d  ""Default implem
+00005ee0: 656e 7461 7469 6f6e 2072 756e 7320 6169  entation runs ai
+00005ef0: 6e76 6f6b 6520 696e 2070 6172 616c 6c65  nvoke in paralle
+00005f00: 6c20 7573 696e 6720 6173 796e 6369 6f2e  l using asyncio.
+00005f10: 6761 7468 6572 2e0a 0a20 2020 2020 2020  gather...       
+00005f20: 2054 6865 2064 6566 6175 6c74 2069 6d70   The default imp
+00005f30: 6c65 6d65 6e74 6174 696f 6e20 6f66 2062  lementation of b
+00005f40: 6174 6368 2077 6f72 6b73 2077 656c 6c20  atch works well 
+00005f50: 666f 7220 494f 2062 6f75 6e64 2072 756e  for IO bound run
+00005f60: 6e61 626c 6573 2e0a 0a20 2020 2020 2020  nables...       
+00005f70: 2053 7562 636c 6173 7365 7320 7368 6f75   Subclasses shou
+00005f80: 6c64 206f 7665 7272 6964 6520 7468 6973  ld override this
+00005f90: 206d 6574 686f 6420 6966 2074 6865 7920   method if they 
+00005fa0: 6361 6e20 6261 7463 6820 6d6f 7265 2065  can batch more e
+00005fb0: 6666 6963 6965 6e74 6c79 3b0a 2020 2020  fficiently;.    
+00005fc0: 2020 2020 652e 672e 2c20 6966 2074 6865      e.g., if the
+00005fd0: 2075 6e64 6572 6c79 696e 6720 7275 6e6e   underlying runn
+00005fe0: 6162 6c65 2075 7365 7320 616e 2041 5049  able uses an API
+00005ff0: 2077 6869 6368 2073 7570 706f 7274 7320   which supports 
+00006000: 6120 6261 7463 6820 6d6f 6465 2e0a 2020  a batch mode..  
+00006010: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00006020: 2020 6966 206e 6f74 2069 6e70 7574 733a    if not inputs:
+00006030: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00006040: 7572 6e20 5b5d 0a0a 2020 2020 2020 2020  urn []..        
+00006050: 636f 6e66 6967 7320 3d20 6765 745f 636f  configs = get_co
+00006060: 6e66 6967 5f6c 6973 7428 636f 6e66 6967  nfig_list(config
+00006070: 2c20 6c65 6e28 696e 7075 7473 2929 0a0a  , len(inputs))..
+00006080: 2020 2020 2020 2020 6173 796e 6320 6465          async de
+00006090: 6620 6169 6e76 6f6b 6528 0a20 2020 2020  f ainvoke(.     
+000060a0: 2020 2020 2020 2069 6e70 7574 3a20 496e         input: In
+000060b0: 7075 742c 2063 6f6e 6669 673a 2052 756e  put, config: Run
+000060c0: 6e61 626c 6543 6f6e 6669 670a 2020 2020  nableConfig.    
+000060d0: 2020 2020 2920 2d3e 2055 6e69 6f6e 5b4f      ) -> Union[O
+000060e0: 7574 7075 742c 2045 7863 6570 7469 6f6e  utput, Exception
+000060f0: 5d3a 0a20 2020 2020 2020 2020 2020 2069  ]:.            i
+00006100: 6620 7265 7475 726e 5f65 7863 6570 7469  f return_excepti
+00006110: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+00006120: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00006130: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00006140: 7475 726e 2061 7761 6974 2073 656c 662e  turn await self.
+00006150: 6169 6e76 6f6b 6528 696e 7075 742c 2063  ainvoke(input, c
+00006160: 6f6e 6669 672c 202a 2a6b 7761 7267 7329  onfig, **kwargs)
+00006170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006180: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+00006190: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
+000061a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000061b0: 726e 2065 0a20 2020 2020 2020 2020 2020  rn e.           
+000061c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000061d0: 2020 2020 2020 2072 6574 7572 6e20 6177         return aw
+000061e0: 6169 7420 7365 6c66 2e61 696e 766f 6b65  ait self.ainvoke
+000061f0: 2869 6e70 7574 2c20 636f 6e66 6967 2c20  (input, config, 
+00006200: 2a2a 6b77 6172 6773 290a 0a20 2020 2020  **kwargs)..     
+00006210: 2020 2063 6f72 6f73 203d 206d 6170 2861     coros = map(a
+00006220: 696e 766f 6b65 2c20 696e 7075 7473 2c20  invoke, inputs, 
+00006230: 636f 6e66 6967 7329 0a20 2020 2020 2020  configs).       
+00006240: 2072 6574 7572 6e20 6177 6169 7420 6761   return await ga
+00006250: 7468 6572 5f77 6974 685f 636f 6e63 7572  ther_with_concur
+00006260: 7265 6e63 7928 636f 6e66 6967 735b 305d  rency(configs[0]
+00006270: 2e67 6574 2822 6d61 785f 636f 6e63 7572  .get("max_concur
+00006280: 7265 6e63 7922 292c 202a 636f 726f 7329  rency"), *coros)
+00006290: 0a0a 2020 2020 406f 7665 726c 6f61 640a  ..    @overload.
+000062a0: 2020 2020 6465 6620 6162 6174 6368 5f61      def abatch_a
+000062b0: 735f 636f 6d70 6c65 7465 6428 0a20 2020  s_completed(.   
+000062c0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+000062d0: 2020 2069 6e70 7574 733a 204c 6973 745b     inputs: List[
+000062e0: 496e 7075 745d 2c0a 2020 2020 2020 2020  Input],.        
+000062f0: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
+00006300: 5b55 6e69 6f6e 5b52 756e 6e61 626c 6543  [Union[RunnableC
+00006310: 6f6e 6669 672c 204c 6973 745b 5275 6e6e  onfig, List[Runn
+00006320: 6162 6c65 436f 6e66 6967 5d5d 5d20 3d20  ableConfig]]] = 
+00006330: 4e6f 6e65 2c0a 2020 2020 2020 2020 2a2c  None,.        *,
+00006340: 0a20 2020 2020 2020 2072 6574 7572 6e5f  .        return_
+00006350: 6578 6365 7074 696f 6e73 3a20 4c69 7465  exceptions: Lite
+00006360: 7261 6c5b 4661 6c73 655d 203d 2046 616c  ral[False] = Fal
+00006370: 7365 2c0a 2020 2020 2020 2020 2a2a 6b77  se,.        **kw
+00006380: 6172 6773 3a20 4f70 7469 6f6e 616c 5b41  args: Optional[A
+00006390: 6e79 5d2c 0a20 2020 2029 202d 3e20 4173  ny],.    ) -> As
+000063a0: 796e 6349 7465 7261 746f 725b 5475 706c  yncIterator[Tupl
+000063b0: 655b 696e 742c 204f 7574 7075 745d 5d3a  e[int, Output]]:
+000063c0: 0a20 2020 2020 2020 202e 2e2e 0a0a 2020  .        .....  
+000063d0: 2020 406f 7665 726c 6f61 640a 2020 2020    @overload.    
+000063e0: 6465 6620 6162 6174 6368 5f61 735f 636f  def abatch_as_co
+000063f0: 6d70 6c65 7465 6428 0a20 2020 2020 2020  mpleted(.       
+00006400: 2073 656c 662c 0a20 2020 2020 2020 2069   self,.        i
+00006410: 6e70 7574 733a 204c 6973 745b 496e 7075  nputs: List[Inpu
+00006420: 745d 2c0a 2020 2020 2020 2020 636f 6e66  t],.        conf
+00006430: 6967 3a20 4f70 7469 6f6e 616c 5b55 6e69  ig: Optional[Uni
+00006440: 6f6e 5b52 756e 6e61 626c 6543 6f6e 6669  on[RunnableConfi
+00006450: 672c 204c 6973 745b 5275 6e6e 6162 6c65  g, List[Runnable
+00006460: 436f 6e66 6967 5d5d 5d20 3d20 4e6f 6e65  Config]]] = None
+00006470: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
+00006480: 2020 2020 2072 6574 7572 6e5f 6578 6365       return_exce
+00006490: 7074 696f 6e73 3a20 4c69 7465 7261 6c5b  ptions: Literal[
+000064a0: 5472 7565 5d2c 0a20 2020 2020 2020 202a  True],.        *
+000064b0: 2a6b 7761 7267 733a 204f 7074 696f 6e61  *kwargs: Optiona
+000064c0: 6c5b 416e 795d 2c0a 2020 2020 2920 2d3e  l[Any],.    ) ->
+000064d0: 2041 7379 6e63 4974 6572 6174 6f72 5b54   AsyncIterator[T
+000064e0: 7570 6c65 5b69 6e74 2c20 556e 696f 6e5b  uple[int, Union[
+000064f0: 4f75 7470 7574 2c20 4578 6365 7074 696f  Output, Exceptio
+00006500: 6e5d 5d5d 3a0a 2020 2020 2020 2020 2e2e  n]]]:.        ..
+00006510: 2e0a 0a20 2020 2061 7379 6e63 2064 6566  ...    async def
+00006520: 2061 6261 7463 685f 6173 5f63 6f6d 706c   abatch_as_compl
+00006530: 6574 6564 280a 2020 2020 2020 2020 7365  eted(.        se
+00006540: 6c66 2c0a 2020 2020 2020 2020 696e 7075  lf,.        inpu
+00006550: 7473 3a20 4c69 7374 5b49 6e70 7574 5d2c  ts: List[Input],
+00006560: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
+00006570: 204f 7074 696f 6e61 6c5b 556e 696f 6e5b   Optional[Union[
+00006580: 5275 6e6e 6162 6c65 436f 6e66 6967 2c20  RunnableConfig, 
+00006590: 4c69 7374 5b52 756e 6e61 626c 6543 6f6e  List[RunnableCon
+000065a0: 6669 675d 5d5d 203d 204e 6f6e 652c 0a20  fig]]] = None,. 
+000065b0: 2020 2020 2020 202a 2c0a 2020 2020 2020         *,.      
+000065c0: 2020 7265 7475 726e 5f65 7863 6570 7469    return_excepti
+000065d0: 6f6e 733a 2062 6f6f 6c20 3d20 4661 6c73  ons: bool = Fals
+000065e0: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
+000065f0: 7267 733a 204f 7074 696f 6e61 6c5b 416e  rgs: Optional[An
+00006600: 795d 2c0a 2020 2020 2920 2d3e 2041 7379  y],.    ) -> Asy
+00006610: 6e63 4974 6572 6174 6f72 5b54 7570 6c65  ncIterator[Tuple
+00006620: 5b69 6e74 2c20 556e 696f 6e5b 4f75 7470  [int, Union[Outp
+00006630: 7574 2c20 4578 6365 7074 696f 6e5d 5d5d  ut, Exception]]]
+00006640: 3a0a 2020 2020 2020 2020 2222 2252 756e  :.        """Run
+00006650: 2061 696e 766f 6b65 2069 6e20 7061 7261   ainvoke in para
+00006660: 6c6c 656c 206f 6e20 6120 6c69 7374 206f  llel on a list o
+00006670: 6620 696e 7075 7473 2c0a 2020 2020 2020  f inputs,.      
+00006680: 2020 7969 656c 6469 6e67 2072 6573 756c    yielding resul
+00006690: 7473 2061 7320 7468 6579 2063 6f6d 706c  ts as they compl
+000066a0: 6574 652e 2222 220a 0a20 2020 2020 2020  ete."""..       
+000066b0: 2069 6620 6e6f 7420 696e 7075 7473 3a0a   if not inputs:.
+000066c0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000066d0: 726e 0a0a 2020 2020 2020 2020 636f 6e66  rn..        conf
+000066e0: 6967 7320 3d20 6765 745f 636f 6e66 6967  igs = get_config
+000066f0: 5f6c 6973 7428 636f 6e66 6967 2c20 6c65  _list(config, le
+00006700: 6e28 696e 7075 7473 2929 0a0a 2020 2020  n(inputs))..    
+00006710: 2020 2020 6173 796e 6320 6465 6620 6169      async def ai
+00006720: 6e76 6f6b 6528 0a20 2020 2020 2020 2020  nvoke(.         
+00006730: 2020 2069 3a20 696e 742c 2069 6e70 7574     i: int, input
+00006740: 3a20 496e 7075 742c 2063 6f6e 6669 673a  : Input, config:
+00006750: 2052 756e 6e61 626c 6543 6f6e 6669 670a   RunnableConfig.
+00006760: 2020 2020 2020 2020 2920 2d3e 2054 7570          ) -> Tup
+00006770: 6c65 5b69 6e74 2c20 556e 696f 6e5b 4f75  le[int, Union[Ou
+00006780: 7470 7574 2c20 4578 6365 7074 696f 6e5d  tput, Exception]
+00006790: 5d3a 0a20 2020 2020 2020 2020 2020 2069  ]:.            i
+000067a0: 6620 7265 7475 726e 5f65 7863 6570 7469  f return_excepti
+000067b0: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+000067c0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+000067d0: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
+000067e0: 743a 2055 6e69 6f6e 5b4f 7574 7075 742c  t: Union[Output,
+000067f0: 2045 7863 6570 7469 6f6e 5d20 3d20 6177   Exception] = aw
+00006800: 6169 7420 7365 6c66 2e61 696e 766f 6b65  ait self.ainvoke
+00006810: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00006820: 2020 2020 2020 2020 2020 696e 7075 742c            input,
+00006830: 2063 6f6e 6669 672c 202a 2a6b 7761 7267   config, **kwarg
+00006840: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00006850: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00006860: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+00006870: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
+00006880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006890: 2020 206f 7574 203d 2065 0a20 2020 2020     out = e.     
+000068a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000068b0: 2020 2020 2020 2020 2020 2020 206f 7574               out
+000068c0: 203d 2061 7761 6974 2073 656c 662e 6169   = await self.ai
+000068d0: 6e76 6f6b 6528 696e 7075 742c 2063 6f6e  nvoke(input, con
+000068e0: 6669 672c 202a 2a6b 7761 7267 7329 0a0a  fig, **kwargs)..
+000068f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00006900: 726e 2028 692c 206f 7574 290a 0a20 2020  rn (i, out)..   
+00006910: 2020 2020 2063 6f72 6f73 203d 206d 6170       coros = map
+00006920: 2861 696e 766f 6b65 2c20 7261 6e67 6528  (ainvoke, range(
+00006930: 6c65 6e28 696e 7075 7473 2929 2c20 696e  len(inputs)), in
+00006940: 7075 7473 2c20 636f 6e66 6967 7329 0a0a  puts, configs)..
+00006950: 2020 2020 2020 2020 666f 7220 636f 726f          for coro
+00006960: 2069 6e20 6173 796e 6369 6f2e 6173 5f63   in asyncio.as_c
+00006970: 6f6d 706c 6574 6564 2863 6f72 6f73 293a  ompleted(coros):
+00006980: 0a20 2020 2020 2020 2020 2020 2079 6965  .            yie
+00006990: 6c64 2061 7761 6974 2063 6f72 6f0a 0a20  ld await coro.. 
+000069a0: 2020 2064 6566 2073 7472 6561 6d28 0a20     def stream(. 
+000069b0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+000069c0: 2020 2020 2069 6e70 7574 3a20 496e 7075       input: Inpu
+000069d0: 742c 0a20 2020 2020 2020 2063 6f6e 6669  t,.        confi
+000069e0: 673a 204f 7074 696f 6e61 6c5b 5275 6e6e  g: Optional[Runn
+000069f0: 6162 6c65 436f 6e66 6967 5d20 3d20 4e6f  ableConfig] = No
+00006a00: 6e65 2c0a 2020 2020 2020 2020 2a2a 6b77  ne,.        **kw
+00006a10: 6172 6773 3a20 4f70 7469 6f6e 616c 5b41  args: Optional[A
+00006a20: 6e79 5d2c 0a20 2020 2029 202d 3e20 4974  ny],.    ) -> It
+00006a30: 6572 6174 6f72 5b4f 7574 7075 745d 3a0a  erator[Output]:.
+00006a40: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00006a50: 2020 2020 4465 6661 756c 7420 696d 706c      Default impl
+00006a60: 656d 656e 7461 7469 6f6e 206f 6620 7374  ementation of st
+00006a70: 7265 616d 2c20 7768 6963 6820 6361 6c6c  ream, which call
+00006a80: 7320 696e 766f 6b65 2e0a 2020 2020 2020  s invoke..      
+00006a90: 2020 5375 6263 6c61 7373 6573 2073 686f    Subclasses sho
+00006aa0: 756c 6420 6f76 6572 7269 6465 2074 6869  uld override thi
+00006ab0: 7320 6d65 7468 6f64 2069 6620 7468 6579  s method if they
+00006ac0: 2073 7570 706f 7274 2073 7472 6561 6d69   support streami
+00006ad0: 6e67 206f 7574 7075 742e 0a20 2020 2020  ng output..     
+00006ae0: 2020 2022 2222 0a20 2020 2020 2020 2079     """.        y
+00006af0: 6965 6c64 2073 656c 662e 696e 766f 6b65  ield self.invoke
+00006b00: 2869 6e70 7574 2c20 636f 6e66 6967 2c20  (input, config, 
+00006b10: 2a2a 6b77 6172 6773 290a 0a20 2020 2061  **kwargs)..    a
+00006b20: 7379 6e63 2064 6566 2061 7374 7265 616d  sync def astream
+00006b30: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00006b40: 2020 2020 2020 2020 696e 7075 743a 2049          input: I
+00006b50: 6e70 7574 2c0a 2020 2020 2020 2020 636f  nput,.        co
+00006b60: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
+00006b70: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
+00006b80: 204e 6f6e 652c 0a20 2020 2020 2020 202a   None,.        *
+00006b90: 2a6b 7761 7267 733a 204f 7074 696f 6e61  *kwargs: Optiona
+00006ba0: 6c5b 416e 795d 2c0a 2020 2020 2920 2d3e  l[Any],.    ) ->
+00006bb0: 2041 7379 6e63 4974 6572 6174 6f72 5b4f   AsyncIterator[O
+00006bc0: 7574 7075 745d 3a0a 2020 2020 2020 2020  utput]:.        
+00006bd0: 2222 220a 2020 2020 2020 2020 4465 6661  """.        Defa
+00006be0: 756c 7420 696d 706c 656d 656e 7461 7469  ult implementati
+00006bf0: 6f6e 206f 6620 6173 7472 6561 6d2c 2077  on of astream, w
+00006c00: 6869 6368 2063 616c 6c73 2061 696e 766f  hich calls ainvo
+00006c10: 6b65 2e0a 2020 2020 2020 2020 5375 6263  ke..        Subc
+00006c20: 6c61 7373 6573 2073 686f 756c 6420 6f76  lasses should ov
+00006c30: 6572 7269 6465 2074 6869 7320 6d65 7468  erride this meth
+00006c40: 6f64 2069 6620 7468 6579 2073 7570 706f  od if they suppo
+00006c50: 7274 2073 7472 6561 6d69 6e67 206f 7574  rt streaming out
+00006c60: 7075 742e 0a20 2020 2020 2020 2022 2222  put..        """
+00006c70: 0a20 2020 2020 2020 2079 6965 6c64 2061  .        yield a
+00006c80: 7761 6974 2073 656c 662e 6169 6e76 6f6b  wait self.ainvok
+00006c90: 6528 696e 7075 742c 2063 6f6e 6669 672c  e(input, config,
+00006ca0: 202a 2a6b 7761 7267 7329 0a0a 2020 2020   **kwargs)..    
+00006cb0: 406f 7665 726c 6f61 640a 2020 2020 6465  @overload.    de
+00006cc0: 6620 6173 7472 6561 6d5f 6c6f 6728 0a20  f astream_log(. 
+00006cd0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+00006ce0: 2020 2020 2069 6e70 7574 3a20 416e 792c       input: Any,
+00006cf0: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
+00006d00: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
+00006d10: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
+00006d20: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
+00006d30: 2020 2020 2064 6966 663a 204c 6974 6572       diff: Liter
+00006d40: 616c 5b54 7275 655d 203d 2054 7275 652c  al[True] = True,
+00006d50: 0a20 2020 2020 2020 2077 6974 685f 7374  .        with_st
+00006d60: 7265 616d 6564 5f6f 7574 7075 745f 6c69  reamed_output_li
+00006d70: 7374 3a20 626f 6f6c 203d 2054 7275 652c  st: bool = True,
+00006d80: 0a20 2020 2020 2020 2069 6e63 6c75 6465  .        include
+00006d90: 5f6e 616d 6573 3a20 4f70 7469 6f6e 616c  _names: Optional
+00006da0: 5b53 6571 7565 6e63 655b 7374 725d 5d20  [Sequence[str]] 
+00006db0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00006dc0: 696e 636c 7564 655f 7479 7065 733a 204f  include_types: O
+00006dd0: 7074 696f 6e61 6c5b 5365 7175 656e 6365  ptional[Sequence
+00006de0: 5b73 7472 5d5d 203d 204e 6f6e 652c 0a20  [str]] = None,. 
+00006df0: 2020 2020 2020 2069 6e63 6c75 6465 5f74         include_t
+00006e00: 6167 733a 204f 7074 696f 6e61 6c5b 5365  ags: Optional[Se
+00006e10: 7175 656e 6365 5b73 7472 5d5d 203d 204e  quence[str]] = N
+00006e20: 6f6e 652c 0a20 2020 2020 2020 2065 7863  one,.        exc
+00006e30: 6c75 6465 5f6e 616d 6573 3a20 4f70 7469  lude_names: Opti
+00006e40: 6f6e 616c 5b53 6571 7565 6e63 655b 7374  onal[Sequence[st
+00006e50: 725d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  r]] = None,.    
+00006e60: 2020 2020 6578 636c 7564 655f 7479 7065      exclude_type
+00006e70: 733a 204f 7074 696f 6e61 6c5b 5365 7175  s: Optional[Sequ
+00006e80: 656e 6365 5b73 7472 5d5d 203d 204e 6f6e  ence[str]] = Non
+00006e90: 652c 0a20 2020 2020 2020 2065 7863 6c75  e,.        exclu
+00006ea0: 6465 5f74 6167 733a 204f 7074 696f 6e61  de_tags: Optiona
+00006eb0: 6c5b 5365 7175 656e 6365 5b73 7472 5d5d  l[Sequence[str]]
+00006ec0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00006ed0: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
+00006ee0: 2020 2020 2920 2d3e 2041 7379 6e63 4974      ) -> AsyncIt
+00006ef0: 6572 6174 6f72 5b52 756e 4c6f 6750 6174  erator[RunLogPat
+00006f00: 6368 5d3a 0a20 2020 2020 2020 202e 2e2e  ch]:.        ...
+00006f10: 0a0a 2020 2020 406f 7665 726c 6f61 640a  ..    @overload.
+00006f20: 2020 2020 6465 6620 6173 7472 6561 6d5f      def astream_
+00006f30: 6c6f 6728 0a20 2020 2020 2020 2073 656c  log(.        sel
+00006f40: 662c 0a20 2020 2020 2020 2069 6e70 7574  f,.        input
+00006f50: 3a20 416e 792c 0a20 2020 2020 2020 2063  : Any,.        c
+00006f60: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
+00006f70: 5275 6e6e 6162 6c65 436f 6e66 6967 5d20  RunnableConfig] 
+00006f80: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00006f90: 2a2c 0a20 2020 2020 2020 2064 6966 663a  *,.        diff:
+00006fa0: 204c 6974 6572 616c 5b46 616c 7365 5d2c   Literal[False],
+00006fb0: 0a20 2020 2020 2020 2077 6974 685f 7374  .        with_st
+00006fc0: 7265 616d 6564 5f6f 7574 7075 745f 6c69  reamed_output_li
+00006fd0: 7374 3a20 626f 6f6c 203d 2054 7275 652c  st: bool = True,
+00006fe0: 0a20 2020 2020 2020 2069 6e63 6c75 6465  .        include
+00006ff0: 5f6e 616d 6573 3a20 4f70 7469 6f6e 616c  _names: Optional
+00007000: 5b53 6571 7565 6e63 655b 7374 725d 5d20  [Sequence[str]] 
+00007010: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00007020: 696e 636c 7564 655f 7479 7065 733a 204f  include_types: O
+00007030: 7074 696f 6e61 6c5b 5365 7175 656e 6365  ptional[Sequence
+00007040: 5b73 7472 5d5d 203d 204e 6f6e 652c 0a20  [str]] = None,. 
+00007050: 2020 2020 2020 2069 6e63 6c75 6465 5f74         include_t
+00007060: 6167 733a 204f 7074 696f 6e61 6c5b 5365  ags: Optional[Se
+00007070: 7175 656e 6365 5b73 7472 5d5d 203d 204e  quence[str]] = N
+00007080: 6f6e 652c 0a20 2020 2020 2020 2065 7863  one,.        exc
+00007090: 6c75 6465 5f6e 616d 6573 3a20 4f70 7469  lude_names: Opti
+000070a0: 6f6e 616c 5b53 6571 7565 6e63 655b 7374  onal[Sequence[st
+000070b0: 725d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  r]] = None,.    
+000070c0: 2020 2020 6578 636c 7564 655f 7479 7065      exclude_type
+000070d0: 733a 204f 7074 696f 6e61 6c5b 5365 7175  s: Optional[Sequ
+000070e0: 656e 6365 5b73 7472 5d5d 203d 204e 6f6e  ence[str]] = Non
+000070f0: 652c 0a20 2020 2020 2020 2065 7863 6c75  e,.        exclu
+00007100: 6465 5f74 6167 733a 204f 7074 696f 6e61  de_tags: Optiona
+00007110: 6c5b 5365 7175 656e 6365 5b73 7472 5d5d  l[Sequence[str]]
+00007120: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00007130: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
+00007140: 2020 2020 2920 2d3e 2041 7379 6e63 4974      ) -> AsyncIt
+00007150: 6572 6174 6f72 5b52 756e 4c6f 675d 3a0a  erator[RunLog]:.
+00007160: 2020 2020 2020 2020 2e2e 2e0a 0a20 2020          .....   
+00007170: 2061 7379 6e63 2064 6566 2061 7374 7265   async def astre
+00007180: 616d 5f6c 6f67 280a 2020 2020 2020 2020  am_log(.        
+00007190: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
+000071a0: 7075 743a 2041 6e79 2c0a 2020 2020 2020  put: Any,.      
+000071b0: 2020 636f 6e66 6967 3a20 4f70 7469 6f6e    config: Option
+000071c0: 616c 5b52 756e 6e61 626c 6543 6f6e 6669  al[RunnableConfi
+000071d0: 675d 203d 204e 6f6e 652c 0a20 2020 2020  g] = None,.     
+000071e0: 2020 202a 2c0a 2020 2020 2020 2020 6469     *,.        di
+000071f0: 6666 3a20 626f 6f6c 203d 2054 7275 652c  ff: bool = True,
+00007200: 0a20 2020 2020 2020 2077 6974 685f 7374  .        with_st
+00007210: 7265 616d 6564 5f6f 7574 7075 745f 6c69  reamed_output_li
+00007220: 7374 3a20 626f 6f6c 203d 2054 7275 652c  st: bool = True,
+00007230: 0a20 2020 2020 2020 2069 6e63 6c75 6465  .        include
+00007240: 5f6e 616d 6573 3a20 4f70 7469 6f6e 616c  _names: Optional
+00007250: 5b53 6571 7565 6e63 655b 7374 725d 5d20  [Sequence[str]] 
+00007260: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00007270: 696e 636c 7564 655f 7479 7065 733a 204f  include_types: O
+00007280: 7074 696f 6e61 6c5b 5365 7175 656e 6365  ptional[Sequence
+00007290: 5b73 7472 5d5d 203d 204e 6f6e 652c 0a20  [str]] = None,. 
+000072a0: 2020 2020 2020 2069 6e63 6c75 6465 5f74         include_t
+000072b0: 6167 733a 204f 7074 696f 6e61 6c5b 5365  ags: Optional[Se
+000072c0: 7175 656e 6365 5b73 7472 5d5d 203d 204e  quence[str]] = N
+000072d0: 6f6e 652c 0a20 2020 2020 2020 2065 7863  one,.        exc
+000072e0: 6c75 6465 5f6e 616d 6573 3a20 4f70 7469  lude_names: Opti
+000072f0: 6f6e 616c 5b53 6571 7565 6e63 655b 7374  onal[Sequence[st
+00007300: 725d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  r]] = None,.    
+00007310: 2020 2020 6578 636c 7564 655f 7479 7065      exclude_type
+00007320: 733a 204f 7074 696f 6e61 6c5b 5365 7175  s: Optional[Sequ
+00007330: 656e 6365 5b73 7472 5d5d 203d 204e 6f6e  ence[str]] = Non
+00007340: 652c 0a20 2020 2020 2020 2065 7863 6c75  e,.        exclu
+00007350: 6465 5f74 6167 733a 204f 7074 696f 6e61  de_tags: Optiona
+00007360: 6c5b 5365 7175 656e 6365 5b73 7472 5d5d  l[Sequence[str]]
+00007370: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00007380: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
+00007390: 2020 2020 2920 2d3e 2055 6e69 6f6e 5b41      ) -> Union[A
+000073a0: 7379 6e63 4974 6572 6174 6f72 5b52 756e  syncIterator[Run
+000073b0: 4c6f 6750 6174 6368 5d2c 2041 7379 6e63  LogPatch], Async
+000073c0: 4974 6572 6174 6f72 5b52 756e 4c6f 675d  Iterator[RunLog]
+000073d0: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
+000073e0: 2020 2020 2020 2053 7472 6561 6d20 616c         Stream al
+000073f0: 6c20 6f75 7470 7574 2066 726f 6d20 6120  l output from a 
+00007400: 7275 6e6e 6162 6c65 2c20 6173 2072 6570  runnable, as rep
+00007410: 6f72 7465 6420 746f 2074 6865 2063 616c  orted to the cal
+00007420: 6c62 6163 6b20 7379 7374 656d 2e0a 2020  lback system..  
+00007430: 2020 2020 2020 5468 6973 2069 6e63 6c75        This inclu
+00007440: 6465 7320 616c 6c20 696e 6e65 7220 7275  des all inner ru
+00007450: 6e73 206f 6620 4c4c 4d73 2c20 5265 7472  ns of LLMs, Retr
+00007460: 6965 7665 7273 2c20 546f 6f6c 732c 2065  ievers, Tools, e
+00007470: 7463 2e0a 0a20 2020 2020 2020 204f 7574  tc...        Out
+00007480: 7075 7420 6973 2073 7472 6561 6d65 6420  put is streamed 
+00007490: 6173 204c 6f67 206f 626a 6563 7473 2c20  as Log objects, 
+000074a0: 7768 6963 6820 696e 636c 7564 6520 6120  which include a 
+000074b0: 6c69 7374 206f 660a 2020 2020 2020 2020  list of.        
+000074c0: 6a73 6f6e 7061 7463 6820 6f70 7320 7468  jsonpatch ops th
+000074d0: 6174 2064 6573 6372 6962 6520 686f 7720  at describe how 
+000074e0: 7468 6520 7374 6174 6520 6f66 2074 6865  the state of the
+000074f0: 2072 756e 2068 6173 2063 6861 6e67 6564   run has changed
+00007500: 2069 6e20 6561 6368 0a20 2020 2020 2020   in each.       
+00007510: 2073 7465 702c 2061 6e64 2074 6865 2066   step, and the f
+00007520: 696e 616c 2073 7461 7465 206f 6620 7468  inal state of th
+00007530: 6520 7275 6e2e 0a0a 2020 2020 2020 2020  e run...        
+00007540: 5468 6520 6a73 6f6e 7061 7463 6820 6f70  The jsonpatch op
+00007550: 7320 6361 6e20 6265 2061 7070 6c69 6564  s can be applied
+00007560: 2069 6e20 6f72 6465 7220 746f 2063 6f6e   in order to con
+00007570: 7374 7275 6374 2073 7461 7465 2e0a 0a20  struct state... 
+00007580: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
+00007590: 2020 2020 2020 2020 2069 6e70 7574 3a20           input: 
+000075a0: 5468 6520 696e 7075 7420 746f 2074 6865  The input to the
+000075b0: 2072 756e 6e61 626c 652e 0a20 2020 2020   runnable..     
+000075c0: 2020 2020 2020 2063 6f6e 6669 673a 2054         config: T
+000075d0: 6865 2063 6f6e 6669 6720 746f 2075 7365  he config to use
+000075e0: 2066 6f72 2074 6865 2072 756e 6e61 626c   for the runnabl
+000075f0: 652e 0a20 2020 2020 2020 2020 2020 2064  e..            d
+00007600: 6966 663a 2057 6865 7468 6572 2074 6f20  iff: Whether to 
+00007610: 7969 656c 6420 6469 6666 7320 6265 7477  yield diffs betw
+00007620: 6565 6e20 6561 6368 2073 7465 702c 206f  een each step, o
+00007630: 7220 7468 6520 6375 7272 656e 7420 7374  r the current st
+00007640: 6174 652e 0a20 2020 2020 2020 2020 2020  ate..           
+00007650: 2077 6974 685f 7374 7265 616d 6564 5f6f   with_streamed_o
+00007660: 7574 7075 745f 6c69 7374 3a20 5768 6574  utput_list: Whet
+00007670: 6865 7220 746f 2079 6965 6c64 2074 6865  her to yield the
+00007680: 2073 7472 6561 6d65 645f 6f75 7470 7574   streamed_output
+00007690: 206c 6973 742e 0a20 2020 2020 2020 2020   list..         
+000076a0: 2020 2069 6e63 6c75 6465 5f6e 616d 6573     include_names
+000076b0: 3a20 4f6e 6c79 2069 6e63 6c75 6465 206c  : Only include l
+000076c0: 6f67 7320 7769 7468 2074 6865 7365 206e  ogs with these n
+000076d0: 616d 6573 2e0a 2020 2020 2020 2020 2020  ames..          
+000076e0: 2020 696e 636c 7564 655f 7479 7065 733a    include_types:
+000076f0: 204f 6e6c 7920 696e 636c 7564 6520 6c6f   Only include lo
+00007700: 6773 2077 6974 6820 7468 6573 6520 7479  gs with these ty
+00007710: 7065 732e 0a20 2020 2020 2020 2020 2020  pes..           
+00007720: 2069 6e63 6c75 6465 5f74 6167 733a 204f   include_tags: O
+00007730: 6e6c 7920 696e 636c 7564 6520 6c6f 6773  nly include logs
+00007740: 2077 6974 6820 7468 6573 6520 7461 6773   with these tags
+00007750: 2e0a 2020 2020 2020 2020 2020 2020 6578  ..            ex
+00007760: 636c 7564 655f 6e61 6d65 733a 2045 7863  clude_names: Exc
+00007770: 6c75 6465 206c 6f67 7320 7769 7468 2074  lude logs with t
+00007780: 6865 7365 206e 616d 6573 2e0a 2020 2020  hese names..    
+00007790: 2020 2020 2020 2020 6578 636c 7564 655f          exclude_
+000077a0: 7479 7065 733a 2045 7863 6c75 6465 206c  types: Exclude l
+000077b0: 6f67 7320 7769 7468 2074 6865 7365 2074  ogs with these t
+000077c0: 7970 6573 2e0a 2020 2020 2020 2020 2020  ypes..          
+000077d0: 2020 6578 636c 7564 655f 7461 6773 3a20    exclude_tags: 
+000077e0: 4578 636c 7564 6520 6c6f 6773 2077 6974  Exclude logs wit
+000077f0: 6820 7468 6573 6520 7461 6773 2e0a 2020  h these tags..  
+00007800: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00007810: 2020 6672 6f6d 206c 616e 6763 6861 696e    from langchain
+00007820: 5f63 6f72 652e 7472 6163 6572 732e 6c6f  _core.tracers.lo
+00007830: 675f 7374 7265 616d 2069 6d70 6f72 7420  g_stream import 
+00007840: 280a 2020 2020 2020 2020 2020 2020 4c6f  (.            Lo
+00007850: 6753 7472 6561 6d43 616c 6c62 6163 6b48  gStreamCallbackH
+00007860: 616e 646c 6572 2c0a 2020 2020 2020 2020  andler,.        
+00007870: 2020 2020 5f61 7374 7265 616d 5f6c 6f67      _astream_log
+00007880: 5f69 6d70 6c65 6d65 6e74 6174 696f 6e2c  _implementation,
+00007890: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+000078a0: 2020 2020 7374 7265 616d 203d 204c 6f67      stream = Log
+000078b0: 5374 7265 616d 4361 6c6c 6261 636b 4861  StreamCallbackHa
+000078c0: 6e64 6c65 7228 0a20 2020 2020 2020 2020  ndler(.         
+000078d0: 2020 2061 7574 6f5f 636c 6f73 653d 4661     auto_close=Fa
+000078e0: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
+000078f0: 2069 6e63 6c75 6465 5f6e 616d 6573 3d69   include_names=i
+00007900: 6e63 6c75 6465 5f6e 616d 6573 2c0a 2020  nclude_names,.  
+00007910: 2020 2020 2020 2020 2020 696e 636c 7564            includ
+00007920: 655f 7479 7065 733d 696e 636c 7564 655f  e_types=include_
+00007930: 7479 7065 732c 0a20 2020 2020 2020 2020  types,.         
+00007940: 2020 2069 6e63 6c75 6465 5f74 6167 733d     include_tags=
+00007950: 696e 636c 7564 655f 7461 6773 2c0a 2020  include_tags,.  
+00007960: 2020 2020 2020 2020 2020 6578 636c 7564            exclud
+00007970: 655f 6e61 6d65 733d 6578 636c 7564 655f  e_names=exclude_
+00007980: 6e61 6d65 732c 0a20 2020 2020 2020 2020  names,.         
+00007990: 2020 2065 7863 6c75 6465 5f74 7970 6573     exclude_types
+000079a0: 3d65 7863 6c75 6465 5f74 7970 6573 2c0a  =exclude_types,.
+000079b0: 2020 2020 2020 2020 2020 2020 6578 636c              excl
+000079c0: 7564 655f 7461 6773 3d65 7863 6c75 6465  ude_tags=exclude
+000079d0: 5f74 6167 732c 0a20 2020 2020 2020 2020  _tags,.         
+000079e0: 2020 205f 7363 6865 6d61 5f66 6f72 6d61     _schema_forma
+000079f0: 743d 226f 7269 6769 6e61 6c22 2c0a 2020  t="original",.  
+00007a00: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00007a10: 2023 204d 7970 7920 6973 6e27 7420 7265   # Mypy isn't re
+00007a20: 736f 6c76 696e 6720 7468 6520 6f76 6572  solving the over
+00007a30: 6c6f 6164 7320 6865 7265 0a20 2020 2020  loads here.     
+00007a40: 2020 2023 204c 696b 656c 7920 616e 2069     # Likely an i
+00007a50: 7373 7565 2062 2f63 2060 7365 6c66 6020  ssue b/c `self` 
+00007a60: 6973 2062 6569 6e67 2070 6173 7365 6420  is being passed 
+00007a70: 7468 726f 7567 680a 2020 2020 2020 2020  through.        
+00007a80: 2320 616e 6420 6974 2773 2063 616e 2774  # and it's can't
+00007a90: 206d 6170 2069 7420 746f 2052 756e 6e61   map it to Runna
+00007aa0: 626c 655b 496e 7075 742c 4f75 7470 7574  ble[Input,Output
+00007ab0: 5d3f 0a20 2020 2020 2020 2061 7379 6e63  ]?.        async
+00007ac0: 2066 6f72 2069 7465 6d20 696e 205f 6173   for item in _as
+00007ad0: 7472 6561 6d5f 6c6f 675f 696d 706c 656d  tream_log_implem
+00007ae0: 656e 7461 7469 6f6e 2820 2023 2074 7970  entation(  # typ
+00007af0: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
+00007b00: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00007b10: 2020 2020 2020 2020 696e 7075 742c 0a20          input,. 
+00007b20: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
+00007b30: 672c 0a20 2020 2020 2020 2020 2020 2064  g,.            d
+00007b40: 6966 663d 6469 6666 2c0a 2020 2020 2020  iff=diff,.      
+00007b50: 2020 2020 2020 7374 7265 616d 3d73 7472        stream=str
+00007b60: 6561 6d2c 0a20 2020 2020 2020 2020 2020  eam,.           
+00007b70: 2077 6974 685f 7374 7265 616d 6564 5f6f   with_streamed_o
+00007b80: 7574 7075 745f 6c69 7374 3d77 6974 685f  utput_list=with_
+00007b90: 7374 7265 616d 6564 5f6f 7574 7075 745f  streamed_output_
+00007ba0: 6c69 7374 2c0a 2020 2020 2020 2020 2020  list,.          
+00007bb0: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
+00007bc0: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+00007bd0: 2020 2079 6965 6c64 2069 7465 6d0a 0a20     yield item.. 
+00007be0: 2020 2040 6265 7461 5f64 6563 6f72 6174     @beta_decorat
+00007bf0: 6f72 2e62 6574 6128 6d65 7373 6167 653d  or.beta(message=
+00007c00: 2254 6869 7320 4150 4920 6973 2069 6e20  "This API is in 
+00007c10: 6265 7461 2061 6e64 206d 6179 2063 6861  beta and may cha
+00007c20: 6e67 6520 696e 2074 6865 2066 7574 7572  nge in the futur
+00007c30: 652e 2229 0a20 2020 2061 7379 6e63 2064  e.").    async d
+00007c40: 6566 2061 7374 7265 616d 5f65 7665 6e74  ef astream_event
+00007c50: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
+00007c60: 0a20 2020 2020 2020 2069 6e70 7574 3a20  .        input: 
+00007c70: 416e 792c 0a20 2020 2020 2020 2063 6f6e  Any,.        con
+00007c80: 6669 673a 204f 7074 696f 6e61 6c5b 5275  fig: Optional[Ru
+00007c90: 6e6e 6162 6c65 436f 6e66 6967 5d20 3d20  nnableConfig] = 
+00007ca0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2a2c  None,.        *,
+00007cb0: 0a20 2020 2020 2020 2076 6572 7369 6f6e  .        version
+00007cc0: 3a20 4c69 7465 7261 6c5b 2276 3122 5d2c  : Literal["v1"],
+00007cd0: 0a20 2020 2020 2020 2069 6e63 6c75 6465  .        include
+00007ce0: 5f6e 616d 6573 3a20 4f70 7469 6f6e 616c  _names: Optional
+00007cf0: 5b53 6571 7565 6e63 655b 7374 725d 5d20  [Sequence[str]] 
+00007d00: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00007d10: 696e 636c 7564 655f 7479 7065 733a 204f  include_types: O
+00007d20: 7074 696f 6e61 6c5b 5365 7175 656e 6365  ptional[Sequence
+00007d30: 5b73 7472 5d5d 203d 204e 6f6e 652c 0a20  [str]] = None,. 
+00007d40: 2020 2020 2020 2069 6e63 6c75 6465 5f74         include_t
+00007d50: 6167 733a 204f 7074 696f 6e61 6c5b 5365  ags: Optional[Se
+00007d60: 7175 656e 6365 5b73 7472 5d5d 203d 204e  quence[str]] = N
+00007d70: 6f6e 652c 0a20 2020 2020 2020 2065 7863  one,.        exc
+00007d80: 6c75 6465 5f6e 616d 6573 3a20 4f70 7469  lude_names: Opti
+00007d90: 6f6e 616c 5b53 6571 7565 6e63 655b 7374  onal[Sequence[st
+00007da0: 725d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  r]] = None,.    
+00007db0: 2020 2020 6578 636c 7564 655f 7479 7065      exclude_type
+00007dc0: 733a 204f 7074 696f 6e61 6c5b 5365 7175  s: Optional[Sequ
+00007dd0: 656e 6365 5b73 7472 5d5d 203d 204e 6f6e  ence[str]] = Non
+00007de0: 652c 0a20 2020 2020 2020 2065 7863 6c75  e,.        exclu
+00007df0: 6465 5f74 6167 733a 204f 7074 696f 6e61  de_tags: Optiona
+00007e00: 6c5b 5365 7175 656e 6365 5b73 7472 5d5d  l[Sequence[str]]
+00007e10: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00007e20: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
+00007e30: 2020 2020 2920 2d3e 2041 7379 6e63 4974      ) -> AsyncIt
+00007e40: 6572 6174 6f72 5b53 7472 6561 6d45 7665  erator[StreamEve
+00007e50: 6e74 5d3a 0a20 2020 2020 2020 2022 2222  nt]:.        """
+00007e60: 4765 6e65 7261 7465 2061 2073 7472 6561  Generate a strea
+00007e70: 6d20 6f66 2065 7665 6e74 732e 0a0a 2020  m of events...  
+00007e80: 2020 2020 2020 5573 6520 746f 2063 7265        Use to cre
+00007e90: 6174 6520 616e 2069 7465 7261 746f 7220  ate an iterator 
+00007ea0: 6f76 6572 2053 7472 6561 6d45 7665 6e74  over StreamEvent
+00007eb0: 7320 7468 6174 2070 726f 7669 6465 2072  s that provide r
+00007ec0: 6561 6c2d 7469 6d65 2069 6e66 6f72 6d61  eal-time informa
+00007ed0: 7469 6f6e 0a20 2020 2020 2020 2061 626f  tion.        abo
+00007ee0: 7574 2074 6865 2070 726f 6772 6573 7320  ut the progress 
+00007ef0: 6f66 2074 6865 2072 756e 6e61 626c 652c  of the runnable,
+00007f00: 2069 6e63 6c75 6469 6e67 2053 7472 6561   including Strea
+00007f10: 6d45 7665 6e74 7320 6672 6f6d 2069 6e74  mEvents from int
+00007f20: 6572 6d65 6469 6174 650a 2020 2020 2020  ermediate.      
+00007f30: 2020 7265 7375 6c74 732e 0a0a 2020 2020    results...    
+00007f40: 2020 2020 4120 5374 7265 616d 4576 656e      A StreamEven
+00007f50: 7420 6973 2061 2064 6963 7469 6f6e 6172  t is a dictionar
+00007f60: 7920 7769 7468 2074 6865 2066 6f6c 6c6f  y with the follo
+00007f70: 7769 6e67 2073 6368 656d 613a 0a0a 2020  wing schema:..  
+00007f80: 2020 2020 2020 2d20 6060 6576 656e 7460        - ``event`
+00007f90: 603a 202a 2a73 7472 2a2a 202d 2045 7665  `: **str** - Eve
+00007fa0: 6e74 206e 616d 6573 2061 7265 206f 6620  nt names are of 
+00007fb0: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
+00007fc0: 666f 726d 6174 3a20 6f6e 5f5b 7275 6e6e  format: on_[runn
+00007fd0: 6162 6c65 5f74 7970 655d 5f28 7374 6172  able_type]_(star
+00007fe0: 747c 7374 7265 616d 7c65 6e64 292e 0a20  t|stream|end).. 
+00007ff0: 2020 2020 2020 202d 2060 606e 616d 6560         - ``name`
+00008000: 603a 202a 2a73 7472 2a2a 202d 2054 6865  `: **str** - The
+00008010: 206e 616d 6520 6f66 2074 6865 2072 756e   name of the run
+00008020: 6e61 626c 6520 7468 6174 2067 656e 6572  nable that gener
+00008030: 6174 6564 2074 6865 2065 7665 6e74 2e0a  ated the event..
+00008040: 2020 2020 2020 2020 2d20 6060 7275 6e5f          - ``run_
+00008050: 6964 6060 3a20 2a2a 7374 722a 2a20 2d20  id``: **str** - 
+00008060: 7261 6e64 6f6d 6c79 2067 656e 6572 6174  randomly generat
+00008070: 6564 2049 4420 6173 736f 6369 6174 6564  ed ID associated
+00008080: 2077 6974 6820 7468 6520 6769 7665 6e20   with the given 
+00008090: 6578 6563 7574 696f 6e20 6f66 0a20 2020  execution of.   
+000080a0: 2020 2020 2020 2020 2074 6865 2072 756e           the run
+000080b0: 6e61 626c 6520 7468 6174 2065 6d69 7474  nable that emitt
+000080c0: 6564 2074 6865 2065 7665 6e74 2e0a 2020  ed the event..  
+000080d0: 2020 2020 2020 2020 2020 4120 6368 696c            A chil
+000080e0: 6420 7275 6e6e 6162 6c65 2074 6861 7420  d runnable that 
+000080f0: 6765 7473 2069 6e76 6f6b 6564 2061 7320  gets invoked as 
+00008100: 7061 7274 206f 6620 7468 6520 6578 6563  part of the exec
+00008110: 7574 696f 6e20 6f66 2061 0a20 2020 2020  ution of a.     
+00008120: 2020 2020 2020 2070 6172 656e 7420 7275         parent ru
+00008130: 6e6e 6162 6c65 2069 7320 6173 7369 676e  nnable is assign
+00008140: 6564 2069 7473 206f 776e 2075 6e69 7175  ed its own uniqu
+00008150: 6520 4944 2e0a 2020 2020 2020 2020 2d20  e ID..        - 
+00008160: 6060 7461 6773 6060 3a20 2a2a 4f70 7469  ``tags``: **Opti
+00008170: 6f6e 616c 5b4c 6973 745b 7374 725d 5d2a  onal[List[str]]*
+00008180: 2a20 2d20 5468 6520 7461 6773 206f 6620  * - The tags of 
+00008190: 7468 6520 7275 6e6e 6162 6c65 2074 6861  the runnable tha
+000081a0: 7420 6765 6e65 7261 7465 640a 2020 2020  t generated.    
+000081b0: 2020 2020 2020 2020 7468 6520 6576 656e          the even
+000081c0: 742e 0a20 2020 2020 2020 202d 2060 606d  t..        - ``m
+000081d0: 6574 6164 6174 6160 603a 202a 2a4f 7074  etadata``: **Opt
+000081e0: 696f 6e61 6c5b 4469 6374 5b73 7472 2c20  ional[Dict[str, 
+000081f0: 416e 795d 5d2a 2a20 2d20 5468 6520 6d65  Any]]** - The me
+00008200: 7461 6461 7461 206f 6620 7468 6520 7275  tadata of the ru
+00008210: 6e6e 6162 6c65 0a20 2020 2020 2020 2020  nnable.         
+00008220: 2020 2074 6861 7420 6765 6e65 7261 7465     that generate
+00008230: 6420 7468 6520 6576 656e 742e 0a20 2020  d the event..   
+00008240: 2020 2020 202d 2060 6064 6174 6160 603a       - ``data``:
+00008250: 202a 2a44 6963 745b 7374 722c 2041 6e79   **Dict[str, Any
+00008260: 5d2a 2a0a 0a0a 2020 2020 2020 2020 4265  ]**...        Be
+00008270: 6c6f 7720 6973 2061 2074 6162 6c65 2074  low is a table t
+00008280: 6861 7420 696c 6c75 7374 7261 7465 7320  hat illustrates 
+00008290: 736f 6d65 2065 7665 6e73 2074 6861 7420  some evens that 
+000082a0: 6d69 6768 7420 6265 2065 6d69 7474 6564  might be emitted
+000082b0: 2062 7920 7661 7269 6f75 730a 2020 2020   by various.    
+000082c0: 2020 2020 6368 6169 6e73 2e20 4d65 7461      chains. Meta
+000082d0: 6461 7461 2066 6965 6c64 7320 6861 7665  data fields have
+000082e0: 2062 6565 6e20 6f6d 6974 7465 6420 6672   been omitted fr
+000082f0: 6f6d 2074 6865 2074 6162 6c65 2066 6f72  om the table for
+00008300: 2062 7265 7669 7479 2e0a 2020 2020 2020   brevity..      
+00008310: 2020 4368 6169 6e20 6465 6669 6e69 7469    Chain definiti
+00008320: 6f6e 7320 6861 7665 2062 6565 6e20 696e  ons have been in
+00008330: 636c 7564 6564 2061 6674 6572 2074 6865  cluded after the
+00008340: 2074 6162 6c65 2e0a 0a20 2020 2020 2020   table...       
+00008350: 202b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   +--------------
+00008360: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00008370: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+00008380: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008390: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+000083a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000083b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000083c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+000083d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000083e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000083f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+00008400: 0a20 2020 2020 2020 207c 2065 7665 6e74  .        | event
+00008410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008420: 7c20 6e61 6d65 2020 2020 2020 2020 2020  | name          
+00008430: 2020 207c 2063 6875 6e6b 2020 2020 2020     | chunk      
+00008440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008450: 2020 2020 207c 2069 6e70 7574 2020 2020       | input    
+00008460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008480: 2020 2020 207c 206f 7574 7075 7420 2020       | output   
+00008490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000084a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000084b0: 2020 2020 2020 207c 0a20 2020 2020 2020         |.       
+000084c0: 202b 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   +==============
+000084d0: 3d3d 3d3d 3d3d 3d3d 2b3d 3d3d 3d3d 3d3d  ========+=======
+000084e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d2b 3d3d 3d3d  ===========+====
+000084f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00008500: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d2b 3d3d  =============+==
+00008510: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00008520: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00008530: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d2b 3d3d  =============+==
+00008540: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00008550: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00008560: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d2b  ===============+
+00008570: 0a20 2020 2020 2020 207c 206f 6e5f 6368  .        | on_ch
+00008580: 6174 5f6d 6f64 656c 5f73 7461 7274 2020  at_model_start  
+00008590: 7c20 5b6d 6f64 656c 206e 616d 655d 2020  | [model name]  
+000085a0: 2020 207c 2020 2020 2020 2020 2020 2020     |            
+000085b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000085c0: 2020 2020 207c 207b 226d 6573 7361 6765       | {"message
+000085d0: 7322 3a20 5b5b 5379 7374 656d 4d65 7373  s": [[SystemMess
+000085e0: 6167 652c 2048 756d 616e 4d65 7373 6167  age, HumanMessag
+000085f0: 655d 5d7d 207c 2020 2020 2020 2020 2020  e]]} |          
+00008600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008620: 2020 2020 2020 207c 0a20 2020 2020 2020         |.       
+00008630: 202b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   +--------------
+00008640: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00008650: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+00008660: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008670: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00008680: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008690: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000086a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+000086b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000086c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000086d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+000086e0: 0a20 2020 2020 2020 207c 206f 6e5f 6368  .        | on_ch
+000086f0: 6174 5f6d 6f64 656c 5f73 7472 6561 6d20  at_model_stream 
+00008700: 7c20 5b6d 6f64 656c 206e 616d 655d 2020  | [model name]  
+00008710: 2020 207c 2041 494d 6573 7361 6765 4368     | AIMessageCh
+00008720: 756e 6b28 636f 6e74 656e 743d 2268 656c  unk(content="hel
+00008730: 6c6f 2229 207c 2020 2020 2020 2020 2020  lo") |          
+00008740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008760: 2020 2020 207c 2020 2020 2020 2020 2020       |          
+00008770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008790: 2020 2020 2020 207c 0a20 2020 2020 2020         |.       
+000087a0: 202b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   +--------------
+000087b0: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+000087c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+000087d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000087e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+000087f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008800: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008810: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00008820: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008830: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008840: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+00008850: 0a20 2020 2020 2020 207c 206f 6e5f 6368  .        | on_ch
+00008860: 6174 5f6d 6f64 656c 5f65 6e64 2020 2020  at_model_end    
+00008870: 7c20 5b6d 6f64 656c 206e 616d 655d 2020  | [model name]  
+00008880: 2020 207c 2020 2020 2020 2020 2020 2020     |            
+00008890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000088a0: 2020 2020 207c 207b 226d 6573 7361 6765       | {"message
+000088b0: 7322 3a20 5b5b 5379 7374 656d 4d65 7373  s": [[SystemMess
+000088c0: 6167 652c 2048 756d 616e 4d65 7373 6167  age, HumanMessag
+000088d0: 655d 5d7d 207c 207b 2267 656e 6572 6174  e]]} | {"generat
+000088e0: 696f 6e73 223a 205b 2e2e 2e5d 2c20 226c  ions": [...], "l
+000088f0: 6c6d 5f6f 7574 7075 7422 3a20 4e6f 6e65  lm_output": None
+00008900: 2c20 2e2e 2e7d 207c 0a20 2020 2020 2020  , ...} |.       
+00008910: 202b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   +--------------
+00008920: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00008930: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+00008940: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008950: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00008960: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008970: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008980: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00008990: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000089a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000089b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+000089c0: 0a20 2020 2020 2020 207c 206f 6e5f 6c6c  .        | on_ll
+000089d0: 6d5f 7374 6172 7420 2020 2020 2020 2020  m_start         
+000089e0: 7c20 5b6d 6f64 656c 206e 616d 655d 2020  | [model name]  
+000089f0: 2020 207c 2020 2020 2020 2020 2020 2020     |            
+00008a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a10: 2020 2020 207c 207b 2769 6e70 7574 273a       | {'input':
+00008a20: 2027 6865 6c6c 6f27 7d20 2020 2020 2020   'hello'}       
+00008a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a40: 2020 2020 207c 2020 2020 2020 2020 2020       |          
+00008a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a70: 2020 2020 2020 207c 0a20 2020 2020 2020         |.       
+00008a80: 202b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   +--------------
+00008a90: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00008aa0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+00008ab0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008ac0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00008ad0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008ae0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008af0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00008b00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008b10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008b20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+00008b30: 0a20 2020 2020 2020 207c 206f 6e5f 6c6c  .        | on_ll
+00008b40: 6d5f 7374 7265 616d 2020 2020 2020 2020  m_stream        
+00008b50: 7c20 5b6d 6f64 656c 206e 616d 655d 2020  | [model name]  
+00008b60: 2020 207c 2027 4865 6c6c 6f27 2020 2020     | 'Hello'    
+00008b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008b80: 2020 2020 207c 2020 2020 2020 2020 2020       |          
+00008b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008bb0: 2020 2020 207c 2020 2020 2020 2020 2020       |          
+00008bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008be0: 2020 2020 2020 207c 0a20 2020 2020 2020         |.       
+00008bf0: 202b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   +--------------
+00008c00: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00008c10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+00008c20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008c30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00008c40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008c50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008c60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00008c70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008c80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008c90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+00008ca0: 0a20 2020 2020 2020 207c 206f 6e5f 6c6c  .        | on_ll
+00008cb0: 6d5f 656e 6420 2020 2020 2020 2020 2020  m_end           
+00008cc0: 7c20 5b6d 6f64 656c 206e 616d 655d 2020  | [model name]  
+00008cd0: 2020 207c 2020 2020 2020 2020 2020 2020     |            
+00008ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008cf0: 2020 2020 207c 2027 4865 6c6c 6f20 6875       | 'Hello hu
+00008d00: 6d61 6e21 2720 2020 2020 2020 2020 2020  man!'           
+00008d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008d20: 2020 2020 207c 2020 2020 2020 2020 2020       |          
+00008d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008d50: 2020 2020 2020 207c 0a20 2020 2020 2020         |.       
+00008d60: 202b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   +--------------
+00008d70: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00008d80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+00008d90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008da0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00008db0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008dc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008dd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00008de0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008df0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008e00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+00008e10: 0a20 2020 2020 2020 207c 206f 6e5f 6368  .        | on_ch
+00008e20: 6169 6e5f 7374 6172 7420 2020 2020 2020  ain_start       
+00008e30: 7c20 666f 726d 6174 5f64 6f63 7320 2020  | format_docs   
+00008e40: 2020 207c 2020 2020 2020 2020 2020 2020     |            
+00008e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008e60: 2020 2020 207c 2020 2020 2020 2020 2020       |          
+00008e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008e90: 2020 2020 207c 2020 2020 2020 2020 2020       |          
+00008ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008ec0: 2020 2020 2020 207c 0a20 2020 2020 2020         |.       
+00008ed0: 202b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   +--------------
+00008ee0: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00008ef0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+00008f00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008f10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00008f20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008f30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008f40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00008f50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008f60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008f70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+00008f80: 0a20 2020 2020 2020 207c 206f 6e5f 6368  .        | on_ch
+00008f90: 6169 6e5f 7374 7265 616d 2020 2020 2020  ain_stream      
+00008fa0: 7c20 666f 726d 6174 5f64 6f63 7320 2020  | format_docs   
+00008fb0: 2020 207c 2022 6865 6c6c 6f20 776f 726c     | "hello worl
+00008fc0: 6421 2c20 676f 6f64 6279 6520 776f 726c  d!, goodbye worl
+00008fd0: 6421 2220 207c 2020 2020 2020 2020 2020  d!"  |          
+00008fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009000: 2020 2020 207c 2020 2020 2020 2020 2020       |          
+00009010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009030: 2020 2020 2020 207c 0a20 2020 2020 2020         |.       
+00009040: 202b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   +--------------
+00009050: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00009060: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+00009070: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009080: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00009090: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000090a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000090b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+000090c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000090d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000090e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+000090f0: 0a20 2020 2020 2020 207c 206f 6e5f 6368  .        | on_ch
+00009100: 6169 6e5f 656e 6420 2020 2020 2020 2020  ain_end         
+00009110: 7c20 666f 726d 6174 5f64 6f63 7320 2020  | format_docs   
+00009120: 2020 207c 2020 2020 2020 2020 2020 2020     |            
+00009130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009140: 2020 2020 207c 205b 446f 6375 6d65 6e74       | [Document
+00009150: 282e 2e2e 295d 2020 2020 2020 2020 2020  (...)]          
+00009160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009170: 2020 2020 207c 2022 6865 6c6c 6f20 776f       | "hello wo
+00009180: 726c 6421 2c20 676f 6f64 6279 6520 776f  rld!, goodbye wo
+00009190: 726c 6421 2220 2020 2020 2020 2020 2020  rld!"           
+000091a0: 2020 2020 2020 207c 0a20 2020 2020 2020         |.       
+000091b0: 202b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   +--------------
+000091c0: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+000091d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+000091e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000091f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00009200: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009210: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009220: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00009230: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009240: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009250: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+00009260: 0a20 2020 2020 2020 207c 206f 6e5f 746f  .        | on_to
+00009270: 6f6c 5f73 7461 7274 2020 2020 2020 2020  ol_start        
+00009280: 7c20 736f 6d65 5f74 6f6f 6c20 2020 2020  | some_tool     
+00009290: 2020 207c 2020 2020 2020 2020 2020 2020     |            
+000092a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000092b0: 2020 2020 207c 207b 2278 223a 2031 2c20       | {"x": 1, 
+000092c0: 2279 223a 2022 3222 7d20 2020 2020 2020  "y": "2"}       
+000092d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000092e0: 2020 2020 207c 2020 2020 2020 2020 2020       |          
+000092f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009310: 2020 2020 2020 207c 0a20 2020 2020 2020         |.       
+00009320: 202b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   +--------------
+00009330: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00009340: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+00009350: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009360: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00009370: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009380: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009390: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+000093a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000093b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000093c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+000093d0: 0a20 2020 2020 2020 207c 206f 6e5f 746f  .        | on_to
+000093e0: 6f6c 5f73 7472 6561 6d20 2020 2020 2020  ol_stream       
+000093f0: 7c20 736f 6d65 5f74 6f6f 6c20 2020 2020  | some_tool     
+00009400: 2020 207c 207b 2278 223a 2031 2c20 2279     | {"x": 1, "y
+00009410: 223a 2022 3222 7d20 2020 2020 2020 2020  ": "2"}         
+00009420: 2020 2020 207c 2020 2020 2020 2020 2020       |          
+00009430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009450: 2020 2020 207c 2020 2020 2020 2020 2020       |          
+00009460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009480: 2020 2020 2020 207c 0a20 2020 2020 2020         |.       
+00009490: 202b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   +--------------
+000094a0: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+000094b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+000094c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000094d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+000094e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000094f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009500: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00009510: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009520: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009530: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+00009540: 0a20 2020 2020 2020 207c 206f 6e5f 746f  .        | on_to
+00009550: 6f6c 5f65 6e64 2020 2020 2020 2020 2020  ol_end          
+00009560: 7c20 736f 6d65 5f74 6f6f 6c20 2020 2020  | some_tool     
+00009570: 2020 207c 2020 2020 2020 2020 2020 2020     |            
+00009580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009590: 2020 2020 207c 2020 2020 2020 2020 2020       |          
+000095a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000095b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000095c0: 2020 2020 207c 207b 2278 223a 2031 2c20       | {"x": 1, 
+000095d0: 2279 223a 2022 3222 7d20 2020 2020 2020  "y": "2"}       
+000095e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000095f0: 2020 2020 2020 207c 0a20 2020 2020 2020         |.       
+00009600: 202b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   +--------------
+00009610: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00009620: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+00009630: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009640: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00009650: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009660: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009670: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00009680: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009690: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000096a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+000096b0: 0a20 2020 2020 2020 207c 206f 6e5f 7265  .        | on_re
+000096c0: 7472 6965 7665 725f 7374 6172 7420 2020  triever_start   
+000096d0: 7c20 5b72 6574 7269 6576 6572 206e 616d  | [retriever nam
+000096e0: 655d 207c 2020 2020 2020 2020 2020 2020  e] |            
+000096f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009700: 2020 2020 207c 207b 2271 7565 7279 223a       | {"query":
+00009710: 2022 6865 6c6c 6f22 7d20 2020 2020 2020   "hello"}       
+00009720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009730: 2020 2020 207c 2020 2020 2020 2020 2020       |          
+00009740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009760: 2020 2020 2020 207c 0a20 2020 2020 2020         |.       
+00009770: 202b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   +--------------
+00009780: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00009790: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+000097a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000097b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+000097c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000097d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000097e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+000097f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009800: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009810: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+00009820: 0a20 2020 2020 2020 207c 206f 6e5f 7265  .        | on_re
+00009830: 7472 6965 7665 725f 6368 756e 6b20 2020  triever_chunk   
+00009840: 7c20 5b72 6574 7269 6576 6572 206e 616d  | [retriever nam
+00009850: 655d 207c 207b 646f 6375 6d65 6e74 733a  e] | {documents:
+00009860: 205b 2e2e 2e5d 7d20 2020 2020 2020 2020   [...]}         
+00009870: 2020 2020 207c 2020 2020 2020 2020 2020       |          
+00009880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000098a0: 2020 2020 207c 2020 2020 2020 2020 2020       |          
+000098b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000098c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000098d0: 2020 2020 2020 207c 0a20 2020 2020 2020         |.       
+000098e0: 202b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   +--------------
+000098f0: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00009900: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+00009910: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009920: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00009930: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009940: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009950: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00009960: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009970: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009980: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+00009990: 0a20 2020 2020 2020 207c 206f 6e5f 7265  .        | on_re
+000099a0: 7472 6965 7665 725f 656e 6420 2020 2020  triever_end     
+000099b0: 7c20 5b72 6574 7269 6576 6572 206e 616d  | [retriever nam
+000099c0: 655d 207c 2020 2020 2020 2020 2020 2020  e] |            
+000099d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000099e0: 2020 2020 207c 207b 2271 7565 7279 223a       | {"query":
+000099f0: 2022 6865 6c6c 6f22 7d20 2020 2020 2020   "hello"}       
+00009a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a10: 2020 2020 207c 207b 646f 6375 6d65 6e74       | {document
+00009a20: 733a 205b 2e2e 2e5d 7d20 2020 2020 2020  s: [...]}       
+00009a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a40: 2020 2020 2020 207c 0a20 2020 2020 2020         |.       
+00009a50: 202b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   +--------------
+00009a60: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00009a70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+00009a80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009a90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00009aa0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009ab0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009ac0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00009ad0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009ae0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009af0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+00009b00: 0a20 2020 2020 2020 207c 206f 6e5f 7072  .        | on_pr
+00009b10: 6f6d 7074 5f73 7461 7274 2020 2020 2020  ompt_start      
+00009b20: 7c20 5b74 656d 706c 6174 655f 6e61 6d65  | [template_name
+00009b30: 5d20 207c 2020 2020 2020 2020 2020 2020  ]  |            
+00009b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009b50: 2020 2020 207c 207b 2271 7565 7374 696f       | {"questio
+00009b60: 6e22 3a20 2268 656c 6c6f 227d 2020 2020  n": "hello"}    
+00009b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009b80: 2020 2020 207c 2020 2020 2020 2020 2020       |          
+00009b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009bb0: 2020 2020 2020 207c 0a20 2020 2020 2020         |.       
+00009bc0: 202b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   +--------------
+00009bd0: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00009be0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+00009bf0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009c00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00009c10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009c20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009c30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00009c40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009c50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009c60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+00009c70: 0a20 2020 2020 2020 207c 206f 6e5f 7072  .        | on_pr
+00009c80: 6f6d 7074 5f65 6e64 2020 2020 2020 2020  ompt_end        
+00009c90: 7c20 5b74 656d 706c 6174 655f 6e61 6d65  | [template_name
+00009ca0: 5d20 207c 2020 2020 2020 2020 2020 2020  ]  |            
+00009cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009cc0: 2020 2020 207c 207b 2271 7565 7374 696f       | {"questio
+00009cd0: 6e22 3a20 2268 656c 6c6f 227d 2020 2020  n": "hello"}    
+00009ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009cf0: 2020 2020 207c 2043 6861 7450 726f 6d70       | ChatPromp
+00009d00: 7456 616c 7565 286d 6573 7361 6765 733a  tValue(messages:
+00009d10: 205b 5379 7374 656d 4d65 7373 6167 652c   [SystemMessage,
+00009d20: 202e 2e2e 5d29 207c 0a20 2020 2020 2020   ...]) |.       
+00009d30: 202b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   +--------------
+00009d40: 2d2d 2d2d 2d2d 2d2d 2b2d 2d2d 2d2d 2d2d  --------+-------
+00009d50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
+00009d60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009d70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00009d80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009d90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009da0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d  -------------+--
+00009db0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009dc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009dd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+00009de0: 0a0a 2020 2020 2020 2020 4865 7265 2061  ..        Here a
+00009df0: 7265 2064 6563 6c61 7261 7469 6f6e 7320  re declarations 
+00009e00: 6173 736f 6369 6174 6564 2077 6974 6820  associated with 
+00009e10: 7468 6520 6576 656e 7473 2073 686f 776e  the events shown
+00009e20: 2061 626f 7665 3a0a 0a20 2020 2020 2020   above:..       
+00009e30: 2060 666f 726d 6174 5f64 6f63 7360 3a0a   `format_docs`:.
+00009e40: 0a20 2020 2020 2020 202e 2e20 636f 6465  .        .. code
+00009e50: 2d62 6c6f 636b 3a3a 2070 7974 686f 6e0a  -block:: python.
+00009e60: 0a20 2020 2020 2020 2020 2020 2064 6566  .            def
+00009e70: 2066 6f72 6d61 745f 646f 6373 2864 6f63   format_docs(doc
+00009e80: 733a 204c 6973 745b 446f 6375 6d65 6e74  s: List[Document
+00009e90: 5d29 202d 3e20 7374 723a 0a20 2020 2020  ]) -> str:.     
+00009ea0: 2020 2020 2020 2020 2020 2027 2727 466f             '''Fo
+00009eb0: 726d 6174 2074 6865 2064 6f63 732e 2727  rmat the docs.''
+00009ec0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00009ed0: 2020 7265 7475 726e 2022 2c20 222e 6a6f    return ", ".jo
+00009ee0: 696e 285b 646f 632e 7061 6765 5f63 6f6e  in([doc.page_con
+00009ef0: 7465 6e74 2066 6f72 2064 6f63 2069 6e20  tent for doc in 
+00009f00: 646f 6373 5d29 0a0a 2020 2020 2020 2020  docs])..        
+00009f10: 2020 2020 666f 726d 6174 5f64 6f63 7320      format_docs 
+00009f20: 3d20 5275 6e6e 6162 6c65 4c61 6d62 6461  = RunnableLambda
+00009f30: 2866 6f72 6d61 745f 646f 6373 290a 0a20  (format_docs).. 
+00009f40: 2020 2020 2020 2060 736f 6d65 5f74 6f6f         `some_too
+00009f50: 6c60 3a0a 0a20 2020 2020 2020 202e 2e20  l`:..        .. 
+00009f60: 636f 6465 2d62 6c6f 636b 3a3a 2070 7974  code-block:: pyt
+00009f70: 686f 6e0a 0a20 2020 2020 2020 2020 2020  hon..           
+00009f80: 2040 746f 6f6c 0a20 2020 2020 2020 2020   @tool.         
+00009f90: 2020 2064 6566 2073 6f6d 655f 746f 6f6c     def some_tool
+00009fa0: 2878 3a20 696e 742c 2079 3a20 7374 7229  (x: int, y: str)
+00009fb0: 202d 3e20 6469 6374 3a0a 2020 2020 2020   -> dict:.      
+00009fc0: 2020 2020 2020 2020 2020 2727 2753 6f6d            '''Som
+00009fd0: 655f 746f 6f6c 2e27 2727 0a20 2020 2020  e_tool.'''.     
+00009fe0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00009ff0: 6e20 7b22 7822 3a20 782c 2022 7922 3a20  n {"x": x, "y": 
+0000a000: 797d 0a0a 2020 2020 2020 2020 6070 726f  y}..        `pro
+0000a010: 6d70 7460 3a0a 0a20 2020 2020 2020 202e  mpt`:..        .
+0000a020: 2e20 636f 6465 2d62 6c6f 636b 3a3a 2070  . code-block:: p
+0000a030: 7974 686f 6e0a 0a20 2020 2020 2020 2020  ython..         
+0000a040: 2020 2074 656d 706c 6174 6520 3d20 4368     template = Ch
+0000a050: 6174 5072 6f6d 7074 5465 6d70 6c61 7465  atPromptTemplate
+0000a060: 2e66 726f 6d5f 6d65 7373 6167 6573 280a  .from_messages(.
+0000a070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a080: 5b28 2273 7973 7465 6d22 2c20 2259 6f75  [("system", "You
+0000a090: 2061 7265 2043 6174 2041 6765 6e74 2030   are Cat Agent 0
+0000a0a0: 3037 2229 2c20 2822 6875 6d61 6e22 2c20  07"), ("human", 
+0000a0b0: 227b 7175 6573 7469 6f6e 7d22 295d 0a20  "{question}")]. 
+0000a0c0: 2020 2020 2020 2020 2020 2029 2e77 6974             ).wit
+0000a0d0: 685f 636f 6e66 6967 287b 2272 756e 5f6e  h_config({"run_n
+0000a0e0: 616d 6522 3a20 226d 795f 7465 6d70 6c61  ame": "my_templa
+0000a0f0: 7465 222c 2022 7461 6773 223a 205b 226d  te", "tags": ["m
+0000a100: 795f 7465 6d70 6c61 7465 225d 7d29 0a0a  y_template"]})..
+0000a110: 0a20 2020 2020 2020 2045 7861 6d70 6c65  .        Example
+0000a120: 3a0a 0a20 2020 2020 2020 202e 2e20 636f  :..        .. co
+0000a130: 6465 2d62 6c6f 636b 3a3a 2070 7974 686f  de-block:: pytho
+0000a140: 6e0a 0a20 2020 2020 2020 2020 2020 2066  n..            f
+0000a150: 726f 6d20 6c61 6e67 6368 6169 6e5f 636f  rom langchain_co
+0000a160: 7265 2e72 756e 6e61 626c 6573 2069 6d70  re.runnables imp
+0000a170: 6f72 7420 5275 6e6e 6162 6c65 4c61 6d62  ort RunnableLamb
+0000a180: 6461 0a0a 2020 2020 2020 2020 2020 2020  da..            
+0000a190: 6173 796e 6320 6465 6620 7265 7665 7273  async def revers
+0000a1a0: 6528 733a 2073 7472 2920 2d3e 2073 7472  e(s: str) -> str
+0000a1b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a1c0: 2020 7265 7475 726e 2073 5b3a 3a2d 315d    return s[::-1]
+0000a1d0: 0a0a 2020 2020 2020 2020 2020 2020 6368  ..            ch
+0000a1e0: 6169 6e20 3d20 5275 6e6e 6162 6c65 4c61  ain = RunnableLa
+0000a1f0: 6d62 6461 2866 756e 633d 7265 7665 7273  mbda(func=revers
+0000a200: 6529 0a0a 2020 2020 2020 2020 2020 2020  e)..            
+0000a210: 6576 656e 7473 203d 205b 0a20 2020 2020  events = [.     
+0000a220: 2020 2020 2020 2020 2020 2065 7665 6e74             event
+0000a230: 2061 7379 6e63 2066 6f72 2065 7665 6e74   async for event
+0000a240: 2069 6e20 6368 6169 6e2e 6173 7472 6561   in chain.astrea
+0000a250: 6d5f 6576 656e 7473 2822 6865 6c6c 6f22  m_events("hello"
+0000a260: 2c20 7665 7273 696f 6e3d 2276 3122 290a  , version="v1").
+0000a270: 2020 2020 2020 2020 2020 2020 5d0a 0a20              ].. 
+0000a280: 2020 2020 2020 2020 2020 2023 2077 696c             # wil
+0000a290: 6c20 7072 6f64 7563 6520 7468 6520 666f  l produce the fo
+0000a2a0: 6c6c 6f77 696e 6720 6576 656e 7473 2028  llowing events (
+0000a2b0: 7275 6e5f 6964 2068 6173 2062 6565 6e20  run_id has been 
+0000a2c0: 6f6d 6974 7465 6420 666f 7220 6272 6576  omitted for brev
+0000a2d0: 6974 7929 3a0a 2020 2020 2020 2020 2020  ity):.          
+0000a2e0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+0000a2f0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0000a300: 2020 2020 2020 2020 2020 2264 6174 6122            "data"
+0000a310: 3a20 7b22 696e 7075 7422 3a20 2268 656c  : {"input": "hel
+0000a320: 6c6f 227d 2c0a 2020 2020 2020 2020 2020  lo"},.          
+0000a330: 2020 2020 2020 2020 2020 2265 7665 6e74            "event
+0000a340: 223a 2022 6f6e 5f63 6861 696e 5f73 7461  ": "on_chain_sta
+0000a350: 7274 222c 0a20 2020 2020 2020 2020 2020  rt",.           
+0000a360: 2020 2020 2020 2020 2022 6d65 7461 6461           "metada
+0000a370: 7461 223a 207b 7d2c 0a20 2020 2020 2020  ta": {},.       
+0000a380: 2020 2020 2020 2020 2020 2020 2022 6e61               "na
+0000a390: 6d65 223a 2022 7265 7665 7273 6522 2c0a  me": "reverse",.
+0000a3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a3b0: 2020 2020 2274 6167 7322 3a20 5b5d 2c0a      "tags": [],.
+0000a3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a3d0: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+0000a3e0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0000a3f0: 2020 2020 2020 2020 2022 6461 7461 223a           "data":
+0000a400: 207b 2263 6875 6e6b 223a 2022 6f6c 6c65   {"chunk": "olle
+0000a410: 6822 7d2c 0a20 2020 2020 2020 2020 2020  h"},.           
+0000a420: 2020 2020 2020 2020 2022 6576 656e 7422           "event"
+0000a430: 3a20 226f 6e5f 6368 6169 6e5f 7374 7265  : "on_chain_stre
+0000a440: 616d 222c 0a20 2020 2020 2020 2020 2020  am",.           
+0000a450: 2020 2020 2020 2020 2022 6d65 7461 6461           "metada
+0000a460: 7461 223a 207b 7d2c 0a20 2020 2020 2020  ta": {},.       
+0000a470: 2020 2020 2020 2020 2020 2020 2022 6e61               "na
+0000a480: 6d65 223a 2022 7265 7665 7273 6522 2c0a  me": "reverse",.
+0000a490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a4a0: 2020 2020 2274 6167 7322 3a20 5b5d 2c0a      "tags": [],.
+0000a4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a4c0: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+0000a4d0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0000a4e0: 2020 2020 2020 2020 2022 6461 7461 223a           "data":
+0000a4f0: 207b 226f 7574 7075 7422 3a20 226f 6c6c   {"output": "oll
+0000a500: 6568 227d 2c0a 2020 2020 2020 2020 2020  eh"},.          
+0000a510: 2020 2020 2020 2020 2020 2265 7665 6e74            "event
+0000a520: 223a 2022 6f6e 5f63 6861 696e 5f65 6e64  ": "on_chain_end
+0000a530: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0000a540: 2020 2020 2020 2022 6d65 7461 6461 7461         "metadata
+0000a550: 223a 207b 7d2c 0a20 2020 2020 2020 2020  ": {},.         
+0000a560: 2020 2020 2020 2020 2020 2022 6e61 6d65             "name
+0000a570: 223a 2022 7265 7665 7273 6522 2c0a 2020  ": "reverse",.  
+0000a580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a590: 2020 2274 6167 7322 3a20 5b5d 2c0a 2020    "tags": [],.  
+0000a5a0: 2020 2020 2020 2020 2020 2020 2020 7d2c                },
+0000a5b0: 0a20 2020 2020 2020 2020 2020 205d 0a0a  .            ]..
+0000a5c0: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
+0000a5d0: 2020 2020 2020 2020 2020 696e 7075 743a            input:
+0000a5e0: 2054 6865 2069 6e70 7574 2074 6f20 7468   The input to th
+0000a5f0: 6520 7275 6e6e 6162 6c65 2e0a 2020 2020  e runnable..    
+0000a600: 2020 2020 2020 2020 636f 6e66 6967 3a20          config: 
+0000a610: 5468 6520 636f 6e66 6967 2074 6f20 7573  The config to us
+0000a620: 6520 666f 7220 7468 6520 7275 6e6e 6162  e for the runnab
+0000a630: 6c65 2e0a 2020 2020 2020 2020 2020 2020  le..            
+0000a640: 7665 7273 696f 6e3a 2054 6865 2076 6572  version: The ver
+0000a650: 7369 6f6e 206f 6620 7468 6520 7363 6865  sion of the sche
+0000a660: 6d61 2074 6f20 7573 652e 0a20 2020 2020  ma to use..     
+0000a670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a680: 4375 7272 656e 746c 7920 6f6e 6c79 2076  Currently only v
+0000a690: 6572 7369 6f6e 2031 2069 7320 6176 6169  ersion 1 is avai
+0000a6a0: 6c61 626c 652e 0a20 2020 2020 2020 2020  lable..         
+0000a6b0: 2020 2020 2020 2020 2020 2020 4e6f 2064              No d
+0000a6c0: 6566 6175 6c74 2077 696c 6c20 6265 2061  efault will be a
+0000a6d0: 7373 6967 6e65 6420 756e 7469 6c20 7468  ssigned until th
+0000a6e0: 6520 4150 4920 6973 2073 7461 6269 6c69  e API is stabili
+0000a6f0: 7a65 642e 0a20 2020 2020 2020 2020 2020  zed..           
+0000a700: 2069 6e63 6c75 6465 5f6e 616d 6573 3a20   include_names: 
+0000a710: 4f6e 6c79 2069 6e63 6c75 6465 2065 7665  Only include eve
+0000a720: 6e74 7320 6672 6f6d 2072 756e 6e61 626c  nts from runnabl
+0000a730: 6573 2077 6974 6820 6d61 7463 6869 6e67  es with matching
+0000a740: 206e 616d 6573 2e0a 2020 2020 2020 2020   names..        
+0000a750: 2020 2020 696e 636c 7564 655f 7479 7065      include_type
+0000a760: 733a 204f 6e6c 7920 696e 636c 7564 6520  s: Only include 
+0000a770: 6576 656e 7473 2066 726f 6d20 7275 6e6e  events from runn
+0000a780: 6162 6c65 7320 7769 7468 206d 6174 6368  ables with match
+0000a790: 696e 6720 7479 7065 732e 0a20 2020 2020  ing types..     
+0000a7a0: 2020 2020 2020 2069 6e63 6c75 6465 5f74         include_t
+0000a7b0: 6167 733a 204f 6e6c 7920 696e 636c 7564  ags: Only includ
+0000a7c0: 6520 6576 656e 7473 2066 726f 6d20 7275  e events from ru
+0000a7d0: 6e6e 6162 6c65 7320 7769 7468 206d 6174  nnables with mat
+0000a7e0: 6368 696e 6720 7461 6773 2e0a 2020 2020  ching tags..    
+0000a7f0: 2020 2020 2020 2020 6578 636c 7564 655f          exclude_
+0000a800: 6e61 6d65 733a 2045 7863 6c75 6465 2065  names: Exclude e
+0000a810: 7665 6e74 7320 6672 6f6d 2072 756e 6e61  vents from runna
+0000a820: 626c 6573 2077 6974 6820 6d61 7463 6869  bles with matchi
+0000a830: 6e67 206e 616d 6573 2e0a 2020 2020 2020  ng names..      
+0000a840: 2020 2020 2020 6578 636c 7564 655f 7479        exclude_ty
+0000a850: 7065 733a 2045 7863 6c75 6465 2065 7665  pes: Exclude eve
+0000a860: 6e74 7320 6672 6f6d 2072 756e 6e61 626c  nts from runnabl
+0000a870: 6573 2077 6974 6820 6d61 7463 6869 6e67  es with matching
+0000a880: 2074 7970 6573 2e0a 2020 2020 2020 2020   types..        
+0000a890: 2020 2020 6578 636c 7564 655f 7461 6773      exclude_tags
+0000a8a0: 3a20 4578 636c 7564 6520 6576 656e 7473  : Exclude events
+0000a8b0: 2066 726f 6d20 7275 6e6e 6162 6c65 7320   from runnables 
+0000a8c0: 7769 7468 206d 6174 6368 696e 6720 7461  with matching ta
+0000a8d0: 6773 2e0a 2020 2020 2020 2020 2020 2020  gs..            
+0000a8e0: 6b77 6172 6773 3a20 4164 6469 7469 6f6e  kwargs: Addition
+0000a8f0: 616c 206b 6579 776f 7264 2061 7267 756d  al keyword argum
+0000a900: 656e 7473 2074 6f20 7061 7373 2074 6f20  ents to pass to 
+0000a910: 7468 6520 7275 6e6e 6162 6c65 2e0a 2020  the runnable..  
+0000a920: 2020 2020 2020 2020 2020 2020 2020 5468                Th
+0000a930: 6573 6520 7769 6c6c 2062 6520 7061 7373  ese will be pass
+0000a940: 6564 2074 6f20 6173 7472 6561 6d5f 6c6f  ed to astream_lo
+0000a950: 6720 6173 2074 6869 7320 696d 706c 656d  g as this implem
+0000a960: 656e 7461 7469 6f6e 0a20 2020 2020 2020  entation.       
+0000a970: 2020 2020 2020 2020 206f 6620 6173 7472           of astr
+0000a980: 6561 6d5f 6576 656e 7473 2069 7320 6275  eam_events is bu
+0000a990: 696c 7420 6f6e 2074 6f70 206f 6620 6173  ilt on top of as
+0000a9a0: 7472 6561 6d5f 6c6f 672e 0a0a 2020 2020  tream_log...    
+0000a9b0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+0000a9c0: 2020 2020 2020 2020 2041 6e20 6173 796e           An asyn
+0000a9d0: 6320 7374 7265 616d 206f 6620 5374 7265  c stream of Stre
+0000a9e0: 616d 4576 656e 7473 2e0a 2020 2020 2020  amEvents..      
+0000a9f0: 2020 2222 2220 2023 206e 6f71 613a 2045    """  # noqa: E
+0000aa00: 3530 310a 2020 2020 2020 2020 6966 2076  501.        if v
+0000aa10: 6572 7369 6f6e 2021 3d20 2276 3122 3a0a  ersion != "v1":.
+0000aa20: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000aa30: 6520 4e6f 7449 6d70 6c65 6d65 6e74 6564  e NotImplemented
+0000aa40: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+0000aa50: 2020 2020 2020 2027 4f6e 6c79 2076 6572         'Only ver
+0000aa60: 7369 6f6e 2022 7631 2220 6f66 2074 6865  sion "v1" of the
+0000aa70: 2073 6368 656d 6120 6973 2063 7572 7265   schema is curre
+0000aa80: 6e74 6c79 2073 7570 706f 7274 6564 2e27  ntly supported.'
+0000aa90: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+0000aaa0: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
+0000aab0: 6763 6861 696e 5f63 6f72 652e 7275 6e6e  gchain_core.runn
+0000aac0: 6162 6c65 732e 7574 696c 7320 696d 706f  ables.utils impo
+0000aad0: 7274 2028 0a20 2020 2020 2020 2020 2020  rt (.           
+0000aae0: 205f 526f 6f74 4576 656e 7446 696c 7465   _RootEventFilte
+0000aaf0: 722c 0a20 2020 2020 2020 2029 0a20 2020  r,.        ).   
+0000ab00: 2020 2020 2066 726f 6d20 6c61 6e67 6368       from langch
+0000ab10: 6169 6e5f 636f 7265 2e74 7261 6365 7273  ain_core.tracers
+0000ab20: 2e6c 6f67 5f73 7472 6561 6d20 696d 706f  .log_stream impo
+0000ab30: 7274 2028 0a20 2020 2020 2020 2020 2020  rt (.           
+0000ab40: 204c 6f67 5374 7265 616d 4361 6c6c 6261   LogStreamCallba
+0000ab50: 636b 4861 6e64 6c65 722c 0a20 2020 2020  ckHandler,.     
+0000ab60: 2020 2020 2020 2052 756e 4c6f 672c 0a20         RunLog,. 
+0000ab70: 2020 2020 2020 2020 2020 205f 6173 7472             _astr
+0000ab80: 6561 6d5f 6c6f 675f 696d 706c 656d 656e  eam_log_implemen
+0000ab90: 7461 7469 6f6e 2c0a 2020 2020 2020 2020  tation,.        
+0000aba0: 290a 0a20 2020 2020 2020 2073 7472 6561  )..        strea
+0000abb0: 6d20 3d20 4c6f 6753 7472 6561 6d43 616c  m = LogStreamCal
+0000abc0: 6c62 6163 6b48 616e 646c 6572 280a 2020  lbackHandler(.  
+0000abd0: 2020 2020 2020 2020 2020 6175 746f 5f63            auto_c
+0000abe0: 6c6f 7365 3d46 616c 7365 2c0a 2020 2020  lose=False,.    
+0000abf0: 2020 2020 2020 2020 696e 636c 7564 655f          include_
+0000ac00: 6e61 6d65 733d 696e 636c 7564 655f 6e61  names=include_na
+0000ac10: 6d65 732c 0a20 2020 2020 2020 2020 2020  mes,.           
+0000ac20: 2069 6e63 6c75 6465 5f74 7970 6573 3d69   include_types=i
+0000ac30: 6e63 6c75 6465 5f74 7970 6573 2c0a 2020  nclude_types,.  
+0000ac40: 2020 2020 2020 2020 2020 696e 636c 7564            includ
+0000ac50: 655f 7461 6773 3d69 6e63 6c75 6465 5f74  e_tags=include_t
+0000ac60: 6167 732c 0a20 2020 2020 2020 2020 2020  ags,.           
+0000ac70: 2065 7863 6c75 6465 5f6e 616d 6573 3d65   exclude_names=e
+0000ac80: 7863 6c75 6465 5f6e 616d 6573 2c0a 2020  xclude_names,.  
+0000ac90: 2020 2020 2020 2020 2020 6578 636c 7564            exclud
+0000aca0: 655f 7479 7065 733d 6578 636c 7564 655f  e_types=exclude_
+0000acb0: 7479 7065 732c 0a20 2020 2020 2020 2020  types,.         
+0000acc0: 2020 2065 7863 6c75 6465 5f74 6167 733d     exclude_tags=
+0000acd0: 6578 636c 7564 655f 7461 6773 2c0a 2020  exclude_tags,.  
+0000ace0: 2020 2020 2020 2020 2020 5f73 6368 656d            _schem
+0000acf0: 615f 666f 726d 6174 3d22 7374 7265 616d  a_format="stream
+0000ad00: 696e 675f 6576 656e 7473 222c 0a20 2020  ing_events",.   
+0000ad10: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0000ad20: 7275 6e5f 6c6f 6720 3d20 5275 6e4c 6f67  run_log = RunLog
+0000ad30: 2873 7461 7465 3d4e 6f6e 6529 2020 2320  (state=None)  # 
+0000ad40: 7479 7065 3a20 6967 6e6f 7265 5b61 7267  type: ignore[arg
+0000ad50: 2d74 7970 655d 0a20 2020 2020 2020 2065  -type].        e
+0000ad60: 6e63 6f75 6e74 6572 6564 5f73 7461 7274  ncountered_start
+0000ad70: 5f65 7665 6e74 203d 2046 616c 7365 0a0a  _event = False..
+0000ad80: 2020 2020 2020 2020 5f72 6f6f 745f 6576          _root_ev
+0000ad90: 656e 745f 6669 6c74 6572 203d 205f 526f  ent_filter = _Ro
+0000ada0: 6f74 4576 656e 7446 696c 7465 7228 0a20  otEventFilter(. 
+0000adb0: 2020 2020 2020 2020 2020 2069 6e63 6c75             inclu
+0000adc0: 6465 5f6e 616d 6573 3d69 6e63 6c75 6465  de_names=include
+0000add0: 5f6e 616d 6573 2c0a 2020 2020 2020 2020  _names,.        
+0000ade0: 2020 2020 696e 636c 7564 655f 7479 7065      include_type
+0000adf0: 733d 696e 636c 7564 655f 7479 7065 732c  s=include_types,
+0000ae00: 0a20 2020 2020 2020 2020 2020 2069 6e63  .            inc
+0000ae10: 6c75 6465 5f74 6167 733d 696e 636c 7564  lude_tags=includ
+0000ae20: 655f 7461 6773 2c0a 2020 2020 2020 2020  e_tags,.        
+0000ae30: 2020 2020 6578 636c 7564 655f 6e61 6d65      exclude_name
+0000ae40: 733d 6578 636c 7564 655f 6e61 6d65 732c  s=exclude_names,
+0000ae50: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+0000ae60: 6c75 6465 5f74 7970 6573 3d65 7863 6c75  lude_types=exclu
+0000ae70: 6465 5f74 7970 6573 2c0a 2020 2020 2020  de_types,.      
+0000ae80: 2020 2020 2020 6578 636c 7564 655f 7461        exclude_ta
+0000ae90: 6773 3d65 7863 6c75 6465 5f74 6167 732c  gs=exclude_tags,
+0000aea0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0000aeb0: 2020 2020 636f 6e66 6967 203d 2065 6e73      config = ens
+0000aec0: 7572 655f 636f 6e66 6967 2863 6f6e 6669  ure_config(confi
+0000aed0: 6729 0a20 2020 2020 2020 2072 6f6f 745f  g).        root_
+0000aee0: 7461 6773 203d 2063 6f6e 6669 672e 6765  tags = config.ge
+0000aef0: 7428 2274 6167 7322 2c20 5b5d 290a 2020  t("tags", []).  
+0000af00: 2020 2020 2020 726f 6f74 5f6d 6574 6164        root_metad
+0000af10: 6174 6120 3d20 636f 6e66 6967 2e67 6574  ata = config.get
+0000af20: 2822 6d65 7461 6461 7461 222c 207b 7d29  ("metadata", {})
+0000af30: 0a20 2020 2020 2020 2072 6f6f 745f 6e61  .        root_na
+0000af40: 6d65 203d 2063 6f6e 6669 672e 6765 7428  me = config.get(
+0000af50: 2272 756e 5f6e 616d 6522 2c20 7365 6c66  "run_name", self
+0000af60: 2e67 6574 5f6e 616d 6528 2929 0a0a 2020  .get_name())..  
+0000af70: 2020 2020 2020 2320 4967 6e6f 7269 6e67        # Ignoring
+0000af80: 206d 7970 7920 636f 6d70 6c61 696e 7420   mypy complaint 
+0000af90: 6162 6f75 7420 746f 6f20 6d61 6e79 2064  about too many d
+0000afa0: 6966 6665 7265 6e74 2075 6e69 6f6e 2063  ifferent union c
+0000afb0: 6f6d 6269 6e61 7469 6f6e 730a 2020 2020  ombinations.    
+0000afc0: 2020 2020 2320 5468 6973 2061 7269 7365      # This arise
+0000afd0: 7320 6265 6361 7573 6520 6d61 6e79 206f  s because many o
+0000afe0: 6620 7468 6520 6172 6775 6d65 6e74 2074  f the argument t
+0000aff0: 7970 6573 2061 7265 2075 6e69 6f6e 730a  ypes are unions.
+0000b000: 2020 2020 2020 2020 6173 796e 6320 666f          async fo
+0000b010: 7220 6c6f 6720 696e 205f 6173 7472 6561  r log in _astrea
+0000b020: 6d5f 6c6f 675f 696d 706c 656d 656e 7461  m_log_implementa
+0000b030: 7469 6f6e 2820 2023 2074 7970 653a 2069  tion(  # type: i
+0000b040: 676e 6f72 655b 6d69 7363 5d0a 2020 2020  gnore[misc].    
+0000b050: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+0000b060: 2020 2020 2020 2020 2020 696e 7075 742c            input,
+0000b070: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0000b080: 6669 673d 636f 6e66 6967 2c0a 2020 2020  fig=config,.    
+0000b090: 2020 2020 2020 2020 7374 7265 616d 3d73          stream=s
+0000b0a0: 7472 6561 6d2c 0a20 2020 2020 2020 2020  tream,.         
+0000b0b0: 2020 2064 6966 663d 5472 7565 2c0a 2020     diff=True,.  
+0000b0c0: 2020 2020 2020 2020 2020 7769 7468 5f73            with_s
+0000b0d0: 7472 6561 6d65 645f 6f75 7470 7574 5f6c  treamed_output_l
+0000b0e0: 6973 743d 5472 7565 2c0a 2020 2020 2020  ist=True,.      
+0000b0f0: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
+0000b100: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
+0000b110: 2020 2020 2020 2072 756e 5f6c 6f67 203d         run_log =
+0000b120: 2072 756e 5f6c 6f67 202b 206c 6f67 0a0a   run_log + log..
+0000b130: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0000b140: 6f74 2065 6e63 6f75 6e74 6572 6564 5f73  ot encountered_s
+0000b150: 7461 7274 5f65 7665 6e74 3a0a 2020 2020  tart_event:.    
+0000b160: 2020 2020 2020 2020 2020 2020 2320 5969              # Yi
+0000b170: 656c 6420 7468 6520 7374 6172 7420 6576  eld the start ev
+0000b180: 656e 7420 666f 7220 7468 6520 726f 6f74  ent for the root
+0000b190: 2072 756e 6e61 626c 652e 0a20 2020 2020   runnable..     
+0000b1a0: 2020 2020 2020 2020 2020 2065 6e63 6f75             encou
+0000b1b0: 6e74 6572 6564 5f73 7461 7274 5f65 7665  ntered_start_eve
+0000b1c0: 6e74 203d 2054 7275 650a 2020 2020 2020  nt = True.      
+0000b1d0: 2020 2020 2020 2020 2020 7374 6174 6520            state 
+0000b1e0: 3d20 7275 6e5f 6c6f 672e 7374 6174 652e  = run_log.state.
+0000b1f0: 636f 7079 2829 0a0a 2020 2020 2020 2020  copy()..        
+0000b200: 2020 2020 2020 2020 6576 656e 7420 3d20          event = 
+0000b210: 5374 7265 616d 4576 656e 7428 0a20 2020  StreamEvent(.   
+0000b220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b230: 2065 7665 6e74 3d66 226f 6e5f 7b73 7461   event=f"on_{sta
+0000b240: 7465 5b27 7479 7065 275d 7d5f 7374 6172  te['type']}_star
+0000b250: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
+0000b260: 2020 2020 2020 2020 7275 6e5f 6964 3d73          run_id=s
+0000b270: 7461 7465 5b22 6964 225d 2c0a 2020 2020  tate["id"],.    
+0000b280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b290: 6e61 6d65 3d72 6f6f 745f 6e61 6d65 2c0a  name=root_name,.
+0000b2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b2b0: 2020 2020 7461 6773 3d72 6f6f 745f 7461      tags=root_ta
+0000b2c0: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
+0000b2d0: 2020 2020 2020 2020 6d65 7461 6461 7461          metadata
+0000b2e0: 3d72 6f6f 745f 6d65 7461 6461 7461 2c0a  =root_metadata,.
+0000b2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b300: 2020 2020 6461 7461 3d7b 0a20 2020 2020      data={.     
+0000b310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b320: 2020 2022 696e 7075 7422 3a20 696e 7075     "input": inpu
+0000b330: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+0000b340: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+0000b350: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0000b360: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000b370: 5f72 6f6f 745f 6576 656e 745f 6669 6c74  _root_event_filt
+0000b380: 6572 2e69 6e63 6c75 6465 5f65 7665 6e74  er.include_event
+0000b390: 2865 7665 6e74 2c20 7374 6174 655b 2274  (event, state["t
+0000b3a0: 7970 6522 5d29 3a0a 2020 2020 2020 2020  ype"]):.        
+0000b3b0: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
+0000b3c0: 6420 6576 656e 740a 0a20 2020 2020 2020  d event..       
+0000b3d0: 2020 2020 2070 6174 6873 203d 207b 0a20       paths = {. 
+0000b3e0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0000b3f0: 705b 2270 6174 6822 5d2e 7370 6c69 7428  p["path"].split(
+0000b400: 222f 2229 5b32 5d0a 2020 2020 2020 2020  "/")[2].        
+0000b410: 2020 2020 2020 2020 666f 7220 6f70 2069          for op i
+0000b420: 6e20 6c6f 672e 6f70 730a 2020 2020 2020  n log.ops.      
+0000b430: 2020 2020 2020 2020 2020 6966 206f 705b            if op[
+0000b440: 2270 6174 6822 5d2e 7374 6172 7473 7769  "path"].startswi
+0000b450: 7468 2822 2f6c 6f67 732f 2229 0a20 2020  th("/logs/").   
+0000b460: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0000b470: 2020 2020 2020 2023 2045 6c65 6d65 6e74         # Element
+0000b480: 7320 696e 2061 2073 6574 2073 686f 756c  s in a set shoul
+0000b490: 6420 6265 2069 7465 7261 7465 6420 696e  d be iterated in
+0000b4a0: 2074 6865 2073 616d 6520 6f72 6465 720a   the same order.
+0000b4b0: 2020 2020 2020 2020 2020 2020 2320 6173              # as
+0000b4c0: 2074 6865 7920 7765 7265 2069 6e73 6572   they were inser
+0000b4d0: 7465 6420 696e 206d 6f64 6572 6e20 7079  ted in modern py
+0000b4e0: 7468 6f6e 2076 6572 7369 6f6e 732e 0a20  thon versions.. 
+0000b4f0: 2020 2020 2020 2020 2020 2066 6f72 2070             for p
+0000b500: 6174 6820 696e 2070 6174 6873 3a0a 2020  ath in paths:.  
+0000b510: 2020 2020 2020 2020 2020 2020 2020 6461                da
+0000b520: 7461 3a20 4576 656e 7444 6174 6120 3d20  ta: EventData = 
+0000b530: 7b7d 0a20 2020 2020 2020 2020 2020 2020  {}.             
+0000b540: 2020 206c 6f67 5f65 6e74 7279 3a20 4c6f     log_entry: Lo
+0000b550: 6745 6e74 7279 203d 2072 756e 5f6c 6f67  gEntry = run_log
+0000b560: 2e73 7461 7465 5b22 6c6f 6773 225d 5b70  .state["logs"][p
+0000b570: 6174 685d 0a20 2020 2020 2020 2020 2020  ath].           
+0000b580: 2020 2020 2069 6620 6c6f 675f 656e 7472       if log_entr
+0000b590: 795b 2265 6e64 5f74 696d 6522 5d20 6973  y["end_time"] is
+0000b5a0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0000b5b0: 2020 2020 2020 2020 2020 2069 6620 6c6f             if lo
+0000b5c0: 675f 656e 7472 795b 2273 7472 6561 6d65  g_entry["streame
+0000b5d0: 645f 6f75 7470 7574 225d 3a0a 2020 2020  d_output"]:.    
+0000b5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b5f0: 2020 2020 6576 656e 745f 7479 7065 203d      event_type =
+0000b600: 2022 7374 7265 616d 220a 2020 2020 2020   "stream".      
+0000b610: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0000b620: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000b630: 2020 2020 2020 2020 2020 2020 6576 656e              even
+0000b640: 745f 7479 7065 203d 2022 7374 6172 7422  t_type = "start"
+0000b650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b660: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000b670: 2020 2020 2020 2020 2020 2065 7665 6e74             event
+0000b680: 5f74 7970 6520 3d20 2265 6e64 220a 0a20  _type = "end".. 
+0000b690: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000b6a0: 6620 6576 656e 745f 7479 7065 203d 3d20  f event_type == 
+0000b6b0: 2273 7461 7274 223a 0a20 2020 2020 2020  "start":.       
+0000b6c0: 2020 2020 2020 2020 2020 2020 2023 2049               # I
+0000b6d0: 6e63 6c75 6465 2074 6865 2069 6e70 7574  nclude the input
+0000b6e0: 7320 7769 7468 2074 6865 2073 7461 7274  s with the start
+0000b6f0: 2065 7665 6e74 2069 6620 7468 6579 2061   event if they a
+0000b700: 7265 2061 7661 696c 6162 6c65 2e0a 2020  re available..  
+0000b710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b720: 2020 2320 5573 7561 6c6c 7920 7468 6579    # Usually they
+0000b730: 2077 696c 6c20 4e4f 5420 6265 2061 7661   will NOT be ava
+0000b740: 696c 6162 6c65 2066 6f72 2063 6f6d 706f  ilable for compo
+0000b750: 6e65 6e74 7320 7468 6174 206f 7065 7261  nents that opera
+0000b760: 7465 0a20 2020 2020 2020 2020 2020 2020  te.             
+0000b770: 2020 2020 2020 2023 206f 6e20 7374 7265         # on stre
+0000b780: 616d 732c 2073 696e 6365 2074 686f 7365  ams, since those
+0000b790: 2063 6f6d 706f 6e65 6e74 7320 7374 7265   components stre
+0000b7a0: 616d 2074 6865 2069 6e70 7574 2061 6e64  am the input and
+0000b7b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b7c0: 2020 2020 2023 2064 6f6e 2774 206b 6e6f       # don't kno
+0000b7d0: 7720 6974 7320 6669 6e61 6c20 7661 6c75  w its final valu
+0000b7e0: 6520 756e 7469 6c20 7468 6520 656e 6420  e until the end 
+0000b7f0: 6f66 2074 6865 2073 7472 6561 6d2e 0a20  of the stream.. 
+0000b800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b810: 2020 2069 6e70 7574 7320 3d20 6c6f 675f     inputs = log_
+0000b820: 656e 7472 795b 2269 6e70 7574 7322 5d0a  entry["inputs"].
+0000b830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b840: 2020 2020 6966 2069 6e70 7574 7320 6973      if inputs is
+0000b850: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0000b860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b870: 2020 2064 6174 615b 2269 6e70 7574 225d     data["input"]
+0000b880: 203d 2069 6e70 7574 730a 2020 2020 2020   = inputs.      
+0000b890: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+0000b8a0: 7373 0a0a 2020 2020 2020 2020 2020 2020  ss..            
+0000b8b0: 2020 2020 6966 2065 7665 6e74 5f74 7970      if event_typ
+0000b8c0: 6520 3d3d 2022 656e 6422 3a0a 2020 2020  e == "end":.    
+0000b8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b8e0: 696e 7075 7473 203d 206c 6f67 5f65 6e74  inputs = log_ent
+0000b8f0: 7279 5b22 696e 7075 7473 225d 0a20 2020  ry["inputs"].   
+0000b900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b910: 2069 6620 696e 7075 7473 2069 7320 6e6f   if inputs is no
+0000b920: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0000b930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b940: 6461 7461 5b22 696e 7075 7422 5d20 3d20  data["input"] = 
+0000b950: 696e 7075 7473 0a0a 2020 2020 2020 2020  inputs..        
+0000b960: 2020 2020 2020 2020 2020 2020 2320 4e6f              # No
+0000b970: 6e65 2069 7320 6120 5641 4c49 4420 6f75  ne is a VALID ou
+0000b980: 7470 7574 2066 6f72 2061 6e20 656e 6420  tput for an end 
+0000b990: 6576 656e 740a 2020 2020 2020 2020 2020  event.          
+0000b9a0: 2020 2020 2020 2020 2020 6461 7461 5b22            data["
+0000b9b0: 6f75 7470 7574 225d 203d 206c 6f67 5f65  output"] = log_e
+0000b9c0: 6e74 7279 5b22 6669 6e61 6c5f 6f75 7470  ntry["final_outp
+0000b9d0: 7574 225d 0a0a 2020 2020 2020 2020 2020  ut"]..          
+0000b9e0: 2020 2020 2020 6966 2065 7665 6e74 5f74        if event_t
+0000b9f0: 7970 6520 3d3d 2022 7374 7265 616d 223a  ype == "stream":
+0000ba00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ba10: 2020 2020 206e 756d 5f63 6875 6e6b 7320       num_chunks 
+0000ba20: 3d20 6c65 6e28 6c6f 675f 656e 7472 795b  = len(log_entry[
+0000ba30: 2273 7472 6561 6d65 645f 6f75 7470 7574  "streamed_output
+0000ba40: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
+0000ba50: 2020 2020 2020 2020 6966 206e 756d 5f63          if num_c
+0000ba60: 6875 6e6b 7320 213d 2031 3a0a 2020 2020  hunks != 1:.    
+0000ba70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ba80: 2020 2020 7261 6973 6520 4173 7365 7274      raise Assert
+0000ba90: 696f 6e45 7272 6f72 280a 2020 2020 2020  ionError(.      
+0000baa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bab0: 2020 2020 2020 6622 4578 7065 6374 6564        f"Expected
+0000bac0: 2065 7861 6374 6c79 206f 6e65 2063 6875   exactly one chu
+0000bad0: 6e6b 206f 6620 7374 7265 616d 6564 206f  nk of streamed o
+0000bae0: 7574 7075 742c 2022 0a20 2020 2020 2020  utput, ".       
+0000baf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bb00: 2020 2020 2066 2267 6f74 207b 6e75 6d5f       f"got {num_
+0000bb10: 6368 756e 6b73 7d20 696e 7374 6561 642e  chunks} instead.
+0000bb20: 2054 6869 7320 6973 2069 6d70 6f73 7369   This is impossi
+0000bb30: 626c 652e 2022 0a20 2020 2020 2020 2020  ble. ".         
+0000bb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bb50: 2020 2066 2245 6e63 6f75 6e74 6572 6564     f"Encountered
+0000bb60: 2069 6e3a 207b 6c6f 675f 656e 7472 795b   in: {log_entry[
+0000bb70: 276e 616d 6527 5d7d 220a 2020 2020 2020  'name']}".      
+0000bb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bb90: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+0000bba0: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
+0000bbb0: 7b22 6368 756e 6b22 3a20 6c6f 675f 656e  {"chunk": log_en
+0000bbc0: 7472 795b 2273 7472 6561 6d65 645f 6f75  try["streamed_ou
+0000bbd0: 7470 7574 225d 5b30 5d7d 0a20 2020 2020  tput"][0]}.     
+0000bbe0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000bbf0: 2043 6c65 616e 2075 7020 7468 6520 7374   Clean up the st
+0000bc00: 7265 616d 2c20 7765 2064 6f6e 2774 206e  ream, we don't n
+0000bc10: 6565 6420 6974 2061 6e79 6d6f 7265 2e0a  eed it anymore..
+0000bc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bc30: 2020 2020 2320 416e 6420 7468 6973 2061      # And this a
+0000bc40: 766f 6964 7320 6475 706c 6963 6174 6573  voids duplicates
+0000bc50: 2061 7320 7765 6c6c 210a 2020 2020 2020   as well!.      
+0000bc60: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+0000bc70: 675f 656e 7472 795b 2273 7472 6561 6d65  g_entry["streame
+0000bc80: 645f 6f75 7470 7574 225d 203d 205b 5d0a  d_output"] = [].
+0000bc90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bca0: 2079 6965 6c64 2053 7472 6561 6d45 7665   yield StreamEve
+0000bcb0: 6e74 280a 2020 2020 2020 2020 2020 2020  nt(.            
+0000bcc0: 2020 2020 2020 2020 6576 656e 743d 6622          event=f"
+0000bcd0: 6f6e 5f7b 6c6f 675f 656e 7472 795b 2774  on_{log_entry['t
+0000bce0: 7970 6527 5d7d 5f7b 6576 656e 745f 7479  ype']}_{event_ty
+0000bcf0: 7065 7d22 2c0a 2020 2020 2020 2020 2020  pe}",.          
+0000bd00: 2020 2020 2020 2020 2020 6e61 6d65 3d6c            name=l
+0000bd10: 6f67 5f65 6e74 7279 5b22 6e61 6d65 225d  og_entry["name"]
+0000bd20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000bd30: 2020 2020 2020 7275 6e5f 6964 3d6c 6f67        run_id=log
+0000bd40: 5f65 6e74 7279 5b22 6964 225d 2c0a 2020  _entry["id"],.  
+0000bd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bd60: 2020 7461 6773 3d6c 6f67 5f65 6e74 7279    tags=log_entry
+0000bd70: 5b22 7461 6773 225d 2c0a 2020 2020 2020  ["tags"],.      
+0000bd80: 2020 2020 2020 2020 2020 2020 2020 6d65                me
+0000bd90: 7461 6461 7461 3d6c 6f67 5f65 6e74 7279  tadata=log_entry
+0000bda0: 5b22 6d65 7461 6461 7461 225d 2c0a 2020  ["metadata"],.  
+0000bdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bdc0: 2020 6461 7461 3d64 6174 612c 0a20 2020    data=data,.   
+0000bdd0: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+0000bde0: 2020 2020 2020 2020 2020 2020 2320 4669              # Fi
+0000bdf0: 6e61 6c6c 792c 2077 6520 7461 6b65 2063  nally, we take c
+0000be00: 6172 6520 6f66 2074 6865 2073 7472 6561  are of the strea
+0000be10: 6d69 6e67 206f 7574 7075 7420 6672 6f6d  ming output from
+0000be20: 2074 6865 2072 6f6f 7420 6368 6169 6e0a   the root chain.
+0000be30: 2020 2020 2020 2020 2020 2020 2320 6966              # if
+0000be40: 2074 6865 7265 2069 7320 616e 792e 0a20   there is any.. 
+0000be50: 2020 2020 2020 2020 2020 2073 7461 7465             state
+0000be60: 203d 2072 756e 5f6c 6f67 2e73 7461 7465   = run_log.state
+0000be70: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000be80: 7374 6174 655b 2273 7472 6561 6d65 645f  state["streamed_
+0000be90: 6f75 7470 7574 225d 3a0a 2020 2020 2020  output"]:.      
+0000bea0: 2020 2020 2020 2020 2020 6e75 6d5f 6368            num_ch
+0000beb0: 756e 6b73 203d 206c 656e 2873 7461 7465  unks = len(state
+0000bec0: 5b22 7374 7265 616d 6564 5f6f 7574 7075  ["streamed_outpu
+0000bed0: 7422 5d29 0a20 2020 2020 2020 2020 2020  t"]).           
+0000bee0: 2020 2020 2069 6620 6e75 6d5f 6368 756e       if num_chun
+0000bef0: 6b73 2021 3d20 313a 0a20 2020 2020 2020  ks != 1:.       
+0000bf00: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0000bf10: 7365 2041 7373 6572 7469 6f6e 4572 726f  se AssertionErro
+0000bf20: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0000bf30: 2020 2020 2020 2020 2020 2066 2245 7870             f"Exp
+0000bf40: 6563 7465 6420 6578 6163 746c 7920 6f6e  ected exactly on
+0000bf50: 6520 6368 756e 6b20 6f66 2073 7472 6561  e chunk of strea
+0000bf60: 6d65 6420 6f75 7470 7574 2c20 220a 2020  med output, ".  
+0000bf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bf80: 2020 2020 2020 6622 676f 7420 7b6e 756d        f"got {num
+0000bf90: 5f63 6875 6e6b 737d 2069 6e73 7465 6164  _chunks} instead
+0000bfa0: 2e20 5468 6973 2069 7320 696d 706f 7373  . This is imposs
+0000bfb0: 6962 6c65 2e20 220a 2020 2020 2020 2020  ible. ".        
+0000bfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bfd0: 6622 456e 636f 756e 7465 7265 6420 696e  f"Encountered in
+0000bfe0: 3a20 7b73 7461 7465 5b27 6e61 6d65 275d  : {state['name']
+0000bff0: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+0000c000: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0000c010: 2020 2020 2020 2020 2020 6461 7461 203d            data =
+0000c020: 207b 2263 6875 6e6b 223a 2073 7461 7465   {"chunk": state
+0000c030: 5b22 7374 7265 616d 6564 5f6f 7574 7075  ["streamed_outpu
+0000c040: 7422 5d5b 305d 7d0a 2020 2020 2020 2020  t"][0]}.        
+0000c050: 2020 2020 2020 2020 2320 436c 6561 6e20          # Clean 
+0000c060: 7570 2074 6865 2073 7472 6561 6d2c 2077  up the stream, w
+0000c070: 6520 646f 6e27 7420 6e65 6564 2069 7420  e don't need it 
+0000c080: 616e 796d 6f72 652e 0a20 2020 2020 2020  anymore..       
+0000c090: 2020 2020 2020 2020 2073 7461 7465 5b22           state["
+0000c0a0: 7374 7265 616d 6564 5f6f 7574 7075 7422  streamed_output"
+0000c0b0: 5d20 3d20 5b5d 0a0a 2020 2020 2020 2020  ] = []..        
+0000c0c0: 2020 2020 2020 2020 6576 656e 7420 3d20          event = 
+0000c0d0: 5374 7265 616d 4576 656e 7428 0a20 2020  StreamEvent(.   
+0000c0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c0f0: 2065 7665 6e74 3d66 226f 6e5f 7b73 7461   event=f"on_{sta
+0000c100: 7465 5b27 7479 7065 275d 7d5f 7374 7265  te['type']}_stre
+0000c110: 616d 222c 0a20 2020 2020 2020 2020 2020  am",.           
+0000c120: 2020 2020 2020 2020 2072 756e 5f69 643d           run_id=
+0000c130: 7374 6174 655b 2269 6422 5d2c 0a20 2020  state["id"],.   
 0000c140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c150: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0000c160: 6e61 6c5f 6f75 7470 7574 203d 204e 6f6e  nal_output = Non
-0000c170: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0000c180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c190: 2020 6669 6e61 6c5f 6f75 7470 7574 5f73    final_output_s
-0000c1a0: 7570 706f 7274 6564 203d 2046 616c 7365  upported = False
-0000c1b0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-0000c1c0: 6570 7420 5374 6f70 4173 796e 6349 7465  ept StopAsyncIte
-0000c1d0: 7261 7469 6f6e 3a0a 2020 2020 2020 2020  ration:.        
-0000c1e0: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-0000c1f0: 2020 2020 2020 2020 2061 7379 6e63 2066           async f
-0000c200: 6f72 2069 6368 756e 6b20 696e 2069 6e70  or ichunk in inp
-0000c210: 7574 5f66 6f72 5f74 7261 6369 6e67 3a0a  ut_for_tracing:.
-0000c220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c230: 6966 2066 696e 616c 5f69 6e70 7574 5f73  if final_input_s
-0000c240: 7570 706f 7274 6564 3a0a 2020 2020 2020  upported:.      
-0000c250: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000c260: 2066 696e 616c 5f69 6e70 7574 2069 7320   final_input is 
-0000c270: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0000c280: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0000c290: 6e61 6c5f 696e 7075 7420 3d20 6963 6875  nal_input = ichu
-0000c2a0: 6e6b 0a20 2020 2020 2020 2020 2020 2020  nk.             
-0000c2b0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0000c2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2d0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0000c2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2f0: 2020 2020 2020 6669 6e61 6c5f 696e 7075        final_inpu
-0000c300: 7420 3d20 6669 6e61 6c5f 696e 7075 7420  t = final_input 
-0000c310: 2b20 6963 6875 6e6b 2020 2320 7479 7065  + ichunk  # type
-0000c320: 3a20 6967 6e6f 7265 5b6f 7065 7261 746f  : ignore[operato
-0000c330: 725d 0a20 2020 2020 2020 2020 2020 2020  r].             
-0000c340: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-0000c350: 7420 5479 7065 4572 726f 723a 0a20 2020  t TypeError:.   
-0000c360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c370: 2020 2020 2020 2020 2066 696e 616c 5f69           final_i
-0000c380: 6e70 7574 203d 204e 6f6e 650a 2020 2020  nput = None.    
-0000c390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c3a0: 2020 2020 2020 2020 6669 6e61 6c5f 696e          final_in
-0000c3b0: 7075 745f 7375 7070 6f72 7465 6420 3d20  put_supported = 
-0000c3c0: 4661 6c73 650a 2020 2020 2020 2020 6578  False.        ex
-0000c3d0: 6365 7074 2042 6173 6545 7863 6570 7469  cept BaseExcepti
-0000c3e0: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
-0000c3f0: 2020 2020 2061 7761 6974 2072 756e 5f6d       await run_m
-0000c400: 616e 6167 6572 2e6f 6e5f 6368 6169 6e5f  anager.on_chain_
-0000c410: 6572 726f 7228 652c 2069 6e70 7574 733d  error(e, inputs=
-0000c420: 6669 6e61 6c5f 696e 7075 7429 0a20 2020  final_input).   
-0000c430: 2020 2020 2020 2020 2072 6169 7365 0a20           raise. 
-0000c440: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0000c450: 2020 2020 2020 2020 2061 7761 6974 2072           await r
-0000c460: 756e 5f6d 616e 6167 6572 2e6f 6e5f 6368  un_manager.on_ch
-0000c470: 6169 6e5f 656e 6428 6669 6e61 6c5f 6f75  ain_end(final_ou
-0000c480: 7470 7574 2c20 696e 7075 7473 3d66 696e  tput, inputs=fin
-0000c490: 616c 5f69 6e70 7574 290a 0a0a 636c 6173  al_input)...clas
-0000c4a0: 7320 5275 6e6e 6162 6c65 5365 7269 616c  s RunnableSerial
-0000c4b0: 697a 6162 6c65 2853 6572 6961 6c69 7a61  izable(Serializa
-0000c4c0: 626c 652c 2052 756e 6e61 626c 655b 496e  ble, Runnable[In
-0000c4d0: 7075 742c 204f 7574 7075 745d 293a 0a20  put, Output]):. 
-0000c4e0: 2020 2022 2222 4120 5275 6e6e 6162 6c65     """A Runnable
-0000c4f0: 2074 6861 7420 6361 6e20 6265 2073 6572   that can be ser
-0000c500: 6961 6c69 7a65 6420 746f 204a 534f 4e2e  ialized to JSON.
-0000c510: 2222 220a 0a20 2020 206e 616d 653a 204f  """..    name: O
-0000c520: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
-0000c530: 6f6e 650a 2020 2020 2222 2254 6865 206e  one.    """The n
-0000c540: 616d 6520 6f66 2074 6865 2072 756e 6e61  ame of the runna
-0000c550: 626c 652e 2055 7365 6420 666f 7220 6465  ble. Used for de
-0000c560: 6275 6767 696e 6720 616e 6420 7472 6163  bugging and trac
-0000c570: 696e 672e 2222 220a 0a20 2020 2064 6566  ing."""..    def
-0000c580: 2063 6f6e 6669 6775 7261 626c 655f 6669   configurable_fi
-0000c590: 656c 6473 280a 2020 2020 2020 2020 7365  elds(.        se
-0000c5a0: 6c66 2c20 2a2a 6b77 6172 6773 3a20 416e  lf, **kwargs: An
-0000c5b0: 7943 6f6e 6669 6775 7261 626c 6546 6965  yConfigurableFie
-0000c5c0: 6c64 0a20 2020 2029 202d 3e20 5275 6e6e  ld.    ) -> Runn
-0000c5d0: 6162 6c65 5365 7269 616c 697a 6162 6c65  ableSerializable
-0000c5e0: 5b49 6e70 7574 2c20 4f75 7470 7574 5d3a  [Input, Output]:
-0000c5f0: 0a20 2020 2020 2020 2066 726f 6d20 6c61  .        from la
-0000c600: 6e67 6368 6169 6e5f 636f 7265 2e72 756e  ngchain_core.run
-0000c610: 6e61 626c 6573 2e63 6f6e 6669 6775 7261  nables.configura
-0000c620: 626c 6520 696d 706f 7274 2052 756e 6e61  ble import Runna
-0000c630: 626c 6543 6f6e 6669 6775 7261 626c 6546  bleConfigurableF
-0000c640: 6965 6c64 730a 0a20 2020 2020 2020 2066  ields..        f
-0000c650: 6f72 206b 6579 2069 6e20 6b77 6172 6773  or key in kwargs
-0000c660: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0000c670: 206b 6579 206e 6f74 2069 6e20 7365 6c66   key not in self
-0000c680: 2e5f 5f66 6965 6c64 735f 5f3a 0a20 2020  .__fields__:.   
-0000c690: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-0000c6a0: 7365 2056 616c 7565 4572 726f 7228 0a20  se ValueError(. 
-0000c6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c6c0: 2020 2066 2243 6f6e 6669 6775 7261 7469     f"Configurati
-0000c6d0: 6f6e 206b 6579 207b 6b65 797d 206e 6f74  on key {key} not
-0000c6e0: 2066 6f75 6e64 2069 6e20 7b73 656c 667d   found in {self}
-0000c6f0: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
-0000c700: 2020 2020 2020 2020 2261 7661 696c 6162          "availab
-0000c710: 6c65 206b 6579 7320 6172 6520 7b73 656c  le keys are {sel
-0000c720: 662e 5f5f 6669 656c 6473 5f5f 2e6b 6579  f.__fields__.key
-0000c730: 7328 297d 220a 2020 2020 2020 2020 2020  s()}".          
-0000c740: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000c750: 2072 6574 7572 6e20 5275 6e6e 6162 6c65   return Runnable
-0000c760: 436f 6e66 6967 7572 6162 6c65 4669 656c  ConfigurableFiel
-0000c770: 6473 2864 6566 6175 6c74 3d73 656c 662c  ds(default=self,
-0000c780: 2066 6965 6c64 733d 6b77 6172 6773 290a   fields=kwargs).
-0000c790: 0a20 2020 2064 6566 2063 6f6e 6669 6775  .    def configu
-0000c7a0: 7261 626c 655f 616c 7465 726e 6174 6976  rable_alternativ
-0000c7b0: 6573 280a 2020 2020 2020 2020 7365 6c66  es(.        self
-0000c7c0: 2c0a 2020 2020 2020 2020 7768 6963 683a  ,.        which:
-0000c7d0: 2043 6f6e 6669 6775 7261 626c 6546 6965   ConfigurableFie
-0000c7e0: 6c64 2c0a 2020 2020 2020 2020 2a2c 0a20  ld,.        *,. 
-0000c7f0: 2020 2020 2020 2064 6566 6175 6c74 5f6b         default_k
-0000c800: 6579 3a20 7374 7220 3d20 2264 6566 6175  ey: str = "defau
-0000c810: 6c74 222c 0a20 2020 2020 2020 2070 7265  lt",.        pre
-0000c820: 6669 785f 6b65 7973 3a20 626f 6f6c 203d  fix_keys: bool =
-0000c830: 2046 616c 7365 2c0a 2020 2020 2020 2020   False,.        
-0000c840: 2a2a 6b77 6172 6773 3a20 556e 696f 6e5b  **kwargs: Union[
-0000c850: 5275 6e6e 6162 6c65 5b49 6e70 7574 2c20  Runnable[Input, 
-0000c860: 4f75 7470 7574 5d2c 2043 616c 6c61 626c  Output], Callabl
-0000c870: 655b 5b5d 2c20 5275 6e6e 6162 6c65 5b49  e[[], Runnable[I
-0000c880: 6e70 7574 2c20 4f75 7470 7574 5d5d 5d2c  nput, Output]]],
-0000c890: 0a20 2020 2029 202d 3e20 5275 6e6e 6162  .    ) -> Runnab
-0000c8a0: 6c65 5365 7269 616c 697a 6162 6c65 5b49  leSerializable[I
-0000c8b0: 6e70 7574 2c20 4f75 7470 7574 5d3a 0a20  nput, Output]:. 
-0000c8c0: 2020 2020 2020 2066 726f 6d20 6c61 6e67         from lang
-0000c8d0: 6368 6169 6e5f 636f 7265 2e72 756e 6e61  chain_core.runna
-0000c8e0: 626c 6573 2e63 6f6e 6669 6775 7261 626c  bles.configurabl
-0000c8f0: 6520 696d 706f 7274 2028 0a20 2020 2020  e import (.     
-0000c900: 2020 2020 2020 2052 756e 6e61 626c 6543         RunnableC
-0000c910: 6f6e 6669 6775 7261 626c 6541 6c74 6572  onfigurableAlter
-0000c920: 6e61 7469 7665 732c 0a20 2020 2020 2020  natives,.       
-0000c930: 2029 0a0a 2020 2020 2020 2020 7265 7475   )..        retu
-0000c940: 726e 2052 756e 6e61 626c 6543 6f6e 6669  rn RunnableConfi
-0000c950: 6775 7261 626c 6541 6c74 6572 6e61 7469  gurableAlternati
-0000c960: 7665 7328 0a20 2020 2020 2020 2020 2020  ves(.           
-0000c970: 2077 6869 6368 3d77 6869 6368 2c0a 2020   which=which,.  
-0000c980: 2020 2020 2020 2020 2020 6465 6661 756c            defaul
-0000c990: 743d 7365 6c66 2c0a 2020 2020 2020 2020  t=self,.        
-0000c9a0: 2020 2020 616c 7465 726e 6174 6976 6573      alternatives
-0000c9b0: 3d6b 7761 7267 732c 0a20 2020 2020 2020  =kwargs,.       
-0000c9c0: 2020 2020 2064 6566 6175 6c74 5f6b 6579       default_key
-0000c9d0: 3d64 6566 6175 6c74 5f6b 6579 2c0a 2020  =default_key,.  
-0000c9e0: 2020 2020 2020 2020 2020 7072 6566 6978            prefix
-0000c9f0: 5f6b 6579 733d 7072 6566 6978 5f6b 6579  _keys=prefix_key
-0000ca00: 732c 0a20 2020 2020 2020 2029 0a0a 0a64  s,.        )...d
-0000ca10: 6566 205f 7365 715f 696e 7075 745f 7363  ef _seq_input_sc
-0000ca20: 6865 6d61 280a 2020 2020 7374 6570 733a  hema(.    steps:
-0000ca30: 204c 6973 745b 5275 6e6e 6162 6c65 5b41   List[Runnable[A
-0000ca40: 6e79 2c20 416e 795d 5d2c 2063 6f6e 6669  ny, Any]], confi
-0000ca50: 673a 204f 7074 696f 6e61 6c5b 5275 6e6e  g: Optional[Runn
-0000ca60: 6162 6c65 436f 6e66 6967 5d0a 2920 2d3e  ableConfig].) ->
-0000ca70: 2054 7970 655b 4261 7365 4d6f 6465 6c5d   Type[BaseModel]
-0000ca80: 3a0a 2020 2020 6672 6f6d 206c 616e 6763  :.    from langc
-0000ca90: 6861 696e 5f63 6f72 652e 7275 6e6e 6162  hain_core.runnab
-0000caa0: 6c65 732e 7061 7373 7468 726f 7567 6820  les.passthrough 
-0000cab0: 696d 706f 7274 2052 756e 6e61 626c 6541  import RunnableA
-0000cac0: 7373 6967 6e2c 2052 756e 6e61 626c 6550  ssign, RunnableP
-0000cad0: 6963 6b0a 0a20 2020 2066 6972 7374 203d  ick..    first =
-0000cae0: 2073 7465 7073 5b30 5d0a 2020 2020 6966   steps[0].    if
-0000caf0: 206c 656e 2873 7465 7073 2920 3d3d 2031   len(steps) == 1
-0000cb00: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0000cb10: 2066 6972 7374 2e67 6574 5f69 6e70 7574   first.get_input
-0000cb20: 5f73 6368 656d 6128 636f 6e66 6967 290a  _schema(config).
-0000cb30: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-0000cb40: 6e63 6528 6669 7273 742c 2052 756e 6e61  nce(first, Runna
-0000cb50: 626c 6541 7373 6967 6e29 3a0a 2020 2020  bleAssign):.    
-0000cb60: 2020 2020 6e65 7874 5f69 6e70 7574 5f73      next_input_s
-0000cb70: 6368 656d 6120 3d20 5f73 6571 5f69 6e70  chema = _seq_inp
-0000cb80: 7574 5f73 6368 656d 6128 7374 6570 735b  ut_schema(steps[
-0000cb90: 313a 5d2c 2063 6f6e 6669 6729 0a20 2020  1:], config).   
-0000cba0: 2020 2020 2069 6620 6e6f 7420 6e65 7874       if not next
-0000cbb0: 5f69 6e70 7574 5f73 6368 656d 612e 5f5f  _input_schema.__
-0000cbc0: 6375 7374 6f6d 5f72 6f6f 745f 7479 7065  custom_root_type
-0000cbd0: 5f5f 3a0a 2020 2020 2020 2020 2020 2020  __:.            
-0000cbe0: 2320 6974 2773 2061 2064 6963 7420 6173  # it's a dict as
-0000cbf0: 2065 7870 6563 7465 640a 2020 2020 2020   expected.      
-0000cc00: 2020 2020 2020 7265 7475 726e 2063 7265        return cre
-0000cc10: 6174 655f 6d6f 6465 6c28 2020 2320 7479  ate_model(  # ty
-0000cc20: 7065 3a20 6967 6e6f 7265 5b63 616c 6c2d  pe: ignore[call-
-0000cc30: 6f76 6572 6c6f 6164 5d0a 2020 2020 2020  overload].      
-0000cc40: 2020 2020 2020 2020 2020 2252 756e 6e61            "Runna
-0000cc50: 626c 6553 6571 7565 6e63 6549 6e70 7574  bleSequenceInput
-0000cc60: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0000cc70: 2020 202a 2a7b 0a20 2020 2020 2020 2020     **{.         
-0000cc80: 2020 2020 2020 2020 2020 206b 3a20 2876             k: (v
-0000cc90: 2e61 6e6e 6f74 6174 696f 6e2c 2076 2e64  .annotation, v.d
-0000cca0: 6566 6175 6c74 290a 2020 2020 2020 2020  efault).        
-0000ccb0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000ccc0: 6b2c 2076 2069 6e20 6e65 7874 5f69 6e70  k, v in next_inp
-0000ccd0: 7574 5f73 6368 656d 612e 5f5f 6669 656c  ut_schema.__fiel
-0000cce0: 6473 5f5f 2e69 7465 6d73 2829 0a20 2020  ds__.items().   
-0000ccf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cd00: 2069 6620 6b20 6e6f 7420 696e 2066 6972   if k not in fir
-0000cd10: 7374 2e6d 6170 7065 722e 7374 6570 730a  st.mapper.steps.
-0000cd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cd30: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-0000cd40: 2020 205f 5f63 6f6e 6669 675f 5f3d 5f53     __config__=_S
-0000cd50: 6368 656d 6143 6f6e 6669 672c 0a20 2020  chemaConfig,.   
-0000cd60: 2020 2020 2020 2020 2029 0a20 2020 2065           ).    e
-0000cd70: 6c69 6620 6973 696e 7374 616e 6365 2866  lif isinstance(f
-0000cd80: 6972 7374 2c20 5275 6e6e 6162 6c65 5069  irst, RunnablePi
-0000cd90: 636b 293a 0a20 2020 2020 2020 2072 6574  ck):.        ret
-0000cda0: 7572 6e20 5f73 6571 5f69 6e70 7574 5f73  urn _seq_input_s
-0000cdb0: 6368 656d 6128 7374 6570 735b 313a 5d2c  chema(steps[1:],
-0000cdc0: 2063 6f6e 6669 6729 0a0a 2020 2020 7265   config)..    re
-0000cdd0: 7475 726e 2066 6972 7374 2e67 6574 5f69  turn first.get_i
-0000cde0: 6e70 7574 5f73 6368 656d 6128 636f 6e66  nput_schema(conf
-0000cdf0: 6967 290a 0a0a 6465 6620 5f73 6571 5f6f  ig)...def _seq_o
-0000ce00: 7574 7075 745f 7363 6865 6d61 280a 2020  utput_schema(.  
-0000ce10: 2020 7374 6570 733a 204c 6973 745b 5275    steps: List[Ru
-0000ce20: 6e6e 6162 6c65 5b41 6e79 2c20 416e 795d  nnable[Any, Any]
-0000ce30: 5d2c 2063 6f6e 6669 673a 204f 7074 696f  ], config: Optio
-0000ce40: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-0000ce50: 6967 5d0a 2920 2d3e 2054 7970 655b 4261  ig].) -> Type[Ba
-0000ce60: 7365 4d6f 6465 6c5d 3a0a 2020 2020 6672  seModel]:.    fr
-0000ce70: 6f6d 206c 616e 6763 6861 696e 5f63 6f72  om langchain_cor
-0000ce80: 652e 7275 6e6e 6162 6c65 732e 7061 7373  e.runnables.pass
-0000ce90: 7468 726f 7567 6820 696d 706f 7274 2052  through import R
-0000cea0: 756e 6e61 626c 6541 7373 6967 6e2c 2052  unnableAssign, R
-0000ceb0: 756e 6e61 626c 6550 6963 6b0a 0a20 2020  unnablePick..   
-0000cec0: 206c 6173 7420 3d20 7374 6570 735b 2d31   last = steps[-1
-0000ced0: 5d0a 2020 2020 6966 206c 656e 2873 7465  ].    if len(ste
-0000cee0: 7073 2920 3d3d 2031 3a0a 2020 2020 2020  ps) == 1:.      
-0000cef0: 2020 7265 7475 726e 206c 6173 742e 6765    return last.ge
-0000cf00: 745f 696e 7075 745f 7363 6865 6d61 2863  t_input_schema(c
-0000cf10: 6f6e 6669 6729 0a20 2020 2065 6c69 6620  onfig).    elif 
-0000cf20: 6973 696e 7374 616e 6365 286c 6173 742c  isinstance(last,
-0000cf30: 2052 756e 6e61 626c 6541 7373 6967 6e29   RunnableAssign)
-0000cf40: 3a0a 2020 2020 2020 2020 6d61 7070 6572  :.        mapper
-0000cf50: 5f6f 7574 7075 745f 7363 6865 6d61 203d  _output_schema =
-0000cf60: 206c 6173 742e 6d61 7070 6572 2e67 6574   last.mapper.get
-0000cf70: 5f6f 7574 7075 745f 7363 6865 6d61 2863  _output_schema(c
-0000cf80: 6f6e 6669 6729 0a20 2020 2020 2020 2070  onfig).        p
-0000cf90: 7265 765f 6f75 7470 7574 5f73 6368 656d  rev_output_schem
-0000cfa0: 6120 3d20 5f73 6571 5f6f 7574 7075 745f  a = _seq_output_
-0000cfb0: 7363 6865 6d61 2873 7465 7073 5b3a 2d31  schema(steps[:-1
-0000cfc0: 5d2c 2063 6f6e 6669 6729 0a20 2020 2020  ], config).     
-0000cfd0: 2020 2069 6620 6e6f 7420 7072 6576 5f6f     if not prev_o
-0000cfe0: 7574 7075 745f 7363 6865 6d61 2e5f 5f63  utput_schema.__c
-0000cff0: 7573 746f 6d5f 726f 6f74 5f74 7970 655f  ustom_root_type_
-0000d000: 5f3a 0a20 2020 2020 2020 2020 2020 2023  _:.            #
-0000d010: 2069 7427 7320 6120 6469 6374 2061 7320   it's a dict as 
-0000d020: 6578 7065 6374 6564 0a20 2020 2020 2020  expected.       
-0000d030: 2020 2020 2072 6574 7572 6e20 6372 6561       return crea
-0000d040: 7465 5f6d 6f64 656c 2820 2023 2074 7970  te_model(  # typ
-0000d050: 653a 2069 676e 6f72 655b 6361 6c6c 2d6f  e: ignore[call-o
-0000d060: 7665 726c 6f61 645d 0a20 2020 2020 2020  verload].       
-0000d070: 2020 2020 2020 2020 2022 5275 6e6e 6162           "Runnab
-0000d080: 6c65 5365 7175 656e 6365 4f75 7470 7574  leSequenceOutput
-0000d090: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0000d0a0: 2020 202a 2a7b 0a20 2020 2020 2020 2020     **{.         
-0000d0b0: 2020 2020 2020 2020 2020 202a 2a7b 0a20             **{. 
-0000d0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d0d0: 2020 2020 2020 206b 3a20 2876 2e61 6e6e         k: (v.ann
-0000d0e0: 6f74 6174 696f 6e2c 2076 2e64 6566 6175  otation, v.defau
-0000d0f0: 6c74 290a 2020 2020 2020 2020 2020 2020  lt).            
-0000d100: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000d110: 6b2c 2076 2069 6e20 7072 6576 5f6f 7574  k, v in prev_out
-0000d120: 7075 745f 7363 6865 6d61 2e5f 5f66 6965  put_schema.__fie
-0000d130: 6c64 735f 5f2e 6974 656d 7328 290a 2020  lds__.items().  
-0000d140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d150: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
-0000d160: 2020 2020 2020 2020 202a 2a7b 0a20 2020           **{.   
-0000d170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d180: 2020 2020 206b 3a20 2876 2e61 6e6e 6f74       k: (v.annot
-0000d190: 6174 696f 6e2c 2076 2e64 6566 6175 6c74  ation, v.default
-0000d1a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000d1b0: 2020 2020 2020 2020 2020 666f 7220 6b2c            for k,
-0000d1c0: 2076 2069 6e20 6d61 7070 6572 5f6f 7574   v in mapper_out
-0000d1d0: 7075 745f 7363 6865 6d61 2e5f 5f66 6965  put_schema.__fie
-0000d1e0: 6c64 735f 5f2e 6974 656d 7328 290a 2020  lds__.items().  
-0000d1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d200: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
-0000d210: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-0000d220: 2020 2020 2020 2020 5f5f 636f 6e66 6967          __config
-0000d230: 5f5f 3d5f 5363 6865 6d61 436f 6e66 6967  __=_SchemaConfig
-0000d240: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-0000d250: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-0000d260: 6e63 6528 6c61 7374 2c20 5275 6e6e 6162  nce(last, Runnab
-0000d270: 6c65 5069 636b 293a 0a20 2020 2020 2020  lePick):.       
-0000d280: 2070 7265 765f 6f75 7470 7574 5f73 6368   prev_output_sch
-0000d290: 656d 6120 3d20 5f73 6571 5f6f 7574 7075  ema = _seq_outpu
-0000d2a0: 745f 7363 6865 6d61 2873 7465 7073 5b3a  t_schema(steps[:
-0000d2b0: 2d31 5d2c 2063 6f6e 6669 6729 0a20 2020  -1], config).   
-0000d2c0: 2020 2020 2069 6620 6e6f 7420 7072 6576       if not prev
-0000d2d0: 5f6f 7574 7075 745f 7363 6865 6d61 2e5f  _output_schema._
-0000d2e0: 5f63 7573 746f 6d5f 726f 6f74 5f74 7970  _custom_root_typ
-0000d2f0: 655f 5f3a 0a20 2020 2020 2020 2020 2020  e__:.           
-0000d300: 2023 2069 7427 7320 6120 6469 6374 2061   # it's a dict a
-0000d310: 7320 6578 7065 6374 6564 0a20 2020 2020  s expected.     
-0000d320: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-0000d330: 616e 6365 286c 6173 742e 6b65 7973 2c20  ance(last.keys, 
-0000d340: 6c69 7374 293a 0a20 2020 2020 2020 2020  list):.         
-0000d350: 2020 2020 2020 2072 6574 7572 6e20 6372         return cr
-0000d360: 6561 7465 5f6d 6f64 656c 2820 2023 2074  eate_model(  # t
-0000d370: 7970 653a 2069 676e 6f72 655b 6361 6c6c  ype: ignore[call
-0000d380: 2d6f 7665 726c 6f61 645d 0a20 2020 2020  -overload].     
-0000d390: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000d3a0: 5275 6e6e 6162 6c65 5365 7175 656e 6365  RunnableSequence
-0000d3b0: 4f75 7470 7574 222c 0a20 2020 2020 2020  Output",.       
-0000d3c0: 2020 2020 2020 2020 2020 2020 202a 2a7b               **{
-0000d3d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d3e0: 2020 2020 2020 2020 206b 3a20 2876 2e61           k: (v.a
-0000d3f0: 6e6e 6f74 6174 696f 6e2c 2076 2e64 6566  nnotation, v.def
-0000d400: 6175 6c74 290a 2020 2020 2020 2020 2020  ault).          
-0000d410: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0000d420: 7220 6b2c 2076 2069 6e20 7072 6576 5f6f  r k, v in prev_o
-0000d430: 7574 7075 745f 7363 6865 6d61 2e5f 5f66  utput_schema.__f
-0000d440: 6965 6c64 735f 5f2e 6974 656d 7328 290a  ields__.items().
-0000d450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d460: 2020 2020 2020 2020 6966 206b 2069 6e20          if k in 
-0000d470: 6c61 7374 2e6b 6579 730a 2020 2020 2020  last.keys.      
-0000d480: 2020 2020 2020 2020 2020 2020 2020 7d2c                },
-0000d490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d4a0: 2020 2020 205f 5f63 6f6e 6669 675f 5f3d       __config__=
-0000d4b0: 5f53 6368 656d 6143 6f6e 6669 672c 0a20  _SchemaConfig,. 
-0000d4c0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0000d4d0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0000d4e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000d4f0: 2020 2066 6965 6c64 203d 2070 7265 765f     field = prev_
-0000d500: 6f75 7470 7574 5f73 6368 656d 612e 5f5f  output_schema.__
-0000d510: 6669 656c 6473 5f5f 5b6c 6173 742e 6b65  fields__[last.ke
-0000d520: 7973 5d0a 2020 2020 2020 2020 2020 2020  ys].            
-0000d530: 2020 2020 7265 7475 726e 2063 7265 6174      return creat
-0000d540: 655f 6d6f 6465 6c28 2020 2320 7479 7065  e_model(  # type
-0000d550: 3a20 6967 6e6f 7265 5b63 616c 6c2d 6f76  : ignore[call-ov
-0000d560: 6572 6c6f 6164 5d0a 2020 2020 2020 2020  erload].        
-0000d570: 2020 2020 2020 2020 2020 2020 2252 756e              "Run
-0000d580: 6e61 626c 6553 6571 7565 6e63 654f 7574  nableSequenceOut
-0000d590: 7075 7422 2c0a 2020 2020 2020 2020 2020  put",.          
-0000d5a0: 2020 2020 2020 2020 2020 5f5f 726f 6f74            __root
-0000d5b0: 5f5f 3d28 6669 656c 642e 616e 6e6f 7461  __=(field.annota
-0000d5c0: 7469 6f6e 2c20 6669 656c 642e 6465 6661  tion, field.defa
-0000d5d0: 756c 7429 2c0a 2020 2020 2020 2020 2020  ult),.          
-0000d5e0: 2020 2020 2020 2020 2020 5f5f 636f 6e66            __conf
-0000d5f0: 6967 5f5f 3d5f 5363 6865 6d61 436f 6e66  ig__=_SchemaConf
-0000d600: 6967 2c0a 2020 2020 2020 2020 2020 2020  ig,.            
-0000d610: 2020 2020 290a 0a20 2020 2072 6574 7572      )..    retur
-0000d620: 6e20 6c61 7374 2e67 6574 5f6f 7574 7075  n last.get_outpu
-0000d630: 745f 7363 6865 6d61 2863 6f6e 6669 6729  t_schema(config)
-0000d640: 0a0a 0a63 6c61 7373 2052 756e 6e61 626c  ...class Runnabl
-0000d650: 6553 6571 7565 6e63 6528 5275 6e6e 6162  eSequence(Runnab
-0000d660: 6c65 5365 7269 616c 697a 6162 6c65 5b49  leSerializable[I
-0000d670: 6e70 7574 2c20 4f75 7470 7574 5d29 3a0a  nput, Output]):.
-0000d680: 2020 2020 2222 2241 2073 6571 7565 6e63      """A sequenc
-0000d690: 6520 6f66 2072 756e 6e61 626c 6573 2c20  e of runnables, 
-0000d6a0: 7768 6572 6520 7468 6520 6f75 7470 7574  where the output
-0000d6b0: 206f 6620 6561 6368 2069 7320 7468 6520   of each is the 
-0000d6c0: 696e 7075 7420 6f66 2074 6865 206e 6578  input of the nex
-0000d6d0: 742e 0a0a 2020 2020 5275 6e6e 6162 6c65  t...    Runnable
-0000d6e0: 5365 7175 656e 6365 2069 7320 7468 6520  Sequence is the 
-0000d6f0: 6d6f 7374 2069 6d70 6f72 7461 6e74 2063  most important c
-0000d700: 6f6d 706f 7369 7469 6f6e 206f 7065 7261  omposition opera
-0000d710: 746f 7220 696e 204c 616e 6743 6861 696e  tor in LangChain
-0000d720: 2061 7320 6974 2069 730a 2020 2020 7573   as it is.    us
-0000d730: 6564 2069 6e20 7669 7274 7561 6c6c 7920  ed in virtually 
-0000d740: 6576 6572 7920 6368 6169 6e2e 0a0a 2020  every chain...  
-0000d750: 2020 4120 5275 6e6e 6162 6c65 5365 7175    A RunnableSequ
-0000d760: 656e 6365 2063 616e 2062 6520 696e 7374  ence can be inst
-0000d770: 616e 7469 6174 6564 2064 6972 6563 746c  antiated directl
-0000d780: 7920 6f72 206d 6f72 6520 636f 6d6d 6f6e  y or more common
-0000d790: 6c79 2062 7920 7573 696e 6720 7468 6520  ly by using the 
-0000d7a0: 607c 600a 2020 2020 6f70 6572 6174 6f72  `|`.    operator
-0000d7b0: 2077 6865 7265 2065 6974 6865 7220 7468   where either th
-0000d7c0: 6520 6c65 6674 206f 7220 7269 6768 7420  e left or right 
-0000d7d0: 6f70 6572 616e 6473 2028 6f72 2062 6f74  operands (or bot
-0000d7e0: 6829 206d 7573 7420 6265 2061 2052 756e  h) must be a Run
-0000d7f0: 6e61 626c 652e 0a0a 2020 2020 416e 7920  nable...    Any 
-0000d800: 5275 6e6e 6162 6c65 5365 7175 656e 6365  RunnableSequence
-0000d810: 2061 7574 6f6d 6174 6963 616c 6c79 2073   automatically s
-0000d820: 7570 706f 7274 7320 7379 6e63 2c20 6173  upports sync, as
-0000d830: 796e 632c 2062 6174 6368 2e0a 0a20 2020  ync, batch...   
-0000d840: 2054 6865 2064 6566 6175 6c74 2069 6d70   The default imp
-0000d850: 6c65 6d65 6e74 6174 696f 6e73 206f 6620  lementations of 
-0000d860: 6062 6174 6368 6020 616e 6420 6061 6261  `batch` and `aba
-0000d870: 7463 6860 2075 7469 6c69 7a65 2074 6872  tch` utilize thr
-0000d880: 6561 6470 6f6f 6c73 2061 6e64 0a20 2020  eadpools and.   
-0000d890: 2061 7379 6e63 696f 2067 6174 6865 7220   asyncio gather 
-0000d8a0: 616e 6420 7769 6c6c 2062 6520 6661 7374  and will be fast
-0000d8b0: 6572 2074 6861 6e20 6e61 6976 6520 696e  er than naive in
-0000d8c0: 766f 6361 7469 6f6e 206f 6620 696e 766f  vocation of invo
-0000d8d0: 6b65 206f 7220 6169 6e76 6f6b 650a 2020  ke or ainvoke.  
-0000d8e0: 2020 666f 7220 494f 2062 6f75 6e64 2072    for IO bound r
-0000d8f0: 756e 6e61 626c 6573 2e0a 0a20 2020 2042  unnables...    B
-0000d900: 6174 6368 696e 6720 6973 2069 6d70 6c65  atching is imple
-0000d910: 6d65 6e74 6564 2062 7920 696e 766f 6b69  mented by invoki
-0000d920: 6e67 2074 6865 2062 6174 6368 206d 6574  ng the batch met
-0000d930: 686f 6420 6f6e 2065 6163 6820 636f 6d70  hod on each comp
-0000d940: 6f6e 656e 7420 6f66 2074 6865 0a20 2020  onent of the.   
-0000d950: 2052 756e 6e61 626c 6553 6571 7565 6e63   RunnableSequenc
-0000d960: 6520 696e 206f 7264 6572 2e0a 0a20 2020  e in order...   
-0000d970: 2041 2052 756e 6e61 626c 6553 6571 7565   A RunnableSeque
-0000d980: 6e63 6520 7072 6573 6572 7665 7320 7468  nce preserves th
-0000d990: 6520 7374 7265 616d 696e 6720 7072 6f70  e streaming prop
-0000d9a0: 6572 7469 6573 206f 6620 6974 7320 636f  erties of its co
-0000d9b0: 6d70 6f6e 656e 7473 2c20 736f 2069 6620  mponents, so if 
-0000d9c0: 616c 6c0a 2020 2020 636f 6d70 6f6e 656e  all.    componen
-0000d9d0: 7473 206f 6620 7468 6520 7365 7175 656e  ts of the sequen
-0000d9e0: 6365 2069 6d70 6c65 6d65 6e74 2061 2060  ce implement a `
-0000d9f0: 7472 616e 7366 6f72 6d60 206d 6574 686f  transform` metho
-0000da00: 6420 2d2d 2077 6869 6368 0a20 2020 2069  d -- which.    i
-0000da10: 7320 7468 6520 6d65 7468 6f64 2074 6861  s the method tha
-0000da20: 7420 696d 706c 656d 656e 7473 2074 6865  t implements the
-0000da30: 206c 6f67 6963 2074 6f20 6d61 7020 6120   logic to map a 
-0000da40: 7374 7265 616d 696e 6720 696e 7075 7420  streaming input 
-0000da50: 746f 2061 2073 7472 6561 6d69 6e67 0a20  to a streaming. 
-0000da60: 2020 206f 7574 7075 7420 2d2d 2074 6865     output -- the
-0000da70: 6e20 7468 6520 7365 7175 656e 6365 2077  n the sequence w
-0000da80: 696c 6c20 6265 2061 626c 6520 746f 2073  ill be able to s
-0000da90: 7472 6561 6d20 696e 7075 7420 746f 206f  tream input to o
-0000daa0: 7574 7075 7421 0a0a 2020 2020 4966 2061  utput!..    If a
-0000dab0: 6e79 2063 6f6d 706f 6e65 6e74 206f 6620  ny component of 
-0000dac0: 7468 6520 7365 7175 656e 6365 2064 6f65  the sequence doe
-0000dad0: 7320 6e6f 7420 696d 706c 656d 656e 7420  s not implement 
-0000dae0: 7472 616e 7366 6f72 6d20 7468 656e 2074  transform then t
-0000daf0: 6865 0a20 2020 2073 7472 6561 6d69 6e67  he.    streaming
-0000db00: 2077 696c 6c20 6f6e 6c79 2062 6567 696e   will only begin
-0000db10: 2061 6674 6572 2074 6869 7320 636f 6d70   after this comp
-0000db20: 6f6e 656e 7420 6973 2072 756e 2e20 4966  onent is run. If
-0000db30: 2074 6865 7265 2061 7265 0a20 2020 206d   there are.    m
-0000db40: 756c 7469 706c 6520 626c 6f63 6b69 6e67  ultiple blocking
-0000db50: 2063 6f6d 706f 6e65 6e74 732c 2073 7472   components, str
-0000db60: 6561 6d69 6e67 2062 6567 696e 7320 6166  eaming begins af
-0000db70: 7465 7220 7468 6520 6c61 7374 206f 6e65  ter the last one
-0000db80: 2e0a 0a20 2020 2050 6c65 6173 6520 6e6f  ...    Please no
-0000db90: 7465 3a20 5275 6e6e 6162 6c65 4c61 6d62  te: RunnableLamb
-0000dba0: 6461 7320 646f 206e 6f74 2073 7570 706f  das do not suppo
-0000dbb0: 7274 2060 7472 616e 7366 6f72 6d60 2062  rt `transform` b
-0000dbc0: 7920 6465 6661 756c 7421 2053 6f20 6966  y default! So if
-0000dbd0: 0a20 2020 2020 2020 2079 6f75 206e 6565  .        you nee
-0000dbe0: 6420 746f 2075 7365 2061 2052 756e 6e61  d to use a Runna
-0000dbf0: 626c 654c 616d 6264 6173 2062 6520 6361  bleLambdas be ca
-0000dc00: 7265 6675 6c20 6162 6f75 7420 7768 6572  reful about wher
-0000dc10: 6520 796f 7520 706c 6163 6520 7468 656d  e you place them
-0000dc20: 2069 6e20 610a 2020 2020 2020 2020 5275   in a.        Ru
-0000dc30: 6e6e 6162 6c65 5365 7175 656e 6365 2028  nnableSequence (
-0000dc40: 6966 2079 6f75 206e 6565 6420 746f 2075  if you need to u
-0000dc50: 7365 2074 6865 202e 7374 7265 616d 2829  se the .stream()
-0000dc60: 2f2e 6173 7472 6561 6d28 2920 6d65 7468  /.astream() meth
-0000dc70: 6f64 7329 2e0a 0a20 2020 2020 2020 2049  ods)...        I
-0000dc80: 6620 796f 7520 6e65 6564 2061 7262 6974  f you need arbit
-0000dc90: 7261 7279 206c 6f67 6963 2061 6e64 206e  rary logic and n
-0000dca0: 6565 6420 7374 7265 616d 696e 672c 2079  eed streaming, y
-0000dcb0: 6f75 2063 616e 2073 7562 636c 6173 730a  ou can subclass.
-0000dcc0: 2020 2020 2020 2020 5275 6e6e 6162 6c65          Runnable
-0000dcd0: 2c20 616e 6420 696d 706c 656d 656e 7420  , and implement 
-0000dce0: 6074 7261 6e73 666f 726d 6020 666f 7220  `transform` for 
-0000dcf0: 7768 6174 6576 6572 206c 6f67 6963 2079  whatever logic y
-0000dd00: 6f75 206e 6565 642e 0a0a 2020 2020 4865  ou need...    He
-0000dd10: 7265 2069 7320 6120 7369 6d70 6c65 2065  re is a simple e
-0000dd20: 7861 6d70 6c65 2074 6861 7420 7573 6573  xample that uses
-0000dd30: 2073 696d 706c 6520 6675 6e63 7469 6f6e   simple function
-0000dd40: 7320 746f 2069 6c6c 7573 7472 6174 6520  s to illustrate 
-0000dd50: 7468 6520 7573 6520 6f66 0a20 2020 2052  the use of.    R
-0000dd60: 756e 6e61 626c 6553 6571 7565 6e63 653a  unnableSequence:
-0000dd70: 0a0a 2020 2020 2020 2020 2e2e 2063 6f64  ..        .. cod
-0000dd80: 652d 626c 6f63 6b3a 3a20 7079 7468 6f6e  e-block:: python
-0000dd90: 0a0a 2020 2020 2020 2020 2020 2020 6672  ..            fr
-0000dda0: 6f6d 206c 616e 6763 6861 696e 5f63 6f72  om langchain_cor
-0000ddb0: 652e 7275 6e6e 6162 6c65 7320 696d 706f  e.runnables impo
-0000ddc0: 7274 2052 756e 6e61 626c 654c 616d 6264  rt RunnableLambd
-0000ddd0: 610a 0a20 2020 2020 2020 2020 2020 2064  a..            d
-0000dde0: 6566 2061 6464 5f6f 6e65 2878 3a20 696e  ef add_one(x: in
-0000ddf0: 7429 202d 3e20 696e 743a 0a20 2020 2020  t) -> int:.     
-0000de00: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000de10: 6e20 7820 2b20 310a 0a20 2020 2020 2020  n x + 1..       
-0000de20: 2020 2020 2064 6566 206d 756c 5f74 776f       def mul_two
-0000de30: 2878 3a20 696e 7429 202d 3e20 696e 743a  (x: int) -> int:
-0000de40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000de50: 2072 6574 7572 6e20 7820 2a20 320a 0a20   return x * 2.. 
-0000de60: 2020 2020 2020 2020 2020 2072 756e 6e61             runna
-0000de70: 626c 655f 3120 3d20 5275 6e6e 6162 6c65  ble_1 = Runnable
-0000de80: 4c61 6d62 6461 2861 6464 5f6f 6e65 290a  Lambda(add_one).
-0000de90: 2020 2020 2020 2020 2020 2020 7275 6e6e              runn
-0000dea0: 6162 6c65 5f32 203d 2052 756e 6e61 626c  able_2 = Runnabl
-0000deb0: 654c 616d 6264 6128 6d75 6c5f 7477 6f29  eLambda(mul_two)
-0000dec0: 0a20 2020 2020 2020 2020 2020 2073 6571  .            seq
-0000ded0: 7565 6e63 6520 3d20 7275 6e6e 6162 6c65  uence = runnable
-0000dee0: 5f31 207c 2072 756e 6e61 626c 655f 320a  _1 | runnable_2.
-0000def0: 2020 2020 2020 2020 2020 2020 2320 4f72              # Or
-0000df00: 2065 7175 6976 616c 656e 746c 793a 0a20   equivalently:. 
-0000df10: 2020 2020 2020 2020 2020 2023 2073 6571             # seq
-0000df20: 7565 6e63 6520 3d20 5275 6e6e 6162 6c65  uence = Runnable
-0000df30: 5365 7175 656e 6365 2866 6972 7374 3d72  Sequence(first=r
-0000df40: 756e 6e61 626c 655f 312c 206c 6173 743d  unnable_1, last=
-0000df50: 7275 6e6e 6162 6c65 5f32 290a 2020 2020  runnable_2).    
-0000df60: 2020 2020 2020 2020 7365 7175 656e 6365          sequence
-0000df70: 2e69 6e76 6f6b 6528 3129 0a20 2020 2020  .invoke(1).     
-0000df80: 2020 2020 2020 2061 7761 6974 2072 756e         await run
-0000df90: 6e61 626c 652e 6169 6e76 6f6b 6528 3129  nable.ainvoke(1)
-0000dfa0: 0a0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-0000dfb0: 7175 656e 6365 2e62 6174 6368 285b 312c  quence.batch([1,
-0000dfc0: 2032 2c20 335d 290a 2020 2020 2020 2020   2, 3]).        
-0000dfd0: 2020 2020 6177 6169 7420 7365 7175 656e      await sequen
-0000dfe0: 6365 2e61 6261 7463 6828 5b31 2c20 322c  ce.abatch([1, 2,
-0000dff0: 2033 5d29 0a0a 2020 2020 4865 7265 2773   3])..    Here's
-0000e000: 2061 6e20 6578 616d 706c 6520 7468 6174   an example that
-0000e010: 2075 7365 7320 7374 7265 616d 7320 4a53   uses streams JS
-0000e020: 4f4e 206f 7574 7075 7420 6765 6e65 7261  ON output genera
-0000e030: 7465 6420 6279 2061 6e20 4c4c 4d3a 0a0a  ted by an LLM:..
-0000e040: 2020 2020 2020 2020 2e2e 2063 6f64 652d          .. code-
-0000e050: 626c 6f63 6b3a 3a20 7079 7468 6f6e 0a0a  block:: python..
-0000e060: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
-0000e070: 206c 616e 6763 6861 696e 5f63 6f72 652e   langchain_core.
-0000e080: 6f75 7470 7574 5f70 6172 7365 7273 2e6a  output_parsers.j
-0000e090: 736f 6e20 696d 706f 7274 2053 696d 706c  son import Simpl
-0000e0a0: 654a 736f 6e4f 7574 7075 7450 6172 7365  eJsonOutputParse
-0000e0b0: 720a 2020 2020 2020 2020 2020 2020 6672  r.            fr
-0000e0c0: 6f6d 206c 616e 6763 6861 696e 5f6f 7065  om langchain_ope
-0000e0d0: 6e61 6920 696d 706f 7274 2043 6861 744f  nai import ChatO
-0000e0e0: 7065 6e41 490a 0a20 2020 2020 2020 2020  penAI..         
-0000e0f0: 2020 2070 726f 6d70 7420 3d20 5072 6f6d     prompt = Prom
-0000e100: 7074 5465 6d70 6c61 7465 2e66 726f 6d5f  ptTemplate.from_
-0000e110: 7465 6d70 6c61 7465 280a 2020 2020 2020  template(.      
-0000e120: 2020 2020 2020 2020 2020 2749 6e20 4a53            'In JS
-0000e130: 4f4e 2066 6f72 6d61 742c 2067 6976 6520  ON format, give 
-0000e140: 6d65 2061 206c 6973 7420 6f66 207b 746f  me a list of {to
-0000e150: 7069 637d 2061 6e64 2074 6865 6972 2027  pic} and their '
-0000e160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e170: 2027 636f 7272 6573 706f 6e64 696e 6720   'corresponding 
-0000e180: 6e61 6d65 7320 696e 2046 7265 6e63 682c  names in French,
-0000e190: 2053 7061 6e69 7368 2061 6e64 2069 6e20   Spanish and in 
-0000e1a0: 6120 270a 2020 2020 2020 2020 2020 2020  a '.            
-0000e1b0: 2020 2020 2743 6174 204c 616e 6775 6167      'Cat Languag
-0000e1c0: 652e 270a 2020 2020 2020 2020 2020 2020  e.'.            
-0000e1d0: 290a 0a20 2020 2020 2020 2020 2020 206d  )..            m
-0000e1e0: 6f64 656c 203d 2043 6861 744f 7065 6e41  odel = ChatOpenA
-0000e1f0: 4928 290a 2020 2020 2020 2020 2020 2020  I().            
-0000e200: 6368 6169 6e20 3d20 7072 6f6d 7074 207c  chain = prompt |
-0000e210: 206d 6f64 656c 207c 2053 696d 706c 654a   model | SimpleJ
-0000e220: 736f 6e4f 7574 7075 7450 6172 7365 7228  sonOutputParser(
-0000e230: 290a 0a20 2020 2020 2020 2020 2020 2061  )..            a
-0000e240: 7379 6e63 2066 6f72 2063 6875 6e6b 2069  sync for chunk i
-0000e250: 6e20 6368 6169 6e2e 6173 7472 6561 6d28  n chain.astream(
-0000e260: 7b27 746f 7069 6327 3a20 2763 6f6c 6f72  {'topic': 'color
-0000e270: 7327 7d29 3a0a 2020 2020 2020 2020 2020  s'}):.          
-0000e280: 2020 2020 2020 7072 696e 7428 272d 2729        print('-')
-0000e290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e2a0: 2070 7269 6e74 2863 6875 6e6b 2c20 7365   print(chunk, se
-0000e2b0: 703d 2727 2c20 666c 7573 683d 5472 7565  p='', flush=True
-0000e2c0: 290a 2020 2020 2222 220a 0a20 2020 2023  ).    """..    #
-0000e2d0: 2054 6865 2073 7465 7073 2061 7265 2062   The steps are b
-0000e2e0: 726f 6b65 6e20 696e 746f 2066 6972 7374  roken into first
-0000e2f0: 2c20 6d69 6464 6c65 2061 6e64 206c 6173  , middle and las
-0000e300: 742c 2073 6f6c 656c 7920 666f 7220 7479  t, solely for ty
-0000e310: 7065 2063 6865 636b 696e 670a 2020 2020  pe checking.    
-0000e320: 2320 7075 7270 6f73 6573 2e20 4974 2061  # purposes. It a
-0000e330: 6c6c 6f77 7320 7370 6563 6966 7969 6e67  llows specifying
-0000e340: 2074 6865 2060 496e 7075 7460 206f 6e20   the `Input` on 
-0000e350: 7468 6520 6669 7273 7420 7479 7065 2c20  the first type, 
-0000e360: 7468 6520 604f 7574 7075 7460 206f 660a  the `Output` of.
-0000e370: 2020 2020 2320 7468 6520 6c61 7374 2074      # the last t
-0000e380: 7970 652e 0a20 2020 2066 6972 7374 3a20  ype..    first: 
-0000e390: 5275 6e6e 6162 6c65 5b49 6e70 7574 2c20  Runnable[Input, 
-0000e3a0: 416e 795d 0a20 2020 2022 2222 5468 6520  Any].    """The 
-0000e3b0: 6669 7273 7420 7275 6e6e 6162 6c65 2069  first runnable i
-0000e3c0: 6e20 7468 6520 7365 7175 656e 6365 2e22  n the sequence."
-0000e3d0: 2222 0a20 2020 206d 6964 646c 653a 204c  "".    middle: L
-0000e3e0: 6973 745b 5275 6e6e 6162 6c65 5b41 6e79  ist[Runnable[Any
-0000e3f0: 2c20 416e 795d 5d20 3d20 4669 656c 6428  , Any]] = Field(
-0000e400: 6465 6661 756c 745f 6661 6374 6f72 793d  default_factory=
-0000e410: 6c69 7374 290a 2020 2020 2222 2254 6865  list).    """The
-0000e420: 206d 6964 646c 6520 7275 6e6e 6162 6c65   middle runnable
-0000e430: 7320 696e 2074 6865 2073 6571 7565 6e63  s in the sequenc
-0000e440: 652e 2222 220a 2020 2020 6c61 7374 3a20  e.""".    last: 
-0000e450: 5275 6e6e 6162 6c65 5b41 6e79 2c20 4f75  Runnable[Any, Ou
-0000e460: 7470 7574 5d0a 2020 2020 2222 2254 6865  tput].    """The
-0000e470: 206c 6173 7420 7275 6e6e 6162 6c65 2069   last runnable i
-0000e480: 6e20 7468 6520 7365 7175 656e 6365 2e22  n the sequence."
-0000e490: 2222 0a0a 2020 2020 6465 6620 5f5f 696e  ""..    def __in
-0000e4a0: 6974 5f5f 280a 2020 2020 2020 2020 7365  it__(.        se
-0000e4b0: 6c66 2c0a 2020 2020 2020 2020 2a73 7465  lf,.        *ste
-0000e4c0: 7073 3a20 5275 6e6e 6162 6c65 4c69 6b65  ps: RunnableLike
-0000e4d0: 2c0a 2020 2020 2020 2020 6e61 6d65 3a20  ,.        name: 
-0000e4e0: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
-0000e4f0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6669  None,.        fi
-0000e500: 7273 743a 204f 7074 696f 6e61 6c5b 5275  rst: Optional[Ru
-0000e510: 6e6e 6162 6c65 5b41 6e79 2c20 416e 795d  nnable[Any, Any]
-0000e520: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-0000e530: 2020 6d69 6464 6c65 3a20 4f70 7469 6f6e    middle: Option
-0000e540: 616c 5b4c 6973 745b 5275 6e6e 6162 6c65  al[List[Runnable
-0000e550: 5b41 6e79 2c20 416e 795d 5d5d 203d 204e  [Any, Any]]] = N
-0000e560: 6f6e 652c 0a20 2020 2020 2020 206c 6173  one,.        las
-0000e570: 743a 204f 7074 696f 6e61 6c5b 5275 6e6e  t: Optional[Runn
-0000e580: 6162 6c65 5b41 6e79 2c20 416e 795d 5d20  able[Any, Any]] 
-0000e590: 3d20 4e6f 6e65 2c0a 2020 2020 2920 2d3e  = None,.    ) ->
-0000e5a0: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-0000e5b0: 2222 4372 6561 7465 2061 206e 6577 2052  ""Create a new R
-0000e5c0: 756e 6e61 626c 6553 6571 7565 6e63 652e  unnableSequence.
-0000e5d0: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
-0000e5e0: 2020 2020 2020 2020 2020 2020 7374 6570              step
-0000e5f0: 733a 2054 6865 2073 7465 7073 2074 6f20  s: The steps to 
-0000e600: 696e 636c 7564 6520 696e 2074 6865 2073  include in the s
-0000e610: 6571 7565 6e63 652e 0a20 2020 2020 2020  equence..       
-0000e620: 2022 2222 0a20 2020 2020 2020 2073 7465   """.        ste
-0000e630: 7073 5f66 6c61 743a 204c 6973 745b 5275  ps_flat: List[Ru
-0000e640: 6e6e 6162 6c65 5d20 3d20 5b5d 0a20 2020  nnable] = [].   
-0000e650: 2020 2020 2069 6620 6e6f 7420 7374 6570       if not step
-0000e660: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
-0000e670: 6620 6669 7273 7420 6973 206e 6f74 204e  f first is not N
-0000e680: 6f6e 6520 616e 6420 6c61 7374 2069 7320  one and last is 
-0000e690: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0000e6a0: 2020 2020 2020 2020 2020 7374 6570 735f            steps_
-0000e6b0: 666c 6174 203d 205b 6669 7273 745d 202b  flat = [first] +
-0000e6c0: 2028 6d69 6464 6c65 206f 7220 5b5d 2920   (middle or []) 
-0000e6d0: 2b20 5b6c 6173 745d 0a20 2020 2020 2020  + [last].       
-0000e6e0: 2066 6f72 2073 7465 7020 696e 2073 7465   for step in ste
-0000e6f0: 7073 3a0a 2020 2020 2020 2020 2020 2020  ps:.            
-0000e700: 6966 2069 7369 6e73 7461 6e63 6528 7374  if isinstance(st
-0000e710: 6570 2c20 5275 6e6e 6162 6c65 5365 7175  ep, RunnableSequ
-0000e720: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
-0000e730: 2020 2020 2020 2073 7465 7073 5f66 6c61         steps_fla
-0000e740: 742e 6578 7465 6e64 2873 7465 702e 7374  t.extend(step.st
-0000e750: 6570 7329 0a20 2020 2020 2020 2020 2020  eps).           
-0000e760: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000e770: 2020 2020 2020 2073 7465 7073 5f66 6c61         steps_fla
-0000e780: 742e 6170 7065 6e64 2863 6f65 7263 655f  t.append(coerce_
-0000e790: 746f 5f72 756e 6e61 626c 6528 7374 6570  to_runnable(step
-0000e7a0: 2929 0a20 2020 2020 2020 2069 6620 6c65  )).        if le
-0000e7b0: 6e28 7374 6570 735f 666c 6174 2920 3c20  n(steps_flat) < 
-0000e7c0: 323a 0a20 2020 2020 2020 2020 2020 2072  2:.            r
-0000e7d0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-0000e7e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e7f0: 2066 2252 756e 6e61 626c 6553 6571 7565   f"RunnableSeque
-0000e800: 6e63 6520 6d75 7374 2068 6176 6520 6174  nce must have at
-0000e810: 206c 6561 7374 2032 2073 7465 7073 2c20   least 2 steps, 
-0000e820: 676f 7420 7b6c 656e 2873 7465 7073 5f66  got {len(steps_f
-0000e830: 6c61 7429 7d22 0a20 2020 2020 2020 2020  lat)}".         
-0000e840: 2020 2029 0a20 2020 2020 2020 2073 7570     ).        sup
-0000e850: 6572 2829 2e5f 5f69 6e69 745f 5f28 0a20  er().__init__(. 
-0000e860: 2020 2020 2020 2020 2020 2066 6972 7374             first
-0000e870: 3d73 7465 7073 5f66 6c61 745b 305d 2c0a  =steps_flat[0],.
-0000e880: 2020 2020 2020 2020 2020 2020 6d69 6464              midd
-0000e890: 6c65 3d6c 6973 7428 7374 6570 735f 666c  le=list(steps_fl
-0000e8a0: 6174 5b31 3a2d 315d 292c 0a20 2020 2020  at[1:-1]),.     
-0000e8b0: 2020 2020 2020 206c 6173 743d 7374 6570         last=step
-0000e8c0: 735f 666c 6174 5b2d 315d 2c0a 2020 2020  s_flat[-1],.    
-0000e8d0: 2020 2020 2020 2020 6e61 6d65 3d6e 616d          name=nam
-0000e8e0: 652c 0a20 2020 2020 2020 2029 0a0a 2020  e,.        )..  
-0000e8f0: 2020 4063 6c61 7373 6d65 7468 6f64 0a20    @classmethod. 
-0000e900: 2020 2064 6566 2067 6574 5f6c 635f 6e61     def get_lc_na
-0000e910: 6d65 7370 6163 6528 636c 7329 202d 3e20  mespace(cls) -> 
-0000e920: 4c69 7374 5b73 7472 5d3a 0a20 2020 2020  List[str]:.     
-0000e930: 2020 2022 2222 4765 7420 7468 6520 6e61     """Get the na
-0000e940: 6d65 7370 6163 6520 6f66 2074 6865 206c  mespace of the l
-0000e950: 616e 6763 6861 696e 206f 626a 6563 742e  angchain object.
-0000e960: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
-0000e970: 726e 205b 226c 616e 6763 6861 696e 222c  rn ["langchain",
-0000e980: 2022 7363 6865 6d61 222c 2022 7275 6e6e   "schema", "runn
-0000e990: 6162 6c65 225d 0a0a 2020 2020 4070 726f  able"]..    @pro
-0000e9a0: 7065 7274 790a 2020 2020 6465 6620 7374  perty.    def st
-0000e9b0: 6570 7328 7365 6c66 2920 2d3e 204c 6973  eps(self) -> Lis
-0000e9c0: 745b 5275 6e6e 6162 6c65 5b41 6e79 2c20  t[Runnable[Any, 
-0000e9d0: 416e 795d 5d3a 0a20 2020 2020 2020 2022  Any]]:.        "
-0000e9e0: 2222 416c 6c20 7468 6520 7275 6e6e 6162  ""All the runnab
-0000e9f0: 6c65 7320 7468 6174 206d 616b 6520 7570  les that make up
-0000ea00: 2074 6865 2073 6571 7565 6e63 6520 696e   the sequence in
-0000ea10: 206f 7264 6572 2e22 2222 0a20 2020 2020   order.""".     
-0000ea20: 2020 2072 6574 7572 6e20 5b73 656c 662e     return [self.
-0000ea30: 6669 7273 745d 202b 2073 656c 662e 6d69  first] + self.mi
-0000ea40: 6464 6c65 202b 205b 7365 6c66 2e6c 6173  ddle + [self.las
-0000ea50: 745d 0a0a 2020 2020 4063 6c61 7373 6d65  t]..    @classme
-0000ea60: 7468 6f64 0a20 2020 2064 6566 2069 735f  thod.    def is_
-0000ea70: 6c63 5f73 6572 6961 6c69 7a61 626c 6528  lc_serializable(
-0000ea80: 636c 7329 202d 3e20 626f 6f6c 3a0a 2020  cls) -> bool:.  
-0000ea90: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
-0000eaa0: 650a 0a20 2020 2063 6c61 7373 2043 6f6e  e..    class Con
-0000eab0: 6669 673a 0a20 2020 2020 2020 2061 7262  fig:.        arb
-0000eac0: 6974 7261 7279 5f74 7970 6573 5f61 6c6c  itrary_types_all
-0000ead0: 6f77 6564 203d 2054 7275 650a 0a20 2020  owed = True..   
-0000eae0: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-0000eaf0: 6566 2049 6e70 7574 5479 7065 2873 656c  ef InputType(sel
-0000eb00: 6629 202d 3e20 5479 7065 5b49 6e70 7574  f) -> Type[Input
-0000eb10: 5d3a 0a20 2020 2020 2020 2072 6574 7572  ]:.        retur
-0000eb20: 6e20 7365 6c66 2e66 6972 7374 2e49 6e70  n self.first.Inp
-0000eb30: 7574 5479 7065 0a0a 2020 2020 4070 726f  utType..    @pro
-0000eb40: 7065 7274 790a 2020 2020 6465 6620 4f75  perty.    def Ou
-0000eb50: 7470 7574 5479 7065 2873 656c 6629 202d  tputType(self) -
-0000eb60: 3e20 5479 7065 5b4f 7574 7075 745d 3a0a  > Type[Output]:.
-0000eb70: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0000eb80: 656c 662e 6c61 7374 2e4f 7574 7075 7454  elf.last.OutputT
-0000eb90: 7970 650a 0a20 2020 2064 6566 2067 6574  ype..    def get
-0000eba0: 5f69 6e70 7574 5f73 6368 656d 6128 0a20  _input_schema(. 
-0000ebb0: 2020 2020 2020 2073 656c 662c 2063 6f6e         self, con
-0000ebc0: 6669 673a 204f 7074 696f 6e61 6c5b 5275  fig: Optional[Ru
-0000ebd0: 6e6e 6162 6c65 436f 6e66 6967 5d20 3d20  nnableConfig] = 
-0000ebe0: 4e6f 6e65 0a20 2020 2029 202d 3e20 5479  None.    ) -> Ty
-0000ebf0: 7065 5b42 6173 654d 6f64 656c 5d3a 0a20  pe[BaseModel]:. 
-0000ec00: 2020 2020 2020 2072 6574 7572 6e20 5f73         return _s
-0000ec10: 6571 5f69 6e70 7574 5f73 6368 656d 6128  eq_input_schema(
-0000ec20: 7365 6c66 2e73 7465 7073 2c20 636f 6e66  self.steps, conf
-0000ec30: 6967 290a 0a20 2020 2064 6566 2067 6574  ig)..    def get
-0000ec40: 5f6f 7574 7075 745f 7363 6865 6d61 280a  _output_schema(.
-0000ec50: 2020 2020 2020 2020 7365 6c66 2c20 636f          self, co
-0000ec60: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
-0000ec70: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
-0000ec80: 204e 6f6e 650a 2020 2020 2920 2d3e 2054   None.    ) -> T
-0000ec90: 7970 655b 4261 7365 4d6f 6465 6c5d 3a0a  ype[BaseModel]:.
-0000eca0: 2020 2020 2020 2020 7265 7475 726e 205f          return _
-0000ecb0: 7365 715f 6f75 7470 7574 5f73 6368 656d  seq_output_schem
-0000ecc0: 6128 7365 6c66 2e73 7465 7073 2c20 636f  a(self.steps, co
-0000ecd0: 6e66 6967 290a 0a20 2020 2040 7072 6f70  nfig)..    @prop
-0000ece0: 6572 7479 0a20 2020 2064 6566 2063 6f6e  erty.    def con
-0000ecf0: 6669 675f 7370 6563 7328 7365 6c66 2920  fig_specs(self) 
-0000ed00: 2d3e 204c 6973 745b 436f 6e66 6967 7572  -> List[Configur
-0000ed10: 6162 6c65 4669 656c 6453 7065 635d 3a0a  ableFieldSpec]:.
-0000ed20: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
-0000ed30: 6763 6861 696e 5f63 6f72 652e 6265 7461  gchain_core.beta
-0000ed40: 2e72 756e 6e61 626c 6573 2e63 6f6e 7465  .runnables.conte
-0000ed50: 7874 2069 6d70 6f72 7420 280a 2020 2020  xt import (.    
-0000ed60: 2020 2020 2020 2020 434f 4e54 4558 545f          CONTEXT_
-0000ed70: 434f 4e46 4947 5f50 5245 4649 582c 0a20  CONFIG_PREFIX,. 
-0000ed80: 2020 2020 2020 2020 2020 205f 6b65 795f             _key_
-0000ed90: 6672 6f6d 5f69 642c 0a20 2020 2020 2020  from_id,.       
-0000eda0: 2029 0a0a 2020 2020 2020 2020 2320 6765   )..        # ge
-0000edb0: 7420 616c 6c20 7370 6563 730a 2020 2020  t all specs.    
-0000edc0: 2020 2020 616c 6c5f 7370 6563 7320 3d20      all_specs = 
-0000edd0: 5b0a 2020 2020 2020 2020 2020 2020 2873  [.            (s
-0000ede0: 7065 632c 2069 6478 290a 2020 2020 2020  pec, idx).      
-0000edf0: 2020 2020 2020 666f 7220 6964 782c 2073        for idx, s
-0000ee00: 7465 7020 696e 2065 6e75 6d65 7261 7465  tep in enumerate
-0000ee10: 2873 656c 662e 7374 6570 7329 0a20 2020  (self.steps).   
-0000ee20: 2020 2020 2020 2020 2066 6f72 2073 7065           for spe
-0000ee30: 6320 696e 2073 7465 702e 636f 6e66 6967  c in step.config
-0000ee40: 5f73 7065 6373 0a20 2020 2020 2020 205d  _specs.        ]
-0000ee50: 0a20 2020 2020 2020 2023 2063 616c 6375  .        # calcu
-0000ee60: 6c61 7465 2063 6f6e 7465 7874 2064 6570  late context dep
-0000ee70: 656e 6465 6e63 6965 730a 2020 2020 2020  endencies.      
-0000ee80: 2020 7370 6563 735f 6279 5f70 6f73 203d    specs_by_pos =
-0000ee90: 2067 726f 7570 6279 280a 2020 2020 2020   groupby(.      
-0000eea0: 2020 2020 2020 5b74 7570 2066 6f72 2074        [tup for t
-0000eeb0: 7570 2069 6e20 616c 6c5f 7370 6563 7320  up in all_specs 
-0000eec0: 6966 2074 7570 5b30 5d2e 6964 2e73 7461  if tup[0].id.sta
-0000eed0: 7274 7377 6974 6828 434f 4e54 4558 545f  rtswith(CONTEXT_
-0000eee0: 434f 4e46 4947 5f50 5245 4649 5829 5d2c  CONFIG_PREFIX)],
-0000eef0: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
-0000ef00: 6264 6120 783a 2078 5b31 5d2c 0a20 2020  bda x: x[1],.   
-0000ef10: 2020 2020 2029 0a20 2020 2020 2020 206e       ).        n
-0000ef20: 6578 745f 6465 7073 3a20 5365 745b 7374  ext_deps: Set[st
-0000ef30: 725d 203d 2073 6574 2829 0a20 2020 2020  r] = set().     
-0000ef40: 2020 2064 6570 735f 6279 5f70 6f73 3a20     deps_by_pos: 
-0000ef50: 4469 6374 5b69 6e74 2c20 5365 745b 7374  Dict[int, Set[st
-0000ef60: 725d 5d20 3d20 7b7d 0a20 2020 2020 2020  r]] = {}.       
-0000ef70: 2066 6f72 2070 6f73 2c20 7370 6563 7320   for pos, specs 
-0000ef80: 696e 2073 7065 6373 5f62 795f 706f 733a  in specs_by_pos:
-0000ef90: 0a20 2020 2020 2020 2020 2020 2064 6570  .            dep
-0000efa0: 735f 6279 5f70 6f73 5b70 6f73 5d20 3d20  s_by_pos[pos] = 
-0000efb0: 6e65 7874 5f64 6570 730a 2020 2020 2020  next_deps.      
-0000efc0: 2020 2020 2020 6e65 7874 5f64 6570 7320        next_deps 
-0000efd0: 3d20 6e65 7874 5f64 6570 7320 7c20 7b73  = next_deps | {s
-0000efe0: 7065 635b 305d 2e69 6420 666f 7220 7370  pec[0].id for sp
-0000eff0: 6563 2069 6e20 7370 6563 737d 0a20 2020  ec in specs}.   
-0000f000: 2020 2020 2023 2061 7373 6967 6e20 636f       # assign co
-0000f010: 6e74 6578 7420 6465 7065 6e64 656e 6369  ntext dependenci
-0000f020: 6573 0a20 2020 2020 2020 2066 6f72 2070  es.        for p
-0000f030: 6f73 2c20 2873 7065 632c 2069 6478 2920  os, (spec, idx) 
-0000f040: 696e 2065 6e75 6d65 7261 7465 2861 6c6c  in enumerate(all
-0000f050: 5f73 7065 6373 293a 0a20 2020 2020 2020  _specs):.       
-0000f060: 2020 2020 2069 6620 7370 6563 2e69 642e       if spec.id.
-0000f070: 7374 6172 7473 7769 7468 2843 4f4e 5445  startswith(CONTE
-0000f080: 5854 5f43 4f4e 4649 475f 5052 4546 4958  XT_CONFIG_PREFIX
-0000f090: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000f0a0: 2020 2061 6c6c 5f73 7065 6373 5b70 6f73     all_specs[pos
-0000f0b0: 5d20 3d20 280a 2020 2020 2020 2020 2020  ] = (.          
-0000f0c0: 2020 2020 2020 2020 2020 436f 6e66 6967            Config
-0000f0d0: 7572 6162 6c65 4669 656c 6453 7065 6328  urableFieldSpec(
-0000f0e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f0f0: 2020 2020 2020 2020 2069 643d 7370 6563           id=spec
-0000f100: 2e69 642c 0a20 2020 2020 2020 2020 2020  .id,.           
-0000f110: 2020 2020 2020 2020 2020 2020 2061 6e6e               ann
-0000f120: 6f74 6174 696f 6e3d 7370 6563 2e61 6e6e  otation=spec.ann
-0000f130: 6f74 6174 696f 6e2c 0a20 2020 2020 2020  otation,.       
-0000f140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f150: 206e 616d 653d 7370 6563 2e6e 616d 652c   name=spec.name,
-0000f160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f170: 2020 2020 2020 2020 2064 6566 6175 6c74           default
-0000f180: 3d73 7065 632e 6465 6661 756c 742c 0a20  =spec.default,. 
-0000f190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f1a0: 2020 2020 2020 2064 6573 6372 6970 7469         descripti
-0000f1b0: 6f6e 3d73 7065 632e 6465 7363 7269 7074  on=spec.descript
-0000f1c0: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
-0000f1d0: 2020 2020 2020 2020 2020 2020 2069 735f               is_
-0000f1e0: 7368 6172 6564 3d73 7065 632e 6973 5f73  shared=spec.is_s
-0000f1f0: 6861 7265 642c 0a20 2020 2020 2020 2020  hared,.         
-0000f200: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0000f210: 6570 656e 6465 6e63 6965 733d 5b0a 2020  ependencies=[.  
-0000f220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f230: 2020 2020 2020 2020 2020 640a 2020 2020            d.    
-0000f240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f250: 2020 2020 2020 2020 666f 7220 6420 696e          for d in
-0000f260: 2064 6570 735f 6279 5f70 6f73 5b69 6478   deps_by_pos[idx
-0000f270: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0000f280: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000f290: 205f 6b65 795f 6672 6f6d 5f69 6428 6429   _key_from_id(d)
-0000f2a0: 2021 3d20 5f6b 6579 5f66 726f 6d5f 6964   != _key_from_id
-0000f2b0: 2873 7065 632e 6964 290a 2020 2020 2020  (spec.id).      
-0000f2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f2d0: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
-0000f2e0: 2020 2020 2020 2020 2020 2020 2b20 2873              + (s
-0000f2f0: 7065 632e 6465 7065 6e64 656e 6369 6573  pec.dependencies
-0000f300: 206f 7220 5b5d 292c 0a20 2020 2020 2020   or []),.       
-0000f310: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
-0000f320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f330: 2020 2020 6964 782c 0a20 2020 2020 2020      idx,.       
-0000f340: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0000f350: 2020 2020 7265 7475 726e 2067 6574 5f75      return get_u
-0000f360: 6e69 7175 655f 636f 6e66 6967 5f73 7065  nique_config_spe
-0000f370: 6373 2873 7065 6320 666f 7220 7370 6563  cs(spec for spec
-0000f380: 2c20 5f20 696e 2061 6c6c 5f73 7065 6373  , _ in all_specs
-0000f390: 290a 0a20 2020 2064 6566 2067 6574 5f67  )..    def get_g
-0000f3a0: 7261 7068 2873 656c 662c 2063 6f6e 6669  raph(self, confi
-0000f3b0: 673a 204f 7074 696f 6e61 6c5b 5275 6e6e  g: Optional[Runn
-0000f3c0: 6162 6c65 436f 6e66 6967 5d20 3d20 4e6f  ableConfig] = No
-0000f3d0: 6e65 2920 2d3e 2047 7261 7068 3a0a 2020  ne) -> Graph:.  
-0000f3e0: 2020 2020 2020 6672 6f6d 206c 616e 6763        from langc
-0000f3f0: 6861 696e 5f63 6f72 652e 7275 6e6e 6162  hain_core.runnab
-0000f400: 6c65 732e 6772 6170 6820 696d 706f 7274  les.graph import
-0000f410: 2047 7261 7068 0a0a 2020 2020 2020 2020   Graph..        
-0000f420: 6772 6170 6820 3d20 4772 6170 6828 290a  graph = Graph().
-0000f430: 2020 2020 2020 2020 666f 7220 7374 6570          for step
-0000f440: 2069 6e20 7365 6c66 2e73 7465 7073 3a0a   in self.steps:.
-0000f450: 2020 2020 2020 2020 2020 2020 6375 7272              curr
-0000f460: 656e 745f 6c61 7374 5f6e 6f64 6520 3d20  ent_last_node = 
-0000f470: 6772 6170 682e 6c61 7374 5f6e 6f64 6528  graph.last_node(
-0000f480: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
-0000f490: 6570 5f67 7261 7068 203d 2073 7465 702e  ep_graph = step.
-0000f4a0: 6765 745f 6772 6170 6828 636f 6e66 6967  get_graph(config
-0000f4b0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0000f4c0: 2073 7465 7020 6973 206e 6f74 2073 656c   step is not sel
-0000f4d0: 662e 6669 7273 743a 0a20 2020 2020 2020  f.first:.       
-0000f4e0: 2020 2020 2020 2020 2073 7465 705f 6772           step_gr
-0000f4f0: 6170 682e 7472 696d 5f66 6972 7374 5f6e  aph.trim_first_n
-0000f500: 6f64 6528 290a 2020 2020 2020 2020 2020  ode().          
-0000f510: 2020 6966 2073 7465 7020 6973 206e 6f74    if step is not
-0000f520: 2073 656c 662e 6c61 7374 3a0a 2020 2020   self.last:.    
-0000f530: 2020 2020 2020 2020 2020 2020 7374 6570              step
-0000f540: 5f67 7261 7068 2e74 7269 6d5f 6c61 7374  _graph.trim_last
-0000f550: 5f6e 6f64 6528 290a 2020 2020 2020 2020  _node().        
-0000f560: 2020 2020 6772 6170 682e 6578 7465 6e64      graph.extend
-0000f570: 2873 7465 705f 6772 6170 6829 0a20 2020  (step_graph).   
-0000f580: 2020 2020 2020 2020 2073 7465 705f 6669           step_fi
-0000f590: 7273 745f 6e6f 6465 203d 2073 7465 705f  rst_node = step_
-0000f5a0: 6772 6170 682e 6669 7273 745f 6e6f 6465  graph.first_node
-0000f5b0: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
-0000f5c0: 6620 6e6f 7420 7374 6570 5f66 6972 7374  f not step_first
-0000f5d0: 5f6e 6f64 653a 0a20 2020 2020 2020 2020  _node:.         
-0000f5e0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-0000f5f0: 7565 4572 726f 7228 6622 5275 6e6e 6162  ueError(f"Runnab
-0000f600: 6c65 207b 7374 6570 7d20 6861 7320 6e6f  le {step} has no
-0000f610: 2066 6972 7374 206e 6f64 6522 290a 2020   first node").  
-0000f620: 2020 2020 2020 2020 2020 6966 2063 7572            if cur
-0000f630: 7265 6e74 5f6c 6173 745f 6e6f 6465 3a0a  rent_last_node:.
-0000f640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f650: 6772 6170 682e 6164 645f 6564 6765 2863  graph.add_edge(c
-0000f660: 7572 7265 6e74 5f6c 6173 745f 6e6f 6465  urrent_last_node
-0000f670: 2c20 7374 6570 5f66 6972 7374 5f6e 6f64  , step_first_nod
-0000f680: 6529 0a0a 2020 2020 2020 2020 7265 7475  e)..        retu
-0000f690: 726e 2067 7261 7068 0a0a 2020 2020 6465  rn graph..    de
-0000f6a0: 6620 5f5f 7265 7072 5f5f 2873 656c 6629  f __repr__(self)
-0000f6b0: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-0000f6c0: 2072 6574 7572 6e20 225c 6e7c 2022 2e6a   return "\n| ".j
-0000f6d0: 6f69 6e28 0a20 2020 2020 2020 2020 2020  oin(.           
-0000f6e0: 2072 6570 7228 7329 2069 6620 6920 3d3d   repr(s) if i ==
-0000f6f0: 2030 2065 6c73 6520 696e 6465 6e74 5f6c   0 else indent_l
-0000f700: 696e 6573 5f61 6674 6572 5f66 6972 7374  ines_after_first
-0000f710: 2872 6570 7228 7329 2c20 227c 2022 290a  (repr(s), "| ").
-0000f720: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000f730: 692c 2073 2069 6e20 656e 756d 6572 6174  i, s in enumerat
-0000f740: 6528 7365 6c66 2e73 7465 7073 290a 2020  e(self.steps).  
-0000f750: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-0000f760: 205f 5f6f 725f 5f28 0a20 2020 2020 2020   __or__(.       
-0000f770: 2073 656c 662c 0a20 2020 2020 2020 206f   self,.        o
-0000f780: 7468 6572 3a20 556e 696f 6e5b 0a20 2020  ther: Union[.   
-0000f790: 2020 2020 2020 2020 2052 756e 6e61 626c           Runnabl
-0000f7a0: 655b 416e 792c 204f 7468 6572 5d2c 0a20  e[Any, Other],. 
-0000f7b0: 2020 2020 2020 2020 2020 2043 616c 6c61             Calla
-0000f7c0: 626c 655b 5b41 6e79 5d2c 204f 7468 6572  ble[[Any], Other
-0000f7d0: 5d2c 0a20 2020 2020 2020 2020 2020 2043  ],.            C
-0000f7e0: 616c 6c61 626c 655b 5b49 7465 7261 746f  allable[[Iterato
-0000f7f0: 725b 416e 795d 5d2c 2049 7465 7261 746f  r[Any]], Iterato
-0000f800: 725b 4f74 6865 725d 5d2c 0a20 2020 2020  r[Other]],.     
-0000f810: 2020 2020 2020 204d 6170 7069 6e67 5b73         Mapping[s
-0000f820: 7472 2c20 556e 696f 6e5b 5275 6e6e 6162  tr, Union[Runnab
-0000f830: 6c65 5b41 6e79 2c20 4f74 6865 725d 2c20  le[Any, Other], 
-0000f840: 4361 6c6c 6162 6c65 5b5b 416e 795d 2c20  Callable[[Any], 
-0000f850: 4f74 6865 725d 2c20 416e 795d 5d2c 0a20  Other], Any]],. 
-0000f860: 2020 2020 2020 205d 2c0a 2020 2020 2920         ],.    ) 
-0000f870: 2d3e 2052 756e 6e61 626c 6553 6572 6961  -> RunnableSeria
-0000f880: 6c69 7a61 626c 655b 496e 7075 742c 204f  lizable[Input, O
-0000f890: 7468 6572 5d3a 0a20 2020 2020 2020 2069  ther]:.        i
-0000f8a0: 6620 6973 696e 7374 616e 6365 286f 7468  f isinstance(oth
-0000f8b0: 6572 2c20 5275 6e6e 6162 6c65 5365 7175  er, RunnableSequ
-0000f8c0: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
-0000f8d0: 2020 2072 6574 7572 6e20 5275 6e6e 6162     return Runnab
-0000f8e0: 6c65 5365 7175 656e 6365 280a 2020 2020  leSequence(.    
-0000f8f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000f900: 2e66 6972 7374 2c0a 2020 2020 2020 2020  .first,.        
-0000f910: 2020 2020 2020 2020 2a73 656c 662e 6d69          *self.mi
-0000f920: 6464 6c65 2c0a 2020 2020 2020 2020 2020  ddle,.          
-0000f930: 2020 2020 2020 7365 6c66 2e6c 6173 742c        self.last,
-0000f940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f950: 206f 7468 6572 2e66 6972 7374 2c0a 2020   other.first,.  
-0000f960: 2020 2020 2020 2020 2020 2020 2020 2a6f                *o
-0000f970: 7468 6572 2e6d 6964 646c 652c 0a20 2020  ther.middle,.   
-0000f980: 2020 2020 2020 2020 2020 2020 206f 7468               oth
-0000f990: 6572 2e6c 6173 742c 0a20 2020 2020 2020  er.last,.       
-0000f9a0: 2020 2020 2020 2020 206e 616d 653d 7365           name=se
-0000f9b0: 6c66 2e6e 616d 6520 6f72 206f 7468 6572  lf.name or other
-0000f9c0: 2e6e 616d 652c 0a20 2020 2020 2020 2020  .name,.         
-0000f9d0: 2020 2029 0a20 2020 2020 2020 2065 6c73     ).        els
-0000f9e0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-0000f9f0: 6574 7572 6e20 5275 6e6e 6162 6c65 5365  eturn RunnableSe
-0000fa00: 7175 656e 6365 280a 2020 2020 2020 2020  quence(.        
-0000fa10: 2020 2020 2020 2020 7365 6c66 2e66 6972          self.fir
-0000fa20: 7374 2c0a 2020 2020 2020 2020 2020 2020  st,.            
-0000fa30: 2020 2020 2a73 656c 662e 6d69 6464 6c65      *self.middle
-0000fa40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000fa50: 2020 7365 6c66 2e6c 6173 742c 0a20 2020    self.last,.   
-0000fa60: 2020 2020 2020 2020 2020 2020 2063 6f65               coe
-0000fa70: 7263 655f 746f 5f72 756e 6e61 626c 6528  rce_to_runnable(
-0000fa80: 6f74 6865 7229 2c0a 2020 2020 2020 2020  other),.        
-0000fa90: 2020 2020 2020 2020 6e61 6d65 3d73 656c          name=sel
-0000faa0: 662e 6e61 6d65 2c0a 2020 2020 2020 2020  f.name,.        
-0000fab0: 2020 2020 290a 0a20 2020 2064 6566 205f      )..    def _
-0000fac0: 5f72 6f72 5f5f 280a 2020 2020 2020 2020  _ror__(.        
-0000fad0: 7365 6c66 2c0a 2020 2020 2020 2020 6f74  self,.        ot
-0000fae0: 6865 723a 2055 6e69 6f6e 5b0a 2020 2020  her: Union[.    
-0000faf0: 2020 2020 2020 2020 5275 6e6e 6162 6c65          Runnable
-0000fb00: 5b4f 7468 6572 2c20 416e 795d 2c0a 2020  [Other, Any],.  
-0000fb10: 2020 2020 2020 2020 2020 4361 6c6c 6162            Callab
-0000fb20: 6c65 5b5b 4f74 6865 725d 2c20 416e 795d  le[[Other], Any]
-0000fb30: 2c0a 2020 2020 2020 2020 2020 2020 4361  ,.            Ca
-0000fb40: 6c6c 6162 6c65 5b5b 4974 6572 6174 6f72  llable[[Iterator
-0000fb50: 5b4f 7468 6572 5d5d 2c20 4974 6572 6174  [Other]], Iterat
-0000fb60: 6f72 5b41 6e79 5d5d 2c0a 2020 2020 2020  or[Any]],.      
-0000fb70: 2020 2020 2020 4d61 7070 696e 675b 7374        Mapping[st
-0000fb80: 722c 2055 6e69 6f6e 5b52 756e 6e61 626c  r, Union[Runnabl
-0000fb90: 655b 4f74 6865 722c 2041 6e79 5d2c 2043  e[Other, Any], C
-0000fba0: 616c 6c61 626c 655b 5b4f 7468 6572 5d2c  allable[[Other],
-0000fbb0: 2041 6e79 5d2c 2041 6e79 5d5d 2c0a 2020   Any], Any]],.  
-0000fbc0: 2020 2020 2020 5d2c 0a20 2020 2029 202d        ],.    ) -
-0000fbd0: 3e20 5275 6e6e 6162 6c65 5365 7269 616c  > RunnableSerial
-0000fbe0: 697a 6162 6c65 5b4f 7468 6572 2c20 4f75  izable[Other, Ou
-0000fbf0: 7470 7574 5d3a 0a20 2020 2020 2020 2069  tput]:.        i
-0000fc00: 6620 6973 696e 7374 616e 6365 286f 7468  f isinstance(oth
-0000fc10: 6572 2c20 5275 6e6e 6162 6c65 5365 7175  er, RunnableSequ
-0000fc20: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
-0000fc30: 2020 2072 6574 7572 6e20 5275 6e6e 6162     return Runnab
-0000fc40: 6c65 5365 7175 656e 6365 280a 2020 2020  leSequence(.    
-0000fc50: 2020 2020 2020 2020 2020 2020 6f74 6865              othe
-0000fc60: 722e 6669 7273 742c 0a20 2020 2020 2020  r.first,.       
-0000fc70: 2020 2020 2020 2020 202a 6f74 6865 722e           *other.
-0000fc80: 6d69 6464 6c65 2c0a 2020 2020 2020 2020  middle,.        
-0000fc90: 2020 2020 2020 2020 6f74 6865 722e 6c61          other.la
-0000fca0: 7374 2c0a 2020 2020 2020 2020 2020 2020  st,.            
-0000fcb0: 2020 2020 7365 6c66 2e66 6972 7374 2c0a      self.first,.
-0000fcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fcd0: 2a73 656c 662e 6d69 6464 6c65 2c0a 2020  *self.middle,.  
-0000fce0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0000fcf0: 6c66 2e6c 6173 742c 0a20 2020 2020 2020  lf.last,.       
-0000fd00: 2020 2020 2020 2020 206e 616d 653d 6f74           name=ot
-0000fd10: 6865 722e 6e61 6d65 206f 7220 7365 6c66  her.name or self
-0000fd20: 2e6e 616d 652c 0a20 2020 2020 2020 2020  .name,.         
-0000fd30: 2020 2029 0a20 2020 2020 2020 2065 6c73     ).        els
-0000fd40: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-0000fd50: 6574 7572 6e20 5275 6e6e 6162 6c65 5365  eturn RunnableSe
-0000fd60: 7175 656e 6365 280a 2020 2020 2020 2020  quence(.        
-0000fd70: 2020 2020 2020 2020 636f 6572 6365 5f74          coerce_t
-0000fd80: 6f5f 7275 6e6e 6162 6c65 286f 7468 6572  o_runnable(other
-0000fd90: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0000fda0: 2020 2073 656c 662e 6669 7273 742c 0a20     self.first,. 
-0000fdb0: 2020 2020 2020 2020 2020 2020 2020 202a                 *
-0000fdc0: 7365 6c66 2e6d 6964 646c 652c 0a20 2020  self.middle,.   
-0000fdd0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0000fde0: 662e 6c61 7374 2c0a 2020 2020 2020 2020  f.last,.        
-0000fdf0: 2020 2020 2020 2020 6e61 6d65 3d73 656c          name=sel
-0000fe00: 662e 6e61 6d65 2c0a 2020 2020 2020 2020  f.name,.        
-0000fe10: 2020 2020 290a 0a20 2020 2064 6566 2069      )..    def i
-0000fe20: 6e76 6f6b 6528 7365 6c66 2c20 696e 7075  nvoke(self, inpu
-0000fe30: 743a 2049 6e70 7574 2c20 636f 6e66 6967  t: Input, config
-0000fe40: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
-0000fe50: 626c 6543 6f6e 6669 675d 203d 204e 6f6e  bleConfig] = Non
-0000fe60: 6529 202d 3e20 4f75 7470 7574 3a0a 2020  e) -> Output:.  
-0000fe70: 2020 2020 2020 6672 6f6d 206c 616e 6763        from langc
-0000fe80: 6861 696e 5f63 6f72 652e 6265 7461 2e72  hain_core.beta.r
-0000fe90: 756e 6e61 626c 6573 2e63 6f6e 7465 7874  unnables.context
-0000fea0: 2069 6d70 6f72 7420 636f 6e66 6967 5f77   import config_w
-0000feb0: 6974 685f 636f 6e74 6578 740a 0a20 2020  ith_context..   
-0000fec0: 2020 2020 2023 2073 6574 7570 2063 616c       # setup cal
-0000fed0: 6c62 6163 6b73 2061 6e64 2063 6f6e 7465  lbacks and conte
-0000fee0: 7874 0a20 2020 2020 2020 2063 6f6e 6669  xt.        confi
-0000fef0: 6720 3d20 636f 6e66 6967 5f77 6974 685f  g = config_with_
-0000ff00: 636f 6e74 6578 7428 656e 7375 7265 5f63  context(ensure_c
-0000ff10: 6f6e 6669 6728 636f 6e66 6967 292c 2073  onfig(config), s
-0000ff20: 656c 662e 7374 6570 7329 0a20 2020 2020  elf.steps).     
-0000ff30: 2020 2063 616c 6c62 6163 6b5f 6d61 6e61     callback_mana
-0000ff40: 6765 7220 3d20 6765 745f 6361 6c6c 6261  ger = get_callba
-0000ff50: 636b 5f6d 616e 6167 6572 5f66 6f72 5f63  ck_manager_for_c
-0000ff60: 6f6e 6669 6728 636f 6e66 6967 290a 2020  onfig(config).  
-0000ff70: 2020 2020 2020 2320 7374 6172 7420 7468        # start th
-0000ff80: 6520 726f 6f74 2072 756e 0a20 2020 2020  e root run.     
-0000ff90: 2020 2072 756e 5f6d 616e 6167 6572 203d     run_manager =
-0000ffa0: 2063 616c 6c62 6163 6b5f 6d61 6e61 6765   callback_manage
-0000ffb0: 722e 6f6e 5f63 6861 696e 5f73 7461 7274  r.on_chain_start
-0000ffc0: 280a 2020 2020 2020 2020 2020 2020 6475  (.            du
-0000ffd0: 6d70 6428 7365 6c66 292c 2069 6e70 7574  mpd(self), input
-0000ffe0: 2c20 6e61 6d65 3d63 6f6e 6669 672e 6765  , name=config.ge
-0000fff0: 7428 2272 756e 5f6e 616d 6522 2920 6f72  t("run_name") or
-00010000: 2073 656c 662e 6765 745f 6e61 6d65 2829   self.get_name()
-00010010: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00010020: 2020 2020 2320 696e 766f 6b65 2061 6c6c      # invoke all
-00010030: 2073 7465 7073 2069 6e20 7365 7175 656e   steps in sequen
-00010040: 6365 0a20 2020 2020 2020 2074 7279 3a0a  ce.        try:.
-00010050: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00010060: 692c 2073 7465 7020 696e 2065 6e75 6d65  i, step in enume
-00010070: 7261 7465 2873 656c 662e 7374 6570 7329  rate(self.steps)
-00010080: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00010090: 2020 696e 7075 7420 3d20 7374 6570 2e69    input = step.i
-000100a0: 6e76 6f6b 6528 0a20 2020 2020 2020 2020  nvoke(.         
-000100b0: 2020 2020 2020 2020 2020 2069 6e70 7574             input
-000100c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000100d0: 2020 2020 2020 2320 6d61 726b 2065 6163        # mark eac
-000100e0: 6820 7374 6570 2061 7320 6120 6368 696c  h step as a chil
-000100f0: 6420 7275 6e0a 2020 2020 2020 2020 2020  d run.          
-00010100: 2020 2020 2020 2020 2020 7061 7463 685f            patch_
-00010110: 636f 6e66 6967 280a 2020 2020 2020 2020  config(.        
-00010120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010130: 636f 6e66 6967 2c20 6361 6c6c 6261 636b  config, callback
-00010140: 733d 7275 6e5f 6d61 6e61 6765 722e 6765  s=run_manager.ge
-00010150: 745f 6368 696c 6428 6622 7365 713a 7374  t_child(f"seq:st
-00010160: 6570 3a7b 692b 317d 2229 0a20 2020 2020  ep:{i+1}").     
-00010170: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00010180: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00010190: 2020 290a 2020 2020 2020 2020 2320 6669    ).        # fi
-000101a0: 6e69 7368 2074 6865 2072 6f6f 7420 7275  nish the root ru
-000101b0: 6e0a 2020 2020 2020 2020 6578 6365 7074  n.        except
-000101c0: 2042 6173 6545 7863 6570 7469 6f6e 2061   BaseException a
-000101d0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-000101e0: 2072 756e 5f6d 616e 6167 6572 2e6f 6e5f   run_manager.on_
-000101f0: 6368 6169 6e5f 6572 726f 7228 6529 0a20  chain_error(e). 
-00010200: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00010210: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00010220: 2020 2020 2020 2020 2020 2072 756e 5f6d             run_m
-00010230: 616e 6167 6572 2e6f 6e5f 6368 6169 6e5f  anager.on_chain_
-00010240: 656e 6428 696e 7075 7429 0a20 2020 2020  end(input).     
-00010250: 2020 2020 2020 2072 6574 7572 6e20 6361         return ca
-00010260: 7374 284f 7574 7075 742c 2069 6e70 7574  st(Output, input
-00010270: 290a 0a20 2020 2061 7379 6e63 2064 6566  )..    async def
-00010280: 2061 696e 766f 6b65 280a 2020 2020 2020   ainvoke(.      
-00010290: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-000102a0: 696e 7075 743a 2049 6e70 7574 2c0a 2020  input: Input,.  
-000102b0: 2020 2020 2020 636f 6e66 6967 3a20 4f70        config: Op
-000102c0: 7469 6f6e 616c 5b52 756e 6e61 626c 6543  tional[RunnableC
-000102d0: 6f6e 6669 675d 203d 204e 6f6e 652c 0a20  onfig] = None,. 
-000102e0: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
-000102f0: 204f 7074 696f 6e61 6c5b 416e 795d 2c0a   Optional[Any],.
-00010300: 2020 2020 2920 2d3e 204f 7574 7075 743a      ) -> Output:
-00010310: 0a20 2020 2020 2020 2066 726f 6d20 6c61  .        from la
-00010320: 6e67 6368 6169 6e5f 636f 7265 2e62 6574  ngchain_core.bet
-00010330: 612e 7275 6e6e 6162 6c65 732e 636f 6e74  a.runnables.cont
-00010340: 6578 7420 696d 706f 7274 2061 636f 6e66  ext import aconf
-00010350: 6967 5f77 6974 685f 636f 6e74 6578 740a  ig_with_context.
-00010360: 0a20 2020 2020 2020 2023 2073 6574 7570  .        # setup
-00010370: 2063 616c 6c62 6163 6b73 2061 6e64 2063   callbacks and c
-00010380: 6f6e 7465 7874 0a20 2020 2020 2020 2063  ontext.        c
-00010390: 6f6e 6669 6720 3d20 6163 6f6e 6669 675f  onfig = aconfig_
-000103a0: 7769 7468 5f63 6f6e 7465 7874 2865 6e73  with_context(ens
-000103b0: 7572 655f 636f 6e66 6967 2863 6f6e 6669  ure_config(confi
-000103c0: 6729 2c20 7365 6c66 2e73 7465 7073 290a  g), self.steps).
-000103d0: 2020 2020 2020 2020 6361 6c6c 6261 636b          callback
-000103e0: 5f6d 616e 6167 6572 203d 2067 6574 5f61  _manager = get_a
-000103f0: 7379 6e63 5f63 616c 6c62 6163 6b5f 6d61  sync_callback_ma
-00010400: 6e61 6765 725f 666f 725f 636f 6e66 6967  nager_for_config
-00010410: 2863 6f6e 6669 6729 0a20 2020 2020 2020  (config).       
-00010420: 2023 2073 7461 7274 2074 6865 2072 6f6f   # start the roo
-00010430: 7420 7275 6e0a 2020 2020 2020 2020 7275  t run.        ru
-00010440: 6e5f 6d61 6e61 6765 7220 3d20 6177 6169  n_manager = awai
-00010450: 7420 6361 6c6c 6261 636b 5f6d 616e 6167  t callback_manag
-00010460: 6572 2e6f 6e5f 6368 6169 6e5f 7374 6172  er.on_chain_star
-00010470: 7428 0a20 2020 2020 2020 2020 2020 2064  t(.            d
-00010480: 756d 7064 2873 656c 6629 2c20 696e 7075  umpd(self), inpu
-00010490: 742c 206e 616d 653d 636f 6e66 6967 2e67  t, name=config.g
-000104a0: 6574 2822 7275 6e5f 6e61 6d65 2229 206f  et("run_name") o
-000104b0: 7220 7365 6c66 2e67 6574 5f6e 616d 6528  r self.get_name(
-000104c0: 290a 2020 2020 2020 2020 290a 0a20 2020  ).        )..   
-000104d0: 2020 2020 2023 2069 6e76 6f6b 6520 616c       # invoke al
-000104e0: 6c20 7374 6570 7320 696e 2073 6571 7565  l steps in seque
-000104f0: 6e63 650a 2020 2020 2020 2020 7472 793a  nce.        try:
-00010500: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00010510: 2069 2c20 7374 6570 2069 6e20 656e 756d   i, step in enum
-00010520: 6572 6174 6528 7365 6c66 2e73 7465 7073  erate(self.steps
-00010530: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00010540: 2020 2069 6e70 7574 203d 2061 7761 6974     input = await
-00010550: 2073 7465 702e 6169 6e76 6f6b 6528 0a20   step.ainvoke(. 
-00010560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010570: 2020 2069 6e70 7574 2c0a 2020 2020 2020     input,.      
-00010580: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00010590: 6d61 726b 2065 6163 6820 7374 6570 2061  mark each step a
-000105a0: 7320 6120 6368 696c 6420 7275 6e0a 2020  s a child run.  
-000105b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105c0: 2020 7061 7463 685f 636f 6e66 6967 280a    patch_config(.
-000105d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105e0: 2020 2020 2020 2020 636f 6e66 6967 2c20          config, 
-000105f0: 6361 6c6c 6261 636b 733d 7275 6e5f 6d61  callbacks=run_ma
-00010600: 6e61 6765 722e 6765 745f 6368 696c 6428  nager.get_child(
-00010610: 6622 7365 713a 7374 6570 3a7b 692b 317d  f"seq:step:{i+1}
-00010620: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00010630: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-00010640: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00010650: 2020 2020 2320 6669 6e69 7368 2074 6865      # finish the
-00010660: 2072 6f6f 7420 7275 6e0a 2020 2020 2020   root run.      
-00010670: 2020 6578 6365 7074 2042 6173 6545 7863    except BaseExc
-00010680: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
-00010690: 2020 2020 2020 2020 2061 7761 6974 2072           await r
-000106a0: 756e 5f6d 616e 6167 6572 2e6f 6e5f 6368  un_manager.on_ch
-000106b0: 6169 6e5f 6572 726f 7228 6529 0a20 2020  ain_error(e).   
-000106c0: 2020 2020 2020 2020 2072 6169 7365 0a20           raise. 
-000106d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000106e0: 2020 2020 2020 2020 2061 7761 6974 2072           await r
-000106f0: 756e 5f6d 616e 6167 6572 2e6f 6e5f 6368  un_manager.on_ch
-00010700: 6169 6e5f 656e 6428 696e 7075 7429 0a20  ain_end(input). 
-00010710: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00010720: 6e20 6361 7374 284f 7574 7075 742c 2069  n cast(Output, i
-00010730: 6e70 7574 290a 0a20 2020 2064 6566 2062  nput)..    def b
-00010740: 6174 6368 280a 2020 2020 2020 2020 7365  atch(.        se
-00010750: 6c66 2c0a 2020 2020 2020 2020 696e 7075  lf,.        inpu
-00010760: 7473 3a20 4c69 7374 5b49 6e70 7574 5d2c  ts: List[Input],
-00010770: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
-00010780: 204f 7074 696f 6e61 6c5b 556e 696f 6e5b   Optional[Union[
-00010790: 5275 6e6e 6162 6c65 436f 6e66 6967 2c20  RunnableConfig, 
-000107a0: 4c69 7374 5b52 756e 6e61 626c 6543 6f6e  List[RunnableCon
-000107b0: 6669 675d 5d5d 203d 204e 6f6e 652c 0a20  fig]]] = None,. 
-000107c0: 2020 2020 2020 202a 2c0a 2020 2020 2020         *,.      
-000107d0: 2020 7265 7475 726e 5f65 7863 6570 7469    return_excepti
-000107e0: 6f6e 733a 2062 6f6f 6c20 3d20 4661 6c73  ons: bool = Fals
-000107f0: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
-00010800: 7267 733a 204f 7074 696f 6e61 6c5b 416e  rgs: Optional[An
-00010810: 795d 2c0a 2020 2020 2920 2d3e 204c 6973  y],.    ) -> Lis
-00010820: 745b 4f75 7470 7574 5d3a 0a20 2020 2020  t[Output]:.     
-00010830: 2020 2066 726f 6d20 6c61 6e67 6368 6169     from langchai
-00010840: 6e5f 636f 7265 2e62 6574 612e 7275 6e6e  n_core.beta.runn
-00010850: 6162 6c65 732e 636f 6e74 6578 7420 696d  ables.context im
-00010860: 706f 7274 2063 6f6e 6669 675f 7769 7468  port config_with
-00010870: 5f63 6f6e 7465 7874 0a20 2020 2020 2020  _context.       
-00010880: 2066 726f 6d20 6c61 6e67 6368 6169 6e5f   from langchain_
-00010890: 636f 7265 2e63 616c 6c62 6163 6b73 2e6d  core.callbacks.m
-000108a0: 616e 6167 6572 2069 6d70 6f72 7420 4361  anager import Ca
-000108b0: 6c6c 6261 636b 4d61 6e61 6765 720a 0a20  llbackManager.. 
-000108c0: 2020 2020 2020 2069 6620 6e6f 7420 696e         if not in
-000108d0: 7075 7473 3a0a 2020 2020 2020 2020 2020  puts:.          
-000108e0: 2020 7265 7475 726e 205b 5d0a 0a20 2020    return []..   
-000108f0: 2020 2020 2023 2073 6574 7570 2063 616c       # setup cal
-00010900: 6c62 6163 6b73 2061 6e64 2063 6f6e 7465  lbacks and conte
-00010910: 7874 0a20 2020 2020 2020 2063 6f6e 6669  xt.        confi
-00010920: 6773 203d 205b 0a20 2020 2020 2020 2020  gs = [.         
-00010930: 2020 2063 6f6e 6669 675f 7769 7468 5f63     config_with_c
-00010940: 6f6e 7465 7874 2863 2c20 7365 6c66 2e73  ontext(c, self.s
-00010950: 7465 7073 290a 2020 2020 2020 2020 2020  teps).          
-00010960: 2020 666f 7220 6320 696e 2067 6574 5f63    for c in get_c
-00010970: 6f6e 6669 675f 6c69 7374 2863 6f6e 6669  onfig_list(confi
-00010980: 672c 206c 656e 2869 6e70 7574 7329 290a  g, len(inputs)).
-00010990: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-000109a0: 2020 6361 6c6c 6261 636b 5f6d 616e 6167    callback_manag
-000109b0: 6572 7320 3d20 5b0a 2020 2020 2020 2020  ers = [.        
-000109c0: 2020 2020 4361 6c6c 6261 636b 4d61 6e61      CallbackMana
-000109d0: 6765 722e 636f 6e66 6967 7572 6528 0a20  ger.configure(. 
-000109e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000109f0: 6e68 6572 6974 6162 6c65 5f63 616c 6c62  nheritable_callb
-00010a00: 6163 6b73 3d63 6f6e 6669 672e 6765 7428  acks=config.get(
-00010a10: 2263 616c 6c62 6163 6b73 2229 2c0a 2020  "callbacks"),.  
-00010a20: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00010a30: 6361 6c5f 6361 6c6c 6261 636b 733d 4e6f  cal_callbacks=No
-00010a40: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00010a50: 2020 2020 7665 7262 6f73 653d 4661 6c73      verbose=Fals
-00010a60: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00010a70: 2020 2069 6e68 6572 6974 6162 6c65 5f74     inheritable_t
-00010a80: 6167 733d 636f 6e66 6967 2e67 6574 2822  ags=config.get("
-00010a90: 7461 6773 2229 2c0a 2020 2020 2020 2020  tags"),.        
-00010aa0: 2020 2020 2020 2020 6c6f 6361 6c5f 7461          local_ta
-00010ab0: 6773 3d4e 6f6e 652c 0a20 2020 2020 2020  gs=None,.       
-00010ac0: 2020 2020 2020 2020 2069 6e68 6572 6974           inherit
-00010ad0: 6162 6c65 5f6d 6574 6164 6174 613d 636f  able_metadata=co
-00010ae0: 6e66 6967 2e67 6574 2822 6d65 7461 6461  nfig.get("metada
-00010af0: 7461 2229 2c0a 2020 2020 2020 2020 2020  ta"),.          
-00010b00: 2020 2020 2020 6c6f 6361 6c5f 6d65 7461        local_meta
-00010b10: 6461 7461 3d4e 6f6e 652c 0a20 2020 2020  data=None,.     
-00010b20: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00010b30: 2020 2020 2066 6f72 2063 6f6e 6669 6720       for config 
-00010b40: 696e 2063 6f6e 6669 6773 0a20 2020 2020  in configs.     
-00010b50: 2020 205d 0a20 2020 2020 2020 2023 2073     ].        # s
-00010b60: 7461 7274 2074 6865 2072 6f6f 7420 7275  tart the root ru
-00010b70: 6e73 2c20 6f6e 6520 7065 7220 696e 7075  ns, one per inpu
-00010b80: 740a 2020 2020 2020 2020 7275 6e5f 6d61  t.        run_ma
-00010b90: 6e61 6765 7273 203d 205b 0a20 2020 2020  nagers = [.     
-00010ba0: 2020 2020 2020 2063 6d2e 6f6e 5f63 6861         cm.on_cha
-00010bb0: 696e 5f73 7461 7274 280a 2020 2020 2020  in_start(.      
-00010bc0: 2020 2020 2020 2020 2020 6475 6d70 6428            dumpd(
-00010bd0: 7365 6c66 292c 0a20 2020 2020 2020 2020  self),.         
-00010be0: 2020 2020 2020 2069 6e70 7574 2c0a 2020         input,.  
-00010bf0: 2020 2020 2020 2020 2020 2020 2020 6e61                na
-00010c00: 6d65 3d63 6f6e 6669 672e 6765 7428 2272  me=config.get("r
-00010c10: 756e 5f6e 616d 6522 2920 6f72 2073 656c  un_name") or sel
-00010c20: 662e 6765 745f 6e61 6d65 2829 2c0a 2020  f.get_name(),.  
-00010c30: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00010c40: 2020 2020 2020 2020 666f 7220 636d 2c20          for cm, 
-00010c50: 696e 7075 742c 2063 6f6e 6669 6720 696e  input, config in
-00010c60: 207a 6970 2863 616c 6c62 6163 6b5f 6d61   zip(callback_ma
-00010c70: 6e61 6765 7273 2c20 696e 7075 7473 2c20  nagers, inputs, 
-00010c80: 636f 6e66 6967 7329 0a20 2020 2020 2020  configs).       
-00010c90: 205d 0a0a 2020 2020 2020 2020 2320 696e   ]..        # in
-00010ca0: 766f 6b65 0a20 2020 2020 2020 2074 7279  voke.        try
-00010cb0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00010cc0: 2072 6574 7572 6e5f 6578 6365 7074 696f   return_exceptio
-00010cd0: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-00010ce0: 2020 2020 2320 5472 6163 6b20 7768 6963      # Track whic
-00010cf0: 6820 696e 7075 7473 2028 6279 2069 6e64  h inputs (by ind
-00010d00: 6578 2920 6661 696c 6564 2073 6f20 6661  ex) failed so fa
-00010d10: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-00010d20: 2020 2320 4966 2061 6e20 696e 7075 7420    # If an input 
-00010d30: 6861 7320 6661 696c 6564 2069 7420 7769  has failed it wi
-00010d40: 6c6c 2062 6520 7072 6573 656e 7420 696e  ll be present in
-00010d50: 2074 6869 7320 6d61 702c 0a20 2020 2020   this map,.     
-00010d60: 2020 2020 2020 2020 2020 2023 2061 6e64             # and
-00010d70: 2074 6865 2076 616c 7565 2077 696c 6c20   the value will 
-00010d80: 6265 2074 6865 2065 7863 6570 7469 6f6e  be the exception
-00010d90: 2074 6861 7420 7761 7320 7261 6973 6564   that was raised
-00010da0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00010db0: 2020 6661 696c 6564 5f69 6e70 7574 735f    failed_inputs_
-00010dc0: 6d61 703a 2044 6963 745b 696e 742c 2045  map: Dict[int, E
-00010dd0: 7863 6570 7469 6f6e 5d20 3d20 7b7d 0a20  xception] = {}. 
-00010de0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00010df0: 6f72 2073 7465 7069 6478 2c20 7374 6570  or stepidx, step
-00010e00: 2069 6e20 656e 756d 6572 6174 6528 7365   in enumerate(se
-00010e10: 6c66 2e73 7465 7073 293a 0a20 2020 2020  lf.steps):.     
-00010e20: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00010e30: 2041 7373 656d 626c 6520 7468 6520 6f72   Assemble the or
-00010e40: 6967 696e 616c 2069 6e64 6578 6573 206f  iginal indexes o
-00010e50: 6620 7468 6520 7265 6d61 696e 696e 6720  f the remaining 
-00010e60: 696e 7075 7473 0a20 2020 2020 2020 2020  inputs.         
-00010e70: 2020 2020 2020 2020 2020 2023 2028 692e             # (i.
-00010e80: 652e 2074 6865 206f 6e65 7320 7468 6174  e. the ones that
-00010e90: 2068 6176 656e 2774 2066 6169 6c65 6420   haven't failed 
-00010ea0: 7965 7429 0a20 2020 2020 2020 2020 2020  yet).           
-00010eb0: 2020 2020 2020 2020 2072 656d 6169 6e69           remaini
-00010ec0: 6e67 5f69 6478 7320 3d20 5b0a 2020 2020  ng_idxs = [.    
-00010ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ee0: 2020 2020 6920 666f 7220 6920 696e 2072      i for i in r
-00010ef0: 616e 6765 286c 656e 2863 6f6e 6669 6773  ange(len(configs
-00010f00: 2929 2069 6620 6920 6e6f 7420 696e 2066  )) if i not in f
-00010f10: 6169 6c65 645f 696e 7075 7473 5f6d 6170  ailed_inputs_map
-00010f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010f30: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
-00010f40: 2020 2020 2020 2020 2020 2023 2049 6e76             # Inv
-00010f50: 6f6b 6520 7468 6520 7374 6570 206f 6e20  oke the step on 
-00010f60: 7468 6520 7265 6d61 696e 696e 6720 696e  the remaining in
-00010f70: 7075 7473 0a20 2020 2020 2020 2020 2020  puts.           
-00010f80: 2020 2020 2020 2020 2069 6e70 7574 7320           inputs 
-00010f90: 3d20 7374 6570 2e62 6174 6368 280a 2020  = step.batch(.  
-00010fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010fb0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00010fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010fd0: 2020 2020 696e 700a 2020 2020 2020 2020      inp.        
-00010fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ff0: 2020 2020 666f 7220 692c 2069 6e70 2069      for i, inp i
-00011000: 6e20 7a69 7028 7265 6d61 696e 696e 675f  n zip(remaining_
-00011010: 6964 7873 2c20 696e 7075 7473 290a 2020  idxs, inputs).  
-00011020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011030: 2020 2020 2020 2020 2020 6966 2069 206e            if i n
-00011040: 6f74 2069 6e20 6661 696c 6564 5f69 6e70  ot in failed_inp
-00011050: 7574 735f 6d61 700a 2020 2020 2020 2020  uts_map.        
-00011060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011070: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00011080: 2020 2020 2020 2020 2020 205b 0a20 2020             [.   
-00011090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110a0: 2020 2020 2020 2020 2023 2065 6163 6820           # each 
-000110b0: 7374 6570 2061 2063 6869 6c64 2072 756e  step a child run
-000110c0: 206f 6620 7468 6520 636f 7272 6573 706f   of the correspo
-000110d0: 6e64 696e 6720 726f 6f74 2072 756e 0a20  nding root run. 
+0000c150: 2074 6167 733d 726f 6f74 5f74 6167 732c   tags=root_tags,
+0000c160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c170: 2020 2020 206d 6574 6164 6174 613d 726f       metadata=ro
+0000c180: 6f74 5f6d 6574 6164 6174 612c 0a20 2020  ot_metadata,.   
+0000c190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c1a0: 206e 616d 653d 726f 6f74 5f6e 616d 652c   name=root_name,
+0000c1b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c1c0: 2020 2020 2064 6174 613d 6461 7461 2c0a       data=data,.
+0000c1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c1e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000c1f0: 2020 6966 205f 726f 6f74 5f65 7665 6e74    if _root_event
+0000c200: 5f66 696c 7465 722e 696e 636c 7564 655f  _filter.include_
+0000c210: 6576 656e 7428 6576 656e 742c 2073 7461  event(event, sta
+0000c220: 7465 5b22 7479 7065 225d 293a 0a20 2020  te["type"]):.   
+0000c230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c240: 2079 6965 6c64 2065 7665 6e74 0a0a 2020   yield event..  
+0000c250: 2020 2020 2020 7374 6174 6520 3d20 7275        state = ru
+0000c260: 6e5f 6c6f 672e 7374 6174 650a 0a20 2020  n_log.state..   
+0000c270: 2020 2020 2023 2046 696e 616c 6c79 2079       # Finally y
+0000c280: 6965 6c64 2074 6865 2065 6e64 2065 7665  ield the end eve
+0000c290: 6e74 2066 6f72 2074 6865 2072 6f6f 7420  nt for the root 
+0000c2a0: 7275 6e6e 6162 6c65 2e0a 2020 2020 2020  runnable..      
+0000c2b0: 2020 6576 656e 7420 3d20 5374 7265 616d    event = Stream
+0000c2c0: 4576 656e 7428 0a20 2020 2020 2020 2020  Event(.         
+0000c2d0: 2020 2065 7665 6e74 3d66 226f 6e5f 7b73     event=f"on_{s
+0000c2e0: 7461 7465 5b27 7479 7065 275d 7d5f 656e  tate['type']}_en
+0000c2f0: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
+0000c300: 6e61 6d65 3d72 6f6f 745f 6e61 6d65 2c0a  name=root_name,.
+0000c310: 2020 2020 2020 2020 2020 2020 7275 6e5f              run_
+0000c320: 6964 3d73 7461 7465 5b22 6964 225d 2c0a  id=state["id"],.
+0000c330: 2020 2020 2020 2020 2020 2020 7461 6773              tags
+0000c340: 3d72 6f6f 745f 7461 6773 2c0a 2020 2020  =root_tags,.    
+0000c350: 2020 2020 2020 2020 6d65 7461 6461 7461          metadata
+0000c360: 3d72 6f6f 745f 6d65 7461 6461 7461 2c0a  =root_metadata,.
+0000c370: 2020 2020 2020 2020 2020 2020 6461 7461              data
+0000c380: 3d7b 0a20 2020 2020 2020 2020 2020 2020  ={.             
+0000c390: 2020 2022 6f75 7470 7574 223a 2073 7461     "output": sta
+0000c3a0: 7465 5b22 6669 6e61 6c5f 6f75 7470 7574  te["final_output
+0000c3b0: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+0000c3c0: 7d2c 0a20 2020 2020 2020 2029 0a20 2020  },.        ).   
+0000c3d0: 2020 2020 2069 6620 5f72 6f6f 745f 6576       if _root_ev
+0000c3e0: 656e 745f 6669 6c74 6572 2e69 6e63 6c75  ent_filter.inclu
+0000c3f0: 6465 5f65 7665 6e74 2865 7665 6e74 2c20  de_event(event, 
+0000c400: 7374 6174 655b 2274 7970 6522 5d29 3a0a  state["type"]):.
+0000c410: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
+0000c420: 6420 6576 656e 740a 0a20 2020 2064 6566  d event..    def
+0000c430: 2074 7261 6e73 666f 726d 280a 2020 2020   transform(.    
+0000c440: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+0000c450: 2020 696e 7075 743a 2049 7465 7261 746f    input: Iterato
+0000c460: 725b 496e 7075 745d 2c0a 2020 2020 2020  r[Input],.      
+0000c470: 2020 636f 6e66 6967 3a20 4f70 7469 6f6e    config: Option
+0000c480: 616c 5b52 756e 6e61 626c 6543 6f6e 6669  al[RunnableConfi
+0000c490: 675d 203d 204e 6f6e 652c 0a20 2020 2020  g] = None,.     
+0000c4a0: 2020 202a 2a6b 7761 7267 733a 204f 7074     **kwargs: Opt
+0000c4b0: 696f 6e61 6c5b 416e 795d 2c0a 2020 2020  ional[Any],.    
+0000c4c0: 2920 2d3e 2049 7465 7261 746f 725b 4f75  ) -> Iterator[Ou
+0000c4d0: 7470 7574 5d3a 0a20 2020 2020 2020 2022  tput]:.        "
+0000c4e0: 2222 0a20 2020 2020 2020 2044 6566 6175  "".        Defau
+0000c4f0: 6c74 2069 6d70 6c65 6d65 6e74 6174 696f  lt implementatio
+0000c500: 6e20 6f66 2074 7261 6e73 666f 726d 2c20  n of transform, 
+0000c510: 7768 6963 6820 6275 6666 6572 7320 696e  which buffers in
+0000c520: 7075 7420 616e 6420 7468 656e 2063 616c  put and then cal
+0000c530: 6c73 2073 7472 6561 6d2e 0a20 2020 2020  ls stream..     
+0000c540: 2020 2053 7562 636c 6173 7365 7320 7368     Subclasses sh
+0000c550: 6f75 6c64 206f 7665 7272 6964 6520 7468  ould override th
+0000c560: 6973 206d 6574 686f 6420 6966 2074 6865  is method if the
+0000c570: 7920 6361 6e20 7374 6172 7420 7072 6f64  y can start prod
+0000c580: 7563 696e 6720 6f75 7470 7574 2077 6869  ucing output whi
+0000c590: 6c65 0a20 2020 2020 2020 2069 6e70 7574  le.        input
+0000c5a0: 2069 7320 7374 696c 6c20 6265 696e 6720   is still being 
+0000c5b0: 6765 6e65 7261 7465 642e 0a20 2020 2020  generated..     
+0000c5c0: 2020 2022 2222 0a20 2020 2020 2020 2066     """.        f
+0000c5d0: 696e 616c 3a20 496e 7075 740a 2020 2020  inal: Input.    
+0000c5e0: 2020 2020 676f 745f 6669 7273 745f 7661      got_first_va
+0000c5f0: 6c20 3d20 4661 6c73 650a 0a20 2020 2020  l = False..     
+0000c600: 2020 2066 6f72 2069 6368 756e 6b20 696e     for ichunk in
+0000c610: 2069 6e70 7574 3a0a 2020 2020 2020 2020   input:.        
+0000c620: 2020 2020 2320 5468 6520 6465 6661 756c      # The defaul
+0000c630: 7420 696d 706c 656d 656e 7461 7469 6f6e  t implementation
+0000c640: 206f 6620 7472 616e 7366 6f72 6d20 6973   of transform is
+0000c650: 2074 6f20 6275 6666 6572 2069 6e70 7574   to buffer input
+0000c660: 2061 6e64 0a20 2020 2020 2020 2020 2020   and.           
+0000c670: 2023 2074 6865 6e20 6361 6c6c 2073 7472   # then call str
+0000c680: 6561 6d2e 0a20 2020 2020 2020 2020 2020  eam..           
+0000c690: 2023 2049 7427 6c6c 2061 7474 656d 7074   # It'll attempt
+0000c6a0: 2074 6f20 6761 7468 6572 2061 6c6c 2069   to gather all i
+0000c6b0: 6e70 7574 2069 6e74 6f20 6120 7369 6e67  nput into a sing
+0000c6c0: 6c65 2063 6875 6e6b 2075 7369 6e67 0a20  le chunk using. 
+0000c6d0: 2020 2020 2020 2020 2020 2023 2074 6865             # the
+0000c6e0: 2060 2b60 206f 7065 7261 746f 722e 0a20   `+` operator.. 
+0000c6f0: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
+0000c700: 7468 6520 696e 7075 7420 6973 206e 6f74  the input is not
+0000c710: 2061 6464 6162 6c65 2c20 7468 656e 2077   addable, then w
+0000c720: 6527 6c6c 2061 7373 756d 6520 7468 6174  e'll assume that
+0000c730: 2077 6520 6361 6e0a 2020 2020 2020 2020   we can.        
+0000c740: 2020 2020 2320 6f6e 6c79 206f 7065 7261      # only opera
+0000c750: 7465 206f 6e20 7468 6520 6c61 7374 2063  te on the last c
+0000c760: 6875 6e6b 2c0a 2020 2020 2020 2020 2020  hunk,.          
+0000c770: 2020 2320 616e 6420 7765 276c 6c20 6974    # and we'll it
+0000c780: 6572 6174 6520 756e 7469 6c20 7765 2067  erate until we g
+0000c790: 6574 2074 6f20 7468 6520 6c61 7374 2063  et to the last c
+0000c7a0: 6875 6e6b 2e0a 2020 2020 2020 2020 2020  hunk..          
+0000c7b0: 2020 6966 206e 6f74 2067 6f74 5f66 6972    if not got_fir
+0000c7c0: 7374 5f76 616c 3a0a 2020 2020 2020 2020  st_val:.        
+0000c7d0: 2020 2020 2020 2020 6669 6e61 6c20 3d20          final = 
+0000c7e0: 6963 6875 6e6b 0a20 2020 2020 2020 2020  ichunk.         
+0000c7f0: 2020 2020 2020 2067 6f74 5f66 6972 7374         got_first
+0000c800: 5f76 616c 203d 2054 7275 650a 2020 2020  _val = True.    
+0000c810: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000c820: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+0000c830: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0000c840: 2020 2020 2020 2066 696e 616c 203d 2066         final = f
+0000c850: 696e 616c 202b 2069 6368 756e 6b20 2023  inal + ichunk  #
+0000c860: 2074 7970 653a 2069 676e 6f72 655b 6f70   type: ignore[op
+0000c870: 6572 6174 6f72 5d0a 2020 2020 2020 2020  erator].        
+0000c880: 2020 2020 2020 2020 6578 6365 7074 2054          except T
+0000c890: 7970 6545 7272 6f72 3a0a 2020 2020 2020  ypeError:.      
+0000c8a0: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+0000c8b0: 6e61 6c20 3d20 6963 6875 6e6b 0a0a 2020  nal = ichunk..  
+0000c8c0: 2020 2020 2020 6966 2067 6f74 5f66 6972        if got_fir
+0000c8d0: 7374 5f76 616c 3a0a 2020 2020 2020 2020  st_val:.        
+0000c8e0: 2020 2020 7969 656c 6420 6672 6f6d 2073      yield from s
+0000c8f0: 656c 662e 7374 7265 616d 2866 696e 616c  elf.stream(final
+0000c900: 2c20 636f 6e66 6967 2c20 2a2a 6b77 6172  , config, **kwar
+0000c910: 6773 290a 0a20 2020 2061 7379 6e63 2064  gs)..    async d
+0000c920: 6566 2061 7472 616e 7366 6f72 6d28 0a20  ef atransform(. 
+0000c930: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0000c940: 2020 2020 2069 6e70 7574 3a20 4173 796e       input: Asyn
+0000c950: 6349 7465 7261 746f 725b 496e 7075 745d  cIterator[Input]
+0000c960: 2c0a 2020 2020 2020 2020 636f 6e66 6967  ,.        config
+0000c970: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
+0000c980: 626c 6543 6f6e 6669 675d 203d 204e 6f6e  bleConfig] = Non
+0000c990: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
+0000c9a0: 7267 733a 204f 7074 696f 6e61 6c5b 416e  rgs: Optional[An
+0000c9b0: 795d 2c0a 2020 2020 2920 2d3e 2041 7379  y],.    ) -> Asy
+0000c9c0: 6e63 4974 6572 6174 6f72 5b4f 7574 7075  ncIterator[Outpu
+0000c9d0: 745d 3a0a 2020 2020 2020 2020 2222 220a  t]:.        """.
+0000c9e0: 2020 2020 2020 2020 4465 6661 756c 7420          Default 
+0000c9f0: 696d 706c 656d 656e 7461 7469 6f6e 206f  implementation o
+0000ca00: 6620 6174 7261 6e73 666f 726d 2c20 7768  f atransform, wh
+0000ca10: 6963 6820 6275 6666 6572 7320 696e 7075  ich buffers inpu
+0000ca20: 7420 616e 6420 6361 6c6c 7320 6173 7472  t and calls astr
+0000ca30: 6561 6d2e 0a20 2020 2020 2020 2053 7562  eam..        Sub
+0000ca40: 636c 6173 7365 7320 7368 6f75 6c64 206f  classes should o
+0000ca50: 7665 7272 6964 6520 7468 6973 206d 6574  verride this met
+0000ca60: 686f 6420 6966 2074 6865 7920 6361 6e20  hod if they can 
+0000ca70: 7374 6172 7420 7072 6f64 7563 696e 6720  start producing 
+0000ca80: 6f75 7470 7574 2077 6869 6c65 0a20 2020  output while.   
+0000ca90: 2020 2020 2069 6e70 7574 2069 7320 7374       input is st
+0000caa0: 696c 6c20 6265 696e 6720 6765 6e65 7261  ill being genera
+0000cab0: 7465 642e 0a20 2020 2020 2020 2022 2222  ted..        """
+0000cac0: 0a20 2020 2020 2020 2066 696e 616c 3a20  .        final: 
+0000cad0: 496e 7075 740a 2020 2020 2020 2020 676f  Input.        go
+0000cae0: 745f 6669 7273 745f 7661 6c20 3d20 4661  t_first_val = Fa
+0000caf0: 6c73 650a 0a20 2020 2020 2020 2061 7379  lse..        asy
+0000cb00: 6e63 2066 6f72 2069 6368 756e 6b20 696e  nc for ichunk in
+0000cb10: 2069 6e70 7574 3a0a 2020 2020 2020 2020   input:.        
+0000cb20: 2020 2020 2320 5468 6520 6465 6661 756c      # The defaul
+0000cb30: 7420 696d 706c 656d 656e 7461 7469 6f6e  t implementation
+0000cb40: 206f 6620 7472 616e 7366 6f72 6d20 6973   of transform is
+0000cb50: 2074 6f20 6275 6666 6572 2069 6e70 7574   to buffer input
+0000cb60: 2061 6e64 0a20 2020 2020 2020 2020 2020   and.           
+0000cb70: 2023 2074 6865 6e20 6361 6c6c 2073 7472   # then call str
+0000cb80: 6561 6d2e 0a20 2020 2020 2020 2020 2020  eam..           
+0000cb90: 2023 2049 7427 6c6c 2061 7474 656d 7074   # It'll attempt
+0000cba0: 2074 6f20 6761 7468 6572 2061 6c6c 2069   to gather all i
+0000cbb0: 6e70 7574 2069 6e74 6f20 6120 7369 6e67  nput into a sing
+0000cbc0: 6c65 2063 6875 6e6b 2075 7369 6e67 0a20  le chunk using. 
+0000cbd0: 2020 2020 2020 2020 2020 2023 2074 6865             # the
+0000cbe0: 2060 2b60 206f 7065 7261 746f 722e 0a20   `+` operator.. 
+0000cbf0: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
+0000cc00: 7468 6520 696e 7075 7420 6973 206e 6f74  the input is not
+0000cc10: 2061 6464 6162 6c65 2c20 7468 656e 2077   addable, then w
+0000cc20: 6527 6c6c 2061 7373 756d 6520 7468 6174  e'll assume that
+0000cc30: 2077 6520 6361 6e0a 2020 2020 2020 2020   we can.        
+0000cc40: 2020 2020 2320 6f6e 6c79 206f 7065 7261      # only opera
+0000cc50: 7465 206f 6e20 7468 6520 6c61 7374 2063  te on the last c
+0000cc60: 6875 6e6b 2c0a 2020 2020 2020 2020 2020  hunk,.          
+0000cc70: 2020 2320 616e 6420 7765 276c 6c20 6974    # and we'll it
+0000cc80: 6572 6174 6520 756e 7469 6c20 7765 2067  erate until we g
+0000cc90: 6574 2074 6f20 7468 6520 6c61 7374 2063  et to the last c
+0000cca0: 6875 6e6b 2e0a 2020 2020 2020 2020 2020  hunk..          
+0000ccb0: 2020 6966 206e 6f74 2067 6f74 5f66 6972    if not got_fir
+0000ccc0: 7374 5f76 616c 3a0a 2020 2020 2020 2020  st_val:.        
+0000ccd0: 2020 2020 2020 2020 6669 6e61 6c20 3d20          final = 
+0000cce0: 6963 6875 6e6b 0a20 2020 2020 2020 2020  ichunk.         
+0000ccf0: 2020 2020 2020 2067 6f74 5f66 6972 7374         got_first
+0000cd00: 5f76 616c 203d 2054 7275 650a 2020 2020  _val = True.    
+0000cd10: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000cd20: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+0000cd30: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0000cd40: 2020 2020 2020 2066 696e 616c 203d 2066         final = f
+0000cd50: 696e 616c 202b 2069 6368 756e 6b20 2023  inal + ichunk  #
+0000cd60: 2074 7970 653a 2069 676e 6f72 655b 6f70   type: ignore[op
+0000cd70: 6572 6174 6f72 5d0a 2020 2020 2020 2020  erator].        
+0000cd80: 2020 2020 2020 2020 6578 6365 7074 2054          except T
+0000cd90: 7970 6545 7272 6f72 3a0a 2020 2020 2020  ypeError:.      
+0000cda0: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+0000cdb0: 6e61 6c20 3d20 6963 6875 6e6b 0a0a 2020  nal = ichunk..  
+0000cdc0: 2020 2020 2020 6966 2067 6f74 5f66 6972        if got_fir
+0000cdd0: 7374 5f76 616c 3a0a 2020 2020 2020 2020  st_val:.        
+0000cde0: 2020 2020 6173 796e 6320 666f 7220 6f75      async for ou
+0000cdf0: 7470 7574 2069 6e20 7365 6c66 2e61 7374  tput in self.ast
+0000ce00: 7265 616d 2866 696e 616c 2c20 636f 6e66  ream(final, conf
+0000ce10: 6967 2c20 2a2a 6b77 6172 6773 293a 0a20  ig, **kwargs):. 
+0000ce20: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+0000ce30: 6965 6c64 206f 7574 7075 740a 0a20 2020  ield output..   
+0000ce40: 2064 6566 2062 696e 6428 7365 6c66 2c20   def bind(self, 
+0000ce50: 2a2a 6b77 6172 6773 3a20 416e 7929 202d  **kwargs: Any) -
+0000ce60: 3e20 5275 6e6e 6162 6c65 5b49 6e70 7574  > Runnable[Input
+0000ce70: 2c20 4f75 7470 7574 5d3a 0a20 2020 2020  , Output]:.     
+0000ce80: 2020 2022 2222 0a20 2020 2020 2020 2042     """.        B
+0000ce90: 696e 6420 6172 6775 6d65 6e74 7320 746f  ind arguments to
+0000cea0: 2061 2052 756e 6e61 626c 652c 2072 6574   a Runnable, ret
+0000ceb0: 7572 6e69 6e67 2061 206e 6577 2052 756e  urning a new Run
+0000cec0: 6e61 626c 652e 0a0a 2020 2020 2020 2020  nable...        
+0000ced0: 5573 6566 756c 2077 6865 6e20 6120 7275  Useful when a ru
+0000cee0: 6e6e 6162 6c65 2069 6e20 6120 6368 6169  nnable in a chai
+0000cef0: 6e20 7265 7175 6972 6573 2061 6e20 6172  n requires an ar
+0000cf00: 6775 6d65 6e74 2074 6861 7420 6973 206e  gument that is n
+0000cf10: 6f74 0a20 2020 2020 2020 2069 6e20 7468  ot.        in th
+0000cf20: 6520 6f75 7470 7574 206f 6620 7468 6520  e output of the 
+0000cf30: 7072 6576 696f 7573 2072 756e 6e61 626c  previous runnabl
+0000cf40: 6520 6f72 2069 6e63 6c75 6465 6420 696e  e or included in
+0000cf50: 2074 6865 2075 7365 7220 696e 7075 742e   the user input.
+0000cf60: 0a0a 2020 2020 2020 2020 4578 616d 706c  ..        Exampl
+0000cf70: 653a 0a0a 2020 2020 2020 2020 2e2e 2063  e:..        .. c
+0000cf80: 6f64 652d 626c 6f63 6b3a 3a20 7079 7468  ode-block:: pyth
+0000cf90: 6f6e 0a0a 2020 2020 2020 2020 2020 2020  on..            
+0000cfa0: 6672 6f6d 206c 616e 6763 6861 696e 5f63  from langchain_c
+0000cfb0: 6f6d 6d75 6e69 7479 2e63 6861 745f 6d6f  ommunity.chat_mo
+0000cfc0: 6465 6c73 2069 6d70 6f72 7420 4368 6174  dels import Chat
+0000cfd0: 4f6c 6c61 6d61 0a20 2020 2020 2020 2020  Ollama.         
+0000cfe0: 2020 2066 726f 6d20 6c61 6e67 6368 6169     from langchai
+0000cff0: 6e5f 636f 7265 2e6f 7574 7075 745f 7061  n_core.output_pa
+0000d000: 7273 6572 7320 696d 706f 7274 2053 7472  rsers import Str
+0000d010: 4f75 7470 7574 5061 7273 6572 0a0a 2020  OutputParser..  
+0000d020: 2020 2020 2020 2020 2020 6c6c 6d20 3d20            llm = 
+0000d030: 4368 6174 4f6c 6c61 6d61 286d 6f64 656c  ChatOllama(model
+0000d040: 3d27 6c6c 616d 6132 2729 0a0a 2020 2020  ='llama2')..    
+0000d050: 2020 2020 2020 2020 2320 5769 7468 6f75          # Withou
+0000d060: 7420 6269 6e64 2e0a 2020 2020 2020 2020  t bind..        
+0000d070: 2020 2020 6368 6169 6e20 3d20 280a 2020      chain = (.  
+0000d080: 2020 2020 2020 2020 2020 2020 2020 6c6c                ll
+0000d090: 6d0a 2020 2020 2020 2020 2020 2020 2020  m.              
+0000d0a0: 2020 7c20 5374 724f 7574 7075 7450 6172    | StrOutputPar
+0000d0b0: 7365 7228 290a 2020 2020 2020 2020 2020  ser().          
+0000d0c0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+0000d0d0: 2063 6861 696e 2e69 6e76 6f6b 6528 2252   chain.invoke("R
+0000d0e0: 6570 6561 7420 7175 6f74 6564 2077 6f72  epeat quoted wor
+0000d0f0: 6473 2065 7861 6374 6c79 3a20 274f 6e65  ds exactly: 'One
+0000d100: 2074 776f 2074 6872 6565 2066 6f75 7220   two three four 
+0000d110: 6669 7665 2e27 2229 0a20 2020 2020 2020  five.'").       
+0000d120: 2020 2020 2023 204f 7574 7075 7420 6973       # Output is
+0000d130: 2027 4f6e 6520 7477 6f20 7468 7265 6520   'One two three 
+0000d140: 666f 7572 2066 6976 652e 270a 0a20 2020  four five.'..   
+0000d150: 2020 2020 2020 2020 2023 2057 6974 6820           # With 
+0000d160: 6269 6e64 2e0a 2020 2020 2020 2020 2020  bind..          
+0000d170: 2020 6368 6169 6e20 3d20 280a 2020 2020    chain = (.    
+0000d180: 2020 2020 2020 2020 2020 2020 6c6c 6d2e              llm.
+0000d190: 6269 6e64 2873 746f 703d 5b22 7468 7265  bind(stop=["thre
+0000d1a0: 6522 5d29 0a20 2020 2020 2020 2020 2020  e"]).           
+0000d1b0: 2020 2020 207c 2053 7472 4f75 7470 7574       | StrOutput
+0000d1c0: 5061 7273 6572 2829 0a20 2020 2020 2020  Parser().       
+0000d1d0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0000d1e0: 2020 2020 6368 6169 6e2e 696e 766f 6b65      chain.invoke
+0000d1f0: 2822 5265 7065 6174 2071 756f 7465 6420  ("Repeat quoted 
+0000d200: 776f 7264 7320 6578 6163 746c 793a 2027  words exactly: '
+0000d210: 4f6e 6520 7477 6f20 7468 7265 6520 666f  One two three fo
+0000d220: 7572 2066 6976 652e 2722 290a 2020 2020  ur five.'").    
+0000d230: 2020 2020 2020 2020 2320 4f75 7470 7574          # Output
+0000d240: 2069 7320 274f 6e65 2074 776f 270a 0a20   is 'One two'.. 
+0000d250: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0000d260: 2020 2072 6574 7572 6e20 5275 6e6e 6162     return Runnab
+0000d270: 6c65 4269 6e64 696e 6728 626f 756e 643d  leBinding(bound=
+0000d280: 7365 6c66 2c20 6b77 6172 6773 3d6b 7761  self, kwargs=kwa
+0000d290: 7267 732c 2063 6f6e 6669 673d 7b7d 290a  rgs, config={}).
+0000d2a0: 0a20 2020 2064 6566 2077 6974 685f 636f  .    def with_co
+0000d2b0: 6e66 6967 280a 2020 2020 2020 2020 7365  nfig(.        se
+0000d2c0: 6c66 2c0a 2020 2020 2020 2020 636f 6e66  lf,.        conf
+0000d2d0: 6967 3a20 4f70 7469 6f6e 616c 5b52 756e  ig: Optional[Run
+0000d2e0: 6e61 626c 6543 6f6e 6669 675d 203d 204e  nableConfig] = N
+0000d2f0: 6f6e 652c 0a20 2020 2020 2020 2023 2053  one,.        # S
+0000d300: 6164 6c79 2055 6e70 6163 6b20 6973 206e  adly Unpack is n
+0000d310: 6f74 2077 656c 6c20 7375 7070 6f72 7465  ot well supporte
+0000d320: 6420 6279 206d 7970 7920 736f 2074 6869  d by mypy so thi
+0000d330: 7320 7769 6c6c 2068 6176 6520 746f 2062  s will have to b
+0000d340: 6520 756e 7479 7065 640a 2020 2020 2020  e untyped.      
+0000d350: 2020 2a2a 6b77 6172 6773 3a20 416e 792c    **kwargs: Any,
+0000d360: 0a20 2020 2029 202d 3e20 5275 6e6e 6162  .    ) -> Runnab
+0000d370: 6c65 5b49 6e70 7574 2c20 4f75 7470 7574  le[Input, Output
+0000d380: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
+0000d390: 2020 2020 2020 2042 696e 6420 636f 6e66         Bind conf
+0000d3a0: 6967 2074 6f20 6120 5275 6e6e 6162 6c65  ig to a Runnable
+0000d3b0: 2c20 7265 7475 726e 696e 6720 6120 6e65  , returning a ne
+0000d3c0: 7720 5275 6e6e 6162 6c65 2e0a 2020 2020  w Runnable..    
+0000d3d0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0000d3e0: 7265 7475 726e 2052 756e 6e61 626c 6542  return RunnableB
+0000d3f0: 696e 6469 6e67 280a 2020 2020 2020 2020  inding(.        
+0000d400: 2020 2020 626f 756e 643d 7365 6c66 2c0a      bound=self,.
+0000d410: 2020 2020 2020 2020 2020 2020 636f 6e66              conf
+0000d420: 6967 3d63 6173 7428 0a20 2020 2020 2020  ig=cast(.       
+0000d430: 2020 2020 2020 2020 2052 756e 6e61 626c           Runnabl
+0000d440: 6543 6f6e 6669 672c 0a20 2020 2020 2020  eConfig,.       
+0000d450: 2020 2020 2020 2020 207b 2a2a 2863 6f6e           {**(con
+0000d460: 6669 6720 6f72 207b 7d29 2c20 2a2a 6b77  fig or {}), **kw
+0000d470: 6172 6773 7d2c 0a20 2020 2020 2020 2020  args},.         
+0000d480: 2020 2029 2c20 2023 2074 7970 653a 2069     ),  # type: i
+0000d490: 676e 6f72 655b 6d69 7363 5d0a 2020 2020  gnore[misc].    
+0000d4a0: 2020 2020 2020 2020 6b77 6172 6773 3d7b          kwargs={
+0000d4b0: 7d2c 0a20 2020 2020 2020 2029 0a0a 2020  },.        )..  
+0000d4c0: 2020 6465 6620 7769 7468 5f6c 6973 7465    def with_liste
+0000d4d0: 6e65 7273 280a 2020 2020 2020 2020 7365  ners(.        se
+0000d4e0: 6c66 2c0a 2020 2020 2020 2020 2a2c 0a20  lf,.        *,. 
+0000d4f0: 2020 2020 2020 206f 6e5f 7374 6172 743a         on_start:
+0000d500: 204f 7074 696f 6e61 6c5b 4c69 7374 656e   Optional[Listen
+0000d510: 6572 5d20 3d20 4e6f 6e65 2c0a 2020 2020  er] = None,.    
+0000d520: 2020 2020 6f6e 5f65 6e64 3a20 4f70 7469      on_end: Opti
+0000d530: 6f6e 616c 5b4c 6973 7465 6e65 725d 203d  onal[Listener] =
+0000d540: 204e 6f6e 652c 0a20 2020 2020 2020 206f   None,.        o
+0000d550: 6e5f 6572 726f 723a 204f 7074 696f 6e61  n_error: Optiona
+0000d560: 6c5b 4c69 7374 656e 6572 5d20 3d20 4e6f  l[Listener] = No
+0000d570: 6e65 2c0a 2020 2020 2920 2d3e 2052 756e  ne,.    ) -> Run
+0000d580: 6e61 626c 655b 496e 7075 742c 204f 7574  nable[Input, Out
+0000d590: 7075 745d 3a0a 2020 2020 2020 2020 2222  put]:.        ""
+0000d5a0: 220a 2020 2020 2020 2020 4269 6e64 206c  ".        Bind l
+0000d5b0: 6966 6563 7963 6c65 206c 6973 7465 6e65  ifecycle listene
+0000d5c0: 7273 2074 6f20 6120 5275 6e6e 6162 6c65  rs to a Runnable
+0000d5d0: 2c20 7265 7475 726e 696e 6720 6120 6e65  , returning a ne
+0000d5e0: 7720 5275 6e6e 6162 6c65 2e0a 0a20 2020  w Runnable...   
+0000d5f0: 2020 2020 206f 6e5f 7374 6172 743a 2043       on_start: C
+0000d600: 616c 6c65 6420 6265 666f 7265 2074 6865  alled before the
+0000d610: 2072 756e 6e61 626c 6520 7374 6172 7473   runnable starts
+0000d620: 2072 756e 6e69 6e67 2c20 7769 7468 2074   running, with t
+0000d630: 6865 2052 756e 206f 626a 6563 742e 0a20  he Run object.. 
+0000d640: 2020 2020 2020 206f 6e5f 656e 643a 2043         on_end: C
+0000d650: 616c 6c65 6420 6166 7465 7220 7468 6520  alled after the 
+0000d660: 7275 6e6e 6162 6c65 2066 696e 6973 6865  runnable finishe
+0000d670: 7320 7275 6e6e 696e 672c 2077 6974 6820  s running, with 
+0000d680: 7468 6520 5275 6e20 6f62 6a65 6374 2e0a  the Run object..
+0000d690: 2020 2020 2020 2020 6f6e 5f65 7272 6f72          on_error
+0000d6a0: 3a20 4361 6c6c 6564 2069 6620 7468 6520  : Called if the 
+0000d6b0: 7275 6e6e 6162 6c65 2074 6872 6f77 7320  runnable throws 
+0000d6c0: 616e 2065 7272 6f72 2c20 7769 7468 2074  an error, with t
+0000d6d0: 6865 2052 756e 206f 626a 6563 742e 0a0a  he Run object...
+0000d6e0: 2020 2020 2020 2020 5468 6520 5275 6e20          The Run 
+0000d6f0: 6f62 6a65 6374 2063 6f6e 7461 696e 7320  object contains 
+0000d700: 696e 666f 726d 6174 696f 6e20 6162 6f75  information abou
+0000d710: 7420 7468 6520 7275 6e2c 2069 6e63 6c75  t the run, inclu
+0000d720: 6469 6e67 2069 7473 2069 642c 0a20 2020  ding its id,.   
+0000d730: 2020 2020 2074 7970 652c 2069 6e70 7574       type, input
+0000d740: 2c20 6f75 7470 7574 2c20 6572 726f 722c  , output, error,
+0000d750: 2073 7461 7274 5f74 696d 652c 2065 6e64   start_time, end
+0000d760: 5f74 696d 652c 2061 6e64 2061 6e79 2074  _time, and any t
+0000d770: 6167 7320 6f72 206d 6574 6164 6174 610a  ags or metadata.
+0000d780: 2020 2020 2020 2020 6164 6465 6420 746f          added to
+0000d790: 2074 6865 2072 756e 2e0a 0a20 2020 2020   the run...     
+0000d7a0: 2020 2045 7861 6d70 6c65 3a0a 0a20 2020     Example:..   
+0000d7b0: 2020 2020 202e 2e20 636f 6465 2d62 6c6f       .. code-blo
+0000d7c0: 636b 3a3a 2070 7974 686f 6e0a 2020 2020  ck:: python.    
+0000d7d0: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
+0000d7e0: 6763 6861 696e 5f63 6f72 652e 7275 6e6e  gchain_core.runn
+0000d7f0: 6162 6c65 7320 696d 706f 7274 2052 756e  ables import Run
+0000d800: 6e61 626c 654c 616d 6264 610a 2020 2020  nableLambda.    
+0000d810: 2020 2020 2020 2020 696d 706f 7274 2074          import t
+0000d820: 696d 650a 0a20 2020 2020 2020 2020 2020  ime..           
+0000d830: 2064 6566 2074 6573 745f 7275 6e6e 6162   def test_runnab
+0000d840: 6c65 2874 696d 655f 746f 5f73 6c65 6570  le(time_to_sleep
+0000d850: 203a 2069 6e74 293a 0a20 2020 2020 2020   : int):.       
+0000d860: 2020 2020 2020 2020 2074 696d 652e 736c           time.sl
+0000d870: 6565 7028 7469 6d65 5f74 6f5f 736c 6565  eep(time_to_slee
+0000d880: 7029 0a0a 2020 2020 2020 2020 2020 2020  p)..            
+0000d890: 6465 6620 666e 5f73 7461 7274 2872 756e  def fn_start(run
+0000d8a0: 5f6f 626a 203a 2052 756e 6e61 626c 6529  _obj : Runnable)
+0000d8b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000d8c0: 2020 7072 696e 7428 2273 7461 7274 5f74    print("start_t
+0000d8d0: 696d 653a 222c 2072 756e 5f6f 626a 2e73  ime:", run_obj.s
+0000d8e0: 7461 7274 5f74 696d 6529 0a0a 2020 2020  tart_time)..    
+0000d8f0: 2020 2020 2020 2020 6465 6620 666e 5f65          def fn_e
+0000d900: 6e64 2872 756e 5f6f 626a 203a 2052 756e  nd(run_obj : Run
+0000d910: 6e61 626c 6529 3a0a 2020 2020 2020 2020  nable):.        
+0000d920: 2020 2020 2020 2020 7072 696e 7428 2265          print("e
+0000d930: 6e64 5f74 696d 653a 222c 2072 756e 5f6f  nd_time:", run_o
+0000d940: 626a 2e65 6e64 5f74 696d 6529 0a0a 2020  bj.end_time)..  
+0000d950: 2020 2020 2020 2020 2020 5275 6e6e 6162            Runnab
+0000d960: 6c65 4c61 6d62 6461 2874 6573 745f 7275  leLambda(test_ru
+0000d970: 6e6e 6162 6c65 292e 7769 7468 5f6c 6973  nnable).with_lis
+0000d980: 7465 6e65 7273 280a 2020 2020 2020 2020  teners(.        
+0000d990: 2020 2020 2020 2020 6f6e 5f73 7461 7274          on_start
+0000d9a0: 3d66 6e5f 7374 6172 742c 0a20 2020 2020  =fn_start,.     
+0000d9b0: 2020 2020 2020 2020 2020 206f 6e5f 656e             on_en
+0000d9c0: 643d 666e 5f65 6e64 0a20 2020 2020 2020  d=fn_end.       
+0000d9d0: 2020 2020 2020 2020 2029 2e69 6e76 6f6b           ).invok
+0000d9e0: 6528 3229 0a20 2020 2020 2020 2022 2222  e(2).        """
+0000d9f0: 0a20 2020 2020 2020 2066 726f 6d20 6c61  .        from la
+0000da00: 6e67 6368 6169 6e5f 636f 7265 2e74 7261  ngchain_core.tra
+0000da10: 6365 7273 2e72 6f6f 745f 6c69 7374 656e  cers.root_listen
+0000da20: 6572 7320 696d 706f 7274 2052 6f6f 744c  ers import RootL
+0000da30: 6973 7465 6e65 7273 5472 6163 6572 0a0a  istenersTracer..
+0000da40: 2020 2020 2020 2020 7265 7475 726e 2052          return R
+0000da50: 756e 6e61 626c 6542 696e 6469 6e67 280a  unnableBinding(.
+0000da60: 2020 2020 2020 2020 2020 2020 626f 756e              boun
+0000da70: 643d 7365 6c66 2c0a 2020 2020 2020 2020  d=self,.        
+0000da80: 2020 2020 636f 6e66 6967 5f66 6163 746f      config_facto
+0000da90: 7269 6573 3d5b 0a20 2020 2020 2020 2020  ries=[.         
+0000daa0: 2020 2020 2020 206c 616d 6264 6120 636f         lambda co
+0000dab0: 6e66 6967 3a20 7b0a 2020 2020 2020 2020  nfig: {.        
+0000dac0: 2020 2020 2020 2020 2020 2020 2263 616c              "cal
+0000dad0: 6c62 6163 6b73 223a 205b 0a20 2020 2020  lbacks": [.     
+0000dae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000daf0: 2020 2052 6f6f 744c 6973 7465 6e65 7273     RootListeners
+0000db00: 5472 6163 6572 280a 2020 2020 2020 2020  Tracer(.        
+0000db10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000db20: 2020 2020 636f 6e66 6967 3d63 6f6e 6669      config=confi
+0000db30: 672c 0a20 2020 2020 2020 2020 2020 2020  g,.             
+0000db40: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0000db50: 6e5f 7374 6172 743d 6f6e 5f73 7461 7274  n_start=on_start
+0000db60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000db70: 2020 2020 2020 2020 2020 2020 2020 6f6e                on
+0000db80: 5f65 6e64 3d6f 6e5f 656e 642c 0a20 2020  _end=on_end,.   
+0000db90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dba0: 2020 2020 2020 2020 206f 6e5f 6572 726f           on_erro
+0000dbb0: 723d 6f6e 5f65 7272 6f72 2c0a 2020 2020  r=on_error,.    
+0000dbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dbd0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0000dbe0: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
+0000dbf0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0000dc00: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
+0000dc10: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
+0000dc20: 2077 6974 685f 7479 7065 7328 0a20 2020   with_types(.   
+0000dc30: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0000dc40: 2020 202a 2c0a 2020 2020 2020 2020 696e     *,.        in
+0000dc50: 7075 745f 7479 7065 3a20 4f70 7469 6f6e  put_type: Option
+0000dc60: 616c 5b54 7970 655b 496e 7075 745d 5d20  al[Type[Input]] 
+0000dc70: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0000dc80: 6f75 7470 7574 5f74 7970 653a 204f 7074  output_type: Opt
+0000dc90: 696f 6e61 6c5b 5479 7065 5b4f 7574 7075  ional[Type[Outpu
+0000dca0: 745d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  t]] = None,.    
+0000dcb0: 2920 2d3e 2052 756e 6e61 626c 655b 496e  ) -> Runnable[In
+0000dcc0: 7075 742c 204f 7574 7075 745d 3a0a 2020  put, Output]:.  
+0000dcd0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0000dce0: 2020 4269 6e64 2069 6e70 7574 2061 6e64    Bind input and
+0000dcf0: 206f 7574 7075 7420 7479 7065 7320 746f   output types to
+0000dd00: 2061 2052 756e 6e61 626c 652c 2072 6574   a Runnable, ret
+0000dd10: 7572 6e69 6e67 2061 206e 6577 2052 756e  urning a new Run
+0000dd20: 6e61 626c 652e 0a20 2020 2020 2020 2022  nable..        "
+0000dd30: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
+0000dd40: 6e20 5275 6e6e 6162 6c65 4269 6e64 696e  n RunnableBindin
+0000dd50: 6728 0a20 2020 2020 2020 2020 2020 2062  g(.            b
+0000dd60: 6f75 6e64 3d73 656c 662c 0a20 2020 2020  ound=self,.     
+0000dd70: 2020 2020 2020 2063 7573 746f 6d5f 696e         custom_in
+0000dd80: 7075 745f 7479 7065 3d69 6e70 7574 5f74  put_type=input_t
+0000dd90: 7970 652c 0a20 2020 2020 2020 2020 2020  ype,.           
+0000dda0: 2063 7573 746f 6d5f 6f75 7470 7574 5f74   custom_output_t
+0000ddb0: 7970 653d 6f75 7470 7574 5f74 7970 652c  ype=output_type,
+0000ddc0: 0a20 2020 2020 2020 2020 2020 206b 7761  .            kwa
+0000ddd0: 7267 733d 7b7d 2c0a 2020 2020 2020 2020  rgs={},.        
+0000dde0: 290a 0a20 2020 2064 6566 2077 6974 685f  )..    def with_
+0000ddf0: 7265 7472 7928 0a20 2020 2020 2020 2073  retry(.        s
+0000de00: 656c 662c 0a20 2020 2020 2020 202a 2c0a  elf,.        *,.
+0000de10: 2020 2020 2020 2020 7265 7472 795f 6966          retry_if
+0000de20: 5f65 7863 6570 7469 6f6e 5f74 7970 653a  _exception_type:
+0000de30: 2054 7570 6c65 5b54 7970 655b 4261 7365   Tuple[Type[Base
+0000de40: 4578 6365 7074 696f 6e5d 2c20 2e2e 2e5d  Exception], ...]
+0000de50: 203d 2028 4578 6365 7074 696f 6e2c 292c   = (Exception,),
+0000de60: 0a20 2020 2020 2020 2077 6169 745f 6578  .        wait_ex
+0000de70: 706f 6e65 6e74 6961 6c5f 6a69 7474 6572  ponential_jitter
+0000de80: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
+0000de90: 2020 2020 2020 2073 746f 705f 6166 7465         stop_afte
+0000dea0: 725f 6174 7465 6d70 743a 2069 6e74 203d  r_attempt: int =
+0000deb0: 2033 2c0a 2020 2020 2920 2d3e 2052 756e   3,.    ) -> Run
+0000dec0: 6e61 626c 655b 496e 7075 742c 204f 7574  nable[Input, Out
+0000ded0: 7075 745d 3a0a 2020 2020 2020 2020 2222  put]:.        ""
+0000dee0: 2243 7265 6174 6520 6120 6e65 7720 5275  "Create a new Ru
+0000def0: 6e6e 6162 6c65 2074 6861 7420 7265 7472  nnable that retr
+0000df00: 6965 7320 7468 6520 6f72 6967 696e 616c  ies the original
+0000df10: 2072 756e 6e61 626c 6520 6f6e 2065 7863   runnable on exc
+0000df20: 6570 7469 6f6e 732e 0a0a 2020 2020 2020  eptions...      
+0000df30: 2020 4578 616d 706c 653a 0a0a 2020 2020    Example:..    
+0000df40: 2020 2020 2e2e 2063 6f64 652d 626c 6f63      .. code-bloc
+0000df50: 6b3a 3a20 7079 7468 6f6e 0a20 2020 2020  k:: python.     
+0000df60: 2020 2020 2020 2066 726f 6d20 6c61 6e67         from lang
+0000df70: 6368 6169 6e5f 636f 7265 2e72 756e 6e61  chain_core.runna
+0000df80: 626c 6573 2069 6d70 6f72 7420 5275 6e6e  bles import Runn
+0000df90: 6162 6c65 4c61 6d62 6461 0a0a 2020 2020  ableLambda..    
+0000dfa0: 2020 2020 2020 2020 636f 756e 7420 3d20          count = 
+0000dfb0: 300a 0a0a 2020 2020 2020 2020 2020 2020  0...            
+0000dfc0: 6465 6620 5f6c 616d 6264 6128 783a 2069  def _lambda(x: i
+0000dfd0: 6e74 2920 2d3e 204e 6f6e 653a 0a20 2020  nt) -> None:.   
+0000dfe0: 2020 2020 2020 2020 2020 2020 2067 6c6f               glo
+0000dff0: 6261 6c20 636f 756e 740a 2020 2020 2020  bal count.      
+0000e000: 2020 2020 2020 2020 2020 636f 756e 7420            count 
+0000e010: 3d20 636f 756e 7420 2b20 310a 2020 2020  = count + 1.    
+0000e020: 2020 2020 2020 2020 2020 2020 6966 2078              if x
+0000e030: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
+0000e040: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000e050: 2056 616c 7565 4572 726f 7228 2278 2069   ValueError("x i
+0000e060: 7320 3122 290a 2020 2020 2020 2020 2020  s 1").          
+0000e070: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000e080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e090: 2070 6173 730a 0a0a 2020 2020 2020 2020   pass...        
+0000e0a0: 2020 2020 7275 6e6e 6162 6c65 203d 2052      runnable = R
+0000e0b0: 756e 6e61 626c 654c 616d 6264 6128 5f6c  unnableLambda(_l
+0000e0c0: 616d 6264 6129 0a20 2020 2020 2020 2020  ambda).         
+0000e0d0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000e0e0: 2020 2020 2020 2020 7275 6e6e 6162 6c65          runnable
+0000e0f0: 2e77 6974 685f 7265 7472 7928 0a20 2020  .with_retry(.   
+0000e100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e110: 2073 746f 705f 6166 7465 725f 6174 7465   stop_after_atte
+0000e120: 6d70 743d 322c 0a20 2020 2020 2020 2020  mpt=2,.         
+0000e130: 2020 2020 2020 2020 2020 2072 6574 7279             retry
+0000e140: 5f69 665f 6578 6365 7074 696f 6e5f 7479  _if_exception_ty
+0000e150: 7065 3d28 5661 6c75 6545 7272 6f72 2c29  pe=(ValueError,)
+0000e160: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000e170: 2020 292e 696e 766f 6b65 2831 290a 2020    ).invoke(1).  
+0000e180: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0000e190: 2056 616c 7565 4572 726f 723a 0a20 2020   ValueError:.   
+0000e1a0: 2020 2020 2020 2020 2020 2020 2070 6173               pas
+0000e1b0: 730a 0a20 2020 2020 2020 2020 2020 2061  s..            a
+0000e1c0: 7373 6572 7420 2863 6f75 6e74 203d 3d20  ssert (count == 
+0000e1d0: 3229 0a0a 0a20 2020 2020 2020 2041 7267  2)...        Arg
+0000e1e0: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
+0000e1f0: 6574 7279 5f69 665f 6578 6365 7074 696f  etry_if_exceptio
+0000e200: 6e5f 7479 7065 3a20 4120 7475 706c 6520  n_type: A tuple 
+0000e210: 6f66 2065 7863 6570 7469 6f6e 2074 7970  of exception typ
+0000e220: 6573 2074 6f20 7265 7472 7920 6f6e 0a20  es to retry on. 
+0000e230: 2020 2020 2020 2020 2020 2077 6169 745f             wait_
+0000e240: 6578 706f 6e65 6e74 6961 6c5f 6a69 7474  exponential_jitt
+0000e250: 6572 3a20 5768 6574 6865 7220 746f 2061  er: Whether to a
+0000e260: 6464 206a 6974 7465 7220 746f 2074 6865  dd jitter to the
+0000e270: 2077 6169 7420 7469 6d65 0a20 2020 2020   wait time.     
+0000e280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e2a0: 6265 7477 6565 6e20 7265 7472 6965 730a  between retries.
+0000e2b0: 2020 2020 2020 2020 2020 2020 7374 6f70              stop
+0000e2c0: 5f61 6674 6572 5f61 7474 656d 7074 3a20  _after_attempt: 
+0000e2d0: 5468 6520 6d61 7869 6d75 6d20 6e75 6d62  The maximum numb
+0000e2e0: 6572 206f 6620 6174 7465 6d70 7473 2074  er of attempts t
+0000e2f0: 6f20 6d61 6b65 2062 6566 6f72 6520 6769  o make before gi
+0000e300: 7669 6e67 2075 700a 0a20 2020 2020 2020  ving up..       
+0000e310: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0000e320: 2020 2020 2020 4120 6e65 7720 5275 6e6e        A new Runn
+0000e330: 6162 6c65 2074 6861 7420 7265 7472 6965  able that retrie
+0000e340: 7320 7468 6520 6f72 6967 696e 616c 2072  s the original r
+0000e350: 756e 6e61 626c 6520 6f6e 2065 7863 6570  unnable on excep
+0000e360: 7469 6f6e 732e 0a20 2020 2020 2020 2022  tions..        "
+0000e370: 2222 0a20 2020 2020 2020 2066 726f 6d20  "".        from 
+0000e380: 6c61 6e67 6368 6169 6e5f 636f 7265 2e72  langchain_core.r
+0000e390: 756e 6e61 626c 6573 2e72 6574 7279 2069  unnables.retry i
+0000e3a0: 6d70 6f72 7420 5275 6e6e 6162 6c65 5265  mport RunnableRe
+0000e3b0: 7472 790a 0a20 2020 2020 2020 2072 6574  try..        ret
+0000e3c0: 7572 6e20 5275 6e6e 6162 6c65 5265 7472  urn RunnableRetr
+0000e3d0: 7928 0a20 2020 2020 2020 2020 2020 2062  y(.            b
+0000e3e0: 6f75 6e64 3d73 656c 662c 0a20 2020 2020  ound=self,.     
+0000e3f0: 2020 2020 2020 206b 7761 7267 733d 7b7d         kwargs={}
+0000e400: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
+0000e410: 6e66 6967 3d7b 7d2c 0a20 2020 2020 2020  nfig={},.       
+0000e420: 2020 2020 2072 6574 7279 5f65 7863 6570       retry_excep
+0000e430: 7469 6f6e 5f74 7970 6573 3d72 6574 7279  tion_types=retry
+0000e440: 5f69 665f 6578 6365 7074 696f 6e5f 7479  _if_exception_ty
+0000e450: 7065 2c0a 2020 2020 2020 2020 2020 2020  pe,.            
+0000e460: 7761 6974 5f65 7870 6f6e 656e 7469 616c  wait_exponential
+0000e470: 5f6a 6974 7465 723d 7761 6974 5f65 7870  _jitter=wait_exp
+0000e480: 6f6e 656e 7469 616c 5f6a 6974 7465 722c  onential_jitter,
+0000e490: 0a20 2020 2020 2020 2020 2020 206d 6178  .            max
+0000e4a0: 5f61 7474 656d 7074 5f6e 756d 6265 723d  _attempt_number=
+0000e4b0: 7374 6f70 5f61 6674 6572 5f61 7474 656d  stop_after_attem
+0000e4c0: 7074 2c0a 2020 2020 2020 2020 290a 0a20  pt,.        ).. 
+0000e4d0: 2020 2064 6566 206d 6170 2873 656c 6629     def map(self)
+0000e4e0: 202d 3e20 5275 6e6e 6162 6c65 5b4c 6973   -> Runnable[Lis
+0000e4f0: 745b 496e 7075 745d 2c20 4c69 7374 5b4f  t[Input], List[O
+0000e500: 7574 7075 745d 5d3a 0a20 2020 2020 2020  utput]]:.       
+0000e510: 2022 2222 0a20 2020 2020 2020 2052 6574   """.        Ret
+0000e520: 7572 6e20 6120 6e65 7720 5275 6e6e 6162  urn a new Runnab
+0000e530: 6c65 2074 6861 7420 6d61 7073 2061 206c  le that maps a l
+0000e540: 6973 7420 6f66 2069 6e70 7574 7320 746f  ist of inputs to
+0000e550: 2061 206c 6973 7420 6f66 206f 7574 7075   a list of outpu
+0000e560: 7473 2c0a 2020 2020 2020 2020 6279 2063  ts,.        by c
+0000e570: 616c 6c69 6e67 2069 6e76 6f6b 6528 2920  alling invoke() 
+0000e580: 7769 7468 2065 6163 6820 696e 7075 742e  with each input.
+0000e590: 0a0a 2020 2020 2020 2020 4578 616d 706c  ..        Exampl
+0000e5a0: 653a 0a0a 2020 2020 2020 2020 2020 2020  e:..            
+0000e5b0: 2e2e 2063 6f64 652d 626c 6f63 6b3a 3a20  .. code-block:: 
+0000e5c0: 7079 7468 6f6e 0a0a 2020 2020 2020 2020  python..        
+0000e5d0: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
+0000e5e0: 206c 616e 6763 6861 696e 5f63 6f72 652e   langchain_core.
+0000e5f0: 7275 6e6e 6162 6c65 7320 696d 706f 7274  runnables import
+0000e600: 2052 756e 6e61 626c 654c 616d 6264 610a   RunnableLambda.
+0000e610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e620: 2020 2020 2064 6566 205f 6c61 6d62 6461       def _lambda
+0000e630: 2878 3a20 696e 7429 202d 3e20 696e 743a  (x: int) -> int:
+0000e640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e650: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000e660: 7820 2b20 310a 0a20 2020 2020 2020 2020  x + 1..         
+0000e670: 2020 2020 2020 2020 2020 2072 756e 6e61             runna
+0000e680: 626c 6520 3d20 5275 6e6e 6162 6c65 4c61  ble = RunnableLa
+0000e690: 6d62 6461 285f 6c61 6d62 6461 290a 2020  mbda(_lambda).  
+0000e6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e6b0: 2020 7072 696e 7428 7275 6e6e 6162 6c65    print(runnable
+0000e6c0: 2e6d 6170 2829 2e69 6e76 6f6b 6528 5b31  .map().invoke([1
+0000e6d0: 2c20 322c 2033 5d29 2920 2320 5b32 2c20  , 2, 3])) # [2, 
+0000e6e0: 332c 2034 5d0a 2020 2020 2020 2020 2222  3, 4].        ""
+0000e6f0: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
+0000e700: 2052 756e 6e61 626c 6545 6163 6828 626f   RunnableEach(bo
+0000e710: 756e 643d 7365 6c66 290a 0a20 2020 2064  und=self)..    d
+0000e720: 6566 2077 6974 685f 6661 6c6c 6261 636b  ef with_fallback
+0000e730: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
+0000e740: 0a20 2020 2020 2020 2066 616c 6c62 6163  .        fallbac
+0000e750: 6b73 3a20 5365 7175 656e 6365 5b52 756e  ks: Sequence[Run
+0000e760: 6e61 626c 655b 496e 7075 742c 204f 7574  nable[Input, Out
+0000e770: 7075 745d 5d2c 0a20 2020 2020 2020 202a  put]],.        *
+0000e780: 2c0a 2020 2020 2020 2020 6578 6365 7074  ,.        except
+0000e790: 696f 6e73 5f74 6f5f 6861 6e64 6c65 3a20  ions_to_handle: 
+0000e7a0: 5475 706c 655b 5479 7065 5b42 6173 6545  Tuple[Type[BaseE
+0000e7b0: 7863 6570 7469 6f6e 5d2c 202e 2e2e 5d20  xception], ...] 
+0000e7c0: 3d20 2845 7863 6570 7469 6f6e 2c29 2c0a  = (Exception,),.
+0000e7d0: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
+0000e7e0: 6e5f 6b65 793a 204f 7074 696f 6e61 6c5b  n_key: Optional[
+0000e7f0: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
+0000e800: 2029 202d 3e20 5275 6e6e 6162 6c65 5769   ) -> RunnableWi
+0000e810: 7468 4661 6c6c 6261 636b 7354 5b49 6e70  thFallbacksT[Inp
+0000e820: 7574 2c20 4f75 7470 7574 5d3a 0a20 2020  ut, Output]:.   
+0000e830: 2020 2020 2022 2222 4164 6420 6661 6c6c       """Add fall
+0000e840: 6261 636b 7320 746f 2061 2072 756e 6e61  backs to a runna
+0000e850: 626c 652c 2072 6574 7572 6e69 6e67 2061  ble, returning a
+0000e860: 206e 6577 2052 756e 6e61 626c 652e 0a0a   new Runnable...
+0000e870: 2020 2020 2020 2020 4578 616d 706c 653a          Example:
+0000e880: 0a0a 2020 2020 2020 2020 2020 2020 2e2e  ..            ..
+0000e890: 2063 6f64 652d 626c 6f63 6b3a 3a20 7079   code-block:: py
+0000e8a0: 7468 6f6e 0a0a 2020 2020 2020 2020 2020  thon..          
+0000e8b0: 2020 2020 2020 6672 6f6d 2074 7970 696e        from typin
+0000e8c0: 6720 696d 706f 7274 2049 7465 7261 746f  g import Iterato
+0000e8d0: 720a 0a20 2020 2020 2020 2020 2020 2020  r..             
+0000e8e0: 2020 2066 726f 6d20 6c61 6e67 6368 6169     from langchai
+0000e8f0: 6e5f 636f 7265 2e72 756e 6e61 626c 6573  n_core.runnables
+0000e900: 2069 6d70 6f72 7420 5275 6e6e 6162 6c65   import Runnable
+0000e910: 4765 6e65 7261 746f 720a 0a0a 2020 2020  Generator...    
+0000e920: 2020 2020 2020 2020 2020 2020 6465 6620              def 
+0000e930: 5f67 656e 6572 6174 655f 696d 6d65 6469  _generate_immedi
+0000e940: 6174 655f 6572 726f 7228 696e 7075 743a  ate_error(input:
+0000e950: 2049 7465 7261 746f 7229 202d 3e20 4974   Iterator) -> It
+0000e960: 6572 6174 6f72 5b73 7472 5d3a 0a20 2020  erator[str]:.   
+0000e970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e980: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+0000e990: 7228 290a 2020 2020 2020 2020 2020 2020  r().            
+0000e9a0: 2020 2020 2020 2020 7969 656c 6420 2222          yield ""
+0000e9b0: 0a0a 0a20 2020 2020 2020 2020 2020 2020  ...             
+0000e9c0: 2020 2064 6566 205f 6765 6e65 7261 7465     def _generate
+0000e9d0: 2869 6e70 7574 3a20 4974 6572 6174 6f72  (input: Iterator
+0000e9e0: 2920 2d3e 2049 7465 7261 746f 725b 7374  ) -> Iterator[st
+0000e9f0: 725d 3a0a 2020 2020 2020 2020 2020 2020  r]:.            
+0000ea00: 2020 2020 2020 2020 7969 656c 6420 6672          yield fr
+0000ea10: 6f6d 2022 666f 6f20 6261 7222 0a0a 0a20  om "foo bar"... 
+0000ea20: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000ea30: 756e 6e61 626c 6520 3d20 5275 6e6e 6162  unnable = Runnab
+0000ea40: 6c65 4765 6e65 7261 746f 7228 5f67 656e  leGenerator(_gen
+0000ea50: 6572 6174 655f 696d 6d65 6469 6174 655f  erate_immediate_
+0000ea60: 6572 726f 7229 2e77 6974 685f 6661 6c6c  error).with_fall
+0000ea70: 6261 636b 7328 0a20 2020 2020 2020 2020  backs(.         
+0000ea80: 2020 2020 2020 2020 2020 205b 5275 6e6e             [Runn
+0000ea90: 6162 6c65 4765 6e65 7261 746f 7228 5f67  ableGenerator(_g
+0000eaa0: 656e 6572 6174 6529 5d0a 2020 2020 2020  enerate)].      
+0000eab0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0000eac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ead0: 7072 696e 7428 2727 2e6a 6f69 6e28 7275  print(''.join(ru
+0000eae0: 6e6e 6162 6c65 2e73 7472 6561 6d28 7b7d  nnable.stream({}
+0000eaf0: 2929 2920 2366 6f6f 2062 6172 0a0a 2020  ))) #foo bar..  
+0000eb00: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
+0000eb10: 2020 2020 2020 2020 6661 6c6c 6261 636b          fallback
+0000eb20: 733a 2041 2073 6571 7565 6e63 6520 6f66  s: A sequence of
+0000eb30: 2072 756e 6e61 626c 6573 2074 6f20 7472   runnables to tr
+0000eb40: 7920 6966 2074 6865 206f 7269 6769 6e61  y if the origina
+0000eb50: 6c20 7275 6e6e 6162 6c65 2066 6169 6c73  l runnable fails
+0000eb60: 2e0a 2020 2020 2020 2020 2020 2020 6578  ..            ex
+0000eb70: 6365 7074 696f 6e73 5f74 6f5f 6861 6e64  ceptions_to_hand
+0000eb80: 6c65 3a20 4120 7475 706c 6520 6f66 2065  le: A tuple of e
+0000eb90: 7863 6570 7469 6f6e 2074 7970 6573 2074  xception types t
+0000eba0: 6f20 6861 6e64 6c65 2e0a 2020 2020 2020  o handle..      
+0000ebb0: 2020 2020 2020 6578 6365 7074 696f 6e5f        exception_
+0000ebc0: 6b65 793a 2049 6620 7374 7269 6e67 2069  key: If string i
+0000ebd0: 7320 7370 6563 6966 6965 6420 7468 656e  s specified then
+0000ebe0: 2068 616e 646c 6564 2065 7863 6570 7469   handled excepti
+0000ebf0: 6f6e 7320 7769 6c6c 2062 6520 7061 7373  ons will be pass
+0000ec00: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
+0000ec10: 2020 2074 6f20 6661 6c6c 6261 636b 7320     to fallbacks 
+0000ec20: 6173 2070 6172 7420 6f66 2074 6865 2069  as part of the i
+0000ec30: 6e70 7574 2075 6e64 6572 2074 6865 2073  nput under the s
+0000ec40: 7065 6369 6669 6564 206b 6579 2e20 4966  pecified key. If
+0000ec50: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+0000ec60: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
+0000ec70: 7320 7769 6c6c 206e 6f74 2062 6520 7061  s will not be pa
+0000ec80: 7373 6564 2074 6f20 6661 6c6c 6261 636b  ssed to fallback
+0000ec90: 732e 2049 6620 7573 6564 2c20 7468 6520  s. If used, the 
+0000eca0: 6261 7365 2072 756e 6e61 626c 650a 2020  base runnable.  
+0000ecb0: 2020 2020 2020 2020 2020 2020 2020 616e                an
+0000ecc0: 6420 6974 7320 6661 6c6c 6261 636b 7320  d its fallbacks 
+0000ecd0: 6d75 7374 2061 6363 6570 7420 6120 6469  must accept a di
+0000ece0: 6374 696f 6e61 7279 2061 7320 696e 7075  ctionary as inpu
+0000ecf0: 742e 0a0a 2020 2020 2020 2020 5265 7475  t...        Retu
+0000ed00: 726e 733a 0a20 2020 2020 2020 2020 2020  rns:.           
+0000ed10: 2041 206e 6577 2052 756e 6e61 626c 6520   A new Runnable 
+0000ed20: 7468 6174 2077 696c 6c20 7472 7920 7468  that will try th
+0000ed30: 6520 6f72 6967 696e 616c 2072 756e 6e61  e original runna
+0000ed40: 626c 652c 2061 6e64 2074 6865 6e20 6561  ble, and then ea
+0000ed50: 6368 0a20 2020 2020 2020 2020 2020 2066  ch.            f
+0000ed60: 616c 6c62 6163 6b20 696e 206f 7264 6572  allback in order
+0000ed70: 2c20 7570 6f6e 2066 6169 6c75 7265 732e  , upon failures.
+0000ed80: 0a0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+0000ed90: 2020 2020 2020 6672 6f6d 206c 616e 6763        from langc
+0000eda0: 6861 696e 5f63 6f72 652e 7275 6e6e 6162  hain_core.runnab
+0000edb0: 6c65 732e 6661 6c6c 6261 636b 7320 696d  les.fallbacks im
+0000edc0: 706f 7274 2052 756e 6e61 626c 6557 6974  port RunnableWit
+0000edd0: 6846 616c 6c62 6163 6b73 0a0a 2020 2020  hFallbacks..    
+0000ede0: 2020 2020 7265 7475 726e 2052 756e 6e61      return Runna
+0000edf0: 626c 6557 6974 6846 616c 6c62 6163 6b73  bleWithFallbacks
+0000ee00: 280a 2020 2020 2020 2020 2020 2020 7275  (.            ru
+0000ee10: 6e6e 6162 6c65 3d73 656c 662c 0a20 2020  nnable=self,.   
+0000ee20: 2020 2020 2020 2020 2066 616c 6c62 6163           fallbac
+0000ee30: 6b73 3d66 616c 6c62 6163 6b73 2c0a 2020  ks=fallbacks,.  
+0000ee40: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0000ee50: 696f 6e73 5f74 6f5f 6861 6e64 6c65 3d65  ions_to_handle=e
+0000ee60: 7863 6570 7469 6f6e 735f 746f 5f68 616e  xceptions_to_han
+0000ee70: 646c 652c 0a20 2020 2020 2020 2020 2020  dle,.           
+0000ee80: 2065 7863 6570 7469 6f6e 5f6b 6579 3d65   exception_key=e
+0000ee90: 7863 6570 7469 6f6e 5f6b 6579 2c0a 2020  xception_key,.  
+0000eea0: 2020 2020 2020 290a 0a20 2020 2022 2222        )..    """
+0000eeb0: 202d 2d2d 2048 656c 7065 7220 6d65 7468   --- Helper meth
+0000eec0: 6f64 7320 666f 7220 5375 6263 6c61 7373  ods for Subclass
+0000eed0: 6573 202d 2d2d 2022 2222 0a0a 2020 2020  es --- """..    
+0000eee0: 6465 6620 5f63 616c 6c5f 7769 7468 5f63  def _call_with_c
+0000eef0: 6f6e 6669 6728 0a20 2020 2020 2020 2073  onfig(.        s
+0000ef00: 656c 662c 0a20 2020 2020 2020 2066 756e  elf,.        fun
+0000ef10: 633a 2055 6e69 6f6e 5b0a 2020 2020 2020  c: Union[.      
+0000ef20: 2020 2020 2020 4361 6c6c 6162 6c65 5b5b        Callable[[
+0000ef30: 496e 7075 745d 2c20 4f75 7470 7574 5d2c  Input], Output],
+0000ef40: 0a20 2020 2020 2020 2020 2020 2043 616c  .            Cal
+0000ef50: 6c61 626c 655b 5b49 6e70 7574 2c20 4361  lable[[Input, Ca
+0000ef60: 6c6c 6261 636b 4d61 6e61 6765 7246 6f72  llbackManagerFor
+0000ef70: 4368 6169 6e52 756e 5d2c 204f 7574 7075  ChainRun], Outpu
+0000ef80: 745d 2c0a 2020 2020 2020 2020 2020 2020  t],.            
+0000ef90: 4361 6c6c 6162 6c65 5b5b 496e 7075 742c  Callable[[Input,
+0000efa0: 2043 616c 6c62 6163 6b4d 616e 6167 6572   CallbackManager
+0000efb0: 466f 7243 6861 696e 5275 6e2c 2052 756e  ForChainRun, Run
+0000efc0: 6e61 626c 6543 6f6e 6669 675d 2c20 4f75  nableConfig], Ou
+0000efd0: 7470 7574 5d2c 0a20 2020 2020 2020 205d  tput],.        ]
+0000efe0: 2c0a 2020 2020 2020 2020 696e 7075 743a  ,.        input:
+0000eff0: 2049 6e70 7574 2c0a 2020 2020 2020 2020   Input,.        
+0000f000: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
+0000f010: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+0000f020: 2c0a 2020 2020 2020 2020 7275 6e5f 7479  ,.        run_ty
+0000f030: 7065 3a20 4f70 7469 6f6e 616c 5b73 7472  pe: Optional[str
+0000f040: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0000f050: 2020 2a2a 6b77 6172 6773 3a20 4f70 7469    **kwargs: Opti
+0000f060: 6f6e 616c 5b41 6e79 5d2c 0a20 2020 2029  onal[Any],.    )
+0000f070: 202d 3e20 4f75 7470 7574 3a0a 2020 2020   -> Output:.    
+0000f080: 2020 2020 2222 2248 656c 7065 7220 6d65      """Helper me
+0000f090: 7468 6f64 2074 6f20 7472 616e 7366 6f72  thod to transfor
+0000f0a0: 6d20 616e 2049 6e70 7574 2076 616c 7565  m an Input value
+0000f0b0: 2074 6f20 616e 204f 7574 7075 7420 7661   to an Output va
+0000f0c0: 6c75 652c 0a20 2020 2020 2020 2077 6974  lue,.        wit
+0000f0d0: 6820 6361 6c6c 6261 636b 732e 2055 7365  h callbacks. Use
+0000f0e0: 2074 6869 7320 6d65 7468 6f64 2074 6f20   this method to 
+0000f0f0: 696d 706c 656d 656e 7420 696e 766f 6b65  implement invoke
+0000f100: 2829 2069 6e20 7375 6263 6c61 7373 6573  () in subclasses
+0000f110: 2e22 2222 0a20 2020 2020 2020 2063 6f6e  .""".        con
+0000f120: 6669 6720 3d20 656e 7375 7265 5f63 6f6e  fig = ensure_con
+0000f130: 6669 6728 636f 6e66 6967 290a 2020 2020  fig(config).    
+0000f140: 2020 2020 6361 6c6c 6261 636b 5f6d 616e      callback_man
+0000f150: 6167 6572 203d 2067 6574 5f63 616c 6c62  ager = get_callb
+0000f160: 6163 6b5f 6d61 6e61 6765 725f 666f 725f  ack_manager_for_
+0000f170: 636f 6e66 6967 2863 6f6e 6669 6729 0a20  config(config). 
+0000f180: 2020 2020 2020 2072 756e 5f6d 616e 6167         run_manag
+0000f190: 6572 203d 2063 616c 6c62 6163 6b5f 6d61  er = callback_ma
+0000f1a0: 6e61 6765 722e 6f6e 5f63 6861 696e 5f73  nager.on_chain_s
+0000f1b0: 7461 7274 280a 2020 2020 2020 2020 2020  tart(.          
+0000f1c0: 2020 6475 6d70 6428 7365 6c66 292c 0a20    dumpd(self),. 
+0000f1d0: 2020 2020 2020 2020 2020 2069 6e70 7574             input
+0000f1e0: 2c0a 2020 2020 2020 2020 2020 2020 7275  ,.            ru
+0000f1f0: 6e5f 7479 7065 3d72 756e 5f74 7970 652c  n_type=run_type,
+0000f200: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+0000f210: 653d 636f 6e66 6967 2e67 6574 2822 7275  e=config.get("ru
+0000f220: 6e5f 6e61 6d65 2229 206f 7220 7365 6c66  n_name") or self
+0000f230: 2e67 6574 5f6e 616d 6528 292c 0a20 2020  .get_name(),.   
+0000f240: 2020 2020 2020 2020 2072 756e 5f69 643d           run_id=
+0000f250: 636f 6e66 6967 2e70 6f70 2822 7275 6e5f  config.pop("run_
+0000f260: 6964 222c 204e 6f6e 6529 2c0a 2020 2020  id", None),.    
+0000f270: 2020 2020 290a 2020 2020 2020 2020 7472      ).        tr
+0000f280: 793a 0a20 2020 2020 2020 2020 2020 2063  y:.            c
+0000f290: 6869 6c64 5f63 6f6e 6669 6720 3d20 7061  hild_config = pa
+0000f2a0: 7463 685f 636f 6e66 6967 2863 6f6e 6669  tch_config(confi
+0000f2b0: 672c 2063 616c 6c62 6163 6b73 3d72 756e  g, callbacks=run
+0000f2c0: 5f6d 616e 6167 6572 2e67 6574 5f63 6869  _manager.get_chi
+0000f2d0: 6c64 2829 290a 2020 2020 2020 2020 2020  ld()).          
+0000f2e0: 2020 636f 6e74 6578 7420 3d20 636f 7079    context = copy
+0000f2f0: 5f63 6f6e 7465 7874 2829 0a20 2020 2020  _context().     
+0000f300: 2020 2020 2020 2063 6f6e 7465 7874 2e72         context.r
+0000f310: 756e 2876 6172 5f63 6869 6c64 5f72 756e  un(var_child_run
+0000f320: 6e61 626c 655f 636f 6e66 6967 2e73 6574  nable_config.set
+0000f330: 2c20 6368 696c 645f 636f 6e66 6967 290a  , child_config).
+0000f340: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+0000f350: 7574 203d 2063 6173 7428 0a20 2020 2020  ut = cast(.     
+0000f360: 2020 2020 2020 2020 2020 204f 7574 7075             Outpu
+0000f370: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+0000f380: 2020 2063 6f6e 7465 7874 2e72 756e 280a     context.run(.
+0000f390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f3a0: 2020 2020 6361 6c6c 5f66 756e 635f 7769      call_func_wi
+0000f3b0: 7468 5f76 6172 6961 626c 655f 6172 6773  th_variable_args
+0000f3c0: 2c20 2023 2074 7970 653a 2069 676e 6f72  ,  # type: ignor
+0000f3d0: 655b 6172 672d 7479 7065 5d0a 2020 2020  e[arg-type].    
+0000f3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f3f0: 6675 6e63 2c20 2023 2074 7970 653a 2069  func,  # type: i
+0000f400: 676e 6f72 655b 6172 672d 7479 7065 5d0a  gnore[arg-type].
+0000f410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f420: 2020 2020 696e 7075 742c 2020 2320 7479      input,  # ty
+0000f430: 7065 3a20 6967 6e6f 7265 5b61 7267 2d74  pe: ignore[arg-t
+0000f440: 7970 655d 0a20 2020 2020 2020 2020 2020  ype].           
+0000f450: 2020 2020 2020 2020 2063 6f6e 6669 672c           config,
+0000f460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f470: 2020 2020 2072 756e 5f6d 616e 6167 6572       run_manager
+0000f480: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000f490: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
+0000f4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f4b0: 292c 0a20 2020 2020 2020 2020 2020 2029  ),.            )
+0000f4c0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0000f4d0: 4261 7365 4578 6365 7074 696f 6e20 6173  BaseException as
+0000f4e0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+0000f4f0: 7275 6e5f 6d61 6e61 6765 722e 6f6e 5f63  run_manager.on_c
+0000f500: 6861 696e 5f65 7272 6f72 2865 290a 2020  hain_error(e).  
+0000f510: 2020 2020 2020 2020 2020 7261 6973 650a            raise.
+0000f520: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000f530: 2020 2020 2020 2020 2020 7275 6e5f 6d61            run_ma
+0000f540: 6e61 6765 722e 6f6e 5f63 6861 696e 5f65  nager.on_chain_e
+0000f550: 6e64 286f 7574 7075 7429 0a20 2020 2020  nd(output).     
+0000f560: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
+0000f570: 7470 7574 0a0a 2020 2020 6173 796e 6320  tput..    async 
+0000f580: 6465 6620 5f61 6361 6c6c 5f77 6974 685f  def _acall_with_
+0000f590: 636f 6e66 6967 280a 2020 2020 2020 2020  config(.        
+0000f5a0: 7365 6c66 2c0a 2020 2020 2020 2020 6675  self,.        fu
+0000f5b0: 6e63 3a20 556e 696f 6e5b 0a20 2020 2020  nc: Union[.     
+0000f5c0: 2020 2020 2020 2043 616c 6c61 626c 655b         Callable[
+0000f5d0: 5b49 6e70 7574 5d2c 2041 7761 6974 6162  [Input], Awaitab
+0000f5e0: 6c65 5b4f 7574 7075 745d 5d2c 0a20 2020  le[Output]],.   
+0000f5f0: 2020 2020 2020 2020 2043 616c 6c61 626c           Callabl
+0000f600: 655b 5b49 6e70 7574 2c20 4173 796e 6343  e[[Input, AsyncC
+0000f610: 616c 6c62 6163 6b4d 616e 6167 6572 466f  allbackManagerFo
+0000f620: 7243 6861 696e 5275 6e5d 2c20 4177 6169  rChainRun], Awai
+0000f630: 7461 626c 655b 4f75 7470 7574 5d5d 2c0a  table[Output]],.
+0000f640: 2020 2020 2020 2020 2020 2020 4361 6c6c              Call
+0000f650: 6162 6c65 5b0a 2020 2020 2020 2020 2020  able[.          
+0000f660: 2020 2020 2020 5b49 6e70 7574 2c20 4173        [Input, As
+0000f670: 796e 6343 616c 6c62 6163 6b4d 616e 6167  yncCallbackManag
+0000f680: 6572 466f 7243 6861 696e 5275 6e2c 2052  erForChainRun, R
+0000f690: 756e 6e61 626c 6543 6f6e 6669 675d 2c0a  unnableConfig],.
+0000f6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f6b0: 4177 6169 7461 626c 655b 4f75 7470 7574  Awaitable[Output
+0000f6c0: 5d2c 0a20 2020 2020 2020 2020 2020 205d  ],.            ]
+0000f6d0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+0000f6e0: 2020 2020 2069 6e70 7574 3a20 496e 7075       input: Inpu
+0000f6f0: 742c 0a20 2020 2020 2020 2063 6f6e 6669  t,.        confi
+0000f700: 673a 204f 7074 696f 6e61 6c5b 5275 6e6e  g: Optional[Runn
+0000f710: 6162 6c65 436f 6e66 6967 5d2c 0a20 2020  ableConfig],.   
+0000f720: 2020 2020 2072 756e 5f74 7970 653a 204f       run_type: O
+0000f730: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
+0000f740: 6f6e 652c 0a20 2020 2020 2020 202a 2a6b  one,.        **k
+0000f750: 7761 7267 733a 204f 7074 696f 6e61 6c5b  wargs: Optional[
+0000f760: 416e 795d 2c0a 2020 2020 2920 2d3e 204f  Any],.    ) -> O
+0000f770: 7574 7075 743a 0a20 2020 2020 2020 2022  utput:.        "
+0000f780: 2222 4865 6c70 6572 206d 6574 686f 6420  ""Helper method 
+0000f790: 746f 2074 7261 6e73 666f 726d 2061 6e20  to transform an 
+0000f7a0: 496e 7075 7420 7661 6c75 6520 746f 2061  Input value to a
+0000f7b0: 6e20 4f75 7470 7574 2076 616c 7565 2c0a  n Output value,.
+0000f7c0: 2020 2020 2020 2020 7769 7468 2063 616c          with cal
+0000f7d0: 6c62 6163 6b73 2e20 5573 6520 7468 6973  lbacks. Use this
+0000f7e0: 206d 6574 686f 6420 746f 2069 6d70 6c65   method to imple
+0000f7f0: 6d65 6e74 2061 696e 766f 6b65 2829 2069  ment ainvoke() i
+0000f800: 6e20 7375 6263 6c61 7373 6573 2e22 2222  n subclasses."""
+0000f810: 0a20 2020 2020 2020 2063 6f6e 6669 6720  .        config 
+0000f820: 3d20 656e 7375 7265 5f63 6f6e 6669 6728  = ensure_config(
+0000f830: 636f 6e66 6967 290a 2020 2020 2020 2020  config).        
+0000f840: 6361 6c6c 6261 636b 5f6d 616e 6167 6572  callback_manager
+0000f850: 203d 2067 6574 5f61 7379 6e63 5f63 616c   = get_async_cal
+0000f860: 6c62 6163 6b5f 6d61 6e61 6765 725f 666f  lback_manager_fo
+0000f870: 725f 636f 6e66 6967 2863 6f6e 6669 6729  r_config(config)
+0000f880: 0a20 2020 2020 2020 2072 756e 5f6d 616e  .        run_man
+0000f890: 6167 6572 203d 2061 7761 6974 2063 616c  ager = await cal
+0000f8a0: 6c62 6163 6b5f 6d61 6e61 6765 722e 6f6e  lback_manager.on
+0000f8b0: 5f63 6861 696e 5f73 7461 7274 280a 2020  _chain_start(.  
+0000f8c0: 2020 2020 2020 2020 2020 6475 6d70 6428            dumpd(
+0000f8d0: 7365 6c66 292c 0a20 2020 2020 2020 2020  self),.         
+0000f8e0: 2020 2069 6e70 7574 2c0a 2020 2020 2020     input,.      
+0000f8f0: 2020 2020 2020 7275 6e5f 7479 7065 3d72        run_type=r
+0000f900: 756e 5f74 7970 652c 0a20 2020 2020 2020  un_type,.       
+0000f910: 2020 2020 206e 616d 653d 636f 6e66 6967       name=config
+0000f920: 2e67 6574 2822 7275 6e5f 6e61 6d65 2229  .get("run_name")
+0000f930: 206f 7220 7365 6c66 2e67 6574 5f6e 616d   or self.get_nam
+0000f940: 6528 292c 0a20 2020 2020 2020 2020 2020  e(),.           
+0000f950: 2072 756e 5f69 643d 636f 6e66 6967 2e70   run_id=config.p
+0000f960: 6f70 2822 7275 6e5f 6964 222c 204e 6f6e  op("run_id", Non
+0000f970: 6529 2c0a 2020 2020 2020 2020 290a 2020  e),.        ).  
+0000f980: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0000f990: 2020 2020 2020 2063 6869 6c64 5f63 6f6e         child_con
+0000f9a0: 6669 6720 3d20 7061 7463 685f 636f 6e66  fig = patch_conf
+0000f9b0: 6967 2863 6f6e 6669 672c 2063 616c 6c62  ig(config, callb
+0000f9c0: 6163 6b73 3d72 756e 5f6d 616e 6167 6572  acks=run_manager
+0000f9d0: 2e67 6574 5f63 6869 6c64 2829 290a 2020  .get_child()).  
+0000f9e0: 2020 2020 2020 2020 2020 636f 6e74 6578            contex
+0000f9f0: 7420 3d20 636f 7079 5f63 6f6e 7465 7874  t = copy_context
+0000fa00: 2829 0a20 2020 2020 2020 2020 2020 2063  ().            c
+0000fa10: 6f6e 7465 7874 2e72 756e 2876 6172 5f63  ontext.run(var_c
+0000fa20: 6869 6c64 5f72 756e 6e61 626c 655f 636f  hild_runnable_co
+0000fa30: 6e66 6967 2e73 6574 2c20 6368 696c 645f  nfig.set, child_
+0000fa40: 636f 6e66 6967 290a 2020 2020 2020 2020  config).        
+0000fa50: 2020 2020 636f 726f 203d 2061 6361 6c6c      coro = acall
+0000fa60: 5f66 756e 635f 7769 7468 5f76 6172 6961  _func_with_varia
+0000fa70: 626c 655f 6172 6773 280a 2020 2020 2020  ble_args(.      
+0000fa80: 2020 2020 2020 2020 2020 6675 6e63 2c20            func, 
+0000fa90: 696e 7075 742c 2063 6f6e 6669 672c 2072  input, config, r
+0000faa0: 756e 5f6d 616e 6167 6572 2c20 2a2a 6b77  un_manager, **kw
+0000fab0: 6172 6773 0a20 2020 2020 2020 2020 2020  args.           
+0000fac0: 2029 0a20 2020 2020 2020 2020 2020 2069   ).            i
+0000fad0: 6620 6163 6365 7074 735f 636f 6e74 6578  f accepts_contex
+0000fae0: 7428 6173 796e 6369 6f2e 6372 6561 7465  t(asyncio.create
+0000faf0: 5f74 6173 6b29 3a0a 2020 2020 2020 2020  _task):.        
+0000fb00: 2020 2020 2020 2020 6f75 7470 7574 3a20          output: 
+0000fb10: 4f75 7470 7574 203d 2061 7761 6974 2061  Output = await a
+0000fb20: 7379 6e63 696f 2e63 7265 6174 655f 7461  syncio.create_ta
+0000fb30: 736b 2863 6f72 6f2c 2063 6f6e 7465 7874  sk(coro, context
+0000fb40: 3d63 6f6e 7465 7874 2920 2023 2074 7970  =context)  # typ
+0000fb50: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
+0000fb60: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000fb70: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+0000fb80: 7574 203d 2061 7761 6974 2063 6f72 6f0a  ut = await coro.
+0000fb90: 2020 2020 2020 2020 6578 6365 7074 2042          except B
+0000fba0: 6173 6545 7863 6570 7469 6f6e 2061 7320  aseException as 
+0000fbb0: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+0000fbc0: 7761 6974 2072 756e 5f6d 616e 6167 6572  wait run_manager
+0000fbd0: 2e6f 6e5f 6368 6169 6e5f 6572 726f 7228  .on_chain_error(
+0000fbe0: 6529 0a20 2020 2020 2020 2020 2020 2072  e).            r
+0000fbf0: 6169 7365 0a20 2020 2020 2020 2065 6c73  aise.        els
+0000fc00: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+0000fc10: 7761 6974 2072 756e 5f6d 616e 6167 6572  wait run_manager
+0000fc20: 2e6f 6e5f 6368 6169 6e5f 656e 6428 6f75  .on_chain_end(ou
+0000fc30: 7470 7574 290a 2020 2020 2020 2020 2020  tput).          
+0000fc40: 2020 7265 7475 726e 206f 7574 7075 740a    return output.
+0000fc50: 0a20 2020 2064 6566 205f 6261 7463 685f  .    def _batch_
+0000fc60: 7769 7468 5f63 6f6e 6669 6728 0a20 2020  with_config(.   
+0000fc70: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0000fc80: 2020 2066 756e 633a 2055 6e69 6f6e 5b0a     func: Union[.
+0000fc90: 2020 2020 2020 2020 2020 2020 4361 6c6c              Call
+0000fca0: 6162 6c65 5b5b 4c69 7374 5b49 6e70 7574  able[[List[Input
+0000fcb0: 5d5d 2c20 4c69 7374 5b55 6e69 6f6e 5b45  ]], List[Union[E
+0000fcc0: 7863 6570 7469 6f6e 2c20 4f75 7470 7574  xception, Output
+0000fcd0: 5d5d 5d2c 0a20 2020 2020 2020 2020 2020  ]]],.           
+0000fce0: 2043 616c 6c61 626c 655b 0a20 2020 2020   Callable[.     
+0000fcf0: 2020 2020 2020 2020 2020 205b 4c69 7374             [List
+0000fd00: 5b49 6e70 7574 5d2c 204c 6973 745b 4361  [Input], List[Ca
+0000fd10: 6c6c 6261 636b 4d61 6e61 6765 7246 6f72  llbackManagerFor
+0000fd20: 4368 6169 6e52 756e 5d5d 2c0a 2020 2020  ChainRun]],.    
+0000fd30: 2020 2020 2020 2020 2020 2020 4c69 7374              List
+0000fd40: 5b55 6e69 6f6e 5b45 7863 6570 7469 6f6e  [Union[Exception
+0000fd50: 2c20 4f75 7470 7574 5d5d 2c0a 2020 2020  , Output]],.    
+0000fd60: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+0000fd70: 2020 2020 2020 2043 616c 6c61 626c 655b         Callable[
+0000fd80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fd90: 205b 4c69 7374 5b49 6e70 7574 5d2c 204c   [List[Input], L
+0000fda0: 6973 745b 4361 6c6c 6261 636b 4d61 6e61  ist[CallbackMana
+0000fdb0: 6765 7246 6f72 4368 6169 6e52 756e 5d2c  gerForChainRun],
+0000fdc0: 204c 6973 745b 5275 6e6e 6162 6c65 436f   List[RunnableCo
+0000fdd0: 6e66 6967 5d5d 2c0a 2020 2020 2020 2020  nfig]],.        
+0000fde0: 2020 2020 2020 2020 4c69 7374 5b55 6e69          List[Uni
+0000fdf0: 6f6e 5b45 7863 6570 7469 6f6e 2c20 4f75  on[Exception, Ou
+0000fe00: 7470 7574 5d5d 2c0a 2020 2020 2020 2020  tput]],.        
+0000fe10: 2020 2020 5d2c 0a20 2020 2020 2020 205d      ],.        ]
+0000fe20: 2c0a 2020 2020 2020 2020 696e 7075 743a  ,.        input:
+0000fe30: 204c 6973 745b 496e 7075 745d 2c0a 2020   List[Input],.  
+0000fe40: 2020 2020 2020 636f 6e66 6967 3a20 4f70        config: Op
+0000fe50: 7469 6f6e 616c 5b55 6e69 6f6e 5b52 756e  tional[Union[Run
+0000fe60: 6e61 626c 6543 6f6e 6669 672c 204c 6973  nableConfig, Lis
+0000fe70: 745b 5275 6e6e 6162 6c65 436f 6e66 6967  t[RunnableConfig
+0000fe80: 5d5d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ]]] = None,.    
+0000fe90: 2020 2020 2a2c 0a20 2020 2020 2020 2072      *,.        r
+0000fea0: 6574 7572 6e5f 6578 6365 7074 696f 6e73  eturn_exceptions
+0000feb0: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+0000fec0: 2020 2020 2020 2020 7275 6e5f 7479 7065          run_type
+0000fed0: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+0000fee0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0000fef0: 2a2a 6b77 6172 6773 3a20 4f70 7469 6f6e  **kwargs: Option
+0000ff00: 616c 5b41 6e79 5d2c 0a20 2020 2029 202d  al[Any],.    ) -
+0000ff10: 3e20 4c69 7374 5b4f 7574 7075 745d 3a0a  > List[Output]:.
+0000ff20: 2020 2020 2020 2020 2222 2248 656c 7065          """Helpe
+0000ff30: 7220 6d65 7468 6f64 2074 6f20 7472 616e  r method to tran
+0000ff40: 7366 6f72 6d20 616e 2049 6e70 7574 2076  sform an Input v
+0000ff50: 616c 7565 2074 6f20 616e 204f 7574 7075  alue to an Outpu
+0000ff60: 7420 7661 6c75 652c 0a20 2020 2020 2020  t value,.       
+0000ff70: 2077 6974 6820 6361 6c6c 6261 636b 732e   with callbacks.
+0000ff80: 2055 7365 2074 6869 7320 6d65 7468 6f64   Use this method
+0000ff90: 2074 6f20 696d 706c 656d 656e 7420 696e   to implement in
+0000ffa0: 766f 6b65 2829 2069 6e20 7375 6263 6c61  voke() in subcla
+0000ffb0: 7373 6573 2e22 2222 0a20 2020 2020 2020  sses.""".       
+0000ffc0: 2069 6620 6e6f 7420 696e 7075 743a 0a20   if not input:. 
+0000ffd0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000ffe0: 6e20 5b5d 0a0a 2020 2020 2020 2020 636f  n []..        co
+0000fff0: 6e66 6967 7320 3d20 6765 745f 636f 6e66  nfigs = get_conf
+00010000: 6967 5f6c 6973 7428 636f 6e66 6967 2c20  ig_list(config, 
+00010010: 6c65 6e28 696e 7075 7429 290a 2020 2020  len(input)).    
+00010020: 2020 2020 6361 6c6c 6261 636b 5f6d 616e      callback_man
+00010030: 6167 6572 7320 3d20 5b67 6574 5f63 616c  agers = [get_cal
+00010040: 6c62 6163 6b5f 6d61 6e61 6765 725f 666f  lback_manager_fo
+00010050: 725f 636f 6e66 6967 2863 2920 666f 7220  r_config(c) for 
+00010060: 6320 696e 2063 6f6e 6669 6773 5d0a 2020  c in configs].  
+00010070: 2020 2020 2020 7275 6e5f 6d61 6e61 6765        run_manage
+00010080: 7273 203d 205b 0a20 2020 2020 2020 2020  rs = [.         
+00010090: 2020 2063 616c 6c62 6163 6b5f 6d61 6e61     callback_mana
+000100a0: 6765 722e 6f6e 5f63 6861 696e 5f73 7461  ger.on_chain_sta
+000100b0: 7274 280a 2020 2020 2020 2020 2020 2020  rt(.            
+000100c0: 2020 2020 6475 6d70 6428 7365 6c66 292c      dumpd(self),
+000100d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000100e0: 2069 6e70 7574 2c0a 2020 2020 2020 2020   input,.        
+000100f0: 2020 2020 2020 2020 7275 6e5f 7479 7065          run_type
+00010100: 3d72 756e 5f74 7970 652c 0a20 2020 2020  =run_type,.     
+00010110: 2020 2020 2020 2020 2020 206e 616d 653d             name=
+00010120: 636f 6e66 6967 2e67 6574 2822 7275 6e5f  config.get("run_
+00010130: 6e61 6d65 2229 206f 7220 7365 6c66 2e67  name") or self.g
+00010140: 6574 5f6e 616d 6528 292c 0a20 2020 2020  et_name(),.     
+00010150: 2020 2020 2020 2020 2020 2072 756e 5f69             run_i
+00010160: 643d 636f 6e66 6967 2e70 6f70 2822 7275  d=config.pop("ru
+00010170: 6e5f 6964 222c 204e 6f6e 6529 2c0a 2020  n_id", None),.  
+00010180: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00010190: 2020 2020 2020 2020 666f 7220 6361 6c6c          for call
+000101a0: 6261 636b 5f6d 616e 6167 6572 2c20 696e  back_manager, in
+000101b0: 7075 742c 2063 6f6e 6669 6720 696e 207a  put, config in z
+000101c0: 6970 280a 2020 2020 2020 2020 2020 2020  ip(.            
+000101d0: 2020 2020 6361 6c6c 6261 636b 5f6d 616e      callback_man
+000101e0: 6167 6572 732c 2069 6e70 7574 2c20 636f  agers, input, co
+000101f0: 6e66 6967 730a 2020 2020 2020 2020 2020  nfigs.          
+00010200: 2020 290a 2020 2020 2020 2020 5d0a 2020    ).        ].  
+00010210: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00010220: 2020 2020 2020 2069 6620 6163 6365 7074         if accept
+00010230: 735f 636f 6e66 6967 2866 756e 6329 3a0a  s_config(func):.
+00010240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010250: 6b77 6172 6773 5b22 636f 6e66 6967 225d  kwargs["config"]
+00010260: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+00010270: 2020 2020 2020 2020 2070 6174 6368 5f63           patch_c
+00010280: 6f6e 6669 6728 632c 2063 616c 6c62 6163  onfig(c, callbac
+00010290: 6b73 3d72 6d2e 6765 745f 6368 696c 6428  ks=rm.get_child(
+000102a0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+000102b0: 2020 2020 2020 2066 6f72 2063 2c20 726d         for c, rm
+000102c0: 2069 6e20 7a69 7028 636f 6e66 6967 732c   in zip(configs,
+000102d0: 2072 756e 5f6d 616e 6167 6572 7329 0a20   run_managers). 
+000102e0: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
+000102f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00010300: 6163 6365 7074 735f 7275 6e5f 6d61 6e61  accepts_run_mana
+00010310: 6765 7228 6675 6e63 293a 0a20 2020 2020  ger(func):.     
+00010320: 2020 2020 2020 2020 2020 206b 7761 7267             kwarg
+00010330: 735b 2272 756e 5f6d 616e 6167 6572 225d  s["run_manager"]
+00010340: 203d 2072 756e 5f6d 616e 6167 6572 730a   = run_managers.
+00010350: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+00010360: 7574 203d 2066 756e 6328 696e 7075 742c  ut = func(input,
+00010370: 202a 2a6b 7761 7267 7329 2020 2320 7479   **kwargs)  # ty
+00010380: 7065 3a20 6967 6e6f 7265 5b63 616c 6c2d  pe: ignore[call-
+00010390: 6172 675d 0a20 2020 2020 2020 2065 7863  arg].        exc
+000103a0: 6570 7420 4261 7365 4578 6365 7074 696f  ept BaseExceptio
+000103b0: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
+000103c0: 2020 2020 666f 7220 7275 6e5f 6d61 6e61      for run_mana
+000103d0: 6765 7220 696e 2072 756e 5f6d 616e 6167  ger in run_manag
+000103e0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+000103f0: 2020 2020 2072 756e 5f6d 616e 6167 6572       run_manager
+00010400: 2e6f 6e5f 6368 6169 6e5f 6572 726f 7228  .on_chain_error(
+00010410: 6529 0a20 2020 2020 2020 2020 2020 2069  e).            i
+00010420: 6620 7265 7475 726e 5f65 7863 6570 7469  f return_excepti
+00010430: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+00010440: 2020 2020 2072 6574 7572 6e20 6361 7374       return cast
+00010450: 284c 6973 745b 4f75 7470 7574 5d2c 205b  (List[Output], [
+00010460: 6520 666f 7220 5f20 696e 2069 6e70 7574  e for _ in input
+00010470: 5d29 0a20 2020 2020 2020 2020 2020 2065  ]).            e
+00010480: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00010490: 2020 2020 2072 6169 7365 0a20 2020 2020       raise.     
+000104a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000104b0: 2020 2020 2066 6972 7374 5f65 7863 6570       first_excep
+000104c0: 7469 6f6e 3a20 4f70 7469 6f6e 616c 5b45  tion: Optional[E
+000104d0: 7863 6570 7469 6f6e 5d20 3d20 4e6f 6e65  xception] = None
+000104e0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000104f0: 2072 756e 5f6d 616e 6167 6572 2c20 6f75   run_manager, ou
+00010500: 7420 696e 207a 6970 2872 756e 5f6d 616e  t in zip(run_man
+00010510: 6167 6572 732c 206f 7574 7075 7429 3a0a  agers, output):.
+00010520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010530: 6966 2069 7369 6e73 7461 6e63 6528 6f75  if isinstance(ou
+00010540: 742c 2045 7863 6570 7469 6f6e 293a 0a20  t, Exception):. 
+00010550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010560: 2020 2066 6972 7374 5f65 7863 6570 7469     first_excepti
+00010570: 6f6e 203d 2066 6972 7374 5f65 7863 6570  on = first_excep
+00010580: 7469 6f6e 206f 7220 6f75 740a 2020 2020  tion or out.    
+00010590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000105a0: 7275 6e5f 6d61 6e61 6765 722e 6f6e 5f63  run_manager.on_c
+000105b0: 6861 696e 5f65 7272 6f72 286f 7574 290a  hain_error(out).
+000105c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000105d0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000105e0: 2020 2020 2020 2020 2020 7275 6e5f 6d61            run_ma
+000105f0: 6e61 6765 722e 6f6e 5f63 6861 696e 5f65  nager.on_chain_e
+00010600: 6e64 286f 7574 290a 2020 2020 2020 2020  nd(out).        
+00010610: 2020 2020 6966 2072 6574 7572 6e5f 6578      if return_ex
+00010620: 6365 7074 696f 6e73 206f 7220 6669 7273  ceptions or firs
+00010630: 745f 6578 6365 7074 696f 6e20 6973 204e  t_exception is N
+00010640: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00010650: 2020 2020 2072 6574 7572 6e20 6361 7374       return cast
+00010660: 284c 6973 745b 4f75 7470 7574 5d2c 206f  (List[Output], o
+00010670: 7574 7075 7429 0a20 2020 2020 2020 2020  utput).         
+00010680: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00010690: 2020 2020 2020 2020 2072 6169 7365 2066           raise f
+000106a0: 6972 7374 5f65 7863 6570 7469 6f6e 0a0a  irst_exception..
+000106b0: 2020 2020 6173 796e 6320 6465 6620 5f61      async def _a
+000106c0: 6261 7463 685f 7769 7468 5f63 6f6e 6669  batch_with_confi
+000106d0: 6728 0a20 2020 2020 2020 2073 656c 662c  g(.        self,
+000106e0: 0a20 2020 2020 2020 2066 756e 633a 2055  .        func: U
+000106f0: 6e69 6f6e 5b0a 2020 2020 2020 2020 2020  nion[.          
+00010700: 2020 4361 6c6c 6162 6c65 5b5b 4c69 7374    Callable[[List
+00010710: 5b49 6e70 7574 5d5d 2c20 4177 6169 7461  [Input]], Awaita
+00010720: 626c 655b 4c69 7374 5b55 6e69 6f6e 5b45  ble[List[Union[E
+00010730: 7863 6570 7469 6f6e 2c20 4f75 7470 7574  xception, Output
+00010740: 5d5d 5d5d 2c0a 2020 2020 2020 2020 2020  ]]]],.          
+00010750: 2020 4361 6c6c 6162 6c65 5b0a 2020 2020    Callable[.    
+00010760: 2020 2020 2020 2020 2020 2020 5b4c 6973              [Lis
+00010770: 745b 496e 7075 745d 2c20 4c69 7374 5b41  t[Input], List[A
+00010780: 7379 6e63 4361 6c6c 6261 636b 4d61 6e61  syncCallbackMana
+00010790: 6765 7246 6f72 4368 6169 6e52 756e 5d5d  gerForChainRun]]
+000107a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000107b0: 2020 4177 6169 7461 626c 655b 4c69 7374    Awaitable[List
+000107c0: 5b55 6e69 6f6e 5b45 7863 6570 7469 6f6e  [Union[Exception
+000107d0: 2c20 4f75 7470 7574 5d5d 5d2c 0a20 2020  , Output]]],.   
+000107e0: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
+000107f0: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
+00010800: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00010810: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00010820: 2020 2020 2020 2020 4c69 7374 5b49 6e70          List[Inp
+00010830: 7574 5d2c 0a20 2020 2020 2020 2020 2020  ut],.           
+00010840: 2020 2020 2020 2020 204c 6973 745b 4173           List[As
+00010850: 796e 6343 616c 6c62 6163 6b4d 616e 6167  yncCallbackManag
+00010860: 6572 466f 7243 6861 696e 5275 6e5d 2c0a  erForChainRun],.
+00010870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010880: 2020 2020 4c69 7374 5b52 756e 6e61 626c      List[Runnabl
+00010890: 6543 6f6e 6669 675d 2c0a 2020 2020 2020  eConfig],.      
+000108a0: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
+000108b0: 2020 2020 2020 2020 2020 2020 2041 7761               Awa
+000108c0: 6974 6162 6c65 5b4c 6973 745b 556e 696f  itable[List[Unio
+000108d0: 6e5b 4578 6365 7074 696f 6e2c 204f 7574  n[Exception, Out
+000108e0: 7075 745d 5d5d 2c0a 2020 2020 2020 2020  put]]],.        
+000108f0: 2020 2020 5d2c 0a20 2020 2020 2020 205d      ],.        ]
+00010900: 2c0a 2020 2020 2020 2020 696e 7075 743a  ,.        input:
+00010910: 204c 6973 745b 496e 7075 745d 2c0a 2020   List[Input],.  
+00010920: 2020 2020 2020 636f 6e66 6967 3a20 4f70        config: Op
+00010930: 7469 6f6e 616c 5b55 6e69 6f6e 5b52 756e  tional[Union[Run
+00010940: 6e61 626c 6543 6f6e 6669 672c 204c 6973  nableConfig, Lis
+00010950: 745b 5275 6e6e 6162 6c65 436f 6e66 6967  t[RunnableConfig
+00010960: 5d5d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ]]] = None,.    
+00010970: 2020 2020 2a2c 0a20 2020 2020 2020 2072      *,.        r
+00010980: 6574 7572 6e5f 6578 6365 7074 696f 6e73  eturn_exceptions
+00010990: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+000109a0: 2020 2020 2020 2020 7275 6e5f 7479 7065          run_type
+000109b0: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+000109c0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+000109d0: 2a2a 6b77 6172 6773 3a20 4f70 7469 6f6e  **kwargs: Option
+000109e0: 616c 5b41 6e79 5d2c 0a20 2020 2029 202d  al[Any],.    ) -
+000109f0: 3e20 4c69 7374 5b4f 7574 7075 745d 3a0a  > List[Output]:.
+00010a00: 2020 2020 2020 2020 2222 2248 656c 7065          """Helpe
+00010a10: 7220 6d65 7468 6f64 2074 6f20 7472 616e  r method to tran
+00010a20: 7366 6f72 6d20 616e 2049 6e70 7574 2076  sform an Input v
+00010a30: 616c 7565 2074 6f20 616e 204f 7574 7075  alue to an Outpu
+00010a40: 7420 7661 6c75 652c 0a20 2020 2020 2020  t value,.       
+00010a50: 2077 6974 6820 6361 6c6c 6261 636b 732e   with callbacks.
+00010a60: 2055 7365 2074 6869 7320 6d65 7468 6f64   Use this method
+00010a70: 2074 6f20 696d 706c 656d 656e 7420 696e   to implement in
+00010a80: 766f 6b65 2829 2069 6e20 7375 6263 6c61  voke() in subcla
+00010a90: 7373 6573 2e22 2222 0a20 2020 2020 2020  sses.""".       
+00010aa0: 2069 6620 6e6f 7420 696e 7075 743a 0a20   if not input:. 
+00010ab0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00010ac0: 6e20 5b5d 0a0a 2020 2020 2020 2020 636f  n []..        co
+00010ad0: 6e66 6967 7320 3d20 6765 745f 636f 6e66  nfigs = get_conf
+00010ae0: 6967 5f6c 6973 7428 636f 6e66 6967 2c20  ig_list(config, 
+00010af0: 6c65 6e28 696e 7075 7429 290a 2020 2020  len(input)).    
+00010b00: 2020 2020 6361 6c6c 6261 636b 5f6d 616e      callback_man
+00010b10: 6167 6572 7320 3d20 5b67 6574 5f61 7379  agers = [get_asy
+00010b20: 6e63 5f63 616c 6c62 6163 6b5f 6d61 6e61  nc_callback_mana
+00010b30: 6765 725f 666f 725f 636f 6e66 6967 2863  ger_for_config(c
+00010b40: 2920 666f 7220 6320 696e 2063 6f6e 6669  ) for c in confi
+00010b50: 6773 5d0a 2020 2020 2020 2020 7275 6e5f  gs].        run_
+00010b60: 6d61 6e61 6765 7273 3a20 4c69 7374 5b41  managers: List[A
+00010b70: 7379 6e63 4361 6c6c 6261 636b 4d61 6e61  syncCallbackMana
+00010b80: 6765 7246 6f72 4368 6169 6e52 756e 5d20  gerForChainRun] 
+00010b90: 3d20 6177 6169 7420 6173 796e 6369 6f2e  = await asyncio.
+00010ba0: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
+00010bb0: 2020 2020 2a28 0a20 2020 2020 2020 2020      *(.         
+00010bc0: 2020 2020 2020 2063 616c 6c62 6163 6b5f         callback_
+00010bd0: 6d61 6e61 6765 722e 6f6e 5f63 6861 696e  manager.on_chain
+00010be0: 5f73 7461 7274 280a 2020 2020 2020 2020  _start(.        
+00010bf0: 2020 2020 2020 2020 2020 2020 6475 6d70              dump
+00010c00: 6428 7365 6c66 292c 0a20 2020 2020 2020  d(self),.       
+00010c10: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
+00010c20: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
+00010c30: 2020 2020 2020 2020 7275 6e5f 7479 7065          run_type
+00010c40: 3d72 756e 5f74 7970 652c 0a20 2020 2020  =run_type,.     
+00010c50: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00010c60: 616d 653d 636f 6e66 6967 2e67 6574 2822  ame=config.get("
+00010c70: 7275 6e5f 6e61 6d65 2229 206f 7220 7365  run_name") or se
+00010c80: 6c66 2e67 6574 5f6e 616d 6528 292c 0a20  lf.get_name(),. 
+00010c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010ca0: 2020 2072 756e 5f69 643d 636f 6e66 6967     run_id=config
+00010cb0: 2e70 6f70 2822 7275 6e5f 6964 222c 204e  .pop("run_id", N
+00010cc0: 6f6e 6529 2c0a 2020 2020 2020 2020 2020  one),.          
+00010cd0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00010ce0: 2020 2020 2020 2020 666f 7220 6361 6c6c          for call
+00010cf0: 6261 636b 5f6d 616e 6167 6572 2c20 696e  back_manager, in
+00010d00: 7075 742c 2063 6f6e 6669 6720 696e 207a  put, config in z
+00010d10: 6970 280a 2020 2020 2020 2020 2020 2020  ip(.            
+00010d20: 2020 2020 2020 2020 6361 6c6c 6261 636b          callback
+00010d30: 5f6d 616e 6167 6572 732c 2069 6e70 7574  _managers, input
+00010d40: 2c20 636f 6e66 6967 730a 2020 2020 2020  , configs.      
+00010d50: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00010d60: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00010d70: 2020 290a 2020 2020 2020 2020 7472 793a    ).        try:
+00010d80: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00010d90: 6163 6365 7074 735f 636f 6e66 6967 2866  accepts_config(f
+00010da0: 756e 6329 3a0a 2020 2020 2020 2020 2020  unc):.          
+00010db0: 2020 2020 2020 6b77 6172 6773 5b22 636f        kwargs["co
+00010dc0: 6e66 6967 225d 203d 205b 0a20 2020 2020  nfig"] = [.     
+00010dd0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00010de0: 6174 6368 5f63 6f6e 6669 6728 632c 2063  atch_config(c, c
+00010df0: 616c 6c62 6163 6b73 3d72 6d2e 6765 745f  allbacks=rm.get_
+00010e00: 6368 696c 6428 2929 0a20 2020 2020 2020  child()).       
+00010e10: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00010e20: 2063 2c20 726d 2069 6e20 7a69 7028 636f   c, rm in zip(co
+00010e30: 6e66 6967 732c 2072 756e 5f6d 616e 6167  nfigs, run_manag
+00010e40: 6572 7329 0a20 2020 2020 2020 2020 2020  ers).           
+00010e50: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
+00010e60: 2020 2069 6620 6163 6365 7074 735f 7275     if accepts_ru
+00010e70: 6e5f 6d61 6e61 6765 7228 6675 6e63 293a  n_manager(func):
+00010e80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010e90: 206b 7761 7267 735b 2272 756e 5f6d 616e   kwargs["run_man
+00010ea0: 6167 6572 225d 203d 2072 756e 5f6d 616e  ager"] = run_man
+00010eb0: 6167 6572 730a 2020 2020 2020 2020 2020  agers.          
+00010ec0: 2020 6f75 7470 7574 203d 2061 7761 6974    output = await
+00010ed0: 2066 756e 6328 696e 7075 742c 202a 2a6b   func(input, **k
+00010ee0: 7761 7267 7329 2020 2320 7479 7065 3a20  wargs)  # type: 
+00010ef0: 6967 6e6f 7265 5b63 616c 6c2d 6172 675d  ignore[call-arg]
+00010f00: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+00010f10: 4261 7365 4578 6365 7074 696f 6e20 6173  BaseException as
+00010f20: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+00010f30: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
+00010f40: 7468 6572 280a 2020 2020 2020 2020 2020  ther(.          
+00010f50: 2020 2020 2020 2a28 7275 6e5f 6d61 6e61        *(run_mana
+00010f60: 6765 722e 6f6e 5f63 6861 696e 5f65 7272  ger.on_chain_err
+00010f70: 6f72 2865 2920 666f 7220 7275 6e5f 6d61  or(e) for run_ma
+00010f80: 6e61 6765 7220 696e 2072 756e 5f6d 616e  nager in run_man
+00010f90: 6167 6572 7329 0a20 2020 2020 2020 2020  agers).         
+00010fa0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00010fb0: 2069 6620 7265 7475 726e 5f65 7863 6570   if return_excep
+00010fc0: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
+00010fd0: 2020 2020 2020 2072 6574 7572 6e20 6361         return ca
+00010fe0: 7374 284c 6973 745b 4f75 7470 7574 5d2c  st(List[Output],
+00010ff0: 205b 6520 666f 7220 5f20 696e 2069 6e70   [e for _ in inp
+00011000: 7574 5d29 0a20 2020 2020 2020 2020 2020  ut]).           
+00011010: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00011020: 2020 2020 2020 2072 6169 7365 0a20 2020         raise.   
+00011030: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00011040: 2020 2020 2020 2066 6972 7374 5f65 7863         first_exc
+00011050: 6570 7469 6f6e 3a20 4f70 7469 6f6e 616c  eption: Optional
+00011060: 5b45 7863 6570 7469 6f6e 5d20 3d20 4e6f  [Exception] = No
+00011070: 6e65 0a20 2020 2020 2020 2020 2020 2063  ne.            c
+00011080: 6f72 6f73 3a20 4c69 7374 5b41 7761 6974  oros: List[Await
+00011090: 6162 6c65 5b4e 6f6e 655d 5d20 3d20 5b5d  able[None]] = []
+000110a0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000110b0: 2072 756e 5f6d 616e 6167 6572 2c20 6f75   run_manager, ou
+000110c0: 7420 696e 207a 6970 2872 756e 5f6d 616e  t in zip(run_man
+000110d0: 6167 6572 732c 206f 7574 7075 7429 3a0a  agers, output):.
 000110e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110f0: 2020 2020 2020 2020 2020 2070 6174 6368             patch
-00011100: 5f63 6f6e 6669 6728 0a20 2020 2020 2020  _config(.       
+000110f0: 6966 2069 7369 6e73 7461 6e63 6528 6f75  if isinstance(ou
+00011100: 742c 2045 7863 6570 7469 6f6e 293a 0a20  t, Exception):. 
 00011110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011120: 2020 2020 2020 2020 2063 6f6e 6669 672c           config,
-00011130: 2063 616c 6c62 6163 6b73 3d72 6d2e 6765   callbacks=rm.ge
-00011140: 745f 6368 696c 6428 6622 7365 713a 7374  t_child(f"seq:st
-00011150: 6570 3a7b 7374 6570 6964 782b 317d 2229  ep:{stepidx+1}")
-00011160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011170: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00011180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011190: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-000111a0: 2c20 2872 6d2c 2063 6f6e 6669 6729 2069  , (rm, config) i
-000111b0: 6e20 656e 756d 6572 6174 6528 7a69 7028  n enumerate(zip(
-000111c0: 7275 6e5f 6d61 6e61 6765 7273 2c20 636f  run_managers, co
-000111d0: 6e66 6967 7329 290a 2020 2020 2020 2020  nfigs)).        
-000111e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000111f0: 2020 2020 6966 2069 206e 6f74 2069 6e20      if i not in 
-00011200: 6661 696c 6564 5f69 6e70 7574 735f 6d61  failed_inputs_ma
-00011210: 700a 2020 2020 2020 2020 2020 2020 2020  p.              
-00011220: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
-00011230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011240: 2020 2020 2072 6574 7572 6e5f 6578 6365       return_exce
-00011250: 7074 696f 6e73 3d72 6574 7572 6e5f 6578  ptions=return_ex
-00011260: 6365 7074 696f 6e73 2c0a 2020 2020 2020  ceptions,.      
-00011270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011280: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
-00011290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000112a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000112b0: 2020 2020 2020 2320 4966 2061 6e20 696e        # If an in
-000112c0: 7075 7420 6661 696c 6564 2c20 6164 6420  put failed, add 
-000112d0: 6974 2074 6f20 7468 6520 6d61 700a 2020  it to the map.  
-000112e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000112f0: 2020 666f 7220 692c 2069 6e70 2069 6e20    for i, inp in 
-00011300: 7a69 7028 7265 6d61 696e 696e 675f 6964  zip(remaining_id
-00011310: 7873 2c20 696e 7075 7473 293a 0a20 2020  xs, inputs):.   
-00011320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011330: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-00011340: 6365 2869 6e70 2c20 4578 6365 7074 696f  ce(inp, Exceptio
-00011350: 6e29 3a0a 2020 2020 2020 2020 2020 2020  n):.            
-00011360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011370: 6661 696c 6564 5f69 6e70 7574 735f 6d61  failed_inputs_ma
-00011380: 705b 695d 203d 2069 6e70 0a20 2020 2020  p[i] = inp.     
-00011390: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000113a0: 6e70 7574 7320 3d20 5b69 6e70 2066 6f72  nputs = [inp for
-000113b0: 2069 6e70 2069 6e20 696e 7075 7473 2069   inp in inputs i
-000113c0: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
-000113d0: 2869 6e70 2c20 4578 6365 7074 696f 6e29  (inp, Exception)
-000113e0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000113f0: 2020 2020 2020 2320 4966 2061 6c6c 2069        # If all i
-00011400: 6e70 7574 7320 6861 7665 2066 6169 6c65  nputs have faile
-00011410: 642c 2073 746f 7020 7072 6f63 6573 7369  d, stop processi
-00011420: 6e67 0a20 2020 2020 2020 2020 2020 2020  ng.             
-00011430: 2020 2020 2020 2069 6620 6c65 6e28 6661         if len(fa
-00011440: 696c 6564 5f69 6e70 7574 735f 6d61 7029  iled_inputs_map)
-00011450: 203d 3d20 6c65 6e28 636f 6e66 6967 7329   == len(configs)
-00011460: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00011470: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-00011480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011490: 2023 2052 6561 7373 656d 626c 6520 7468   # Reassemble th
-000114a0: 6520 6f75 7470 7574 732c 2069 6e73 6572  e outputs, inser
-000114b0: 7469 6e67 2045 7863 6570 7469 6f6e 7320  ting Exceptions 
-000114c0: 666f 7220 6661 696c 6564 2069 6e70 7574  for failed input
-000114d0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-000114e0: 2020 696e 7075 7473 5f63 6f70 7920 3d20    inputs_copy = 
-000114f0: 696e 7075 7473 2e63 6f70 7928 290a 2020  inputs.copy().  
-00011500: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00011510: 7075 7473 203d 205b 5d0a 2020 2020 2020  puts = [].      
-00011520: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
-00011530: 696e 2072 616e 6765 286c 656e 2863 6f6e  in range(len(con
-00011540: 6669 6773 2929 3a0a 2020 2020 2020 2020  figs)):.        
-00011550: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00011560: 2069 6e20 6661 696c 6564 5f69 6e70 7574   in failed_input
-00011570: 735f 6d61 703a 0a20 2020 2020 2020 2020  s_map:.         
-00011580: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00011590: 6e70 7574 732e 6170 7065 6e64 2863 6173  nputs.append(cas
-000115a0: 7428 496e 7075 742c 2066 6169 6c65 645f  t(Input, failed_
-000115b0: 696e 7075 7473 5f6d 6170 5b69 5d29 290a  inputs_map[i])).
-000115c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000115d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000115e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000115f0: 2020 696e 7075 7473 2e61 7070 656e 6428    inputs.append(
-00011600: 696e 7075 7473 5f63 6f70 792e 706f 7028  inputs_copy.pop(
-00011610: 3029 290a 2020 2020 2020 2020 2020 2020  0)).            
-00011620: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00011630: 2020 2020 2020 666f 7220 692c 2073 7465        for i, ste
-00011640: 7020 696e 2065 6e75 6d65 7261 7465 2873  p in enumerate(s
-00011650: 656c 662e 7374 6570 7329 3a0a 2020 2020  elf.steps):.    
-00011660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011670: 696e 7075 7473 203d 2073 7465 702e 6261  inputs = step.ba
-00011680: 7463 6828 0a20 2020 2020 2020 2020 2020  tch(.           
-00011690: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-000116a0: 7574 732c 0a20 2020 2020 2020 2020 2020  uts,.           
-000116b0: 2020 2020 2020 2020 2020 2020 205b 0a20               [. 
-000116c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000116d0: 2020 2020 2020 2020 2020 2023 2065 6163             # eac
-000116e0: 6820 7374 6570 2061 2063 6869 6c64 2072  h step a child r
-000116f0: 756e 206f 6620 7468 6520 636f 7272 6573  un of the corres
-00011700: 706f 6e64 696e 6720 726f 6f74 2072 756e  ponding root run
-00011710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011720: 2020 2020 2020 2020 2020 2020 2070 6174               pat
-00011730: 6368 5f63 6f6e 6669 6728 0a20 2020 2020  ch_config(.     
-00011740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011750: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
-00011760: 672c 2063 616c 6c62 6163 6b73 3d72 6d2e  g, callbacks=rm.
-00011770: 6765 745f 6368 696c 6428 6622 7365 713a  get_child(f"seq:
-00011780: 7374 6570 3a7b 692b 317d 2229 0a20 2020  step:{i+1}").   
-00011790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000117a0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000117b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000117c0: 2020 2020 2020 2066 6f72 2072 6d2c 2063         for rm, c
-000117d0: 6f6e 6669 6720 696e 207a 6970 2872 756e  onfig in zip(run
-000117e0: 5f6d 616e 6167 6572 732c 2063 6f6e 6669  _managers, confi
-000117f0: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-00011800: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
-00011810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011820: 2020 2029 0a0a 2020 2020 2020 2020 2320     )..        # 
-00011830: 6669 6e69 7368 2074 6865 2072 6f6f 7420  finish the root 
-00011840: 7275 6e73 0a20 2020 2020 2020 2065 7863  runs.        exc
-00011850: 6570 7420 4261 7365 4578 6365 7074 696f  ept BaseExceptio
-00011860: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
-00011870: 2020 2020 666f 7220 726d 2069 6e20 7275      for rm in ru
-00011880: 6e5f 6d61 6e61 6765 7273 3a0a 2020 2020  n_managers:.    
-00011890: 2020 2020 2020 2020 2020 2020 726d 2e6f              rm.o
-000118a0: 6e5f 6368 6169 6e5f 6572 726f 7228 6529  n_chain_error(e)
-000118b0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000118c0: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
-000118d0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-000118e0: 2020 2072 6574 7572 6e20 6361 7374 284c     return cast(L
-000118f0: 6973 745b 4f75 7470 7574 5d2c 205b 6520  ist[Output], [e 
-00011900: 666f 7220 5f20 696e 2069 6e70 7574 735d  for _ in inputs]
-00011910: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00011920: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00011930: 2020 2020 7261 6973 650a 2020 2020 2020      raise.      
-00011940: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00011950: 2020 2020 6669 7273 745f 6578 6365 7074      first_except
-00011960: 696f 6e3a 204f 7074 696f 6e61 6c5b 4578  ion: Optional[Ex
-00011970: 6365 7074 696f 6e5d 203d 204e 6f6e 650a  ception] = None.
-00011980: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00011990: 7275 6e5f 6d61 6e61 6765 722c 206f 7574  run_manager, out
-000119a0: 2069 6e20 7a69 7028 7275 6e5f 6d61 6e61   in zip(run_mana
-000119b0: 6765 7273 2c20 696e 7075 7473 293a 0a20  gers, inputs):. 
-000119c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000119d0: 6620 6973 696e 7374 616e 6365 286f 7574  f isinstance(out
-000119e0: 2c20 4578 6365 7074 696f 6e29 3a0a 2020  , Exception):.  
-000119f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011a00: 2020 6669 7273 745f 6578 6365 7074 696f    first_exceptio
-00011a10: 6e20 3d20 6669 7273 745f 6578 6365 7074  n = first_except
-00011a20: 696f 6e20 6f72 206f 7574 0a20 2020 2020  ion or out.     
-00011a30: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00011a40: 756e 5f6d 616e 6167 6572 2e6f 6e5f 6368  un_manager.on_ch
-00011a50: 6169 6e5f 6572 726f 7228 6f75 7429 0a20  ain_error(out). 
-00011a60: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00011a70: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00011a80: 2020 2020 2020 2020 2072 756e 5f6d 616e           run_man
-00011a90: 6167 6572 2e6f 6e5f 6368 6169 6e5f 656e  ager.on_chain_en
-00011aa0: 6428 6475 6d70 6428 6f75 7429 290a 2020  d(dumpd(out)).  
-00011ab0: 2020 2020 2020 2020 2020 6966 2072 6574            if ret
-00011ac0: 7572 6e5f 6578 6365 7074 696f 6e73 206f  urn_exceptions o
-00011ad0: 7220 6669 7273 745f 6578 6365 7074 696f  r first_exceptio
-00011ae0: 6e20 6973 204e 6f6e 653a 0a20 2020 2020  n is None:.     
-00011af0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00011b00: 6e20 6361 7374 284c 6973 745b 4f75 7470  n cast(List[Outp
-00011b10: 7574 5d2c 2069 6e70 7574 7329 0a20 2020  ut], inputs).   
-00011b20: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00011b30: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00011b40: 6169 7365 2066 6972 7374 5f65 7863 6570  aise first_excep
-00011b50: 7469 6f6e 0a0a 2020 2020 6173 796e 6320  tion..    async 
-00011b60: 6465 6620 6162 6174 6368 280a 2020 2020  def abatch(.    
-00011b70: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00011b80: 2020 696e 7075 7473 3a20 4c69 7374 5b49    inputs: List[I
-00011b90: 6e70 7574 5d2c 0a20 2020 2020 2020 2063  nput],.        c
-00011ba0: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
-00011bb0: 556e 696f 6e5b 5275 6e6e 6162 6c65 436f  Union[RunnableCo
-00011bc0: 6e66 6967 2c20 4c69 7374 5b52 756e 6e61  nfig, List[Runna
-00011bd0: 626c 6543 6f6e 6669 675d 5d5d 203d 204e  bleConfig]]] = N
-00011be0: 6f6e 652c 0a20 2020 2020 2020 202a 2c0a  one,.        *,.
-00011bf0: 2020 2020 2020 2020 7265 7475 726e 5f65          return_e
-00011c00: 7863 6570 7469 6f6e 733a 2062 6f6f 6c20  xceptions: bool 
-00011c10: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
-00011c20: 202a 2a6b 7761 7267 733a 204f 7074 696f   **kwargs: Optio
-00011c30: 6e61 6c5b 416e 795d 2c0a 2020 2020 2920  nal[Any],.    ) 
-00011c40: 2d3e 204c 6973 745b 4f75 7470 7574 5d3a  -> List[Output]:
-00011c50: 0a20 2020 2020 2020 2066 726f 6d20 6c61  .        from la
-00011c60: 6e67 6368 6169 6e5f 636f 7265 2e62 6574  ngchain_core.bet
-00011c70: 612e 7275 6e6e 6162 6c65 732e 636f 6e74  a.runnables.cont
-00011c80: 6578 7420 696d 706f 7274 2061 636f 6e66  ext import aconf
-00011c90: 6967 5f77 6974 685f 636f 6e74 6578 740a  ig_with_context.
-00011ca0: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
-00011cb0: 6763 6861 696e 5f63 6f72 652e 6361 6c6c  gchain_core.call
-00011cc0: 6261 636b 732e 6d61 6e61 6765 7220 696d  backs.manager im
-00011cd0: 706f 7274 2041 7379 6e63 4361 6c6c 6261  port AsyncCallba
-00011ce0: 636b 4d61 6e61 6765 720a 0a20 2020 2020  ckManager..     
-00011cf0: 2020 2069 6620 6e6f 7420 696e 7075 7473     if not inputs
-00011d00: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00011d10: 7475 726e 205b 5d0a 0a20 2020 2020 2020  turn []..       
-00011d20: 2023 2073 6574 7570 2063 616c 6c62 6163   # setup callbac
-00011d30: 6b73 2061 6e64 2063 6f6e 7465 7874 0a20  ks and context. 
-00011d40: 2020 2020 2020 2063 6f6e 6669 6773 203d         configs =
-00011d50: 205b 0a20 2020 2020 2020 2020 2020 2061   [.            a
-00011d60: 636f 6e66 6967 5f77 6974 685f 636f 6e74  config_with_cont
-00011d70: 6578 7428 632c 2073 656c 662e 7374 6570  ext(c, self.step
-00011d80: 7329 0a20 2020 2020 2020 2020 2020 2066  s).            f
-00011d90: 6f72 2063 2069 6e20 6765 745f 636f 6e66  or c in get_conf
-00011da0: 6967 5f6c 6973 7428 636f 6e66 6967 2c20  ig_list(config, 
-00011db0: 6c65 6e28 696e 7075 7473 2929 0a20 2020  len(inputs)).   
-00011dc0: 2020 2020 205d 0a20 2020 2020 2020 2063       ].        c
-00011dd0: 616c 6c62 6163 6b5f 6d61 6e61 6765 7273  allback_managers
-00011de0: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-00011df0: 2041 7379 6e63 4361 6c6c 6261 636b 4d61   AsyncCallbackMa
-00011e00: 6e61 6765 722e 636f 6e66 6967 7572 6528  nager.configure(
-00011e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011e20: 2069 6e68 6572 6974 6162 6c65 5f63 616c   inheritable_cal
-00011e30: 6c62 6163 6b73 3d63 6f6e 6669 672e 6765  lbacks=config.ge
-00011e40: 7428 2263 616c 6c62 6163 6b73 2229 2c0a  t("callbacks"),.
-00011e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011e60: 6c6f 6361 6c5f 6361 6c6c 6261 636b 733d  local_callbacks=
-00011e70: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00011e80: 2020 2020 2020 7665 7262 6f73 653d 4661        verbose=Fa
-00011e90: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
-00011ea0: 2020 2020 2069 6e68 6572 6974 6162 6c65       inheritable
-00011eb0: 5f74 6167 733d 636f 6e66 6967 2e67 6574  _tags=config.get
-00011ec0: 2822 7461 6773 2229 2c0a 2020 2020 2020  ("tags"),.      
-00011ed0: 2020 2020 2020 2020 2020 6c6f 6361 6c5f            local_
-00011ee0: 7461 6773 3d4e 6f6e 652c 0a20 2020 2020  tags=None,.     
-00011ef0: 2020 2020 2020 2020 2020 2069 6e68 6572             inher
-00011f00: 6974 6162 6c65 5f6d 6574 6164 6174 613d  itable_metadata=
-00011f10: 636f 6e66 6967 2e67 6574 2822 6d65 7461  config.get("meta
-00011f20: 6461 7461 2229 2c0a 2020 2020 2020 2020  data"),.        
-00011f30: 2020 2020 2020 2020 6c6f 6361 6c5f 6d65          local_me
-00011f40: 7461 6461 7461 3d4e 6f6e 652c 0a20 2020  tadata=None,.   
-00011f50: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00011f60: 2020 2020 2020 2066 6f72 2063 6f6e 6669         for confi
-00011f70: 6720 696e 2063 6f6e 6669 6773 0a20 2020  g in configs.   
-00011f80: 2020 2020 205d 0a20 2020 2020 2020 2023       ].        #
-00011f90: 2073 7461 7274 2074 6865 2072 6f6f 7420   start the root 
-00011fa0: 7275 6e73 2c20 6f6e 6520 7065 7220 696e  runs, one per in
-00011fb0: 7075 740a 2020 2020 2020 2020 7275 6e5f  put.        run_
-00011fc0: 6d61 6e61 6765 7273 3a20 4c69 7374 5b41  managers: List[A
-00011fd0: 7379 6e63 4361 6c6c 6261 636b 4d61 6e61  syncCallbackMana
-00011fe0: 6765 7246 6f72 4368 6169 6e52 756e 5d20  gerForChainRun] 
-00011ff0: 3d20 6177 6169 7420 6173 796e 6369 6f2e  = await asyncio.
-00012000: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
-00012010: 2020 2020 2a28 0a20 2020 2020 2020 2020      *(.         
-00012020: 2020 2020 2020 2063 6d2e 6f6e 5f63 6861         cm.on_cha
-00012030: 696e 5f73 7461 7274 280a 2020 2020 2020  in_start(.      
-00012040: 2020 2020 2020 2020 2020 2020 2020 6475                du
-00012050: 6d70 6428 7365 6c66 292c 0a20 2020 2020  mpd(self),.     
-00012060: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00012070: 6e70 7574 2c0a 2020 2020 2020 2020 2020  nput,.          
-00012080: 2020 2020 2020 2020 2020 6e61 6d65 3d63            name=c
-00012090: 6f6e 6669 672e 6765 7428 2272 756e 5f6e  onfig.get("run_n
-000120a0: 616d 6522 2920 6f72 2073 656c 662e 6765  ame") or self.ge
-000120b0: 745f 6e61 6d65 2829 2c0a 2020 2020 2020  t_name(),.      
-000120c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000120d0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000120e0: 636d 2c20 696e 7075 742c 2063 6f6e 6669  cm, input, confi
-000120f0: 6720 696e 207a 6970 2863 616c 6c62 6163  g in zip(callbac
-00012100: 6b5f 6d61 6e61 6765 7273 2c20 696e 7075  k_managers, inpu
-00012110: 7473 2c20 636f 6e66 6967 7329 0a20 2020  ts, configs).   
-00012120: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00012130: 2020 2029 0a0a 2020 2020 2020 2020 2320     )..        # 
-00012140: 696e 766f 6b65 202e 6261 7463 6828 2920  invoke .batch() 
-00012150: 6f6e 2065 6163 6820 7374 6570 0a20 2020  on each step.   
-00012160: 2020 2020 2023 2074 6869 7320 7573 6573       # this uses
-00012170: 2062 6174 6368 696e 6720 6f70 7469 6d69   batching optimi
-00012180: 7a61 7469 6f6e 7320 696e 2052 756e 6e61  zations in Runna
-00012190: 626c 6520 7375 6263 6c61 7373 6573 2c20  ble subclasses, 
-000121a0: 6c69 6b65 204c 4c4d 0a20 2020 2020 2020  like LLM.       
-000121b0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-000121c0: 2020 6966 2072 6574 7572 6e5f 6578 6365    if return_exce
-000121d0: 7074 696f 6e73 3a0a 2020 2020 2020 2020  ptions:.        
-000121e0: 2020 2020 2020 2020 2320 5472 6163 6b20          # Track 
-000121f0: 7768 6963 6820 696e 7075 7473 2028 6279  which inputs (by
-00012200: 2069 6e64 6578 2920 6661 696c 6564 2073   index) failed s
-00012210: 6f20 6661 720a 2020 2020 2020 2020 2020  o far.          
-00012220: 2020 2020 2020 2320 4966 2061 6e20 696e        # If an in
-00012230: 7075 7420 6861 7320 6661 696c 6564 2069  put has failed i
-00012240: 7420 7769 6c6c 2062 6520 7072 6573 656e  t will be presen
-00012250: 7420 696e 2074 6869 7320 6d61 702c 0a20  t in this map,. 
-00012260: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00012270: 2061 6e64 2074 6865 2076 616c 7565 2077   and the value w
-00012280: 696c 6c20 6265 2074 6865 2065 7863 6570  ill be the excep
-00012290: 7469 6f6e 2074 6861 7420 7761 7320 7261  tion that was ra
-000122a0: 6973 6564 2e0a 2020 2020 2020 2020 2020  ised..          
-000122b0: 2020 2020 2020 6661 696c 6564 5f69 6e70        failed_inp
-000122c0: 7574 735f 6d61 703a 2044 6963 745b 696e  uts_map: Dict[in
-000122d0: 742c 2045 7863 6570 7469 6f6e 5d20 3d20  t, Exception] = 
-000122e0: 7b7d 0a20 2020 2020 2020 2020 2020 2020  {}.             
-000122f0: 2020 2066 6f72 2073 7465 7069 6478 2c20     for stepidx, 
-00012300: 7374 6570 2069 6e20 656e 756d 6572 6174  step in enumerat
-00012310: 6528 7365 6c66 2e73 7465 7073 293a 0a20  e(self.steps):. 
-00012320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012330: 2020 2023 2041 7373 656d 626c 6520 7468     # Assemble th
-00012340: 6520 6f72 6967 696e 616c 2069 6e64 6578  e original index
-00012350: 6573 206f 6620 7468 6520 7265 6d61 696e  es of the remain
-00012360: 696e 6720 696e 7075 7473 0a20 2020 2020  ing inputs.     
-00012370: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00012380: 2028 692e 652e 2074 6865 206f 6e65 7320   (i.e. the ones 
-00012390: 7468 6174 2068 6176 656e 2774 2066 6169  that haven't fai
-000123a0: 6c65 6420 7965 7429 0a20 2020 2020 2020  led yet).       
-000123b0: 2020 2020 2020 2020 2020 2020 2072 656d               rem
-000123c0: 6169 6e69 6e67 5f69 6478 7320 3d20 5b0a  aining_idxs = [.
-000123d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000123e0: 2020 2020 2020 2020 6920 666f 7220 6920          i for i 
-000123f0: 696e 2072 616e 6765 286c 656e 2863 6f6e  in range(len(con
-00012400: 6669 6773 2929 2069 6620 6920 6e6f 7420  figs)) if i not 
-00012410: 696e 2066 6169 6c65 645f 696e 7075 7473  in failed_inputs
-00012420: 5f6d 6170 0a20 2020 2020 2020 2020 2020  _map.           
-00012430: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
-00012440: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00012450: 2049 6e76 6f6b 6520 7468 6520 7374 6570   Invoke the step
-00012460: 206f 6e20 7468 6520 7265 6d61 696e 696e   on the remainin
-00012470: 6720 696e 7075 7473 0a20 2020 2020 2020  g inputs.       
-00012480: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-00012490: 7574 7320 3d20 6177 6169 7420 7374 6570  uts = await step
-000124a0: 2e61 6261 7463 6828 0a20 2020 2020 2020  .abatch(.       
-000124b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000124c0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-000124d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000124e0: 6e70 0a20 2020 2020 2020 2020 2020 2020  np.             
-000124f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00012500: 6f72 2069 2c20 696e 7020 696e 207a 6970  or i, inp in zip
-00012510: 2872 656d 6169 6e69 6e67 5f69 6478 732c  (remaining_idxs,
-00012520: 2069 6e70 7574 7329 0a20 2020 2020 2020   inputs).       
-00012530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012540: 2020 2020 2069 6620 6920 6e6f 7420 696e       if i not in
-00012550: 2066 6169 6c65 645f 696e 7075 7473 5f6d   failed_inputs_m
-00012560: 6170 0a20 2020 2020 2020 2020 2020 2020  ap.             
-00012570: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
-00012580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012590: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-000125a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000125b0: 2020 2020 2320 6561 6368 2073 7465 7020      # each step 
-000125c0: 6120 6368 696c 6420 7275 6e20 6f66 2074  a child run of t
-000125d0: 6865 2063 6f72 7265 7370 6f6e 6469 6e67  he corresponding
-000125e0: 2072 6f6f 7420 7275 6e0a 2020 2020 2020   root run.      
-000125f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012600: 2020 2020 2020 7061 7463 685f 636f 6e66        patch_conf
-00012610: 6967 280a 2020 2020 2020 2020 2020 2020  ig(.            
-00012620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012630: 2020 2020 636f 6e66 6967 2c20 6361 6c6c      config, call
-00012640: 6261 636b 733d 726d 2e67 6574 5f63 6869  backs=rm.get_chi
-00012650: 6c64 2866 2273 6571 3a73 7465 703a 7b73  ld(f"seq:step:{s
-00012660: 7465 7069 6478 2b31 7d22 290a 2020 2020  tepidx+1}").    
-00012670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012680: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00012690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000126a0: 2020 2020 2020 666f 7220 692c 2028 726d        for i, (rm
-000126b0: 2c20 636f 6e66 6967 2920 696e 2065 6e75  , config) in enu
-000126c0: 6d65 7261 7465 287a 6970 2872 756e 5f6d  merate(zip(run_m
-000126d0: 616e 6167 6572 732c 2063 6f6e 6669 6773  anagers, configs
-000126e0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-000126f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00012700: 6620 6920 6e6f 7420 696e 2066 6169 6c65  f i not in faile
-00012710: 645f 696e 7075 7473 5f6d 6170 0a20 2020  d_inputs_map.   
-00012720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012730: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00012740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012750: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
-00012760: 733d 7265 7475 726e 5f65 7863 6570 7469  s=return_excepti
-00012770: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
-00012780: 2020 2020 2020 2020 2020 2020 202a 2a6b               **k
-00012790: 7761 7267 732c 0a20 2020 2020 2020 2020  wargs,.         
-000127a0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000127b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000127c0: 2023 2049 6620 616e 2069 6e70 7574 2066   # If an input f
-000127d0: 6169 6c65 642c 2061 6464 2069 7420 746f  ailed, add it to
-000127e0: 2074 6865 206d 6170 0a20 2020 2020 2020   the map.       
-000127f0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00012800: 2069 2c20 696e 7020 696e 207a 6970 2872   i, inp in zip(r
-00012810: 656d 6169 6e69 6e67 5f69 6478 732c 2069  emaining_idxs, i
-00012820: 6e70 7574 7329 3a0a 2020 2020 2020 2020  nputs):.        
-00012830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012840: 6966 2069 7369 6e73 7461 6e63 6528 696e  if isinstance(in
-00012850: 702c 2045 7863 6570 7469 6f6e 293a 0a20  p, Exception):. 
-00012860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012870: 2020 2020 2020 2020 2020 2066 6169 6c65             faile
-00012880: 645f 696e 7075 7473 5f6d 6170 5b69 5d20  d_inputs_map[i] 
-00012890: 3d20 696e 700a 2020 2020 2020 2020 2020  = inp.          
-000128a0: 2020 2020 2020 2020 2020 696e 7075 7473            inputs
-000128b0: 203d 205b 696e 7020 666f 7220 696e 7020   = [inp for inp 
-000128c0: 696e 2069 6e70 7574 7320 6966 206e 6f74  in inputs if not
-000128d0: 2069 7369 6e73 7461 6e63 6528 696e 702c   isinstance(inp,
-000128e0: 2045 7863 6570 7469 6f6e 295d 0a20 2020   Exception)].   
-000128f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012900: 2023 2049 6620 616c 6c20 696e 7075 7473   # If all inputs
-00012910: 2068 6176 6520 6661 696c 6564 2c20 7374   have failed, st
-00012920: 6f70 2070 726f 6365 7373 696e 670a 2020  op processing.  
-00012930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012940: 2020 6966 206c 656e 2866 6169 6c65 645f    if len(failed_
-00012950: 696e 7075 7473 5f6d 6170 2920 3d3d 206c  inputs_map) == l
-00012960: 656e 2863 6f6e 6669 6773 293a 0a20 2020  en(configs):.   
-00012970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012980: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
-00012990: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
-000129a0: 6173 7365 6d62 6c65 2074 6865 206f 7574  assemble the out
-000129b0: 7075 7473 2c20 696e 7365 7274 696e 6720  puts, inserting 
-000129c0: 4578 6365 7074 696f 6e73 2066 6f72 2066  Exceptions for f
-000129d0: 6169 6c65 6420 696e 7075 7473 0a20 2020  ailed inputs.   
-000129e0: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-000129f0: 7574 735f 636f 7079 203d 2069 6e70 7574  uts_copy = input
-00012a00: 732e 636f 7079 2829 0a20 2020 2020 2020  s.copy().       
-00012a10: 2020 2020 2020 2020 2069 6e70 7574 7320           inputs 
-00012a20: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-00012a30: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
-00012a40: 6e67 6528 6c65 6e28 636f 6e66 6967 7329  nge(len(configs)
-00012a50: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00012a60: 2020 2020 2020 2069 6620 6920 696e 2066         if i in f
-00012a70: 6169 6c65 645f 696e 7075 7473 5f6d 6170  ailed_inputs_map
-00012a80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012a90: 2020 2020 2020 2020 2020 696e 7075 7473            inputs
-00012aa0: 2e61 7070 656e 6428 6361 7374 2849 6e70  .append(cast(Inp
-00012ab0: 7574 2c20 6661 696c 6564 5f69 6e70 7574  ut, failed_input
-00012ac0: 735f 6d61 705b 695d 2929 0a20 2020 2020  s_map[i])).     
-00012ad0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00012ae0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00012af0: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-00012b00: 7574 732e 6170 7065 6e64 2869 6e70 7574  uts.append(input
-00012b10: 735f 636f 7079 2e70 6f70 2830 2929 0a20  s_copy.pop(0)). 
-00012b20: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00012b30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012b40: 2066 6f72 2069 2c20 7374 6570 2069 6e20   for i, step in 
-00012b50: 656e 756d 6572 6174 6528 7365 6c66 2e73  enumerate(self.s
-00012b60: 7465 7073 293a 0a20 2020 2020 2020 2020  teps):.         
-00012b70: 2020 2020 2020 2020 2020 2069 6e70 7574             input
-00012b80: 7320 3d20 6177 6169 7420 7374 6570 2e61  s = await step.a
-00012b90: 6261 7463 6828 0a20 2020 2020 2020 2020  batch(.         
-00012ba0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00012bb0: 6e70 7574 732c 0a20 2020 2020 2020 2020  nputs,.         
-00012bc0: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-00012bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012be0: 2020 2020 2020 2020 2020 2020 2023 2065               # e
-00012bf0: 6163 6820 7374 6570 2061 2063 6869 6c64  ach step a child
-00012c00: 2072 756e 206f 6620 7468 6520 636f 7272   run of the corr
-00012c10: 6573 706f 6e64 696e 6720 726f 6f74 2072  esponding root r
-00012c20: 756e 0a20 2020 2020 2020 2020 2020 2020  un.             
-00012c30: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00012c40: 6174 6368 5f63 6f6e 6669 6728 0a20 2020  atch_config(.   
-00012c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012c60: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00012c70: 6669 672c 2063 616c 6c62 6163 6b73 3d72  fig, callbacks=r
-00012c80: 6d2e 6765 745f 6368 696c 6428 6622 7365  m.get_child(f"se
-00012c90: 713a 7374 6570 3a7b 692b 317d 2229 0a20  q:step:{i+1}"). 
-00012ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012cb0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00012cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012cd0: 2020 2020 2020 2020 2066 6f72 2072 6d2c           for rm,
-00012ce0: 2063 6f6e 6669 6720 696e 207a 6970 2872   config in zip(r
-00012cf0: 756e 5f6d 616e 6167 6572 732c 2063 6f6e  un_managers, con
-00012d00: 6669 6773 290a 2020 2020 2020 2020 2020  figs).          
-00012d10: 2020 2020 2020 2020 2020 2020 2020 5d2c                ],
-00012d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012d30: 2020 2020 2029 0a20 2020 2020 2020 2023       ).        #
-00012d40: 2066 696e 6973 6820 7468 6520 726f 6f74   finish the root
-00012d50: 2072 756e 730a 2020 2020 2020 2020 6578   runs.        ex
-00012d60: 6365 7074 2042 6173 6545 7863 6570 7469  cept BaseExcepti
-00012d70: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
-00012d80: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
-00012d90: 696f 2e67 6174 6865 7228 2a28 726d 2e6f  io.gather(*(rm.o
-00012da0: 6e5f 6368 6169 6e5f 6572 726f 7228 6529  n_chain_error(e)
-00012db0: 2066 6f72 2072 6d20 696e 2072 756e 5f6d   for rm in run_m
-00012dc0: 616e 6167 6572 7329 290a 2020 2020 2020  anagers)).      
-00012dd0: 2020 2020 2020 6966 2072 6574 7572 6e5f        if return_
-00012de0: 6578 6365 7074 696f 6e73 3a0a 2020 2020  exceptions:.    
-00012df0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00012e00: 726e 2063 6173 7428 4c69 7374 5b4f 7574  rn cast(List[Out
-00012e10: 7075 745d 2c20 5b65 2066 6f72 205f 2069  put], [e for _ i
-00012e20: 6e20 696e 7075 7473 5d29 0a20 2020 2020  n inputs]).     
-00012e30: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00012e40: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00012e50: 7365 0a20 2020 2020 2020 2065 6c73 653a  se.        else:
-00012e60: 0a20 2020 2020 2020 2020 2020 2066 6972  .            fir
-00012e70: 7374 5f65 7863 6570 7469 6f6e 3a20 4f70  st_exception: Op
-00012e80: 7469 6f6e 616c 5b45 7863 6570 7469 6f6e  tional[Exception
-00012e90: 5d20 3d20 4e6f 6e65 0a20 2020 2020 2020  ] = None.       
-00012ea0: 2020 2020 2063 6f72 6f73 3a20 4c69 7374       coros: List
-00012eb0: 5b41 7761 6974 6162 6c65 5b4e 6f6e 655d  [Awaitable[None]
-00012ec0: 5d20 3d20 5b5d 0a20 2020 2020 2020 2020  ] = [].         
-00012ed0: 2020 2066 6f72 2072 756e 5f6d 616e 6167     for run_manag
-00012ee0: 6572 2c20 6f75 7420 696e 207a 6970 2872  er, out in zip(r
-00012ef0: 756e 5f6d 616e 6167 6572 732c 2069 6e70  un_managers, inp
-00012f00: 7574 7329 3a0a 2020 2020 2020 2020 2020  uts):.          
-00012f10: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00012f20: 6e63 6528 6f75 742c 2045 7863 6570 7469  nce(out, Excepti
-00012f30: 6f6e 293a 0a20 2020 2020 2020 2020 2020  on):.           
-00012f40: 2020 2020 2020 2020 2066 6972 7374 5f65           first_e
-00012f50: 7863 6570 7469 6f6e 203d 2066 6972 7374  xception = first
-00012f60: 5f65 7863 6570 7469 6f6e 206f 7220 6f75  _exception or ou
-00012f70: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-00012f80: 2020 2020 2020 636f 726f 732e 6170 7065        coros.appe
-00012f90: 6e64 2872 756e 5f6d 616e 6167 6572 2e6f  nd(run_manager.o
-00012fa0: 6e5f 6368 6169 6e5f 6572 726f 7228 6f75  n_chain_error(ou
-00012fb0: 7429 290a 2020 2020 2020 2020 2020 2020  t)).            
-00012fc0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00012fd0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00012fe0: 726f 732e 6170 7065 6e64 2872 756e 5f6d  ros.append(run_m
-00012ff0: 616e 6167 6572 2e6f 6e5f 6368 6169 6e5f  anager.on_chain_
-00013000: 656e 6428 6475 6d70 6428 6f75 7429 2929  end(dumpd(out)))
-00013010: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-00013020: 6974 2061 7379 6e63 696f 2e67 6174 6865  it asyncio.gathe
-00013030: 7228 2a63 6f72 6f73 290a 2020 2020 2020  r(*coros).      
-00013040: 2020 2020 2020 6966 2072 6574 7572 6e5f        if return_
-00013050: 6578 6365 7074 696f 6e73 206f 7220 6669  exceptions or fi
-00013060: 7273 745f 6578 6365 7074 696f 6e20 6973  rst_exception is
-00013070: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00013080: 2020 2020 2020 2072 6574 7572 6e20 6361         return ca
-00013090: 7374 284c 6973 745b 4f75 7470 7574 5d2c  st(List[Output],
-000130a0: 2069 6e70 7574 7329 0a20 2020 2020 2020   inputs).       
-000130b0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000130c0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-000130d0: 2066 6972 7374 5f65 7863 6570 7469 6f6e   first_exception
-000130e0: 0a0a 2020 2020 6465 6620 5f74 7261 6e73  ..    def _trans
-000130f0: 666f 726d 280a 2020 2020 2020 2020 7365  form(.        se
-00013100: 6c66 2c0a 2020 2020 2020 2020 696e 7075  lf,.        inpu
-00013110: 743a 2049 7465 7261 746f 725b 496e 7075  t: Iterator[Inpu
-00013120: 745d 2c0a 2020 2020 2020 2020 7275 6e5f  t],.        run_
-00013130: 6d61 6e61 6765 723a 2043 616c 6c62 6163  manager: Callbac
-00013140: 6b4d 616e 6167 6572 466f 7243 6861 696e  kManagerForChain
-00013150: 5275 6e2c 0a20 2020 2020 2020 2063 6f6e  Run,.        con
-00013160: 6669 673a 2052 756e 6e61 626c 6543 6f6e  fig: RunnableCon
-00013170: 6669 672c 0a20 2020 2029 202d 3e20 4974  fig,.    ) -> It
-00013180: 6572 6174 6f72 5b4f 7574 7075 745d 3a0a  erator[Output]:.
-00013190: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
-000131a0: 6763 6861 696e 5f63 6f72 652e 6265 7461  gchain_core.beta
-000131b0: 2e72 756e 6e61 626c 6573 2e63 6f6e 7465  .runnables.conte
-000131c0: 7874 2069 6d70 6f72 7420 636f 6e66 6967  xt import config
-000131d0: 5f77 6974 685f 636f 6e74 6578 740a 0a20  _with_context.. 
-000131e0: 2020 2020 2020 2073 7465 7073 203d 205b         steps = [
-000131f0: 7365 6c66 2e66 6972 7374 5d20 2b20 7365  self.first] + se
-00013200: 6c66 2e6d 6964 646c 6520 2b20 5b73 656c  lf.middle + [sel
-00013210: 662e 6c61 7374 5d0a 2020 2020 2020 2020  f.last].        
-00013220: 636f 6e66 6967 203d 2063 6f6e 6669 675f  config = config_
-00013230: 7769 7468 5f63 6f6e 7465 7874 2863 6f6e  with_context(con
-00013240: 6669 672c 2073 656c 662e 7374 6570 7329  fig, self.steps)
-00013250: 0a0a 2020 2020 2020 2020 2320 7472 616e  ..        # tran
-00013260: 7366 6f72 6d20 7468 6520 696e 7075 7420  sform the input 
-00013270: 7374 7265 616d 206f 6620 6561 6368 2073  stream of each s
-00013280: 7465 7020 7769 7468 2074 6865 206e 6578  tep with the nex
-00013290: 740a 2020 2020 2020 2020 2320 7374 6570  t.        # step
-000132a0: 7320 7468 6174 2064 6f6e 2774 206e 6174  s that don't nat
-000132b0: 6976 656c 7920 7375 7070 6f72 7420 7472  ively support tr
-000132c0: 616e 7366 6f72 6d69 6e67 2061 6e20 696e  ansforming an in
-000132d0: 7075 7420 7374 7265 616d 2077 696c 6c0a  put stream will.
-000132e0: 2020 2020 2020 2020 2320 6275 6666 6572          # buffer
-000132f0: 2069 6e70 7574 2069 6e20 6d65 6d6f 7279   input in memory
-00013300: 2075 6e74 696c 2061 6c6c 2061 7661 696c   until all avail
-00013310: 6162 6c65 2c20 616e 6420 7468 656e 2073  able, and then s
-00013320: 7461 7274 2065 6d69 7474 696e 6720 6f75  tart emitting ou
-00013330: 7470 7574 0a20 2020 2020 2020 2066 696e  tput.        fin
-00013340: 616c 5f70 6970 656c 696e 6520 3d20 6361  al_pipeline = ca
-00013350: 7374 2849 7465 7261 746f 725b 4f75 7470  st(Iterator[Outp
-00013360: 7574 5d2c 2069 6e70 7574 290a 2020 2020  ut], input).    
-00013370: 2020 2020 666f 7220 7374 6570 2069 6e20      for step in 
-00013380: 7374 6570 733a 0a20 2020 2020 2020 2020  steps:.         
-00013390: 2020 2066 696e 616c 5f70 6970 656c 696e     final_pipelin
-000133a0: 6520 3d20 7374 6570 2e74 7261 6e73 666f  e = step.transfo
-000133b0: 726d 280a 2020 2020 2020 2020 2020 2020  rm(.            
-000133c0: 2020 2020 6669 6e61 6c5f 7069 7065 6c69      final_pipeli
-000133d0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-000133e0: 2020 2020 7061 7463 685f 636f 6e66 6967      patch_config
-000133f0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00013400: 2020 2020 2020 636f 6e66 6967 2c0a 2020        config,.  
-00013410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013420: 2020 6361 6c6c 6261 636b 733d 7275 6e5f    callbacks=run_
-00013430: 6d61 6e61 6765 722e 6765 745f 6368 696c  manager.get_chil
-00013440: 6428 6622 7365 713a 7374 6570 3a7b 7374  d(f"seq:step:{st
-00013450: 6570 732e 696e 6465 7828 7374 6570 292b  eps.index(step)+
-00013460: 317d 2229 2c0a 2020 2020 2020 2020 2020  1}"),.          
-00013470: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
-00013480: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00013490: 666f 7220 6f75 7470 7574 2069 6e20 6669  for output in fi
-000134a0: 6e61 6c5f 7069 7065 6c69 6e65 3a0a 2020  nal_pipeline:.  
-000134b0: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
-000134c0: 6f75 7470 7574 0a0a 2020 2020 6173 796e  output..    asyn
-000134d0: 6320 6465 6620 5f61 7472 616e 7366 6f72  c def _atransfor
-000134e0: 6d28 0a20 2020 2020 2020 2073 656c 662c  m(.        self,
-000134f0: 0a20 2020 2020 2020 2069 6e70 7574 3a20  .        input: 
-00013500: 4173 796e 6349 7465 7261 746f 725b 496e  AsyncIterator[In
-00013510: 7075 745d 2c0a 2020 2020 2020 2020 7275  put],.        ru
-00013520: 6e5f 6d61 6e61 6765 723a 2041 7379 6e63  n_manager: Async
-00013530: 4361 6c6c 6261 636b 4d61 6e61 6765 7246  CallbackManagerF
-00013540: 6f72 4368 6169 6e52 756e 2c0a 2020 2020  orChainRun,.    
-00013550: 2020 2020 636f 6e66 6967 3a20 5275 6e6e      config: Runn
-00013560: 6162 6c65 436f 6e66 6967 2c0a 2020 2020  ableConfig,.    
-00013570: 2920 2d3e 2041 7379 6e63 4974 6572 6174  ) -> AsyncIterat
-00013580: 6f72 5b4f 7574 7075 745d 3a0a 2020 2020  or[Output]:.    
-00013590: 2020 2020 6672 6f6d 206c 616e 6763 6861      from langcha
-000135a0: 696e 5f63 6f72 652e 6265 7461 2e72 756e  in_core.beta.run
-000135b0: 6e61 626c 6573 2e63 6f6e 7465 7874 2069  nables.context i
-000135c0: 6d70 6f72 7420 6163 6f6e 6669 675f 7769  mport aconfig_wi
-000135d0: 7468 5f63 6f6e 7465 7874 0a0a 2020 2020  th_context..    
-000135e0: 2020 2020 7374 6570 7320 3d20 5b73 656c      steps = [sel
-000135f0: 662e 6669 7273 745d 202b 2073 656c 662e  f.first] + self.
-00013600: 6d69 6464 6c65 202b 205b 7365 6c66 2e6c  middle + [self.l
-00013610: 6173 745d 0a20 2020 2020 2020 2063 6f6e  ast].        con
-00013620: 6669 6720 3d20 6163 6f6e 6669 675f 7769  fig = aconfig_wi
-00013630: 7468 5f63 6f6e 7465 7874 2863 6f6e 6669  th_context(confi
-00013640: 672c 2073 656c 662e 7374 6570 7329 0a0a  g, self.steps)..
-00013650: 2020 2020 2020 2020 2320 7374 7265 616d          # stream
-00013660: 2074 6865 206c 6173 7420 7374 6570 730a   the last steps.
-00013670: 2020 2020 2020 2020 2320 7472 616e 7366          # transf
-00013680: 6f72 6d20 7468 6520 696e 7075 7420 7374  orm the input st
-00013690: 7265 616d 206f 6620 6561 6368 2073 7465  ream of each ste
-000136a0: 7020 7769 7468 2074 6865 206e 6578 740a  p with the next.
-000136b0: 2020 2020 2020 2020 2320 7374 6570 7320          # steps 
-000136c0: 7468 6174 2064 6f6e 2774 206e 6174 6976  that don't nativ
-000136d0: 656c 7920 7375 7070 6f72 7420 7472 616e  ely support tran
-000136e0: 7366 6f72 6d69 6e67 2061 6e20 696e 7075  sforming an inpu
-000136f0: 7420 7374 7265 616d 2077 696c 6c0a 2020  t stream will.  
-00013700: 2020 2020 2020 2320 6275 6666 6572 2069        # buffer i
-00013710: 6e70 7574 2069 6e20 6d65 6d6f 7279 2075  nput in memory u
-00013720: 6e74 696c 2061 6c6c 2061 7661 696c 6162  ntil all availab
-00013730: 6c65 2c20 616e 6420 7468 656e 2073 7461  le, and then sta
-00013740: 7274 2065 6d69 7474 696e 6720 6f75 7470  rt emitting outp
-00013750: 7574 0a20 2020 2020 2020 2066 696e 616c  ut.        final
-00013760: 5f70 6970 656c 696e 6520 3d20 6361 7374  _pipeline = cast
-00013770: 2841 7379 6e63 4974 6572 6174 6f72 5b4f  (AsyncIterator[O
-00013780: 7574 7075 745d 2c20 696e 7075 7429 0a20  utput], input). 
-00013790: 2020 2020 2020 2066 6f72 2073 7465 7020         for step 
-000137a0: 696e 2073 7465 7073 3a0a 2020 2020 2020  in steps:.      
-000137b0: 2020 2020 2020 6669 6e61 6c5f 7069 7065        final_pipe
-000137c0: 6c69 6e65 203d 2073 7465 702e 6174 7261  line = step.atra
-000137d0: 6e73 666f 726d 280a 2020 2020 2020 2020  nsform(.        
-000137e0: 2020 2020 2020 2020 6669 6e61 6c5f 7069          final_pi
-000137f0: 7065 6c69 6e65 2c0a 2020 2020 2020 2020  peline,.        
-00013800: 2020 2020 2020 2020 7061 7463 685f 636f          patch_co
-00013810: 6e66 6967 280a 2020 2020 2020 2020 2020  nfig(.          
-00013820: 2020 2020 2020 2020 2020 636f 6e66 6967            config
-00013830: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00013840: 2020 2020 2020 6361 6c6c 6261 636b 733d        callbacks=
-00013850: 7275 6e5f 6d61 6e61 6765 722e 6765 745f  run_manager.get_
-00013860: 6368 696c 6428 6622 7365 713a 7374 6570  child(f"seq:step
-00013870: 3a7b 7374 6570 732e 696e 6465 7828 7374  :{steps.index(st
-00013880: 6570 292b 317d 2229 2c0a 2020 2020 2020  ep)+1}"),.      
-00013890: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-000138a0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000138b0: 2020 2061 7379 6e63 2066 6f72 206f 7574     async for out
-000138c0: 7075 7420 696e 2066 696e 616c 5f70 6970  put in final_pip
-000138d0: 656c 696e 653a 0a20 2020 2020 2020 2020  eline:.         
-000138e0: 2020 2079 6965 6c64 206f 7574 7075 740a     yield output.
-000138f0: 0a20 2020 2064 6566 2074 7261 6e73 666f  .    def transfo
-00013900: 726d 280a 2020 2020 2020 2020 7365 6c66  rm(.        self
-00013910: 2c0a 2020 2020 2020 2020 696e 7075 743a  ,.        input:
-00013920: 2049 7465 7261 746f 725b 496e 7075 745d   Iterator[Input]
-00013930: 2c0a 2020 2020 2020 2020 636f 6e66 6967  ,.        config
-00013940: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
-00013950: 626c 6543 6f6e 6669 675d 203d 204e 6f6e  bleConfig] = Non
-00013960: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
-00013970: 7267 733a 204f 7074 696f 6e61 6c5b 416e  rgs: Optional[An
-00013980: 795d 2c0a 2020 2020 2920 2d3e 2049 7465  y],.    ) -> Ite
-00013990: 7261 746f 725b 4f75 7470 7574 5d3a 0a20  rator[Output]:. 
-000139a0: 2020 2020 2020 2079 6965 6c64 2066 726f         yield fro
-000139b0: 6d20 7365 6c66 2e5f 7472 616e 7366 6f72  m self._transfor
-000139c0: 6d5f 7374 7265 616d 5f77 6974 685f 636f  m_stream_with_co
-000139d0: 6e66 6967 280a 2020 2020 2020 2020 2020  nfig(.          
-000139e0: 2020 696e 7075 742c 0a20 2020 2020 2020    input,.       
-000139f0: 2020 2020 2073 656c 662e 5f74 7261 6e73       self._trans
-00013a00: 666f 726d 2c0a 2020 2020 2020 2020 2020  form,.          
-00013a10: 2020 7061 7463 685f 636f 6e66 6967 2863    patch_config(c
-00013a20: 6f6e 6669 672c 2072 756e 5f6e 616d 653d  onfig, run_name=
-00013a30: 2863 6f6e 6669 6720 6f72 207b 7d29 2e67  (config or {}).g
-00013a40: 6574 2822 7275 6e5f 6e61 6d65 2229 206f  et("run_name") o
-00013a50: 7220 7365 6c66 2e6e 616d 6529 2c0a 2020  r self.name),.  
-00013a60: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
-00013a70: 6773 2c0a 2020 2020 2020 2020 290a 0a20  gs,.        ).. 
-00013a80: 2020 2064 6566 2073 7472 6561 6d28 0a20     def stream(. 
-00013a90: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00013aa0: 2020 2020 2069 6e70 7574 3a20 496e 7075       input: Inpu
-00013ab0: 742c 0a20 2020 2020 2020 2063 6f6e 6669  t,.        confi
-00013ac0: 673a 204f 7074 696f 6e61 6c5b 5275 6e6e  g: Optional[Runn
-00013ad0: 6162 6c65 436f 6e66 6967 5d20 3d20 4e6f  ableConfig] = No
-00013ae0: 6e65 2c0a 2020 2020 2020 2020 2a2a 6b77  ne,.        **kw
-00013af0: 6172 6773 3a20 4f70 7469 6f6e 616c 5b41  args: Optional[A
-00013b00: 6e79 5d2c 0a20 2020 2029 202d 3e20 4974  ny],.    ) -> It
-00013b10: 6572 6174 6f72 5b4f 7574 7075 745d 3a0a  erator[Output]:.
-00013b20: 2020 2020 2020 2020 7969 656c 6420 6672          yield fr
-00013b30: 6f6d 2073 656c 662e 7472 616e 7366 6f72  om self.transfor
-00013b40: 6d28 6974 6572 285b 696e 7075 745d 292c  m(iter([input]),
-00013b50: 2063 6f6e 6669 672c 202a 2a6b 7761 7267   config, **kwarg
-00013b60: 7329 0a0a 2020 2020 6173 796e 6320 6465  s)..    async de
-00013b70: 6620 6174 7261 6e73 666f 726d 280a 2020  f atransform(.  
-00013b80: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-00013b90: 2020 2020 696e 7075 743a 2041 7379 6e63      input: Async
-00013ba0: 4974 6572 6174 6f72 5b49 6e70 7574 5d2c  Iterator[Input],
-00013bb0: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
-00013bc0: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
-00013bd0: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
-00013be0: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
-00013bf0: 6773 3a20 4f70 7469 6f6e 616c 5b41 6e79  gs: Optional[Any
-00013c00: 5d2c 0a20 2020 2029 202d 3e20 4173 796e  ],.    ) -> Asyn
-00013c10: 6349 7465 7261 746f 725b 4f75 7470 7574  cIterator[Output
-00013c20: 5d3a 0a20 2020 2020 2020 2061 7379 6e63  ]:.        async
-00013c30: 2066 6f72 2063 6875 6e6b 2069 6e20 7365   for chunk in se
-00013c40: 6c66 2e5f 6174 7261 6e73 666f 726d 5f73  lf._atransform_s
-00013c50: 7472 6561 6d5f 7769 7468 5f63 6f6e 6669  tream_with_confi
-00013c60: 6728 0a20 2020 2020 2020 2020 2020 2069  g(.            i
-00013c70: 6e70 7574 2c0a 2020 2020 2020 2020 2020  nput,.          
-00013c80: 2020 7365 6c66 2e5f 6174 7261 6e73 666f    self._atransfo
-00013c90: 726d 2c0a 2020 2020 2020 2020 2020 2020  rm,.            
-00013ca0: 7061 7463 685f 636f 6e66 6967 2863 6f6e  patch_config(con
-00013cb0: 6669 672c 2072 756e 5f6e 616d 653d 2863  fig, run_name=(c
-00013cc0: 6f6e 6669 6720 6f72 207b 7d29 2e67 6574  onfig or {}).get
-00013cd0: 2822 7275 6e5f 6e61 6d65 2229 206f 7220  ("run_name") or 
-00013ce0: 7365 6c66 2e6e 616d 6529 2c0a 2020 2020  self.name),.    
-00013cf0: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
-00013d00: 2c0a 2020 2020 2020 2020 293a 0a20 2020  ,.        ):.   
-00013d10: 2020 2020 2020 2020 2079 6965 6c64 2063           yield c
-00013d20: 6875 6e6b 0a0a 2020 2020 6173 796e 6320  hunk..    async 
-00013d30: 6465 6620 6173 7472 6561 6d28 0a20 2020  def astream(.   
-00013d40: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00013d50: 2020 2069 6e70 7574 3a20 496e 7075 742c     input: Input,
-00013d60: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
-00013d70: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
-00013d80: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
-00013d90: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
-00013da0: 6773 3a20 4f70 7469 6f6e 616c 5b41 6e79  gs: Optional[Any
-00013db0: 5d2c 0a20 2020 2029 202d 3e20 4173 796e  ],.    ) -> Asyn
-00013dc0: 6349 7465 7261 746f 725b 4f75 7470 7574  cIterator[Output
-00013dd0: 5d3a 0a20 2020 2020 2020 2061 7379 6e63  ]:.        async
-00013de0: 2064 6566 2069 6e70 7574 5f61 6974 6572   def input_aiter
-00013df0: 2829 202d 3e20 4173 796e 6349 7465 7261  () -> AsyncItera
-00013e00: 746f 725b 496e 7075 745d 3a0a 2020 2020  tor[Input]:.    
-00013e10: 2020 2020 2020 2020 7969 656c 6420 696e          yield in
-00013e20: 7075 740a 0a20 2020 2020 2020 2061 7379  put..        asy
-00013e30: 6e63 2066 6f72 2063 6875 6e6b 2069 6e20  nc for chunk in 
-00013e40: 7365 6c66 2e61 7472 616e 7366 6f72 6d28  self.atransform(
-00013e50: 696e 7075 745f 6169 7465 7228 292c 2063  input_aiter(), c
-00013e60: 6f6e 6669 672c 202a 2a6b 7761 7267 7329  onfig, **kwargs)
-00013e70: 3a0a 2020 2020 2020 2020 2020 2020 7969  :.            yi
-00013e80: 656c 6420 6368 756e 6b0a 0a0a 636c 6173  eld chunk...clas
-00013e90: 7320 5275 6e6e 6162 6c65 5061 7261 6c6c  s RunnableParall
-00013ea0: 656c 2852 756e 6e61 626c 6553 6572 6961  el(RunnableSeria
-00013eb0: 6c69 7a61 626c 655b 496e 7075 742c 2044  lizable[Input, D
-00013ec0: 6963 745b 7374 722c 2041 6e79 5d5d 293a  ict[str, Any]]):
-00013ed0: 0a20 2020 2022 2222 0a20 2020 2041 2072  .    """.    A r
-00013ee0: 756e 6e61 626c 6520 7468 6174 2072 756e  unnable that run
-00013ef0: 7320 6120 6d61 7070 696e 6720 6f66 2072  s a mapping of r
-00013f00: 756e 6e61 626c 6573 2069 6e20 7061 7261  unnables in para
-00013f10: 6c6c 656c 2c0a 2020 2020 616e 6420 7265  llel,.    and re
-00013f20: 7475 726e 7320 6120 6d61 7070 696e 6720  turns a mapping 
-00013f30: 6f66 2074 6865 6972 206f 7574 7075 7473  of their outputs
-00013f40: 2e0a 2020 2020 2222 220a 0a20 2020 2073  ..    """..    s
-00013f50: 7465 7073 3a20 4d61 7070 696e 675b 7374  teps: Mapping[st
-00013f60: 722c 2052 756e 6e61 626c 655b 496e 7075  r, Runnable[Inpu
-00013f70: 742c 2041 6e79 5d5d 0a0a 2020 2020 6465  t, Any]]..    de
-00013f80: 6620 5f5f 696e 6974 5f5f 280a 2020 2020  f __init__(.    
-00013f90: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00013fa0: 2020 5f5f 7374 6570 733a 204f 7074 696f    __steps: Optio
-00013fb0: 6e61 6c5b 0a20 2020 2020 2020 2020 2020  nal[.           
-00013fc0: 204d 6170 7069 6e67 5b0a 2020 2020 2020   Mapping[.      
-00013fd0: 2020 2020 2020 2020 2020 7374 722c 0a20            str,. 
-00013fe0: 2020 2020 2020 2020 2020 2020 2020 2055                 U
-00013ff0: 6e69 6f6e 5b0a 2020 2020 2020 2020 2020  nion[.          
-00014000: 2020 2020 2020 2020 2020 5275 6e6e 6162            Runnab
-00014010: 6c65 5b49 6e70 7574 2c20 416e 795d 2c0a  le[Input, Any],.
-00014020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014030: 2020 2020 4361 6c6c 6162 6c65 5b5b 496e      Callable[[In
-00014040: 7075 745d 2c20 416e 795d 2c0a 2020 2020  put], Any],.    
-00014050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014060: 4d61 7070 696e 675b 7374 722c 2055 6e69  Mapping[str, Uni
-00014070: 6f6e 5b52 756e 6e61 626c 655b 496e 7075  on[Runnable[Inpu
-00014080: 742c 2041 6e79 5d2c 2043 616c 6c61 626c  t, Any], Callabl
-00014090: 655b 5b49 6e70 7574 5d2c 2041 6e79 5d5d  e[[Input], Any]]
-000140a0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-000140b0: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
-000140c0: 2020 5d0a 2020 2020 2020 2020 5d20 3d20    ].        ] = 
-000140d0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2a2a  None,.        **
-000140e0: 6b77 6172 6773 3a20 556e 696f 6e5b 0a20  kwargs: Union[. 
-000140f0: 2020 2020 2020 2020 2020 2052 756e 6e61             Runna
-00014100: 626c 655b 496e 7075 742c 2041 6e79 5d2c  ble[Input, Any],
-00014110: 0a20 2020 2020 2020 2020 2020 2043 616c  .            Cal
-00014120: 6c61 626c 655b 5b49 6e70 7574 5d2c 2041  lable[[Input], A
-00014130: 6e79 5d2c 0a20 2020 2020 2020 2020 2020  ny],.           
-00014140: 204d 6170 7069 6e67 5b73 7472 2c20 556e   Mapping[str, Un
-00014150: 696f 6e5b 5275 6e6e 6162 6c65 5b49 6e70  ion[Runnable[Inp
-00014160: 7574 2c20 416e 795d 2c20 4361 6c6c 6162  ut, Any], Callab
-00014170: 6c65 5b5b 496e 7075 745d 2c20 416e 795d  le[[Input], Any]
-00014180: 5d5d 2c0a 2020 2020 2020 2020 5d2c 0a20  ]],.        ],. 
-00014190: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
-000141a0: 2020 2020 2020 6d65 7267 6564 203d 207b        merged = {
-000141b0: 2a2a 5f5f 7374 6570 737d 2069 6620 5f5f  **__steps} if __
-000141c0: 7374 6570 7320 6973 206e 6f74 204e 6f6e  steps is not Non
-000141d0: 6520 656c 7365 207b 7d0a 2020 2020 2020  e else {}.      
-000141e0: 2020 6d65 7267 6564 2e75 7064 6174 6528    merged.update(
-000141f0: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
-00014200: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
-00014210: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
-00014220: 6570 733d 7b6b 6579 3a20 636f 6572 6365  eps={key: coerce
-00014230: 5f74 6f5f 7275 6e6e 6162 6c65 2872 2920  _to_runnable(r) 
-00014240: 666f 7220 6b65 792c 2072 2069 6e20 6d65  for key, r in me
-00014250: 7267 6564 2e69 7465 6d73 2829 7d0a 2020  rged.items()}.  
-00014260: 2020 2020 2020 290a 0a20 2020 2040 636c        )..    @cl
-00014270: 6173 736d 6574 686f 640a 2020 2020 6465  assmethod.    de
-00014280: 6620 6973 5f6c 635f 7365 7269 616c 697a  f is_lc_serializ
-00014290: 6162 6c65 2863 6c73 2920 2d3e 2062 6f6f  able(cls) -> boo
-000142a0: 6c3a 0a20 2020 2020 2020 2072 6574 7572  l:.        retur
-000142b0: 6e20 5472 7565 0a0a 2020 2020 4063 6c61  n True..    @cla
-000142c0: 7373 6d65 7468 6f64 0a20 2020 2064 6566  ssmethod.    def
-000142d0: 2067 6574 5f6c 635f 6e61 6d65 7370 6163   get_lc_namespac
-000142e0: 6528 636c 7329 202d 3e20 4c69 7374 5b73  e(cls) -> List[s
-000142f0: 7472 5d3a 0a20 2020 2020 2020 2022 2222  tr]:.        """
-00014300: 4765 7420 7468 6520 6e61 6d65 7370 6163  Get the namespac
-00014310: 6520 6f66 2074 6865 206c 616e 6763 6861  e of the langcha
-00014320: 696e 206f 626a 6563 742e 2222 220a 2020  in object.""".  
-00014330: 2020 2020 2020 7265 7475 726e 205b 226c        return ["l
-00014340: 616e 6763 6861 696e 222c 2022 7363 6865  angchain", "sche
-00014350: 6d61 222c 2022 7275 6e6e 6162 6c65 225d  ma", "runnable"]
-00014360: 0a0a 2020 2020 636c 6173 7320 436f 6e66  ..    class Conf
-00014370: 6967 3a0a 2020 2020 2020 2020 6172 6269  ig:.        arbi
-00014380: 7472 6172 795f 7479 7065 735f 616c 6c6f  trary_types_allo
-00014390: 7765 6420 3d20 5472 7565 0a0a 2020 2020  wed = True..    
-000143a0: 6465 6620 6765 745f 6e61 6d65 280a 2020  def get_name(.  
-000143b0: 2020 2020 2020 7365 6c66 2c20 7375 6666        self, suff
-000143c0: 6978 3a20 4f70 7469 6f6e 616c 5b73 7472  ix: Optional[str
-000143d0: 5d20 3d20 4e6f 6e65 2c20 2a2c 206e 616d  ] = None, *, nam
-000143e0: 653a 204f 7074 696f 6e61 6c5b 7374 725d  e: Optional[str]
-000143f0: 203d 204e 6f6e 650a 2020 2020 2920 2d3e   = None.    ) ->
-00014400: 2073 7472 3a0a 2020 2020 2020 2020 6e61   str:.        na
-00014410: 6d65 203d 206e 616d 6520 6f72 2073 656c  me = name or sel
-00014420: 662e 6e61 6d65 206f 7220 6622 5275 6e6e  f.name or f"Runn
-00014430: 6162 6c65 5061 7261 6c6c 656c 3c7b 272c  ableParallel<{',
-00014440: 272e 6a6f 696e 2873 656c 662e 7374 6570  '.join(self.step
-00014450: 732e 6b65 7973 2829 297d 3e22 0a20 2020  s.keys())}>".   
-00014460: 2020 2020 2072 6574 7572 6e20 7375 7065       return supe
-00014470: 7228 292e 6765 745f 6e61 6d65 2873 7566  r().get_name(suf
-00014480: 6669 782c 206e 616d 653d 6e61 6d65 290a  fix, name=name).
-00014490: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-000144a0: 2020 2064 6566 2049 6e70 7574 5479 7065     def InputType
-000144b0: 2873 656c 6629 202d 3e20 416e 793a 0a20  (self) -> Any:. 
-000144c0: 2020 2020 2020 2066 6f72 2073 7465 7020         for step 
-000144d0: 696e 2073 656c 662e 7374 6570 732e 7661  in self.steps.va
-000144e0: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
-000144f0: 2020 2020 6966 2073 7465 702e 496e 7075      if step.Inpu
-00014500: 7454 7970 653a 0a20 2020 2020 2020 2020  tType:.         
-00014510: 2020 2020 2020 2072 6574 7572 6e20 7374         return st
-00014520: 6570 2e49 6e70 7574 5479 7065 0a0a 2020  ep.InputType..  
-00014530: 2020 2020 2020 7265 7475 726e 2041 6e79        return Any
-00014540: 0a0a 2020 2020 6465 6620 6765 745f 696e  ..    def get_in
-00014550: 7075 745f 7363 6865 6d61 280a 2020 2020  put_schema(.    
-00014560: 2020 2020 7365 6c66 2c20 636f 6e66 6967      self, config
-00014570: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
-00014580: 626c 6543 6f6e 6669 675d 203d 204e 6f6e  bleConfig] = Non
-00014590: 650a 2020 2020 2920 2d3e 2054 7970 655b  e.    ) -> Type[
-000145a0: 4261 7365 4d6f 6465 6c5d 3a0a 2020 2020  BaseModel]:.    
-000145b0: 2020 2020 6966 2061 6c6c 280a 2020 2020      if all(.    
-000145c0: 2020 2020 2020 2020 732e 6765 745f 696e          s.get_in
-000145d0: 7075 745f 7363 6865 6d61 2863 6f6e 6669  put_schema(confi
-000145e0: 6729 2e73 6368 656d 6128 292e 6765 7428  g).schema().get(
-000145f0: 2274 7970 6522 2c20 226f 626a 6563 7422  "type", "object"
-00014600: 2920 3d3d 2022 6f62 6a65 6374 220a 2020  ) == "object".  
-00014610: 2020 2020 2020 2020 2020 666f 7220 7320            for s 
-00014620: 696e 2073 656c 662e 7374 6570 732e 7661  in self.steps.va
-00014630: 6c75 6573 2829 0a20 2020 2020 2020 2029  lues().        )
+00011120: 2020 2066 6972 7374 5f65 7863 6570 7469     first_excepti
+00011130: 6f6e 203d 2066 6972 7374 5f65 7863 6570  on = first_excep
+00011140: 7469 6f6e 206f 7220 6f75 740a 2020 2020  tion or out.    
+00011150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011160: 636f 726f 732e 6170 7065 6e64 2872 756e  coros.append(run
+00011170: 5f6d 616e 6167 6572 2e6f 6e5f 6368 6169  _manager.on_chai
+00011180: 6e5f 6572 726f 7228 6f75 7429 290a 2020  n_error(out)).  
+00011190: 2020 2020 2020 2020 2020 2020 2020 656c                el
+000111a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000111b0: 2020 2020 2020 2020 636f 726f 732e 6170          coros.ap
+000111c0: 7065 6e64 2872 756e 5f6d 616e 6167 6572  pend(run_manager
+000111d0: 2e6f 6e5f 6368 6169 6e5f 656e 6428 6f75  .on_chain_end(ou
+000111e0: 7429 290a 2020 2020 2020 2020 2020 2020  t)).            
+000111f0: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
+00011200: 7468 6572 282a 636f 726f 7329 0a20 2020  ther(*coros).   
+00011210: 2020 2020 2020 2020 2069 6620 7265 7475           if retu
+00011220: 726e 5f65 7863 6570 7469 6f6e 7320 6f72  rn_exceptions or
+00011230: 2066 6972 7374 5f65 7863 6570 7469 6f6e   first_exception
+00011240: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00011250: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00011260: 2063 6173 7428 4c69 7374 5b4f 7574 7075   cast(List[Outpu
+00011270: 745d 2c20 6f75 7470 7574 290a 2020 2020  t], output).    
+00011280: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00011290: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+000112a0: 6973 6520 6669 7273 745f 6578 6365 7074  ise first_except
+000112b0: 696f 6e0a 0a20 2020 2064 6566 205f 7472  ion..    def _tr
+000112c0: 616e 7366 6f72 6d5f 7374 7265 616d 5f77  ansform_stream_w
+000112d0: 6974 685f 636f 6e66 6967 280a 2020 2020  ith_config(.    
+000112e0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+000112f0: 2020 696e 7075 743a 2049 7465 7261 746f    input: Iterato
+00011300: 725b 496e 7075 745d 2c0a 2020 2020 2020  r[Input],.      
+00011310: 2020 7472 616e 7366 6f72 6d65 723a 2055    transformer: U
+00011320: 6e69 6f6e 5b0a 2020 2020 2020 2020 2020  nion[.          
+00011330: 2020 4361 6c6c 6162 6c65 5b5b 4974 6572    Callable[[Iter
+00011340: 6174 6f72 5b49 6e70 7574 5d5d 2c20 4974  ator[Input]], It
+00011350: 6572 6174 6f72 5b4f 7574 7075 745d 5d2c  erator[Output]],
+00011360: 0a20 2020 2020 2020 2020 2020 2043 616c  .            Cal
+00011370: 6c61 626c 655b 5b49 7465 7261 746f 725b  lable[[Iterator[
+00011380: 496e 7075 745d 2c20 4361 6c6c 6261 636b  Input], Callback
+00011390: 4d61 6e61 6765 7246 6f72 4368 6169 6e52  ManagerForChainR
+000113a0: 756e 5d2c 2049 7465 7261 746f 725b 4f75  un], Iterator[Ou
+000113b0: 7470 7574 5d5d 2c0a 2020 2020 2020 2020  tput]],.        
+000113c0: 2020 2020 4361 6c6c 6162 6c65 5b0a 2020      Callable[.  
+000113d0: 2020 2020 2020 2020 2020 2020 2020 5b0a                [.
+000113e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000113f0: 2020 2020 4974 6572 6174 6f72 5b49 6e70      Iterator[Inp
+00011400: 7574 5d2c 0a20 2020 2020 2020 2020 2020  ut],.           
+00011410: 2020 2020 2020 2020 2043 616c 6c62 6163           Callbac
+00011420: 6b4d 616e 6167 6572 466f 7243 6861 696e  kManagerForChain
+00011430: 5275 6e2c 0a20 2020 2020 2020 2020 2020  Run,.           
+00011440: 2020 2020 2020 2020 2052 756e 6e61 626c           Runnabl
+00011450: 6543 6f6e 6669 672c 0a20 2020 2020 2020  eConfig,.       
+00011460: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
+00011470: 2020 2020 2020 2020 2020 2020 4974 6572              Iter
+00011480: 6174 6f72 5b4f 7574 7075 745d 2c0a 2020  ator[Output],.  
+00011490: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
+000114a0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+000114b0: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
+000114c0: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+000114d0: 2c0a 2020 2020 2020 2020 7275 6e5f 7479  ,.        run_ty
+000114e0: 7065 3a20 4f70 7469 6f6e 616c 5b73 7472  pe: Optional[str
+000114f0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00011500: 2020 2a2a 6b77 6172 6773 3a20 4f70 7469    **kwargs: Opti
+00011510: 6f6e 616c 5b41 6e79 5d2c 0a20 2020 2029  onal[Any],.    )
+00011520: 202d 3e20 4974 6572 6174 6f72 5b4f 7574   -> Iterator[Out
+00011530: 7075 745d 3a0a 2020 2020 2020 2020 2222  put]:.        ""
+00011540: 2248 656c 7065 7220 6d65 7468 6f64 2074  "Helper method t
+00011550: 6f20 7472 616e 7366 6f72 6d20 616e 2049  o transform an I
+00011560: 7465 7261 746f 7220 6f66 2049 6e70 7574  terator of Input
+00011570: 2076 616c 7565 7320 696e 746f 2061 6e20   values into an 
+00011580: 4974 6572 6174 6f72 206f 660a 2020 2020  Iterator of.    
+00011590: 2020 2020 4f75 7470 7574 2076 616c 7565      Output value
+000115a0: 732c 2077 6974 6820 6361 6c6c 6261 636b  s, with callback
+000115b0: 732e 0a20 2020 2020 2020 2055 7365 2074  s..        Use t
+000115c0: 6869 7320 746f 2069 6d70 6c65 6d65 6e74  his to implement
+000115d0: 2060 7374 7265 616d 2829 6020 6f72 2060   `stream()` or `
+000115e0: 7472 616e 7366 6f72 6d28 2960 2069 6e20  transform()` in 
+000115f0: 5275 6e6e 6162 6c65 2073 7562 636c 6173  Runnable subclas
+00011600: 7365 732e 2222 220a 2020 2020 2020 2020  ses.""".        
+00011610: 2320 7465 6520 7468 6520 696e 7075 7420  # tee the input 
+00011620: 736f 2077 6520 6361 6e20 6974 6572 6174  so we can iterat
+00011630: 6520 6f76 6572 2069 7420 7477 6963 650a  e over it twice.
+00011640: 2020 2020 2020 2020 696e 7075 745f 666f          input_fo
+00011650: 725f 7472 6163 696e 672c 2069 6e70 7574  r_tracing, input
+00011660: 5f66 6f72 5f74 7261 6e73 666f 726d 203d  _for_transform =
+00011670: 2074 6565 2869 6e70 7574 2c20 3229 0a20   tee(input, 2). 
+00011680: 2020 2020 2020 2023 2053 7461 7274 2074         # Start t
+00011690: 6865 2069 6e70 7574 2069 7465 7261 746f  he input iterato
+000116a0: 7220 746f 2065 6e73 7572 6520 7468 6520  r to ensure the 
+000116b0: 696e 7075 7420 7275 6e6e 6162 6c65 2073  input runnable s
+000116c0: 7461 7274 7320 6265 666f 7265 2074 6869  tarts before thi
+000116d0: 7320 6f6e 650a 2020 2020 2020 2020 6669  s one.        fi
+000116e0: 6e61 6c5f 696e 7075 743a 204f 7074 696f  nal_input: Optio
+000116f0: 6e61 6c5b 496e 7075 745d 203d 206e 6578  nal[Input] = nex
+00011700: 7428 696e 7075 745f 666f 725f 7472 6163  t(input_for_trac
+00011710: 696e 672c 204e 6f6e 6529 0a20 2020 2020  ing, None).     
+00011720: 2020 2066 696e 616c 5f69 6e70 7574 5f73     final_input_s
+00011730: 7570 706f 7274 6564 203d 2054 7275 650a  upported = True.
+00011740: 2020 2020 2020 2020 6669 6e61 6c5f 6f75          final_ou
+00011750: 7470 7574 3a20 4f70 7469 6f6e 616c 5b4f  tput: Optional[O
+00011760: 7574 7075 745d 203d 204e 6f6e 650a 2020  utput] = None.  
+00011770: 2020 2020 2020 6669 6e61 6c5f 6f75 7470        final_outp
+00011780: 7574 5f73 7570 706f 7274 6564 203d 2054  ut_supported = T
+00011790: 7275 650a 0a20 2020 2020 2020 2063 6f6e  rue..        con
+000117a0: 6669 6720 3d20 656e 7375 7265 5f63 6f6e  fig = ensure_con
+000117b0: 6669 6728 636f 6e66 6967 290a 2020 2020  fig(config).    
+000117c0: 2020 2020 6361 6c6c 6261 636b 5f6d 616e      callback_man
+000117d0: 6167 6572 203d 2067 6574 5f63 616c 6c62  ager = get_callb
+000117e0: 6163 6b5f 6d61 6e61 6765 725f 666f 725f  ack_manager_for_
+000117f0: 636f 6e66 6967 2863 6f6e 6669 6729 0a20  config(config). 
+00011800: 2020 2020 2020 2072 756e 5f6d 616e 6167         run_manag
+00011810: 6572 203d 2063 616c 6c62 6163 6b5f 6d61  er = callback_ma
+00011820: 6e61 6765 722e 6f6e 5f63 6861 696e 5f73  nager.on_chain_s
+00011830: 7461 7274 280a 2020 2020 2020 2020 2020  tart(.          
+00011840: 2020 6475 6d70 6428 7365 6c66 292c 0a20    dumpd(self),. 
+00011850: 2020 2020 2020 2020 2020 207b 2269 6e70             {"inp
+00011860: 7574 223a 2022 227d 2c0a 2020 2020 2020  ut": ""},.      
+00011870: 2020 2020 2020 7275 6e5f 7479 7065 3d72        run_type=r
+00011880: 756e 5f74 7970 652c 0a20 2020 2020 2020  un_type,.       
+00011890: 2020 2020 206e 616d 653d 636f 6e66 6967       name=config
+000118a0: 2e67 6574 2822 7275 6e5f 6e61 6d65 2229  .get("run_name")
+000118b0: 206f 7220 7365 6c66 2e67 6574 5f6e 616d   or self.get_nam
+000118c0: 6528 292c 0a20 2020 2020 2020 2020 2020  e(),.           
+000118d0: 2072 756e 5f69 643d 636f 6e66 6967 2e70   run_id=config.p
+000118e0: 6f70 2822 7275 6e5f 6964 222c 204e 6f6e  op("run_id", Non
+000118f0: 6529 2c0a 2020 2020 2020 2020 290a 2020  e),.        ).  
+00011900: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00011910: 2020 2020 2020 2063 6869 6c64 5f63 6f6e         child_con
+00011920: 6669 6720 3d20 7061 7463 685f 636f 6e66  fig = patch_conf
+00011930: 6967 2863 6f6e 6669 672c 2063 616c 6c62  ig(config, callb
+00011940: 6163 6b73 3d72 756e 5f6d 616e 6167 6572  acks=run_manager
+00011950: 2e67 6574 5f63 6869 6c64 2829 290a 2020  .get_child()).  
+00011960: 2020 2020 2020 2020 2020 6966 2061 6363            if acc
+00011970: 6570 7473 5f63 6f6e 6669 6728 7472 616e  epts_config(tran
+00011980: 7366 6f72 6d65 7229 3a0a 2020 2020 2020  sformer):.      
+00011990: 2020 2020 2020 2020 2020 6b77 6172 6773            kwargs
+000119a0: 5b22 636f 6e66 6967 225d 203d 2063 6869  ["config"] = chi
+000119b0: 6c64 5f63 6f6e 6669 670a 2020 2020 2020  ld_config.      
+000119c0: 2020 2020 2020 6966 2061 6363 6570 7473        if accepts
+000119d0: 5f72 756e 5f6d 616e 6167 6572 2874 7261  _run_manager(tra
+000119e0: 6e73 666f 726d 6572 293a 0a20 2020 2020  nsformer):.     
+000119f0: 2020 2020 2020 2020 2020 206b 7761 7267             kwarg
+00011a00: 735b 2272 756e 5f6d 616e 6167 6572 225d  s["run_manager"]
+00011a10: 203d 2072 756e 5f6d 616e 6167 6572 0a20   = run_manager. 
+00011a20: 2020 2020 2020 2020 2020 2063 6f6e 7465             conte
+00011a30: 7874 203d 2063 6f70 795f 636f 6e74 6578  xt = copy_contex
+00011a40: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+00011a50: 636f 6e74 6578 742e 7275 6e28 7661 725f  context.run(var_
+00011a60: 6368 696c 645f 7275 6e6e 6162 6c65 5f63  child_runnable_c
+00011a70: 6f6e 6669 672e 7365 742c 2063 6869 6c64  onfig.set, child
+00011a80: 5f63 6f6e 6669 6729 0a20 2020 2020 2020  _config).       
+00011a90: 2020 2020 2069 7465 7261 746f 7220 3d20       iterator = 
+00011aa0: 636f 6e74 6578 742e 7275 6e28 7472 616e  context.run(tran
+00011ab0: 7366 6f72 6d65 722c 2069 6e70 7574 5f66  sformer, input_f
+00011ac0: 6f72 5f74 7261 6e73 666f 726d 2c20 2a2a  or_transform, **
+00011ad0: 6b77 6172 6773 2920 2023 2074 7970 653a  kwargs)  # type:
+00011ae0: 2069 676e 6f72 655b 6172 672d 7479 7065   ignore[arg-type
+00011af0: 5d0a 2020 2020 2020 2020 2020 2020 7472  ].            tr
+00011b00: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00011b10: 2020 2077 6869 6c65 2054 7275 653a 0a20     while True:. 
+00011b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b30: 2020 2063 6875 6e6b 3a20 4f75 7470 7574     chunk: Output
+00011b40: 203d 2063 6f6e 7465 7874 2e72 756e 286e   = context.run(n
+00011b50: 6578 742c 2069 7465 7261 746f 7229 2020  ext, iterator)  
+00011b60: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
+00011b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b80: 2020 2079 6965 6c64 2063 6875 6e6b 0a20     yield chunk. 
+00011b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ba0: 2020 2069 6620 6669 6e61 6c5f 6f75 7470     if final_outp
+00011bb0: 7574 5f73 7570 706f 7274 6564 3a0a 2020  ut_supported:.  
+00011bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011bd0: 2020 2020 2020 6966 2066 696e 616c 5f6f        if final_o
+00011be0: 7574 7075 7420 6973 204e 6f6e 653a 0a20  utput is None:. 
+00011bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c00: 2020 2020 2020 2020 2020 2066 696e 616c             final
+00011c10: 5f6f 7574 7075 7420 3d20 6368 756e 6b0a  _output = chunk.
+00011c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c30: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00011c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c50: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00011c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c70: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00011c80: 696e 616c 5f6f 7574 7075 7420 3d20 6669  inal_output = fi
+00011c90: 6e61 6c5f 6f75 7470 7574 202b 2063 6875  nal_output + chu
+00011ca0: 6e6b 2020 2320 7479 7065 3a20 6967 6e6f  nk  # type: igno
+00011cb0: 7265 0a20 2020 2020 2020 2020 2020 2020  re.             
+00011cc0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00011cd0: 7863 6570 7420 5479 7065 4572 726f 723a  xcept TypeError:
+00011ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011d00: 2066 696e 616c 5f6f 7574 7075 7420 3d20   final_output = 
+00011d10: 6368 756e 6b0a 2020 2020 2020 2020 2020  chunk.          
+00011d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011d30: 2020 2020 2020 6669 6e61 6c5f 6f75 7470        final_outp
+00011d40: 7574 5f73 7570 706f 7274 6564 203d 2046  ut_supported = F
+00011d50: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
+00011d60: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00011d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011d80: 2020 2020 2020 2066 696e 616c 5f6f 7574         final_out
+00011d90: 7075 7420 3d20 6368 756e 6b0a 2020 2020  put = chunk.    
+00011da0: 2020 2020 2020 2020 6578 6365 7074 2053          except S
+00011db0: 746f 7049 7465 7261 7469 6f6e 3a0a 2020  topIteration:.  
+00011dc0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00011dd0: 7373 0a20 2020 2020 2020 2020 2020 2066  ss.            f
+00011de0: 6f72 2069 6368 756e 6b20 696e 2069 6e70  or ichunk in inp
+00011df0: 7574 5f66 6f72 5f74 7261 6369 6e67 3a0a  ut_for_tracing:.
+00011e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011e10: 6966 2066 696e 616c 5f69 6e70 7574 5f73  if final_input_s
+00011e20: 7570 706f 7274 6564 3a0a 2020 2020 2020  upported:.      
+00011e30: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00011e40: 2066 696e 616c 5f69 6e70 7574 2069 7320   final_input is 
+00011e50: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00011e60: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+00011e70: 6e61 6c5f 696e 7075 7420 3d20 6963 6875  nal_input = ichu
+00011e80: 6e6b 0a20 2020 2020 2020 2020 2020 2020  nk.             
+00011e90: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00011ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011eb0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00011ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ed0: 2020 2020 2020 6669 6e61 6c5f 696e 7075        final_inpu
+00011ee0: 7420 3d20 6669 6e61 6c5f 696e 7075 7420  t = final_input 
+00011ef0: 2b20 6963 6875 6e6b 2020 2320 7479 7065  + ichunk  # type
+00011f00: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
+00011f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f20: 2065 7863 6570 7420 5479 7065 4572 726f   except TypeErro
+00011f30: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+00011f40: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00011f50: 696e 616c 5f69 6e70 7574 203d 2069 6368  inal_input = ich
+00011f60: 756e 6b0a 2020 2020 2020 2020 2020 2020  unk.            
+00011f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f80: 6669 6e61 6c5f 696e 7075 745f 7375 7070  final_input_supp
+00011f90: 6f72 7465 6420 3d20 4661 6c73 650a 2020  orted = False.  
+00011fa0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00011fb0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00011fc0: 2020 2020 2020 2020 6669 6e61 6c5f 696e          final_in
+00011fd0: 7075 7420 3d20 6963 6875 6e6b 0a20 2020  put = ichunk.   
+00011fe0: 2020 2020 2065 7863 6570 7420 4261 7365       except Base
+00011ff0: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+00012000: 2020 2020 2020 2020 2020 2020 7275 6e5f              run_
+00012010: 6d61 6e61 6765 722e 6f6e 5f63 6861 696e  manager.on_chain
+00012020: 5f65 7272 6f72 2865 2c20 696e 7075 7473  _error(e, inputs
+00012030: 3d66 696e 616c 5f69 6e70 7574 290a 2020  =final_input).  
+00012040: 2020 2020 2020 2020 2020 7261 6973 650a            raise.
+00012050: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00012060: 2020 2020 2020 2020 2020 7275 6e5f 6d61            run_ma
+00012070: 6e61 6765 722e 6f6e 5f63 6861 696e 5f65  nager.on_chain_e
+00012080: 6e64 2866 696e 616c 5f6f 7574 7075 742c  nd(final_output,
+00012090: 2069 6e70 7574 733d 6669 6e61 6c5f 696e   inputs=final_in
+000120a0: 7075 7429 0a0a 2020 2020 6173 796e 6320  put)..    async 
+000120b0: 6465 6620 5f61 7472 616e 7366 6f72 6d5f  def _atransform_
+000120c0: 7374 7265 616d 5f77 6974 685f 636f 6e66  stream_with_conf
+000120d0: 6967 280a 2020 2020 2020 2020 7365 6c66  ig(.        self
+000120e0: 2c0a 2020 2020 2020 2020 696e 7075 743a  ,.        input:
+000120f0: 2041 7379 6e63 4974 6572 6174 6f72 5b49   AsyncIterator[I
+00012100: 6e70 7574 5d2c 0a20 2020 2020 2020 2074  nput],.        t
+00012110: 7261 6e73 666f 726d 6572 3a20 556e 696f  ransformer: Unio
+00012120: 6e5b 0a20 2020 2020 2020 2020 2020 2043  n[.            C
+00012130: 616c 6c61 626c 655b 5b41 7379 6e63 4974  allable[[AsyncIt
+00012140: 6572 6174 6f72 5b49 6e70 7574 5d5d 2c20  erator[Input]], 
+00012150: 4173 796e 6349 7465 7261 746f 725b 4f75  AsyncIterator[Ou
+00012160: 7470 7574 5d5d 2c0a 2020 2020 2020 2020  tput]],.        
+00012170: 2020 2020 4361 6c6c 6162 6c65 5b0a 2020      Callable[.  
+00012180: 2020 2020 2020 2020 2020 2020 2020 5b41                [A
+00012190: 7379 6e63 4974 6572 6174 6f72 5b49 6e70  syncIterator[Inp
+000121a0: 7574 5d2c 2041 7379 6e63 4361 6c6c 6261  ut], AsyncCallba
+000121b0: 636b 4d61 6e61 6765 7246 6f72 4368 6169  ckManagerForChai
+000121c0: 6e52 756e 5d2c 0a20 2020 2020 2020 2020  nRun],.         
+000121d0: 2020 2020 2020 2041 7379 6e63 4974 6572         AsyncIter
+000121e0: 6174 6f72 5b4f 7574 7075 745d 2c0a 2020  ator[Output],.  
+000121f0: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
+00012200: 2020 2020 2020 2020 2043 616c 6c61 626c           Callabl
+00012210: 655b 0a20 2020 2020 2020 2020 2020 2020  e[.             
+00012220: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00012230: 2020 2020 2020 2020 2041 7379 6e63 4974           AsyncIt
+00012240: 6572 6174 6f72 5b49 6e70 7574 5d2c 0a20  erator[Input],. 
+00012250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012260: 2020 2041 7379 6e63 4361 6c6c 6261 636b     AsyncCallback
+00012270: 4d61 6e61 6765 7246 6f72 4368 6169 6e52  ManagerForChainR
+00012280: 756e 2c0a 2020 2020 2020 2020 2020 2020  un,.            
+00012290: 2020 2020 2020 2020 5275 6e6e 6162 6c65          Runnable
+000122a0: 436f 6e66 6967 2c0a 2020 2020 2020 2020  Config,.        
+000122b0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+000122c0: 2020 2020 2020 2020 2020 2041 7379 6e63             Async
+000122d0: 4974 6572 6174 6f72 5b4f 7574 7075 745d  Iterator[Output]
+000122e0: 2c0a 2020 2020 2020 2020 2020 2020 5d2c  ,.            ],
+000122f0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00012300: 2020 2020 636f 6e66 6967 3a20 4f70 7469      config: Opti
+00012310: 6f6e 616c 5b52 756e 6e61 626c 6543 6f6e  onal[RunnableCon
+00012320: 6669 675d 2c0a 2020 2020 2020 2020 7275  fig],.        ru
+00012330: 6e5f 7479 7065 3a20 4f70 7469 6f6e 616c  n_type: Optional
+00012340: 5b73 7472 5d20 3d20 4e6f 6e65 2c0a 2020  [str] = None,.  
+00012350: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
+00012360: 4f70 7469 6f6e 616c 5b41 6e79 5d2c 0a20  Optional[Any],. 
+00012370: 2020 2029 202d 3e20 4173 796e 6349 7465     ) -> AsyncIte
+00012380: 7261 746f 725b 4f75 7470 7574 5d3a 0a20  rator[Output]:. 
+00012390: 2020 2020 2020 2022 2222 4865 6c70 6572         """Helper
+000123a0: 206d 6574 686f 6420 746f 2074 7261 6e73   method to trans
+000123b0: 666f 726d 2061 6e20 4173 796e 6320 4974  form an Async It
+000123c0: 6572 6174 6f72 206f 6620 496e 7075 7420  erator of Input 
+000123d0: 7661 6c75 6573 2069 6e74 6f20 616e 2041  values into an A
+000123e0: 7379 6e63 0a20 2020 2020 2020 2049 7465  sync.        Ite
+000123f0: 7261 746f 7220 6f66 204f 7574 7075 7420  rator of Output 
+00012400: 7661 6c75 6573 2c20 7769 7468 2063 616c  values, with cal
+00012410: 6c62 6163 6b73 2e0a 2020 2020 2020 2020  lbacks..        
+00012420: 5573 6520 7468 6973 2074 6f20 696d 706c  Use this to impl
+00012430: 656d 656e 7420 6061 7374 7265 616d 2829  ement `astream()
+00012440: 6020 6f72 2060 6174 7261 6e73 666f 726d  ` or `atransform
+00012450: 2829 6020 696e 2052 756e 6e61 626c 6520  ()` in Runnable 
+00012460: 7375 6263 6c61 7373 6573 2e22 2222 0a20  subclasses.""". 
+00012470: 2020 2020 2020 2066 726f 6d20 6c61 6e67         from lang
+00012480: 6368 6169 6e5f 636f 7265 2e74 7261 6365  chain_core.trace
+00012490: 7273 2e6c 6f67 5f73 7472 6561 6d20 696d  rs.log_stream im
+000124a0: 706f 7274 204c 6f67 5374 7265 616d 4361  port LogStreamCa
+000124b0: 6c6c 6261 636b 4861 6e64 6c65 720a 0a20  llbackHandler.. 
+000124c0: 2020 2020 2020 2023 2074 6565 2074 6865         # tee the
+000124d0: 2069 6e70 7574 2073 6f20 7765 2063 616e   input so we can
+000124e0: 2069 7465 7261 7465 206f 7665 7220 6974   iterate over it
+000124f0: 2074 7769 6365 0a20 2020 2020 2020 2069   twice.        i
+00012500: 6e70 7574 5f66 6f72 5f74 7261 6369 6e67  nput_for_tracing
+00012510: 2c20 696e 7075 745f 666f 725f 7472 616e  , input_for_tran
+00012520: 7366 6f72 6d20 3d20 6174 6565 2869 6e70  sform = atee(inp
+00012530: 7574 2c20 3229 0a20 2020 2020 2020 2023  ut, 2).        #
+00012540: 2053 7461 7274 2074 6865 2069 6e70 7574   Start the input
+00012550: 2069 7465 7261 746f 7220 746f 2065 6e73   iterator to ens
+00012560: 7572 6520 7468 6520 696e 7075 7420 7275  ure the input ru
+00012570: 6e6e 6162 6c65 2073 7461 7274 7320 6265  nnable starts be
+00012580: 666f 7265 2074 6869 7320 6f6e 650a 2020  fore this one.  
+00012590: 2020 2020 2020 6669 6e61 6c5f 696e 7075        final_inpu
+000125a0: 743a 204f 7074 696f 6e61 6c5b 496e 7075  t: Optional[Inpu
+000125b0: 745d 203d 2061 7761 6974 2070 795f 616e  t] = await py_an
+000125c0: 6578 7428 696e 7075 745f 666f 725f 7472  ext(input_for_tr
+000125d0: 6163 696e 672c 204e 6f6e 6529 0a20 2020  acing, None).   
+000125e0: 2020 2020 2066 696e 616c 5f69 6e70 7574       final_input
+000125f0: 5f73 7570 706f 7274 6564 203d 2054 7275  _supported = Tru
+00012600: 650a 2020 2020 2020 2020 6669 6e61 6c5f  e.        final_
+00012610: 6f75 7470 7574 3a20 4f70 7469 6f6e 616c  output: Optional
+00012620: 5b4f 7574 7075 745d 203d 204e 6f6e 650a  [Output] = None.
+00012630: 2020 2020 2020 2020 6669 6e61 6c5f 6f75          final_ou
+00012640: 7470 7574 5f73 7570 706f 7274 6564 203d  tput_supported =
+00012650: 2054 7275 650a 0a20 2020 2020 2020 2063   True..        c
+00012660: 6f6e 6669 6720 3d20 656e 7375 7265 5f63  onfig = ensure_c
+00012670: 6f6e 6669 6728 636f 6e66 6967 290a 2020  onfig(config).  
+00012680: 2020 2020 2020 6361 6c6c 6261 636b 5f6d        callback_m
+00012690: 616e 6167 6572 203d 2067 6574 5f61 7379  anager = get_asy
+000126a0: 6e63 5f63 616c 6c62 6163 6b5f 6d61 6e61  nc_callback_mana
+000126b0: 6765 725f 666f 725f 636f 6e66 6967 2863  ger_for_config(c
+000126c0: 6f6e 6669 6729 0a20 2020 2020 2020 2072  onfig).        r
+000126d0: 756e 5f6d 616e 6167 6572 203d 2061 7761  un_manager = awa
+000126e0: 6974 2063 616c 6c62 6163 6b5f 6d61 6e61  it callback_mana
+000126f0: 6765 722e 6f6e 5f63 6861 696e 5f73 7461  ger.on_chain_sta
+00012700: 7274 280a 2020 2020 2020 2020 2020 2020  rt(.            
+00012710: 6475 6d70 6428 7365 6c66 292c 0a20 2020  dumpd(self),.   
+00012720: 2020 2020 2020 2020 207b 2269 6e70 7574           {"input
+00012730: 223a 2022 227d 2c0a 2020 2020 2020 2020  ": ""},.        
+00012740: 2020 2020 7275 6e5f 7479 7065 3d72 756e      run_type=run
+00012750: 5f74 7970 652c 0a20 2020 2020 2020 2020  _type,.         
+00012760: 2020 206e 616d 653d 636f 6e66 6967 2e67     name=config.g
+00012770: 6574 2822 7275 6e5f 6e61 6d65 2229 206f  et("run_name") o
+00012780: 7220 7365 6c66 2e67 6574 5f6e 616d 6528  r self.get_name(
+00012790: 292c 0a20 2020 2020 2020 2020 2020 2072  ),.            r
+000127a0: 756e 5f69 643d 636f 6e66 6967 2e70 6f70  un_id=config.pop
+000127b0: 2822 7275 6e5f 6964 222c 204e 6f6e 6529  ("run_id", None)
+000127c0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+000127d0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+000127e0: 2020 2020 2063 6869 6c64 5f63 6f6e 6669       child_confi
+000127f0: 6720 3d20 7061 7463 685f 636f 6e66 6967  g = patch_config
+00012800: 2863 6f6e 6669 672c 2063 616c 6c62 6163  (config, callbac
+00012810: 6b73 3d72 756e 5f6d 616e 6167 6572 2e67  ks=run_manager.g
+00012820: 6574 5f63 6869 6c64 2829 290a 2020 2020  et_child()).    
+00012830: 2020 2020 2020 2020 6966 2061 6363 6570          if accep
+00012840: 7473 5f63 6f6e 6669 6728 7472 616e 7366  ts_config(transf
+00012850: 6f72 6d65 7229 3a0a 2020 2020 2020 2020  ormer):.        
+00012860: 2020 2020 2020 2020 6b77 6172 6773 5b22          kwargs["
+00012870: 636f 6e66 6967 225d 203d 2063 6869 6c64  config"] = child
+00012880: 5f63 6f6e 6669 670a 2020 2020 2020 2020  _config.        
+00012890: 2020 2020 6966 2061 6363 6570 7473 5f72      if accepts_r
+000128a0: 756e 5f6d 616e 6167 6572 2874 7261 6e73  un_manager(trans
+000128b0: 666f 726d 6572 293a 0a20 2020 2020 2020  former):.       
+000128c0: 2020 2020 2020 2020 206b 7761 7267 735b           kwargs[
+000128d0: 2272 756e 5f6d 616e 6167 6572 225d 203d  "run_manager"] =
+000128e0: 2072 756e 5f6d 616e 6167 6572 0a20 2020   run_manager.   
+000128f0: 2020 2020 2020 2020 2063 6f6e 7465 7874           context
+00012900: 203d 2063 6f70 795f 636f 6e74 6578 7428   = copy_context(
+00012910: 290a 2020 2020 2020 2020 2020 2020 636f  ).            co
+00012920: 6e74 6578 742e 7275 6e28 7661 725f 6368  ntext.run(var_ch
+00012930: 696c 645f 7275 6e6e 6162 6c65 5f63 6f6e  ild_runnable_con
+00012940: 6669 672e 7365 742c 2063 6869 6c64 5f63  fig.set, child_c
+00012950: 6f6e 6669 6729 0a20 2020 2020 2020 2020  onfig).         
+00012960: 2020 2069 7465 7261 746f 7220 3d20 636f     iterator = co
+00012970: 6e74 6578 742e 7275 6e28 7472 616e 7366  ntext.run(transf
+00012980: 6f72 6d65 722c 2069 6e70 7574 5f66 6f72  ormer, input_for
+00012990: 5f74 7261 6e73 666f 726d 2c20 2a2a 6b77  _transform, **kw
+000129a0: 6172 6773 2920 2023 2074 7970 653a 2069  args)  # type: i
+000129b0: 676e 6f72 655b 6172 672d 7479 7065 5d0a  gnore[arg-type].
+000129c0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+000129d0: 7472 6561 6d5f 6c6f 6720 3a3d 206e 6578  tream_log := nex
+000129e0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+000129f0: 2020 2028 0a20 2020 2020 2020 2020 2020     (.           
+00012a00: 2020 2020 2020 2020 2068 0a20 2020 2020           h.     
+00012a10: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00012a20: 6f72 2068 2069 6e20 7275 6e5f 6d61 6e61  or h in run_mana
+00012a30: 6765 722e 6861 6e64 6c65 7273 0a20 2020  ger.handlers.   
+00012a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a50: 2069 6620 6973 696e 7374 616e 6365 2868   if isinstance(h
+00012a60: 2c20 4c6f 6753 7472 6561 6d43 616c 6c62  , LogStreamCallb
+00012a70: 6163 6b48 616e 646c 6572 290a 2020 2020  ackHandler).    
+00012a80: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
+00012a90: 2020 2020 2020 2020 2020 2020 2020 204e                 N
+00012aa0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00012ab0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+00012ac0: 2020 2020 2320 706f 7075 6c61 7465 7320      # populates 
+00012ad0: 7374 7265 616d 6564 5f6f 7574 7075 7420  streamed_output 
+00012ae0: 696e 2061 7374 7265 616d 5f6c 6f67 2829  in astream_log()
+00012af0: 206f 7574 7075 7420 6966 206e 6565 6465   output if neede
+00012b00: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00012b10: 2020 6974 6572 6174 6f72 203d 2073 7472    iterator = str
+00012b20: 6561 6d5f 6c6f 672e 7461 705f 6f75 7470  eam_log.tap_outp
+00012b30: 7574 5f61 6974 6572 2872 756e 5f6d 616e  ut_aiter(run_man
+00012b40: 6167 6572 2e72 756e 5f69 642c 2069 7465  ager.run_id, ite
+00012b50: 7261 746f 7229 0a20 2020 2020 2020 2020  rator).         
+00012b60: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00012b70: 2020 2020 2020 2020 7768 696c 6520 5472          while Tr
+00012b80: 7565 3a0a 2020 2020 2020 2020 2020 2020  ue:.            
+00012b90: 2020 2020 2020 2020 6966 2061 6363 6570          if accep
+00012ba0: 7473 5f63 6f6e 7465 7874 2861 7379 6e63  ts_context(async
+00012bb0: 696f 2e63 7265 6174 655f 7461 736b 293a  io.create_task):
+00012bc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012bd0: 2020 2020 2020 2020 2063 6875 6e6b 3a20           chunk: 
+00012be0: 4f75 7470 7574 203d 2061 7761 6974 2061  Output = await a
+00012bf0: 7379 6e63 696f 2e63 7265 6174 655f 7461  syncio.create_ta
+00012c00: 736b 2820 2023 2074 7970 653a 2069 676e  sk(  # type: ign
+00012c10: 6f72 655b 6361 6c6c 2d61 7267 5d0a 2020  ore[call-arg].  
+00012c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012c30: 2020 2020 2020 2020 2020 7079 5f61 6e65            py_ane
+00012c40: 7874 2869 7465 7261 746f 7229 2c20 2023  xt(iterator),  #
+00012c50: 2074 7970 653a 2069 676e 6f72 655b 6172   type: ignore[ar
+00012c60: 672d 7479 7065 5d0a 2020 2020 2020 2020  g-type].        
+00012c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012c80: 2020 2020 636f 6e74 6578 743d 636f 6e74      context=cont
+00012c90: 6578 742c 0a20 2020 2020 2020 2020 2020  ext,.           
+00012ca0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00012cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012cc0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00012cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ce0: 2063 6875 6e6b 203d 2063 6173 7428 4f75   chunk = cast(Ou
+00012cf0: 7470 7574 2c20 6177 6169 7420 7079 5f61  tput, await py_a
+00012d00: 6e65 7874 2869 7465 7261 746f 7229 290a  next(iterator)).
+00012d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012d20: 2020 2020 7969 656c 6420 6368 756e 6b0a      yield chunk.
+00012d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012d40: 2020 2020 6966 2066 696e 616c 5f6f 7574      if final_out
+00012d50: 7075 745f 7375 7070 6f72 7465 643a 0a20  put_supported:. 
+00012d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012d70: 2020 2020 2020 2069 6620 6669 6e61 6c5f         if final_
+00012d80: 6f75 7470 7574 2069 7320 4e6f 6e65 3a0a  output is None:.
+00012d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012da0: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
+00012db0: 6c5f 6f75 7470 7574 203d 2063 6875 6e6b  l_output = chunk
+00012dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012dd0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00012de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012df0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00012e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012e20: 6669 6e61 6c5f 6f75 7470 7574 203d 2066  final_output = f
+00012e30: 696e 616c 5f6f 7574 7075 7420 2b20 6368  inal_output + ch
+00012e40: 756e 6b20 2023 2074 7970 653a 2069 676e  unk  # type: ign
+00012e50: 6f72 650a 2020 2020 2020 2020 2020 2020  ore.            
+00012e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012e70: 6578 6365 7074 2054 7970 6545 7272 6f72  except TypeError
+00012e80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ea0: 2020 6669 6e61 6c5f 6f75 7470 7574 203d    final_output =
+00012eb0: 2063 6875 6e6b 0a20 2020 2020 2020 2020   chunk.         
+00012ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ed0: 2020 2020 2020 2066 696e 616c 5f6f 7574         final_out
+00012ee0: 7075 745f 7375 7070 6f72 7465 6420 3d20  put_supported = 
+00012ef0: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+00012f00: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00012f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f20: 2020 2020 2020 2020 6669 6e61 6c5f 6f75          final_ou
+00012f30: 7470 7574 203d 2063 6875 6e6b 0a20 2020  tput = chunk.   
+00012f40: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00012f50: 5374 6f70 4173 796e 6349 7465 7261 7469  StopAsyncIterati
+00012f60: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
+00012f70: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
+00012f80: 2020 2020 2061 7379 6e63 2066 6f72 2069       async for i
+00012f90: 6368 756e 6b20 696e 2069 6e70 7574 5f66  chunk in input_f
+00012fa0: 6f72 5f74 7261 6369 6e67 3a0a 2020 2020  or_tracing:.    
+00012fb0: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+00012fc0: 696e 616c 5f69 6e70 7574 5f73 7570 706f  inal_input_suppo
+00012fd0: 7274 6564 3a0a 2020 2020 2020 2020 2020  rted:.          
+00012fe0: 2020 2020 2020 2020 2020 6966 2066 696e            if fin
+00012ff0: 616c 5f69 6e70 7574 2069 7320 4e6f 6e65  al_input is None
+00013000: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00013010: 2020 2020 2020 2020 2020 6669 6e61 6c5f            final_
+00013020: 696e 7075 7420 3d20 6963 6875 6e6b 0a20  input = ichunk. 
+00013030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013040: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00013050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013060: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00013070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013080: 2020 6669 6e61 6c5f 696e 7075 7420 3d20    final_input = 
+00013090: 6669 6e61 6c5f 696e 7075 7420 2b20 6963  final_input + ic
+000130a0: 6875 6e6b 2020 2320 7479 7065 3a20 6967  hunk  # type: ig
+000130b0: 6e6f 7265 5b6f 7065 7261 746f 725d 0a20  nore[operator]. 
+000130c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000130d0: 2020 2020 2020 2065 7863 6570 7420 5479         except Ty
+000130e0: 7065 4572 726f 723a 0a20 2020 2020 2020  peError:.       
+000130f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013100: 2020 2020 2066 696e 616c 5f69 6e70 7574       final_input
+00013110: 203d 2069 6368 756e 6b0a 2020 2020 2020   = ichunk.      
+00013120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013130: 2020 2020 2020 6669 6e61 6c5f 696e 7075        final_inpu
+00013140: 745f 7375 7070 6f72 7465 6420 3d20 4661  t_supported = Fa
+00013150: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+00013160: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00013170: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+00013180: 6e61 6c5f 696e 7075 7420 3d20 6963 6875  nal_input = ichu
+00013190: 6e6b 0a20 2020 2020 2020 2065 7863 6570  nk.        excep
+000131a0: 7420 4261 7365 4578 6365 7074 696f 6e20  t BaseException 
+000131b0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+000131c0: 2020 6177 6169 7420 7275 6e5f 6d61 6e61    await run_mana
+000131d0: 6765 722e 6f6e 5f63 6861 696e 5f65 7272  ger.on_chain_err
+000131e0: 6f72 2865 2c20 696e 7075 7473 3d66 696e  or(e, inputs=fin
+000131f0: 616c 5f69 6e70 7574 290a 2020 2020 2020  al_input).      
+00013200: 2020 2020 2020 7261 6973 650a 2020 2020        raise.    
+00013210: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00013220: 2020 2020 2020 6177 6169 7420 7275 6e5f        await run_
+00013230: 6d61 6e61 6765 722e 6f6e 5f63 6861 696e  manager.on_chain
+00013240: 5f65 6e64 2866 696e 616c 5f6f 7574 7075  _end(final_outpu
+00013250: 742c 2069 6e70 7574 733d 6669 6e61 6c5f  t, inputs=final_
+00013260: 696e 7075 7429 0a0a 0a63 6c61 7373 2052  input)...class R
+00013270: 756e 6e61 626c 6553 6572 6961 6c69 7a61  unnableSerializa
+00013280: 626c 6528 5365 7269 616c 697a 6162 6c65  ble(Serializable
+00013290: 2c20 5275 6e6e 6162 6c65 5b49 6e70 7574  , Runnable[Input
+000132a0: 2c20 4f75 7470 7574 5d29 3a0a 2020 2020  , Output]):.    
+000132b0: 2222 2252 756e 6e61 626c 6520 7468 6174  """Runnable that
+000132c0: 2063 616e 2062 6520 7365 7269 616c 697a   can be serializ
+000132d0: 6564 2074 6f20 4a53 4f4e 2e22 2222 0a0a  ed to JSON."""..
+000132e0: 2020 2020 6e61 6d65 3a20 4f70 7469 6f6e      name: Option
+000132f0: 616c 5b73 7472 5d20 3d20 4e6f 6e65 0a20  al[str] = None. 
+00013300: 2020 2022 2222 5468 6520 6e61 6d65 206f     """The name o
+00013310: 6620 7468 6520 7275 6e6e 6162 6c65 2e20  f the runnable. 
+00013320: 5573 6564 2066 6f72 2064 6562 7567 6769  Used for debuggi
+00013330: 6e67 2061 6e64 2074 7261 6369 6e67 2e22  ng and tracing."
+00013340: 2222 0a0a 2020 2020 6465 6620 746f 5f6a  ""..    def to_j
+00013350: 736f 6e28 7365 6c66 2920 2d3e 2055 6e69  son(self) -> Uni
+00013360: 6f6e 5b53 6572 6961 6c69 7a65 6443 6f6e  on[SerializedCon
+00013370: 7374 7275 6374 6f72 2c20 5365 7269 616c  structor, Serial
+00013380: 697a 6564 4e6f 7449 6d70 6c65 6d65 6e74  izedNotImplement
+00013390: 6564 5d3a 0a20 2020 2020 2020 2022 2222  ed]:.        """
+000133a0: 5365 7269 616c 697a 6520 7468 6520 7275  Serialize the ru
+000133b0: 6e6e 6162 6c65 2074 6f20 4a53 4f4e 2e22  nnable to JSON."
+000133c0: 2222 0a20 2020 2020 2020 2064 756d 7065  "".        dumpe
+000133d0: 6420 3d20 7375 7065 7228 292e 746f 5f6a  d = super().to_j
+000133e0: 736f 6e28 290a 2020 2020 2020 2020 7472  son().        tr
+000133f0: 793a 0a20 2020 2020 2020 2020 2020 2064  y:.            d
+00013400: 756d 7065 645b 226e 616d 6522 5d20 3d20  umped["name"] = 
+00013410: 7365 6c66 2e67 6574 5f6e 616d 6528 290a  self.get_name().
+00013420: 2020 2020 2020 2020 2020 2020 6475 6d70              dump
+00013430: 6564 5b22 6772 6170 6822 5d20 3d20 7365  ed["graph"] = se
+00013440: 6c66 2e67 6574 5f67 7261 7068 2829 2e74  lf.get_graph().t
+00013450: 6f5f 6a73 6f6e 2829 0a20 2020 2020 2020  o_json().       
+00013460: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+00013470: 6e3a 0a20 2020 2020 2020 2020 2020 2070  n:.            p
+00013480: 6173 730a 2020 2020 2020 2020 7265 7475  ass.        retu
+00013490: 726e 2064 756d 7065 640a 0a20 2020 2064  rn dumped..    d
+000134a0: 6566 2063 6f6e 6669 6775 7261 626c 655f  ef configurable_
+000134b0: 6669 656c 6473 280a 2020 2020 2020 2020  fields(.        
+000134c0: 7365 6c66 2c20 2a2a 6b77 6172 6773 3a20  self, **kwargs: 
+000134d0: 416e 7943 6f6e 6669 6775 7261 626c 6546  AnyConfigurableF
+000134e0: 6965 6c64 0a20 2020 2029 202d 3e20 5275  ield.    ) -> Ru
+000134f0: 6e6e 6162 6c65 5365 7269 616c 697a 6162  nnableSerializab
+00013500: 6c65 5b49 6e70 7574 2c20 4f75 7470 7574  le[Input, Output
+00013510: 5d3a 0a20 2020 2020 2020 2022 2222 436f  ]:.        """Co
+00013520: 6e66 6967 7572 6520 7061 7274 6963 756c  nfigure particul
+00013530: 6172 2072 756e 6e61 626c 6520 6669 656c  ar runnable fiel
+00013540: 6473 2061 7420 7275 6e74 696d 652e 0a0a  ds at runtime...
+00013550: 2020 2020 2020 2020 2e2e 2063 6f64 652d          .. code-
+00013560: 626c 6f63 6b3a 3a20 7079 7468 6f6e 0a0a  block:: python..
+00013570: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
+00013580: 206c 616e 6763 6861 696e 5f63 6f72 652e   langchain_core.
+00013590: 7275 6e6e 6162 6c65 7320 696d 706f 7274  runnables import
+000135a0: 2043 6f6e 6669 6775 7261 626c 6546 6965   ConfigurableFie
+000135b0: 6c64 0a20 2020 2020 2020 2020 2020 2066  ld.            f
+000135c0: 726f 6d20 6c61 6e67 6368 6169 6e5f 6f70  rom langchain_op
+000135d0: 656e 6169 2069 6d70 6f72 7420 4368 6174  enai import Chat
+000135e0: 4f70 656e 4149 0a0a 2020 2020 2020 2020  OpenAI..        
+000135f0: 2020 2020 6d6f 6465 6c20 3d20 4368 6174      model = Chat
+00013600: 4f70 656e 4149 286d 6178 5f74 6f6b 656e  OpenAI(max_token
+00013610: 733d 3230 292e 636f 6e66 6967 7572 6162  s=20).configurab
+00013620: 6c65 5f66 6965 6c64 7328 0a20 2020 2020  le_fields(.     
+00013630: 2020 2020 2020 2020 2020 206d 6178 5f74             max_t
+00013640: 6f6b 656e 733d 436f 6e66 6967 7572 6162  okens=Configurab
+00013650: 6c65 4669 656c 6428 0a20 2020 2020 2020  leField(.       
+00013660: 2020 2020 2020 2020 2020 2020 2069 643d               id=
+00013670: 226f 7574 7075 745f 746f 6b65 6e5f 6e75  "output_token_nu
+00013680: 6d62 6572 222c 0a20 2020 2020 2020 2020  mber",.         
+00013690: 2020 2020 2020 2020 2020 206e 616d 653d             name=
+000136a0: 224d 6178 2074 6f6b 656e 7320 696e 2074  "Max tokens in t
+000136b0: 6865 206f 7574 7075 7422 2c0a 2020 2020  he output",.    
+000136c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000136d0: 6465 7363 7269 7074 696f 6e3d 2254 6865  description="The
+000136e0: 206d 6178 696d 756d 206e 756d 6265 7220   maximum number 
+000136f0: 6f66 2074 6f6b 656e 7320 696e 2074 6865  of tokens in the
+00013700: 206f 7574 7075 7422 2c0a 2020 2020 2020   output",.      
+00013710: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00013720: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00013730: 2020 2020 2020 2023 206d 6178 5f74 6f6b         # max_tok
+00013740: 656e 7320 3d20 3230 0a20 2020 2020 2020  ens = 20.       
+00013750: 2020 2020 2070 7269 6e74 280a 2020 2020       print(.    
+00013760: 2020 2020 2020 2020 2020 2020 226d 6178              "max
+00013770: 5f74 6f6b 656e 735f 3230 3a20 222c 0a20  _tokens_20: ",. 
+00013780: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00013790: 6f64 656c 2e69 6e76 6f6b 6528 2274 656c  odel.invoke("tel
+000137a0: 6c20 6d65 2073 6f6d 6574 6869 6e67 2061  l me something a
+000137b0: 626f 7574 2063 6865 7373 2229 2e63 6f6e  bout chess").con
+000137c0: 7465 6e74 0a20 2020 2020 2020 2020 2020  tent.           
+000137d0: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+000137e0: 2320 6d61 785f 746f 6b65 6e73 203d 2032  # max_tokens = 2
+000137f0: 3030 0a20 2020 2020 2020 2020 2020 2070  00.            p
+00013800: 7269 6e74 2822 6d61 785f 746f 6b65 6e73  rint("max_tokens
+00013810: 5f32 3030 3a20 222c 206d 6f64 656c 2e77  _200: ", model.w
+00013820: 6974 685f 636f 6e66 6967 280a 2020 2020  ith_config(.    
+00013830: 2020 2020 2020 2020 2020 2020 636f 6e66              conf
+00013840: 6967 7572 6162 6c65 3d7b 226f 7574 7075  igurable={"outpu
+00013850: 745f 746f 6b65 6e5f 6e75 6d62 6572 223a  t_token_number":
+00013860: 2032 3030 7d0a 2020 2020 2020 2020 2020   200}.          
+00013870: 2020 2020 2020 292e 696e 766f 6b65 2822        ).invoke("
+00013880: 7465 6c6c 206d 6520 736f 6d65 7468 696e  tell me somethin
+00013890: 6720 6162 6f75 7420 6368 6573 7322 292e  g about chess").
+000138a0: 636f 6e74 656e 740a 2020 2020 2020 2020  content.        
+000138b0: 2020 2020 290a 2020 2020 2020 2020 2222      ).        ""
+000138c0: 220a 2020 2020 2020 2020 6672 6f6d 206c  ".        from l
+000138d0: 616e 6763 6861 696e 5f63 6f72 652e 7275  angchain_core.ru
+000138e0: 6e6e 6162 6c65 732e 636f 6e66 6967 7572  nnables.configur
+000138f0: 6162 6c65 2069 6d70 6f72 7420 5275 6e6e  able import Runn
+00013900: 6162 6c65 436f 6e66 6967 7572 6162 6c65  ableConfigurable
+00013910: 4669 656c 6473 0a0a 2020 2020 2020 2020  Fields..        
+00013920: 666f 7220 6b65 7920 696e 206b 7761 7267  for key in kwarg
+00013930: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
+00013940: 6620 6b65 7920 6e6f 7420 696e 2073 656c  f key not in sel
+00013950: 662e 5f5f 6669 656c 6473 5f5f 3a0a 2020  f.__fields__:.  
+00013960: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00013970: 6973 6520 5661 6c75 6545 7272 6f72 280a  ise ValueError(.
+00013980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013990: 2020 2020 6622 436f 6e66 6967 7572 6174      f"Configurat
+000139a0: 696f 6e20 6b65 7920 7b6b 6579 7d20 6e6f  ion key {key} no
+000139b0: 7420 666f 756e 6420 696e 207b 7365 6c66  t found in {self
+000139c0: 7d3a 2022 0a20 2020 2020 2020 2020 2020  }: ".           
+000139d0: 2020 2020 2020 2020 2066 2261 7661 696c           f"avail
+000139e0: 6162 6c65 206b 6579 7320 6172 6520 7b73  able keys are {s
+000139f0: 656c 662e 5f5f 6669 656c 6473 5f5f 2e6b  elf.__fields__.k
+00013a00: 6579 7328 297d 220a 2020 2020 2020 2020  eys()}".        
+00013a10: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00013a20: 2020 2072 6574 7572 6e20 5275 6e6e 6162     return Runnab
+00013a30: 6c65 436f 6e66 6967 7572 6162 6c65 4669  leConfigurableFi
+00013a40: 656c 6473 2864 6566 6175 6c74 3d73 656c  elds(default=sel
+00013a50: 662c 2066 6965 6c64 733d 6b77 6172 6773  f, fields=kwargs
+00013a60: 290a 0a20 2020 2064 6566 2063 6f6e 6669  )..    def confi
+00013a70: 6775 7261 626c 655f 616c 7465 726e 6174  gurable_alternat
+00013a80: 6976 6573 280a 2020 2020 2020 2020 7365  ives(.        se
+00013a90: 6c66 2c0a 2020 2020 2020 2020 7768 6963  lf,.        whic
+00013aa0: 683a 2043 6f6e 6669 6775 7261 626c 6546  h: ConfigurableF
+00013ab0: 6965 6c64 2c0a 2020 2020 2020 2020 2a2c  ield,.        *,
+00013ac0: 0a20 2020 2020 2020 2064 6566 6175 6c74  .        default
+00013ad0: 5f6b 6579 3a20 7374 7220 3d20 2264 6566  _key: str = "def
+00013ae0: 6175 6c74 222c 0a20 2020 2020 2020 2070  ault",.        p
+00013af0: 7265 6669 785f 6b65 7973 3a20 626f 6f6c  refix_keys: bool
+00013b00: 203d 2046 616c 7365 2c0a 2020 2020 2020   = False,.      
+00013b10: 2020 2a2a 6b77 6172 6773 3a20 556e 696f    **kwargs: Unio
+00013b20: 6e5b 5275 6e6e 6162 6c65 5b49 6e70 7574  n[Runnable[Input
+00013b30: 2c20 4f75 7470 7574 5d2c 2043 616c 6c61  , Output], Calla
+00013b40: 626c 655b 5b5d 2c20 5275 6e6e 6162 6c65  ble[[], Runnable
+00013b50: 5b49 6e70 7574 2c20 4f75 7470 7574 5d5d  [Input, Output]]
+00013b60: 5d2c 0a20 2020 2029 202d 3e20 5275 6e6e  ],.    ) -> Runn
+00013b70: 6162 6c65 5365 7269 616c 697a 6162 6c65  ableSerializable
+00013b80: 5b49 6e70 7574 2c20 4f75 7470 7574 5d3a  [Input, Output]:
+00013b90: 0a20 2020 2020 2020 2022 2222 436f 6e66  .        """Conf
+00013ba0: 6967 7572 6520 616c 7465 726e 6174 6976  igure alternativ
+00013bb0: 6573 2066 6f72 2072 756e 6e61 626c 6573  es for runnables
+00013bc0: 2074 6861 7420 6361 6e20 6265 2073 6574   that can be set
+00013bd0: 2061 7420 7275 6e74 696d 652e 0a0a 2020   at runtime...  
+00013be0: 2020 2020 2020 2e2e 2063 6f64 652d 626c        .. code-bl
+00013bf0: 6f63 6b3a 3a20 7079 7468 6f6e 0a0a 2020  ock:: python..  
+00013c00: 2020 2020 2020 2020 2020 6672 6f6d 206c            from l
+00013c10: 616e 6763 6861 696e 5f61 6e74 6872 6f70  angchain_anthrop
+00013c20: 6963 2069 6d70 6f72 7420 4368 6174 416e  ic import ChatAn
+00013c30: 7468 726f 7069 630a 2020 2020 2020 2020  thropic.        
+00013c40: 2020 2020 6672 6f6d 206c 616e 6763 6861      from langcha
+00013c50: 696e 5f63 6f72 652e 7275 6e6e 6162 6c65  in_core.runnable
+00013c60: 732e 7574 696c 7320 696d 706f 7274 2043  s.utils import C
+00013c70: 6f6e 6669 6775 7261 626c 6546 6965 6c64  onfigurableField
+00013c80: 0a20 2020 2020 2020 2020 2020 2066 726f  .            fro
+00013c90: 6d20 6c61 6e67 6368 6169 6e5f 6f70 656e  m langchain_open
+00013ca0: 6169 2069 6d70 6f72 7420 4368 6174 4f70  ai import ChatOp
+00013cb0: 656e 4149 0a0a 2020 2020 2020 2020 2020  enAI..          
+00013cc0: 2020 6d6f 6465 6c20 3d20 4368 6174 416e    model = ChatAn
+00013cd0: 7468 726f 7069 6328 0a20 2020 2020 2020  thropic(.       
+00013ce0: 2020 2020 2020 2020 206d 6f64 656c 5f6e           model_n
+00013cf0: 616d 653d 2263 6c61 7564 652d 332d 736f  ame="claude-3-so
+00013d00: 6e6e 6574 2d32 3032 3430 3232 3922 0a20  nnet-20240229". 
+00013d10: 2020 2020 2020 2020 2020 2029 2e63 6f6e             ).con
+00013d20: 6669 6775 7261 626c 655f 616c 7465 726e  figurable_altern
+00013d30: 6174 6976 6573 280a 2020 2020 2020 2020  atives(.        
+00013d40: 2020 2020 2020 2020 436f 6e66 6967 7572          Configur
+00013d50: 6162 6c65 4669 656c 6428 6964 3d22 6c6c  ableField(id="ll
+00013d60: 6d22 292c 0a20 2020 2020 2020 2020 2020  m"),.           
+00013d70: 2020 2020 2064 6566 6175 6c74 5f6b 6579       default_key
+00013d80: 3d22 616e 7468 726f 7069 6322 2c0a 2020  ="anthropic",.  
+00013d90: 2020 2020 2020 2020 2020 2020 2020 6f70                op
+00013da0: 656e 6169 3d43 6861 744f 7065 6e41 4928  enai=ChatOpenAI(
+00013db0: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
+00013dc0: 0a20 2020 2020 2020 2020 2020 2023 2075  .            # u
+00013dd0: 7365 7320 7468 6520 6465 6661 756c 7420  ses the default 
+00013de0: 6d6f 6465 6c20 4368 6174 416e 7468 726f  model ChatAnthro
+00013df0: 7069 630a 2020 2020 2020 2020 2020 2020  pic.            
+00013e00: 7072 696e 7428 6d6f 6465 6c2e 696e 766f  print(model.invo
+00013e10: 6b65 2822 7768 6963 6820 6f72 6761 6e69  ke("which organi
+00013e20: 7a61 7469 6f6e 2063 7265 6174 6564 2079  zation created y
+00013e30: 6f75 3f22 292e 636f 6e74 656e 7429 0a0a  ou?").content)..
+00013e40: 2020 2020 2020 2020 2020 2020 2320 7573              # us
+00013e50: 6573 2043 6861 744f 7065 6e61 4149 0a20  es ChatOpenaAI. 
+00013e60: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00013e70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00013e80: 2020 6d6f 6465 6c2e 7769 7468 5f63 6f6e    model.with_con
+00013e90: 6669 6728 0a20 2020 2020 2020 2020 2020  fig(.           
+00013ea0: 2020 2020 2020 2020 2063 6f6e 6669 6775           configu
+00013eb0: 7261 626c 653d 7b22 6c6c 6d22 3a20 226f  rable={"llm": "o
+00013ec0: 7065 6e61 6922 7d0a 2020 2020 2020 2020  penai"}.        
+00013ed0: 2020 2020 2020 2020 292e 696e 766f 6b65          ).invoke
+00013ee0: 2822 7768 6963 6820 6f72 6761 6e69 7a61  ("which organiza
+00013ef0: 7469 6f6e 2063 7265 6174 6564 2079 6f75  tion created you
+00013f00: 3f22 292e 636f 6e74 656e 740a 2020 2020  ?").content.    
+00013f10: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00013f20: 2020 2222 220a 2020 2020 2020 2020 6672    """.        fr
+00013f30: 6f6d 206c 616e 6763 6861 696e 5f63 6f72  om langchain_cor
+00013f40: 652e 7275 6e6e 6162 6c65 732e 636f 6e66  e.runnables.conf
+00013f50: 6967 7572 6162 6c65 2069 6d70 6f72 7420  igurable import 
+00013f60: 280a 2020 2020 2020 2020 2020 2020 5275  (.            Ru
+00013f70: 6e6e 6162 6c65 436f 6e66 6967 7572 6162  nnableConfigurab
+00013f80: 6c65 416c 7465 726e 6174 6976 6573 2c0a  leAlternatives,.
+00013f90: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00013fa0: 2020 2072 6574 7572 6e20 5275 6e6e 6162     return Runnab
+00013fb0: 6c65 436f 6e66 6967 7572 6162 6c65 416c  leConfigurableAl
+00013fc0: 7465 726e 6174 6976 6573 280a 2020 2020  ternatives(.    
+00013fd0: 2020 2020 2020 2020 7768 6963 683d 7768          which=wh
+00013fe0: 6963 682c 0a20 2020 2020 2020 2020 2020  ich,.           
+00013ff0: 2064 6566 6175 6c74 3d73 656c 662c 0a20   default=self,. 
+00014000: 2020 2020 2020 2020 2020 2061 6c74 6572             alter
+00014010: 6e61 7469 7665 733d 6b77 6172 6773 2c0a  natives=kwargs,.
+00014020: 2020 2020 2020 2020 2020 2020 6465 6661              defa
+00014030: 756c 745f 6b65 793d 6465 6661 756c 745f  ult_key=default_
+00014040: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
+00014050: 2070 7265 6669 785f 6b65 7973 3d70 7265   prefix_keys=pre
+00014060: 6669 785f 6b65 7973 2c0a 2020 2020 2020  fix_keys,.      
+00014070: 2020 290a 0a0a 6465 6620 5f73 6571 5f69    )...def _seq_i
+00014080: 6e70 7574 5f73 6368 656d 6128 0a20 2020  nput_schema(.   
+00014090: 2073 7465 7073 3a20 4c69 7374 5b52 756e   steps: List[Run
+000140a0: 6e61 626c 655b 416e 792c 2041 6e79 5d5d  nable[Any, Any]]
+000140b0: 2c20 636f 6e66 6967 3a20 4f70 7469 6f6e  , config: Option
+000140c0: 616c 5b52 756e 6e61 626c 6543 6f6e 6669  al[RunnableConfi
+000140d0: 675d 0a29 202d 3e20 5479 7065 5b42 6173  g].) -> Type[Bas
+000140e0: 654d 6f64 656c 5d3a 0a20 2020 2066 726f  eModel]:.    fro
+000140f0: 6d20 6c61 6e67 6368 6169 6e5f 636f 7265  m langchain_core
+00014100: 2e72 756e 6e61 626c 6573 2e70 6173 7374  .runnables.passt
+00014110: 6872 6f75 6768 2069 6d70 6f72 7420 5275  hrough import Ru
+00014120: 6e6e 6162 6c65 4173 7369 676e 2c20 5275  nnableAssign, Ru
+00014130: 6e6e 6162 6c65 5069 636b 0a0a 2020 2020  nnablePick..    
+00014140: 6669 7273 7420 3d20 7374 6570 735b 305d  first = steps[0]
+00014150: 0a20 2020 2069 6620 6c65 6e28 7374 6570  .    if len(step
+00014160: 7329 203d 3d20 313a 0a20 2020 2020 2020  s) == 1:.       
+00014170: 2072 6574 7572 6e20 6669 7273 742e 6765   return first.ge
+00014180: 745f 696e 7075 745f 7363 6865 6d61 2863  t_input_schema(c
+00014190: 6f6e 6669 6729 0a20 2020 2065 6c69 6620  onfig).    elif 
+000141a0: 6973 696e 7374 616e 6365 2866 6972 7374  isinstance(first
+000141b0: 2c20 5275 6e6e 6162 6c65 4173 7369 676e  , RunnableAssign
+000141c0: 293a 0a20 2020 2020 2020 206e 6578 745f  ):.        next_
+000141d0: 696e 7075 745f 7363 6865 6d61 203d 205f  input_schema = _
+000141e0: 7365 715f 696e 7075 745f 7363 6865 6d61  seq_input_schema
+000141f0: 2873 7465 7073 5b31 3a5d 2c20 636f 6e66  (steps[1:], conf
+00014200: 6967 290a 2020 2020 2020 2020 6966 206e  ig).        if n
+00014210: 6f74 206e 6578 745f 696e 7075 745f 7363  ot next_input_sc
+00014220: 6865 6d61 2e5f 5f63 7573 746f 6d5f 726f  hema.__custom_ro
+00014230: 6f74 5f74 7970 655f 5f3a 0a20 2020 2020  ot_type__:.     
+00014240: 2020 2020 2020 2023 2069 7427 7320 6120         # it's a 
+00014250: 6469 6374 2061 7320 6578 7065 6374 6564  dict as expected
+00014260: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00014270: 7572 6e20 6372 6561 7465 5f6d 6f64 656c  urn create_model
+00014280: 2820 2023 2074 7970 653a 2069 676e 6f72  (  # type: ignor
+00014290: 655b 6361 6c6c 2d6f 7665 726c 6f61 645d  e[call-overload]
+000142a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000142b0: 2022 5275 6e6e 6162 6c65 5365 7175 656e   "RunnableSequen
+000142c0: 6365 496e 7075 7422 2c0a 2020 2020 2020  ceInput",.      
+000142d0: 2020 2020 2020 2020 2020 2a2a 7b0a 2020            **{.  
+000142e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000142f0: 2020 6b3a 2028 762e 616e 6e6f 7461 7469    k: (v.annotati
+00014300: 6f6e 2c20 762e 6465 6661 756c 7429 0a20  on, v.default). 
+00014310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014320: 2020 2066 6f72 206b 2c20 7620 696e 206e     for k, v in n
+00014330: 6578 745f 696e 7075 745f 7363 6865 6d61  ext_input_schema
+00014340: 2e5f 5f66 6965 6c64 735f 5f2e 6974 656d  .__fields__.item
+00014350: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
+00014360: 2020 2020 2020 2020 6966 206b 206e 6f74          if k not
+00014370: 2069 6e20 6669 7273 742e 6d61 7070 6572   in first.mapper
+00014380: 2e73 7465 7073 5f5f 0a20 2020 2020 2020  .steps__.       
+00014390: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
+000143a0: 2020 2020 2020 2020 290a 2020 2020 656c          ).    el
+000143b0: 6966 2069 7369 6e73 7461 6e63 6528 6669  if isinstance(fi
+000143c0: 7273 742c 2052 756e 6e61 626c 6550 6963  rst, RunnablePic
+000143d0: 6b29 3a0a 2020 2020 2020 2020 7265 7475  k):.        retu
+000143e0: 726e 205f 7365 715f 696e 7075 745f 7363  rn _seq_input_sc
+000143f0: 6865 6d61 2873 7465 7073 5b31 3a5d 2c20  hema(steps[1:], 
+00014400: 636f 6e66 6967 290a 0a20 2020 2072 6574  config)..    ret
+00014410: 7572 6e20 6669 7273 742e 6765 745f 696e  urn first.get_in
+00014420: 7075 745f 7363 6865 6d61 2863 6f6e 6669  put_schema(confi
+00014430: 6729 0a0a 0a64 6566 205f 7365 715f 6f75  g)...def _seq_ou
+00014440: 7470 7574 5f73 6368 656d 6128 0a20 2020  tput_schema(.   
+00014450: 2073 7465 7073 3a20 4c69 7374 5b52 756e   steps: List[Run
+00014460: 6e61 626c 655b 416e 792c 2041 6e79 5d5d  nable[Any, Any]]
+00014470: 2c20 636f 6e66 6967 3a20 4f70 7469 6f6e  , config: Option
+00014480: 616c 5b52 756e 6e61 626c 6543 6f6e 6669  al[RunnableConfi
+00014490: 675d 0a29 202d 3e20 5479 7065 5b42 6173  g].) -> Type[Bas
+000144a0: 654d 6f64 656c 5d3a 0a20 2020 2066 726f  eModel]:.    fro
+000144b0: 6d20 6c61 6e67 6368 6169 6e5f 636f 7265  m langchain_core
+000144c0: 2e72 756e 6e61 626c 6573 2e70 6173 7374  .runnables.passt
+000144d0: 6872 6f75 6768 2069 6d70 6f72 7420 5275  hrough import Ru
+000144e0: 6e6e 6162 6c65 4173 7369 676e 2c20 5275  nnableAssign, Ru
+000144f0: 6e6e 6162 6c65 5069 636b 0a0a 2020 2020  nnablePick..    
+00014500: 6c61 7374 203d 2073 7465 7073 5b2d 315d  last = steps[-1]
+00014510: 0a20 2020 2069 6620 6c65 6e28 7374 6570  .    if len(step
+00014520: 7329 203d 3d20 313a 0a20 2020 2020 2020  s) == 1:.       
+00014530: 2072 6574 7572 6e20 6c61 7374 2e67 6574   return last.get
+00014540: 5f69 6e70 7574 5f73 6368 656d 6128 636f  _input_schema(co
+00014550: 6e66 6967 290a 2020 2020 656c 6966 2069  nfig).    elif i
+00014560: 7369 6e73 7461 6e63 6528 6c61 7374 2c20  sinstance(last, 
+00014570: 5275 6e6e 6162 6c65 4173 7369 676e 293a  RunnableAssign):
+00014580: 0a20 2020 2020 2020 206d 6170 7065 725f  .        mapper_
+00014590: 6f75 7470 7574 5f73 6368 656d 6120 3d20  output_schema = 
+000145a0: 6c61 7374 2e6d 6170 7065 722e 6765 745f  last.mapper.get_
+000145b0: 6f75 7470 7574 5f73 6368 656d 6128 636f  output_schema(co
+000145c0: 6e66 6967 290a 2020 2020 2020 2020 7072  nfig).        pr
+000145d0: 6576 5f6f 7574 7075 745f 7363 6865 6d61  ev_output_schema
+000145e0: 203d 205f 7365 715f 6f75 7470 7574 5f73   = _seq_output_s
+000145f0: 6368 656d 6128 7374 6570 735b 3a2d 315d  chema(steps[:-1]
+00014600: 2c20 636f 6e66 6967 290a 2020 2020 2020  , config).      
+00014610: 2020 6966 206e 6f74 2070 7265 765f 6f75    if not prev_ou
+00014620: 7470 7574 5f73 6368 656d 612e 5f5f 6375  tput_schema.__cu
+00014630: 7374 6f6d 5f72 6f6f 745f 7479 7065 5f5f  stom_root_type__
 00014640: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00014650: 5468 6973 2069 7320 636f 7272 6563 742c  This is correct,
-00014660: 2062 7574 2070 7964 616e 7469 6320 7479   but pydantic ty
-00014670: 7069 6e67 732f 6d79 7079 2064 6f6e 2774  pings/mypy don't
-00014680: 2074 6869 6e6b 2073 6f2e 0a20 2020 2020   think so..     
-00014690: 2020 2020 2020 2072 6574 7572 6e20 6372         return cr
-000146a0: 6561 7465 5f6d 6f64 656c 2820 2023 2074  eate_model(  # t
-000146b0: 7970 653a 2069 676e 6f72 655b 6361 6c6c  ype: ignore[call
-000146c0: 2d6f 7665 726c 6f61 645d 0a20 2020 2020  -overload].     
-000146d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000146e0: 6765 745f 6e61 6d65 2822 496e 7075 7422  get_name("Input"
-000146f0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00014700: 2020 202a 2a7b 0a20 2020 2020 2020 2020     **{.         
-00014710: 2020 2020 2020 2020 2020 206b 3a20 2876             k: (v
-00014720: 2e61 6e6e 6f74 6174 696f 6e2c 2076 2e64  .annotation, v.d
-00014730: 6566 6175 6c74 290a 2020 2020 2020 2020  efault).        
-00014740: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00014750: 7374 6570 2069 6e20 7365 6c66 2e73 7465  step in self.ste
-00014760: 7073 2e76 616c 7565 7328 290a 2020 2020  ps.values().    
-00014770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014780: 666f 7220 6b2c 2076 2069 6e20 7374 6570  for k, v in step
-00014790: 2e67 6574 5f69 6e70 7574 5f73 6368 656d  .get_input_schem
-000147a0: 6128 636f 6e66 6967 292e 5f5f 6669 656c  a(config).__fiel
-000147b0: 6473 5f5f 2e69 7465 6d73 2829 0a20 2020  ds__.items().   
-000147c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000147d0: 2069 6620 6b20 213d 2022 5f5f 726f 6f74   if k != "__root
-000147e0: 5f5f 220a 2020 2020 2020 2020 2020 2020  __".            
-000147f0: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
-00014800: 2020 2020 2020 205f 5f63 6f6e 6669 675f         __config_
-00014810: 5f3d 5f53 6368 656d 6143 6f6e 6669 672c  _=_SchemaConfig,
-00014820: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-00014830: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00014840: 7570 6572 2829 2e67 6574 5f69 6e70 7574  uper().get_input
-00014850: 5f73 6368 656d 6128 636f 6e66 6967 290a  _schema(config).
-00014860: 0a20 2020 2064 6566 2067 6574 5f6f 7574  .    def get_out
-00014870: 7075 745f 7363 6865 6d61 280a 2020 2020  put_schema(.    
-00014880: 2020 2020 7365 6c66 2c20 636f 6e66 6967      self, config
-00014890: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
-000148a0: 626c 6543 6f6e 6669 675d 203d 204e 6f6e  bleConfig] = Non
-000148b0: 650a 2020 2020 2920 2d3e 2054 7970 655b  e.    ) -> Type[
-000148c0: 4261 7365 4d6f 6465 6c5d 3a0a 2020 2020  BaseModel]:.    
-000148d0: 2020 2020 2320 5468 6973 2069 7320 636f      # This is co
-000148e0: 7272 6563 742c 2062 7574 2070 7964 616e  rrect, but pydan
-000148f0: 7469 6320 7479 7069 6e67 732f 6d79 7079  tic typings/mypy
-00014900: 2064 6f6e 2774 2074 6869 6e6b 2073 6f2e   don't think so.
-00014910: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00014920: 6372 6561 7465 5f6d 6f64 656c 2820 2023  create_model(  #
-00014930: 2074 7970 653a 2069 676e 6f72 655b 6361   type: ignore[ca
-00014940: 6c6c 2d6f 7665 726c 6f61 645d 0a20 2020  ll-overload].   
-00014950: 2020 2020 2020 2020 2073 656c 662e 6765           self.ge
-00014960: 745f 6e61 6d65 2822 4f75 7470 7574 2229  t_name("Output")
-00014970: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
-00014980: 7b6b 3a20 2876 2e4f 7574 7075 7454 7970  {k: (v.OutputTyp
-00014990: 652c 204e 6f6e 6529 2066 6f72 206b 2c20  e, None) for k, 
-000149a0: 7620 696e 2073 656c 662e 7374 6570 732e  v in self.steps.
-000149b0: 6974 656d 7328 297d 2c0a 2020 2020 2020  items()},.      
-000149c0: 2020 2020 2020 5f5f 636f 6e66 6967 5f5f        __config__
-000149d0: 3d5f 5363 6865 6d61 436f 6e66 6967 2c0a  =_SchemaConfig,.
-000149e0: 2020 2020 2020 2020 290a 0a20 2020 2040          )..    @
-000149f0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00014a00: 2063 6f6e 6669 675f 7370 6563 7328 7365   config_specs(se
-00014a10: 6c66 2920 2d3e 204c 6973 745b 436f 6e66  lf) -> List[Conf
-00014a20: 6967 7572 6162 6c65 4669 656c 6453 7065  igurableFieldSpe
-00014a30: 635d 3a0a 2020 2020 2020 2020 7265 7475  c]:.        retu
-00014a40: 726e 2067 6574 5f75 6e69 7175 655f 636f  rn get_unique_co
-00014a50: 6e66 6967 5f73 7065 6373 280a 2020 2020  nfig_specs(.    
-00014a60: 2020 2020 2020 2020 7370 6563 2066 6f72          spec for
-00014a70: 2073 7465 7020 696e 2073 656c 662e 7374   step in self.st
-00014a80: 6570 732e 7661 6c75 6573 2829 2066 6f72  eps.values() for
-00014a90: 2073 7065 6320 696e 2073 7465 702e 636f   spec in step.co
-00014aa0: 6e66 6967 5f73 7065 6373 0a20 2020 2020  nfig_specs.     
-00014ab0: 2020 2029 0a0a 2020 2020 6465 6620 6765     )..    def ge
-00014ac0: 745f 6772 6170 6828 7365 6c66 2c20 636f  t_graph(self, co
-00014ad0: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
-00014ae0: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
-00014af0: 204e 6f6e 6529 202d 3e20 4772 6170 683a   None) -> Graph:
-00014b00: 0a20 2020 2020 2020 2066 726f 6d20 6c61  .        from la
-00014b10: 6e67 6368 6169 6e5f 636f 7265 2e72 756e  ngchain_core.run
-00014b20: 6e61 626c 6573 2e67 7261 7068 2069 6d70  nables.graph imp
-00014b30: 6f72 7420 4772 6170 680a 0a20 2020 2020  ort Graph..     
-00014b40: 2020 2067 7261 7068 203d 2047 7261 7068     graph = Graph
-00014b50: 2829 0a20 2020 2020 2020 2069 6e70 7574  ().        input
-00014b60: 5f6e 6f64 6520 3d20 6772 6170 682e 6164  _node = graph.ad
-00014b70: 645f 6e6f 6465 2873 656c 662e 6765 745f  d_node(self.get_
-00014b80: 696e 7075 745f 7363 6865 6d61 2863 6f6e  input_schema(con
-00014b90: 6669 6729 290a 2020 2020 2020 2020 6f75  fig)).        ou
-00014ba0: 7470 7574 5f6e 6f64 6520 3d20 6772 6170  tput_node = grap
-00014bb0: 682e 6164 645f 6e6f 6465 2873 656c 662e  h.add_node(self.
-00014bc0: 6765 745f 6f75 7470 7574 5f73 6368 656d  get_output_schem
-00014bd0: 6128 636f 6e66 6967 2929 0a20 2020 2020  a(config)).     
-00014be0: 2020 2066 6f72 2073 7465 7020 696e 2073     for step in s
-00014bf0: 656c 662e 7374 6570 732e 7661 6c75 6573  elf.steps.values
-00014c00: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00014c10: 7374 6570 5f67 7261 7068 203d 2073 7465  step_graph = ste
-00014c20: 702e 6765 745f 6772 6170 6828 290a 2020  p.get_graph().  
-00014c30: 2020 2020 2020 2020 2020 7374 6570 5f67            step_g
-00014c40: 7261 7068 2e74 7269 6d5f 6669 7273 745f  raph.trim_first_
-00014c50: 6e6f 6465 2829 0a20 2020 2020 2020 2020  node().         
-00014c60: 2020 2073 7465 705f 6772 6170 682e 7472     step_graph.tr
-00014c70: 696d 5f6c 6173 745f 6e6f 6465 2829 0a20  im_last_node(). 
-00014c80: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00014c90: 7420 7374 6570 5f67 7261 7068 3a0a 2020  t step_graph:.  
-00014ca0: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-00014cb0: 6170 682e 6164 645f 6564 6765 2869 6e70  aph.add_edge(inp
-00014cc0: 7574 5f6e 6f64 652c 206f 7574 7075 745f  ut_node, output_
-00014cd0: 6e6f 6465 290a 2020 2020 2020 2020 2020  node).          
-00014ce0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00014cf0: 2020 2020 2020 2020 6772 6170 682e 6578          graph.ex
-00014d00: 7465 6e64 2873 7465 705f 6772 6170 6829  tend(step_graph)
-00014d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014d20: 2073 7465 705f 6669 7273 745f 6e6f 6465   step_first_node
-00014d30: 203d 2073 7465 705f 6772 6170 682e 6669   = step_graph.fi
-00014d40: 7273 745f 6e6f 6465 2829 0a20 2020 2020  rst_node().     
-00014d50: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00014d60: 7420 7374 6570 5f66 6972 7374 5f6e 6f64  t step_first_nod
-00014d70: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00014d80: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00014d90: 7565 4572 726f 7228 6622 5275 6e6e 6162  ueError(f"Runnab
-00014da0: 6c65 207b 7374 6570 7d20 6861 7320 6e6f  le {step} has no
-00014db0: 2066 6972 7374 206e 6f64 6522 290a 2020   first node").  
-00014dc0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00014dd0: 6570 5f6c 6173 745f 6e6f 6465 203d 2073  ep_last_node = s
-00014de0: 7465 705f 6772 6170 682e 6c61 7374 5f6e  tep_graph.last_n
-00014df0: 6f64 6528 290a 2020 2020 2020 2020 2020  ode().          
-00014e00: 2020 2020 2020 6966 206e 6f74 2073 7465        if not ste
-00014e10: 705f 6c61 7374 5f6e 6f64 653a 0a20 2020  p_last_node:.   
-00014e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e30: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00014e40: 7228 6622 5275 6e6e 6162 6c65 207b 7374  r(f"Runnable {st
-00014e50: 6570 7d20 6861 7320 6e6f 206c 6173 7420  ep} has no last 
-00014e60: 6e6f 6465 2229 0a20 2020 2020 2020 2020  node").         
-00014e70: 2020 2020 2020 2067 7261 7068 2e61 6464         graph.add
-00014e80: 5f65 6467 6528 696e 7075 745f 6e6f 6465  _edge(input_node
-00014e90: 2c20 7374 6570 5f66 6972 7374 5f6e 6f64  , step_first_nod
-00014ea0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00014eb0: 2020 2067 7261 7068 2e61 6464 5f65 6467     graph.add_edg
-00014ec0: 6528 7374 6570 5f6c 6173 745f 6e6f 6465  e(step_last_node
-00014ed0: 2c20 6f75 7470 7574 5f6e 6f64 6529 0a0a  , output_node)..
-00014ee0: 2020 2020 2020 2020 7265 7475 726e 2067          return g
-00014ef0: 7261 7068 0a0a 2020 2020 6465 6620 5f5f  raph..    def __
-00014f00: 7265 7072 5f5f 2873 656c 6629 202d 3e20  repr__(self) -> 
-00014f10: 7374 723a 0a20 2020 2020 2020 206d 6170  str:.        map
-00014f20: 5f66 6f72 5f72 6570 7220 3d20 222c 5c6e  _for_repr = ",\n
-00014f30: 2020 222e 6a6f 696e 280a 2020 2020 2020    ".join(.      
-00014f40: 2020 2020 2020 6622 7b6b 7d3a 207b 696e        f"{k}: {in
-00014f50: 6465 6e74 5f6c 696e 6573 5f61 6674 6572  dent_lines_after
-00014f60: 5f66 6972 7374 2872 6570 7228 7629 2c20  _first(repr(v), 
-00014f70: 2720 2027 202b 206b 202b 2027 3a20 2729  '  ' + k + ': ')
-00014f80: 7d22 0a20 2020 2020 2020 2020 2020 2066  }".            f
-00014f90: 6f72 206b 2c20 7620 696e 2073 656c 662e  or k, v in self.
-00014fa0: 7374 6570 732e 6974 656d 7328 290a 2020  steps.items().  
-00014fb0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00014fc0: 7265 7475 726e 2022 7b5c 6e20 2022 202b  return "{\n  " +
-00014fd0: 206d 6170 5f66 6f72 5f72 6570 7220 2b20   map_for_repr + 
-00014fe0: 225c 6e7d 220a 0a20 2020 2064 6566 2069  "\n}"..    def i
-00014ff0: 6e76 6f6b 6528 0a20 2020 2020 2020 2073  nvoke(.        s
-00015000: 656c 662c 2069 6e70 7574 3a20 496e 7075  elf, input: Inpu
-00015010: 742c 2063 6f6e 6669 673a 204f 7074 696f  t, config: Optio
-00015020: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-00015030: 6967 5d20 3d20 4e6f 6e65 0a20 2020 2029  ig] = None.    )
-00015040: 202d 3e20 4469 6374 5b73 7472 2c20 416e   -> Dict[str, An
-00015050: 795d 3a0a 2020 2020 2020 2020 6672 6f6d  y]:.        from
-00015060: 206c 616e 6763 6861 696e 5f63 6f72 652e   langchain_core.
-00015070: 6361 6c6c 6261 636b 732e 6d61 6e61 6765  callbacks.manage
-00015080: 7220 696d 706f 7274 2043 616c 6c62 6163  r import Callbac
-00015090: 6b4d 616e 6167 6572 0a0a 2020 2020 2020  kManager..      
-000150a0: 2020 2320 7365 7475 7020 6361 6c6c 6261    # setup callba
-000150b0: 636b 730a 2020 2020 2020 2020 636f 6e66  cks.        conf
-000150c0: 6967 203d 2065 6e73 7572 655f 636f 6e66  ig = ensure_conf
-000150d0: 6967 2863 6f6e 6669 6729 0a20 2020 2020  ig(config).     
-000150e0: 2020 2063 616c 6c62 6163 6b5f 6d61 6e61     callback_mana
-000150f0: 6765 7220 3d20 4361 6c6c 6261 636b 4d61  ger = CallbackMa
-00015100: 6e61 6765 722e 636f 6e66 6967 7572 6528  nager.configure(
-00015110: 0a20 2020 2020 2020 2020 2020 2069 6e68  .            inh
-00015120: 6572 6974 6162 6c65 5f63 616c 6c62 6163  eritable_callbac
-00015130: 6b73 3d63 6f6e 6669 672e 6765 7428 2263  ks=config.get("c
-00015140: 616c 6c62 6163 6b73 2229 2c0a 2020 2020  allbacks"),.    
-00015150: 2020 2020 2020 2020 6c6f 6361 6c5f 6361          local_ca
-00015160: 6c6c 6261 636b 733d 4e6f 6e65 2c0a 2020  llbacks=None,.  
-00015170: 2020 2020 2020 2020 2020 7665 7262 6f73            verbos
-00015180: 653d 4661 6c73 652c 0a20 2020 2020 2020  e=False,.       
-00015190: 2020 2020 2069 6e68 6572 6974 6162 6c65       inheritable
-000151a0: 5f74 6167 733d 636f 6e66 6967 2e67 6574  _tags=config.get
-000151b0: 2822 7461 6773 2229 2c0a 2020 2020 2020  ("tags"),.      
-000151c0: 2020 2020 2020 6c6f 6361 6c5f 7461 6773        local_tags
-000151d0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
-000151e0: 2020 2069 6e68 6572 6974 6162 6c65 5f6d     inheritable_m
-000151f0: 6574 6164 6174 613d 636f 6e66 6967 2e67  etadata=config.g
-00015200: 6574 2822 6d65 7461 6461 7461 2229 2c0a  et("metadata"),.
-00015210: 2020 2020 2020 2020 2020 2020 6c6f 6361              loca
-00015220: 6c5f 6d65 7461 6461 7461 3d4e 6f6e 652c  l_metadata=None,
-00015230: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00015240: 2020 2023 2073 7461 7274 2074 6865 2072     # start the r
-00015250: 6f6f 7420 7275 6e0a 2020 2020 2020 2020  oot run.        
-00015260: 7275 6e5f 6d61 6e61 6765 7220 3d20 6361  run_manager = ca
-00015270: 6c6c 6261 636b 5f6d 616e 6167 6572 2e6f  llback_manager.o
-00015280: 6e5f 6368 6169 6e5f 7374 6172 7428 0a20  n_chain_start(. 
-00015290: 2020 2020 2020 2020 2020 2064 756d 7064             dumpd
-000152a0: 2873 656c 6629 2c20 696e 7075 742c 206e  (self), input, n
-000152b0: 616d 653d 636f 6e66 6967 2e67 6574 2822  ame=config.get("
-000152c0: 7275 6e5f 6e61 6d65 2229 206f 7220 7365  run_name") or se
-000152d0: 6c66 2e67 6574 5f6e 616d 6528 290a 2020  lf.get_name().  
-000152e0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-000152f0: 2023 2067 6174 6865 7220 7265 7375 6c74   # gather result
-00015300: 7320 6672 6f6d 2061 6c6c 2073 7465 7073  s from all steps
-00015310: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-00015320: 2020 2020 2020 2020 2020 2320 636f 7079            # copy
-00015330: 2074 6f20 6176 6f69 6420 6973 7375 6573   to avoid issues
-00015340: 2066 726f 6d20 7468 6520 6361 6c6c 6572   from the caller
-00015350: 206d 7574 6174 696e 6720 7468 6520 7374   mutating the st
-00015360: 6570 7320 6475 7269 6e67 2069 6e76 6f6b  eps during invok
-00015370: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
-00015380: 7374 6570 7320 3d20 6469 6374 2873 656c  steps = dict(sel
-00015390: 662e 7374 6570 7329 0a20 2020 2020 2020  f.steps).       
-000153a0: 2020 2020 2077 6974 6820 6765 745f 6578       with get_ex
-000153b0: 6563 7574 6f72 5f66 6f72 5f63 6f6e 6669  ecutor_for_confi
-000153c0: 6728 636f 6e66 6967 2920 6173 2065 7865  g(config) as exe
-000153d0: 6375 746f 723a 0a20 2020 2020 2020 2020  cutor:.         
-000153e0: 2020 2020 2020 2066 7574 7572 6573 203d         futures =
-000153f0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-00015400: 2020 2020 2020 2065 7865 6375 746f 722e         executor.
-00015410: 7375 626d 6974 280a 2020 2020 2020 2020  submit(.        
-00015420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015430: 7374 6570 2e69 6e76 6f6b 652c 0a20 2020  step.invoke,.   
-00015440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015450: 2020 2020 2069 6e70 7574 2c0a 2020 2020       input,.    
-00015460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015470: 2020 2020 2320 6d61 726b 2065 6163 6820      # mark each 
-00015480: 7374 6570 2061 7320 6120 6368 696c 6420  step as a child 
-00015490: 7275 6e0a 2020 2020 2020 2020 2020 2020  run.            
-000154a0: 2020 2020 2020 2020 2020 2020 7061 7463              patc
-000154b0: 685f 636f 6e66 6967 280a 2020 2020 2020  h_config(.      
-000154c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000154d0: 2020 2020 2020 636f 6e66 6967 2c0a 2020        config,.  
-000154e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000154f0: 2020 2020 2020 2020 2020 6361 6c6c 6261            callba
-00015500: 636b 733d 7275 6e5f 6d61 6e61 6765 722e  cks=run_manager.
-00015510: 6765 745f 6368 696c 6428 6622 6d61 703a  get_child(f"map:
-00015520: 6b65 793a 7b6b 6579 7d22 292c 0a20 2020  key:{key}"),.   
-00015530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015540: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-00015550: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00015560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015570: 2020 666f 7220 6b65 792c 2073 7465 7020    for key, step 
-00015580: 696e 2073 7465 7073 2e69 7465 6d73 2829  in steps.items()
-00015590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000155a0: 205d 0a20 2020 2020 2020 2020 2020 2020   ].             
-000155b0: 2020 206f 7574 7075 7420 3d20 7b6b 6579     output = {key
-000155c0: 3a20 6675 7475 7265 2e72 6573 756c 7428  : future.result(
-000155d0: 2920 666f 7220 6b65 792c 2066 7574 7572  ) for key, futur
-000155e0: 6520 696e 207a 6970 2873 7465 7073 2c20  e in zip(steps, 
-000155f0: 6675 7475 7265 7329 7d0a 2020 2020 2020  futures)}.      
-00015600: 2020 2320 6669 6e69 7368 2074 6865 2072    # finish the r
-00015610: 6f6f 7420 7275 6e0a 2020 2020 2020 2020  oot run.        
-00015620: 6578 6365 7074 2042 6173 6545 7863 6570  except BaseExcep
-00015630: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-00015640: 2020 2020 2020 2072 756e 5f6d 616e 6167         run_manag
-00015650: 6572 2e6f 6e5f 6368 6169 6e5f 6572 726f  er.on_chain_erro
-00015660: 7228 6529 0a20 2020 2020 2020 2020 2020  r(e).           
-00015670: 2072 6169 7365 0a20 2020 2020 2020 2065   raise.        e
-00015680: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00015690: 2072 756e 5f6d 616e 6167 6572 2e6f 6e5f   run_manager.on_
-000156a0: 6368 6169 6e5f 656e 6428 6f75 7470 7574  chain_end(output
-000156b0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-000156c0: 7475 726e 206f 7574 7075 740a 0a20 2020  turn output..   
-000156d0: 2061 7379 6e63 2064 6566 2061 696e 766f   async def ainvo
-000156e0: 6b65 280a 2020 2020 2020 2020 7365 6c66  ke(.        self
-000156f0: 2c0a 2020 2020 2020 2020 696e 7075 743a  ,.        input:
-00015700: 2049 6e70 7574 2c0a 2020 2020 2020 2020   Input,.        
-00015710: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
-00015720: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
-00015730: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00015740: 202a 2a6b 7761 7267 733a 204f 7074 696f   **kwargs: Optio
-00015750: 6e61 6c5b 416e 795d 2c0a 2020 2020 2920  nal[Any],.    ) 
-00015760: 2d3e 2044 6963 745b 7374 722c 2041 6e79  -> Dict[str, Any
-00015770: 5d3a 0a20 2020 2020 2020 2023 2073 6574  ]:.        # set
-00015780: 7570 2063 616c 6c62 6163 6b73 0a20 2020  up callbacks.   
-00015790: 2020 2020 2063 6f6e 6669 6720 3d20 656e       config = en
-000157a0: 7375 7265 5f63 6f6e 6669 6728 636f 6e66  sure_config(conf
-000157b0: 6967 290a 2020 2020 2020 2020 6361 6c6c  ig).        call
-000157c0: 6261 636b 5f6d 616e 6167 6572 203d 2067  back_manager = g
-000157d0: 6574 5f61 7379 6e63 5f63 616c 6c62 6163  et_async_callbac
-000157e0: 6b5f 6d61 6e61 6765 725f 666f 725f 636f  k_manager_for_co
-000157f0: 6e66 6967 2863 6f6e 6669 6729 0a20 2020  nfig(config).   
-00015800: 2020 2020 2023 2073 7461 7274 2074 6865       # start the
-00015810: 2072 6f6f 7420 7275 6e0a 2020 2020 2020   root run.      
-00015820: 2020 7275 6e5f 6d61 6e61 6765 7220 3d20    run_manager = 
-00015830: 6177 6169 7420 6361 6c6c 6261 636b 5f6d  await callback_m
-00015840: 616e 6167 6572 2e6f 6e5f 6368 6169 6e5f  anager.on_chain_
-00015850: 7374 6172 7428 0a20 2020 2020 2020 2020  start(.         
-00015860: 2020 2064 756d 7064 2873 656c 6629 2c20     dumpd(self), 
-00015870: 696e 7075 742c 206e 616d 653d 636f 6e66  input, name=conf
-00015880: 6967 2e67 6574 2822 7275 6e5f 6e61 6d65  ig.get("run_name
-00015890: 2229 206f 7220 7365 6c66 2e67 6574 5f6e  ") or self.get_n
-000158a0: 616d 6528 290a 2020 2020 2020 2020 290a  ame().        ).
-000158b0: 0a20 2020 2020 2020 2023 2067 6174 6865  .        # gathe
-000158c0: 7220 7265 7375 6c74 7320 6672 6f6d 2061  r results from a
-000158d0: 6c6c 2073 7465 7073 0a20 2020 2020 2020  ll steps.       
-000158e0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-000158f0: 2020 2320 636f 7079 2074 6f20 6176 6f69    # copy to avoi
-00015900: 6420 6973 7375 6573 2066 726f 6d20 7468  d issues from th
-00015910: 6520 6361 6c6c 6572 206d 7574 6174 696e  e caller mutatin
-00015920: 6720 7468 6520 7374 6570 7320 6475 7269  g the steps duri
-00015930: 6e67 2069 6e76 6f6b 6528 290a 2020 2020  ng invoke().    
-00015940: 2020 2020 2020 2020 7374 6570 7320 3d20          steps = 
-00015950: 6469 6374 2873 656c 662e 7374 6570 7329  dict(self.steps)
-00015960: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-00015970: 756c 7473 203d 2061 7761 6974 2061 7379  ults = await asy
-00015980: 6e63 696f 2e67 6174 6865 7228 0a20 2020  ncio.gather(.   
-00015990: 2020 2020 2020 2020 2020 2020 202a 280a               *(.
-000159a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000159b0: 2020 2020 7374 6570 2e61 696e 766f 6b65      step.ainvoke
-000159c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000159d0: 2020 2020 2020 2020 2020 696e 7075 742c            input,
-000159e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000159f0: 2020 2020 2020 2020 2023 206d 6172 6b20           # mark 
-00015a00: 6561 6368 2073 7465 7020 6173 2061 2063  each step as a c
-00015a10: 6869 6c64 2072 756e 0a20 2020 2020 2020  hild run.       
-00015a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a30: 2070 6174 6368 5f63 6f6e 6669 6728 0a20   patch_config(. 
-00015a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a50: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
-00015a60: 672c 2063 616c 6c62 6163 6b73 3d72 756e  g, callbacks=run
-00015a70: 5f6d 616e 6167 6572 2e67 6574 5f63 6869  _manager.get_chi
-00015a80: 6c64 2866 226d 6170 3a6b 6579 3a7b 6b65  ld(f"map:key:{ke
-00015a90: 797d 2229 0a20 2020 2020 2020 2020 2020  y}").           
-00015aa0: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
-00015ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ac0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00015ad0: 2020 2020 2020 2020 2020 666f 7220 6b65            for ke
-00015ae0: 792c 2073 7465 7020 696e 2073 7465 7073  y, step in steps
-00015af0: 2e69 7465 6d73 2829 0a20 2020 2020 2020  .items().       
-00015b00: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00015b10: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00015b20: 2020 2020 206f 7574 7075 7420 3d20 7b6b       output = {k
-00015b30: 6579 3a20 7661 6c75 6520 666f 7220 6b65  ey: value for ke
-00015b40: 792c 2076 616c 7565 2069 6e20 7a69 7028  y, value in zip(
-00015b50: 7374 6570 732c 2072 6573 756c 7473 297d  steps, results)}
-00015b60: 0a20 2020 2020 2020 2023 2066 696e 6973  .        # finis
-00015b70: 6820 7468 6520 726f 6f74 2072 756e 0a20  h the root run. 
-00015b80: 2020 2020 2020 2065 7863 6570 7420 4261         except Ba
-00015b90: 7365 4578 6365 7074 696f 6e20 6173 2065  seException as e
-00015ba0: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
-00015bb0: 6169 7420 7275 6e5f 6d61 6e61 6765 722e  ait run_manager.
-00015bc0: 6f6e 5f63 6861 696e 5f65 7272 6f72 2865  on_chain_error(e
-00015bd0: 290a 2020 2020 2020 2020 2020 2020 7261  ).            ra
-00015be0: 6973 650a 2020 2020 2020 2020 656c 7365  ise.        else
-00015bf0: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
-00015c00: 6169 7420 7275 6e5f 6d61 6e61 6765 722e  ait run_manager.
-00015c10: 6f6e 5f63 6861 696e 5f65 6e64 286f 7574  on_chain_end(out
-00015c20: 7075 7429 0a20 2020 2020 2020 2020 2020  put).           
-00015c30: 2072 6574 7572 6e20 6f75 7470 7574 0a0a   return output..
-00015c40: 2020 2020 6465 6620 5f74 7261 6e73 666f      def _transfo
-00015c50: 726d 280a 2020 2020 2020 2020 7365 6c66  rm(.        self
-00015c60: 2c0a 2020 2020 2020 2020 696e 7075 743a  ,.        input:
-00015c70: 2049 7465 7261 746f 725b 496e 7075 745d   Iterator[Input]
-00015c80: 2c0a 2020 2020 2020 2020 7275 6e5f 6d61  ,.        run_ma
-00015c90: 6e61 6765 723a 2043 616c 6c62 6163 6b4d  nager: CallbackM
-00015ca0: 616e 6167 6572 466f 7243 6861 696e 5275  anagerForChainRu
-00015cb0: 6e2c 0a20 2020 2020 2020 2063 6f6e 6669  n,.        confi
-00015cc0: 673a 2052 756e 6e61 626c 6543 6f6e 6669  g: RunnableConfi
-00015cd0: 672c 0a20 2020 2029 202d 3e20 4974 6572  g,.    ) -> Iter
-00015ce0: 6174 6f72 5b41 6464 6162 6c65 4469 6374  ator[AddableDict
-00015cf0: 5d3a 0a20 2020 2020 2020 2023 2053 6861  ]:.        # Sha
-00015d00: 6c6c 6f77 2063 6f70 7920 7374 6570 7320  llow copy steps 
-00015d10: 746f 2069 676e 6f72 6520 6d75 7461 7469  to ignore mutati
-00015d20: 6f6e 7320 7768 696c 6520 696e 2070 726f  ons while in pro
-00015d30: 6772 6573 730a 2020 2020 2020 2020 7374  gress.        st
-00015d40: 6570 7320 3d20 6469 6374 2873 656c 662e  eps = dict(self.
-00015d50: 7374 6570 7329 0a20 2020 2020 2020 2023  steps).        #
-00015d60: 2045 6163 6820 7374 6570 2067 6574 7320   Each step gets 
-00015d70: 6120 636f 7079 206f 6620 7468 6520 696e  a copy of the in
-00015d80: 7075 7420 6974 6572 6174 6f72 2c0a 2020  put iterator,.  
-00015d90: 2020 2020 2020 2320 7768 6963 6820 6973        # which is
-00015da0: 2063 6f6e 7375 6d65 6420 696e 2070 6172   consumed in par
-00015db0: 616c 6c65 6c20 696e 2061 2073 6570 6172  allel in a separ
-00015dc0: 6174 6520 7468 7265 6164 2e0a 2020 2020  ate thread..    
-00015dd0: 2020 2020 696e 7075 745f 636f 7069 6573      input_copies
-00015de0: 203d 206c 6973 7428 7361 6665 7465 6528   = list(safetee(
-00015df0: 696e 7075 742c 206c 656e 2873 7465 7073  input, len(steps
-00015e00: 292c 206c 6f63 6b3d 7468 7265 6164 696e  ), lock=threadin
-00015e10: 672e 4c6f 636b 2829 2929 0a20 2020 2020  g.Lock())).     
-00015e20: 2020 2077 6974 6820 6765 745f 6578 6563     with get_exec
-00015e30: 7574 6f72 5f66 6f72 5f63 6f6e 6669 6728  utor_for_config(
-00015e40: 636f 6e66 6967 2920 6173 2065 7865 6375  config) as execu
-00015e50: 746f 723a 0a20 2020 2020 2020 2020 2020  tor:.           
-00015e60: 2023 2043 7265 6174 6520 7468 6520 7472   # Create the tr
-00015e70: 616e 7366 6f72 6d28 2920 6765 6e65 7261  ansform() genera
-00015e80: 746f 7220 666f 7220 6561 6368 2073 7465  tor for each ste
-00015e90: 700a 2020 2020 2020 2020 2020 2020 6e61  p.            na
-00015ea0: 6d65 645f 6765 6e65 7261 746f 7273 203d  med_generators =
-00015eb0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-00015ec0: 2020 2028 0a20 2020 2020 2020 2020 2020     (.           
-00015ed0: 2020 2020 2020 2020 206e 616d 652c 0a20           name,. 
-00015ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ef0: 2020 2073 7465 702e 7472 616e 7366 6f72     step.transfor
-00015f00: 6d28 0a20 2020 2020 2020 2020 2020 2020  m(.             
-00015f10: 2020 2020 2020 2020 2020 2069 6e70 7574             input
-00015f20: 5f63 6f70 6965 732e 706f 7028 292c 0a20  _copies.pop(),. 
-00015f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015f40: 2020 2020 2020 2070 6174 6368 5f63 6f6e         patch_con
-00015f50: 6669 6728 0a20 2020 2020 2020 2020 2020  fig(.           
-00015f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015f70: 2063 6f6e 6669 672c 2063 616c 6c62 6163   config, callbac
-00015f80: 6b73 3d72 756e 5f6d 616e 6167 6572 2e67  ks=run_manager.g
-00015f90: 6574 5f63 6869 6c64 2866 226d 6170 3a6b  et_child(f"map:k
-00015fa0: 6579 3a7b 6e61 6d65 7d22 290a 2020 2020  ey:{name}").    
-00015fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015fc0: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-00015fd0: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-00015fe0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00015ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016000: 666f 7220 6e61 6d65 2c20 7374 6570 2069  for name, step i
-00016010: 6e20 7374 6570 732e 6974 656d 7328 290a  n steps.items().
-00016020: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-00016030: 2020 2020 2020 2020 2020 2320 5374 6172            # Star
-00016040: 7420 7468 6520 6669 7273 7420 6974 6572  t the first iter
-00016050: 6174 696f 6e20 6f66 2065 6163 6820 6765  ation of each ge
-00016060: 6e65 7261 746f 720a 2020 2020 2020 2020  nerator.        
-00016070: 2020 2020 6675 7475 7265 7320 3d20 7b0a      futures = {.
-00016080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016090: 6578 6563 7574 6f72 2e73 7562 6d69 7428  executor.submit(
-000160a0: 6e65 7874 2c20 6765 6e65 7261 746f 7229  next, generator)
-000160b0: 3a20 2873 7465 705f 6e61 6d65 2c20 6765  : (step_name, ge
-000160c0: 6e65 7261 746f 7229 0a20 2020 2020 2020  nerator).       
-000160d0: 2020 2020 2020 2020 2066 6f72 2073 7465           for ste
-000160e0: 705f 6e61 6d65 2c20 6765 6e65 7261 746f  p_name, generato
-000160f0: 7220 696e 206e 616d 6564 5f67 656e 6572  r in named_gener
-00016100: 6174 6f72 730a 2020 2020 2020 2020 2020  ators.          
-00016110: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00016120: 2320 5969 656c 6420 6368 756e 6b73 2066  # Yield chunks f
-00016130: 726f 6d20 6561 6368 2061 7320 7468 6579  rom each as they
-00016140: 2062 6563 6f6d 6520 6176 6169 6c61 626c   become availabl
-00016150: 652c 0a20 2020 2020 2020 2020 2020 2023  e,.            #
-00016160: 2061 6e64 2073 7461 7274 2074 6865 206e   and start the n
-00016170: 6578 7420 6974 6572 6174 696f 6e20 6f66  ext iteration of
-00016180: 2074 6861 7420 6765 6e65 7261 746f 7220   that generator 
-00016190: 7468 6174 2079 6965 6c64 6564 2069 742e  that yielded it.
-000161a0: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
-000161b0: 6865 6e20 616c 6c20 6765 6e65 7261 746f  hen all generato
-000161c0: 7273 2061 7265 2065 7868 6175 7374 6564  rs are exhausted
-000161d0: 2c20 7374 6f70 2e0a 2020 2020 2020 2020  , stop..        
-000161e0: 2020 2020 7768 696c 6520 6675 7475 7265      while future
-000161f0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00016200: 2020 2063 6f6d 706c 6574 6564 5f66 7574     completed_fut
-00016210: 7572 6573 2c20 5f20 3d20 7761 6974 2866  ures, _ = wait(f
-00016220: 7574 7572 6573 2c20 7265 7475 726e 5f77  utures, return_w
-00016230: 6865 6e3d 4649 5253 545f 434f 4d50 4c45  hen=FIRST_COMPLE
-00016240: 5445 4429 0a20 2020 2020 2020 2020 2020  TED).           
-00016250: 2020 2020 2066 6f72 2066 7574 7572 6520       for future 
-00016260: 696e 2063 6f6d 706c 6574 6564 5f66 7574  in completed_fut
-00016270: 7572 6573 3a0a 2020 2020 2020 2020 2020  ures:.          
-00016280: 2020 2020 2020 2020 2020 2873 7465 705f            (step_
-00016290: 6e61 6d65 2c20 6765 6e65 7261 746f 7229  name, generator)
-000162a0: 203d 2066 7574 7572 6573 2e70 6f70 2866   = futures.pop(f
-000162b0: 7574 7572 6529 0a20 2020 2020 2020 2020  uture).         
-000162c0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-000162d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000162e0: 2020 2020 2020 2020 6368 756e 6b20 3d20          chunk = 
-000162f0: 4164 6461 626c 6544 6963 7428 7b73 7465  AddableDict({ste
-00016300: 705f 6e61 6d65 3a20 6675 7475 7265 2e72  p_name: future.r
-00016310: 6573 756c 7428 297d 290a 2020 2020 2020  esult()}).      
-00016320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016330: 2020 7969 656c 6420 6368 756e 6b0a 2020    yield chunk.  
-00016340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016350: 2020 2020 2020 6675 7475 7265 735b 6578        futures[ex
-00016360: 6563 7574 6f72 2e73 7562 6d69 7428 6e65  ecutor.submit(ne
-00016370: 7874 2c20 6765 6e65 7261 746f 7229 5d20  xt, generator)] 
-00016380: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-00016390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000163a0: 7374 6570 5f6e 616d 652c 0a20 2020 2020  step_name,.     
-000163b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000163c0: 2020 2020 2020 2067 656e 6572 6174 6f72         generator
-000163d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000163e0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000163f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016400: 6578 6365 7074 2053 746f 7049 7465 7261  except StopItera
-00016410: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
-00016420: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-00016430: 7373 0a0a 2020 2020 6465 6620 7472 616e  ss..    def tran
-00016440: 7366 6f72 6d28 0a20 2020 2020 2020 2073  sform(.        s
-00016450: 656c 662c 0a20 2020 2020 2020 2069 6e70  elf,.        inp
-00016460: 7574 3a20 4974 6572 6174 6f72 5b49 6e70  ut: Iterator[Inp
-00016470: 7574 5d2c 0a20 2020 2020 2020 2063 6f6e  ut],.        con
-00016480: 6669 673a 204f 7074 696f 6e61 6c5b 5275  fig: Optional[Ru
-00016490: 6e6e 6162 6c65 436f 6e66 6967 5d20 3d20  nnableConfig] = 
-000164a0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2a2a  None,.        **
-000164b0: 6b77 6172 6773 3a20 416e 792c 0a20 2020  kwargs: Any,.   
-000164c0: 2029 202d 3e20 4974 6572 6174 6f72 5b44   ) -> Iterator[D
-000164d0: 6963 745b 7374 722c 2041 6e79 5d5d 3a0a  ict[str, Any]]:.
-000164e0: 2020 2020 2020 2020 7969 656c 6420 6672          yield fr
-000164f0: 6f6d 2073 656c 662e 5f74 7261 6e73 666f  om self._transfo
-00016500: 726d 5f73 7472 6561 6d5f 7769 7468 5f63  rm_stream_with_c
-00016510: 6f6e 6669 6728 0a20 2020 2020 2020 2020  onfig(.         
-00016520: 2020 2069 6e70 7574 2c20 7365 6c66 2e5f     input, self._
-00016530: 7472 616e 7366 6f72 6d2c 2063 6f6e 6669  transform, confi
-00016540: 672c 202a 2a6b 7761 7267 730a 2020 2020  g, **kwargs.    
-00016550: 2020 2020 290a 0a20 2020 2064 6566 2073      )..    def s
-00016560: 7472 6561 6d28 0a20 2020 2020 2020 2073  tream(.        s
-00016570: 656c 662c 0a20 2020 2020 2020 2069 6e70  elf,.        inp
-00016580: 7574 3a20 496e 7075 742c 0a20 2020 2020  ut: Input,.     
-00016590: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
-000165a0: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-000165b0: 6967 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ig] = None,.    
-000165c0: 2020 2020 2a2a 6b77 6172 6773 3a20 4f70      **kwargs: Op
-000165d0: 7469 6f6e 616c 5b41 6e79 5d2c 0a20 2020  tional[Any],.   
-000165e0: 2029 202d 3e20 4974 6572 6174 6f72 5b44   ) -> Iterator[D
-000165f0: 6963 745b 7374 722c 2041 6e79 5d5d 3a0a  ict[str, Any]]:.
-00016600: 2020 2020 2020 2020 7969 656c 6420 6672          yield fr
-00016610: 6f6d 2073 656c 662e 7472 616e 7366 6f72  om self.transfor
-00016620: 6d28 6974 6572 285b 696e 7075 745d 292c  m(iter([input]),
-00016630: 2063 6f6e 6669 6729 0a0a 2020 2020 6173   config)..    as
-00016640: 796e 6320 6465 6620 5f61 7472 616e 7366  ync def _atransf
-00016650: 6f72 6d28 0a20 2020 2020 2020 2073 656c  orm(.        sel
-00016660: 662c 0a20 2020 2020 2020 2069 6e70 7574  f,.        input
-00016670: 3a20 4173 796e 6349 7465 7261 746f 725b  : AsyncIterator[
-00016680: 496e 7075 745d 2c0a 2020 2020 2020 2020  Input],.        
-00016690: 7275 6e5f 6d61 6e61 6765 723a 2041 7379  run_manager: Asy
-000166a0: 6e63 4361 6c6c 6261 636b 4d61 6e61 6765  ncCallbackManage
-000166b0: 7246 6f72 4368 6169 6e52 756e 2c0a 2020  rForChainRun,.  
-000166c0: 2020 2020 2020 636f 6e66 6967 3a20 5275        config: Ru
-000166d0: 6e6e 6162 6c65 436f 6e66 6967 2c0a 2020  nnableConfig,.  
-000166e0: 2020 2920 2d3e 2041 7379 6e63 4974 6572    ) -> AsyncIter
-000166f0: 6174 6f72 5b41 6464 6162 6c65 4469 6374  ator[AddableDict
-00016700: 5d3a 0a20 2020 2020 2020 2023 2053 6861  ]:.        # Sha
-00016710: 6c6c 6f77 2063 6f70 7920 7374 6570 7320  llow copy steps 
-00016720: 746f 2069 676e 6f72 6520 6d75 7461 7469  to ignore mutati
-00016730: 6f6e 7320 7768 696c 6520 696e 2070 726f  ons while in pro
-00016740: 6772 6573 730a 2020 2020 2020 2020 7374  gress.        st
-00016750: 6570 7320 3d20 6469 6374 2873 656c 662e  eps = dict(self.
-00016760: 7374 6570 7329 0a20 2020 2020 2020 2023  steps).        #
-00016770: 2045 6163 6820 7374 6570 2067 6574 7320   Each step gets 
-00016780: 6120 636f 7079 206f 6620 7468 6520 696e  a copy of the in
-00016790: 7075 7420 6974 6572 6174 6f72 2c0a 2020  put iterator,.  
-000167a0: 2020 2020 2020 2320 7768 6963 6820 6973        # which is
-000167b0: 2063 6f6e 7375 6d65 6420 696e 2070 6172   consumed in par
-000167c0: 616c 6c65 6c20 696e 2061 2073 6570 6172  allel in a separ
-000167d0: 6174 6520 7468 7265 6164 2e0a 2020 2020  ate thread..    
-000167e0: 2020 2020 696e 7075 745f 636f 7069 6573      input_copies
-000167f0: 203d 206c 6973 7428 6174 6565 2869 6e70   = list(atee(inp
-00016800: 7574 2c20 6c65 6e28 7374 6570 7329 2c20  ut, len(steps), 
-00016810: 6c6f 636b 3d61 7379 6e63 696f 2e4c 6f63  lock=asyncio.Loc
-00016820: 6b28 2929 290a 2020 2020 2020 2020 2320  k())).        # 
-00016830: 4372 6561 7465 2074 6865 2074 7261 6e73  Create the trans
-00016840: 666f 726d 2829 2067 656e 6572 6174 6f72  form() generator
-00016850: 2066 6f72 2065 6163 6820 7374 6570 0a20   for each step. 
-00016860: 2020 2020 2020 206e 616d 6564 5f67 656e         named_gen
-00016870: 6572 6174 6f72 7320 3d20 5b0a 2020 2020  erators = [.    
-00016880: 2020 2020 2020 2020 280a 2020 2020 2020          (.      
-00016890: 2020 2020 2020 2020 2020 6e61 6d65 2c0a            name,.
-000168a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000168b0: 7374 6570 2e61 7472 616e 7366 6f72 6d28  step.atransform(
+00014650: 6974 2773 2061 2064 6963 7420 6173 2065  it's a dict as e
+00014660: 7870 6563 7465 640a 2020 2020 2020 2020  xpected.        
+00014670: 2020 2020 7265 7475 726e 2063 7265 6174      return creat
+00014680: 655f 6d6f 6465 6c28 2020 2320 7479 7065  e_model(  # type
+00014690: 3a20 6967 6e6f 7265 5b63 616c 6c2d 6f76  : ignore[call-ov
+000146a0: 6572 6c6f 6164 5d0a 2020 2020 2020 2020  erload].        
+000146b0: 2020 2020 2020 2020 2252 756e 6e61 626c          "Runnabl
+000146c0: 6553 6571 7565 6e63 654f 7574 7075 7422  eSequenceOutput"
+000146d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000146e0: 2020 2a2a 7b0a 2020 2020 2020 2020 2020    **{.          
+000146f0: 2020 2020 2020 2020 2020 2a2a 7b0a 2020            **{.  
+00014700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014710: 2020 2020 2020 6b3a 2028 762e 616e 6e6f        k: (v.anno
+00014720: 7461 7469 6f6e 2c20 762e 6465 6661 756c  tation, v.defaul
+00014730: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+00014740: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+00014750: 2c20 7620 696e 2070 7265 765f 6f75 7470  , v in prev_outp
+00014760: 7574 5f73 6368 656d 612e 5f5f 6669 656c  ut_schema.__fiel
+00014770: 6473 5f5f 2e69 7465 6d73 2829 0a20 2020  ds__.items().   
+00014780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014790: 207d 2c0a 2020 2020 2020 2020 2020 2020   },.            
+000147a0: 2020 2020 2020 2020 2a2a 7b0a 2020 2020          **{.    
+000147b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000147c0: 2020 2020 6b3a 2028 762e 616e 6e6f 7461      k: (v.annota
+000147d0: 7469 6f6e 2c20 762e 6465 6661 756c 7429  tion, v.default)
+000147e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000147f0: 2020 2020 2020 2020 2066 6f72 206b 2c20           for k, 
+00014800: 7620 696e 206d 6170 7065 725f 6f75 7470  v in mapper_outp
+00014810: 7574 5f73 6368 656d 612e 5f5f 6669 656c  ut_schema.__fiel
+00014820: 6473 5f5f 2e69 7465 6d73 2829 0a20 2020  ds__.items().   
+00014830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014840: 207d 2c0a 2020 2020 2020 2020 2020 2020   },.            
+00014850: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
+00014860: 2020 2029 0a20 2020 2065 6c69 6620 6973     ).    elif is
+00014870: 696e 7374 616e 6365 286c 6173 742c 2052  instance(last, R
+00014880: 756e 6e61 626c 6550 6963 6b29 3a0a 2020  unnablePick):.  
+00014890: 2020 2020 2020 7072 6576 5f6f 7574 7075        prev_outpu
+000148a0: 745f 7363 6865 6d61 203d 205f 7365 715f  t_schema = _seq_
+000148b0: 6f75 7470 7574 5f73 6368 656d 6128 7374  output_schema(st
+000148c0: 6570 735b 3a2d 315d 2c20 636f 6e66 6967  eps[:-1], config
+000148d0: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+000148e0: 2070 7265 765f 6f75 7470 7574 5f73 6368   prev_output_sch
+000148f0: 656d 612e 5f5f 6375 7374 6f6d 5f72 6f6f  ema.__custom_roo
+00014900: 745f 7479 7065 5f5f 3a0a 2020 2020 2020  t_type__:.      
+00014910: 2020 2020 2020 2320 6974 2773 2061 2064        # it's a d
+00014920: 6963 7420 6173 2065 7870 6563 7465 640a  ict as expected.
+00014930: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00014940: 7369 6e73 7461 6e63 6528 6c61 7374 2e6b  sinstance(last.k
+00014950: 6579 732c 206c 6973 7429 3a0a 2020 2020  eys, list):.    
+00014960: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00014970: 726e 2063 7265 6174 655f 6d6f 6465 6c28  rn create_model(
+00014980: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
+00014990: 5b63 616c 6c2d 6f76 6572 6c6f 6164 5d0a  [call-overload].
+000149a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000149b0: 2020 2020 2252 756e 6e61 626c 6553 6571      "RunnableSeq
+000149c0: 7565 6e63 654f 7574 7075 7422 2c0a 2020  uenceOutput",.  
+000149d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000149e0: 2020 2a2a 7b0a 2020 2020 2020 2020 2020    **{.          
+000149f0: 2020 2020 2020 2020 2020 2020 2020 6b3a                k:
+00014a00: 2028 762e 616e 6e6f 7461 7469 6f6e 2c20   (v.annotation, 
+00014a10: 762e 6465 6661 756c 7429 0a20 2020 2020  v.default).     
+00014a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a30: 2020 2066 6f72 206b 2c20 7620 696e 2070     for k, v in p
+00014a40: 7265 765f 6f75 7470 7574 5f73 6368 656d  rev_output_schem
+00014a50: 612e 5f5f 6669 656c 6473 5f5f 2e69 7465  a.__fields__.ite
+00014a60: 6d73 2829 0a20 2020 2020 2020 2020 2020  ms().           
+00014a70: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00014a80: 6b20 696e 206c 6173 742e 6b65 7973 0a20  k in last.keys. 
+00014a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014aa0: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
+00014ab0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00014ac0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00014ad0: 2020 2020 2020 2020 2020 6669 656c 6420            field 
+00014ae0: 3d20 7072 6576 5f6f 7574 7075 745f 7363  = prev_output_sc
+00014af0: 6865 6d61 2e5f 5f66 6965 6c64 735f 5f5b  hema.__fields__[
+00014b00: 6c61 7374 2e6b 6579 735d 0a20 2020 2020  last.keys].     
+00014b10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00014b20: 6e20 6372 6561 7465 5f6d 6f64 656c 2820  n create_model( 
+00014b30: 2023 2074 7970 653a 2069 676e 6f72 655b   # type: ignore[
+00014b40: 6361 6c6c 2d6f 7665 726c 6f61 645d 0a20  call-overload]. 
+00014b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014b60: 2020 2022 5275 6e6e 6162 6c65 5365 7175     "RunnableSequ
+00014b70: 656e 6365 4f75 7470 7574 222c 0a20 2020  enceOutput",.   
+00014b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014b90: 205f 5f72 6f6f 745f 5f3d 2866 6965 6c64   __root__=(field
+00014ba0: 2e61 6e6e 6f74 6174 696f 6e2c 2066 6965  .annotation, fie
+00014bb0: 6c64 2e64 6566 6175 6c74 292c 0a20 2020  ld.default),.   
+00014bc0: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+00014bd0: 2020 2020 7265 7475 726e 206c 6173 742e      return last.
+00014be0: 6765 745f 6f75 7470 7574 5f73 6368 656d  get_output_schem
+00014bf0: 6128 636f 6e66 6967 290a 0a0a 636c 6173  a(config)...clas
+00014c00: 7320 5275 6e6e 6162 6c65 5365 7175 656e  s RunnableSequen
+00014c10: 6365 2852 756e 6e61 626c 6553 6572 6961  ce(RunnableSeria
+00014c20: 6c69 7a61 626c 655b 496e 7075 742c 204f  lizable[Input, O
+00014c30: 7574 7075 745d 293a 0a20 2020 2022 2222  utput]):.    """
+00014c40: 5365 7175 656e 6365 206f 6620 5275 6e6e  Sequence of Runn
+00014c50: 6162 6c65 732c 2077 6865 7265 2074 6865  ables, where the
+00014c60: 206f 7574 7075 7420 6f66 2065 6163 6820   output of each 
+00014c70: 6973 2074 6865 2069 6e70 7574 206f 6620  is the input of 
+00014c80: 7468 6520 6e65 7874 2e0a 0a20 2020 2052  the next...    R
+00014c90: 756e 6e61 626c 6553 6571 7565 6e63 6520  unnableSequence 
+00014ca0: 6973 2074 6865 206d 6f73 7420 696d 706f  is the most impo
+00014cb0: 7274 616e 7420 636f 6d70 6f73 6974 696f  rtant compositio
+00014cc0: 6e20 6f70 6572 6174 6f72 2069 6e20 4c61  n operator in La
+00014cd0: 6e67 4368 6169 6e20 6173 2069 7420 6973  ngChain as it is
+00014ce0: 0a20 2020 2075 7365 6420 696e 2076 6972  .    used in vir
+00014cf0: 7475 616c 6c79 2065 7665 7279 2063 6861  tually every cha
+00014d00: 696e 2e0a 0a20 2020 2041 2052 756e 6e61  in...    A Runna
+00014d10: 626c 6553 6571 7565 6e63 6520 6361 6e20  bleSequence can 
+00014d20: 6265 2069 6e73 7461 6e74 6961 7465 6420  be instantiated 
+00014d30: 6469 7265 6374 6c79 206f 7220 6d6f 7265  directly or more
+00014d40: 2063 6f6d 6d6f 6e6c 7920 6279 2075 7369   commonly by usi
+00014d50: 6e67 2074 6865 2060 7c60 0a20 2020 206f  ng the `|`.    o
+00014d60: 7065 7261 746f 7220 7768 6572 6520 6569  perator where ei
+00014d70: 7468 6572 2074 6865 206c 6566 7420 6f72  ther the left or
+00014d80: 2072 6967 6874 206f 7065 7261 6e64 7320   right operands 
+00014d90: 286f 7220 626f 7468 2920 6d75 7374 2062  (or both) must b
+00014da0: 6520 6120 5275 6e6e 6162 6c65 2e0a 0a20  e a Runnable... 
+00014db0: 2020 2041 6e79 2052 756e 6e61 626c 6553     Any RunnableS
+00014dc0: 6571 7565 6e63 6520 6175 746f 6d61 7469  equence automati
+00014dd0: 6361 6c6c 7920 7375 7070 6f72 7473 2073  cally supports s
+00014de0: 796e 632c 2061 7379 6e63 2c20 6261 7463  ync, async, batc
+00014df0: 682e 0a0a 2020 2020 5468 6520 6465 6661  h...    The defa
+00014e00: 756c 7420 696d 706c 656d 656e 7461 7469  ult implementati
+00014e10: 6f6e 7320 6f66 2060 6261 7463 6860 2061  ons of `batch` a
+00014e20: 6e64 2060 6162 6174 6368 6020 7574 696c  nd `abatch` util
+00014e30: 697a 6520 7468 7265 6164 706f 6f6c 7320  ize threadpools 
+00014e40: 616e 640a 2020 2020 6173 796e 6369 6f20  and.    asyncio 
+00014e50: 6761 7468 6572 2061 6e64 2077 696c 6c20  gather and will 
+00014e60: 6265 2066 6173 7465 7220 7468 616e 206e  be faster than n
+00014e70: 6169 7665 2069 6e76 6f63 6174 696f 6e20  aive invocation 
+00014e80: 6f66 2069 6e76 6f6b 6520 6f72 2061 696e  of invoke or ain
+00014e90: 766f 6b65 0a20 2020 2066 6f72 2049 4f20  voke.    for IO 
+00014ea0: 626f 756e 6420 5275 6e6e 6162 6c65 732e  bound Runnables.
+00014eb0: 0a0a 2020 2020 4261 7463 6869 6e67 2069  ..    Batching i
+00014ec0: 7320 696d 706c 656d 656e 7465 6420 6279  s implemented by
+00014ed0: 2069 6e76 6f6b 696e 6720 7468 6520 6261   invoking the ba
+00014ee0: 7463 6820 6d65 7468 6f64 206f 6e20 6561  tch method on ea
+00014ef0: 6368 2063 6f6d 706f 6e65 6e74 206f 6620  ch component of 
+00014f00: 7468 650a 2020 2020 5275 6e6e 6162 6c65  the.    Runnable
+00014f10: 5365 7175 656e 6365 2069 6e20 6f72 6465  Sequence in orde
+00014f20: 722e 0a0a 2020 2020 4120 5275 6e6e 6162  r...    A Runnab
+00014f30: 6c65 5365 7175 656e 6365 2070 7265 7365  leSequence prese
+00014f40: 7276 6573 2074 6865 2073 7472 6561 6d69  rves the streami
+00014f50: 6e67 2070 726f 7065 7274 6965 7320 6f66  ng properties of
+00014f60: 2069 7473 2063 6f6d 706f 6e65 6e74 732c   its components,
+00014f70: 2073 6f20 6966 2061 6c6c 0a20 2020 2063   so if all.    c
+00014f80: 6f6d 706f 6e65 6e74 7320 6f66 2074 6865  omponents of the
+00014f90: 2073 6571 7565 6e63 6520 696d 706c 656d   sequence implem
+00014fa0: 656e 7420 6120 6074 7261 6e73 666f 726d  ent a `transform
+00014fb0: 6020 6d65 7468 6f64 202d 2d20 7768 6963  ` method -- whic
+00014fc0: 680a 2020 2020 6973 2074 6865 206d 6574  h.    is the met
+00014fd0: 686f 6420 7468 6174 2069 6d70 6c65 6d65  hod that impleme
+00014fe0: 6e74 7320 7468 6520 6c6f 6769 6320 746f  nts the logic to
+00014ff0: 206d 6170 2061 2073 7472 6561 6d69 6e67   map a streaming
+00015000: 2069 6e70 7574 2074 6f20 6120 7374 7265   input to a stre
+00015010: 616d 696e 670a 2020 2020 6f75 7470 7574  aming.    output
+00015020: 202d 2d20 7468 656e 2074 6865 2073 6571   -- then the seq
+00015030: 7565 6e63 6520 7769 6c6c 2062 6520 6162  uence will be ab
+00015040: 6c65 2074 6f20 7374 7265 616d 2069 6e70  le to stream inp
+00015050: 7574 2074 6f20 6f75 7470 7574 210a 0a20  ut to output!.. 
+00015060: 2020 2049 6620 616e 7920 636f 6d70 6f6e     If any compon
+00015070: 656e 7420 6f66 2074 6865 2073 6571 7565  ent of the seque
+00015080: 6e63 6520 646f 6573 206e 6f74 2069 6d70  nce does not imp
+00015090: 6c65 6d65 6e74 2074 7261 6e73 666f 726d  lement transform
+000150a0: 2074 6865 6e20 7468 650a 2020 2020 7374   then the.    st
+000150b0: 7265 616d 696e 6720 7769 6c6c 206f 6e6c  reaming will onl
+000150c0: 7920 6265 6769 6e20 6166 7465 7220 7468  y begin after th
+000150d0: 6973 2063 6f6d 706f 6e65 6e74 2069 7320  is component is 
+000150e0: 7275 6e2e 2049 6620 7468 6572 6520 6172  run. If there ar
+000150f0: 650a 2020 2020 6d75 6c74 6970 6c65 2062  e.    multiple b
+00015100: 6c6f 636b 696e 6720 636f 6d70 6f6e 656e  locking componen
+00015110: 7473 2c20 7374 7265 616d 696e 6720 6265  ts, streaming be
+00015120: 6769 6e73 2061 6674 6572 2074 6865 206c  gins after the l
+00015130: 6173 7420 6f6e 652e 0a0a 2020 2020 506c  ast one...    Pl
+00015140: 6561 7365 206e 6f74 653a 2052 756e 6e61  ease note: Runna
+00015150: 626c 654c 616d 6264 6173 2064 6f20 6e6f  bleLambdas do no
+00015160: 7420 7375 7070 6f72 7420 6074 7261 6e73  t support `trans
+00015170: 666f 726d 6020 6279 2064 6566 6175 6c74  form` by default
+00015180: 2120 536f 2069 660a 2020 2020 2020 2020  ! So if.        
+00015190: 796f 7520 6e65 6564 2074 6f20 7573 6520  you need to use 
+000151a0: 6120 5275 6e6e 6162 6c65 4c61 6d62 6461  a RunnableLambda
+000151b0: 7320 6265 2063 6172 6566 756c 2061 626f  s be careful abo
+000151c0: 7574 2077 6865 7265 2079 6f75 2070 6c61  ut where you pla
+000151d0: 6365 2074 6865 6d20 696e 2061 0a20 2020  ce them in a.   
+000151e0: 2020 2020 2052 756e 6e61 626c 6553 6571       RunnableSeq
+000151f0: 7565 6e63 6520 2869 6620 796f 7520 6e65  uence (if you ne
+00015200: 6564 2074 6f20 7573 6520 7468 6520 2e73  ed to use the .s
+00015210: 7472 6561 6d28 292f 2e61 7374 7265 616d  tream()/.astream
+00015220: 2829 206d 6574 686f 6473 292e 0a0a 2020  () methods)...  
+00015230: 2020 2020 2020 4966 2079 6f75 206e 6565        If you nee
+00015240: 6420 6172 6269 7472 6172 7920 6c6f 6769  d arbitrary logi
+00015250: 6320 616e 6420 6e65 6564 2073 7472 6561  c and need strea
+00015260: 6d69 6e67 2c20 796f 7520 6361 6e20 7375  ming, you can su
+00015270: 6263 6c61 7373 0a20 2020 2020 2020 2052  bclass.        R
+00015280: 756e 6e61 626c 652c 2061 6e64 2069 6d70  unnable, and imp
+00015290: 6c65 6d65 6e74 2060 7472 616e 7366 6f72  lement `transfor
+000152a0: 6d60 2066 6f72 2077 6861 7465 7665 7220  m` for whatever 
+000152b0: 6c6f 6769 6320 796f 7520 6e65 6564 2e0a  logic you need..
+000152c0: 0a20 2020 2048 6572 6520 6973 2061 2073  .    Here is a s
+000152d0: 696d 706c 6520 6578 616d 706c 6520 7468  imple example th
+000152e0: 6174 2075 7365 7320 7369 6d70 6c65 2066  at uses simple f
+000152f0: 756e 6374 696f 6e73 2074 6f20 696c 6c75  unctions to illu
+00015300: 7374 7261 7465 2074 6865 2075 7365 206f  strate the use o
+00015310: 660a 2020 2020 5275 6e6e 6162 6c65 5365  f.    RunnableSe
+00015320: 7175 656e 6365 3a0a 0a20 2020 2020 2020  quence:..       
+00015330: 202e 2e20 636f 6465 2d62 6c6f 636b 3a3a   .. code-block::
+00015340: 2070 7974 686f 6e0a 0a20 2020 2020 2020   python..       
+00015350: 2020 2020 2066 726f 6d20 6c61 6e67 6368       from langch
+00015360: 6169 6e5f 636f 7265 2e72 756e 6e61 626c  ain_core.runnabl
+00015370: 6573 2069 6d70 6f72 7420 5275 6e6e 6162  es import Runnab
+00015380: 6c65 4c61 6d62 6461 0a0a 2020 2020 2020  leLambda..      
+00015390: 2020 2020 2020 6465 6620 6164 645f 6f6e        def add_on
+000153a0: 6528 783a 2069 6e74 2920 2d3e 2069 6e74  e(x: int) -> int
+000153b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000153c0: 2020 7265 7475 726e 2078 202b 2031 0a0a    return x + 1..
+000153d0: 2020 2020 2020 2020 2020 2020 6465 6620              def 
+000153e0: 6d75 6c5f 7477 6f28 783a 2069 6e74 2920  mul_two(x: int) 
+000153f0: 2d3e 2069 6e74 3a0a 2020 2020 2020 2020  -> int:.        
+00015400: 2020 2020 2020 2020 7265 7475 726e 2078          return x
+00015410: 202a 2032 0a0a 2020 2020 2020 2020 2020   * 2..          
+00015420: 2020 7275 6e6e 6162 6c65 5f31 203d 2052    runnable_1 = R
+00015430: 756e 6e61 626c 654c 616d 6264 6128 6164  unnableLambda(ad
+00015440: 645f 6f6e 6529 0a20 2020 2020 2020 2020  d_one).         
+00015450: 2020 2072 756e 6e61 626c 655f 3220 3d20     runnable_2 = 
+00015460: 5275 6e6e 6162 6c65 4c61 6d62 6461 286d  RunnableLambda(m
+00015470: 756c 5f74 776f 290a 2020 2020 2020 2020  ul_two).        
+00015480: 2020 2020 7365 7175 656e 6365 203d 2072      sequence = r
+00015490: 756e 6e61 626c 655f 3120 7c20 7275 6e6e  unnable_1 | runn
+000154a0: 6162 6c65 5f32 0a20 2020 2020 2020 2020  able_2.         
+000154b0: 2020 2023 204f 7220 6571 7569 7661 6c65     # Or equivale
+000154c0: 6e74 6c79 3a0a 2020 2020 2020 2020 2020  ntly:.          
+000154d0: 2020 2320 7365 7175 656e 6365 203d 2052    # sequence = R
+000154e0: 756e 6e61 626c 6553 6571 7565 6e63 6528  unnableSequence(
+000154f0: 6669 7273 743d 7275 6e6e 6162 6c65 5f31  first=runnable_1
+00015500: 2c20 6c61 7374 3d72 756e 6e61 626c 655f  , last=runnable_
+00015510: 3229 0a20 2020 2020 2020 2020 2020 2073  2).            s
+00015520: 6571 7565 6e63 652e 696e 766f 6b65 2831  equence.invoke(1
+00015530: 290a 2020 2020 2020 2020 2020 2020 6177  ).            aw
+00015540: 6169 7420 7365 7175 656e 6365 2e61 696e  ait sequence.ain
+00015550: 766f 6b65 2831 290a 0a20 2020 2020 2020  voke(1)..       
+00015560: 2020 2020 2073 6571 7565 6e63 652e 6261       sequence.ba
+00015570: 7463 6828 5b31 2c20 322c 2033 5d29 0a20  tch([1, 2, 3]). 
+00015580: 2020 2020 2020 2020 2020 2061 7761 6974             await
+00015590: 2073 6571 7565 6e63 652e 6162 6174 6368   sequence.abatch
+000155a0: 285b 312c 2032 2c20 335d 290a 0a20 2020  ([1, 2, 3])..   
+000155b0: 2048 6572 6527 7320 616e 2065 7861 6d70   Here's an examp
+000155c0: 6c65 2074 6861 7420 7573 6573 2073 7472  le that uses str
+000155d0: 6561 6d73 204a 534f 4e20 6f75 7470 7574  eams JSON output
+000155e0: 2067 656e 6572 6174 6564 2062 7920 616e   generated by an
+000155f0: 204c 4c4d 3a0a 0a20 2020 2020 2020 202e   LLM:..        .
+00015600: 2e20 636f 6465 2d62 6c6f 636b 3a3a 2070  . code-block:: p
+00015610: 7974 686f 6e0a 0a20 2020 2020 2020 2020  ython..         
+00015620: 2020 2066 726f 6d20 6c61 6e67 6368 6169     from langchai
+00015630: 6e5f 636f 7265 2e6f 7574 7075 745f 7061  n_core.output_pa
+00015640: 7273 6572 732e 6a73 6f6e 2069 6d70 6f72  rsers.json impor
+00015650: 7420 5369 6d70 6c65 4a73 6f6e 4f75 7470  t SimpleJsonOutp
+00015660: 7574 5061 7273 6572 0a20 2020 2020 2020  utParser.       
+00015670: 2020 2020 2066 726f 6d20 6c61 6e67 6368       from langch
+00015680: 6169 6e5f 6f70 656e 6169 2069 6d70 6f72  ain_openai impor
+00015690: 7420 4368 6174 4f70 656e 4149 0a0a 2020  t ChatOpenAI..  
+000156a0: 2020 2020 2020 2020 2020 7072 6f6d 7074            prompt
+000156b0: 203d 2050 726f 6d70 7454 656d 706c 6174   = PromptTemplat
+000156c0: 652e 6672 6f6d 5f74 656d 706c 6174 6528  e.from_template(
+000156d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000156e0: 2027 496e 204a 534f 4e20 666f 726d 6174   'In JSON format
+000156f0: 2c20 6769 7665 206d 6520 6120 6c69 7374  , give me a list
+00015700: 206f 6620 7b74 6f70 6963 7d20 616e 6420   of {topic} and 
+00015710: 7468 6569 7220 270a 2020 2020 2020 2020  their '.        
+00015720: 2020 2020 2020 2020 2763 6f72 7265 7370          'corresp
+00015730: 6f6e 6469 6e67 206e 616d 6573 2069 6e20  onding names in 
+00015740: 4672 656e 6368 2c20 5370 616e 6973 6820  French, Spanish 
+00015750: 616e 6420 696e 2061 2027 0a20 2020 2020  and in a '.     
+00015760: 2020 2020 2020 2020 2020 2027 4361 7420             'Cat 
+00015770: 4c61 6e67 7561 6765 2e27 0a20 2020 2020  Language.'.     
+00015780: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00015790: 2020 2020 2020 6d6f 6465 6c20 3d20 4368        model = Ch
+000157a0: 6174 4f70 656e 4149 2829 0a20 2020 2020  atOpenAI().     
+000157b0: 2020 2020 2020 2063 6861 696e 203d 2070         chain = p
+000157c0: 726f 6d70 7420 7c20 6d6f 6465 6c20 7c20  rompt | model | 
+000157d0: 5369 6d70 6c65 4a73 6f6e 4f75 7470 7574  SimpleJsonOutput
+000157e0: 5061 7273 6572 2829 0a0a 2020 2020 2020  Parser()..      
+000157f0: 2020 2020 2020 6173 796e 6320 666f 7220        async for 
+00015800: 6368 756e 6b20 696e 2063 6861 696e 2e61  chunk in chain.a
+00015810: 7374 7265 616d 287b 2774 6f70 6963 273a  stream({'topic':
+00015820: 2027 636f 6c6f 7273 277d 293a 0a20 2020   'colors'}):.   
+00015830: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00015840: 6e74 2827 2d27 2920 2023 206e 6f71 613a  nt('-')  # noqa:
+00015850: 2054 3230 310a 2020 2020 2020 2020 2020   T201.          
+00015860: 2020 2020 2020 7072 696e 7428 6368 756e        print(chun
+00015870: 6b2c 2073 6570 3d27 272c 2066 6c75 7368  k, sep='', flush
+00015880: 3d54 7275 6529 2020 2320 6e6f 7161 3a20  =True)  # noqa: 
+00015890: 5432 3031 0a20 2020 2022 2222 0a0a 2020  T201.    """..  
+000158a0: 2020 2320 5468 6520 7374 6570 7320 6172    # The steps ar
+000158b0: 6520 6272 6f6b 656e 2069 6e74 6f20 6669  e broken into fi
+000158c0: 7273 742c 206d 6964 646c 6520 616e 6420  rst, middle and 
+000158d0: 6c61 7374 2c20 736f 6c65 6c79 2066 6f72  last, solely for
+000158e0: 2074 7970 6520 6368 6563 6b69 6e67 0a20   type checking. 
+000158f0: 2020 2023 2070 7572 706f 7365 732e 2049     # purposes. I
+00015900: 7420 616c 6c6f 7773 2073 7065 6369 6679  t allows specify
+00015910: 696e 6720 7468 6520 6049 6e70 7574 6020  ing the `Input` 
+00015920: 6f6e 2074 6865 2066 6972 7374 2074 7970  on the first typ
+00015930: 652c 2074 6865 2060 4f75 7470 7574 6020  e, the `Output` 
+00015940: 6f66 0a20 2020 2023 2074 6865 206c 6173  of.    # the las
+00015950: 7420 7479 7065 2e0a 2020 2020 6669 7273  t type..    firs
+00015960: 743a 2052 756e 6e61 626c 655b 496e 7075  t: Runnable[Inpu
+00015970: 742c 2041 6e79 5d0a 2020 2020 2222 2254  t, Any].    """T
+00015980: 6865 2066 6972 7374 2072 756e 6e61 626c  he first runnabl
+00015990: 6520 696e 2074 6865 2073 6571 7565 6e63  e in the sequenc
+000159a0: 652e 2222 220a 2020 2020 6d69 6464 6c65  e.""".    middle
+000159b0: 3a20 4c69 7374 5b52 756e 6e61 626c 655b  : List[Runnable[
+000159c0: 416e 792c 2041 6e79 5d5d 203d 2046 6965  Any, Any]] = Fie
+000159d0: 6c64 2864 6566 6175 6c74 5f66 6163 746f  ld(default_facto
+000159e0: 7279 3d6c 6973 7429 0a20 2020 2022 2222  ry=list).    """
+000159f0: 5468 6520 6d69 6464 6c65 2072 756e 6e61  The middle runna
+00015a00: 626c 6573 2069 6e20 7468 6520 7365 7175  bles in the sequ
+00015a10: 656e 6365 2e22 2222 0a20 2020 206c 6173  ence.""".    las
+00015a20: 743a 2052 756e 6e61 626c 655b 416e 792c  t: Runnable[Any,
+00015a30: 204f 7574 7075 745d 0a20 2020 2022 2222   Output].    """
+00015a40: 5468 6520 6c61 7374 2072 756e 6e61 626c  The last runnabl
+00015a50: 6520 696e 2074 6865 2073 6571 7565 6e63  e in the sequenc
+00015a60: 652e 2222 220a 0a20 2020 2064 6566 205f  e."""..    def _
+00015a70: 5f69 6e69 745f 5f28 0a20 2020 2020 2020  _init__(.       
+00015a80: 2073 656c 662c 0a20 2020 2020 2020 202a   self,.        *
+00015a90: 7374 6570 733a 2052 756e 6e61 626c 654c  steps: RunnableL
+00015aa0: 696b 652c 0a20 2020 2020 2020 206e 616d  ike,.        nam
+00015ab0: 653a 204f 7074 696f 6e61 6c5b 7374 725d  e: Optional[str]
+00015ac0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00015ad0: 2066 6972 7374 3a20 4f70 7469 6f6e 616c   first: Optional
+00015ae0: 5b52 756e 6e61 626c 655b 416e 792c 2041  [Runnable[Any, A
+00015af0: 6e79 5d5d 203d 204e 6f6e 652c 0a20 2020  ny]] = None,.   
+00015b00: 2020 2020 206d 6964 646c 653a 204f 7074       middle: Opt
+00015b10: 696f 6e61 6c5b 4c69 7374 5b52 756e 6e61  ional[List[Runna
+00015b20: 626c 655b 416e 792c 2041 6e79 5d5d 5d20  ble[Any, Any]]] 
+00015b30: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00015b40: 6c61 7374 3a20 4f70 7469 6f6e 616c 5b52  last: Optional[R
+00015b50: 756e 6e61 626c 655b 416e 792c 2041 6e79  unnable[Any, Any
+00015b60: 5d5d 203d 204e 6f6e 652c 0a20 2020 2029  ]] = None,.    )
+00015b70: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00015b80: 2020 2222 2243 7265 6174 6520 6120 6e65    """Create a ne
+00015b90: 7720 5275 6e6e 6162 6c65 5365 7175 656e  w RunnableSequen
+00015ba0: 6365 2e0a 0a20 2020 2020 2020 2041 7267  ce...        Arg
+00015bb0: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
+00015bc0: 7465 7073 3a20 5468 6520 7374 6570 7320  teps: The steps 
+00015bd0: 746f 2069 6e63 6c75 6465 2069 6e20 7468  to include in th
+00015be0: 6520 7365 7175 656e 6365 2e0a 2020 2020  e sequence..    
+00015bf0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00015c00: 7374 6570 735f 666c 6174 3a20 4c69 7374  steps_flat: List
+00015c10: 5b52 756e 6e61 626c 655d 203d 205b 5d0a  [Runnable] = [].
+00015c20: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+00015c30: 7465 7073 3a0a 2020 2020 2020 2020 2020  teps:.          
+00015c40: 2020 6966 2066 6972 7374 2069 7320 6e6f    if first is no
+00015c50: 7420 4e6f 6e65 2061 6e64 206c 6173 7420  t None and last 
+00015c60: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00015c70: 2020 2020 2020 2020 2020 2020 2073 7465               ste
+00015c80: 7073 5f66 6c61 7420 3d20 5b66 6972 7374  ps_flat = [first
+00015c90: 5d20 2b20 286d 6964 646c 6520 6f72 205b  ] + (middle or [
+00015ca0: 5d29 202b 205b 6c61 7374 5d0a 2020 2020  ]) + [last].    
+00015cb0: 2020 2020 666f 7220 7374 6570 2069 6e20      for step in 
+00015cc0: 7374 6570 733a 0a20 2020 2020 2020 2020  steps:.         
+00015cd0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00015ce0: 2873 7465 702c 2052 756e 6e61 626c 6553  (step, RunnableS
+00015cf0: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
+00015d00: 2020 2020 2020 2020 2020 7374 6570 735f            steps_
+00015d10: 666c 6174 2e65 7874 656e 6428 7374 6570  flat.extend(step
+00015d20: 2e73 7465 7073 290a 2020 2020 2020 2020  .steps).        
+00015d30: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00015d40: 2020 2020 2020 2020 2020 7374 6570 735f            steps_
+00015d50: 666c 6174 2e61 7070 656e 6428 636f 6572  flat.append(coer
+00015d60: 6365 5f74 6f5f 7275 6e6e 6162 6c65 2873  ce_to_runnable(s
+00015d70: 7465 7029 290a 2020 2020 2020 2020 6966  tep)).        if
+00015d80: 206c 656e 2873 7465 7073 5f66 6c61 7429   len(steps_flat)
+00015d90: 203c 2032 3a0a 2020 2020 2020 2020 2020   < 2:.          
+00015da0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00015db0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00015dc0: 2020 2020 6622 5275 6e6e 6162 6c65 5365      f"RunnableSe
+00015dd0: 7175 656e 6365 206d 7573 7420 6861 7665  quence must have
+00015de0: 2061 7420 6c65 6173 7420 3220 7374 6570   at least 2 step
+00015df0: 732c 2067 6f74 207b 6c65 6e28 7374 6570  s, got {len(step
+00015e00: 735f 666c 6174 297d 220a 2020 2020 2020  s_flat)}".      
+00015e10: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00015e20: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
+00015e30: 2820 2023 2074 7970 653a 2069 676e 6f72  (  # type: ignor
+00015e40: 655b 6361 6c6c 2d61 7267 5d0a 2020 2020  e[call-arg].    
+00015e50: 2020 2020 2020 2020 6669 7273 743d 7374          first=st
+00015e60: 6570 735f 666c 6174 5b30 5d2c 0a20 2020  eps_flat[0],.   
+00015e70: 2020 2020 2020 2020 206d 6964 646c 653d           middle=
+00015e80: 6c69 7374 2873 7465 7073 5f66 6c61 745b  list(steps_flat[
+00015e90: 313a 2d31 5d29 2c0a 2020 2020 2020 2020  1:-1]),.        
+00015ea0: 2020 2020 6c61 7374 3d73 7465 7073 5f66      last=steps_f
+00015eb0: 6c61 745b 2d31 5d2c 0a20 2020 2020 2020  lat[-1],.       
+00015ec0: 2020 2020 206e 616d 653d 6e61 6d65 2c0a       name=name,.
+00015ed0: 2020 2020 2020 2020 290a 0a20 2020 2040          )..    @
+00015ee0: 636c 6173 736d 6574 686f 640a 2020 2020  classmethod.    
+00015ef0: 6465 6620 6765 745f 6c63 5f6e 616d 6573  def get_lc_names
+00015f00: 7061 6365 2863 6c73 2920 2d3e 204c 6973  pace(cls) -> Lis
+00015f10: 745b 7374 725d 3a0a 2020 2020 2020 2020  t[str]:.        
+00015f20: 2222 2247 6574 2074 6865 206e 616d 6573  """Get the names
+00015f30: 7061 6365 206f 6620 7468 6520 6c61 6e67  pace of the lang
+00015f40: 6368 6169 6e20 6f62 6a65 6374 2e22 2222  chain object."""
+00015f50: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00015f60: 5b22 6c61 6e67 6368 6169 6e22 2c20 2273  ["langchain", "s
+00015f70: 6368 656d 6122 2c20 2272 756e 6e61 626c  chema", "runnabl
+00015f80: 6522 5d0a 0a20 2020 2040 7072 6f70 6572  e"]..    @proper
+00015f90: 7479 0a20 2020 2064 6566 2073 7465 7073  ty.    def steps
+00015fa0: 2873 656c 6629 202d 3e20 4c69 7374 5b52  (self) -> List[R
+00015fb0: 756e 6e61 626c 655b 416e 792c 2041 6e79  unnable[Any, Any
+00015fc0: 5d5d 3a0a 2020 2020 2020 2020 2222 2241  ]]:.        """A
+00015fd0: 6c6c 2074 6865 2072 756e 6e61 626c 6573  ll the runnables
+00015fe0: 2074 6861 7420 6d61 6b65 2075 7020 7468   that make up th
+00015ff0: 6520 7365 7175 656e 6365 2069 6e20 6f72  e sequence in or
+00016000: 6465 722e 2222 220a 2020 2020 2020 2020  der.""".        
+00016010: 7265 7475 726e 205b 7365 6c66 2e66 6972  return [self.fir
+00016020: 7374 5d20 2b20 7365 6c66 2e6d 6964 646c  st] + self.middl
+00016030: 6520 2b20 5b73 656c 662e 6c61 7374 5d0a  e + [self.last].
+00016040: 0a20 2020 2040 636c 6173 736d 6574 686f  .    @classmetho
+00016050: 640a 2020 2020 6465 6620 6973 5f6c 635f  d.    def is_lc_
+00016060: 7365 7269 616c 697a 6162 6c65 2863 6c73  serializable(cls
+00016070: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
+00016080: 2020 2072 6574 7572 6e20 5472 7565 0a0a     return True..
+00016090: 2020 2020 636c 6173 7320 436f 6e66 6967      class Config
+000160a0: 3a0a 2020 2020 2020 2020 6172 6269 7472  :.        arbitr
+000160b0: 6172 795f 7479 7065 735f 616c 6c6f 7765  ary_types_allowe
+000160c0: 6420 3d20 5472 7565 0a0a 2020 2020 4070  d = True..    @p
+000160d0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+000160e0: 496e 7075 7454 7970 6528 7365 6c66 2920  InputType(self) 
+000160f0: 2d3e 2054 7970 655b 496e 7075 745d 3a0a  -> Type[Input]:.
+00016100: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00016110: 656c 662e 6669 7273 742e 496e 7075 7454  elf.first.InputT
+00016120: 7970 650a 0a20 2020 2040 7072 6f70 6572  ype..    @proper
+00016130: 7479 0a20 2020 2064 6566 204f 7574 7075  ty.    def Outpu
+00016140: 7454 7970 6528 7365 6c66 2920 2d3e 2054  tType(self) -> T
+00016150: 7970 655b 4f75 7470 7574 5d3a 0a20 2020  ype[Output]:.   
+00016160: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00016170: 2e6c 6173 742e 4f75 7470 7574 5479 7065  .last.OutputType
+00016180: 0a0a 2020 2020 6465 6620 6765 745f 696e  ..    def get_in
+00016190: 7075 745f 7363 6865 6d61 280a 2020 2020  put_schema(.    
+000161a0: 2020 2020 7365 6c66 2c20 636f 6e66 6967      self, config
+000161b0: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
+000161c0: 626c 6543 6f6e 6669 675d 203d 204e 6f6e  bleConfig] = Non
+000161d0: 650a 2020 2020 2920 2d3e 2054 7970 655b  e.    ) -> Type[
+000161e0: 4261 7365 4d6f 6465 6c5d 3a0a 2020 2020  BaseModel]:.    
+000161f0: 2020 2020 7265 7475 726e 205f 7365 715f      return _seq_
+00016200: 696e 7075 745f 7363 6865 6d61 2873 656c  input_schema(sel
+00016210: 662e 7374 6570 732c 2063 6f6e 6669 6729  f.steps, config)
+00016220: 0a0a 2020 2020 6465 6620 6765 745f 6f75  ..    def get_ou
+00016230: 7470 7574 5f73 6368 656d 6128 0a20 2020  tput_schema(.   
+00016240: 2020 2020 2073 656c 662c 2063 6f6e 6669       self, confi
+00016250: 673a 204f 7074 696f 6e61 6c5b 5275 6e6e  g: Optional[Runn
+00016260: 6162 6c65 436f 6e66 6967 5d20 3d20 4e6f  ableConfig] = No
+00016270: 6e65 0a20 2020 2029 202d 3e20 5479 7065  ne.    ) -> Type
+00016280: 5b42 6173 654d 6f64 656c 5d3a 0a20 2020  [BaseModel]:.   
+00016290: 2020 2020 2072 6574 7572 6e20 5f73 6571       return _seq
+000162a0: 5f6f 7574 7075 745f 7363 6865 6d61 2873  _output_schema(s
+000162b0: 656c 662e 7374 6570 732c 2063 6f6e 6669  elf.steps, confi
+000162c0: 6729 0a0a 2020 2020 4070 726f 7065 7274  g)..    @propert
+000162d0: 790a 2020 2020 6465 6620 636f 6e66 6967  y.    def config
+000162e0: 5f73 7065 6373 2873 656c 6629 202d 3e20  _specs(self) -> 
+000162f0: 4c69 7374 5b43 6f6e 6669 6775 7261 626c  List[Configurabl
+00016300: 6546 6965 6c64 5370 6563 5d3a 0a20 2020  eFieldSpec]:.   
+00016310: 2020 2020 2066 726f 6d20 6c61 6e67 6368       from langch
+00016320: 6169 6e5f 636f 7265 2e62 6574 612e 7275  ain_core.beta.ru
+00016330: 6e6e 6162 6c65 732e 636f 6e74 6578 7420  nnables.context 
+00016340: 696d 706f 7274 2028 0a20 2020 2020 2020  import (.       
+00016350: 2020 2020 2043 4f4e 5445 5854 5f43 4f4e       CONTEXT_CON
+00016360: 4649 475f 5052 4546 4958 2c0a 2020 2020  FIG_PREFIX,.    
+00016370: 2020 2020 2020 2020 5f6b 6579 5f66 726f          _key_fro
+00016380: 6d5f 6964 2c0a 2020 2020 2020 2020 290a  m_id,.        ).
+00016390: 0a20 2020 2020 2020 2023 2067 6574 2061  .        # get a
+000163a0: 6c6c 2073 7065 6373 0a20 2020 2020 2020  ll specs.       
+000163b0: 2061 6c6c 5f73 7065 6373 203d 205b 0a20   all_specs = [. 
+000163c0: 2020 2020 2020 2020 2020 2028 7370 6563             (spec
+000163d0: 2c20 6964 7829 0a20 2020 2020 2020 2020  , idx).         
+000163e0: 2020 2066 6f72 2069 6478 2c20 7374 6570     for idx, step
+000163f0: 2069 6e20 656e 756d 6572 6174 6528 7365   in enumerate(se
+00016400: 6c66 2e73 7465 7073 290a 2020 2020 2020  lf.steps).      
+00016410: 2020 2020 2020 666f 7220 7370 6563 2069        for spec i
+00016420: 6e20 7374 6570 2e63 6f6e 6669 675f 7370  n step.config_sp
+00016430: 6563 730a 2020 2020 2020 2020 5d0a 2020  ecs.        ].  
+00016440: 2020 2020 2020 2320 6361 6c63 756c 6174        # calculat
+00016450: 6520 636f 6e74 6578 7420 6465 7065 6e64  e context depend
+00016460: 656e 6369 6573 0a20 2020 2020 2020 2073  encies.        s
+00016470: 7065 6373 5f62 795f 706f 7320 3d20 6772  pecs_by_pos = gr
+00016480: 6f75 7062 7928 0a20 2020 2020 2020 2020  oupby(.         
+00016490: 2020 205b 7475 7020 666f 7220 7475 7020     [tup for tup 
+000164a0: 696e 2061 6c6c 5f73 7065 6373 2069 6620  in all_specs if 
+000164b0: 7475 705b 305d 2e69 642e 7374 6172 7473  tup[0].id.starts
+000164c0: 7769 7468 2843 4f4e 5445 5854 5f43 4f4e  with(CONTEXT_CON
+000164d0: 4649 475f 5052 4546 4958 295d 2c0a 2020  FIG_PREFIX)],.  
+000164e0: 2020 2020 2020 2020 2020 6c61 6d62 6461            lambda
+000164f0: 2078 3a20 785b 315d 2c0a 2020 2020 2020   x: x[1],.      
+00016500: 2020 290a 2020 2020 2020 2020 6e65 7874    ).        next
+00016510: 5f64 6570 733a 2053 6574 5b73 7472 5d20  _deps: Set[str] 
+00016520: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
+00016530: 6465 7073 5f62 795f 706f 733a 2044 6963  deps_by_pos: Dic
+00016540: 745b 696e 742c 2053 6574 5b73 7472 5d5d  t[int, Set[str]]
+00016550: 203d 207b 7d0a 2020 2020 2020 2020 666f   = {}.        fo
+00016560: 7220 706f 732c 2073 7065 6373 2069 6e20  r pos, specs in 
+00016570: 7370 6563 735f 6279 5f70 6f73 3a0a 2020  specs_by_pos:.  
+00016580: 2020 2020 2020 2020 2020 6465 7073 5f62            deps_b
+00016590: 795f 706f 735b 706f 735d 203d 206e 6578  y_pos[pos] = nex
+000165a0: 745f 6465 7073 0a20 2020 2020 2020 2020  t_deps.         
+000165b0: 2020 206e 6578 745f 6465 7073 203d 206e     next_deps = n
+000165c0: 6578 745f 6465 7073 207c 207b 7370 6563  ext_deps | {spec
+000165d0: 5b30 5d2e 6964 2066 6f72 2073 7065 6320  [0].id for spec 
+000165e0: 696e 2073 7065 6373 7d0a 2020 2020 2020  in specs}.      
+000165f0: 2020 2320 6173 7369 676e 2063 6f6e 7465    # assign conte
+00016600: 7874 2064 6570 656e 6465 6e63 6965 730a  xt dependencies.
+00016610: 2020 2020 2020 2020 666f 7220 706f 732c          for pos,
+00016620: 2028 7370 6563 2c20 6964 7829 2069 6e20   (spec, idx) in 
+00016630: 656e 756d 6572 6174 6528 616c 6c5f 7370  enumerate(all_sp
+00016640: 6563 7329 3a0a 2020 2020 2020 2020 2020  ecs):.          
+00016650: 2020 6966 2073 7065 632e 6964 2e73 7461    if spec.id.sta
+00016660: 7274 7377 6974 6828 434f 4e54 4558 545f  rtswith(CONTEXT_
+00016670: 434f 4e46 4947 5f50 5245 4649 5829 3a0a  CONFIG_PREFIX):.
+00016680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016690: 616c 6c5f 7370 6563 735b 706f 735d 203d  all_specs[pos] =
+000166a0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+000166b0: 2020 2020 2020 2043 6f6e 6669 6775 7261         Configura
+000166c0: 626c 6546 6965 6c64 5370 6563 280a 2020  bleFieldSpec(.  
+000166d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000166e0: 2020 2020 2020 6964 3d73 7065 632e 6964        id=spec.id
+000166f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00016700: 2020 2020 2020 2020 2020 616e 6e6f 7461            annota
+00016710: 7469 6f6e 3d73 7065 632e 616e 6e6f 7461  tion=spec.annota
+00016720: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
+00016730: 2020 2020 2020 2020 2020 2020 2020 6e61                na
+00016740: 6d65 3d73 7065 632e 6e61 6d65 2c0a 2020  me=spec.name,.  
+00016750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016760: 2020 2020 2020 6465 6661 756c 743d 7370        default=sp
+00016770: 6563 2e64 6566 6175 6c74 2c0a 2020 2020  ec.default,.    
+00016780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016790: 2020 2020 6465 7363 7269 7074 696f 6e3d      description=
+000167a0: 7370 6563 2e64 6573 6372 6970 7469 6f6e  spec.description
+000167b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000167c0: 2020 2020 2020 2020 2020 6973 5f73 6861            is_sha
+000167d0: 7265 643d 7370 6563 2e69 735f 7368 6172  red=spec.is_shar
+000167e0: 6564 2c0a 2020 2020 2020 2020 2020 2020  ed,.            
+000167f0: 2020 2020 2020 2020 2020 2020 6465 7065              depe
+00016800: 6e64 656e 6369 6573 3d5b 0a20 2020 2020  ndencies=[.     
+00016810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016820: 2020 2020 2020 2064 0a20 2020 2020 2020         d.       
+00016830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016840: 2020 2020 2066 6f72 2064 2069 6e20 6465       for d in de
+00016850: 7073 5f62 795f 706f 735b 6964 785d 0a20  ps_by_pos[idx]. 
+00016860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016870: 2020 2020 2020 2020 2020 2069 6620 5f6b             if _k
+00016880: 6579 5f66 726f 6d5f 6964 2864 2920 213d  ey_from_id(d) !=
+00016890: 205f 6b65 795f 6672 6f6d 5f69 6428 7370   _key_from_id(sp
+000168a0: 6563 2e69 6429 0a20 2020 2020 2020 2020  ec.id).         
+000168b0: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
 000168c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000168d0: 2020 2020 2069 6e70 7574 5f63 6f70 6965       input_copie
-000168e0: 732e 706f 7028 292c 0a20 2020 2020 2020  s.pop(),.       
-000168f0: 2020 2020 2020 2020 2020 2020 2070 6174               pat
-00016900: 6368 5f63 6f6e 6669 6728 0a20 2020 2020  ch_config(.     
+000168d0: 2020 2020 2020 2020 202b 2028 7370 6563           + (spec
+000168e0: 2e64 6570 656e 6465 6e63 6965 7320 6f72  .dependencies or
+000168f0: 205b 5d29 2c0a 2020 2020 2020 2020 2020   []),.          
+00016900: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
 00016910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016920: 2020 2063 6f6e 6669 672c 2063 616c 6c62     config, callb
-00016930: 6163 6b73 3d72 756e 5f6d 616e 6167 6572  acks=run_manager
-00016940: 2e67 6574 5f63 6869 6c64 2866 226d 6170  .get_child(f"map
-00016950: 3a6b 6579 3a7b 6e61 6d65 7d22 290a 2020  :key:{name}").  
-00016960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016970: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
-00016980: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-00016990: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-000169a0: 2020 666f 7220 6e61 6d65 2c20 7374 6570    for name, step
-000169b0: 2069 6e20 7374 6570 732e 6974 656d 7328   in steps.items(
-000169c0: 290a 2020 2020 2020 2020 5d0a 0a20 2020  ).        ]..   
-000169d0: 2020 2020 2023 2057 7261 7020 696e 2061       # Wrap in a
-000169e0: 2063 6f72 6f75 7469 6e65 2074 6f20 7361   coroutine to sa
-000169f0: 7469 7366 7920 6c69 6e74 6572 0a20 2020  tisfy linter.   
-00016a00: 2020 2020 2061 7379 6e63 2064 6566 2067       async def g
-00016a10: 6574 5f6e 6578 745f 6368 756e 6b28 6765  et_next_chunk(ge
-00016a20: 6e65 7261 746f 723a 2041 7379 6e63 4974  nerator: AsyncIt
-00016a30: 6572 6174 6f72 2920 2d3e 204f 7074 696f  erator) -> Optio
-00016a40: 6e61 6c5b 4f75 7470 7574 5d3a 0a20 2020  nal[Output]:.   
-00016a50: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00016a60: 6177 6169 7420 7079 5f61 6e65 7874 2867  await py_anext(g
-00016a70: 656e 6572 6174 6f72 290a 0a20 2020 2020  enerator)..     
-00016a80: 2020 2023 2053 7461 7274 2074 6865 2066     # Start the f
-00016a90: 6972 7374 2069 7465 7261 7469 6f6e 206f  irst iteration o
-00016aa0: 6620 6561 6368 2067 656e 6572 6174 6f72  f each generator
-00016ab0: 0a20 2020 2020 2020 2074 6173 6b73 203d  .        tasks =
-00016ac0: 207b 0a20 2020 2020 2020 2020 2020 2061   {.            a
-00016ad0: 7379 6e63 696f 2e63 7265 6174 655f 7461  syncio.create_ta
-00016ae0: 736b 2867 6574 5f6e 6578 745f 6368 756e  sk(get_next_chun
-00016af0: 6b28 6765 6e65 7261 746f 7229 293a 2028  k(generator)): (
-00016b00: 7374 6570 5f6e 616d 652c 2067 656e 6572  step_name, gener
-00016b10: 6174 6f72 290a 2020 2020 2020 2020 2020  ator).          
-00016b20: 2020 666f 7220 7374 6570 5f6e 616d 652c    for step_name,
-00016b30: 2067 656e 6572 6174 6f72 2069 6e20 6e61   generator in na
-00016b40: 6d65 645f 6765 6e65 7261 746f 7273 0a20  med_generators. 
-00016b50: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00016b60: 2023 2059 6965 6c64 2063 6875 6e6b 7320   # Yield chunks 
-00016b70: 6672 6f6d 2065 6163 6820 6173 2074 6865  from each as the
-00016b80: 7920 6265 636f 6d65 2061 7661 696c 6162  y become availab
-00016b90: 6c65 2c0a 2020 2020 2020 2020 2320 616e  le,.        # an
-00016ba0: 6420 7374 6172 7420 7468 6520 6e65 7874  d start the next
-00016bb0: 2069 7465 7261 7469 6f6e 206f 6620 7468   iteration of th
-00016bc0: 6520 6765 6e65 7261 746f 7220 7468 6174  e generator that
-00016bd0: 2079 6965 6c64 6564 2069 742e 0a20 2020   yielded it..   
-00016be0: 2020 2020 2023 2057 6865 6e20 616c 6c20       # When all 
-00016bf0: 6765 6e65 7261 746f 7273 2061 7265 2065  generators are e
-00016c00: 7868 6175 7374 6564 2c20 7374 6f70 2e0a  xhausted, stop..
-00016c10: 2020 2020 2020 2020 7768 696c 6520 7461          while ta
-00016c20: 736b 733a 0a20 2020 2020 2020 2020 2020  sks:.           
-00016c30: 2063 6f6d 706c 6574 6564 5f74 6173 6b73   completed_tasks
-00016c40: 2c20 5f20 3d20 6177 6169 7420 6173 796e  , _ = await asyn
-00016c50: 6369 6f2e 7761 6974 280a 2020 2020 2020  cio.wait(.      
-00016c60: 2020 2020 2020 2020 2020 7461 736b 732c            tasks,
-00016c70: 2072 6574 7572 6e5f 7768 656e 3d61 7379   return_when=asy
-00016c80: 6e63 696f 2e46 4952 5354 5f43 4f4d 504c  ncio.FIRST_COMPL
-00016c90: 4554 4544 0a20 2020 2020 2020 2020 2020  ETED.           
-00016ca0: 2029 0a20 2020 2020 2020 2020 2020 2066   ).            f
-00016cb0: 6f72 2074 6173 6b20 696e 2063 6f6d 706c  or task in compl
-00016cc0: 6574 6564 5f74 6173 6b73 3a0a 2020 2020  eted_tasks:.    
-00016cd0: 2020 2020 2020 2020 2020 2020 2873 7465              (ste
-00016ce0: 705f 6e61 6d65 2c20 6765 6e65 7261 746f  p_name, generato
-00016cf0: 7229 203d 2074 6173 6b73 2e70 6f70 2874  r) = tasks.pop(t
-00016d00: 6173 6b29 0a20 2020 2020 2020 2020 2020  ask).           
-00016d10: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00016d20: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-00016d30: 756e 6b20 3d20 4164 6461 626c 6544 6963  unk = AddableDic
-00016d40: 7428 7b73 7465 705f 6e61 6d65 3a20 7461  t({step_name: ta
-00016d50: 736b 2e72 6573 756c 7428 297d 290a 2020  sk.result()}).  
-00016d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d70: 2020 7969 656c 6420 6368 756e 6b0a 2020    yield chunk.  
-00016d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d90: 2020 6e65 775f 7461 736b 203d 2061 7379    new_task = asy
-00016da0: 6e63 696f 2e63 7265 6174 655f 7461 736b  ncio.create_task
-00016db0: 2867 6574 5f6e 6578 745f 6368 756e 6b28  (get_next_chunk(
-00016dc0: 6765 6e65 7261 746f 7229 290a 2020 2020  generator)).    
-00016dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016de0: 7461 736b 735b 6e65 775f 7461 736b 5d20  tasks[new_task] 
-00016df0: 3d20 2873 7465 705f 6e61 6d65 2c20 6765  = (step_name, ge
-00016e00: 6e65 7261 746f 7229 0a20 2020 2020 2020  nerator).       
-00016e10: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-00016e20: 5374 6f70 4173 796e 6349 7465 7261 7469  StopAsyncIterati
-00016e30: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-00016e40: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
-00016e50: 2020 6173 796e 6320 6465 6620 6174 7261    async def atra
-00016e60: 6e73 666f 726d 280a 2020 2020 2020 2020  nsform(.        
-00016e70: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
-00016e80: 7075 743a 2041 7379 6e63 4974 6572 6174  put: AsyncIterat
-00016e90: 6f72 5b49 6e70 7574 5d2c 0a20 2020 2020  or[Input],.     
-00016ea0: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
-00016eb0: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-00016ec0: 6967 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ig] = None,.    
-00016ed0: 2020 2020 2a2a 6b77 6172 6773 3a20 416e      **kwargs: An
-00016ee0: 792c 0a20 2020 2029 202d 3e20 4173 796e  y,.    ) -> Asyn
-00016ef0: 6349 7465 7261 746f 725b 4469 6374 5b73  cIterator[Dict[s
-00016f00: 7472 2c20 416e 795d 5d3a 0a20 2020 2020  tr, Any]]:.     
-00016f10: 2020 2061 7379 6e63 2066 6f72 2063 6875     async for chu
-00016f20: 6e6b 2069 6e20 7365 6c66 2e5f 6174 7261  nk in self._atra
-00016f30: 6e73 666f 726d 5f73 7472 6561 6d5f 7769  nsform_stream_wi
-00016f40: 7468 5f63 6f6e 6669 6728 0a20 2020 2020  th_config(.     
-00016f50: 2020 2020 2020 2069 6e70 7574 2c20 7365         input, se
-00016f60: 6c66 2e5f 6174 7261 6e73 666f 726d 2c20  lf._atransform, 
-00016f70: 636f 6e66 6967 2c20 2a2a 6b77 6172 6773  config, **kwargs
-00016f80: 0a20 2020 2020 2020 2029 3a0a 2020 2020  .        ):.    
-00016f90: 2020 2020 2020 2020 7969 656c 6420 6368          yield ch
-00016fa0: 756e 6b0a 0a20 2020 2061 7379 6e63 2064  unk..    async d
-00016fb0: 6566 2061 7374 7265 616d 280a 2020 2020  ef astream(.    
-00016fc0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00016fd0: 2020 696e 7075 743a 2049 6e70 7574 2c0a    input: Input,.
-00016fe0: 2020 2020 2020 2020 636f 6e66 6967 3a20          config: 
-00016ff0: 4f70 7469 6f6e 616c 5b52 756e 6e61 626c  Optional[Runnabl
-00017000: 6543 6f6e 6669 675d 203d 204e 6f6e 652c  eConfig] = None,
-00017010: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
-00017020: 733a 204f 7074 696f 6e61 6c5b 416e 795d  s: Optional[Any]
-00017030: 2c0a 2020 2020 2920 2d3e 2041 7379 6e63  ,.    ) -> Async
-00017040: 4974 6572 6174 6f72 5b44 6963 745b 7374  Iterator[Dict[st
-00017050: 722c 2041 6e79 5d5d 3a0a 2020 2020 2020  r, Any]]:.      
-00017060: 2020 6173 796e 6320 6465 6620 696e 7075    async def inpu
-00017070: 745f 6169 7465 7228 2920 2d3e 2041 7379  t_aiter() -> Asy
-00017080: 6e63 4974 6572 6174 6f72 5b49 6e70 7574  ncIterator[Input
-00017090: 5d3a 0a20 2020 2020 2020 2020 2020 2079  ]:.            y
-000170a0: 6965 6c64 2069 6e70 7574 0a0a 2020 2020  ield input..    
-000170b0: 2020 2020 6173 796e 6320 666f 7220 6368      async for ch
-000170c0: 756e 6b20 696e 2073 656c 662e 6174 7261  unk in self.atra
-000170d0: 6e73 666f 726d 2869 6e70 7574 5f61 6974  nsform(input_ait
-000170e0: 6572 2829 2c20 636f 6e66 6967 293a 0a20  er(), config):. 
-000170f0: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
-00017100: 2063 6875 6e6b 0a0a 0a23 2057 6520 7375   chunk...# We su
-00017110: 7070 6f72 7420 626f 7468 206e 616d 6573  pport both names
-00017120: 0a52 756e 6e61 626c 654d 6170 203d 2052  .RunnableMap = R
-00017130: 756e 6e61 626c 6550 6172 616c 6c65 6c0a  unnableParallel.
-00017140: 0a0a 636c 6173 7320 5275 6e6e 6162 6c65  ..class Runnable
-00017150: 4765 6e65 7261 746f 7228 5275 6e6e 6162  Generator(Runnab
-00017160: 6c65 5b49 6e70 7574 2c20 4f75 7470 7574  le[Input, Output
-00017170: 5d29 3a0a 2020 2020 2222 220a 2020 2020  ]):.    """.    
-00017180: 4120 7275 6e6e 6162 6c65 2074 6861 7420  A runnable that 
-00017190: 7275 6e73 2061 2067 656e 6572 6174 6f72  runs a generator
-000171a0: 2066 756e 6374 696f 6e2e 0a20 2020 2022   function..    "
-000171b0: 2222 0a0a 2020 2020 6465 6620 5f5f 696e  ""..    def __in
-000171c0: 6974 5f5f 280a 2020 2020 2020 2020 7365  it__(.        se
-000171d0: 6c66 2c0a 2020 2020 2020 2020 7472 616e  lf,.        tran
-000171e0: 7366 6f72 6d3a 2055 6e69 6f6e 5b0a 2020  sform: Union[.  
-000171f0: 2020 2020 2020 2020 2020 4361 6c6c 6162            Callab
-00017200: 6c65 5b5b 4974 6572 6174 6f72 5b49 6e70  le[[Iterator[Inp
-00017210: 7574 5d5d 2c20 4974 6572 6174 6f72 5b4f  ut]], Iterator[O
-00017220: 7574 7075 745d 5d2c 0a20 2020 2020 2020  utput]],.       
-00017230: 2020 2020 2043 616c 6c61 626c 655b 5b41       Callable[[A
-00017240: 7379 6e63 4974 6572 6174 6f72 5b49 6e70  syncIterator[Inp
-00017250: 7574 5d5d 2c20 4173 796e 6349 7465 7261  ut]], AsyncItera
-00017260: 746f 725b 4f75 7470 7574 5d5d 2c0a 2020  tor[Output]],.  
-00017270: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00017280: 2061 7472 616e 7366 6f72 6d3a 204f 7074   atransform: Opt
-00017290: 696f 6e61 6c5b 0a20 2020 2020 2020 2020  ional[.         
-000172a0: 2020 2043 616c 6c61 626c 655b 5b41 7379     Callable[[Asy
-000172b0: 6e63 4974 6572 6174 6f72 5b49 6e70 7574  ncIterator[Input
-000172c0: 5d5d 2c20 4173 796e 6349 7465 7261 746f  ]], AsyncIterato
-000172d0: 725b 4f75 7470 7574 5d5d 0a20 2020 2020  r[Output]].     
-000172e0: 2020 205d 203d 204e 6f6e 652c 0a20 2020     ] = None,.   
-000172f0: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-00017300: 2020 2020 6966 2061 7472 616e 7366 6f72      if atransfor
-00017310: 6d20 6973 206e 6f74 204e 6f6e 653a 0a20  m is not None:. 
-00017320: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00017330: 5f61 7472 616e 7366 6f72 6d20 3d20 6174  _atransform = at
-00017340: 7261 6e73 666f 726d 0a20 2020 2020 2020  ransform.       
-00017350: 2020 2020 2066 756e 635f 666f 725f 6e61       func_for_na
-00017360: 6d65 3a20 4361 6c6c 6162 6c65 203d 2061  me: Callable = a
-00017370: 7472 616e 7366 6f72 6d0a 0a20 2020 2020  transform..     
-00017380: 2020 2069 6620 696e 7370 6563 742e 6973     if inspect.is
-00017390: 6173 796e 6367 656e 6675 6e63 7469 6f6e  asyncgenfunction
-000173a0: 2874 7261 6e73 666f 726d 293a 0a20 2020  (transform):.   
-000173b0: 2020 2020 2020 2020 2073 656c 662e 5f61           self._a
-000173c0: 7472 616e 7366 6f72 6d20 3d20 7472 616e  transform = tran
-000173d0: 7366 6f72 6d0a 2020 2020 2020 2020 2020  sform.          
-000173e0: 2020 6675 6e63 5f66 6f72 5f6e 616d 6520    func_for_name 
-000173f0: 3d20 7472 616e 7366 6f72 6d0a 2020 2020  = transform.    
-00017400: 2020 2020 656c 6966 2069 6e73 7065 6374      elif inspect
-00017410: 2e69 7367 656e 6572 6174 6f72 6675 6e63  .isgeneratorfunc
-00017420: 7469 6f6e 2874 7261 6e73 666f 726d 293a  tion(transform):
-00017430: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00017440: 662e 5f74 7261 6e73 666f 726d 203d 2074  f._transform = t
-00017450: 7261 6e73 666f 726d 0a20 2020 2020 2020  ransform.       
-00017460: 2020 2020 2066 756e 635f 666f 725f 6e61       func_for_na
-00017470: 6d65 203d 2074 7261 6e73 666f 726d 0a20  me = transform. 
-00017480: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00017490: 2020 2020 2020 2020 2072 6169 7365 2054           raise T
-000174a0: 7970 6545 7272 6f72 280a 2020 2020 2020  ypeError(.      
-000174b0: 2020 2020 2020 2020 2020 2245 7870 6563            "Expec
-000174c0: 7465 6420 6120 6765 6e65 7261 746f 7220  ted a generator 
-000174d0: 6675 6e63 7469 6f6e 2074 7970 6520 666f  function type fo
-000174e0: 7220 6074 7261 6e73 666f 726d 602e 220a  r `transform`.".
-000174f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017500: 6622 496e 7374 6561 6420 676f 7420 616e  f"Instead got an
-00017510: 2075 6e73 7570 706f 7274 6564 2074 7970   unsupported typ
-00017520: 653a 207b 7479 7065 2874 7261 6e73 666f  e: {type(transfo
-00017530: 726d 297d 220a 2020 2020 2020 2020 2020  rm)}".          
-00017540: 2020 290a 0a20 2020 2020 2020 2074 7279    )..        try
-00017550: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00017560: 6c66 2e6e 616d 6520 3d20 6675 6e63 5f66  lf.name = func_f
-00017570: 6f72 5f6e 616d 652e 5f5f 6e61 6d65 5f5f  or_name.__name__
-00017580: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00017590: 4174 7472 6962 7574 6545 7272 6f72 3a0a  AttributeError:.
-000175a0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-000175b0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-000175c0: 2020 2020 6465 6620 496e 7075 7454 7970      def InputTyp
-000175d0: 6528 7365 6c66 2920 2d3e 2041 6e79 3a0a  e(self) -> Any:.
-000175e0: 2020 2020 2020 2020 6675 6e63 203d 2067          func = g
-000175f0: 6574 6174 7472 2873 656c 662c 2022 5f74  etattr(self, "_t
-00017600: 7261 6e73 666f 726d 222c 204e 6f6e 6529  ransform", None)
-00017610: 206f 7220 6765 7461 7474 7228 7365 6c66   or getattr(self
-00017620: 2c20 225f 6174 7261 6e73 666f 726d 2229  , "_atransform")
-00017630: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-00017640: 2020 2020 2020 2020 2020 7061 7261 6d73            params
-00017650: 203d 2069 6e73 7065 6374 2e73 6967 6e61   = inspect.signa
-00017660: 7475 7265 2866 756e 6329 2e70 6172 616d  ture(func).param
-00017670: 6574 6572 730a 2020 2020 2020 2020 2020  eters.          
-00017680: 2020 6669 7273 745f 7061 7261 6d20 3d20    first_param = 
-00017690: 6e65 7874 2869 7465 7228 7061 7261 6d73  next(iter(params
-000176a0: 2e76 616c 7565 7328 2929 2c20 4e6f 6e65  .values()), None
-000176b0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-000176c0: 2066 6972 7374 5f70 6172 616d 2061 6e64   first_param and
-000176d0: 2066 6972 7374 5f70 6172 616d 2e61 6e6e   first_param.ann
-000176e0: 6f74 6174 696f 6e20 213d 2069 6e73 7065  otation != inspe
-000176f0: 6374 2e50 6172 616d 6574 6572 2e65 6d70  ct.Parameter.emp
-00017700: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
-00017710: 2020 2020 7265 7475 726e 2067 6574 6174      return getat
-00017720: 7472 2866 6972 7374 5f70 6172 616d 2e61  tr(first_param.a
-00017730: 6e6e 6f74 6174 696f 6e2c 2022 5f5f 6172  nnotation, "__ar
-00017740: 6773 5f5f 222c 2028 416e 792c 2929 5b30  gs__", (Any,))[0
-00017750: 5d0a 2020 2020 2020 2020 2020 2020 656c  ].            el
-00017760: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00017770: 2020 2020 7265 7475 726e 2041 6e79 0a20      return Any. 
-00017780: 2020 2020 2020 2065 7863 6570 7420 5661         except Va
-00017790: 6c75 6545 7272 6f72 3a0a 2020 2020 2020  lueError:.      
-000177a0: 2020 2020 2020 7265 7475 726e 2041 6e79        return Any
-000177b0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-000177c0: 2020 2020 6465 6620 4f75 7470 7574 5479      def OutputTy
-000177d0: 7065 2873 656c 6629 202d 3e20 416e 793a  pe(self) -> Any:
-000177e0: 0a20 2020 2020 2020 2066 756e 6320 3d20  .        func = 
-000177f0: 6765 7461 7474 7228 7365 6c66 2c20 225f  getattr(self, "_
-00017800: 7472 616e 7366 6f72 6d22 2c20 4e6f 6e65  transform", None
-00017810: 2920 6f72 2067 6574 6174 7472 2873 656c  ) or getattr(sel
-00017820: 662c 2022 5f61 7472 616e 7366 6f72 6d22  f, "_atransform"
-00017830: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
-00017840: 2020 2020 2020 2020 2020 2073 6967 203d             sig =
-00017850: 2069 6e73 7065 6374 2e73 6967 6e61 7475   inspect.signatu
-00017860: 7265 2866 756e 6329 0a20 2020 2020 2020  re(func).       
-00017870: 2020 2020 2072 6574 7572 6e20 280a 2020       return (.  
-00017880: 2020 2020 2020 2020 2020 2020 2020 6765                ge
-00017890: 7461 7474 7228 7369 672e 7265 7475 726e  tattr(sig.return
-000178a0: 5f61 6e6e 6f74 6174 696f 6e2c 2022 5f5f  _annotation, "__
-000178b0: 6172 6773 5f5f 222c 2028 416e 792c 2929  args__", (Any,))
-000178c0: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-000178d0: 2020 2020 6966 2073 6967 2e72 6574 7572      if sig.retur
-000178e0: 6e5f 616e 6e6f 7461 7469 6f6e 2021 3d20  n_annotation != 
-000178f0: 696e 7370 6563 742e 5369 676e 6174 7572  inspect.Signatur
-00017900: 652e 656d 7074 790a 2020 2020 2020 2020  e.empty.        
-00017910: 2020 2020 2020 2020 656c 7365 2041 6e79          else Any
-00017920: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00017930: 2020 2020 2020 2065 7863 6570 7420 5661         except Va
-00017940: 6c75 6545 7272 6f72 3a0a 2020 2020 2020  lueError:.      
-00017950: 2020 2020 2020 7265 7475 726e 2041 6e79        return Any
-00017960: 0a0a 2020 2020 6465 6620 5f5f 6571 5f5f  ..    def __eq__
-00017970: 2873 656c 662c 206f 7468 6572 3a20 416e  (self, other: An
-00017980: 7929 202d 3e20 626f 6f6c 3a0a 2020 2020  y) -> bool:.    
-00017990: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-000179a0: 6528 6f74 6865 722c 2052 756e 6e61 626c  e(other, Runnabl
-000179b0: 6547 656e 6572 6174 6f72 293a 0a20 2020  eGenerator):.   
-000179c0: 2020 2020 2020 2020 2069 6620 6861 7361           if hasa
-000179d0: 7474 7228 7365 6c66 2c20 225f 7472 616e  ttr(self, "_tran
-000179e0: 7366 6f72 6d22 2920 616e 6420 6861 7361  sform") and hasa
-000179f0: 7474 7228 6f74 6865 722c 2022 5f74 7261  ttr(other, "_tra
-00017a00: 6e73 666f 726d 2229 3a0a 2020 2020 2020  nsform"):.      
-00017a10: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00017a20: 2073 656c 662e 5f74 7261 6e73 666f 726d   self._transform
-00017a30: 203d 3d20 6f74 6865 722e 5f74 7261 6e73   == other._trans
-00017a40: 666f 726d 0a20 2020 2020 2020 2020 2020  form.           
-00017a50: 2065 6c69 6620 6861 7361 7474 7228 7365   elif hasattr(se
-00017a60: 6c66 2c20 225f 6174 7261 6e73 666f 726d  lf, "_atransform
-00017a70: 2229 2061 6e64 2068 6173 6174 7472 286f  ") and hasattr(o
-00017a80: 7468 6572 2c20 225f 6174 7261 6e73 666f  ther, "_atransfo
-00017a90: 726d 2229 3a0a 2020 2020 2020 2020 2020  rm"):.          
-00017aa0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00017ab0: 662e 5f61 7472 616e 7366 6f72 6d20 3d3d  f._atransform ==
-00017ac0: 206f 7468 6572 2e5f 6174 7261 6e73 666f   other._atransfo
-00017ad0: 726d 0a20 2020 2020 2020 2020 2020 2065  rm.            e
-00017ae0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00017af0: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
-00017b00: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
-00017b10: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00017b20: 726e 2046 616c 7365 0a0a 2020 2020 6465  rn False..    de
-00017b30: 6620 5f5f 7265 7072 5f5f 2873 656c 6629  f __repr__(self)
-00017b40: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-00017b50: 2069 6620 6861 7361 7474 7228 7365 6c66   if hasattr(self
-00017b60: 2c20 225f 7472 616e 7366 6f72 6d22 293a  , "_transform"):
-00017b70: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00017b80: 7572 6e20 6622 5275 6e6e 6162 6c65 4765  urn f"RunnableGe
-00017b90: 6e65 7261 746f 7228 7b73 656c 662e 5f74  nerator({self._t
-00017ba0: 7261 6e73 666f 726d 2e5f 5f6e 616d 655f  ransform.__name_
-00017bb0: 5f7d 2922 0a20 2020 2020 2020 2065 6c69  _})".        eli
-00017bc0: 6620 6861 7361 7474 7228 7365 6c66 2c20  f hasattr(self, 
-00017bd0: 225f 6174 7261 6e73 666f 726d 2229 3a0a  "_atransform"):.
-00017be0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00017bf0: 726e 2066 2252 756e 6e61 626c 6547 656e  rn f"RunnableGen
-00017c00: 6572 6174 6f72 287b 7365 6c66 2e5f 6174  erator({self._at
-00017c10: 7261 6e73 666f 726d 2e5f 5f6e 616d 655f  ransform.__name_
-00017c20: 5f7d 2922 0a20 2020 2020 2020 2065 6c73  _})".        els
-00017c30: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00017c40: 6574 7572 6e20 2252 756e 6e61 626c 6547  eturn "RunnableG
-00017c50: 656e 6572 6174 6f72 282e 2e2e 2922 0a0a  enerator(...)"..
-00017c60: 2020 2020 6465 6620 7472 616e 7366 6f72      def transfor
-00017c70: 6d28 0a20 2020 2020 2020 2073 656c 662c  m(.        self,
-00017c80: 0a20 2020 2020 2020 2069 6e70 7574 3a20  .        input: 
-00017c90: 4974 6572 6174 6f72 5b49 6e70 7574 5d2c  Iterator[Input],
-00017ca0: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
-00017cb0: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
-00017cc0: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
-00017cd0: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
-00017ce0: 6773 3a20 416e 792c 0a20 2020 2029 202d  gs: Any,.    ) -
-00017cf0: 3e20 4974 6572 6174 6f72 5b4f 7574 7075  > Iterator[Outpu
-00017d00: 745d 3a0a 2020 2020 2020 2020 7265 7475  t]:.        retu
-00017d10: 726e 2073 656c 662e 5f74 7261 6e73 666f  rn self._transfo
-00017d20: 726d 5f73 7472 6561 6d5f 7769 7468 5f63  rm_stream_with_c
-00017d30: 6f6e 6669 6728 0a20 2020 2020 2020 2020  onfig(.         
-00017d40: 2020 2069 6e70 7574 2c20 7365 6c66 2e5f     input, self._
-00017d50: 7472 616e 7366 6f72 6d2c 2063 6f6e 6669  transform, confi
-00017d60: 672c 202a 2a6b 7761 7267 730a 2020 2020  g, **kwargs.    
-00017d70: 2020 2020 290a 0a20 2020 2064 6566 2073      )..    def s
-00017d80: 7472 6561 6d28 0a20 2020 2020 2020 2073  tream(.        s
-00017d90: 656c 662c 0a20 2020 2020 2020 2069 6e70  elf,.        inp
-00017da0: 7574 3a20 496e 7075 742c 0a20 2020 2020  ut: Input,.     
-00017db0: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
-00017dc0: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-00017dd0: 6967 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ig] = None,.    
-00017de0: 2020 2020 2a2a 6b77 6172 6773 3a20 416e      **kwargs: An
-00017df0: 792c 0a20 2020 2029 202d 3e20 4974 6572  y,.    ) -> Iter
-00017e00: 6174 6f72 5b4f 7574 7075 745d 3a0a 2020  ator[Output]:.  
-00017e10: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00017e20: 662e 7472 616e 7366 6f72 6d28 6974 6572  f.transform(iter
-00017e30: 285b 696e 7075 745d 292c 2063 6f6e 6669  ([input]), confi
-00017e40: 672c 202a 2a6b 7761 7267 7329 0a0a 2020  g, **kwargs)..  
-00017e50: 2020 6465 6620 696e 766f 6b65 280a 2020    def invoke(.  
-00017e60: 2020 2020 2020 7365 6c66 2c20 696e 7075        self, inpu
-00017e70: 743a 2049 6e70 7574 2c20 636f 6e66 6967  t: Input, config
-00017e80: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
-00017e90: 626c 6543 6f6e 6669 675d 203d 204e 6f6e  bleConfig] = Non
-00017ea0: 652c 202a 2a6b 7761 7267 733a 2041 6e79  e, **kwargs: Any
-00017eb0: 0a20 2020 2029 202d 3e20 4f75 7470 7574  .    ) -> Output
-00017ec0: 3a0a 2020 2020 2020 2020 6669 6e61 6c20  :.        final 
-00017ed0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2066  = None.        f
-00017ee0: 6f72 206f 7574 7075 7420 696e 2073 656c  or output in sel
-00017ef0: 662e 7374 7265 616d 2869 6e70 7574 2c20  f.stream(input, 
-00017f00: 636f 6e66 6967 2c20 2a2a 6b77 6172 6773  config, **kwargs
-00017f10: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-00017f20: 6620 6669 6e61 6c20 6973 204e 6f6e 653a  f final is None:
-00017f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017f40: 2066 696e 616c 203d 206f 7574 7075 740a   final = output.
-00017f50: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00017f60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00017f70: 2020 6669 6e61 6c20 3d20 6669 6e61 6c20    final = final 
-00017f80: 2b20 6f75 7470 7574 0a20 2020 2020 2020  + output.       
-00017f90: 2072 6574 7572 6e20 6361 7374 284f 7574   return cast(Out
-00017fa0: 7075 742c 2066 696e 616c 290a 0a20 2020  put, final)..   
-00017fb0: 2064 6566 2061 7472 616e 7366 6f72 6d28   def atransform(
-00017fc0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00017fd0: 2020 2020 2020 2069 6e70 7574 3a20 4173         input: As
-00017fe0: 796e 6349 7465 7261 746f 725b 496e 7075  yncIterator[Inpu
-00017ff0: 745d 2c0a 2020 2020 2020 2020 636f 6e66  t],.        conf
-00018000: 6967 3a20 4f70 7469 6f6e 616c 5b52 756e  ig: Optional[Run
-00018010: 6e61 626c 6543 6f6e 6669 675d 203d 204e  nableConfig] = N
-00018020: 6f6e 652c 0a20 2020 2020 2020 202a 2a6b  one,.        **k
-00018030: 7761 7267 733a 2041 6e79 2c0a 2020 2020  wargs: Any,.    
-00018040: 2920 2d3e 2041 7379 6e63 4974 6572 6174  ) -> AsyncIterat
-00018050: 6f72 5b4f 7574 7075 745d 3a0a 2020 2020  or[Output]:.    
-00018060: 2020 2020 6966 206e 6f74 2068 6173 6174      if not hasat
-00018070: 7472 2873 656c 662c 2022 5f61 7472 616e  tr(self, "_atran
-00018080: 7366 6f72 6d22 293a 0a20 2020 2020 2020  sform"):.       
-00018090: 2020 2020 2072 6169 7365 204e 6f74 496d       raise NotIm
-000180a0: 706c 656d 656e 7465 6445 7272 6f72 2822  plementedError("
-000180b0: 5468 6973 2072 756e 6e61 626c 6520 646f  This runnable do
-000180c0: 6573 206e 6f74 2073 7570 706f 7274 2061  es not support a
-000180d0: 7379 6e63 206d 6574 686f 6473 2e22 290a  sync methods.").
-000180e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000180f0: 7365 6c66 2e5f 6174 7261 6e73 666f 726d  self._atransform
-00018100: 5f73 7472 6561 6d5f 7769 7468 5f63 6f6e  _stream_with_con
-00018110: 6669 6728 0a20 2020 2020 2020 2020 2020  fig(.           
-00018120: 2069 6e70 7574 2c20 7365 6c66 2e5f 6174   input, self._at
-00018130: 7261 6e73 666f 726d 2c20 636f 6e66 6967  ransform, config
-00018140: 2c20 2a2a 6b77 6172 6773 0a20 2020 2020  , **kwargs.     
-00018150: 2020 2029 0a0a 2020 2020 6465 6620 6173     )..    def as
-00018160: 7472 6561 6d28 0a20 2020 2020 2020 2073  tream(.        s
-00018170: 656c 662c 0a20 2020 2020 2020 2069 6e70  elf,.        inp
-00018180: 7574 3a20 496e 7075 742c 0a20 2020 2020  ut: Input,.     
-00018190: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
-000181a0: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-000181b0: 6967 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ig] = None,.    
-000181c0: 2020 2020 2a2a 6b77 6172 6773 3a20 416e      **kwargs: An
-000181d0: 792c 0a20 2020 2029 202d 3e20 4173 796e  y,.    ) -> Asyn
-000181e0: 6349 7465 7261 746f 725b 4f75 7470 7574  cIterator[Output
-000181f0: 5d3a 0a20 2020 2020 2020 2061 7379 6e63  ]:.        async
-00018200: 2064 6566 2069 6e70 7574 5f61 6974 6572   def input_aiter
-00018210: 2829 202d 3e20 4173 796e 6349 7465 7261  () -> AsyncItera
-00018220: 746f 725b 496e 7075 745d 3a0a 2020 2020  tor[Input]:.    
-00018230: 2020 2020 2020 2020 7969 656c 6420 696e          yield in
-00018240: 7075 740a 0a20 2020 2020 2020 2072 6574  put..        ret
-00018250: 7572 6e20 7365 6c66 2e61 7472 616e 7366  urn self.atransf
-00018260: 6f72 6d28 696e 7075 745f 6169 7465 7228  orm(input_aiter(
-00018270: 292c 2063 6f6e 6669 672c 202a 2a6b 7761  ), config, **kwa
-00018280: 7267 7329 0a0a 2020 2020 6173 796e 6320  rgs)..    async 
-00018290: 6465 6620 6169 6e76 6f6b 6528 0a20 2020  def ainvoke(.   
-000182a0: 2020 2020 2073 656c 662c 2069 6e70 7574       self, input
-000182b0: 3a20 496e 7075 742c 2063 6f6e 6669 673a  : Input, config:
-000182c0: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
-000182d0: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
-000182e0: 2c20 2a2a 6b77 6172 6773 3a20 416e 790a  , **kwargs: Any.
-000182f0: 2020 2020 2920 2d3e 204f 7574 7075 743a      ) -> Output:
-00018300: 0a20 2020 2020 2020 2066 696e 616c 203d  .        final =
-00018310: 204e 6f6e 650a 2020 2020 2020 2020 6173   None.        as
-00018320: 796e 6320 666f 7220 6f75 7470 7574 2069  ync for output i
-00018330: 6e20 7365 6c66 2e61 7374 7265 616d 2869  n self.astream(i
-00018340: 6e70 7574 2c20 636f 6e66 6967 2c20 2a2a  nput, config, **
-00018350: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
-00018360: 2020 2020 2069 6620 6669 6e61 6c20 6973       if final is
-00018370: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00018380: 2020 2020 2020 2066 696e 616c 203d 206f         final = o
-00018390: 7574 7075 740a 2020 2020 2020 2020 2020  utput.          
-000183a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000183b0: 2020 2020 2020 2020 6669 6e61 6c20 3d20          final = 
-000183c0: 6669 6e61 6c20 2b20 6f75 7470 7574 0a20  final + output. 
-000183d0: 2020 2020 2020 2072 6574 7572 6e20 6361         return ca
-000183e0: 7374 284f 7574 7075 742c 2066 696e 616c  st(Output, final
-000183f0: 290a 0a0a 636c 6173 7320 5275 6e6e 6162  )...class Runnab
-00018400: 6c65 4c61 6d62 6461 2852 756e 6e61 626c  leLambda(Runnabl
-00018410: 655b 496e 7075 742c 204f 7574 7075 745d  e[Input, Output]
-00018420: 293a 0a20 2020 2022 2222 5275 6e6e 6162  ):.    """Runnab
-00018430: 6c65 4c61 6d62 6461 2063 6f6e 7665 7274  leLambda convert
-00018440: 7320 6120 7079 7468 6f6e 2063 616c 6c61  s a python calla
-00018450: 626c 6520 696e 746f 2061 2052 756e 6e61  ble into a Runna
-00018460: 626c 652e 0a0a 2020 2020 5772 6170 7069  ble...    Wrappi
-00018470: 6e67 2061 2063 616c 6c61 626c 6520 696e  ng a callable in
-00018480: 2061 2052 756e 6e61 626c 654c 616d 6264   a RunnableLambd
-00018490: 6120 6d61 6b65 7320 7468 6520 6361 6c6c  a makes the call
-000184a0: 6162 6c65 2075 7361 626c 650a 2020 2020  able usable.    
-000184b0: 7769 7468 696e 2065 6974 6865 7220 6120  within either a 
-000184c0: 7379 6e63 206f 7220 6173 796e 6320 636f  sync or async co
-000184d0: 6e74 6578 742e 0a0a 2020 2020 5275 6e6e  ntext...    Runn
-000184e0: 6162 6c65 4c61 6d62 6461 2063 616e 2062  ableLambda can b
-000184f0: 6520 636f 6d70 6f73 6564 2061 7320 616e  e composed as an
-00018500: 7920 6f74 6865 7220 5275 6e6e 6162 6c65  y other Runnable
-00018510: 2061 6e64 2070 726f 7669 6465 730a 2020   and provides.  
-00018520: 2020 7365 616d 6c65 7373 2069 6e74 6567    seamless integ
-00018530: 7261 7469 6f6e 2077 6974 6820 4c61 6e67  ration with Lang
-00018540: 4368 6169 6e20 7472 6163 696e 672e 0a0a  Chain tracing...
-00018550: 2020 2020 4578 616d 706c 6573 3a0a 0a20      Examples:.. 
-00018560: 2020 2020 2020 202e 2e20 636f 6465 2d62         .. code-b
-00018570: 6c6f 636b 3a3a 2070 7974 686f 6e0a 0a20  lock:: python.. 
-00018580: 2020 2020 2020 2020 2020 2023 2054 6869             # Thi
-00018590: 7320 6973 2061 2052 756e 6e61 626c 654c  s is a RunnableL
-000185a0: 616d 6264 610a 2020 2020 2020 2020 2020  ambda.          
-000185b0: 2020 6672 6f6d 206c 616e 6763 6861 696e    from langchain
-000185c0: 5f63 6f72 652e 7275 6e6e 6162 6c65 7320  _core.runnables 
-000185d0: 696d 706f 7274 2052 756e 6e61 626c 654c  import RunnableL
-000185e0: 616d 6264 610a 0a20 2020 2020 2020 2020  ambda..         
-000185f0: 2020 2064 6566 2061 6464 5f6f 6e65 2878     def add_one(x
-00018600: 3a20 696e 7429 202d 3e20 696e 743a 0a20  : int) -> int:. 
-00018610: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00018620: 6574 7572 6e20 7820 2b20 310a 0a20 2020  eturn x + 1..   
-00018630: 2020 2020 2020 2020 2072 756e 6e61 626c           runnabl
-00018640: 6520 3d20 5275 6e6e 6162 6c65 4c61 6d62  e = RunnableLamb
-00018650: 6461 2861 6464 5f6f 6e65 290a 0a20 2020  da(add_one)..   
-00018660: 2020 2020 2020 2020 2072 756e 6e61 626c           runnabl
-00018670: 652e 696e 766f 6b65 2831 2920 2320 7265  e.invoke(1) # re
-00018680: 7475 726e 7320 320a 2020 2020 2020 2020  turns 2.        
-00018690: 2020 2020 7275 6e6e 6162 6c65 2e62 6174      runnable.bat
-000186a0: 6368 285b 312c 2032 2c20 335d 2920 2320  ch([1, 2, 3]) # 
-000186b0: 7265 7475 726e 7320 5b32 2c20 332c 2034  returns [2, 3, 4
-000186c0: 5d0a 0a20 2020 2020 2020 2020 2020 2023  ]..            #
-000186d0: 2041 7379 6e63 2069 7320 7375 7070 6f72   Async is suppor
-000186e0: 7465 6420 6279 2064 6566 6175 6c74 2062  ted by default b
-000186f0: 7920 6465 6c65 6761 7469 6e67 2074 6f20  y delegating to 
-00018700: 7468 6520 7379 6e63 2069 6d70 6c65 6d65  the sync impleme
-00018710: 6e74 6174 696f 6e0a 2020 2020 2020 2020  ntation.        
-00018720: 2020 2020 6177 6169 7420 7275 6e6e 6162      await runnab
-00018730: 6c65 2e61 696e 766f 6b65 2831 2920 2320  le.ainvoke(1) # 
-00018740: 7265 7475 726e 7320 320a 2020 2020 2020  returns 2.      
-00018750: 2020 2020 2020 6177 6169 7420 7275 6e6e        await runn
-00018760: 6162 6c65 2e61 6261 7463 6828 5b31 2c20  able.abatch([1, 
-00018770: 322c 2033 5d29 2023 2072 6574 7572 6e73  2, 3]) # returns
-00018780: 205b 322c 2033 2c20 345d 0a0a 0a20 2020   [2, 3, 4]...   
-00018790: 2020 2020 2020 2020 2023 2041 6c74 6572           # Alter
-000187a0: 6e61 7469 7665 6c79 2c20 6361 6e20 7072  natively, can pr
-000187b0: 6f76 6964 6520 626f 7468 2073 796e 6420  ovide both synd 
-000187c0: 616e 6420 7379 6e63 2069 6d70 6c65 6d65  and sync impleme
-000187d0: 6e74 6174 696f 6e73 0a20 2020 2020 2020  ntations.       
-000187e0: 2020 2020 2061 7379 6e63 2064 6566 2061       async def a
-000187f0: 6464 5f6f 6e65 5f61 7379 6e63 2878 3a20  dd_one_async(x: 
-00018800: 696e 7429 202d 3e20 696e 743a 0a20 2020  int) -> int:.   
-00018810: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00018820: 7572 6e20 7820 2b20 310a 0a20 2020 2020  urn x + 1..     
-00018830: 2020 2020 2020 2072 756e 6e61 626c 6520         runnable 
-00018840: 3d20 5275 6e6e 6162 6c65 4c61 6d62 6461  = RunnableLambda
-00018850: 2861 6464 5f6f 6e65 2c20 6166 756e 633d  (add_one, afunc=
-00018860: 6164 645f 6f6e 655f 6173 796e 6329 0a20  add_one_async). 
-00018870: 2020 2020 2020 2020 2020 2072 756e 6e61             runna
-00018880: 626c 652e 696e 766f 6b65 2831 2920 2320  ble.invoke(1) # 
-00018890: 5573 6573 2061 6464 5f6f 6e65 0a20 2020  Uses add_one.   
-000188a0: 2020 2020 2020 2020 2061 7761 6974 2072           await r
-000188b0: 756e 6e61 626c 652e 6169 6e76 6f6b 6528  unnable.ainvoke(
-000188c0: 3129 2023 2055 7365 7320 6164 645f 6f6e  1) # Uses add_on
-000188d0: 655f 6173 796e 630a 2020 2020 2222 220a  e_async.    """.
-000188e0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-000188f0: 5f28 0a20 2020 2020 2020 2073 656c 662c  _(.        self,
-00018900: 0a20 2020 2020 2020 2066 756e 633a 2055  .        func: U
-00018910: 6e69 6f6e 5b0a 2020 2020 2020 2020 2020  nion[.          
-00018920: 2020 556e 696f 6e5b 0a20 2020 2020 2020    Union[.       
-00018930: 2020 2020 2020 2020 2043 616c 6c61 626c           Callabl
-00018940: 655b 5b49 6e70 7574 5d2c 204f 7574 7075  e[[Input], Outpu
-00018950: 745d 2c0a 2020 2020 2020 2020 2020 2020  t],.            
-00018960: 2020 2020 4361 6c6c 6162 6c65 5b5b 496e      Callable[[In
-00018970: 7075 745d 2c20 4974 6572 6174 6f72 5b4f  put], Iterator[O
-00018980: 7574 7075 745d 5d2c 0a20 2020 2020 2020  utput]],.       
-00018990: 2020 2020 2020 2020 2043 616c 6c61 626c           Callabl
-000189a0: 655b 5b49 6e70 7574 2c20 5275 6e6e 6162  e[[Input, Runnab
-000189b0: 6c65 436f 6e66 6967 5d2c 204f 7574 7075  leConfig], Outpu
-000189c0: 745d 2c0a 2020 2020 2020 2020 2020 2020  t],.            
-000189d0: 2020 2020 4361 6c6c 6162 6c65 5b5b 496e      Callable[[In
-000189e0: 7075 742c 2043 616c 6c62 6163 6b4d 616e  put, CallbackMan
-000189f0: 6167 6572 466f 7243 6861 696e 5275 6e5d  agerForChainRun]
-00018a00: 2c20 4f75 7470 7574 5d2c 0a20 2020 2020  , Output],.     
-00018a10: 2020 2020 2020 2020 2020 2043 616c 6c61             Calla
-00018a20: 626c 655b 5b49 6e70 7574 2c20 4361 6c6c  ble[[Input, Call
-00018a30: 6261 636b 4d61 6e61 6765 7246 6f72 4368  backManagerForCh
-00018a40: 6169 6e52 756e 2c20 5275 6e6e 6162 6c65  ainRun, Runnable
-00018a50: 436f 6e66 6967 5d2c 204f 7574 7075 745d  Config], Output]
-00018a60: 2c0a 2020 2020 2020 2020 2020 2020 5d2c  ,.            ],
-00018a70: 0a20 2020 2020 2020 2020 2020 2055 6e69  .            Uni
-00018a80: 6f6e 5b0a 2020 2020 2020 2020 2020 2020  on[.            
-00018a90: 2020 2020 4361 6c6c 6162 6c65 5b5b 496e      Callable[[In
-00018aa0: 7075 745d 2c20 4177 6169 7461 626c 655b  put], Awaitable[
-00018ab0: 4f75 7470 7574 5d5d 2c0a 2020 2020 2020  Output]],.      
-00018ac0: 2020 2020 2020 2020 2020 4361 6c6c 6162            Callab
-00018ad0: 6c65 5b5b 496e 7075 745d 2c20 4173 796e  le[[Input], Asyn
-00018ae0: 6349 7465 7261 746f 725b 4f75 7470 7574  cIterator[Output
-00018af0: 5d5d 2c0a 2020 2020 2020 2020 2020 2020  ]],.            
-00018b00: 2020 2020 4361 6c6c 6162 6c65 5b5b 496e      Callable[[In
-00018b10: 7075 742c 2052 756e 6e61 626c 6543 6f6e  put, RunnableCon
-00018b20: 6669 675d 2c20 4177 6169 7461 626c 655b  fig], Awaitable[
-00018b30: 4f75 7470 7574 5d5d 2c0a 2020 2020 2020  Output]],.      
-00018b40: 2020 2020 2020 2020 2020 4361 6c6c 6162            Callab
-00018b50: 6c65 5b5b 496e 7075 742c 2041 7379 6e63  le[[Input, Async
-00018b60: 4361 6c6c 6261 636b 4d61 6e61 6765 7246  CallbackManagerF
-00018b70: 6f72 4368 6169 6e52 756e 5d2c 2041 7761  orChainRun], Awa
-00018b80: 6974 6162 6c65 5b4f 7574 7075 745d 5d2c  itable[Output]],
-00018b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018ba0: 2043 616c 6c61 626c 655b 0a20 2020 2020   Callable[.     
-00018bb0: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-00018bc0: 496e 7075 742c 2041 7379 6e63 4361 6c6c  Input, AsyncCall
-00018bd0: 6261 636b 4d61 6e61 6765 7246 6f72 4368  backManagerForCh
-00018be0: 6169 6e52 756e 2c20 5275 6e6e 6162 6c65  ainRun, Runnable
-00018bf0: 436f 6e66 6967 5d2c 0a20 2020 2020 2020  Config],.       
-00018c00: 2020 2020 2020 2020 2020 2020 2041 7761               Awa
-00018c10: 6974 6162 6c65 5b4f 7574 7075 745d 2c0a  itable[Output],.
-00018c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018c30: 5d2c 0a20 2020 2020 2020 2020 2020 205d  ],.            ]
-00018c40: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-00018c50: 2020 2020 2061 6675 6e63 3a20 4f70 7469       afunc: Opti
-00018c60: 6f6e 616c 5b0a 2020 2020 2020 2020 2020  onal[.          
-00018c70: 2020 556e 696f 6e5b 0a20 2020 2020 2020    Union[.       
-00018c80: 2020 2020 2020 2020 2043 616c 6c61 626c           Callabl
-00018c90: 655b 5b49 6e70 7574 5d2c 2041 7761 6974  e[[Input], Await
-00018ca0: 6162 6c65 5b4f 7574 7075 745d 5d2c 0a20  able[Output]],. 
-00018cb0: 2020 2020 2020 2020 2020 2020 2020 2043                 C
-00018cc0: 616c 6c61 626c 655b 5b49 6e70 7574 5d2c  allable[[Input],
-00018cd0: 2041 7379 6e63 4974 6572 6174 6f72 5b4f   AsyncIterator[O
-00018ce0: 7574 7075 745d 5d2c 0a20 2020 2020 2020  utput]],.       
-00018cf0: 2020 2020 2020 2020 2043 616c 6c61 626c           Callabl
-00018d00: 655b 5b49 6e70 7574 2c20 5275 6e6e 6162  e[[Input, Runnab
-00018d10: 6c65 436f 6e66 6967 5d2c 2041 7761 6974  leConfig], Await
-00018d20: 6162 6c65 5b4f 7574 7075 745d 5d2c 0a20  able[Output]],. 
-00018d30: 2020 2020 2020 2020 2020 2020 2020 2043                 C
-00018d40: 616c 6c61 626c 655b 5b49 6e70 7574 2c20  allable[[Input, 
-00018d50: 4173 796e 6343 616c 6c62 6163 6b4d 616e  AsyncCallbackMan
-00018d60: 6167 6572 466f 7243 6861 696e 5275 6e5d  agerForChainRun]
-00018d70: 2c20 4177 6169 7461 626c 655b 4f75 7470  , Awaitable[Outp
-00018d80: 7574 5d5d 2c0a 2020 2020 2020 2020 2020  ut]],.          
-00018d90: 2020 2020 2020 4361 6c6c 6162 6c65 5b0a        Callable[.
+00016920: 2069 6478 2c0a 2020 2020 2020 2020 2020   idx,.          
+00016930: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00016940: 2072 6574 7572 6e20 6765 745f 756e 6971   return get_uniq
+00016950: 7565 5f63 6f6e 6669 675f 7370 6563 7328  ue_config_specs(
+00016960: 7370 6563 2066 6f72 2073 7065 632c 205f  spec for spec, _
+00016970: 2069 6e20 616c 6c5f 7370 6563 7329 0a0a   in all_specs)..
+00016980: 2020 2020 6465 6620 6765 745f 6772 6170      def get_grap
+00016990: 6828 7365 6c66 2c20 636f 6e66 6967 3a20  h(self, config: 
+000169a0: 4f70 7469 6f6e 616c 5b52 756e 6e61 626c  Optional[Runnabl
+000169b0: 6543 6f6e 6669 675d 203d 204e 6f6e 6529  eConfig] = None)
+000169c0: 202d 3e20 4772 6170 683a 0a20 2020 2020   -> Graph:.     
+000169d0: 2020 2066 726f 6d20 6c61 6e67 6368 6169     from langchai
+000169e0: 6e5f 636f 7265 2e72 756e 6e61 626c 6573  n_core.runnables
+000169f0: 2e67 7261 7068 2069 6d70 6f72 7420 4772  .graph import Gr
+00016a00: 6170 680a 0a20 2020 2020 2020 2067 7261  aph..        gra
+00016a10: 7068 203d 2047 7261 7068 2829 0a20 2020  ph = Graph().   
+00016a20: 2020 2020 2066 6f72 2073 7465 7020 696e       for step in
+00016a30: 2073 656c 662e 7374 6570 733a 0a20 2020   self.steps:.   
+00016a40: 2020 2020 2020 2020 2063 7572 7265 6e74           current
+00016a50: 5f6c 6173 745f 6e6f 6465 203d 2067 7261  _last_node = gra
+00016a60: 7068 2e6c 6173 745f 6e6f 6465 2829 0a20  ph.last_node(). 
+00016a70: 2020 2020 2020 2020 2020 2073 7465 705f             step_
+00016a80: 6772 6170 6820 3d20 7374 6570 2e67 6574  graph = step.get
+00016a90: 5f67 7261 7068 2863 6f6e 6669 6729 0a20  _graph(config). 
+00016aa0: 2020 2020 2020 2020 2020 2069 6620 7374             if st
+00016ab0: 6570 2069 7320 6e6f 7420 7365 6c66 2e66  ep is not self.f
+00016ac0: 6972 7374 3a0a 2020 2020 2020 2020 2020  irst:.          
+00016ad0: 2020 2020 2020 7374 6570 5f67 7261 7068        step_graph
+00016ae0: 2e74 7269 6d5f 6669 7273 745f 6e6f 6465  .trim_first_node
+00016af0: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
+00016b00: 6620 7374 6570 2069 7320 6e6f 7420 7365  f step is not se
+00016b10: 6c66 2e6c 6173 743a 0a20 2020 2020 2020  lf.last:.       
+00016b20: 2020 2020 2020 2020 2073 7465 705f 6772           step_gr
+00016b30: 6170 682e 7472 696d 5f6c 6173 745f 6e6f  aph.trim_last_no
+00016b40: 6465 2829 0a20 2020 2020 2020 2020 2020  de().           
+00016b50: 2073 7465 705f 6669 7273 745f 6e6f 6465   step_first_node
+00016b60: 2c20 5f20 3d20 6772 6170 682e 6578 7465  , _ = graph.exte
+00016b70: 6e64 2873 7465 705f 6772 6170 6829 0a20  nd(step_graph). 
+00016b80: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00016b90: 7420 7374 6570 5f66 6972 7374 5f6e 6f64  t step_first_nod
+00016ba0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00016bb0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00016bc0: 726f 7228 6622 5275 6e6e 6162 6c65 207b  ror(f"Runnable {
+00016bd0: 7374 6570 7d20 6861 7320 6e6f 2066 6972  step} has no fir
+00016be0: 7374 206e 6f64 6522 290a 2020 2020 2020  st node").      
+00016bf0: 2020 2020 2020 6966 2063 7572 7265 6e74        if current
+00016c00: 5f6c 6173 745f 6e6f 6465 3a0a 2020 2020  _last_node:.    
+00016c10: 2020 2020 2020 2020 2020 2020 6772 6170              grap
+00016c20: 682e 6164 645f 6564 6765 2863 7572 7265  h.add_edge(curre
+00016c30: 6e74 5f6c 6173 745f 6e6f 6465 2c20 7374  nt_last_node, st
+00016c40: 6570 5f66 6972 7374 5f6e 6f64 6529 0a0a  ep_first_node)..
+00016c50: 2020 2020 2020 2020 7265 7475 726e 2067          return g
+00016c60: 7261 7068 0a0a 2020 2020 6465 6620 5f5f  raph..    def __
+00016c70: 7265 7072 5f5f 2873 656c 6629 202d 3e20  repr__(self) -> 
+00016c80: 7374 723a 0a20 2020 2020 2020 2072 6574  str:.        ret
+00016c90: 7572 6e20 225c 6e7c 2022 2e6a 6f69 6e28  urn "\n| ".join(
+00016ca0: 0a20 2020 2020 2020 2020 2020 2072 6570  .            rep
+00016cb0: 7228 7329 2069 6620 6920 3d3d 2030 2065  r(s) if i == 0 e
+00016cc0: 6c73 6520 696e 6465 6e74 5f6c 696e 6573  lse indent_lines
+00016cd0: 5f61 6674 6572 5f66 6972 7374 2872 6570  _after_first(rep
+00016ce0: 7228 7329 2c20 227c 2022 290a 2020 2020  r(s), "| ").    
+00016cf0: 2020 2020 2020 2020 666f 7220 692c 2073          for i, s
+00016d00: 2069 6e20 656e 756d 6572 6174 6528 7365   in enumerate(se
+00016d10: 6c66 2e73 7465 7073 290a 2020 2020 2020  lf.steps).      
+00016d20: 2020 290a 0a20 2020 2064 6566 205f 5f6f    )..    def __o
+00016d30: 725f 5f28 0a20 2020 2020 2020 2073 656c  r__(.        sel
+00016d40: 662c 0a20 2020 2020 2020 206f 7468 6572  f,.        other
+00016d50: 3a20 556e 696f 6e5b 0a20 2020 2020 2020  : Union[.       
+00016d60: 2020 2020 2052 756e 6e61 626c 655b 416e       Runnable[An
+00016d70: 792c 204f 7468 6572 5d2c 0a20 2020 2020  y, Other],.     
+00016d80: 2020 2020 2020 2043 616c 6c61 626c 655b         Callable[
+00016d90: 5b41 6e79 5d2c 204f 7468 6572 5d2c 0a20  [Any], Other],. 
+00016da0: 2020 2020 2020 2020 2020 2043 616c 6c61             Calla
+00016db0: 626c 655b 5b49 7465 7261 746f 725b 416e  ble[[Iterator[An
+00016dc0: 795d 5d2c 2049 7465 7261 746f 725b 4f74  y]], Iterator[Ot
+00016dd0: 6865 725d 5d2c 0a20 2020 2020 2020 2020  her]],.         
+00016de0: 2020 204d 6170 7069 6e67 5b73 7472 2c20     Mapping[str, 
+00016df0: 556e 696f 6e5b 5275 6e6e 6162 6c65 5b41  Union[Runnable[A
+00016e00: 6e79 2c20 4f74 6865 725d 2c20 4361 6c6c  ny, Other], Call
+00016e10: 6162 6c65 5b5b 416e 795d 2c20 4f74 6865  able[[Any], Othe
+00016e20: 725d 2c20 416e 795d 5d2c 0a20 2020 2020  r], Any]],.     
+00016e30: 2020 205d 2c0a 2020 2020 2920 2d3e 2052     ],.    ) -> R
+00016e40: 756e 6e61 626c 6553 6572 6961 6c69 7a61  unnableSerializa
+00016e50: 626c 655b 496e 7075 742c 204f 7468 6572  ble[Input, Other
+00016e60: 5d3a 0a20 2020 2020 2020 2069 6620 6973  ]:.        if is
+00016e70: 696e 7374 616e 6365 286f 7468 6572 2c20  instance(other, 
+00016e80: 5275 6e6e 6162 6c65 5365 7175 656e 6365  RunnableSequence
+00016e90: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00016ea0: 6574 7572 6e20 5275 6e6e 6162 6c65 5365  eturn RunnableSe
+00016eb0: 7175 656e 6365 280a 2020 2020 2020 2020  quence(.        
+00016ec0: 2020 2020 2020 2020 7365 6c66 2e66 6972          self.fir
+00016ed0: 7374 2c0a 2020 2020 2020 2020 2020 2020  st,.            
+00016ee0: 2020 2020 2a73 656c 662e 6d69 6464 6c65      *self.middle
+00016ef0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00016f00: 2020 7365 6c66 2e6c 6173 742c 0a20 2020    self.last,.   
+00016f10: 2020 2020 2020 2020 2020 2020 206f 7468               oth
+00016f20: 6572 2e66 6972 7374 2c0a 2020 2020 2020  er.first,.      
+00016f30: 2020 2020 2020 2020 2020 2a6f 7468 6572            *other
+00016f40: 2e6d 6964 646c 652c 0a20 2020 2020 2020  .middle,.       
+00016f50: 2020 2020 2020 2020 206f 7468 6572 2e6c           other.l
+00016f60: 6173 742c 0a20 2020 2020 2020 2020 2020  ast,.           
+00016f70: 2020 2020 206e 616d 653d 7365 6c66 2e6e       name=self.n
+00016f80: 616d 6520 6f72 206f 7468 6572 2e6e 616d  ame or other.nam
+00016f90: 652c 0a20 2020 2020 2020 2020 2020 2029  e,.            )
+00016fa0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00016fb0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00016fc0: 6e20 5275 6e6e 6162 6c65 5365 7175 656e  n RunnableSequen
+00016fd0: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
+00016fe0: 2020 2020 7365 6c66 2e66 6972 7374 2c0a      self.first,.
+00016ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017000: 2a73 656c 662e 6d69 6464 6c65 2c0a 2020  *self.middle,.  
+00017010: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00017020: 6c66 2e6c 6173 742c 0a20 2020 2020 2020  lf.last,.       
+00017030: 2020 2020 2020 2020 2063 6f65 7263 655f           coerce_
+00017040: 746f 5f72 756e 6e61 626c 6528 6f74 6865  to_runnable(othe
+00017050: 7229 2c0a 2020 2020 2020 2020 2020 2020  r),.            
+00017060: 2020 2020 6e61 6d65 3d73 656c 662e 6e61      name=self.na
+00017070: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+00017080: 290a 0a20 2020 2064 6566 205f 5f72 6f72  )..    def __ror
+00017090: 5f5f 280a 2020 2020 2020 2020 7365 6c66  __(.        self
+000170a0: 2c0a 2020 2020 2020 2020 6f74 6865 723a  ,.        other:
+000170b0: 2055 6e69 6f6e 5b0a 2020 2020 2020 2020   Union[.        
+000170c0: 2020 2020 5275 6e6e 6162 6c65 5b4f 7468      Runnable[Oth
+000170d0: 6572 2c20 416e 795d 2c0a 2020 2020 2020  er, Any],.      
+000170e0: 2020 2020 2020 4361 6c6c 6162 6c65 5b5b        Callable[[
+000170f0: 4f74 6865 725d 2c20 416e 795d 2c0a 2020  Other], Any],.  
+00017100: 2020 2020 2020 2020 2020 4361 6c6c 6162            Callab
+00017110: 6c65 5b5b 4974 6572 6174 6f72 5b4f 7468  le[[Iterator[Oth
+00017120: 6572 5d5d 2c20 4974 6572 6174 6f72 5b41  er]], Iterator[A
+00017130: 6e79 5d5d 2c0a 2020 2020 2020 2020 2020  ny]],.          
+00017140: 2020 4d61 7070 696e 675b 7374 722c 2055    Mapping[str, U
+00017150: 6e69 6f6e 5b52 756e 6e61 626c 655b 4f74  nion[Runnable[Ot
+00017160: 6865 722c 2041 6e79 5d2c 2043 616c 6c61  her, Any], Calla
+00017170: 626c 655b 5b4f 7468 6572 5d2c 2041 6e79  ble[[Other], Any
+00017180: 5d2c 2041 6e79 5d5d 2c0a 2020 2020 2020  ], Any]],.      
+00017190: 2020 5d2c 0a20 2020 2029 202d 3e20 5275    ],.    ) -> Ru
+000171a0: 6e6e 6162 6c65 5365 7269 616c 697a 6162  nnableSerializab
+000171b0: 6c65 5b4f 7468 6572 2c20 4f75 7470 7574  le[Other, Output
+000171c0: 5d3a 0a20 2020 2020 2020 2069 6620 6973  ]:.        if is
+000171d0: 696e 7374 616e 6365 286f 7468 6572 2c20  instance(other, 
+000171e0: 5275 6e6e 6162 6c65 5365 7175 656e 6365  RunnableSequence
+000171f0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00017200: 6574 7572 6e20 5275 6e6e 6162 6c65 5365  eturn RunnableSe
+00017210: 7175 656e 6365 280a 2020 2020 2020 2020  quence(.        
+00017220: 2020 2020 2020 2020 6f74 6865 722e 6669          other.fi
+00017230: 7273 742c 0a20 2020 2020 2020 2020 2020  rst,.           
+00017240: 2020 2020 202a 6f74 6865 722e 6d69 6464       *other.midd
+00017250: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
+00017260: 2020 2020 6f74 6865 722e 6c61 7374 2c0a      other.last,.
+00017270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017280: 7365 6c66 2e66 6972 7374 2c0a 2020 2020  self.first,.    
+00017290: 2020 2020 2020 2020 2020 2020 2a73 656c              *sel
+000172a0: 662e 6d69 6464 6c65 2c0a 2020 2020 2020  f.middle,.      
+000172b0: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
+000172c0: 6173 742c 0a20 2020 2020 2020 2020 2020  ast,.           
+000172d0: 2020 2020 206e 616d 653d 6f74 6865 722e       name=other.
+000172e0: 6e61 6d65 206f 7220 7365 6c66 2e6e 616d  name or self.nam
+000172f0: 652c 0a20 2020 2020 2020 2020 2020 2029  e,.            )
+00017300: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00017310: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00017320: 6e20 5275 6e6e 6162 6c65 5365 7175 656e  n RunnableSequen
+00017330: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
+00017340: 2020 2020 636f 6572 6365 5f74 6f5f 7275      coerce_to_ru
+00017350: 6e6e 6162 6c65 286f 7468 6572 292c 0a20  nnable(other),. 
+00017360: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00017370: 656c 662e 6669 7273 742c 0a20 2020 2020  elf.first,.     
+00017380: 2020 2020 2020 2020 2020 202a 7365 6c66             *self
+00017390: 2e6d 6964 646c 652c 0a20 2020 2020 2020  .middle,.       
+000173a0: 2020 2020 2020 2020 2073 656c 662e 6c61           self.la
+000173b0: 7374 2c0a 2020 2020 2020 2020 2020 2020  st,.            
+000173c0: 2020 2020 6e61 6d65 3d73 656c 662e 6e61      name=self.na
+000173d0: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+000173e0: 290a 0a20 2020 2064 6566 2069 6e76 6f6b  )..    def invok
+000173f0: 6528 7365 6c66 2c20 696e 7075 743a 2049  e(self, input: I
+00017400: 6e70 7574 2c20 636f 6e66 6967 3a20 4f70  nput, config: Op
+00017410: 7469 6f6e 616c 5b52 756e 6e61 626c 6543  tional[RunnableC
+00017420: 6f6e 6669 675d 203d 204e 6f6e 6529 202d  onfig] = None) -
+00017430: 3e20 4f75 7470 7574 3a0a 2020 2020 2020  > Output:.      
+00017440: 2020 6672 6f6d 206c 616e 6763 6861 696e    from langchain
+00017450: 5f63 6f72 652e 6265 7461 2e72 756e 6e61  _core.beta.runna
+00017460: 626c 6573 2e63 6f6e 7465 7874 2069 6d70  bles.context imp
+00017470: 6f72 7420 636f 6e66 6967 5f77 6974 685f  ort config_with_
+00017480: 636f 6e74 6578 740a 0a20 2020 2020 2020  context..       
+00017490: 2023 2073 6574 7570 2063 616c 6c62 6163   # setup callbac
+000174a0: 6b73 2061 6e64 2063 6f6e 7465 7874 0a20  ks and context. 
+000174b0: 2020 2020 2020 2063 6f6e 6669 6720 3d20         config = 
+000174c0: 636f 6e66 6967 5f77 6974 685f 636f 6e74  config_with_cont
+000174d0: 6578 7428 656e 7375 7265 5f63 6f6e 6669  ext(ensure_confi
+000174e0: 6728 636f 6e66 6967 292c 2073 656c 662e  g(config), self.
+000174f0: 7374 6570 7329 0a20 2020 2020 2020 2063  steps).        c
+00017500: 616c 6c62 6163 6b5f 6d61 6e61 6765 7220  allback_manager 
+00017510: 3d20 6765 745f 6361 6c6c 6261 636b 5f6d  = get_callback_m
+00017520: 616e 6167 6572 5f66 6f72 5f63 6f6e 6669  anager_for_confi
+00017530: 6728 636f 6e66 6967 290a 2020 2020 2020  g(config).      
+00017540: 2020 2320 7374 6172 7420 7468 6520 726f    # start the ro
+00017550: 6f74 2072 756e 0a20 2020 2020 2020 2072  ot run.        r
+00017560: 756e 5f6d 616e 6167 6572 203d 2063 616c  un_manager = cal
+00017570: 6c62 6163 6b5f 6d61 6e61 6765 722e 6f6e  lback_manager.on
+00017580: 5f63 6861 696e 5f73 7461 7274 280a 2020  _chain_start(.  
+00017590: 2020 2020 2020 2020 2020 6475 6d70 6428            dumpd(
+000175a0: 7365 6c66 292c 0a20 2020 2020 2020 2020  self),.         
+000175b0: 2020 2069 6e70 7574 2c0a 2020 2020 2020     input,.      
+000175c0: 2020 2020 2020 6e61 6d65 3d63 6f6e 6669        name=confi
+000175d0: 672e 6765 7428 2272 756e 5f6e 616d 6522  g.get("run_name"
+000175e0: 2920 6f72 2073 656c 662e 6765 745f 6e61  ) or self.get_na
+000175f0: 6d65 2829 2c0a 2020 2020 2020 2020 2020  me(),.          
+00017600: 2020 7275 6e5f 6964 3d63 6f6e 6669 672e    run_id=config.
+00017610: 706f 7028 2272 756e 5f69 6422 2c20 4e6f  pop("run_id", No
+00017620: 6e65 292c 0a20 2020 2020 2020 2029 0a0a  ne),.        )..
+00017630: 2020 2020 2020 2020 2320 696e 766f 6b65          # invoke
+00017640: 2061 6c6c 2073 7465 7073 2069 6e20 7365   all steps in se
+00017650: 7175 656e 6365 0a20 2020 2020 2020 2074  quence.        t
+00017660: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00017670: 666f 7220 692c 2073 7465 7020 696e 2065  for i, step in e
+00017680: 6e75 6d65 7261 7465 2873 656c 662e 7374  numerate(self.st
+00017690: 6570 7329 3a0a 2020 2020 2020 2020 2020  eps):.          
+000176a0: 2020 2020 2020 696e 7075 7420 3d20 7374        input = st
+000176b0: 6570 2e69 6e76 6f6b 6528 0a20 2020 2020  ep.invoke(.     
+000176c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000176d0: 6e70 7574 2c0a 2020 2020 2020 2020 2020  nput,.          
+000176e0: 2020 2020 2020 2020 2020 2320 6d61 726b            # mark
+000176f0: 2065 6163 6820 7374 6570 2061 7320 6120   each step as a 
+00017700: 6368 696c 6420 7275 6e0a 2020 2020 2020  child run.      
+00017710: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00017720: 7463 685f 636f 6e66 6967 280a 2020 2020  tch_config(.    
+00017730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017740: 2020 2020 636f 6e66 6967 2c20 6361 6c6c      config, call
+00017750: 6261 636b 733d 7275 6e5f 6d61 6e61 6765  backs=run_manage
+00017760: 722e 6765 745f 6368 696c 6428 6622 7365  r.get_child(f"se
+00017770: 713a 7374 6570 3a7b 692b 317d 2229 0a20  q:step:{i+1}"). 
+00017780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017790: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+000177a0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000177b0: 2320 6669 6e69 7368 2074 6865 2072 6f6f  # finish the roo
+000177c0: 7420 7275 6e0a 2020 2020 2020 2020 6578  t run.        ex
+000177d0: 6365 7074 2042 6173 6545 7863 6570 7469  cept BaseExcepti
+000177e0: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+000177f0: 2020 2020 2072 756e 5f6d 616e 6167 6572       run_manager
+00017800: 2e6f 6e5f 6368 6169 6e5f 6572 726f 7228  .on_chain_error(
+00017810: 6529 0a20 2020 2020 2020 2020 2020 2072  e).            r
+00017820: 6169 7365 0a20 2020 2020 2020 2065 6c73  aise.        els
+00017830: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00017840: 756e 5f6d 616e 6167 6572 2e6f 6e5f 6368  un_manager.on_ch
+00017850: 6169 6e5f 656e 6428 696e 7075 7429 0a20  ain_end(input). 
+00017860: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00017870: 6e20 6361 7374 284f 7574 7075 742c 2069  n cast(Output, i
+00017880: 6e70 7574 290a 0a20 2020 2061 7379 6e63  nput)..    async
+00017890: 2064 6566 2061 696e 766f 6b65 280a 2020   def ainvoke(.  
+000178a0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+000178b0: 2020 2020 696e 7075 743a 2049 6e70 7574      input: Input
+000178c0: 2c0a 2020 2020 2020 2020 636f 6e66 6967  ,.        config
+000178d0: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
+000178e0: 626c 6543 6f6e 6669 675d 203d 204e 6f6e  bleConfig] = Non
+000178f0: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
+00017900: 7267 733a 204f 7074 696f 6e61 6c5b 416e  rgs: Optional[An
+00017910: 795d 2c0a 2020 2020 2920 2d3e 204f 7574  y],.    ) -> Out
+00017920: 7075 743a 0a20 2020 2020 2020 2066 726f  put:.        fro
+00017930: 6d20 6c61 6e67 6368 6169 6e5f 636f 7265  m langchain_core
+00017940: 2e62 6574 612e 7275 6e6e 6162 6c65 732e  .beta.runnables.
+00017950: 636f 6e74 6578 7420 696d 706f 7274 2061  context import a
+00017960: 636f 6e66 6967 5f77 6974 685f 636f 6e74  config_with_cont
+00017970: 6578 740a 0a20 2020 2020 2020 2023 2073  ext..        # s
+00017980: 6574 7570 2063 616c 6c62 6163 6b73 2061  etup callbacks a
+00017990: 6e64 2063 6f6e 7465 7874 0a20 2020 2020  nd context.     
+000179a0: 2020 2063 6f6e 6669 6720 3d20 6163 6f6e     config = acon
+000179b0: 6669 675f 7769 7468 5f63 6f6e 7465 7874  fig_with_context
+000179c0: 2865 6e73 7572 655f 636f 6e66 6967 2863  (ensure_config(c
+000179d0: 6f6e 6669 6729 2c20 7365 6c66 2e73 7465  onfig), self.ste
+000179e0: 7073 290a 2020 2020 2020 2020 6361 6c6c  ps).        call
+000179f0: 6261 636b 5f6d 616e 6167 6572 203d 2067  back_manager = g
+00017a00: 6574 5f61 7379 6e63 5f63 616c 6c62 6163  et_async_callbac
+00017a10: 6b5f 6d61 6e61 6765 725f 666f 725f 636f  k_manager_for_co
+00017a20: 6e66 6967 2863 6f6e 6669 6729 0a20 2020  nfig(config).   
+00017a30: 2020 2020 2023 2073 7461 7274 2074 6865       # start the
+00017a40: 2072 6f6f 7420 7275 6e0a 2020 2020 2020   root run.      
+00017a50: 2020 7275 6e5f 6d61 6e61 6765 7220 3d20    run_manager = 
+00017a60: 6177 6169 7420 6361 6c6c 6261 636b 5f6d  await callback_m
+00017a70: 616e 6167 6572 2e6f 6e5f 6368 6169 6e5f  anager.on_chain_
+00017a80: 7374 6172 7428 0a20 2020 2020 2020 2020  start(.         
+00017a90: 2020 2064 756d 7064 2873 656c 6629 2c0a     dumpd(self),.
+00017aa0: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+00017ab0: 742c 0a20 2020 2020 2020 2020 2020 206e  t,.            n
+00017ac0: 616d 653d 636f 6e66 6967 2e67 6574 2822  ame=config.get("
+00017ad0: 7275 6e5f 6e61 6d65 2229 206f 7220 7365  run_name") or se
+00017ae0: 6c66 2e67 6574 5f6e 616d 6528 292c 0a20  lf.get_name(),. 
+00017af0: 2020 2020 2020 2020 2020 2072 756e 5f69             run_i
+00017b00: 643d 636f 6e66 6967 2e70 6f70 2822 7275  d=config.pop("ru
+00017b10: 6e5f 6964 222c 204e 6f6e 6529 2c0a 2020  n_id", None),.  
+00017b20: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00017b30: 2023 2069 6e76 6f6b 6520 616c 6c20 7374   # invoke all st
+00017b40: 6570 7320 696e 2073 6571 7565 6e63 650a  eps in sequence.
+00017b50: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00017b60: 2020 2020 2020 2020 2066 6f72 2069 2c20           for i, 
+00017b70: 7374 6570 2069 6e20 656e 756d 6572 6174  step in enumerat
+00017b80: 6528 7365 6c66 2e73 7465 7073 293a 0a20  e(self.steps):. 
+00017b90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00017ba0: 6e70 7574 203d 2061 7761 6974 2073 7465  nput = await ste
+00017bb0: 702e 6169 6e76 6f6b 6528 0a20 2020 2020  p.ainvoke(.     
+00017bc0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00017bd0: 6e70 7574 2c0a 2020 2020 2020 2020 2020  nput,.          
+00017be0: 2020 2020 2020 2020 2020 2320 6d61 726b            # mark
+00017bf0: 2065 6163 6820 7374 6570 2061 7320 6120   each step as a 
+00017c00: 6368 696c 6420 7275 6e0a 2020 2020 2020  child run.      
+00017c10: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00017c20: 7463 685f 636f 6e66 6967 280a 2020 2020  tch_config(.    
+00017c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017c40: 2020 2020 636f 6e66 6967 2c20 6361 6c6c      config, call
+00017c50: 6261 636b 733d 7275 6e5f 6d61 6e61 6765  backs=run_manage
+00017c60: 722e 6765 745f 6368 696c 6428 6622 7365  r.get_child(f"se
+00017c70: 713a 7374 6570 3a7b 692b 317d 2229 0a20  q:step:{i+1}"). 
+00017c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017c90: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+00017ca0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00017cb0: 2320 6669 6e69 7368 2074 6865 2072 6f6f  # finish the roo
+00017cc0: 7420 7275 6e0a 2020 2020 2020 2020 6578  t run.        ex
+00017cd0: 6365 7074 2042 6173 6545 7863 6570 7469  cept BaseExcepti
+00017ce0: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+00017cf0: 2020 2020 2061 7761 6974 2072 756e 5f6d       await run_m
+00017d00: 616e 6167 6572 2e6f 6e5f 6368 6169 6e5f  anager.on_chain_
+00017d10: 6572 726f 7228 6529 0a20 2020 2020 2020  error(e).       
+00017d20: 2020 2020 2072 6169 7365 0a20 2020 2020       raise.     
+00017d30: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00017d40: 2020 2020 2061 7761 6974 2072 756e 5f6d       await run_m
+00017d50: 616e 6167 6572 2e6f 6e5f 6368 6169 6e5f  anager.on_chain_
+00017d60: 656e 6428 696e 7075 7429 0a20 2020 2020  end(input).     
+00017d70: 2020 2020 2020 2072 6574 7572 6e20 6361         return ca
+00017d80: 7374 284f 7574 7075 742c 2069 6e70 7574  st(Output, input
+00017d90: 290a 0a20 2020 2064 6566 2062 6174 6368  )..    def batch
+00017da0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00017db0: 2020 2020 2020 2020 696e 7075 7473 3a20          inputs: 
+00017dc0: 4c69 7374 5b49 6e70 7574 5d2c 0a20 2020  List[Input],.   
+00017dd0: 2020 2020 2063 6f6e 6669 673a 204f 7074       config: Opt
+00017de0: 696f 6e61 6c5b 556e 696f 6e5b 5275 6e6e  ional[Union[Runn
+00017df0: 6162 6c65 436f 6e66 6967 2c20 4c69 7374  ableConfig, List
+00017e00: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+00017e10: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
+00017e20: 2020 202a 2c0a 2020 2020 2020 2020 7265     *,.        re
+00017e30: 7475 726e 5f65 7863 6570 7469 6f6e 733a  turn_exceptions:
+00017e40: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+00017e50: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
+00017e60: 204f 7074 696f 6e61 6c5b 416e 795d 2c0a   Optional[Any],.
+00017e70: 2020 2020 2920 2d3e 204c 6973 745b 4f75      ) -> List[Ou
+00017e80: 7470 7574 5d3a 0a20 2020 2020 2020 2066  tput]:.        f
+00017e90: 726f 6d20 6c61 6e67 6368 6169 6e5f 636f  rom langchain_co
+00017ea0: 7265 2e62 6574 612e 7275 6e6e 6162 6c65  re.beta.runnable
+00017eb0: 732e 636f 6e74 6578 7420 696d 706f 7274  s.context import
+00017ec0: 2063 6f6e 6669 675f 7769 7468 5f63 6f6e   config_with_con
+00017ed0: 7465 7874 0a20 2020 2020 2020 2066 726f  text.        fro
+00017ee0: 6d20 6c61 6e67 6368 6169 6e5f 636f 7265  m langchain_core
+00017ef0: 2e63 616c 6c62 6163 6b73 2e6d 616e 6167  .callbacks.manag
+00017f00: 6572 2069 6d70 6f72 7420 4361 6c6c 6261  er import Callba
+00017f10: 636b 4d61 6e61 6765 720a 0a20 2020 2020  ckManager..     
+00017f20: 2020 2069 6620 6e6f 7420 696e 7075 7473     if not inputs
+00017f30: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00017f40: 7475 726e 205b 5d0a 0a20 2020 2020 2020  turn []..       
+00017f50: 2023 2073 6574 7570 2063 616c 6c62 6163   # setup callbac
+00017f60: 6b73 2061 6e64 2063 6f6e 7465 7874 0a20  ks and context. 
+00017f70: 2020 2020 2020 2063 6f6e 6669 6773 203d         configs =
+00017f80: 205b 0a20 2020 2020 2020 2020 2020 2063   [.            c
+00017f90: 6f6e 6669 675f 7769 7468 5f63 6f6e 7465  onfig_with_conte
+00017fa0: 7874 2863 2c20 7365 6c66 2e73 7465 7073  xt(c, self.steps
+00017fb0: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+00017fc0: 7220 6320 696e 2067 6574 5f63 6f6e 6669  r c in get_confi
+00017fd0: 675f 6c69 7374 2863 6f6e 6669 672c 206c  g_list(config, l
+00017fe0: 656e 2869 6e70 7574 7329 290a 2020 2020  en(inputs)).    
+00017ff0: 2020 2020 5d0a 2020 2020 2020 2020 6361      ].        ca
+00018000: 6c6c 6261 636b 5f6d 616e 6167 6572 7320  llback_managers 
+00018010: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+00018020: 4361 6c6c 6261 636b 4d61 6e61 6765 722e  CallbackManager.
+00018030: 636f 6e66 6967 7572 6528 0a20 2020 2020  configure(.     
+00018040: 2020 2020 2020 2020 2020 2069 6e68 6572             inher
+00018050: 6974 6162 6c65 5f63 616c 6c62 6163 6b73  itable_callbacks
+00018060: 3d63 6f6e 6669 672e 6765 7428 2263 616c  =config.get("cal
+00018070: 6c62 6163 6b73 2229 2c0a 2020 2020 2020  lbacks"),.      
+00018080: 2020 2020 2020 2020 2020 6c6f 6361 6c5f            local_
+00018090: 6361 6c6c 6261 636b 733d 4e6f 6e65 2c0a  callbacks=None,.
+000180a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000180b0: 7665 7262 6f73 653d 4661 6c73 652c 0a20  verbose=False,. 
+000180c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000180d0: 6e68 6572 6974 6162 6c65 5f74 6167 733d  nheritable_tags=
+000180e0: 636f 6e66 6967 2e67 6574 2822 7461 6773  config.get("tags
+000180f0: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+00018100: 2020 2020 6c6f 6361 6c5f 7461 6773 3d4e      local_tags=N
+00018110: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00018120: 2020 2020 2069 6e68 6572 6974 6162 6c65       inheritable
+00018130: 5f6d 6574 6164 6174 613d 636f 6e66 6967  _metadata=config
+00018140: 2e67 6574 2822 6d65 7461 6461 7461 2229  .get("metadata")
+00018150: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018160: 2020 6c6f 6361 6c5f 6d65 7461 6461 7461    local_metadata
+00018170: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
+00018180: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00018190: 2066 6f72 2063 6f6e 6669 6720 696e 2063   for config in c
+000181a0: 6f6e 6669 6773 0a20 2020 2020 2020 205d  onfigs.        ]
+000181b0: 0a20 2020 2020 2020 2023 2073 7461 7274  .        # start
+000181c0: 2074 6865 2072 6f6f 7420 7275 6e73 2c20   the root runs, 
+000181d0: 6f6e 6520 7065 7220 696e 7075 740a 2020  one per input.  
+000181e0: 2020 2020 2020 7275 6e5f 6d61 6e61 6765        run_manage
+000181f0: 7273 203d 205b 0a20 2020 2020 2020 2020  rs = [.         
+00018200: 2020 2063 6d2e 6f6e 5f63 6861 696e 5f73     cm.on_chain_s
+00018210: 7461 7274 280a 2020 2020 2020 2020 2020  tart(.          
+00018220: 2020 2020 2020 6475 6d70 6428 7365 6c66        dumpd(self
+00018230: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00018240: 2020 2069 6e70 7574 2c0a 2020 2020 2020     input,.      
+00018250: 2020 2020 2020 2020 2020 6e61 6d65 3d63            name=c
+00018260: 6f6e 6669 672e 6765 7428 2272 756e 5f6e  onfig.get("run_n
+00018270: 616d 6522 2920 6f72 2073 656c 662e 6765  ame") or self.ge
+00018280: 745f 6e61 6d65 2829 2c0a 2020 2020 2020  t_name(),.      
+00018290: 2020 2020 2020 2020 2020 7275 6e5f 6964            run_id
+000182a0: 3d63 6f6e 6669 672e 706f 7028 2272 756e  =config.pop("run
+000182b0: 5f69 6422 2c20 4e6f 6e65 292c 0a20 2020  _id", None),.   
+000182c0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000182d0: 2020 2020 2020 2066 6f72 2063 6d2c 2069         for cm, i
+000182e0: 6e70 7574 2c20 636f 6e66 6967 2069 6e20  nput, config in 
+000182f0: 7a69 7028 6361 6c6c 6261 636b 5f6d 616e  zip(callback_man
+00018300: 6167 6572 732c 2069 6e70 7574 732c 2063  agers, inputs, c
+00018310: 6f6e 6669 6773 290a 2020 2020 2020 2020  onfigs).        
+00018320: 5d0a 0a20 2020 2020 2020 2023 2069 6e76  ]..        # inv
+00018330: 6f6b 650a 2020 2020 2020 2020 7472 793a  oke.        try:
+00018340: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00018350: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
+00018360: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00018370: 2020 2023 2054 7261 636b 2077 6869 6368     # Track which
+00018380: 2069 6e70 7574 7320 2862 7920 696e 6465   inputs (by inde
+00018390: 7829 2066 6169 6c65 6420 736f 2066 6172  x) failed so far
+000183a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000183b0: 2023 2049 6620 616e 2069 6e70 7574 2068   # If an input h
+000183c0: 6173 2066 6169 6c65 6420 6974 2077 696c  as failed it wil
+000183d0: 6c20 6265 2070 7265 7365 6e74 2069 6e20  l be present in 
+000183e0: 7468 6973 206d 6170 2c0a 2020 2020 2020  this map,.      
+000183f0: 2020 2020 2020 2020 2020 2320 616e 6420            # and 
+00018400: 7468 6520 7661 6c75 6520 7769 6c6c 2062  the value will b
+00018410: 6520 7468 6520 6578 6365 7074 696f 6e20  e the exception 
+00018420: 7468 6174 2077 6173 2072 6169 7365 642e  that was raised.
+00018430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018440: 2066 6169 6c65 645f 696e 7075 7473 5f6d   failed_inputs_m
+00018450: 6170 3a20 4469 6374 5b69 6e74 2c20 4578  ap: Dict[int, Ex
+00018460: 6365 7074 696f 6e5d 203d 207b 7d0a 2020  ception] = {}.  
+00018470: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00018480: 7220 7374 6570 6964 782c 2073 7465 7020  r stepidx, step 
+00018490: 696e 2065 6e75 6d65 7261 7465 2873 656c  in enumerate(sel
+000184a0: 662e 7374 6570 7329 3a0a 2020 2020 2020  f.steps):.      
+000184b0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000184c0: 4173 7365 6d62 6c65 2074 6865 206f 7269  Assemble the ori
+000184d0: 6769 6e61 6c20 696e 6465 7865 7320 6f66  ginal indexes of
+000184e0: 2074 6865 2072 656d 6169 6e69 6e67 2069   the remaining i
+000184f0: 6e70 7574 730a 2020 2020 2020 2020 2020  nputs.          
+00018500: 2020 2020 2020 2020 2020 2320 2869 2e65            # (i.e
+00018510: 2e20 7468 6520 6f6e 6573 2074 6861 7420  . the ones that 
+00018520: 6861 7665 6e27 7420 6661 696c 6564 2079  haven't failed y
+00018530: 6574 290a 2020 2020 2020 2020 2020 2020  et).            
+00018540: 2020 2020 2020 2020 7265 6d61 696e 696e          remainin
+00018550: 675f 6964 7873 203d 205b 0a20 2020 2020  g_idxs = [.     
+00018560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018570: 2020 2069 2066 6f72 2069 2069 6e20 7261     i for i in ra
+00018580: 6e67 6528 6c65 6e28 636f 6e66 6967 7329  nge(len(configs)
+00018590: 2920 6966 2069 206e 6f74 2069 6e20 6661  ) if i not in fa
+000185a0: 696c 6564 5f69 6e70 7574 735f 6d61 700a  iled_inputs_map.
+000185b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000185c0: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
+000185d0: 2020 2020 2020 2020 2020 2320 496e 766f            # Invo
+000185e0: 6b65 2074 6865 2073 7465 7020 6f6e 2074  ke the step on t
+000185f0: 6865 2072 656d 6169 6e69 6e67 2069 6e70  he remaining inp
+00018600: 7574 730a 2020 2020 2020 2020 2020 2020  uts.            
+00018610: 2020 2020 2020 2020 696e 7075 7473 203d          inputs =
+00018620: 2073 7465 702e 6261 7463 6828 0a20 2020   step.batch(.   
+00018630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018640: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00018650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018660: 2020 2069 6e70 0a20 2020 2020 2020 2020     inp.         
+00018670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018680: 2020 2066 6f72 2069 2c20 696e 7020 696e     for i, inp in
+00018690: 207a 6970 2872 656d 6169 6e69 6e67 5f69   zip(remaining_i
+000186a0: 6478 732c 2069 6e70 7574 7329 0a20 2020  dxs, inputs).   
+000186b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000186c0: 2020 2020 2020 2020 2069 6620 6920 6e6f           if i no
+000186d0: 7420 696e 2066 6169 6c65 645f 696e 7075  t in failed_inpu
+000186e0: 7473 5f6d 6170 0a20 2020 2020 2020 2020  ts_map.         
+000186f0: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
+00018700: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018710: 2020 2020 2020 2020 2020 5b0a 2020 2020            [.    
+00018720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018730: 2020 2020 2020 2020 2320 6561 6368 2073          # each s
+00018740: 7465 7020 6120 6368 696c 6420 7275 6e20  tep a child run 
+00018750: 6f66 2074 6865 2063 6f72 7265 7370 6f6e  of the correspon
+00018760: 6469 6e67 2072 6f6f 7420 7275 6e0a 2020  ding root run.  
+00018770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018780: 2020 2020 2020 2020 2020 7061 7463 685f            patch_
+00018790: 636f 6e66 6967 280a 2020 2020 2020 2020  config(.        
+000187a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000187b0: 2020 2020 2020 2020 636f 6e66 6967 2c20          config, 
+000187c0: 6361 6c6c 6261 636b 733d 726d 2e67 6574  callbacks=rm.get
+000187d0: 5f63 6869 6c64 2866 2273 6571 3a73 7465  _child(f"seq:ste
+000187e0: 703a 7b73 7465 7069 6478 2b31 7d22 290a  p:{stepidx+1}").
+000187f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018800: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00018810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018820: 2020 2020 2020 2020 2020 666f 7220 692c            for i,
+00018830: 2028 726d 2c20 636f 6e66 6967 2920 696e   (rm, config) in
+00018840: 2065 6e75 6d65 7261 7465 287a 6970 2872   enumerate(zip(r
+00018850: 756e 5f6d 616e 6167 6572 732c 2063 6f6e  un_managers, con
+00018860: 6669 6773 2929 0a20 2020 2020 2020 2020  figs)).         
+00018870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018880: 2020 2069 6620 6920 6e6f 7420 696e 2066     if i not in f
+00018890: 6169 6c65 645f 696e 7075 7473 5f6d 6170  ailed_inputs_map
+000188a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000188b0: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
+000188c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000188d0: 2020 2020 7265 7475 726e 5f65 7863 6570      return_excep
+000188e0: 7469 6f6e 733d 7265 7475 726e 5f65 7863  tions=return_exc
+000188f0: 6570 7469 6f6e 732c 0a20 2020 2020 2020  eptions,.       
+00018900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018910: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
+00018920: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00018930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018940: 2020 2020 2023 2049 6620 616e 2069 6e70       # If an inp
+00018950: 7574 2066 6169 6c65 642c 2061 6464 2069  ut failed, add i
+00018960: 7420 746f 2074 6865 206d 6170 0a20 2020  t to the map.   
+00018970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018980: 2066 6f72 2069 2c20 696e 7020 696e 207a   for i, inp in z
+00018990: 6970 2872 656d 6169 6e69 6e67 5f69 6478  ip(remaining_idx
+000189a0: 732c 2069 6e70 7574 7329 3a0a 2020 2020  s, inputs):.    
+000189b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000189c0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+000189d0: 6528 696e 702c 2045 7863 6570 7469 6f6e  e(inp, Exception
+000189e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000189f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00018a00: 6169 6c65 645f 696e 7075 7473 5f6d 6170  ailed_inputs_map
+00018a10: 5b69 5d20 3d20 696e 700a 2020 2020 2020  [i] = inp.      
+00018a20: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00018a30: 7075 7473 203d 205b 696e 7020 666f 7220  puts = [inp for 
+00018a40: 696e 7020 696e 2069 6e70 7574 7320 6966  inp in inputs if
+00018a50: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+00018a60: 696e 702c 2045 7863 6570 7469 6f6e 295d  inp, Exception)]
+00018a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018a80: 2020 2020 2023 2049 6620 616c 6c20 696e       # If all in
+00018a90: 7075 7473 2068 6176 6520 6661 696c 6564  puts have failed
+00018aa0: 2c20 7374 6f70 2070 726f 6365 7373 696e  , stop processin
+00018ab0: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
+00018ac0: 2020 2020 2020 6966 206c 656e 2866 6169        if len(fai
+00018ad0: 6c65 645f 696e 7075 7473 5f6d 6170 2920  led_inputs_map) 
+00018ae0: 3d3d 206c 656e 2863 6f6e 6669 6773 293a  == len(configs):
+00018af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018b00: 2020 2020 2020 2020 2062 7265 616b 0a0a           break..
+00018b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018b20: 2320 5265 6173 7365 6d62 6c65 2074 6865  # Reassemble the
+00018b30: 206f 7574 7075 7473 2c20 696e 7365 7274   outputs, insert
+00018b40: 696e 6720 4578 6365 7074 696f 6e73 2066  ing Exceptions f
+00018b50: 6f72 2066 6169 6c65 6420 696e 7075 7473  or failed inputs
+00018b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018b70: 2069 6e70 7574 735f 636f 7079 203d 2069   inputs_copy = i
+00018b80: 6e70 7574 732e 636f 7079 2829 0a20 2020  nputs.copy().   
+00018b90: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
+00018ba0: 7574 7320 3d20 5b5d 0a20 2020 2020 2020  uts = [].       
+00018bb0: 2020 2020 2020 2020 2066 6f72 2069 2069           for i i
+00018bc0: 6e20 7261 6e67 6528 6c65 6e28 636f 6e66  n range(len(conf
+00018bd0: 6967 7329 293a 0a20 2020 2020 2020 2020  igs)):.         
+00018be0: 2020 2020 2020 2020 2020 2069 6620 6920             if i 
+00018bf0: 696e 2066 6169 6c65 645f 696e 7075 7473  in failed_inputs
+00018c00: 5f6d 6170 3a0a 2020 2020 2020 2020 2020  _map:.          
+00018c10: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00018c20: 7075 7473 2e61 7070 656e 6428 6361 7374  puts.append(cast
+00018c30: 2849 6e70 7574 2c20 6661 696c 6564 5f69  (Input, failed_i
+00018c40: 6e70 7574 735f 6d61 705b 695d 2929 0a20  nputs_map[i])). 
+00018c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018c60: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00018c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018c80: 2069 6e70 7574 732e 6170 7065 6e64 2869   inputs.append(i
+00018c90: 6e70 7574 735f 636f 7079 2e70 6f70 2830  nputs_copy.pop(0
+00018ca0: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
+00018cb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00018cc0: 2020 2020 2066 6f72 2069 2c20 7374 6570       for i, step
+00018cd0: 2069 6e20 656e 756d 6572 6174 6528 7365   in enumerate(se
+00018ce0: 6c66 2e73 7465 7073 293a 0a20 2020 2020  lf.steps):.     
+00018cf0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00018d00: 6e70 7574 7320 3d20 7374 6570 2e62 6174  nputs = step.bat
+00018d10: 6368 280a 2020 2020 2020 2020 2020 2020  ch(.            
+00018d20: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+00018d30: 7473 2c0a 2020 2020 2020 2020 2020 2020  ts,.            
+00018d40: 2020 2020 2020 2020 2020 2020 5b0a 2020              [.  
+00018d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d60: 2020 2020 2020 2020 2020 2320 6561 6368            # each
+00018d70: 2073 7465 7020 6120 6368 696c 6420 7275   step a child ru
+00018d80: 6e20 6f66 2074 6865 2063 6f72 7265 7370  n of the corresp
+00018d90: 6f6e 6469 6e67 2072 6f6f 7420 7275 6e0a  onding root run.
 00018da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018db0: 2020 2020 5b49 6e70 7574 2c20 4173 796e      [Input, Asyn
-00018dc0: 6343 616c 6c62 6163 6b4d 616e 6167 6572  cCallbackManager
-00018dd0: 466f 7243 6861 696e 5275 6e2c 2052 756e  ForChainRun, Run
-00018de0: 6e61 626c 6543 6f6e 6669 675d 2c0a 2020  nableConfig],.  
-00018df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e00: 2020 4177 6169 7461 626c 655b 4f75 7470    Awaitable[Outp
-00018e10: 7574 5d2c 0a20 2020 2020 2020 2020 2020  ut],.           
-00018e20: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00018e30: 2020 2020 5d0a 2020 2020 2020 2020 5d20      ].        ] 
-00018e40: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00018e50: 6e61 6d65 3a20 4f70 7469 6f6e 616c 5b73  name: Optional[s
-00018e60: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
-00018e70: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00018e80: 2020 2022 2222 4372 6561 7465 2061 2052     """Create a R
-00018e90: 756e 6e61 626c 654c 616d 6264 6120 6672  unnableLambda fr
-00018ea0: 6f6d 2061 2063 616c 6c61 626c 652c 2061  om a callable, a
-00018eb0: 6e64 2061 7379 6e63 2063 616c 6c61 626c  nd async callabl
-00018ec0: 6520 6f72 2062 6f74 682e 0a0a 2020 2020  e or both...    
-00018ed0: 2020 2020 4163 6365 7074 7320 626f 7468      Accepts both
-00018ee0: 2073 796e 6320 616e 6420 6173 796e 6320   sync and async 
-00018ef0: 7661 7269 616e 7473 2074 6f20 616c 6c6f  variants to allo
-00018f00: 7720 7072 6f76 6964 696e 6720 6566 6669  w providing effi
-00018f10: 6369 656e 740a 2020 2020 2020 2020 696d  cient.        im
-00018f20: 706c 656d 656e 7461 7469 6f6e 7320 666f  plementations fo
-00018f30: 7220 7379 6e63 2061 6e64 2061 7379 6e63  r sync and async
-00018f40: 2065 7865 6375 7469 6f6e 2e0a 0a20 2020   execution...   
-00018f50: 2020 2020 2041 7267 733a 0a20 2020 2020       Args:.     
-00018f60: 2020 2020 2020 2066 756e 633a 2045 6974         func: Eit
-00018f70: 6865 7220 7379 6e63 206f 7220 6173 796e  her sync or asyn
-00018f80: 6320 6361 6c6c 6162 6c65 0a20 2020 2020  c callable.     
-00018f90: 2020 2020 2020 2061 6675 6e63 3a20 416e         afunc: An
-00018fa0: 2061 7379 6e63 2063 616c 6c61 626c 6520   async callable 
-00018fb0: 7468 6174 2074 616b 6573 2061 6e20 696e  that takes an in
-00018fc0: 7075 7420 616e 6420 7265 7475 726e 7320  put and returns 
-00018fd0: 616e 206f 7574 7075 742e 0a20 2020 2020  an output..     
-00018fe0: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
-00018ff0: 6620 6166 756e 6320 6973 206e 6f74 204e  f afunc is not N
-00019000: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00019010: 2073 656c 662e 6166 756e 6320 3d20 6166   self.afunc = af
-00019020: 756e 630a 2020 2020 2020 2020 2020 2020  unc.            
-00019030: 6675 6e63 5f66 6f72 5f6e 616d 653a 2043  func_for_name: C
-00019040: 616c 6c61 626c 6520 3d20 6166 756e 630a  allable = afunc.
-00019050: 0a20 2020 2020 2020 2069 6620 696e 7370  .        if insp
-00019060: 6563 742e 6973 636f 726f 7574 696e 6566  ect.iscoroutinef
-00019070: 756e 6374 696f 6e28 6675 6e63 2920 6f72  unction(func) or
-00019080: 2069 6e73 7065 6374 2e69 7361 7379 6e63   inspect.isasync
-00019090: 6765 6e66 756e 6374 696f 6e28 6675 6e63  genfunction(func
-000190a0: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-000190b0: 6620 6166 756e 6320 6973 206e 6f74 204e  f afunc is not N
-000190c0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000190d0: 2020 2020 2072 6169 7365 2054 7970 6545       raise TypeE
-000190e0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-000190f0: 2020 2020 2020 2020 2020 2246 756e 6320            "Func 
-00019100: 7761 7320 7072 6f76 6964 6564 2061 7320  was provided as 
-00019110: 6120 636f 726f 7574 696e 6520 6675 6e63  a coroutine func
-00019120: 7469 6f6e 2c20 6275 7420 6166 756e 6320  tion, but afunc 
-00019130: 7761 7320 220a 2020 2020 2020 2020 2020  was ".          
-00019140: 2020 2020 2020 2020 2020 2261 6c73 6f20            "also 
-00019150: 7072 6f76 6964 6564 2e20 4966 2070 726f  provided. If pro
-00019160: 7669 6469 6e67 2062 6f74 682c 2066 756e  viding both, fun
-00019170: 6320 7368 6f75 6c64 2062 6520 6120 7265  c should be a re
-00019180: 6775 6c61 7220 220a 2020 2020 2020 2020  gular ".        
-00019190: 2020 2020 2020 2020 2020 2020 2266 756e              "fun
-000191a0: 6374 696f 6e20 746f 2061 766f 6964 2061  ction to avoid a
-000191b0: 6d62 6967 7569 7479 2e22 0a20 2020 2020  mbiguity.".     
-000191c0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000191d0: 2020 2020 2020 2020 2073 656c 662e 6166           self.af
-000191e0: 756e 6320 3d20 6675 6e63 0a20 2020 2020  unc = func.     
-000191f0: 2020 2020 2020 2066 756e 635f 666f 725f         func_for_
-00019200: 6e61 6d65 203d 2066 756e 630a 2020 2020  name = func.    
-00019210: 2020 2020 656c 6966 2063 616c 6c61 626c      elif callabl
-00019220: 6528 6675 6e63 293a 0a20 2020 2020 2020  e(func):.       
-00019230: 2020 2020 2073 656c 662e 6675 6e63 203d       self.func =
-00019240: 2063 6173 7428 4361 6c6c 6162 6c65 5b5b   cast(Callable[[
-00019250: 496e 7075 745d 2c20 4f75 7470 7574 5d2c  Input], Output],
-00019260: 2066 756e 6329 0a20 2020 2020 2020 2020   func).         
-00019270: 2020 2066 756e 635f 666f 725f 6e61 6d65     func_for_name
-00019280: 203d 2066 756e 630a 2020 2020 2020 2020   = func.        
-00019290: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000192a0: 2020 7261 6973 6520 5479 7065 4572 726f    raise TypeErro
-000192b0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-000192c0: 2020 2022 4578 7065 6374 6564 2061 2063     "Expected a c
-000192d0: 616c 6c61 626c 6520 7479 7065 2066 6f72  allable type for
-000192e0: 2060 6675 6e63 602e 220a 2020 2020 2020   `func`.".      
-000192f0: 2020 2020 2020 2020 2020 6622 496e 7374            f"Inst
-00019300: 6561 6420 676f 7420 616e 2075 6e73 7570  ead got an unsup
-00019310: 706f 7274 6564 2074 7970 653a 207b 7479  ported type: {ty
-00019320: 7065 2866 756e 6329 7d22 0a20 2020 2020  pe(func)}".     
-00019330: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00019340: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00019350: 2020 2069 6620 6e61 6d65 2069 7320 6e6f     if name is no
-00019360: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00019370: 2020 2020 2020 2020 7365 6c66 2e6e 616d          self.nam
-00019380: 6520 3d20 6e61 6d65 0a20 2020 2020 2020  e = name.       
-00019390: 2020 2020 2065 6c69 6620 6675 6e63 5f66       elif func_f
-000193a0: 6f72 5f6e 616d 652e 5f5f 6e61 6d65 5f5f  or_name.__name__
-000193b0: 2021 3d20 223c 6c61 6d62 6461 3e22 3a0a   != "<lambda>":.
-000193c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000193d0: 7365 6c66 2e6e 616d 6520 3d20 6675 6e63  self.name = func
-000193e0: 5f66 6f72 5f6e 616d 652e 5f5f 6e61 6d65  _for_name.__name
-000193f0: 5f5f 0a20 2020 2020 2020 2065 7863 6570  __.        excep
-00019400: 7420 4174 7472 6962 7574 6545 7272 6f72  t AttributeError
-00019410: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
-00019420: 7373 0a0a 2020 2020 4070 726f 7065 7274  ss..    @propert
-00019430: 790a 2020 2020 6465 6620 496e 7075 7454  y.    def InputT
-00019440: 7970 6528 7365 6c66 2920 2d3e 2041 6e79  ype(self) -> Any
-00019450: 3a0a 2020 2020 2020 2020 2222 2254 6865  :.        """The
-00019460: 2074 7970 6520 6f66 2074 6865 2069 6e70   type of the inp
-00019470: 7574 2074 6f20 7468 6973 2072 756e 6e61  ut to this runna
-00019480: 626c 652e 2222 220a 2020 2020 2020 2020  ble.""".        
-00019490: 6675 6e63 203d 2067 6574 6174 7472 2873  func = getattr(s
-000194a0: 656c 662c 2022 6675 6e63 222c 204e 6f6e  elf, "func", Non
-000194b0: 6529 206f 7220 6765 7461 7474 7228 7365  e) or getattr(se
-000194c0: 6c66 2c20 2261 6675 6e63 2229 0a20 2020  lf, "afunc").   
-000194d0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-000194e0: 2020 2020 2020 7061 7261 6d73 203d 2069        params = i
-000194f0: 6e73 7065 6374 2e73 6967 6e61 7475 7265  nspect.signature
-00019500: 2866 756e 6329 2e70 6172 616d 6574 6572  (func).parameter
-00019510: 730a 2020 2020 2020 2020 2020 2020 6669  s.            fi
-00019520: 7273 745f 7061 7261 6d20 3d20 6e65 7874  rst_param = next
-00019530: 2869 7465 7228 7061 7261 6d73 2e76 616c  (iter(params.val
-00019540: 7565 7328 2929 2c20 4e6f 6e65 290a 2020  ues()), None).  
-00019550: 2020 2020 2020 2020 2020 6966 2066 6972            if fir
-00019560: 7374 5f70 6172 616d 2061 6e64 2066 6972  st_param and fir
-00019570: 7374 5f70 6172 616d 2e61 6e6e 6f74 6174  st_param.annotat
-00019580: 696f 6e20 213d 2069 6e73 7065 6374 2e50  ion != inspect.P
-00019590: 6172 616d 6574 6572 2e65 6d70 7479 3a0a  arameter.empty:.
-000195a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000195b0: 7265 7475 726e 2066 6972 7374 5f70 6172  return first_par
-000195c0: 616d 2e61 6e6e 6f74 6174 696f 6e0a 2020  am.annotation.  
-000195d0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000195e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000195f0: 7265 7475 726e 2041 6e79 0a20 2020 2020  return Any.     
-00019600: 2020 2065 7863 6570 7420 5661 6c75 6545     except ValueE
-00019610: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-00019620: 2020 7265 7475 726e 2041 6e79 0a0a 2020    return Any..  
-00019630: 2020 6465 6620 6765 745f 696e 7075 745f    def get_input_
-00019640: 7363 6865 6d61 280a 2020 2020 2020 2020  schema(.        
-00019650: 7365 6c66 2c20 636f 6e66 6967 3a20 4f70  self, config: Op
-00019660: 7469 6f6e 616c 5b52 756e 6e61 626c 6543  tional[RunnableC
-00019670: 6f6e 6669 675d 203d 204e 6f6e 650a 2020  onfig] = None.  
-00019680: 2020 2920 2d3e 2054 7970 655b 4261 7365    ) -> Type[Base
-00019690: 4d6f 6465 6c5d 3a0a 2020 2020 2020 2020  Model]:.        
-000196a0: 2222 2254 6865 2070 7964 616e 7469 6320  """The pydantic 
-000196b0: 7363 6865 6d61 2066 6f72 2074 6865 2069  schema for the i
-000196c0: 6e70 7574 2074 6f20 7468 6973 2072 756e  nput to this run
-000196d0: 6e61 626c 652e 2222 220a 2020 2020 2020  nable.""".      
-000196e0: 2020 6675 6e63 203d 2067 6574 6174 7472    func = getattr
-000196f0: 2873 656c 662c 2022 6675 6e63 222c 204e  (self, "func", N
-00019700: 6f6e 6529 206f 7220 6765 7461 7474 7228  one) or getattr(
-00019710: 7365 6c66 2c20 2261 6675 6e63 2229 0a0a  self, "afunc")..
-00019720: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00019730: 7461 6e63 6528 6675 6e63 2c20 6974 656d  tance(func, item
-00019740: 6765 7474 6572 293a 0a20 2020 2020 2020  getter):.       
-00019750: 2020 2020 2023 2054 6869 7320 6973 2074       # This is t
-00019760: 6572 7269 626c 652c 2062 7574 2061 6661  errible, but afa
-00019770: 6963 7420 6974 2773 206e 6f74 2070 6f73  ict it's not pos
-00019780: 7369 626c 6520 746f 2061 6363 6573 7320  sible to access 
-00019790: 5f69 7465 6d73 0a20 2020 2020 2020 2020  _items.         
-000197a0: 2020 2023 206f 6e20 6974 656d 6765 7474     # on itemgett
-000197b0: 6572 206f 626a 6563 7473 2c20 736f 2077  er objects, so w
-000197c0: 6520 6861 7665 2074 6f20 7061 7273 6520  e have to parse 
-000197d0: 7468 6520 7265 7072 0a20 2020 2020 2020  the repr.       
-000197e0: 2020 2020 2069 7465 6d73 203d 2073 7472       items = str
-000197f0: 2866 756e 6329 2e72 6570 6c61 6365 2822  (func).replace("
-00019800: 6f70 6572 6174 6f72 2e69 7465 6d67 6574  operator.itemget
-00019810: 7465 7228 222c 2022 2229 5b3a 2d31 5d2e  ter(", "")[:-1].
-00019820: 7370 6c69 7428 222c 2022 290a 2020 2020  split(", ").    
-00019830: 2020 2020 2020 2020 6966 2061 6c6c 280a          if all(.
-00019840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019850: 6974 656d 5b30 5d20 3d3d 2022 2722 2061  item[0] == "'" a
-00019860: 6e64 2069 7465 6d5b 2d31 5d20 3d3d 2022  nd item[-1] == "
-00019870: 2722 2061 6e64 206c 656e 2869 7465 6d29  '" and len(item)
-00019880: 203e 2032 2066 6f72 2069 7465 6d20 696e   > 2 for item in
-00019890: 2069 7465 6d73 0a20 2020 2020 2020 2020   items.         
-000198a0: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
-000198b0: 2020 2020 2020 2320 4974 2773 2061 2064        # It's a d
-000198c0: 6963 742c 206c 6f6c 0a20 2020 2020 2020  ict, lol.       
-000198d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000198e0: 6372 6561 7465 5f6d 6f64 656c 280a 2020  create_model(.  
-000198f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019900: 2020 7365 6c66 2e67 6574 5f6e 616d 6528    self.get_name(
-00019910: 2249 6e70 7574 2229 2c0a 2020 2020 2020  "Input"),.      
-00019920: 2020 2020 2020 2020 2020 2020 2020 2a2a                **
-00019930: 7b69 7465 6d5b 313a 2d31 5d3a 2028 416e  {item[1:-1]: (An
-00019940: 792c 204e 6f6e 6529 2066 6f72 2069 7465  y, None) for ite
-00019950: 6d20 696e 2069 7465 6d73 7d2c 2020 2320  m in items},  # 
-00019960: 7479 7065 3a20 6967 6e6f 7265 0a20 2020  type: ignore.   
-00019970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019980: 205f 5f63 6f6e 6669 675f 5f3d 5f53 6368   __config__=_Sch
-00019990: 656d 6143 6f6e 6669 672c 0a20 2020 2020  emaConfig,.     
-000199a0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000199b0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000199c0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000199d0: 6574 7572 6e20 6372 6561 7465 5f6d 6f64  eturn create_mod
-000199e0: 656c 280a 2020 2020 2020 2020 2020 2020  el(.            
-000199f0: 2020 2020 2020 2020 7365 6c66 2e67 6574          self.get
-00019a00: 5f6e 616d 6528 2249 6e70 7574 2229 2c0a  _name("Input"),.
-00019a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a20: 2020 2020 5f5f 726f 6f74 5f5f 3d28 4c69      __root__=(Li
-00019a30: 7374 5b41 6e79 5d2c 204e 6f6e 6529 2c0a  st[Any], None),.
-00019a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a50: 2020 2020 5f5f 636f 6e66 6967 5f5f 3d5f      __config__=_
-00019a60: 5363 6865 6d61 436f 6e66 6967 2c0a 2020  SchemaConfig,.  
-00019a70: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00019a80: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00019a90: 2e49 6e70 7574 5479 7065 2021 3d20 416e  .InputType != An
-00019aa0: 793a 0a20 2020 2020 2020 2020 2020 2072  y:.            r
-00019ab0: 6574 7572 6e20 7375 7065 7228 292e 6765  eturn super().ge
-00019ac0: 745f 696e 7075 745f 7363 6865 6d61 2863  t_input_schema(c
-00019ad0: 6f6e 6669 6729 0a0a 2020 2020 2020 2020  onfig)..        
-00019ae0: 6966 2064 6963 745f 6b65 7973 203a 3d20  if dict_keys := 
-00019af0: 6765 745f 6675 6e63 7469 6f6e 5f66 6972  get_function_fir
-00019b00: 7374 5f61 7267 5f64 6963 745f 6b65 7973  st_arg_dict_keys
-00019b10: 2866 756e 6329 3a0a 2020 2020 2020 2020  (func):.        
-00019b20: 2020 2020 7265 7475 726e 2063 7265 6174      return creat
-00019b30: 655f 6d6f 6465 6c28 0a20 2020 2020 2020  e_model(.       
-00019b40: 2020 2020 2020 2020 2073 656c 662e 6765           self.ge
-00019b50: 745f 6e61 6d65 2822 496e 7075 7422 292c  t_name("Input"),
-00019b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019b70: 202a 2a7b 6b65 793a 2028 416e 792c 204e   **{key: (Any, N
-00019b80: 6f6e 6529 2066 6f72 206b 6579 2069 6e20  one) for key in 
-00019b90: 6469 6374 5f6b 6579 737d 2c20 2023 2074  dict_keys},  # t
-00019ba0: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
-00019bb0: 2020 2020 2020 2020 2020 2020 5f5f 636f              __co
-00019bc0: 6e66 6967 5f5f 3d5f 5363 6865 6d61 436f  nfig__=_SchemaCo
-00019bd0: 6e66 6967 2c0a 2020 2020 2020 2020 2020  nfig,.          
-00019be0: 2020 290a 0a20 2020 2020 2020 2072 6574    )..        ret
-00019bf0: 7572 6e20 7375 7065 7228 292e 6765 745f  urn super().get_
-00019c00: 696e 7075 745f 7363 6865 6d61 2863 6f6e  input_schema(con
-00019c10: 6669 6729 0a0a 2020 2020 4070 726f 7065  fig)..    @prope
-00019c20: 7274 790a 2020 2020 6465 6620 4f75 7470  rty.    def Outp
-00019c30: 7574 5479 7065 2873 656c 6629 202d 3e20  utType(self) -> 
-00019c40: 416e 793a 0a20 2020 2020 2020 2022 2222  Any:.        """
-00019c50: 5468 6520 7479 7065 206f 6620 7468 6520  The type of the 
-00019c60: 6f75 7470 7574 206f 6620 7468 6973 2072  output of this r
-00019c70: 756e 6e61 626c 6520 6173 2061 2074 7970  unnable as a typ
-00019c80: 6520 616e 6e6f 7461 7469 6f6e 2e22 2222  e annotation."""
-00019c90: 0a20 2020 2020 2020 2066 756e 6320 3d20  .        func = 
-00019ca0: 6765 7461 7474 7228 7365 6c66 2c20 2266  getattr(self, "f
-00019cb0: 756e 6322 2c20 4e6f 6e65 2920 6f72 2067  unc", None) or g
-00019cc0: 6574 6174 7472 2873 656c 662c 2022 6166  etattr(self, "af
-00019cd0: 756e 6322 290a 2020 2020 2020 2020 7472  unc").        tr
-00019ce0: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
-00019cf0: 6967 203d 2069 6e73 7065 6374 2e73 6967  ig = inspect.sig
-00019d00: 6e61 7475 7265 2866 756e 6329 0a20 2020  nature(func).   
-00019d10: 2020 2020 2020 2020 2069 6620 7369 672e           if sig.
-00019d20: 7265 7475 726e 5f61 6e6e 6f74 6174 696f  return_annotatio
-00019d30: 6e20 213d 2069 6e73 7065 6374 2e53 6967  n != inspect.Sig
-00019d40: 6e61 7475 7265 2e65 6d70 7479 3a0a 2020  nature.empty:.  
-00019d50: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00019d60: 756e 7772 6170 2069 7465 7261 746f 7220  unwrap iterator 
-00019d70: 7479 7065 730a 2020 2020 2020 2020 2020  types.          
-00019d80: 2020 2020 2020 6966 2067 6574 6174 7472        if getattr
-00019d90: 2873 6967 2e72 6574 7572 6e5f 616e 6e6f  (sig.return_anno
-00019da0: 7461 7469 6f6e 2c20 225f 5f6f 7269 6769  tation, "__origi
-00019db0: 6e5f 5f22 2c20 4e6f 6e65 2920 696e 2028  n__", None) in (
-00019dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019dd0: 2020 2020 2063 6f6c 6c65 6374 696f 6e73       collections
-00019de0: 2e61 6263 2e49 7465 7261 746f 722c 0a20  .abc.Iterator,. 
-00019df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019e00: 2020 2063 6f6c 6c65 6374 696f 6e73 2e61     collections.a
-00019e10: 6263 2e41 7379 6e63 4974 6572 6174 6f72  bc.AsyncIterator
-00019e20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00019e30: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-00019e40: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00019e50: 6765 7461 7474 7228 7369 672e 7265 7475  getattr(sig.retu
-00019e60: 726e 5f61 6e6e 6f74 6174 696f 6e2c 2022  rn_annotation, "
-00019e70: 5f5f 6172 6773 5f5f 222c 2028 416e 792c  __args__", (Any,
-00019e80: 2929 5b30 5d0a 2020 2020 2020 2020 2020  ))[0].          
-00019e90: 2020 2020 2020 7265 7475 726e 2073 6967        return sig
-00019ea0: 2e72 6574 7572 6e5f 616e 6e6f 7461 7469  .return_annotati
-00019eb0: 6f6e 0a20 2020 2020 2020 2020 2020 2065  on.            e
-00019ec0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00019ed0: 2020 2020 2072 6574 7572 6e20 416e 790a       return Any.
-00019ee0: 2020 2020 2020 2020 6578 6365 7074 2056          except V
-00019ef0: 616c 7565 4572 726f 723a 0a20 2020 2020  alueError:.     
-00019f00: 2020 2020 2020 2072 6574 7572 6e20 416e         return An
-00019f10: 790a 0a20 2020 2040 7072 6f70 6572 7479  y..    @property
-00019f20: 0a20 2020 2064 6566 2064 6570 7328 7365  .    def deps(se
-00019f30: 6c66 2920 2d3e 204c 6973 745b 5275 6e6e  lf) -> List[Runn
-00019f40: 6162 6c65 5d3a 0a20 2020 2020 2020 2022  able]:.        "
-00019f50: 2222 5468 6520 6465 7065 6e64 656e 6369  ""The dependenci
-00019f60: 6573 206f 6620 7468 6973 2072 756e 6e61  es of this runna
-00019f70: 626c 652e 2222 220a 2020 2020 2020 2020  ble.""".        
-00019f80: 6966 2068 6173 6174 7472 2873 656c 662c  if hasattr(self,
-00019f90: 2022 6675 6e63 2229 3a0a 2020 2020 2020   "func"):.      
-00019fa0: 2020 2020 2020 6f62 6a65 6374 7320 3d20        objects = 
-00019fb0: 6765 745f 6675 6e63 7469 6f6e 5f6e 6f6e  get_function_non
-00019fc0: 6c6f 6361 6c73 2873 656c 662e 6675 6e63  locals(self.func
-00019fd0: 290a 2020 2020 2020 2020 656c 6966 2068  ).        elif h
-00019fe0: 6173 6174 7472 2873 656c 662c 2022 6166  asattr(self, "af
-00019ff0: 756e 6322 293a 0a20 2020 2020 2020 2020  unc"):.         
-0001a000: 2020 206f 626a 6563 7473 203d 2067 6574     objects = get
-0001a010: 5f66 756e 6374 696f 6e5f 6e6f 6e6c 6f63  _function_nonloc
-0001a020: 616c 7328 7365 6c66 2e61 6675 6e63 290a  als(self.afunc).
-0001a030: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001a040: 2020 2020 2020 2020 2020 6f62 6a65 6374            object
-0001a050: 7320 3d20 5b5d 0a0a 2020 2020 2020 2020  s = []..        
-0001a060: 7265 7475 726e 205b 6f62 6a20 666f 7220  return [obj for 
-0001a070: 6f62 6a20 696e 206f 626a 6563 7473 2069  obj in objects i
-0001a080: 6620 6973 696e 7374 616e 6365 286f 626a  f isinstance(obj
-0001a090: 2c20 5275 6e6e 6162 6c65 295d 0a0a 2020  , Runnable)]..  
-0001a0a0: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-0001a0b0: 6465 6620 636f 6e66 6967 5f73 7065 6373  def config_specs
-0001a0c0: 2873 656c 6629 202d 3e20 4c69 7374 5b43  (self) -> List[C
-0001a0d0: 6f6e 6669 6775 7261 626c 6546 6965 6c64  onfigurableField
-0001a0e0: 5370 6563 5d3a 0a20 2020 2020 2020 2072  Spec]:.        r
-0001a0f0: 6574 7572 6e20 6765 745f 756e 6971 7565  eturn get_unique
-0001a100: 5f63 6f6e 6669 675f 7370 6563 7328 0a20  _config_specs(. 
-0001a110: 2020 2020 2020 2020 2020 2073 7065 6320             spec 
-0001a120: 666f 7220 6465 7020 696e 2073 656c 662e  for dep in self.
-0001a130: 6465 7073 2066 6f72 2073 7065 6320 696e  deps for spec in
-0001a140: 2064 6570 2e63 6f6e 6669 675f 7370 6563   dep.config_spec
-0001a150: 730a 2020 2020 2020 2020 290a 0a20 2020  s.        )..   
-0001a160: 2064 6566 2067 6574 5f67 7261 7068 2873   def get_graph(s
-0001a170: 656c 662c 2063 6f6e 6669 673a 2052 756e  elf, config: Run
-0001a180: 6e61 626c 6543 6f6e 6669 6720 7c20 4e6f  nableConfig | No
-0001a190: 6e65 203d 204e 6f6e 6529 202d 3e20 4772  ne = None) -> Gr
-0001a1a0: 6170 683a 0a20 2020 2020 2020 2069 6620  aph:.        if 
-0001a1b0: 6465 7073 203a 3d20 7365 6c66 2e64 6570  deps := self.dep
-0001a1c0: 733a 0a20 2020 2020 2020 2020 2020 2067  s:.            g
-0001a1d0: 7261 7068 203d 2047 7261 7068 2829 0a20  raph = Graph(). 
-0001a1e0: 2020 2020 2020 2020 2020 2069 6e70 7574             input
-0001a1f0: 5f6e 6f64 6520 3d20 6772 6170 682e 6164  _node = graph.ad
-0001a200: 645f 6e6f 6465 2873 656c 662e 6765 745f  d_node(self.get_
-0001a210: 696e 7075 745f 7363 6865 6d61 2863 6f6e  input_schema(con
-0001a220: 6669 6729 290a 2020 2020 2020 2020 2020  fig)).          
-0001a230: 2020 6f75 7470 7574 5f6e 6f64 6520 3d20    output_node = 
-0001a240: 6772 6170 682e 6164 645f 6e6f 6465 2873  graph.add_node(s
-0001a250: 656c 662e 6765 745f 6f75 7470 7574 5f73  elf.get_output_s
-0001a260: 6368 656d 6128 636f 6e66 6967 2929 0a20  chema(config)). 
-0001a270: 2020 2020 2020 2020 2020 2066 6f72 2064             for d
-0001a280: 6570 2069 6e20 6465 7073 3a0a 2020 2020  ep in deps:.    
-0001a290: 2020 2020 2020 2020 2020 2020 6465 705f              dep_
-0001a2a0: 6772 6170 6820 3d20 6465 702e 6765 745f  graph = dep.get_
-0001a2b0: 6772 6170 6828 290a 2020 2020 2020 2020  graph().        
-0001a2c0: 2020 2020 2020 2020 6465 705f 6772 6170          dep_grap
-0001a2d0: 682e 7472 696d 5f66 6972 7374 5f6e 6f64  h.trim_first_nod
-0001a2e0: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
-0001a2f0: 2020 2020 6465 705f 6772 6170 682e 7472      dep_graph.tr
-0001a300: 696d 5f6c 6173 745f 6e6f 6465 2829 0a20  im_last_node(). 
-0001a310: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001a320: 6620 6e6f 7420 6465 705f 6772 6170 683a  f not dep_graph:
-0001a330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a340: 2020 2020 2067 7261 7068 2e61 6464 5f65       graph.add_e
-0001a350: 6467 6528 696e 7075 745f 6e6f 6465 2c20  dge(input_node, 
-0001a360: 6f75 7470 7574 5f6e 6f64 6529 0a20 2020  output_node).   
-0001a370: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0001a380: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001a390: 2020 2020 2020 2067 7261 7068 2e65 7874         graph.ext
-0001a3a0: 656e 6428 6465 705f 6772 6170 6829 0a20  end(dep_graph). 
-0001a3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a3c0: 2020 2064 6570 5f66 6972 7374 5f6e 6f64     dep_first_nod
-0001a3d0: 6520 3d20 6465 705f 6772 6170 682e 6669  e = dep_graph.fi
-0001a3e0: 7273 745f 6e6f 6465 2829 0a20 2020 2020  rst_node().     
-0001a3f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001a400: 6620 6e6f 7420 6465 705f 6669 7273 745f  f not dep_first_
-0001a410: 6e6f 6465 3a0a 2020 2020 2020 2020 2020  node:.          
-0001a420: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0001a430: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-0001a440: 2252 756e 6e61 626c 6520 7b64 6570 7d20  "Runnable {dep} 
-0001a450: 6861 7320 6e6f 2066 6972 7374 206e 6f64  has no first nod
-0001a460: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
-0001a470: 2020 2020 2020 2020 6465 705f 6c61 7374          dep_last
-0001a480: 5f6e 6f64 6520 3d20 6465 705f 6772 6170  _node = dep_grap
-0001a490: 682e 6c61 7374 5f6e 6f64 6528 290a 2020  h.last_node().  
-0001a4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a4b0: 2020 6966 206e 6f74 2064 6570 5f6c 6173    if not dep_las
-0001a4c0: 745f 6e6f 6465 3a0a 2020 2020 2020 2020  t_node:.        
-0001a4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a4e0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-0001a4f0: 2866 2252 756e 6e61 626c 6520 7b64 6570  (f"Runnable {dep
-0001a500: 7d20 6861 7320 6e6f 206c 6173 7420 6e6f  } has no last no
-0001a510: 6465 2229 0a20 2020 2020 2020 2020 2020  de").           
-0001a520: 2020 2020 2020 2020 2067 7261 7068 2e61           graph.a
-0001a530: 6464 5f65 6467 6528 696e 7075 745f 6e6f  dd_edge(input_no
-0001a540: 6465 2c20 6465 705f 6669 7273 745f 6e6f  de, dep_first_no
-0001a550: 6465 290a 2020 2020 2020 2020 2020 2020  de).            
-0001a560: 2020 2020 2020 2020 6772 6170 682e 6164          graph.ad
-0001a570: 645f 6564 6765 2864 6570 5f6c 6173 745f  d_edge(dep_last_
-0001a580: 6e6f 6465 2c20 6f75 7470 7574 5f6e 6f64  node, output_nod
-0001a590: 6529 0a20 2020 2020 2020 2065 6c73 653a  e).        else:
-0001a5a0: 0a20 2020 2020 2020 2020 2020 2067 7261  .            gra
-0001a5b0: 7068 203d 2073 7570 6572 2829 2e67 6574  ph = super().get
-0001a5c0: 5f67 7261 7068 2863 6f6e 6669 6729 0a0a  _graph(config)..
-0001a5d0: 2020 2020 2020 2020 7265 7475 726e 2067          return g
-0001a5e0: 7261 7068 0a0a 2020 2020 6465 6620 5f5f  raph..    def __
-0001a5f0: 6571 5f5f 2873 656c 662c 206f 7468 6572  eq__(self, other
-0001a600: 3a20 416e 7929 202d 3e20 626f 6f6c 3a0a  : Any) -> bool:.
-0001a610: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0001a620: 7461 6e63 6528 6f74 6865 722c 2052 756e  tance(other, Run
-0001a630: 6e61 626c 654c 616d 6264 6129 3a0a 2020  nableLambda):.  
-0001a640: 2020 2020 2020 2020 2020 6966 2068 6173            if has
-0001a650: 6174 7472 2873 656c 662c 2022 6675 6e63  attr(self, "func
-0001a660: 2229 2061 6e64 2068 6173 6174 7472 286f  ") and hasattr(o
-0001a670: 7468 6572 2c20 2266 756e 6322 293a 0a20  ther, "func"):. 
-0001a680: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001a690: 6574 7572 6e20 7365 6c66 2e66 756e 6320  eturn self.func 
-0001a6a0: 3d3d 206f 7468 6572 2e66 756e 630a 2020  == other.func.  
-0001a6b0: 2020 2020 2020 2020 2020 656c 6966 2068            elif h
-0001a6c0: 6173 6174 7472 2873 656c 662c 2022 6166  asattr(self, "af
-0001a6d0: 756e 6322 2920 616e 6420 6861 7361 7474  unc") and hasatt
-0001a6e0: 7228 6f74 6865 722c 2022 6166 756e 6322  r(other, "afunc"
-0001a6f0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0001a700: 2020 2072 6574 7572 6e20 7365 6c66 2e61     return self.a
-0001a710: 6675 6e63 203d 3d20 6f74 6865 722e 6166  func == other.af
-0001a720: 756e 630a 2020 2020 2020 2020 2020 2020  unc.            
-0001a730: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001a740: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-0001a750: 7365 0a20 2020 2020 2020 2065 6c73 653a  se.        else:
-0001a760: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001a770: 7572 6e20 4661 6c73 650a 0a20 2020 2064  urn False..    d
-0001a780: 6566 205f 5f72 6570 725f 5f28 7365 6c66  ef __repr__(self
-0001a790: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
-0001a7a0: 2020 2222 2241 2073 7472 696e 6720 7265    """A string re
-0001a7b0: 7072 6573 656e 7461 7469 6f6e 206f 6620  presentation of 
-0001a7c0: 7468 6973 2072 756e 6e61 626c 652e 2222  this runnable.""
-0001a7d0: 220a 2020 2020 2020 2020 6966 2068 6173  ".        if has
-0001a7e0: 6174 7472 2873 656c 662c 2022 6675 6e63  attr(self, "func
-0001a7f0: 2229 2061 6e64 2069 7369 6e73 7461 6e63  ") and isinstanc
-0001a800: 6528 7365 6c66 2e66 756e 632c 2069 7465  e(self.func, ite
-0001a810: 6d67 6574 7465 7229 3a0a 2020 2020 2020  mgetter):.      
-0001a820: 2020 2020 2020 7265 7475 726e 2066 2252        return f"R
-0001a830: 756e 6e61 626c 654c 616d 6264 6128 7b73  unnableLambda({s
-0001a840: 7472 2873 656c 662e 6675 6e63 295b 6c65  tr(self.func)[le
-0001a850: 6e28 276f 7065 7261 746f 722e 2729 3a5d  n('operator.'):]
-0001a860: 7d29 220a 2020 2020 2020 2020 656c 6966  })".        elif
-0001a870: 2068 6173 6174 7472 2873 656c 662c 2022   hasattr(self, "
-0001a880: 6675 6e63 2229 3a0a 2020 2020 2020 2020  func"):.        
-0001a890: 2020 2020 7265 7475 726e 2066 2252 756e      return f"Run
-0001a8a0: 6e61 626c 654c 616d 6264 6128 7b67 6574  nableLambda({get
-0001a8b0: 5f6c 616d 6264 615f 736f 7572 6365 2873  _lambda_source(s
-0001a8c0: 656c 662e 6675 6e63 2920 6f72 2027 2e2e  elf.func) or '..
-0001a8d0: 2e27 7d29 220a 2020 2020 2020 2020 656c  .'})".        el
-0001a8e0: 6966 2068 6173 6174 7472 2873 656c 662c  if hasattr(self,
-0001a8f0: 2022 6166 756e 6322 293a 0a20 2020 2020   "afunc"):.     
-0001a900: 2020 2020 2020 2072 6574 7572 6e20 6622         return f"
-0001a910: 5275 6e6e 6162 6c65 4c61 6d62 6461 2861  RunnableLambda(a
-0001a920: 6675 6e63 3d7b 6765 745f 6c61 6d62 6461  func={get_lambda
-0001a930: 5f73 6f75 7263 6528 7365 6c66 2e61 6675  _source(self.afu
-0001a940: 6e63 2920 6f72 2027 2e2e 2e27 7d29 220a  nc) or '...'})".
-0001a950: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001a960: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001a970: 2022 5275 6e6e 6162 6c65 4c61 6d62 6461   "RunnableLambda
-0001a980: 282e 2e2e 2922 0a0a 2020 2020 6465 6620  (...)"..    def 
-0001a990: 5f69 6e76 6f6b 6528 0a20 2020 2020 2020  _invoke(.       
-0001a9a0: 2073 656c 662c 0a20 2020 2020 2020 2069   self,.        i
-0001a9b0: 6e70 7574 3a20 496e 7075 742c 0a20 2020  nput: Input,.   
-0001a9c0: 2020 2020 2072 756e 5f6d 616e 6167 6572       run_manager
-0001a9d0: 3a20 4361 6c6c 6261 636b 4d61 6e61 6765  : CallbackManage
-0001a9e0: 7246 6f72 4368 6169 6e52 756e 2c0a 2020  rForChainRun,.  
-0001a9f0: 2020 2020 2020 636f 6e66 6967 3a20 5275        config: Ru
-0001aa00: 6e6e 6162 6c65 436f 6e66 6967 2c0a 2020  nnableConfig,.  
-0001aa10: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
-0001aa20: 416e 792c 0a20 2020 2029 202d 3e20 4f75  Any,.    ) -> Ou
-0001aa30: 7470 7574 3a0a 2020 2020 2020 2020 6966  tput:.        if
-0001aa40: 2069 6e73 7065 6374 2e69 7367 656e 6572   inspect.isgener
-0001aa50: 6174 6f72 6675 6e63 7469 6f6e 2873 656c  atorfunction(sel
-0001aa60: 662e 6675 6e63 293a 0a20 2020 2020 2020  f.func):.       
-0001aa70: 2020 2020 206f 7574 7075 743a 204f 7074       output: Opt
-0001aa80: 696f 6e61 6c5b 4f75 7470 7574 5d20 3d20  ional[Output] = 
-0001aa90: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-0001aaa0: 2066 6f72 2063 6875 6e6b 2069 6e20 6361   for chunk in ca
-0001aab0: 6c6c 5f66 756e 635f 7769 7468 5f76 6172  ll_func_with_var
-0001aac0: 6961 626c 655f 6172 6773 280a 2020 2020  iable_args(.    
-0001aad0: 2020 2020 2020 2020 2020 2020 6361 7374              cast
-0001aae0: 2843 616c 6c61 626c 655b 5b49 6e70 7574  (Callable[[Input
-0001aaf0: 5d2c 2049 7465 7261 746f 725b 4f75 7470  ], Iterator[Outp
-0001ab00: 7574 5d5d 2c20 7365 6c66 2e66 756e 6329  ut]], self.func)
-0001ab10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001ab20: 2020 696e 7075 742c 0a20 2020 2020 2020    input,.       
-0001ab30: 2020 2020 2020 2020 2063 6f6e 6669 672c           config,
-0001ab40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ab50: 2072 756e 5f6d 616e 6167 6572 2c0a 2020   run_manager,.  
-0001ab60: 2020 2020 2020 2020 2020 2020 2020 2a2a                **
-0001ab70: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
-0001ab80: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-0001ab90: 2020 2020 2020 2069 6620 6f75 7470 7574         if output
-0001aba0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0001abb0: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
-0001abc0: 7470 7574 203d 2063 6875 6e6b 0a20 2020  tput = chunk.   
-0001abd0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0001abe0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001abf0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0001ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac10: 2020 2020 6f75 7470 7574 203d 206f 7574      output = out
-0001ac20: 7075 7420 2b20 6368 756e 6b20 2023 2074  put + chunk  # t
-0001ac30: 7970 653a 2069 676e 6f72 655b 6f70 6572  ype: ignore[oper
-0001ac40: 6174 6f72 5d0a 2020 2020 2020 2020 2020  ator].          
-0001ac50: 2020 2020 2020 2020 2020 6578 6365 7074            except
-0001ac60: 2054 7970 6545 7272 6f72 3a0a 2020 2020   TypeError:.    
-0001ac70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac80: 2020 2020 6f75 7470 7574 203d 2063 6875      output = chu
-0001ac90: 6e6b 0a20 2020 2020 2020 2065 6c73 653a  nk.        else:
-0001aca0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-0001acb0: 7075 7420 3d20 6361 6c6c 5f66 756e 635f  put = call_func_
-0001acc0: 7769 7468 5f76 6172 6961 626c 655f 6172  with_variable_ar
-0001acd0: 6773 280a 2020 2020 2020 2020 2020 2020  gs(.            
-0001ace0: 2020 2020 7365 6c66 2e66 756e 632c 2069      self.func, i
-0001acf0: 6e70 7574 2c20 636f 6e66 6967 2c20 7275  nput, config, ru
-0001ad00: 6e5f 6d61 6e61 6765 722c 202a 2a6b 7761  n_manager, **kwa
-0001ad10: 7267 730a 2020 2020 2020 2020 2020 2020  rgs.            
-0001ad20: 290a 2020 2020 2020 2020 2320 4966 2074  ).        # If t
-0001ad30: 6865 206f 7574 7075 7420 6973 2061 2072  he output is a r
-0001ad40: 756e 6e61 626c 652c 2069 6e76 6f6b 6520  unnable, invoke 
-0001ad50: 6974 0a20 2020 2020 2020 2069 6620 6973  it.        if is
-0001ad60: 696e 7374 616e 6365 286f 7574 7075 742c  instance(output,
-0001ad70: 2052 756e 6e61 626c 6529 3a0a 2020 2020   Runnable):.    
-0001ad80: 2020 2020 2020 2020 7265 6375 7273 696f          recursio
-0001ad90: 6e5f 6c69 6d69 7420 3d20 636f 6e66 6967  n_limit = config
-0001ada0: 5b22 7265 6375 7273 696f 6e5f 6c69 6d69  ["recursion_limi
-0001adb0: 7422 5d0a 2020 2020 2020 2020 2020 2020  t"].            
-0001adc0: 6966 2072 6563 7572 7369 6f6e 5f6c 696d  if recursion_lim
-0001add0: 6974 203c 3d20 303a 0a20 2020 2020 2020  it <= 0:.       
-0001ade0: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
-0001adf0: 6563 7572 7369 6f6e 4572 726f 7228 0a20  ecursionError(. 
-0001ae00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ae10: 2020 2066 2252 6563 7572 7369 6f6e 206c     f"Recursion l
-0001ae20: 696d 6974 2072 6561 6368 6564 2077 6865  imit reached whe
-0001ae30: 6e20 696e 766f 6b69 6e67 207b 7365 6c66  n invoking {self
-0001ae40: 7d20 7769 7468 2069 6e70 7574 207b 696e  } with input {in
-0001ae50: 7075 747d 2e22 0a20 2020 2020 2020 2020  put}.".         
-0001ae60: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001ae70: 2020 2020 206f 7574 7075 7420 3d20 6f75       output = ou
-0001ae80: 7470 7574 2e69 6e76 6f6b 6528 0a20 2020  tput.invoke(.   
-0001ae90: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-0001aea0: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
-0001aeb0: 2020 2020 7061 7463 685f 636f 6e66 6967      patch_config
-0001aec0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001aed0: 2020 2020 2020 636f 6e66 6967 2c0a 2020        config,.  
-0001aee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aef0: 2020 6361 6c6c 6261 636b 733d 7275 6e5f    callbacks=run_
-0001af00: 6d61 6e61 6765 722e 6765 745f 6368 696c  manager.get_chil
-0001af10: 6428 292c 0a20 2020 2020 2020 2020 2020  d(),.           
-0001af20: 2020 2020 2020 2020 2072 6563 7572 7369           recursi
-0001af30: 6f6e 5f6c 696d 6974 3d72 6563 7572 7369  on_limit=recursi
-0001af40: 6f6e 5f6c 696d 6974 202d 2031 2c0a 2020  on_limit - 1,.  
-0001af50: 2020 2020 2020 2020 2020 2020 2020 292c                ),
-0001af60: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0001af70: 2020 2020 2020 2072 6574 7572 6e20 6361         return ca
-0001af80: 7374 284f 7574 7075 742c 206f 7574 7075  st(Output, outpu
-0001af90: 7429 0a0a 2020 2020 6173 796e 6320 6465  t)..    async de
-0001afa0: 6620 5f61 696e 766f 6b65 280a 2020 2020  f _ainvoke(.    
-0001afb0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-0001afc0: 2020 696e 7075 743a 2049 6e70 7574 2c0a    input: Input,.
-0001afd0: 2020 2020 2020 2020 7275 6e5f 6d61 6e61          run_mana
-0001afe0: 6765 723a 2041 7379 6e63 4361 6c6c 6261  ger: AsyncCallba
-0001aff0: 636b 4d61 6e61 6765 7246 6f72 4368 6169  ckManagerForChai
-0001b000: 6e52 756e 2c0a 2020 2020 2020 2020 636f  nRun,.        co
-0001b010: 6e66 6967 3a20 5275 6e6e 6162 6c65 436f  nfig: RunnableCo
-0001b020: 6e66 6967 2c0a 2020 2020 2020 2020 2a2a  nfig,.        **
-0001b030: 6b77 6172 6773 3a20 416e 792c 0a20 2020  kwargs: Any,.   
-0001b040: 2029 202d 3e20 4f75 7470 7574 3a0a 2020   ) -> Output:.  
-0001b050: 2020 2020 2020 6966 2068 6173 6174 7472        if hasattr
-0001b060: 2873 656c 662c 2022 6166 756e 6322 293a  (self, "afunc"):
-0001b070: 0a20 2020 2020 2020 2020 2020 2061 6675  .            afu
-0001b080: 6e63 203d 2073 656c 662e 6166 756e 630a  nc = self.afunc.
-0001b090: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001b0a0: 2020 2020 2020 2020 2020 6966 2069 6e73            if ins
-0001b0b0: 7065 6374 2e69 7367 656e 6572 6174 6f72  pect.isgenerator
-0001b0c0: 6675 6e63 7469 6f6e 2873 656c 662e 6675  function(self.fu
-0001b0d0: 6e63 293a 0a0a 2020 2020 2020 2020 2020  nc):..          
-0001b0e0: 2020 2020 2020 6465 6620 6675 6e63 280a        def func(.
-0001b0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b100: 2020 2020 696e 7075 743a 2049 6e70 7574      input: Input
-0001b110: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001b120: 2020 2020 2020 7275 6e5f 6d61 6e61 6765        run_manage
-0001b130: 723a 2041 7379 6e63 4361 6c6c 6261 636b  r: AsyncCallback
-0001b140: 4d61 6e61 6765 7246 6f72 4368 6169 6e52  ManagerForChainR
-0001b150: 756e 2c0a 2020 2020 2020 2020 2020 2020  un,.            
-0001b160: 2020 2020 2020 2020 636f 6e66 6967 3a20          config: 
-0001b170: 5275 6e6e 6162 6c65 436f 6e66 6967 2c0a  RunnableConfig,.
-0001b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b190: 2920 2d3e 204f 7574 7075 743a 0a20 2020  ) -> Output:.   
-0001b1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b1b0: 206f 7574 7075 743a 204f 7074 696f 6e61   output: Optiona
-0001b1c0: 6c5b 4f75 7470 7574 5d20 3d20 4e6f 6e65  l[Output] = None
-0001b1d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b1e0: 2020 2020 2066 6f72 2063 6875 6e6b 2069       for chunk i
-0001b1f0: 6e20 6361 6c6c 5f66 756e 635f 7769 7468  n call_func_with
-0001b200: 5f76 6172 6961 626c 655f 6172 6773 280a  _variable_args(.
-0001b210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b220: 2020 2020 2020 2020 6361 7374 2843 616c          cast(Cal
-0001b230: 6c61 626c 655b 5b49 6e70 7574 5d2c 2049  lable[[Input], I
-0001b240: 7465 7261 746f 725b 4f75 7470 7574 5d5d  terator[Output]]
-0001b250: 2c20 7365 6c66 2e66 756e 6329 2c0a 2020  , self.func),.  
-0001b260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b270: 2020 2020 2020 696e 7075 742c 0a20 2020        input,.   
-0001b280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b290: 2020 2020 2063 6f6e 6669 672c 0a20 2020       config,.   
-0001b2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b2b0: 2020 2020 2072 756e 5f6d 616e 6167 6572       run_manager
-0001b2c0: 2e67 6574 5f73 796e 6328 292c 0a20 2020  .get_sync(),.   
-0001b2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b2e0: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
-0001b2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b300: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
-0001b310: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0001b320: 206f 7574 7075 7420 6973 204e 6f6e 653a   output is None:
-0001b330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b340: 2020 2020 2020 2020 2020 2020 206f 7574               out
-0001b350: 7075 7420 3d20 6368 756e 6b0a 2020 2020  put = chunk.    
-0001b360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b370: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001b380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b390: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0001b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b3b0: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
-0001b3c0: 7420 3d20 6f75 7470 7574 202b 2063 6875  t = output + chu
-0001b3d0: 6e6b 2020 2320 7479 7065 3a20 6967 6e6f  nk  # type: igno
-0001b3e0: 7265 5b6f 7065 7261 746f 725d 0a20 2020  re[operator].   
-0001b3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b400: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-0001b410: 5479 7065 4572 726f 723a 0a20 2020 2020  TypeError:.     
-0001b420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b430: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
-0001b440: 7420 3d20 6368 756e 6b0a 2020 2020 2020  t = chunk.      
-0001b450: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0001b460: 7475 726e 2063 6173 7428 4f75 7470 7574  turn cast(Output
-0001b470: 2c20 6f75 7470 7574 290a 0a20 2020 2020  , output)..     
-0001b480: 2020 2020 2020 2065 6c73 653a 0a0a 2020         else:..  
-0001b490: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0001b4a0: 6620 6675 6e63 280a 2020 2020 2020 2020  f func(.        
-0001b4b0: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
-0001b4c0: 743a 2049 6e70 7574 2c0a 2020 2020 2020  t: Input,.      
-0001b4d0: 2020 2020 2020 2020 2020 2020 2020 7275                ru
-0001b4e0: 6e5f 6d61 6e61 6765 723a 2041 7379 6e63  n_manager: Async
-0001b4f0: 4361 6c6c 6261 636b 4d61 6e61 6765 7246  CallbackManagerF
-0001b500: 6f72 4368 6169 6e52 756e 2c0a 2020 2020  orChainRun,.    
-0001b510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b520: 636f 6e66 6967 3a20 5275 6e6e 6162 6c65  config: Runnable
-0001b530: 436f 6e66 6967 2c0a 2020 2020 2020 2020  Config,.        
-0001b540: 2020 2020 2020 2020 2920 2d3e 204f 7574          ) -> Out
-0001b550: 7075 743a 0a20 2020 2020 2020 2020 2020  put:.           
-0001b560: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001b570: 6361 6c6c 5f66 756e 635f 7769 7468 5f76  call_func_with_v
-0001b580: 6172 6961 626c 655f 6172 6773 280a 2020  ariable_args(.  
-0001b590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b5a0: 2020 2020 2020 7365 6c66 2e66 756e 632c        self.func,
-0001b5b0: 2069 6e70 7574 2c20 636f 6e66 6967 2c20   input, config, 
-0001b5c0: 7275 6e5f 6d61 6e61 6765 722e 6765 745f  run_manager.get_
-0001b5d0: 7379 6e63 2829 2c20 2a2a 6b77 6172 6773  sync(), **kwargs
-0001b5e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b5f0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0001b600: 2020 2020 4077 7261 7073 2866 756e 6329      @wraps(func)
-0001b610: 0a20 2020 2020 2020 2020 2020 2061 7379  .            asy
-0001b620: 6e63 2064 6566 2066 282a 6172 6773 2c20  nc def f(*args, 
-0001b630: 2a2a 6b77 6172 6773 293a 2020 2320 7479  **kwargs):  # ty
-0001b640: 7065 3a20 6967 6e6f 7265 5b6e 6f2d 756e  pe: ignore[no-un
-0001b650: 7479 7065 642d 6465 665d 0a20 2020 2020  typed-def].     
-0001b660: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001b670: 6e20 6177 6169 7420 7275 6e5f 696e 5f65  n await run_in_e
-0001b680: 7865 6375 746f 7228 636f 6e66 6967 2c20  xecutor(config, 
-0001b690: 6675 6e63 2c20 2a61 7267 732c 202a 2a6b  func, *args, **k
-0001b6a0: 7761 7267 7329 0a0a 2020 2020 2020 2020  wargs)..        
-0001b6b0: 2020 2020 6166 756e 6320 3d20 660a 0a20      afunc = f.. 
-0001b6c0: 2020 2020 2020 2069 6620 696e 7370 6563         if inspec
-0001b6d0: 742e 6973 6173 796e 6367 656e 6675 6e63  t.isasyncgenfunc
-0001b6e0: 7469 6f6e 2861 6675 6e63 293a 0a20 2020  tion(afunc):.   
-0001b6f0: 2020 2020 2020 2020 206f 7574 7075 743a           output:
-0001b700: 204f 7074 696f 6e61 6c5b 4f75 7470 7574   Optional[Output
-0001b710: 5d20 3d20 4e6f 6e65 0a20 2020 2020 2020  ] = None.       
-0001b720: 2020 2020 2061 7379 6e63 2066 6f72 2063       async for c
-0001b730: 6875 6e6b 2069 6e20 6361 7374 280a 2020  hunk in cast(.  
-0001b740: 2020 2020 2020 2020 2020 2020 2020 4173                As
-0001b750: 796e 6349 7465 7261 746f 725b 4f75 7470  yncIterator[Outp
-0001b760: 7574 5d2c 0a20 2020 2020 2020 2020 2020  ut],.           
-0001b770: 2020 2020 2061 6361 6c6c 5f66 756e 635f       acall_func_
-0001b780: 7769 7468 5f76 6172 6961 626c 655f 6172  with_variable_ar
-0001b790: 6773 280a 2020 2020 2020 2020 2020 2020  gs(.            
-0001b7a0: 2020 2020 2020 2020 6361 7374 2843 616c          cast(Cal
-0001b7b0: 6c61 626c 652c 2061 6675 6e63 292c 0a20  lable, afunc),. 
-0001b7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b7d0: 2020 2069 6e70 7574 2c0a 2020 2020 2020     input,.      
-0001b7e0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0001b7f0: 6e66 6967 2c0a 2020 2020 2020 2020 2020  nfig,.          
-0001b800: 2020 2020 2020 2020 2020 7275 6e5f 6d61            run_ma
-0001b810: 6e61 6765 722c 0a20 2020 2020 2020 2020  nager,.         
-0001b820: 2020 2020 2020 2020 2020 202a 2a6b 7761             **kwa
-0001b830: 7267 732c 0a20 2020 2020 2020 2020 2020  rgs,.           
-0001b840: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-0001b850: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-0001b860: 2020 2020 2020 2069 6620 6f75 7470 7574         if output
-0001b870: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0001b880: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
-0001b890: 7470 7574 203d 2063 6875 6e6b 0a20 2020  tput = chunk.   
-0001b8a0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0001b8b0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001b8c0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0001b8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b8e0: 2020 2020 6f75 7470 7574 203d 206f 7574      output = out
-0001b8f0: 7075 7420 2b20 6368 756e 6b20 2023 2074  put + chunk  # t
-0001b900: 7970 653a 2069 676e 6f72 655b 6f70 6572  ype: ignore[oper
-0001b910: 6174 6f72 5d0a 2020 2020 2020 2020 2020  ator].          
-0001b920: 2020 2020 2020 2020 2020 6578 6365 7074            except
-0001b930: 2054 7970 6545 7272 6f72 3a0a 2020 2020   TypeError:.    
-0001b940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b950: 2020 2020 6f75 7470 7574 203d 2063 6875      output = chu
-0001b960: 6e6b 0a20 2020 2020 2020 2065 6c73 653a  nk.        else:
-0001b970: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-0001b980: 7075 7420 3d20 6177 6169 7420 6163 616c  put = await acal
-0001b990: 6c5f 6675 6e63 5f77 6974 685f 7661 7269  l_func_with_vari
-0001b9a0: 6162 6c65 5f61 7267 7328 0a20 2020 2020  able_args(.     
-0001b9b0: 2020 2020 2020 2020 2020 2063 6173 7428             cast(
-0001b9c0: 4361 6c6c 6162 6c65 2c20 6166 756e 6329  Callable, afunc)
-0001b9d0: 2c20 696e 7075 742c 2063 6f6e 6669 672c  , input, config,
-0001b9e0: 2072 756e 5f6d 616e 6167 6572 2c20 2a2a   run_manager, **
-0001b9f0: 6b77 6172 6773 0a20 2020 2020 2020 2020  kwargs.         
-0001ba00: 2020 2029 0a20 2020 2020 2020 2023 2049     ).        # I
-0001ba10: 6620 7468 6520 6f75 7470 7574 2069 7320  f the output is 
-0001ba20: 6120 7275 6e6e 6162 6c65 2c20 696e 766f  a runnable, invo
-0001ba30: 6b65 2069 740a 2020 2020 2020 2020 6966  ke it.        if
-0001ba40: 2069 7369 6e73 7461 6e63 6528 6f75 7470   isinstance(outp
-0001ba50: 7574 2c20 5275 6e6e 6162 6c65 293a 0a20  ut, Runnable):. 
-0001ba60: 2020 2020 2020 2020 2020 2072 6563 7572             recur
-0001ba70: 7369 6f6e 5f6c 696d 6974 203d 2063 6f6e  sion_limit = con
-0001ba80: 6669 675b 2272 6563 7572 7369 6f6e 5f6c  fig["recursion_l
-0001ba90: 696d 6974 225d 0a20 2020 2020 2020 2020  imit"].         
-0001baa0: 2020 2069 6620 7265 6375 7273 696f 6e5f     if recursion_
-0001bab0: 6c69 6d69 7420 3c3d 2030 3a0a 2020 2020  limit <= 0:.    
-0001bac0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0001bad0: 6520 5265 6375 7273 696f 6e45 7272 6f72  e RecursionError
-0001bae0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001baf0: 2020 2020 2020 6622 5265 6375 7273 696f        f"Recursio
-0001bb00: 6e20 6c69 6d69 7420 7265 6163 6865 6420  n limit reached 
-0001bb10: 7768 656e 2069 6e76 6f6b 696e 6720 7b73  when invoking {s
-0001bb20: 656c 667d 2077 6974 6820 696e 7075 7420  elf} with input 
-0001bb30: 7b69 6e70 7574 7d2e 220a 2020 2020 2020  {input}.".      
-0001bb40: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001bb50: 2020 2020 2020 2020 6f75 7470 7574 203d          output =
-0001bb60: 2061 7761 6974 206f 7574 7075 742e 6169   await output.ai
-0001bb70: 6e76 6f6b 6528 0a20 2020 2020 2020 2020  nvoke(.         
-0001bb80: 2020 2020 2020 2069 6e70 7574 2c0a 2020         input,.  
-0001bb90: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-0001bba0: 7463 685f 636f 6e66 6967 280a 2020 2020  tch_config(.    
-0001bbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bbc0: 636f 6e66 6967 2c0a 2020 2020 2020 2020  config,.        
-0001bbd0: 2020 2020 2020 2020 2020 2020 6361 6c6c              call
-0001bbe0: 6261 636b 733d 7275 6e5f 6d61 6e61 6765  backs=run_manage
-0001bbf0: 722e 6765 745f 6368 696c 6428 292c 0a20  r.get_child(),. 
-0001bc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc10: 2020 2072 6563 7572 7369 6f6e 5f6c 696d     recursion_lim
-0001bc20: 6974 3d72 6563 7572 7369 6f6e 5f6c 696d  it=recursion_lim
-0001bc30: 6974 202d 2031 2c0a 2020 2020 2020 2020  it - 1,.        
-0001bc40: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
-0001bc50: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001bc60: 2072 6574 7572 6e20 6361 7374 284f 7574   return cast(Out
-0001bc70: 7075 742c 206f 7574 7075 7429 0a0a 2020  put, output)..  
-0001bc80: 2020 6465 6620 5f63 6f6e 6669 6728 0a20    def _config(. 
-0001bc90: 2020 2020 2020 2073 656c 662c 2063 6f6e         self, con
-0001bca0: 6669 673a 204f 7074 696f 6e61 6c5b 5275  fig: Optional[Ru
-0001bcb0: 6e6e 6162 6c65 436f 6e66 6967 5d2c 2063  nnableConfig], c
-0001bcc0: 616c 6c61 626c 653a 2043 616c 6c61 626c  allable: Callabl
-0001bcd0: 655b 2e2e 2e2c 2041 6e79 5d0a 2020 2020  e[..., Any].    
-0001bce0: 2920 2d3e 2052 756e 6e61 626c 6543 6f6e  ) -> RunnableCon
-0001bcf0: 6669 673a 0a20 2020 2020 2020 2072 6574  fig:.        ret
-0001bd00: 7572 6e20 656e 7375 7265 5f63 6f6e 6669  urn ensure_confi
-0001bd10: 6728 636f 6e66 6967 290a 0a20 2020 2064  g(config)..    d
-0001bd20: 6566 2069 6e76 6f6b 6528 0a20 2020 2020  ef invoke(.     
-0001bd30: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-0001bd40: 2069 6e70 7574 3a20 496e 7075 742c 0a20   input: Input,. 
-0001bd50: 2020 2020 2020 2063 6f6e 6669 673a 204f         config: O
-0001bd60: 7074 696f 6e61 6c5b 5275 6e6e 6162 6c65  ptional[Runnable
-0001bd70: 436f 6e66 6967 5d20 3d20 4e6f 6e65 2c0a  Config] = None,.
-0001bd80: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
-0001bd90: 3a20 4f70 7469 6f6e 616c 5b41 6e79 5d2c  : Optional[Any],
-0001bda0: 0a20 2020 2029 202d 3e20 4f75 7470 7574  .    ) -> Output
-0001bdb0: 3a0a 2020 2020 2020 2020 2222 2249 6e76  :.        """Inv
-0001bdc0: 6f6b 6520 7468 6973 2072 756e 6e61 626c  oke this runnabl
-0001bdd0: 6520 7379 6e63 6872 6f6e 6f75 736c 792e  e synchronously.
-0001bde0: 2222 220a 2020 2020 2020 2020 6966 2068  """.        if h
-0001bdf0: 6173 6174 7472 2873 656c 662c 2022 6675  asattr(self, "fu
-0001be00: 6e63 2229 3a0a 2020 2020 2020 2020 2020  nc"):.          
-0001be10: 2020 7265 7475 726e 2073 656c 662e 5f63    return self._c
-0001be20: 616c 6c5f 7769 7468 5f63 6f6e 6669 6728  all_with_config(
+00018db0: 2020 2020 2020 2020 2020 2020 7061 7463              patc
+00018dc0: 685f 636f 6e66 6967 280a 2020 2020 2020  h_config(.      
+00018dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018de0: 2020 2020 2020 2020 2020 636f 6e66 6967            config
+00018df0: 2c20 6361 6c6c 6261 636b 733d 726d 2e67  , callbacks=rm.g
+00018e00: 6574 5f63 6869 6c64 2866 2273 6571 3a73  et_child(f"seq:s
+00018e10: 7465 703a 7b69 2b31 7d22 290a 2020 2020  tep:{i+1}").    
+00018e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e30: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00018e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e50: 2020 2020 2020 666f 7220 726d 2c20 636f        for rm, co
+00018e60: 6e66 6967 2069 6e20 7a69 7028 7275 6e5f  nfig in zip(run_
+00018e70: 6d61 6e61 6765 7273 2c20 636f 6e66 6967  managers, config
+00018e80: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+00018e90: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
+00018ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018eb0: 2020 290a 0a20 2020 2020 2020 2023 2066    )..        # f
+00018ec0: 696e 6973 6820 7468 6520 726f 6f74 2072  inish the root r
+00018ed0: 756e 730a 2020 2020 2020 2020 6578 6365  uns.        exce
+00018ee0: 7074 2042 6173 6545 7863 6570 7469 6f6e  pt BaseException
+00018ef0: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+00018f00: 2020 2066 6f72 2072 6d20 696e 2072 756e     for rm in run
+00018f10: 5f6d 616e 6167 6572 733a 0a20 2020 2020  _managers:.     
+00018f20: 2020 2020 2020 2020 2020 2072 6d2e 6f6e             rm.on
+00018f30: 5f63 6861 696e 5f65 7272 6f72 2865 290a  _chain_error(e).
+00018f40: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+00018f50: 6574 7572 6e5f 6578 6365 7074 696f 6e73  eturn_exceptions
+00018f60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00018f70: 2020 7265 7475 726e 2063 6173 7428 4c69    return cast(Li
+00018f80: 7374 5b4f 7574 7075 745d 2c20 5b65 2066  st[Output], [e f
+00018f90: 6f72 205f 2069 6e20 696e 7075 7473 5d29  or _ in inputs])
+00018fa0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00018fb0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00018fc0: 2020 2072 6169 7365 0a20 2020 2020 2020     raise.       
+00018fd0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00018fe0: 2020 2066 6972 7374 5f65 7863 6570 7469     first_excepti
+00018ff0: 6f6e 3a20 4f70 7469 6f6e 616c 5b45 7863  on: Optional[Exc
+00019000: 6570 7469 6f6e 5d20 3d20 4e6f 6e65 0a20  eption] = None. 
+00019010: 2020 2020 2020 2020 2020 2066 6f72 2072             for r
+00019020: 756e 5f6d 616e 6167 6572 2c20 6f75 7420  un_manager, out 
+00019030: 696e 207a 6970 2872 756e 5f6d 616e 6167  in zip(run_manag
+00019040: 6572 732c 2069 6e70 7574 7329 3a0a 2020  ers, inputs):.  
+00019050: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00019060: 2069 7369 6e73 7461 6e63 6528 6f75 742c   isinstance(out,
+00019070: 2045 7863 6570 7469 6f6e 293a 0a20 2020   Exception):.   
+00019080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019090: 2066 6972 7374 5f65 7863 6570 7469 6f6e   first_exception
+000190a0: 203d 2066 6972 7374 5f65 7863 6570 7469   = first_excepti
+000190b0: 6f6e 206f 7220 6f75 740a 2020 2020 2020  on or out.      
+000190c0: 2020 2020 2020 2020 2020 2020 2020 7275                ru
+000190d0: 6e5f 6d61 6e61 6765 722e 6f6e 5f63 6861  n_manager.on_cha
+000190e0: 696e 5f65 7272 6f72 286f 7574 290a 2020  in_error(out).  
+000190f0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00019100: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00019110: 2020 2020 2020 2020 7275 6e5f 6d61 6e61          run_mana
+00019120: 6765 722e 6f6e 5f63 6861 696e 5f65 6e64  ger.on_chain_end
+00019130: 286f 7574 290a 2020 2020 2020 2020 2020  (out).          
+00019140: 2020 6966 2072 6574 7572 6e5f 6578 6365    if return_exce
+00019150: 7074 696f 6e73 206f 7220 6669 7273 745f  ptions or first_
+00019160: 6578 6365 7074 696f 6e20 6973 204e 6f6e  exception is Non
+00019170: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00019180: 2020 2072 6574 7572 6e20 6361 7374 284c     return cast(L
+00019190: 6973 745b 4f75 7470 7574 5d2c 2069 6e70  ist[Output], inp
+000191a0: 7574 7329 0a20 2020 2020 2020 2020 2020  uts).           
+000191b0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000191c0: 2020 2020 2020 2072 6169 7365 2066 6972         raise fir
+000191d0: 7374 5f65 7863 6570 7469 6f6e 0a0a 2020  st_exception..  
+000191e0: 2020 6173 796e 6320 6465 6620 6162 6174    async def abat
+000191f0: 6368 280a 2020 2020 2020 2020 7365 6c66  ch(.        self
+00019200: 2c0a 2020 2020 2020 2020 696e 7075 7473  ,.        inputs
+00019210: 3a20 4c69 7374 5b49 6e70 7574 5d2c 0a20  : List[Input],. 
+00019220: 2020 2020 2020 2063 6f6e 6669 673a 204f         config: O
+00019230: 7074 696f 6e61 6c5b 556e 696f 6e5b 5275  ptional[Union[Ru
+00019240: 6e6e 6162 6c65 436f 6e66 6967 2c20 4c69  nnableConfig, Li
+00019250: 7374 5b52 756e 6e61 626c 6543 6f6e 6669  st[RunnableConfi
+00019260: 675d 5d5d 203d 204e 6f6e 652c 0a20 2020  g]]] = None,.   
+00019270: 2020 2020 202a 2c0a 2020 2020 2020 2020       *,.        
+00019280: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
+00019290: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
+000192a0: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+000192b0: 733a 204f 7074 696f 6e61 6c5b 416e 795d  s: Optional[Any]
+000192c0: 2c0a 2020 2020 2920 2d3e 204c 6973 745b  ,.    ) -> List[
+000192d0: 4f75 7470 7574 5d3a 0a20 2020 2020 2020  Output]:.       
+000192e0: 2066 726f 6d20 6c61 6e67 6368 6169 6e5f   from langchain_
+000192f0: 636f 7265 2e62 6574 612e 7275 6e6e 6162  core.beta.runnab
+00019300: 6c65 732e 636f 6e74 6578 7420 696d 706f  les.context impo
+00019310: 7274 2061 636f 6e66 6967 5f77 6974 685f  rt aconfig_with_
+00019320: 636f 6e74 6578 740a 2020 2020 2020 2020  context.        
+00019330: 6672 6f6d 206c 616e 6763 6861 696e 5f63  from langchain_c
+00019340: 6f72 652e 6361 6c6c 6261 636b 732e 6d61  ore.callbacks.ma
+00019350: 6e61 6765 7220 696d 706f 7274 2041 7379  nager import Asy
+00019360: 6e63 4361 6c6c 6261 636b 4d61 6e61 6765  ncCallbackManage
+00019370: 720a 0a20 2020 2020 2020 2069 6620 6e6f  r..        if no
+00019380: 7420 696e 7075 7473 3a0a 2020 2020 2020  t inputs:.      
+00019390: 2020 2020 2020 7265 7475 726e 205b 5d0a        return [].
+000193a0: 0a20 2020 2020 2020 2023 2073 6574 7570  .        # setup
+000193b0: 2063 616c 6c62 6163 6b73 2061 6e64 2063   callbacks and c
+000193c0: 6f6e 7465 7874 0a20 2020 2020 2020 2063  ontext.        c
+000193d0: 6f6e 6669 6773 203d 205b 0a20 2020 2020  onfigs = [.     
+000193e0: 2020 2020 2020 2061 636f 6e66 6967 5f77         aconfig_w
+000193f0: 6974 685f 636f 6e74 6578 7428 632c 2073  ith_context(c, s
+00019400: 656c 662e 7374 6570 7329 0a20 2020 2020  elf.steps).     
+00019410: 2020 2020 2020 2066 6f72 2063 2069 6e20         for c in 
+00019420: 6765 745f 636f 6e66 6967 5f6c 6973 7428  get_config_list(
+00019430: 636f 6e66 6967 2c20 6c65 6e28 696e 7075  config, len(inpu
+00019440: 7473 2929 0a20 2020 2020 2020 205d 0a20  ts)).        ]. 
+00019450: 2020 2020 2020 2063 616c 6c62 6163 6b5f         callback_
+00019460: 6d61 6e61 6765 7273 203d 205b 0a20 2020  managers = [.   
+00019470: 2020 2020 2020 2020 2041 7379 6e63 4361           AsyncCa
+00019480: 6c6c 6261 636b 4d61 6e61 6765 722e 636f  llbackManager.co
+00019490: 6e66 6967 7572 6528 0a20 2020 2020 2020  nfigure(.       
+000194a0: 2020 2020 2020 2020 2069 6e68 6572 6974           inherit
+000194b0: 6162 6c65 5f63 616c 6c62 6163 6b73 3d63  able_callbacks=c
+000194c0: 6f6e 6669 672e 6765 7428 2263 616c 6c62  onfig.get("callb
+000194d0: 6163 6b73 2229 2c0a 2020 2020 2020 2020  acks"),.        
+000194e0: 2020 2020 2020 2020 6c6f 6361 6c5f 6361          local_ca
+000194f0: 6c6c 6261 636b 733d 4e6f 6e65 2c0a 2020  llbacks=None,.  
+00019500: 2020 2020 2020 2020 2020 2020 2020 7665                ve
+00019510: 7262 6f73 653d 4661 6c73 652c 0a20 2020  rbose=False,.   
+00019520: 2020 2020 2020 2020 2020 2020 2069 6e68               inh
+00019530: 6572 6974 6162 6c65 5f74 6167 733d 636f  eritable_tags=co
+00019540: 6e66 6967 2e67 6574 2822 7461 6773 2229  nfig.get("tags")
+00019550: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00019560: 2020 6c6f 6361 6c5f 7461 6773 3d4e 6f6e    local_tags=Non
+00019570: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00019580: 2020 2069 6e68 6572 6974 6162 6c65 5f6d     inheritable_m
+00019590: 6574 6164 6174 613d 636f 6e66 6967 2e67  etadata=config.g
+000195a0: 6574 2822 6d65 7461 6461 7461 2229 2c0a  et("metadata"),.
+000195b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000195c0: 6c6f 6361 6c5f 6d65 7461 6461 7461 3d4e  local_metadata=N
+000195d0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+000195e0: 2029 0a20 2020 2020 2020 2020 2020 2066   ).            f
+000195f0: 6f72 2063 6f6e 6669 6720 696e 2063 6f6e  or config in con
+00019600: 6669 6773 0a20 2020 2020 2020 205d 0a20  figs.        ]. 
+00019610: 2020 2020 2020 2023 2073 7461 7274 2074         # start t
+00019620: 6865 2072 6f6f 7420 7275 6e73 2c20 6f6e  he root runs, on
+00019630: 6520 7065 7220 696e 7075 740a 2020 2020  e per input.    
+00019640: 2020 2020 7275 6e5f 6d61 6e61 6765 7273      run_managers
+00019650: 3a20 4c69 7374 5b41 7379 6e63 4361 6c6c  : List[AsyncCall
+00019660: 6261 636b 4d61 6e61 6765 7246 6f72 4368  backManagerForCh
+00019670: 6169 6e52 756e 5d20 3d20 6177 6169 7420  ainRun] = await 
+00019680: 6173 796e 6369 6f2e 6761 7468 6572 280a  asyncio.gather(.
+00019690: 2020 2020 2020 2020 2020 2020 2a28 0a20              *(. 
+000196a0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000196b0: 6d2e 6f6e 5f63 6861 696e 5f73 7461 7274  m.on_chain_start
+000196c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000196d0: 2020 2020 2020 6475 6d70 6428 7365 6c66        dumpd(self
+000196e0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000196f0: 2020 2020 2020 2069 6e70 7574 2c0a 2020         input,.  
+00019700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019710: 2020 6e61 6d65 3d63 6f6e 6669 672e 6765    name=config.ge
+00019720: 7428 2272 756e 5f6e 616d 6522 2920 6f72  t("run_name") or
+00019730: 2073 656c 662e 6765 745f 6e61 6d65 2829   self.get_name()
+00019740: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00019750: 2020 2020 2020 7275 6e5f 6964 3d63 6f6e        run_id=con
+00019760: 6669 672e 706f 7028 2272 756e 5f69 6422  fig.pop("run_id"
+00019770: 2c20 4e6f 6e65 292c 0a20 2020 2020 2020  , None),.       
+00019780: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00019790: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
+000197a0: 6d2c 2069 6e70 7574 2c20 636f 6e66 6967  m, input, config
+000197b0: 2069 6e20 7a69 7028 6361 6c6c 6261 636b   in zip(callback
+000197c0: 5f6d 616e 6167 6572 732c 2069 6e70 7574  _managers, input
+000197d0: 732c 2063 6f6e 6669 6773 290a 2020 2020  s, configs).    
+000197e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000197f0: 2020 290a 0a20 2020 2020 2020 2023 2069    )..        # i
+00019800: 6e76 6f6b 6520 2e62 6174 6368 2829 206f  nvoke .batch() o
+00019810: 6e20 6561 6368 2073 7465 700a 2020 2020  n each step.    
+00019820: 2020 2020 2320 7468 6973 2075 7365 7320      # this uses 
+00019830: 6261 7463 6869 6e67 206f 7074 696d 697a  batching optimiz
+00019840: 6174 696f 6e73 2069 6e20 5275 6e6e 6162  ations in Runnab
+00019850: 6c65 2073 7562 636c 6173 7365 732c 206c  le subclasses, l
+00019860: 696b 6520 4c4c 4d0a 2020 2020 2020 2020  ike LLM.        
+00019870: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00019880: 2069 6620 7265 7475 726e 5f65 7863 6570   if return_excep
+00019890: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
+000198a0: 2020 2020 2020 2023 2054 7261 636b 2077         # Track w
+000198b0: 6869 6368 2069 6e70 7574 7320 2862 7920  hich inputs (by 
+000198c0: 696e 6465 7829 2066 6169 6c65 6420 736f  index) failed so
+000198d0: 2066 6172 0a20 2020 2020 2020 2020 2020   far.           
+000198e0: 2020 2020 2023 2049 6620 616e 2069 6e70       # If an inp
+000198f0: 7574 2068 6173 2066 6169 6c65 6420 6974  ut has failed it
+00019900: 2077 696c 6c20 6265 2070 7265 7365 6e74   will be present
+00019910: 2069 6e20 7468 6973 206d 6170 2c0a 2020   in this map,.  
+00019920: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00019930: 616e 6420 7468 6520 7661 6c75 6520 7769  and the value wi
+00019940: 6c6c 2062 6520 7468 6520 6578 6365 7074  ll be the except
+00019950: 696f 6e20 7468 6174 2077 6173 2072 6169  ion that was rai
+00019960: 7365 642e 0a20 2020 2020 2020 2020 2020  sed..           
+00019970: 2020 2020 2066 6169 6c65 645f 696e 7075       failed_inpu
+00019980: 7473 5f6d 6170 3a20 4469 6374 5b69 6e74  ts_map: Dict[int
+00019990: 2c20 4578 6365 7074 696f 6e5d 203d 207b  , Exception] = {
+000199a0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+000199b0: 2020 666f 7220 7374 6570 6964 782c 2073    for stepidx, s
+000199c0: 7465 7020 696e 2065 6e75 6d65 7261 7465  tep in enumerate
+000199d0: 2873 656c 662e 7374 6570 7329 3a0a 2020  (self.steps):.  
+000199e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000199f0: 2020 2320 4173 7365 6d62 6c65 2074 6865    # Assemble the
+00019a00: 206f 7269 6769 6e61 6c20 696e 6465 7865   original indexe
+00019a10: 7320 6f66 2074 6865 2072 656d 6169 6e69  s of the remaini
+00019a20: 6e67 2069 6e70 7574 730a 2020 2020 2020  ng inputs.      
+00019a30: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00019a40: 2869 2e65 2e20 7468 6520 6f6e 6573 2074  (i.e. the ones t
+00019a50: 6861 7420 6861 7665 6e27 7420 6661 696c  hat haven't fail
+00019a60: 6564 2079 6574 290a 2020 2020 2020 2020  ed yet).        
+00019a70: 2020 2020 2020 2020 2020 2020 7265 6d61              rema
+00019a80: 696e 696e 675f 6964 7873 203d 205b 0a20  ining_idxs = [. 
+00019a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019aa0: 2020 2020 2020 2069 2066 6f72 2069 2069         i for i i
+00019ab0: 6e20 7261 6e67 6528 6c65 6e28 636f 6e66  n range(len(conf
+00019ac0: 6967 7329 2920 6966 2069 206e 6f74 2069  igs)) if i not i
+00019ad0: 6e20 6661 696c 6564 5f69 6e70 7574 735f  n failed_inputs_
+00019ae0: 6d61 700a 2020 2020 2020 2020 2020 2020  map.            
+00019af0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+00019b00: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00019b10: 496e 766f 6b65 2074 6865 2073 7465 7020  Invoke the step 
+00019b20: 6f6e 2074 6865 2072 656d 6169 6e69 6e67  on the remaining
+00019b30: 2069 6e70 7574 730a 2020 2020 2020 2020   inputs.        
+00019b40: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+00019b50: 7473 203d 2061 7761 6974 2073 7465 702e  ts = await step.
+00019b60: 6162 6174 6368 280a 2020 2020 2020 2020  abatch(.        
+00019b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b80: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00019b90: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00019ba0: 700a 2020 2020 2020 2020 2020 2020 2020  p.              
+00019bb0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00019bc0: 7220 692c 2069 6e70 2069 6e20 7a69 7028  r i, inp in zip(
+00019bd0: 7265 6d61 696e 696e 675f 6964 7873 2c20  remaining_idxs, 
+00019be0: 696e 7075 7473 290a 2020 2020 2020 2020  inputs).        
+00019bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019c00: 2020 2020 6966 2069 206e 6f74 2069 6e20      if i not in 
+00019c10: 6661 696c 6564 5f69 6e70 7574 735f 6d61  failed_inputs_ma
+00019c20: 700a 2020 2020 2020 2020 2020 2020 2020  p.              
+00019c30: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
+00019c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019c50: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00019c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019c70: 2020 2023 2065 6163 6820 7374 6570 2061     # each step a
+00019c80: 2063 6869 6c64 2072 756e 206f 6620 7468   child run of th
+00019c90: 6520 636f 7272 6573 706f 6e64 696e 6720  e corresponding 
+00019ca0: 726f 6f74 2072 756e 0a20 2020 2020 2020  root run.       
+00019cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019cc0: 2020 2020 2070 6174 6368 5f63 6f6e 6669       patch_confi
+00019cd0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00019ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019cf0: 2020 2063 6f6e 6669 672c 2063 616c 6c62     config, callb
+00019d00: 6163 6b73 3d72 6d2e 6765 745f 6368 696c  acks=rm.get_chil
+00019d10: 6428 6622 7365 713a 7374 6570 3a7b 7374  d(f"seq:step:{st
+00019d20: 6570 6964 782b 317d 2229 0a20 2020 2020  epidx+1}").     
+00019d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d40: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00019d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d60: 2020 2020 2066 6f72 2069 2c20 2872 6d2c       for i, (rm,
+00019d70: 2063 6f6e 6669 6729 2069 6e20 656e 756d   config) in enum
+00019d80: 6572 6174 6528 7a69 7028 7275 6e5f 6d61  erate(zip(run_ma
+00019d90: 6e61 6765 7273 2c20 636f 6e66 6967 7329  nagers, configs)
+00019da0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00019db0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00019dc0: 2069 206e 6f74 2069 6e20 6661 696c 6564   i not in failed
+00019dd0: 5f69 6e70 7574 735f 6d61 700a 2020 2020  _inputs_map.    
+00019de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019df0: 2020 2020 5d2c 0a20 2020 2020 2020 2020      ],.         
+00019e00: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00019e10: 6574 7572 6e5f 6578 6365 7074 696f 6e73  eturn_exceptions
+00019e20: 3d72 6574 7572 6e5f 6578 6365 7074 696f  =return_exceptio
+00019e30: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+00019e40: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
+00019e50: 6172 6773 2c0a 2020 2020 2020 2020 2020  args,.          
+00019e60: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00019e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019e80: 2320 4966 2061 6e20 696e 7075 7420 6661  # If an input fa
+00019e90: 696c 6564 2c20 6164 6420 6974 2074 6f20  iled, add it to 
+00019ea0: 7468 6520 6d61 700a 2020 2020 2020 2020  the map.        
+00019eb0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00019ec0: 692c 2069 6e70 2069 6e20 7a69 7028 7265  i, inp in zip(re
+00019ed0: 6d61 696e 696e 675f 6964 7873 2c20 696e  maining_idxs, in
+00019ee0: 7075 7473 293a 0a20 2020 2020 2020 2020  puts):.         
+00019ef0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00019f00: 6620 6973 696e 7374 616e 6365 2869 6e70  f isinstance(inp
+00019f10: 2c20 4578 6365 7074 696f 6e29 3a0a 2020  , Exception):.  
+00019f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019f30: 2020 2020 2020 2020 2020 6661 696c 6564            failed
+00019f40: 5f69 6e70 7574 735f 6d61 705b 695d 203d  _inputs_map[i] =
+00019f50: 2069 6e70 0a20 2020 2020 2020 2020 2020   inp.           
+00019f60: 2020 2020 2020 2020 2069 6e70 7574 7320           inputs 
+00019f70: 3d20 5b69 6e70 2066 6f72 2069 6e70 2069  = [inp for inp i
+00019f80: 6e20 696e 7075 7473 2069 6620 6e6f 7420  n inputs if not 
+00019f90: 6973 696e 7374 616e 6365 2869 6e70 2c20  isinstance(inp, 
+00019fa0: 4578 6365 7074 696f 6e29 5d0a 2020 2020  Exception)].    
+00019fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019fc0: 2320 4966 2061 6c6c 2069 6e70 7574 7320  # If all inputs 
+00019fd0: 6861 7665 2066 6169 6c65 642c 2073 746f  have failed, sto
+00019fe0: 7020 7072 6f63 6573 7369 6e67 0a20 2020  p processing.   
+00019ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a000: 2069 6620 6c65 6e28 6661 696c 6564 5f69   if len(failed_i
+0001a010: 6e70 7574 735f 6d61 7029 203d 3d20 6c65  nputs_map) == le
+0001a020: 6e28 636f 6e66 6967 7329 3a0a 2020 2020  n(configs):.    
+0001a030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a040: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
+0001a050: 2020 2020 2020 2020 2020 2023 2052 6561             # Rea
+0001a060: 7373 656d 626c 6520 7468 6520 6f75 7470  ssemble the outp
+0001a070: 7574 732c 2069 6e73 6572 7469 6e67 2045  uts, inserting E
+0001a080: 7863 6570 7469 6f6e 7320 666f 7220 6661  xceptions for fa
+0001a090: 696c 6564 2069 6e70 7574 730a 2020 2020  iled inputs.    
+0001a0a0: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+0001a0b0: 7473 5f63 6f70 7920 3d20 696e 7075 7473  ts_copy = inputs
+0001a0c0: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
+0001a0d0: 2020 2020 2020 2020 696e 7075 7473 203d          inputs =
+0001a0e0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+0001a0f0: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
+0001a100: 6765 286c 656e 2863 6f6e 6669 6773 2929  ge(len(configs))
+0001a110: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001a120: 2020 2020 2020 6966 2069 2069 6e20 6661        if i in fa
+0001a130: 696c 6564 5f69 6e70 7574 735f 6d61 703a  iled_inputs_map:
+0001a140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a150: 2020 2020 2020 2020 2069 6e70 7574 732e           inputs.
+0001a160: 6170 7065 6e64 2863 6173 7428 496e 7075  append(cast(Inpu
+0001a170: 742c 2066 6169 6c65 645f 696e 7075 7473  t, failed_inputs
+0001a180: 5f6d 6170 5b69 5d29 290a 2020 2020 2020  _map[i])).      
+0001a190: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0001a1a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001a1b0: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+0001a1c0: 7473 2e61 7070 656e 6428 696e 7075 7473  ts.append(inputs
+0001a1d0: 5f63 6f70 792e 706f 7028 3029 290a 2020  _copy.pop(0)).  
+0001a1e0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0001a1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a200: 666f 7220 692c 2073 7465 7020 696e 2065  for i, step in e
+0001a210: 6e75 6d65 7261 7465 2873 656c 662e 7374  numerate(self.st
+0001a220: 6570 7329 3a0a 2020 2020 2020 2020 2020  eps):.          
+0001a230: 2020 2020 2020 2020 2020 696e 7075 7473            inputs
+0001a240: 203d 2061 7761 6974 2073 7465 702e 6162   = await step.ab
+0001a250: 6174 6368 280a 2020 2020 2020 2020 2020  atch(.          
+0001a260: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0001a270: 7075 7473 2c0a 2020 2020 2020 2020 2020  puts,.          
+0001a280: 2020 2020 2020 2020 2020 2020 2020 5b0a                [.
+0001a290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a2a0: 2020 2020 2020 2020 2020 2020 2320 6561              # ea
+0001a2b0: 6368 2073 7465 7020 6120 6368 696c 6420  ch step a child 
+0001a2c0: 7275 6e20 6f66 2074 6865 2063 6f72 7265  run of the corre
+0001a2d0: 7370 6f6e 6469 6e67 2072 6f6f 7420 7275  sponding root ru
+0001a2e0: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+0001a2f0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+0001a300: 7463 685f 636f 6e66 6967 280a 2020 2020  tch_config(.    
+0001a310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a320: 2020 2020 2020 2020 2020 2020 636f 6e66              conf
+0001a330: 6967 2c20 6361 6c6c 6261 636b 733d 726d  ig, callbacks=rm
+0001a340: 2e67 6574 5f63 6869 6c64 2866 2273 6571  .get_child(f"seq
+0001a350: 3a73 7465 703a 7b69 2b31 7d22 290a 2020  :step:{i+1}").  
+0001a360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a370: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001a380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a390: 2020 2020 2020 2020 666f 7220 726d 2c20          for rm, 
+0001a3a0: 636f 6e66 6967 2069 6e20 7a69 7028 7275  config in zip(ru
+0001a3b0: 6e5f 6d61 6e61 6765 7273 2c20 636f 6e66  n_managers, conf
+0001a3c0: 6967 7329 0a20 2020 2020 2020 2020 2020  igs).           
+0001a3d0: 2020 2020 2020 2020 2020 2020 205d 2c0a               ],.
+0001a3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a3f0: 2020 2020 290a 2020 2020 2020 2020 2320      ).        # 
+0001a400: 6669 6e69 7368 2074 6865 2072 6f6f 7420  finish the root 
+0001a410: 7275 6e73 0a20 2020 2020 2020 2065 7863  runs.        exc
+0001a420: 6570 7420 4261 7365 4578 6365 7074 696f  ept BaseExceptio
+0001a430: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
+0001a440: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
+0001a450: 6f2e 6761 7468 6572 282a 2872 6d2e 6f6e  o.gather(*(rm.on
+0001a460: 5f63 6861 696e 5f65 7272 6f72 2865 2920  _chain_error(e) 
+0001a470: 666f 7220 726d 2069 6e20 7275 6e5f 6d61  for rm in run_ma
+0001a480: 6e61 6765 7273 2929 0a20 2020 2020 2020  nagers)).       
+0001a490: 2020 2020 2069 6620 7265 7475 726e 5f65       if return_e
+0001a4a0: 7863 6570 7469 6f6e 733a 0a20 2020 2020  xceptions:.     
+0001a4b0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001a4c0: 6e20 6361 7374 284c 6973 745b 4f75 7470  n cast(List[Outp
+0001a4d0: 7574 5d2c 205b 6520 666f 7220 5f20 696e  ut], [e for _ in
+0001a4e0: 2069 6e70 7574 735d 290a 2020 2020 2020   inputs]).      
+0001a4f0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001a500: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0001a510: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
+0001a520: 2020 2020 2020 2020 2020 2020 6669 7273              firs
+0001a530: 745f 6578 6365 7074 696f 6e3a 204f 7074  t_exception: Opt
+0001a540: 696f 6e61 6c5b 4578 6365 7074 696f 6e5d  ional[Exception]
+0001a550: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+0001a560: 2020 2020 636f 726f 733a 204c 6973 745b      coros: List[
+0001a570: 4177 6169 7461 626c 655b 4e6f 6e65 5d5d  Awaitable[None]]
+0001a580: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
+0001a590: 2020 666f 7220 7275 6e5f 6d61 6e61 6765    for run_manage
+0001a5a0: 722c 206f 7574 2069 6e20 7a69 7028 7275  r, out in zip(ru
+0001a5b0: 6e5f 6d61 6e61 6765 7273 2c20 696e 7075  n_managers, inpu
+0001a5c0: 7473 293a 0a20 2020 2020 2020 2020 2020  ts):.           
+0001a5d0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0001a5e0: 6365 286f 7574 2c20 4578 6365 7074 696f  ce(out, Exceptio
+0001a5f0: 6e29 3a0a 2020 2020 2020 2020 2020 2020  n):.            
+0001a600: 2020 2020 2020 2020 6669 7273 745f 6578          first_ex
+0001a610: 6365 7074 696f 6e20 3d20 6669 7273 745f  ception = first_
+0001a620: 6578 6365 7074 696f 6e20 6f72 206f 7574  exception or out
+0001a630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a640: 2020 2020 2063 6f72 6f73 2e61 7070 656e       coros.appen
+0001a650: 6428 7275 6e5f 6d61 6e61 6765 722e 6f6e  d(run_manager.on
+0001a660: 5f63 6861 696e 5f65 7272 6f72 286f 7574  _chain_error(out
+0001a670: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+0001a680: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001a690: 2020 2020 2020 2020 2020 2020 2063 6f72               cor
+0001a6a0: 6f73 2e61 7070 656e 6428 7275 6e5f 6d61  os.append(run_ma
+0001a6b0: 6e61 6765 722e 6f6e 5f63 6861 696e 5f65  nager.on_chain_e
+0001a6c0: 6e64 286f 7574 2929 0a20 2020 2020 2020  nd(out)).       
+0001a6d0: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
+0001a6e0: 696f 2e67 6174 6865 7228 2a63 6f72 6f73  io.gather(*coros
+0001a6f0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0001a700: 2072 6574 7572 6e5f 6578 6365 7074 696f   return_exceptio
+0001a710: 6e73 206f 7220 6669 7273 745f 6578 6365  ns or first_exce
+0001a720: 7074 696f 6e20 6973 204e 6f6e 653a 0a20  ption is None:. 
+0001a730: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001a740: 6574 7572 6e20 6361 7374 284c 6973 745b  eturn cast(List[
+0001a750: 4f75 7470 7574 5d2c 2069 6e70 7574 7329  Output], inputs)
+0001a760: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0001a770: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001a780: 2020 2072 6169 7365 2066 6972 7374 5f65     raise first_e
+0001a790: 7863 6570 7469 6f6e 0a0a 2020 2020 6465  xception..    de
+0001a7a0: 6620 5f74 7261 6e73 666f 726d 280a 2020  f _transform(.  
+0001a7b0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+0001a7c0: 2020 2020 696e 7075 743a 2049 7465 7261      input: Itera
+0001a7d0: 746f 725b 496e 7075 745d 2c0a 2020 2020  tor[Input],.    
+0001a7e0: 2020 2020 7275 6e5f 6d61 6e61 6765 723a      run_manager:
+0001a7f0: 2043 616c 6c62 6163 6b4d 616e 6167 6572   CallbackManager
+0001a800: 466f 7243 6861 696e 5275 6e2c 0a20 2020  ForChainRun,.   
+0001a810: 2020 2020 2063 6f6e 6669 673a 2052 756e       config: Run
+0001a820: 6e61 626c 6543 6f6e 6669 672c 0a20 2020  nableConfig,.   
+0001a830: 2029 202d 3e20 4974 6572 6174 6f72 5b4f   ) -> Iterator[O
+0001a840: 7574 7075 745d 3a0a 2020 2020 2020 2020  utput]:.        
+0001a850: 6672 6f6d 206c 616e 6763 6861 696e 5f63  from langchain_c
+0001a860: 6f72 652e 6265 7461 2e72 756e 6e61 626c  ore.beta.runnabl
+0001a870: 6573 2e63 6f6e 7465 7874 2069 6d70 6f72  es.context impor
+0001a880: 7420 636f 6e66 6967 5f77 6974 685f 636f  t config_with_co
+0001a890: 6e74 6578 740a 0a20 2020 2020 2020 2073  ntext..        s
+0001a8a0: 7465 7073 203d 205b 7365 6c66 2e66 6972  teps = [self.fir
+0001a8b0: 7374 5d20 2b20 7365 6c66 2e6d 6964 646c  st] + self.middl
+0001a8c0: 6520 2b20 5b73 656c 662e 6c61 7374 5d0a  e + [self.last].
+0001a8d0: 2020 2020 2020 2020 636f 6e66 6967 203d          config =
+0001a8e0: 2063 6f6e 6669 675f 7769 7468 5f63 6f6e   config_with_con
+0001a8f0: 7465 7874 2863 6f6e 6669 672c 2073 656c  text(config, sel
+0001a900: 662e 7374 6570 7329 0a0a 2020 2020 2020  f.steps)..      
+0001a910: 2020 2320 7472 616e 7366 6f72 6d20 7468    # transform th
+0001a920: 6520 696e 7075 7420 7374 7265 616d 206f  e input stream o
+0001a930: 6620 6561 6368 2073 7465 7020 7769 7468  f each step with
+0001a940: 2074 6865 206e 6578 740a 2020 2020 2020   the next.      
+0001a950: 2020 2320 7374 6570 7320 7468 6174 2064    # steps that d
+0001a960: 6f6e 2774 206e 6174 6976 656c 7920 7375  on't natively su
+0001a970: 7070 6f72 7420 7472 616e 7366 6f72 6d69  pport transformi
+0001a980: 6e67 2061 6e20 696e 7075 7420 7374 7265  ng an input stre
+0001a990: 616d 2077 696c 6c0a 2020 2020 2020 2020  am will.        
+0001a9a0: 2320 6275 6666 6572 2069 6e70 7574 2069  # buffer input i
+0001a9b0: 6e20 6d65 6d6f 7279 2075 6e74 696c 2061  n memory until a
+0001a9c0: 6c6c 2061 7661 696c 6162 6c65 2c20 616e  ll available, an
+0001a9d0: 6420 7468 656e 2073 7461 7274 2065 6d69  d then start emi
+0001a9e0: 7474 696e 6720 6f75 7470 7574 0a20 2020  tting output.   
+0001a9f0: 2020 2020 2066 696e 616c 5f70 6970 656c       final_pipel
+0001aa00: 696e 6520 3d20 6361 7374 2849 7465 7261  ine = cast(Itera
+0001aa10: 746f 725b 4f75 7470 7574 5d2c 2069 6e70  tor[Output], inp
+0001aa20: 7574 290a 2020 2020 2020 2020 666f 7220  ut).        for 
+0001aa30: 7374 6570 2069 6e20 7374 6570 733a 0a20  step in steps:. 
+0001aa40: 2020 2020 2020 2020 2020 2066 696e 616c             final
+0001aa50: 5f70 6970 656c 696e 6520 3d20 7374 6570  _pipeline = step
+0001aa60: 2e74 7261 6e73 666f 726d 280a 2020 2020  .transform(.    
+0001aa70: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
+0001aa80: 6c5f 7069 7065 6c69 6e65 2c0a 2020 2020  l_pipeline,.    
+0001aa90: 2020 2020 2020 2020 2020 2020 7061 7463              patc
+0001aaa0: 685f 636f 6e66 6967 280a 2020 2020 2020  h_config(.      
+0001aab0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0001aac0: 6e66 6967 2c0a 2020 2020 2020 2020 2020  nfig,.          
+0001aad0: 2020 2020 2020 2020 2020 6361 6c6c 6261            callba
+0001aae0: 636b 733d 7275 6e5f 6d61 6e61 6765 722e  cks=run_manager.
+0001aaf0: 6765 745f 6368 696c 6428 6622 7365 713a  get_child(f"seq:
+0001ab00: 7374 6570 3a7b 7374 6570 732e 696e 6465  step:{steps.inde
+0001ab10: 7828 7374 6570 292b 317d 2229 2c0a 2020  x(step)+1}"),.  
+0001ab20: 2020 2020 2020 2020 2020 2020 2020 292c                ),
+0001ab30: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+0001ab40: 2020 2020 2020 2020 666f 7220 6f75 7470          for outp
+0001ab50: 7574 2069 6e20 6669 6e61 6c5f 7069 7065  ut in final_pipe
+0001ab60: 6c69 6e65 3a0a 2020 2020 2020 2020 2020  line:.          
+0001ab70: 2020 7969 656c 6420 6f75 7470 7574 0a0a    yield output..
+0001ab80: 2020 2020 6173 796e 6320 6465 6620 5f61      async def _a
+0001ab90: 7472 616e 7366 6f72 6d28 0a20 2020 2020  transform(.     
+0001aba0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+0001abb0: 2069 6e70 7574 3a20 4173 796e 6349 7465   input: AsyncIte
+0001abc0: 7261 746f 725b 496e 7075 745d 2c0a 2020  rator[Input],.  
+0001abd0: 2020 2020 2020 7275 6e5f 6d61 6e61 6765        run_manage
+0001abe0: 723a 2041 7379 6e63 4361 6c6c 6261 636b  r: AsyncCallback
+0001abf0: 4d61 6e61 6765 7246 6f72 4368 6169 6e52  ManagerForChainR
+0001ac00: 756e 2c0a 2020 2020 2020 2020 636f 6e66  un,.        conf
+0001ac10: 6967 3a20 5275 6e6e 6162 6c65 436f 6e66  ig: RunnableConf
+0001ac20: 6967 2c0a 2020 2020 2920 2d3e 2041 7379  ig,.    ) -> Asy
+0001ac30: 6e63 4974 6572 6174 6f72 5b4f 7574 7075  ncIterator[Outpu
+0001ac40: 745d 3a0a 2020 2020 2020 2020 6672 6f6d  t]:.        from
+0001ac50: 206c 616e 6763 6861 696e 5f63 6f72 652e   langchain_core.
+0001ac60: 6265 7461 2e72 756e 6e61 626c 6573 2e63  beta.runnables.c
+0001ac70: 6f6e 7465 7874 2069 6d70 6f72 7420 6163  ontext import ac
+0001ac80: 6f6e 6669 675f 7769 7468 5f63 6f6e 7465  onfig_with_conte
+0001ac90: 7874 0a0a 2020 2020 2020 2020 7374 6570  xt..        step
+0001aca0: 7320 3d20 5b73 656c 662e 6669 7273 745d  s = [self.first]
+0001acb0: 202b 2073 656c 662e 6d69 6464 6c65 202b   + self.middle +
+0001acc0: 205b 7365 6c66 2e6c 6173 745d 0a20 2020   [self.last].   
+0001acd0: 2020 2020 2063 6f6e 6669 6720 3d20 6163       config = ac
+0001ace0: 6f6e 6669 675f 7769 7468 5f63 6f6e 7465  onfig_with_conte
+0001acf0: 7874 2863 6f6e 6669 672c 2073 656c 662e  xt(config, self.
+0001ad00: 7374 6570 7329 0a0a 2020 2020 2020 2020  steps)..        
+0001ad10: 2320 7374 7265 616d 2074 6865 206c 6173  # stream the las
+0001ad20: 7420 7374 6570 730a 2020 2020 2020 2020  t steps.        
+0001ad30: 2320 7472 616e 7366 6f72 6d20 7468 6520  # transform the 
+0001ad40: 696e 7075 7420 7374 7265 616d 206f 6620  input stream of 
+0001ad50: 6561 6368 2073 7465 7020 7769 7468 2074  each step with t
+0001ad60: 6865 206e 6578 740a 2020 2020 2020 2020  he next.        
+0001ad70: 2320 7374 6570 7320 7468 6174 2064 6f6e  # steps that don
+0001ad80: 2774 206e 6174 6976 656c 7920 7375 7070  't natively supp
+0001ad90: 6f72 7420 7472 616e 7366 6f72 6d69 6e67  ort transforming
+0001ada0: 2061 6e20 696e 7075 7420 7374 7265 616d   an input stream
+0001adb0: 2077 696c 6c0a 2020 2020 2020 2020 2320   will.        # 
+0001adc0: 6275 6666 6572 2069 6e70 7574 2069 6e20  buffer input in 
+0001add0: 6d65 6d6f 7279 2075 6e74 696c 2061 6c6c  memory until all
+0001ade0: 2061 7661 696c 6162 6c65 2c20 616e 6420   available, and 
+0001adf0: 7468 656e 2073 7461 7274 2065 6d69 7474  then start emitt
+0001ae00: 696e 6720 6f75 7470 7574 0a20 2020 2020  ing output.     
+0001ae10: 2020 2066 696e 616c 5f70 6970 656c 696e     final_pipelin
+0001ae20: 6520 3d20 6361 7374 2841 7379 6e63 4974  e = cast(AsyncIt
+0001ae30: 6572 6174 6f72 5b4f 7574 7075 745d 2c20  erator[Output], 
+0001ae40: 696e 7075 7429 0a20 2020 2020 2020 2066  input).        f
+0001ae50: 6f72 2073 7465 7020 696e 2073 7465 7073  or step in steps
+0001ae60: 3a0a 2020 2020 2020 2020 2020 2020 6669  :.            fi
+0001ae70: 6e61 6c5f 7069 7065 6c69 6e65 203d 2073  nal_pipeline = s
+0001ae80: 7465 702e 6174 7261 6e73 666f 726d 280a  tep.atransform(.
+0001ae90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aea0: 6669 6e61 6c5f 7069 7065 6c69 6e65 2c0a  final_pipeline,.
+0001aeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aec0: 7061 7463 685f 636f 6e66 6967 280a 2020  patch_config(.  
+0001aed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aee0: 2020 636f 6e66 6967 2c0a 2020 2020 2020    config,.      
+0001aef0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+0001af00: 6c6c 6261 636b 733d 7275 6e5f 6d61 6e61  llbacks=run_mana
+0001af10: 6765 722e 6765 745f 6368 696c 6428 6622  ger.get_child(f"
+0001af20: 7365 713a 7374 6570 3a7b 7374 6570 732e  seq:step:{steps.
+0001af30: 696e 6465 7828 7374 6570 292b 317d 2229  index(step)+1}")
+0001af40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001af50: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
+0001af60: 2029 0a20 2020 2020 2020 2061 7379 6e63   ).        async
+0001af70: 2066 6f72 206f 7574 7075 7420 696e 2066   for output in f
+0001af80: 696e 616c 5f70 6970 656c 696e 653a 0a20  inal_pipeline:. 
+0001af90: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
+0001afa0: 206f 7574 7075 740a 0a20 2020 2064 6566   output..    def
+0001afb0: 2074 7261 6e73 666f 726d 280a 2020 2020   transform(.    
+0001afc0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+0001afd0: 2020 696e 7075 743a 2049 7465 7261 746f    input: Iterato
+0001afe0: 725b 496e 7075 745d 2c0a 2020 2020 2020  r[Input],.      
+0001aff0: 2020 636f 6e66 6967 3a20 4f70 7469 6f6e    config: Option
+0001b000: 616c 5b52 756e 6e61 626c 6543 6f6e 6669  al[RunnableConfi
+0001b010: 675d 203d 204e 6f6e 652c 0a20 2020 2020  g] = None,.     
+0001b020: 2020 202a 2a6b 7761 7267 733a 204f 7074     **kwargs: Opt
+0001b030: 696f 6e61 6c5b 416e 795d 2c0a 2020 2020  ional[Any],.    
+0001b040: 2920 2d3e 2049 7465 7261 746f 725b 4f75  ) -> Iterator[Ou
+0001b050: 7470 7574 5d3a 0a20 2020 2020 2020 2079  tput]:.        y
+0001b060: 6965 6c64 2066 726f 6d20 7365 6c66 2e5f  ield from self._
+0001b070: 7472 616e 7366 6f72 6d5f 7374 7265 616d  transform_stream
+0001b080: 5f77 6974 685f 636f 6e66 6967 280a 2020  _with_config(.  
+0001b090: 2020 2020 2020 2020 2020 696e 7075 742c            input,
+0001b0a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001b0b0: 662e 5f74 7261 6e73 666f 726d 2c0a 2020  f._transform,.  
+0001b0c0: 2020 2020 2020 2020 2020 7061 7463 685f            patch_
+0001b0d0: 636f 6e66 6967 2863 6f6e 6669 672c 2072  config(config, r
+0001b0e0: 756e 5f6e 616d 653d 2863 6f6e 6669 6720  un_name=(config 
+0001b0f0: 6f72 207b 7d29 2e67 6574 2822 7275 6e5f  or {}).get("run_
+0001b100: 6e61 6d65 2229 206f 7220 7365 6c66 2e6e  name") or self.n
+0001b110: 616d 6529 2c0a 2020 2020 2020 2020 2020  ame),.          
+0001b120: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
+0001b130: 2020 2020 290a 0a20 2020 2064 6566 2073      )..    def s
+0001b140: 7472 6561 6d28 0a20 2020 2020 2020 2073  tream(.        s
+0001b150: 656c 662c 0a20 2020 2020 2020 2069 6e70  elf,.        inp
+0001b160: 7574 3a20 496e 7075 742c 0a20 2020 2020  ut: Input,.     
+0001b170: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
+0001b180: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
+0001b190: 6967 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ig] = None,.    
+0001b1a0: 2020 2020 2a2a 6b77 6172 6773 3a20 4f70      **kwargs: Op
+0001b1b0: 7469 6f6e 616c 5b41 6e79 5d2c 0a20 2020  tional[Any],.   
+0001b1c0: 2029 202d 3e20 4974 6572 6174 6f72 5b4f   ) -> Iterator[O
+0001b1d0: 7574 7075 745d 3a0a 2020 2020 2020 2020  utput]:.        
+0001b1e0: 7969 656c 6420 6672 6f6d 2073 656c 662e  yield from self.
+0001b1f0: 7472 616e 7366 6f72 6d28 6974 6572 285b  transform(iter([
+0001b200: 696e 7075 745d 292c 2063 6f6e 6669 672c  input]), config,
+0001b210: 202a 2a6b 7761 7267 7329 0a0a 2020 2020   **kwargs)..    
+0001b220: 6173 796e 6320 6465 6620 6174 7261 6e73  async def atrans
+0001b230: 666f 726d 280a 2020 2020 2020 2020 7365  form(.        se
+0001b240: 6c66 2c0a 2020 2020 2020 2020 696e 7075  lf,.        inpu
+0001b250: 743a 2041 7379 6e63 4974 6572 6174 6f72  t: AsyncIterator
+0001b260: 5b49 6e70 7574 5d2c 0a20 2020 2020 2020  [Input],.       
+0001b270: 2063 6f6e 6669 673a 204f 7074 696f 6e61   config: Optiona
+0001b280: 6c5b 5275 6e6e 6162 6c65 436f 6e66 6967  l[RunnableConfig
+0001b290: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0001b2a0: 2020 2a2a 6b77 6172 6773 3a20 4f70 7469    **kwargs: Opti
+0001b2b0: 6f6e 616c 5b41 6e79 5d2c 0a20 2020 2029  onal[Any],.    )
+0001b2c0: 202d 3e20 4173 796e 6349 7465 7261 746f   -> AsyncIterato
+0001b2d0: 725b 4f75 7470 7574 5d3a 0a20 2020 2020  r[Output]:.     
+0001b2e0: 2020 2061 7379 6e63 2066 6f72 2063 6875     async for chu
+0001b2f0: 6e6b 2069 6e20 7365 6c66 2e5f 6174 7261  nk in self._atra
+0001b300: 6e73 666f 726d 5f73 7472 6561 6d5f 7769  nsform_stream_wi
+0001b310: 7468 5f63 6f6e 6669 6728 0a20 2020 2020  th_config(.     
+0001b320: 2020 2020 2020 2069 6e70 7574 2c0a 2020         input,.  
+0001b330: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+0001b340: 6174 7261 6e73 666f 726d 2c0a 2020 2020  atransform,.    
+0001b350: 2020 2020 2020 2020 7061 7463 685f 636f          patch_co
+0001b360: 6e66 6967 2863 6f6e 6669 672c 2072 756e  nfig(config, run
+0001b370: 5f6e 616d 653d 2863 6f6e 6669 6720 6f72  _name=(config or
+0001b380: 207b 7d29 2e67 6574 2822 7275 6e5f 6e61   {}).get("run_na
+0001b390: 6d65 2229 206f 7220 7365 6c66 2e6e 616d  me") or self.nam
+0001b3a0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+0001b3b0: 2a2a 6b77 6172 6773 2c0a 2020 2020 2020  **kwargs,.      
+0001b3c0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+0001b3d0: 2079 6965 6c64 2063 6875 6e6b 0a0a 2020   yield chunk..  
+0001b3e0: 2020 6173 796e 6320 6465 6620 6173 7472    async def astr
+0001b3f0: 6561 6d28 0a20 2020 2020 2020 2073 656c  eam(.        sel
+0001b400: 662c 0a20 2020 2020 2020 2069 6e70 7574  f,.        input
+0001b410: 3a20 496e 7075 742c 0a20 2020 2020 2020  : Input,.       
+0001b420: 2063 6f6e 6669 673a 204f 7074 696f 6e61   config: Optiona
+0001b430: 6c5b 5275 6e6e 6162 6c65 436f 6e66 6967  l[RunnableConfig
+0001b440: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0001b450: 2020 2a2a 6b77 6172 6773 3a20 4f70 7469    **kwargs: Opti
+0001b460: 6f6e 616c 5b41 6e79 5d2c 0a20 2020 2029  onal[Any],.    )
+0001b470: 202d 3e20 4173 796e 6349 7465 7261 746f   -> AsyncIterato
+0001b480: 725b 4f75 7470 7574 5d3a 0a20 2020 2020  r[Output]:.     
+0001b490: 2020 2061 7379 6e63 2064 6566 2069 6e70     async def inp
+0001b4a0: 7574 5f61 6974 6572 2829 202d 3e20 4173  ut_aiter() -> As
+0001b4b0: 796e 6349 7465 7261 746f 725b 496e 7075  yncIterator[Inpu
+0001b4c0: 745d 3a0a 2020 2020 2020 2020 2020 2020  t]:.            
+0001b4d0: 7969 656c 6420 696e 7075 740a 0a20 2020  yield input..   
+0001b4e0: 2020 2020 2061 7379 6e63 2066 6f72 2063       async for c
+0001b4f0: 6875 6e6b 2069 6e20 7365 6c66 2e61 7472  hunk in self.atr
+0001b500: 616e 7366 6f72 6d28 696e 7075 745f 6169  ansform(input_ai
+0001b510: 7465 7228 292c 2063 6f6e 6669 672c 202a  ter(), config, *
+0001b520: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+0001b530: 2020 2020 2020 7969 656c 6420 6368 756e        yield chun
+0001b540: 6b0a 0a0a 636c 6173 7320 5275 6e6e 6162  k...class Runnab
+0001b550: 6c65 5061 7261 6c6c 656c 2852 756e 6e61  leParallel(Runna
+0001b560: 626c 6553 6572 6961 6c69 7a61 626c 655b  bleSerializable[
+0001b570: 496e 7075 742c 2044 6963 745b 7374 722c  Input, Dict[str,
+0001b580: 2041 6e79 5d5d 293a 0a20 2020 2022 2222   Any]]):.    """
+0001b590: 5275 6e6e 6162 6c65 2074 6861 7420 7275  Runnable that ru
+0001b5a0: 6e73 2061 206d 6170 7069 6e67 206f 6620  ns a mapping of 
+0001b5b0: 5275 6e6e 6162 6c65 7320 696e 2070 6172  Runnables in par
+0001b5c0: 616c 6c65 6c2c 2061 6e64 2072 6574 7572  allel, and retur
+0001b5d0: 6e73 2061 206d 6170 7069 6e67 0a20 2020  ns a mapping.   
+0001b5e0: 206f 6620 7468 6569 7220 6f75 7470 7574   of their output
+0001b5f0: 732e 0a0a 2020 2020 5275 6e6e 6162 6c65  s...    Runnable
+0001b600: 5061 7261 6c6c 656c 2069 7320 6f6e 6520  Parallel is one 
+0001b610: 6f66 2074 6865 2074 776f 206d 6169 6e20  of the two main 
+0001b620: 636f 6d70 6f73 6974 696f 6e20 7072 696d  composition prim
+0001b630: 6974 6976 6573 2066 6f72 2074 6865 204c  itives for the L
+0001b640: 4345 4c2c 0a20 2020 2061 6c6f 6e67 7369  CEL,.    alongsi
+0001b650: 6465 2052 756e 6e61 626c 6553 6571 7565  de RunnableSeque
+0001b660: 6e63 652e 2049 7420 696e 766f 6b65 7320  nce. It invokes 
+0001b670: 5275 6e6e 6162 6c65 7320 636f 6e63 7572  Runnables concur
+0001b680: 7265 6e74 6c79 2c20 7072 6f76 6964 696e  rently, providin
+0001b690: 6720 7468 6520 7361 6d65 0a20 2020 2069  g the same.    i
+0001b6a0: 6e70 7574 2074 6f20 6561 6368 2e0a 0a20  nput to each... 
+0001b6b0: 2020 2041 2052 756e 6e61 626c 6550 6172     A RunnablePar
+0001b6c0: 616c 6c65 6c20 6361 6e20 6265 2069 6e73  allel can be ins
+0001b6d0: 7461 6e74 6961 7465 6420 6469 7265 6374  tantiated direct
+0001b6e0: 6c79 206f 7220 6279 2075 7369 6e67 2061  ly or by using a
+0001b6f0: 2064 6963 7420 6c69 7465 7261 6c20 7769   dict literal wi
+0001b700: 7468 696e 2061 0a20 2020 2073 6571 7565  thin a.    seque
+0001b710: 6e63 652e 0a0a 2020 2020 4865 7265 2069  nce...    Here i
+0001b720: 7320 6120 7369 6d70 6c65 2065 7861 6d70  s a simple examp
+0001b730: 6c65 2074 6861 7420 7573 6573 2066 756e  le that uses fun
+0001b740: 6374 696f 6e73 2074 6f20 696c 6c75 7374  ctions to illust
+0001b750: 7261 7465 2074 6865 2075 7365 206f 660a  rate the use of.
+0001b760: 2020 2020 5275 6e6e 6162 6c65 5061 7261      RunnablePara
+0001b770: 6c6c 656c 3a0a 0a20 2020 2020 2020 202e  llel:..        .
+0001b780: 2e20 636f 6465 2d62 6c6f 636b 3a3a 2070  . code-block:: p
+0001b790: 7974 686f 6e0a 0a20 2020 2020 2020 2020  ython..         
+0001b7a0: 2020 2066 726f 6d20 6c61 6e67 6368 6169     from langchai
+0001b7b0: 6e5f 636f 7265 2e72 756e 6e61 626c 6573  n_core.runnables
+0001b7c0: 2069 6d70 6f72 7420 5275 6e6e 6162 6c65   import Runnable
+0001b7d0: 4c61 6d62 6461 0a0a 2020 2020 2020 2020  Lambda..        
+0001b7e0: 2020 2020 6465 6620 6164 645f 6f6e 6528      def add_one(
+0001b7f0: 783a 2069 6e74 2920 2d3e 2069 6e74 3a0a  x: int) -> int:.
+0001b800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b810: 7265 7475 726e 2078 202b 2031 0a0a 2020  return x + 1..  
+0001b820: 2020 2020 2020 2020 2020 6465 6620 6d75            def mu
+0001b830: 6c5f 7477 6f28 783a 2069 6e74 2920 2d3e  l_two(x: int) ->
+0001b840: 2069 6e74 3a0a 2020 2020 2020 2020 2020   int:.          
+0001b850: 2020 2020 2020 7265 7475 726e 2078 202a        return x *
+0001b860: 2032 0a0a 2020 2020 2020 2020 2020 2020   2..            
+0001b870: 6465 6620 6d75 6c5f 7468 7265 6528 783a  def mul_three(x:
+0001b880: 2069 6e74 2920 2d3e 2069 6e74 3a0a 2020   int) -> int:.  
+0001b890: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001b8a0: 7475 726e 2078 202a 2033 0a0a 2020 2020  turn x * 3..    
+0001b8b0: 2020 2020 2020 2020 7275 6e6e 6162 6c65          runnable
+0001b8c0: 5f31 203d 2052 756e 6e61 626c 654c 616d  _1 = RunnableLam
+0001b8d0: 6264 6128 6164 645f 6f6e 6529 0a20 2020  bda(add_one).   
+0001b8e0: 2020 2020 2020 2020 2072 756e 6e61 626c           runnabl
+0001b8f0: 655f 3220 3d20 5275 6e6e 6162 6c65 4c61  e_2 = RunnableLa
+0001b900: 6d62 6461 286d 756c 5f74 776f 290a 2020  mbda(mul_two).  
+0001b910: 2020 2020 2020 2020 2020 7275 6e6e 6162            runnab
+0001b920: 6c65 5f33 203d 2052 756e 6e61 626c 654c  le_3 = RunnableL
+0001b930: 616d 6264 6128 6d75 6c5f 7468 7265 6529  ambda(mul_three)
+0001b940: 0a0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+0001b950: 7175 656e 6365 203d 2072 756e 6e61 626c  quence = runnabl
+0001b960: 655f 3120 7c20 7b20 2023 2074 6869 7320  e_1 | {  # this 
+0001b970: 6469 6374 2069 7320 636f 6572 6365 6420  dict is coerced 
+0001b980: 746f 2061 2052 756e 6e61 626c 6550 6172  to a RunnablePar
+0001b990: 616c 6c65 6c0a 2020 2020 2020 2020 2020  allel.          
+0001b9a0: 2020 2020 2020 226d 756c 5f74 776f 223a        "mul_two":
+0001b9b0: 2072 756e 6e61 626c 655f 322c 0a20 2020   runnable_2,.   
+0001b9c0: 2020 2020 2020 2020 2020 2020 2022 6d75               "mu
+0001b9d0: 6c5f 7468 7265 6522 3a20 7275 6e6e 6162  l_three": runnab
+0001b9e0: 6c65 5f33 2c0a 2020 2020 2020 2020 2020  le_3,.          
+0001b9f0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0001ba00: 2320 4f72 2065 7175 6976 616c 656e 746c  # Or equivalentl
+0001ba10: 793a 0a20 2020 2020 2020 2020 2020 2023  y:.            #
+0001ba20: 2073 6571 7565 6e63 6520 3d20 7275 6e6e   sequence = runn
+0001ba30: 6162 6c65 5f31 207c 2052 756e 6e61 626c  able_1 | Runnabl
+0001ba40: 6550 6172 616c 6c65 6c28 0a20 2020 2020  eParallel(.     
+0001ba50: 2020 2020 2020 2023 2020 2020 207b 226d         #     {"m
+0001ba60: 756c 5f74 776f 223a 2072 756e 6e61 626c  ul_two": runnabl
+0001ba70: 655f 322c 2022 6d75 6c5f 7468 7265 6522  e_2, "mul_three"
+0001ba80: 3a20 7275 6e6e 6162 6c65 5f33 7d0a 2020  : runnable_3}.  
+0001ba90: 2020 2020 2020 2020 2020 2320 290a 2020            # ).  
+0001baa0: 2020 2020 2020 2020 2020 2320 416c 736f            # Also
+0001bab0: 2065 7175 6976 616c 656e 746c 793a 0a20   equivalently:. 
+0001bac0: 2020 2020 2020 2020 2020 2023 2073 6571             # seq
+0001bad0: 7565 6e63 6520 3d20 7275 6e6e 6162 6c65  uence = runnable
+0001bae0: 5f31 207c 2052 756e 6e61 626c 6550 6172  _1 | RunnablePar
+0001baf0: 616c 6c65 6c28 0a20 2020 2020 2020 2020  allel(.         
+0001bb00: 2020 2023 2020 2020 206d 756c 5f74 776f     #     mul_two
+0001bb10: 3d72 756e 6e61 626c 655f 322c 0a20 2020  =runnable_2,.   
+0001bb20: 2020 2020 2020 2020 2023 2020 2020 206d           #     m
+0001bb30: 756c 5f74 6872 6565 3d72 756e 6e61 626c  ul_three=runnabl
+0001bb40: 655f 332c 0a20 2020 2020 2020 2020 2020  e_3,.           
+0001bb50: 2023 2029 0a0a 2020 2020 2020 2020 2020   # )..          
+0001bb60: 2020 7365 7175 656e 6365 2e69 6e76 6f6b    sequence.invok
+0001bb70: 6528 3129 0a20 2020 2020 2020 2020 2020  e(1).           
+0001bb80: 2061 7761 6974 2073 6571 7565 6e63 652e   await sequence.
+0001bb90: 6169 6e76 6f6b 6528 3129 0a0a 2020 2020  ainvoke(1)..    
+0001bba0: 2020 2020 2020 2020 7365 7175 656e 6365          sequence
+0001bbb0: 2e62 6174 6368 285b 312c 2032 2c20 335d  .batch([1, 2, 3]
+0001bbc0: 290a 2020 2020 2020 2020 2020 2020 6177  ).            aw
+0001bbd0: 6169 7420 7365 7175 656e 6365 2e61 6261  ait sequence.aba
+0001bbe0: 7463 6828 5b31 2c20 322c 2033 5d29 0a0a  tch([1, 2, 3])..
+0001bbf0: 2020 2020 5275 6e6e 6162 6c65 5061 7261      RunnablePara
+0001bc00: 6c6c 656c 206d 616b 6573 2069 7420 6561  llel makes it ea
+0001bc10: 7379 2074 6f20 7275 6e20 5275 6e6e 6162  sy to run Runnab
+0001bc20: 6c65 7320 696e 2070 6172 616c 6c65 6c2e  les in parallel.
+0001bc30: 2049 6e20 7468 6520 6265 6c6f 7720 6578   In the below ex
+0001bc40: 616d 706c 652c 0a20 2020 2077 6520 7369  ample,.    we si
+0001bc50: 6d75 6c74 616e 656f 7573 6c79 2073 7472  multaneously str
+0001bc60: 6561 6d20 6f75 7470 7574 2066 726f 6d20  eam output from 
+0001bc70: 7477 6f20 6469 6666 6572 656e 7420 5275  two different Ru
+0001bc80: 6e6e 6162 6c65 733a 0a0a 2020 2020 2020  nnables:..      
+0001bc90: 2020 2e2e 2063 6f64 652d 626c 6f63 6b3a    .. code-block:
+0001bca0: 3a20 7079 7468 6f6e 0a0a 2020 2020 2020  : python..      
+0001bcb0: 2020 2020 2020 6672 6f6d 206c 616e 6763        from langc
+0001bcc0: 6861 696e 5f63 6f72 652e 7072 6f6d 7074  hain_core.prompt
+0001bcd0: 7320 696d 706f 7274 2043 6861 7450 726f  s import ChatPro
+0001bce0: 6d70 7454 656d 706c 6174 650a 2020 2020  mptTemplate.    
+0001bcf0: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
+0001bd00: 6763 6861 696e 5f63 6f72 652e 7275 6e6e  gchain_core.runn
+0001bd10: 6162 6c65 7320 696d 706f 7274 2052 756e  ables import Run
+0001bd20: 6e61 626c 6550 6172 616c 6c65 6c0a 2020  nableParallel.  
+0001bd30: 2020 2020 2020 2020 2020 6672 6f6d 206c            from l
+0001bd40: 616e 6763 6861 696e 5f6f 7065 6e61 6920  angchain_openai 
+0001bd50: 696d 706f 7274 2043 6861 744f 7065 6e41  import ChatOpenA
+0001bd60: 490a 0a20 2020 2020 2020 2020 2020 206d  I..            m
+0001bd70: 6f64 656c 203d 2043 6861 744f 7065 6e41  odel = ChatOpenA
+0001bd80: 4928 290a 2020 2020 2020 2020 2020 2020  I().            
+0001bd90: 6a6f 6b65 5f63 6861 696e 203d 2028 0a20  joke_chain = (. 
+0001bda0: 2020 2020 2020 2020 2020 2020 2020 2043                 C
+0001bdb0: 6861 7450 726f 6d70 7454 656d 706c 6174  hatPromptTemplat
+0001bdc0: 652e 6672 6f6d 5f74 656d 706c 6174 6528  e.from_template(
+0001bdd0: 2274 656c 6c20 6d65 2061 206a 6f6b 6520  "tell me a joke 
+0001bde0: 6162 6f75 7420 7b74 6f70 6963 7d22 290a  about {topic}").
+0001bdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001be00: 7c20 6d6f 6465 6c0a 2020 2020 2020 2020  | model.        
+0001be10: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0001be20: 2020 706f 656d 5f63 6861 696e 203d 2028    poem_chain = (
 0001be30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001be40: 2073 656c 662e 5f69 6e76 6f6b 652c 0a20   self._invoke,. 
-0001be50: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001be60: 6e70 7574 2c0a 2020 2020 2020 2020 2020  nput,.          
-0001be70: 2020 2020 2020 7365 6c66 2e5f 636f 6e66        self._conf
-0001be80: 6967 2863 6f6e 6669 672c 2073 656c 662e  ig(config, self.
-0001be90: 6675 6e63 292c 0a20 2020 2020 2020 2020  func),.         
-0001bea0: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
-0001beb0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0001bec0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001bed0: 2020 2020 2020 2020 2072 6169 7365 2054           raise T
-0001bee0: 7970 6545 7272 6f72 280a 2020 2020 2020  ypeError(.      
-0001bef0: 2020 2020 2020 2020 2020 2243 616e 6e6f            "Canno
-0001bf00: 7420 696e 766f 6b65 2061 2063 6f72 6f75  t invoke a corou
-0001bf10: 7469 6e65 2066 756e 6374 696f 6e20 7379  tine function sy
-0001bf20: 6e63 6872 6f6e 6f75 736c 792e 220a 2020  nchronously.".  
-0001bf30: 2020 2020 2020 2020 2020 2020 2020 2255                "U
-0001bf40: 7365 2060 6169 6e76 6f6b 6560 2069 6e73  se `ainvoke` ins
-0001bf50: 7465 6164 2e22 0a20 2020 2020 2020 2020  tead.".         
-0001bf60: 2020 2029 0a0a 2020 2020 6173 796e 6320     )..    async 
-0001bf70: 6465 6620 6169 6e76 6f6b 6528 0a20 2020  def ainvoke(.   
-0001bf80: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-0001bf90: 2020 2069 6e70 7574 3a20 496e 7075 742c     input: Input,
-0001bfa0: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
-0001bfb0: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
-0001bfc0: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
-0001bfd0: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
-0001bfe0: 6773 3a20 4f70 7469 6f6e 616c 5b41 6e79  gs: Optional[Any
-0001bff0: 5d2c 0a20 2020 2029 202d 3e20 4f75 7470  ],.    ) -> Outp
-0001c000: 7574 3a0a 2020 2020 2020 2020 2222 2249  ut:.        """I
-0001c010: 6e76 6f6b 6520 7468 6973 2072 756e 6e61  nvoke this runna
-0001c020: 626c 6520 6173 796e 6368 726f 6e6f 7573  ble asynchronous
-0001c030: 6c79 2e22 2222 0a20 2020 2020 2020 2074  ly.""".        t
-0001c040: 6865 5f66 756e 6320 3d20 7365 6c66 2e61  he_func = self.a
-0001c050: 6675 6e63 2069 6620 6861 7361 7474 7228  func if hasattr(
-0001c060: 7365 6c66 2c20 2261 6675 6e63 2229 2065  self, "afunc") e
-0001c070: 6c73 6520 7365 6c66 2e66 756e 630a 2020  lse self.func.  
-0001c080: 2020 2020 2020 7265 7475 726e 2061 7761        return awa
-0001c090: 6974 2073 656c 662e 5f61 6361 6c6c 5f77  it self._acall_w
-0001c0a0: 6974 685f 636f 6e66 6967 280a 2020 2020  ith_config(.    
-0001c0b0: 2020 2020 2020 2020 7365 6c66 2e5f 6169          self._ai
-0001c0c0: 6e76 6f6b 652c 0a20 2020 2020 2020 2020  nvoke,.         
-0001c0d0: 2020 2069 6e70 7574 2c0a 2020 2020 2020     input,.      
-0001c0e0: 2020 2020 2020 7365 6c66 2e5f 636f 6e66        self._conf
-0001c0f0: 6967 2863 6f6e 6669 672c 2074 6865 5f66  ig(config, the_f
-0001c100: 756e 6329 2c0a 2020 2020 2020 2020 2020  unc),.          
-0001c110: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
-0001c120: 2020 2020 290a 0a20 2020 2064 6566 205f      )..    def _
-0001c130: 7472 616e 7366 6f72 6d28 0a20 2020 2020  transform(.     
-0001c140: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-0001c150: 2069 6e70 7574 3a20 4974 6572 6174 6f72   input: Iterator
-0001c160: 5b49 6e70 7574 5d2c 0a20 2020 2020 2020  [Input],.       
-0001c170: 2072 756e 5f6d 616e 6167 6572 3a20 4361   run_manager: Ca
-0001c180: 6c6c 6261 636b 4d61 6e61 6765 7246 6f72  llbackManagerFor
-0001c190: 4368 6169 6e52 756e 2c0a 2020 2020 2020  ChainRun,.      
-0001c1a0: 2020 636f 6e66 6967 3a20 5275 6e6e 6162    config: Runnab
-0001c1b0: 6c65 436f 6e66 6967 2c0a 2020 2020 2020  leConfig,.      
-0001c1c0: 2020 2a2a 6b77 6172 6773 3a20 416e 792c    **kwargs: Any,
-0001c1d0: 0a20 2020 2029 202d 3e20 4974 6572 6174  .    ) -> Iterat
-0001c1e0: 6f72 5b4f 7574 7075 745d 3a0a 2020 2020  or[Output]:.    
-0001c1f0: 2020 2020 6669 6e61 6c3a 204f 7074 696f      final: Optio
-0001c200: 6e61 6c5b 496e 7075 745d 203d 204e 6f6e  nal[Input] = Non
-0001c210: 650a 2020 2020 2020 2020 666f 7220 6963  e.        for ic
-0001c220: 6875 6e6b 2069 6e20 696e 7075 743a 0a20  hunk in input:. 
-0001c230: 2020 2020 2020 2020 2020 2069 6620 6669             if fi
-0001c240: 6e61 6c20 6973 204e 6f6e 653a 0a20 2020  nal is None:.   
-0001c250: 2020 2020 2020 2020 2020 2020 2066 696e               fin
-0001c260: 616c 203d 2069 6368 756e 6b0a 2020 2020  al = ichunk.    
-0001c270: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001c280: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-0001c290: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0001c2a0: 2020 2020 2020 2066 696e 616c 203d 2066         final = f
-0001c2b0: 696e 616c 202b 2069 6368 756e 6b20 2023  inal + ichunk  #
-0001c2c0: 2074 7970 653a 2069 676e 6f72 655b 6f70   type: ignore[op
-0001c2d0: 6572 6174 6f72 5d0a 2020 2020 2020 2020  erator].        
-0001c2e0: 2020 2020 2020 2020 6578 6365 7074 2054          except T
-0001c2f0: 7970 6545 7272 6f72 3a0a 2020 2020 2020  ypeError:.      
-0001c300: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0001c310: 6e61 6c20 3d20 6963 6875 6e6b 0a0a 2020  nal = ichunk..  
-0001c320: 2020 2020 2020 6966 2069 6e73 7065 6374        if inspect
-0001c330: 2e69 7367 656e 6572 6174 6f72 6675 6e63  .isgeneratorfunc
-0001c340: 7469 6f6e 2873 656c 662e 6675 6e63 293a  tion(self.func):
-0001c350: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-0001c360: 7075 743a 204f 7074 696f 6e61 6c5b 4f75  put: Optional[Ou
-0001c370: 7470 7574 5d20 3d20 4e6f 6e65 0a20 2020  tput] = None.   
-0001c380: 2020 2020 2020 2020 2066 6f72 2063 6875           for chu
-0001c390: 6e6b 2069 6e20 6361 6c6c 5f66 756e 635f  nk in call_func_
-0001c3a0: 7769 7468 5f76 6172 6961 626c 655f 6172  with_variable_ar
-0001c3b0: 6773 280a 2020 2020 2020 2020 2020 2020  gs(.            
-0001c3c0: 2020 2020 7365 6c66 2e66 756e 632c 2063      self.func, c
-0001c3d0: 6173 7428 496e 7075 742c 2066 696e 616c  ast(Input, final
-0001c3e0: 292c 2063 6f6e 6669 672c 2072 756e 5f6d  ), config, run_m
-0001c3f0: 616e 6167 6572 2c20 2a2a 6b77 6172 6773  anager, **kwargs
-0001c400: 0a20 2020 2020 2020 2020 2020 2029 3a0a  .            ):.
-0001c410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c420: 7969 656c 6420 6368 756e 6b0a 2020 2020  yield chunk.    
-0001c430: 2020 2020 2020 2020 2020 2020 6966 206f              if o
-0001c440: 7574 7075 7420 6973 204e 6f6e 653a 0a20  utput is None:. 
-0001c450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c460: 2020 206f 7574 7075 7420 3d20 6368 756e     output = chun
-0001c470: 6b0a 2020 2020 2020 2020 2020 2020 2020  k.              
-0001c480: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001c490: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-0001c4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c4b0: 2020 2020 2020 2020 206f 7574 7075 7420           output 
-0001c4c0: 3d20 6f75 7470 7574 202b 2063 6875 6e6b  = output + chunk
-0001c4d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c4e0: 2020 2020 2065 7863 6570 7420 5479 7065       except Type
-0001c4f0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-0001c500: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-0001c510: 7574 7075 7420 3d20 6368 756e 6b0a 2020  utput = chunk.  
-0001c520: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001c530: 2020 2020 2020 2020 6f75 7470 7574 203d          output =
-0001c540: 2063 616c 6c5f 6675 6e63 5f77 6974 685f   call_func_with_
-0001c550: 7661 7269 6162 6c65 5f61 7267 7328 0a20  variable_args(. 
-0001c560: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001c570: 656c 662e 6675 6e63 2c20 6361 7374 2849  elf.func, cast(I
-0001c580: 6e70 7574 2c20 6669 6e61 6c29 2c20 636f  nput, final), co
-0001c590: 6e66 6967 2c20 7275 6e5f 6d61 6e61 6765  nfig, run_manage
-0001c5a0: 722c 202a 2a6b 7761 7267 730a 2020 2020  r, **kwargs.    
-0001c5b0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0001c5c0: 2020 2023 2049 6620 7468 6520 6f75 7470     # If the outp
-0001c5d0: 7574 2069 7320 6120 7275 6e6e 6162 6c65  ut is a runnable
-0001c5e0: 2c20 7573 6520 6974 7320 7374 7265 616d  , use its stream
-0001c5f0: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
-0001c600: 6966 2069 7369 6e73 7461 6e63 6528 6f75  if isinstance(ou
-0001c610: 7470 7574 2c20 5275 6e6e 6162 6c65 293a  tput, Runnable):
-0001c620: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
-0001c630: 7572 7369 6f6e 5f6c 696d 6974 203d 2063  ursion_limit = c
-0001c640: 6f6e 6669 675b 2272 6563 7572 7369 6f6e  onfig["recursion
-0001c650: 5f6c 696d 6974 225d 0a20 2020 2020 2020  _limit"].       
-0001c660: 2020 2020 2069 6620 7265 6375 7273 696f       if recursio
-0001c670: 6e5f 6c69 6d69 7420 3c3d 2030 3a0a 2020  n_limit <= 0:.  
-0001c680: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0001c690: 6973 6520 5265 6375 7273 696f 6e45 7272  ise RecursionErr
-0001c6a0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-0001c6b0: 2020 2020 2020 2020 6622 5265 6375 7273          f"Recurs
-0001c6c0: 696f 6e20 6c69 6d69 7420 7265 6163 6865  ion limit reache
-0001c6d0: 6420 7768 656e 2069 6e76 6f6b 696e 6720  d when invoking 
-0001c6e0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0001c6f0: 2020 2020 2020 6622 7b73 656c 667d 2077        f"{self} w
-0001c700: 6974 6820 696e 7075 7420 7b66 696e 616c  ith input {final
-0001c710: 7d2e 220a 2020 2020 2020 2020 2020 2020  }.".            
-0001c720: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0001c730: 2020 666f 7220 6368 756e 6b20 696e 206f    for chunk in o
-0001c740: 7574 7075 742e 7374 7265 616d 280a 2020  utput.stream(.  
-0001c750: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0001c760: 6e61 6c2c 0a20 2020 2020 2020 2020 2020  nal,.           
-0001c770: 2020 2020 2070 6174 6368 5f63 6f6e 6669       patch_confi
-0001c780: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-0001c790: 2020 2020 2020 2063 6f6e 6669 672c 0a20         config,. 
-0001c7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c7b0: 2020 2063 616c 6c62 6163 6b73 3d72 756e     callbacks=run
-0001c7c0: 5f6d 616e 6167 6572 2e67 6574 5f63 6869  _manager.get_chi
-0001c7d0: 6c64 2829 2c0a 2020 2020 2020 2020 2020  ld(),.          
-0001c7e0: 2020 2020 2020 2020 2020 7265 6375 7273            recurs
-0001c7f0: 696f 6e5f 6c69 6d69 743d 7265 6375 7273  ion_limit=recurs
-0001c800: 696f 6e5f 6c69 6d69 7420 2d20 312c 0a20  ion_limit - 1,. 
-0001c810: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0001c820: 2c0a 2020 2020 2020 2020 2020 2020 293a  ,.            ):
-0001c830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c840: 2079 6965 6c64 2063 6875 6e6b 0a20 2020   yield chunk.   
-0001c850: 2020 2020 2065 6c69 6620 6e6f 7420 696e       elif not in
-0001c860: 7370 6563 742e 6973 6765 6e65 7261 746f  spect.isgenerato
-0001c870: 7266 756e 6374 696f 6e28 7365 6c66 2e66  rfunction(self.f
-0001c880: 756e 6329 3a0a 2020 2020 2020 2020 2020  unc):.          
-0001c890: 2020 2320 4f74 6865 7277 6973 652c 206a    # Otherwise, j
-0001c8a0: 7573 7420 7969 656c 6420 6974 0a20 2020  ust yield it.   
-0001c8b0: 2020 2020 2020 2020 2079 6965 6c64 2063           yield c
-0001c8c0: 6173 7428 4f75 7470 7574 2c20 6f75 7470  ast(Output, outp
-0001c8d0: 7574 290a 0a20 2020 2064 6566 2074 7261  ut)..    def tra
-0001c8e0: 6e73 666f 726d 280a 2020 2020 2020 2020  nsform(.        
-0001c8f0: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
-0001c900: 7075 743a 2049 7465 7261 746f 725b 496e  put: Iterator[In
-0001c910: 7075 745d 2c0a 2020 2020 2020 2020 636f  put],.        co
-0001c920: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
-0001c930: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
-0001c940: 204e 6f6e 652c 0a20 2020 2020 2020 202a   None,.        *
-0001c950: 2a6b 7761 7267 733a 204f 7074 696f 6e61  *kwargs: Optiona
-0001c960: 6c5b 416e 795d 2c0a 2020 2020 2920 2d3e  l[Any],.    ) ->
-0001c970: 2049 7465 7261 746f 725b 4f75 7470 7574   Iterator[Output
-0001c980: 5d3a 0a20 2020 2020 2020 2069 6620 6861  ]:.        if ha
-0001c990: 7361 7474 7228 7365 6c66 2c20 2266 756e  sattr(self, "fun
-0001c9a0: 6322 293a 0a20 2020 2020 2020 2020 2020  c"):.           
-0001c9b0: 2066 6f72 206f 7574 7075 7420 696e 2073   for output in s
-0001c9c0: 656c 662e 5f74 7261 6e73 666f 726d 5f73  elf._transform_s
-0001c9d0: 7472 6561 6d5f 7769 7468 5f63 6f6e 6669  tream_with_confi
-0001c9e0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-0001c9f0: 2020 2069 6e70 7574 2c0a 2020 2020 2020     input,.      
-0001ca00: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-0001ca10: 7472 616e 7366 6f72 6d2c 0a20 2020 2020  transform,.     
-0001ca20: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001ca30: 5f63 6f6e 6669 6728 636f 6e66 6967 2c20  _config(config, 
-0001ca40: 7365 6c66 2e66 756e 6329 2c0a 2020 2020  self.func),.    
-0001ca50: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
-0001ca60: 6172 6773 2c0a 2020 2020 2020 2020 2020  args,.          
-0001ca70: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-0001ca80: 2020 2020 2079 6965 6c64 206f 7574 7075       yield outpu
-0001ca90: 740a 2020 2020 2020 2020 656c 7365 3a0a  t.        else:.
-0001caa0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0001cab0: 6520 5479 7065 4572 726f 7228 0a20 2020  e TypeError(.   
-0001cac0: 2020 2020 2020 2020 2020 2020 2022 4361               "Ca
-0001cad0: 6e6e 6f74 2073 7472 6561 6d20 6120 636f  nnot stream a co
-0001cae0: 726f 7574 696e 6520 6675 6e63 7469 6f6e  routine function
-0001caf0: 2073 796e 6368 726f 6e6f 7573 6c79 2e22   synchronously."
-0001cb00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cb10: 2022 5573 6520 6061 7374 7265 616d 6020   "Use `astream` 
-0001cb20: 696e 7374 6561 642e 220a 2020 2020 2020  instead.".      
-0001cb30: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-0001cb40: 2073 7472 6561 6d28 0a20 2020 2020 2020   stream(.       
-0001cb50: 2073 656c 662c 0a20 2020 2020 2020 2069   self,.        i
-0001cb60: 6e70 7574 3a20 496e 7075 742c 0a20 2020  nput: Input,.   
-0001cb70: 2020 2020 2063 6f6e 6669 673a 204f 7074       config: Opt
-0001cb80: 696f 6e61 6c5b 5275 6e6e 6162 6c65 436f  ional[RunnableCo
-0001cb90: 6e66 6967 5d20 3d20 4e6f 6e65 2c0a 2020  nfig] = None,.  
-0001cba0: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
-0001cbb0: 4f70 7469 6f6e 616c 5b41 6e79 5d2c 0a20  Optional[Any],. 
-0001cbc0: 2020 2029 202d 3e20 4974 6572 6174 6f72     ) -> Iterator
-0001cbd0: 5b4f 7574 7075 745d 3a0a 2020 2020 2020  [Output]:.      
-0001cbe0: 2020 7265 7475 726e 2073 656c 662e 7472    return self.tr
-0001cbf0: 616e 7366 6f72 6d28 6974 6572 285b 696e  ansform(iter([in
-0001cc00: 7075 745d 292c 2063 6f6e 6669 672c 202a  put]), config, *
-0001cc10: 2a6b 7761 7267 7329 0a0a 2020 2020 6173  *kwargs)..    as
-0001cc20: 796e 6320 6465 6620 5f61 7472 616e 7366  ync def _atransf
-0001cc30: 6f72 6d28 0a20 2020 2020 2020 2073 656c  orm(.        sel
-0001cc40: 662c 0a20 2020 2020 2020 2069 6e70 7574  f,.        input
-0001cc50: 3a20 4173 796e 6349 7465 7261 746f 725b  : AsyncIterator[
-0001cc60: 496e 7075 745d 2c0a 2020 2020 2020 2020  Input],.        
-0001cc70: 7275 6e5f 6d61 6e61 6765 723a 2041 7379  run_manager: Asy
-0001cc80: 6e63 4361 6c6c 6261 636b 4d61 6e61 6765  ncCallbackManage
-0001cc90: 7246 6f72 4368 6169 6e52 756e 2c0a 2020  rForChainRun,.  
-0001cca0: 2020 2020 2020 636f 6e66 6967 3a20 5275        config: Ru
-0001ccb0: 6e6e 6162 6c65 436f 6e66 6967 2c0a 2020  nnableConfig,.  
-0001ccc0: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
-0001ccd0: 416e 792c 0a20 2020 2029 202d 3e20 4173  Any,.    ) -> As
-0001cce0: 796e 6349 7465 7261 746f 725b 4f75 7470  yncIterator[Outp
-0001ccf0: 7574 5d3a 0a20 2020 2020 2020 2066 696e  ut]:.        fin
-0001cd00: 616c 3a20 4f70 7469 6f6e 616c 5b49 6e70  al: Optional[Inp
-0001cd10: 7574 5d20 3d20 4e6f 6e65 0a20 2020 2020  ut] = None.     
-0001cd20: 2020 2061 7379 6e63 2066 6f72 2069 6368     async for ich
-0001cd30: 756e 6b20 696e 2069 6e70 7574 3a0a 2020  unk in input:.  
-0001cd40: 2020 2020 2020 2020 2020 6966 2066 696e            if fin
-0001cd50: 616c 2069 7320 4e6f 6e65 3a0a 2020 2020  al is None:.    
-0001cd60: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
-0001cd70: 6c20 3d20 6963 6875 6e6b 0a20 2020 2020  l = ichunk.     
-0001cd80: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001cd90: 2020 2020 2020 2020 2020 2020 2074 7279               try
-0001cda0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001cdb0: 2020 2020 2020 6669 6e61 6c20 3d20 6669        final = fi
-0001cdc0: 6e61 6c20 2b20 6963 6875 6e6b 2020 2320  nal + ichunk  # 
-0001cdd0: 7479 7065 3a20 6967 6e6f 7265 5b6f 7065  type: ignore[ope
-0001cde0: 7261 746f 725d 0a20 2020 2020 2020 2020  rator].         
-0001cdf0: 2020 2020 2020 2065 7863 6570 7420 5479         except Ty
-0001ce00: 7065 4572 726f 723a 0a20 2020 2020 2020  peError:.       
-0001ce10: 2020 2020 2020 2020 2020 2020 2066 696e               fin
-0001ce20: 616c 203d 2069 6368 756e 6b0a 0a20 2020  al = ichunk..   
-0001ce30: 2020 2020 2069 6620 6861 7361 7474 7228       if hasattr(
-0001ce40: 7365 6c66 2c20 2261 6675 6e63 2229 3a0a  self, "afunc"):.
-0001ce50: 2020 2020 2020 2020 2020 2020 6166 756e              afun
-0001ce60: 6320 3d20 7365 6c66 2e61 6675 6e63 0a20  c = self.afunc. 
-0001ce70: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001ce80: 2020 2020 2020 2020 2069 6620 696e 7370           if insp
-0001ce90: 6563 742e 6973 6765 6e65 7261 746f 7266  ect.isgeneratorf
-0001cea0: 756e 6374 696f 6e28 7365 6c66 2e66 756e  unction(self.fun
-0001ceb0: 6329 3a0a 2020 2020 2020 2020 2020 2020  c):.            
-0001cec0: 2020 2020 7261 6973 6520 5479 7065 4572      raise TypeEr
-0001ced0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-0001cee0: 2020 2020 2020 2020 2022 4361 6e6e 6f74           "Cannot
-0001cef0: 2073 7472 6561 6d20 6672 6f6d 2061 2067   stream from a g
-0001cf00: 656e 6572 6174 6f72 2066 756e 6374 696f  enerator functio
-0001cf10: 6e20 6173 796e 6368 726f 6e6f 7573 6c79  n asynchronously
-0001cf20: 2e22 0a20 2020 2020 2020 2020 2020 2020  .".             
-0001cf30: 2020 2020 2020 2022 5573 6520 2e73 7472         "Use .str
-0001cf40: 6561 6d28 2920 696e 7374 6561 642e 220a  eam() instead.".
-0001cf50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cf60: 290a 0a20 2020 2020 2020 2020 2020 2064  )..            d
-0001cf70: 6566 2066 756e 6328 0a20 2020 2020 2020  ef func(.       
-0001cf80: 2020 2020 2020 2020 2069 6e70 7574 3a20           input: 
-0001cf90: 496e 7075 742c 0a20 2020 2020 2020 2020  Input,.         
-0001cfa0: 2020 2020 2020 2072 756e 5f6d 616e 6167         run_manag
-0001cfb0: 6572 3a20 4173 796e 6343 616c 6c62 6163  er: AsyncCallbac
-0001cfc0: 6b4d 616e 6167 6572 466f 7243 6861 696e  kManagerForChain
-0001cfd0: 5275 6e2c 0a20 2020 2020 2020 2020 2020  Run,.           
-0001cfe0: 2020 2020 2063 6f6e 6669 673a 2052 756e       config: Run
-0001cff0: 6e61 626c 6543 6f6e 6669 672c 0a20 2020  nableConfig,.   
-0001d000: 2020 2020 2020 2020 2029 202d 3e20 4f75           ) -> Ou
-0001d010: 7470 7574 3a0a 2020 2020 2020 2020 2020  tput:.          
-0001d020: 2020 2020 2020 7265 7475 726e 2063 616c        return cal
-0001d030: 6c5f 6675 6e63 5f77 6974 685f 7661 7269  l_func_with_vari
-0001d040: 6162 6c65 5f61 7267 7328 0a20 2020 2020  able_args(.     
-0001d050: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001d060: 656c 662e 6675 6e63 2c20 696e 7075 742c  elf.func, input,
-0001d070: 2063 6f6e 6669 672c 2072 756e 5f6d 616e   config, run_man
-0001d080: 6167 6572 2e67 6574 5f73 796e 6328 292c  ager.get_sync(),
-0001d090: 202a 2a6b 7761 7267 730a 2020 2020 2020   **kwargs.      
-0001d0a0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-0001d0b0: 2020 2020 2020 2020 2040 7772 6170 7328           @wraps(
-0001d0c0: 6675 6e63 290a 2020 2020 2020 2020 2020  func).          
-0001d0d0: 2020 6173 796e 6320 6465 6620 6628 2a61    async def f(*a
-0001d0e0: 7267 732c 202a 2a6b 7761 7267 7329 3a20  rgs, **kwargs): 
-0001d0f0: 2023 2074 7970 653a 2069 676e 6f72 655b   # type: ignore[
-0001d100: 6e6f 2d75 6e74 7970 6564 2d64 6566 5d0a  no-untyped-def].
-0001d110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d120: 7265 7475 726e 2061 7761 6974 2072 756e  return await run
-0001d130: 5f69 6e5f 6578 6563 7574 6f72 2863 6f6e  _in_executor(con
-0001d140: 6669 672c 2066 756e 632c 202a 6172 6773  fig, func, *args
-0001d150: 2c20 2a2a 6b77 6172 6773 290a 0a20 2020  , **kwargs)..   
-0001d160: 2020 2020 2020 2020 2061 6675 6e63 203d           afunc =
-0001d170: 2066 0a0a 2020 2020 2020 2020 6966 2069   f..        if i
-0001d180: 6e73 7065 6374 2e69 7361 7379 6e63 6765  nspect.isasyncge
-0001d190: 6e66 756e 6374 696f 6e28 6166 756e 6329  nfunction(afunc)
-0001d1a0: 3a0a 2020 2020 2020 2020 2020 2020 6f75  :.            ou
-0001d1b0: 7470 7574 3a20 4f70 7469 6f6e 616c 5b4f  tput: Optional[O
-0001d1c0: 7574 7075 745d 203d 204e 6f6e 650a 2020  utput] = None.  
-0001d1d0: 2020 2020 2020 2020 2020 6173 796e 6320            async 
-0001d1e0: 666f 7220 6368 756e 6b20 696e 2063 6173  for chunk in cas
-0001d1f0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-0001d200: 2020 2041 7379 6e63 4974 6572 6174 6f72     AsyncIterator
-0001d210: 5b4f 7574 7075 745d 2c0a 2020 2020 2020  [Output],.      
-0001d220: 2020 2020 2020 2020 2020 6163 616c 6c5f            acall_
-0001d230: 6675 6e63 5f77 6974 685f 7661 7269 6162  func_with_variab
-0001d240: 6c65 5f61 7267 7328 0a20 2020 2020 2020  le_args(.       
-0001d250: 2020 2020 2020 2020 2020 2020 2063 6173               cas
-0001d260: 7428 4361 6c6c 6162 6c65 2c20 6166 756e  t(Callable, afun
-0001d270: 6329 2c0a 2020 2020 2020 2020 2020 2020  c),.            
-0001d280: 2020 2020 2020 2020 6361 7374 2849 6e70          cast(Inp
-0001d290: 7574 2c20 6669 6e61 6c29 2c0a 2020 2020  ut, final),.    
-0001d2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d2b0: 636f 6e66 6967 2c0a 2020 2020 2020 2020  config,.        
-0001d2c0: 2020 2020 2020 2020 2020 2020 7275 6e5f              run_
-0001d2d0: 6d61 6e61 6765 722c 0a20 2020 2020 2020  manager,.       
-0001d2e0: 2020 2020 2020 2020 2020 2020 202a 2a6b               **k
-0001d2f0: 7761 7267 732c 0a20 2020 2020 2020 2020  wargs,.         
-0001d300: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-0001d310: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
-0001d320: 2020 2020 2020 2020 2079 6965 6c64 2063           yield c
-0001d330: 6875 6e6b 0a20 2020 2020 2020 2020 2020  hunk.           
-0001d340: 2020 2020 2069 6620 6f75 7470 7574 2069       if output i
-0001d350: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0001d360: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
-0001d370: 7574 203d 2063 6875 6e6b 0a20 2020 2020  ut = chunk.     
-0001d380: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0001d390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d3a0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0001d3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d3c0: 2020 6f75 7470 7574 203d 206f 7574 7075    output = outpu
-0001d3d0: 7420 2b20 6368 756e 6b20 2023 2074 7970  t + chunk  # typ
-0001d3e0: 653a 2069 676e 6f72 655b 6f70 6572 6174  e: ignore[operat
-0001d3f0: 6f72 5d0a 2020 2020 2020 2020 2020 2020  or].            
-0001d400: 2020 2020 2020 2020 6578 6365 7074 2054          except T
-0001d410: 7970 6545 7272 6f72 3a0a 2020 2020 2020  ypeError:.      
-0001d420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d430: 2020 6f75 7470 7574 203d 2063 6875 6e6b    output = chunk
-0001d440: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0001d450: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
-0001d460: 7420 3d20 6177 6169 7420 6163 616c 6c5f  t = await acall_
-0001d470: 6675 6e63 5f77 6974 685f 7661 7269 6162  func_with_variab
-0001d480: 6c65 5f61 7267 7328 0a20 2020 2020 2020  le_args(.       
-0001d490: 2020 2020 2020 2020 2063 6173 7428 4361           cast(Ca
-0001d4a0: 6c6c 6162 6c65 2c20 6166 756e 6329 2c20  llable, afunc), 
-0001d4b0: 6361 7374 2849 6e70 7574 2c20 6669 6e61  cast(Input, fina
-0001d4c0: 6c29 2c20 636f 6e66 6967 2c20 7275 6e5f  l), config, run_
-0001d4d0: 6d61 6e61 6765 722c 202a 2a6b 7761 7267  manager, **kwarg
-0001d4e0: 730a 2020 2020 2020 2020 2020 2020 290a  s.            ).
-0001d4f0: 0a20 2020 2020 2020 2023 2049 6620 7468  .        # If th
-0001d500: 6520 6f75 7470 7574 2069 7320 6120 7275  e output is a ru
-0001d510: 6e6e 6162 6c65 2c20 7573 6520 6974 7320  nnable, use its 
-0001d520: 6173 7472 6561 6d20 6f75 7470 7574 0a20  astream output. 
-0001d530: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-0001d540: 616e 6365 286f 7574 7075 742c 2052 756e  ance(output, Run
-0001d550: 6e61 626c 6529 3a0a 2020 2020 2020 2020  nable):.        
-0001d560: 2020 2020 7265 6375 7273 696f 6e5f 6c69      recursion_li
-0001d570: 6d69 7420 3d20 636f 6e66 6967 5b22 7265  mit = config["re
-0001d580: 6375 7273 696f 6e5f 6c69 6d69 7422 5d0a  cursion_limit"].
-0001d590: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-0001d5a0: 6563 7572 7369 6f6e 5f6c 696d 6974 203c  ecursion_limit <
-0001d5b0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-0001d5c0: 2020 2020 2072 6169 7365 2052 6563 7572       raise Recur
-0001d5d0: 7369 6f6e 4572 726f 7228 0a20 2020 2020  sionError(.     
-0001d5e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001d5f0: 2252 6563 7572 7369 6f6e 206c 696d 6974  "Recursion limit
-0001d600: 2072 6561 6368 6564 2077 6865 6e20 696e   reached when in
-0001d610: 766f 6b69 6e67 2022 0a20 2020 2020 2020  voking ".       
-0001d620: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
-0001d630: 7365 6c66 7d20 7769 7468 2069 6e70 7574  self} with input
-0001d640: 207b 6669 6e61 6c7d 2e22 0a20 2020 2020   {final}.".     
-0001d650: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0001d660: 2020 2020 2020 2020 2061 7379 6e63 2066           async f
-0001d670: 6f72 2063 6875 6e6b 2069 6e20 6f75 7470  or chunk in outp
-0001d680: 7574 2e61 7374 7265 616d 280a 2020 2020  ut.astream(.    
-0001d690: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
-0001d6a0: 6c2c 0a20 2020 2020 2020 2020 2020 2020  l,.             
-0001d6b0: 2020 2070 6174 6368 5f63 6f6e 6669 6728     patch_config(
-0001d6c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d6d0: 2020 2020 2063 6f6e 6669 672c 0a20 2020       config,.   
-0001d6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d6f0: 2063 616c 6c62 6163 6b73 3d72 756e 5f6d   callbacks=run_m
-0001d700: 616e 6167 6572 2e67 6574 5f63 6869 6c64  anager.get_child
-0001d710: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-0001d720: 2020 2020 2020 2020 7265 6375 7273 696f          recursio
-0001d730: 6e5f 6c69 6d69 743d 7265 6375 7273 696f  n_limit=recursio
-0001d740: 6e5f 6c69 6d69 7420 2d20 312c 0a20 2020  n_limit - 1,.   
-0001d750: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
-0001d760: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
-0001d770: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-0001d780: 6965 6c64 2063 6875 6e6b 0a20 2020 2020  ield chunk.     
-0001d790: 2020 2065 6c69 6620 6e6f 7420 696e 7370     elif not insp
-0001d7a0: 6563 742e 6973 6173 796e 6367 656e 6675  ect.isasyncgenfu
-0001d7b0: 6e63 7469 6f6e 2861 6675 6e63 293a 0a20  nction(afunc):. 
-0001d7c0: 2020 2020 2020 2020 2020 2023 204f 7468             # Oth
-0001d7d0: 6572 7769 7365 2c20 6a75 7374 2079 6965  erwise, just yie
-0001d7e0: 6c64 2069 740a 2020 2020 2020 2020 2020  ld it.          
-0001d7f0: 2020 7969 656c 6420 6361 7374 284f 7574    yield cast(Out
-0001d800: 7075 742c 206f 7574 7075 7429 0a0a 2020  put, output)..  
-0001d810: 2020 6173 796e 6320 6465 6620 6174 7261    async def atra
-0001d820: 6e73 666f 726d 280a 2020 2020 2020 2020  nsform(.        
-0001d830: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
-0001d840: 7075 743a 2041 7379 6e63 4974 6572 6174  put: AsyncIterat
-0001d850: 6f72 5b49 6e70 7574 5d2c 0a20 2020 2020  or[Input],.     
-0001d860: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
-0001d870: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-0001d880: 6967 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ig] = None,.    
-0001d890: 2020 2020 2a2a 6b77 6172 6773 3a20 4f70      **kwargs: Op
-0001d8a0: 7469 6f6e 616c 5b41 6e79 5d2c 0a20 2020  tional[Any],.   
-0001d8b0: 2029 202d 3e20 4173 796e 6349 7465 7261   ) -> AsyncItera
-0001d8c0: 746f 725b 4f75 7470 7574 5d3a 0a20 2020  tor[Output]:.   
-0001d8d0: 2020 2020 2061 7379 6e63 2066 6f72 206f       async for o
-0001d8e0: 7574 7075 7420 696e 2073 656c 662e 5f61  utput in self._a
-0001d8f0: 7472 616e 7366 6f72 6d5f 7374 7265 616d  transform_stream
-0001d900: 5f77 6974 685f 636f 6e66 6967 280a 2020  _with_config(.  
-0001d910: 2020 2020 2020 2020 2020 696e 7075 742c            input,
-0001d920: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0001d930: 662e 5f61 7472 616e 7366 6f72 6d2c 0a20  f._atransform,. 
-0001d940: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001d950: 5f63 6f6e 6669 6728 636f 6e66 6967 2c20  _config(config, 
-0001d960: 7365 6c66 2e61 6675 6e63 2069 6620 6861  self.afunc if ha
-0001d970: 7361 7474 7228 7365 6c66 2c20 2261 6675  sattr(self, "afu
-0001d980: 6e63 2229 2065 6c73 6520 7365 6c66 2e66  nc") else self.f
-0001d990: 756e 6329 2c0a 2020 2020 2020 2020 2020  unc),.          
-0001d9a0: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
-0001d9b0: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-0001d9c0: 2020 2079 6965 6c64 206f 7574 7075 740a     yield output.
-0001d9d0: 0a20 2020 2061 7379 6e63 2064 6566 2061  .    async def a
-0001d9e0: 7374 7265 616d 280a 2020 2020 2020 2020  stream(.        
-0001d9f0: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
-0001da00: 7075 743a 2049 6e70 7574 2c0a 2020 2020  put: Input,.    
-0001da10: 2020 2020 636f 6e66 6967 3a20 4f70 7469      config: Opti
-0001da20: 6f6e 616c 5b52 756e 6e61 626c 6543 6f6e  onal[RunnableCon
-0001da30: 6669 675d 203d 204e 6f6e 652c 0a20 2020  fig] = None,.   
-0001da40: 2020 2020 202a 2a6b 7761 7267 733a 204f       **kwargs: O
-0001da50: 7074 696f 6e61 6c5b 416e 795d 2c0a 2020  ptional[Any],.  
-0001da60: 2020 2920 2d3e 2041 7379 6e63 4974 6572    ) -> AsyncIter
-0001da70: 6174 6f72 5b4f 7574 7075 745d 3a0a 2020  ator[Output]:.  
-0001da80: 2020 2020 2020 6173 796e 6320 6465 6620        async def 
-0001da90: 696e 7075 745f 6169 7465 7228 2920 2d3e  input_aiter() ->
-0001daa0: 2041 7379 6e63 4974 6572 6174 6f72 5b49   AsyncIterator[I
-0001dab0: 6e70 7574 5d3a 0a20 2020 2020 2020 2020  nput]:.         
-0001dac0: 2020 2079 6965 6c64 2069 6e70 7574 0a0a     yield input..
-0001dad0: 2020 2020 2020 2020 6173 796e 6320 666f          async fo
-0001dae0: 7220 6368 756e 6b20 696e 2073 656c 662e  r chunk in self.
-0001daf0: 6174 7261 6e73 666f 726d 2869 6e70 7574  atransform(input
-0001db00: 5f61 6974 6572 2829 2c20 636f 6e66 6967  _aiter(), config
-0001db10: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-0001db20: 2020 2020 2020 2020 2079 6965 6c64 2063           yield c
-0001db30: 6875 6e6b 0a0a 0a63 6c61 7373 2052 756e  hunk...class Run
-0001db40: 6e61 626c 6545 6163 6842 6173 6528 5275  nableEachBase(Ru
-0001db50: 6e6e 6162 6c65 5365 7269 616c 697a 6162  nnableSerializab
-0001db60: 6c65 5b4c 6973 745b 496e 7075 745d 2c20  le[List[Input], 
-0001db70: 4c69 7374 5b4f 7574 7075 745d 5d29 3a0a  List[Output]]):.
-0001db80: 2020 2020 2222 220a 2020 2020 4120 7275      """.    A ru
-0001db90: 6e6e 6162 6c65 2074 6861 7420 6465 6c65  nnable that dele
-0001dba0: 6761 7465 7320 6361 6c6c 7320 746f 2061  gates calls to a
-0001dbb0: 6e6f 7468 6572 2072 756e 6e61 626c 650a  nother runnable.
-0001dbc0: 2020 2020 7769 7468 2065 6163 6820 656c      with each el
-0001dbd0: 656d 656e 7420 6f66 2074 6865 2069 6e70  ement of the inp
-0001dbe0: 7574 2073 6571 7565 6e63 652e 0a0a 2020  ut sequence...  
-0001dbf0: 2020 5573 6520 6f6e 6c79 2069 6620 6372    Use only if cr
-0001dc00: 6561 7469 6e67 2061 206e 6577 2052 756e  eating a new Run
-0001dc10: 6e61 626c 6545 6163 6820 7375 6263 6c61  nableEach subcla
-0001dc20: 7373 2077 6974 6820 6469 6666 6572 656e  ss with differen
-0001dc30: 7420 5f5f 696e 6974 5f5f 2061 7267 732e  t __init__ args.
-0001dc40: 0a20 2020 2022 2222 0a0a 2020 2020 626f  .    """..    bo
-0001dc50: 756e 643a 2052 756e 6e61 626c 655b 496e  und: Runnable[In
-0001dc60: 7075 742c 204f 7574 7075 745d 0a0a 2020  put, Output]..  
-0001dc70: 2020 636c 6173 7320 436f 6e66 6967 3a0a    class Config:.
-0001dc80: 2020 2020 2020 2020 6172 6269 7472 6172          arbitrar
-0001dc90: 795f 7479 7065 735f 616c 6c6f 7765 6420  y_types_allowed 
-0001dca0: 3d20 5472 7565 0a0a 2020 2020 4070 726f  = True..    @pro
-0001dcb0: 7065 7274 790a 2020 2020 6465 6620 496e  perty.    def In
-0001dcc0: 7075 7454 7970 6528 7365 6c66 2920 2d3e  putType(self) ->
-0001dcd0: 2041 6e79 3a0a 2020 2020 2020 2020 7265   Any:.        re
-0001dce0: 7475 726e 204c 6973 745b 7365 6c66 2e62  turn List[self.b
-0001dcf0: 6f75 6e64 2e49 6e70 7574 5479 7065 5d20  ound.InputType] 
-0001dd00: 2023 2074 7970 653a 2069 676e 6f72 655b   # type: ignore[
-0001dd10: 6e61 6d65 2d64 6566 696e 6564 5d0a 0a20  name-defined].. 
-0001dd20: 2020 2064 6566 2067 6574 5f69 6e70 7574     def get_input
-0001dd30: 5f73 6368 656d 6128 0a20 2020 2020 2020  _schema(.       
-0001dd40: 2073 656c 662c 2063 6f6e 6669 673a 204f   self, config: O
-0001dd50: 7074 696f 6e61 6c5b 5275 6e6e 6162 6c65  ptional[Runnable
-0001dd60: 436f 6e66 6967 5d20 3d20 4e6f 6e65 0a20  Config] = None. 
-0001dd70: 2020 2029 202d 3e20 5479 7065 5b42 6173     ) -> Type[Bas
-0001dd80: 654d 6f64 656c 5d3a 0a20 2020 2020 2020  eModel]:.       
-0001dd90: 2072 6574 7572 6e20 6372 6561 7465 5f6d   return create_m
-0001dda0: 6f64 656c 280a 2020 2020 2020 2020 2020  odel(.          
-0001ddb0: 2020 7365 6c66 2e67 6574 5f6e 616d 6528    self.get_name(
-0001ddc0: 2249 6e70 7574 2229 2c0a 2020 2020 2020  "Input"),.      
-0001ddd0: 2020 2020 2020 5f5f 726f 6f74 5f5f 3d28        __root__=(
-0001dde0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ddf0: 204c 6973 745b 7365 6c66 2e62 6f75 6e64   List[self.bound
-0001de00: 2e67 6574 5f69 6e70 7574 5f73 6368 656d  .get_input_schem
-0001de10: 6128 636f 6e66 6967 295d 2c20 2023 2074  a(config)],  # t
-0001de20: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
-0001de30: 2020 2020 2020 2020 2020 2020 4e6f 6e65              None
-0001de40: 2c0a 2020 2020 2020 2020 2020 2020 292c  ,.            ),
-0001de50: 0a20 2020 2020 2020 2020 2020 205f 5f63  .            __c
-0001de60: 6f6e 6669 675f 5f3d 5f53 6368 656d 6143  onfig__=_SchemaC
-0001de70: 6f6e 6669 672c 0a20 2020 2020 2020 2029  onfig,.        )
-0001de80: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-0001de90: 2020 2020 6465 6620 4f75 7470 7574 5479      def OutputTy
-0001dea0: 7065 2873 656c 6629 202d 3e20 5479 7065  pe(self) -> Type
-0001deb0: 5b4c 6973 745b 4f75 7470 7574 5d5d 3a0a  [List[Output]]:.
-0001dec0: 2020 2020 2020 2020 7265 7475 726e 204c          return L
-0001ded0: 6973 745b 7365 6c66 2e62 6f75 6e64 2e4f  ist[self.bound.O
-0001dee0: 7574 7075 7454 7970 655d 2020 2320 7479  utputType]  # ty
-0001def0: 7065 3a20 6967 6e6f 7265 5b6e 616d 652d  pe: ignore[name-
-0001df00: 6465 6669 6e65 645d 0a0a 2020 2020 6465  defined]..    de
-0001df10: 6620 6765 745f 6f75 7470 7574 5f73 6368  f get_output_sch
-0001df20: 656d 6128 0a20 2020 2020 2020 2073 656c  ema(.        sel
-0001df30: 662c 2063 6f6e 6669 673a 204f 7074 696f  f, config: Optio
-0001df40: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-0001df50: 6967 5d20 3d20 4e6f 6e65 0a20 2020 2029  ig] = None.    )
-0001df60: 202d 3e20 5479 7065 5b42 6173 654d 6f64   -> Type[BaseMod
-0001df70: 656c 5d3a 0a20 2020 2020 2020 2073 6368  el]:.        sch
-0001df80: 656d 6120 3d20 7365 6c66 2e62 6f75 6e64  ema = self.bound
-0001df90: 2e67 6574 5f6f 7574 7075 745f 7363 6865  .get_output_sche
-0001dfa0: 6d61 2863 6f6e 6669 6729 0a20 2020 2020  ma(config).     
-0001dfb0: 2020 2072 6574 7572 6e20 6372 6561 7465     return create
-0001dfc0: 5f6d 6f64 656c 280a 2020 2020 2020 2020  _model(.        
-0001dfd0: 2020 2020 7365 6c66 2e67 6574 5f6e 616d      self.get_nam
-0001dfe0: 6528 224f 7574 7075 7422 292c 0a20 2020  e("Output"),.   
-0001dff0: 2020 2020 2020 2020 205f 5f72 6f6f 745f           __root_
-0001e000: 5f3d 280a 2020 2020 2020 2020 2020 2020  _=(.            
-0001e010: 2020 2020 4c69 7374 5b73 6368 656d 615d      List[schema]
-0001e020: 2c20 2023 2074 7970 653a 2069 676e 6f72  ,  # type: ignor
-0001e030: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0001e040: 2020 4e6f 6e65 2c0a 2020 2020 2020 2020    None,.        
-0001e050: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-0001e060: 2020 205f 5f63 6f6e 6669 675f 5f3d 5f53     __config__=_S
-0001e070: 6368 656d 6143 6f6e 6669 672c 0a20 2020  chemaConfig,.   
-0001e080: 2020 2020 2029 0a0a 2020 2020 4070 726f       )..    @pro
-0001e090: 7065 7274 790a 2020 2020 6465 6620 636f  perty.    def co
-0001e0a0: 6e66 6967 5f73 7065 6373 2873 656c 6629  nfig_specs(self)
-0001e0b0: 202d 3e20 4c69 7374 5b43 6f6e 6669 6775   -> List[Configu
-0001e0c0: 7261 626c 6546 6965 6c64 5370 6563 5d3a  rableFieldSpec]:
-0001e0d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001e0e0: 7365 6c66 2e62 6f75 6e64 2e63 6f6e 6669  self.bound.confi
-0001e0f0: 675f 7370 6563 730a 0a20 2020 2064 6566  g_specs..    def
-0001e100: 2067 6574 5f67 7261 7068 2873 656c 662c   get_graph(self,
-0001e110: 2063 6f6e 6669 673a 204f 7074 696f 6e61   config: Optiona
-0001e120: 6c5b 5275 6e6e 6162 6c65 436f 6e66 6967  l[RunnableConfig
-0001e130: 5d20 3d20 4e6f 6e65 2920 2d3e 2047 7261  ] = None) -> Gra
-0001e140: 7068 3a0a 2020 2020 2020 2020 7265 7475  ph:.        retu
-0001e150: 726e 2073 656c 662e 626f 756e 642e 6765  rn self.bound.ge
-0001e160: 745f 6772 6170 6828 636f 6e66 6967 290a  t_graph(config).
-0001e170: 0a20 2020 2040 636c 6173 736d 6574 686f  .    @classmetho
-0001e180: 640a 2020 2020 6465 6620 6973 5f6c 635f  d.    def is_lc_
-0001e190: 7365 7269 616c 697a 6162 6c65 2863 6c73  serializable(cls
-0001e1a0: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
-0001e1b0: 2020 2072 6574 7572 6e20 5472 7565 0a0a     return True..
-0001e1c0: 2020 2020 4063 6c61 7373 6d65 7468 6f64      @classmethod
-0001e1d0: 0a20 2020 2064 6566 2067 6574 5f6c 635f  .    def get_lc_
-0001e1e0: 6e61 6d65 7370 6163 6528 636c 7329 202d  namespace(cls) -
-0001e1f0: 3e20 4c69 7374 5b73 7472 5d3a 0a20 2020  > List[str]:.   
-0001e200: 2020 2020 2022 2222 4765 7420 7468 6520       """Get the 
-0001e210: 6e61 6d65 7370 6163 6520 6f66 2074 6865  namespace of the
-0001e220: 206c 616e 6763 6861 696e 206f 626a 6563   langchain objec
-0001e230: 742e 2222 220a 2020 2020 2020 2020 7265  t.""".        re
-0001e240: 7475 726e 205b 226c 616e 6763 6861 696e  turn ["langchain
-0001e250: 222c 2022 7363 6865 6d61 222c 2022 7275  ", "schema", "ru
-0001e260: 6e6e 6162 6c65 225d 0a0a 2020 2020 6465  nnable"]..    de
-0001e270: 6620 5f69 6e76 6f6b 6528 0a20 2020 2020  f _invoke(.     
-0001e280: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-0001e290: 2069 6e70 7574 733a 204c 6973 745b 496e   inputs: List[In
-0001e2a0: 7075 745d 2c0a 2020 2020 2020 2020 7275  put],.        ru
-0001e2b0: 6e5f 6d61 6e61 6765 723a 2043 616c 6c62  n_manager: Callb
-0001e2c0: 6163 6b4d 616e 6167 6572 466f 7243 6861  ackManagerForCha
-0001e2d0: 696e 5275 6e2c 0a20 2020 2020 2020 2063  inRun,.        c
-0001e2e0: 6f6e 6669 673a 2052 756e 6e61 626c 6543  onfig: RunnableC
-0001e2f0: 6f6e 6669 672c 0a20 2020 2020 2020 202a  onfig,.        *
-0001e300: 2a6b 7761 7267 733a 2041 6e79 2c0a 2020  *kwargs: Any,.  
-0001e310: 2020 2920 2d3e 204c 6973 745b 4f75 7470    ) -> List[Outp
-0001e320: 7574 5d3a 0a20 2020 2020 2020 2072 6574  ut]:.        ret
-0001e330: 7572 6e20 7365 6c66 2e62 6f75 6e64 2e62  urn self.bound.b
-0001e340: 6174 6368 280a 2020 2020 2020 2020 2020  atch(.          
-0001e350: 2020 696e 7075 7473 2c20 7061 7463 685f    inputs, patch_
-0001e360: 636f 6e66 6967 2863 6f6e 6669 672c 2063  config(config, c
-0001e370: 616c 6c62 6163 6b73 3d72 756e 5f6d 616e  allbacks=run_man
-0001e380: 6167 6572 2e67 6574 5f63 6869 6c64 2829  ager.get_child()
-0001e390: 292c 202a 2a6b 7761 7267 730a 2020 2020  ), **kwargs.    
-0001e3a0: 2020 2020 290a 0a20 2020 2064 6566 2069      )..    def i
-0001e3b0: 6e76 6f6b 6528 0a20 2020 2020 2020 2073  nvoke(.        s
-0001e3c0: 656c 662c 2069 6e70 7574 3a20 4c69 7374  elf, input: List
-0001e3d0: 5b49 6e70 7574 5d2c 2063 6f6e 6669 673a  [Input], config:
-0001e3e0: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
-0001e3f0: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
-0001e400: 2c20 2a2a 6b77 6172 6773 3a20 416e 790a  , **kwargs: Any.
-0001e410: 2020 2020 2920 2d3e 204c 6973 745b 4f75      ) -> List[Ou
-0001e420: 7470 7574 5d3a 0a20 2020 2020 2020 2072  tput]:.        r
-0001e430: 6574 7572 6e20 7365 6c66 2e5f 6361 6c6c  eturn self._call
-0001e440: 5f77 6974 685f 636f 6e66 6967 2873 656c  _with_config(sel
-0001e450: 662e 5f69 6e76 6f6b 652c 2069 6e70 7574  f._invoke, input
-0001e460: 2c20 636f 6e66 6967 2c20 2a2a 6b77 6172  , config, **kwar
-0001e470: 6773 290a 0a20 2020 2061 7379 6e63 2064  gs)..    async d
-0001e480: 6566 205f 6169 6e76 6f6b 6528 0a20 2020  ef _ainvoke(.   
-0001e490: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-0001e4a0: 2020 2069 6e70 7574 733a 204c 6973 745b     inputs: List[
-0001e4b0: 496e 7075 745d 2c0a 2020 2020 2020 2020  Input],.        
-0001e4c0: 7275 6e5f 6d61 6e61 6765 723a 2041 7379  run_manager: Asy
-0001e4d0: 6e63 4361 6c6c 6261 636b 4d61 6e61 6765  ncCallbackManage
-0001e4e0: 7246 6f72 4368 6169 6e52 756e 2c0a 2020  rForChainRun,.  
-0001e4f0: 2020 2020 2020 636f 6e66 6967 3a20 5275        config: Ru
-0001e500: 6e6e 6162 6c65 436f 6e66 6967 2c0a 2020  nnableConfig,.  
-0001e510: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
-0001e520: 416e 792c 0a20 2020 2029 202d 3e20 4c69  Any,.    ) -> Li
-0001e530: 7374 5b4f 7574 7075 745d 3a0a 2020 2020  st[Output]:.    
-0001e540: 2020 2020 7265 7475 726e 2061 7761 6974      return await
-0001e550: 2073 656c 662e 626f 756e 642e 6162 6174   self.bound.abat
-0001e560: 6368 280a 2020 2020 2020 2020 2020 2020  ch(.            
-0001e570: 696e 7075 7473 2c20 7061 7463 685f 636f  inputs, patch_co
-0001e580: 6e66 6967 2863 6f6e 6669 672c 2063 616c  nfig(config, cal
-0001e590: 6c62 6163 6b73 3d72 756e 5f6d 616e 6167  lbacks=run_manag
-0001e5a0: 6572 2e67 6574 5f63 6869 6c64 2829 292c  er.get_child()),
-0001e5b0: 202a 2a6b 7761 7267 730a 2020 2020 2020   **kwargs.      
-0001e5c0: 2020 290a 0a20 2020 2061 7379 6e63 2064    )..    async d
-0001e5d0: 6566 2061 696e 766f 6b65 280a 2020 2020  ef ainvoke(.    
-0001e5e0: 2020 2020 7365 6c66 2c20 696e 7075 743a      self, input:
-0001e5f0: 204c 6973 745b 496e 7075 745d 2c20 636f   List[Input], co
-0001e600: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
-0001e610: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
-0001e620: 204e 6f6e 652c 202a 2a6b 7761 7267 733a   None, **kwargs:
-0001e630: 2041 6e79 0a20 2020 2029 202d 3e20 4c69   Any.    ) -> Li
-0001e640: 7374 5b4f 7574 7075 745d 3a0a 2020 2020  st[Output]:.    
-0001e650: 2020 2020 7265 7475 726e 2061 7761 6974      return await
-0001e660: 2073 656c 662e 5f61 6361 6c6c 5f77 6974   self._acall_wit
-0001e670: 685f 636f 6e66 6967 2873 656c 662e 5f61  h_config(self._a
-0001e680: 696e 766f 6b65 2c20 696e 7075 742c 2063  invoke, input, c
-0001e690: 6f6e 6669 672c 202a 2a6b 7761 7267 7329  onfig, **kwargs)
-0001e6a0: 0a0a 0a63 6c61 7373 2052 756e 6e61 626c  ...class Runnabl
-0001e6b0: 6545 6163 6828 5275 6e6e 6162 6c65 4561  eEach(RunnableEa
-0001e6c0: 6368 4261 7365 5b49 6e70 7574 2c20 4f75  chBase[Input, Ou
-0001e6d0: 7470 7574 5d29 3a0a 2020 2020 2222 220a  tput]):.    """.
-0001e6e0: 2020 2020 4120 7275 6e6e 6162 6c65 2074      A runnable t
-0001e6f0: 6861 7420 6465 6c65 6761 7465 7320 6361  hat delegates ca
-0001e700: 6c6c 7320 746f 2061 6e6f 7468 6572 2072  lls to another r
-0001e710: 756e 6e61 626c 650a 2020 2020 7769 7468  unnable.    with
-0001e720: 2065 6163 6820 656c 656d 656e 7420 6f66   each element of
-0001e730: 2074 6865 2069 6e70 7574 2073 6571 7565   the input seque
-0001e740: 6e63 652e 0a20 2020 2022 2222 0a0a 2020  nce..    """..  
-0001e750: 2020 4063 6c61 7373 6d65 7468 6f64 0a20    @classmethod. 
-0001e760: 2020 2064 6566 2067 6574 5f6c 635f 6e61     def get_lc_na
-0001e770: 6d65 7370 6163 6528 636c 7329 202d 3e20  mespace(cls) -> 
-0001e780: 4c69 7374 5b73 7472 5d3a 0a20 2020 2020  List[str]:.     
-0001e790: 2020 2022 2222 4765 7420 7468 6520 6e61     """Get the na
-0001e7a0: 6d65 7370 6163 6520 6f66 2074 6865 206c  mespace of the l
-0001e7b0: 616e 6763 6861 696e 206f 626a 6563 742e  angchain object.
-0001e7c0: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
-0001e7d0: 726e 205b 226c 616e 6763 6861 696e 222c  rn ["langchain",
-0001e7e0: 2022 7363 6865 6d61 222c 2022 7275 6e6e   "schema", "runn
-0001e7f0: 6162 6c65 225d 0a0a 2020 2020 6465 6620  able"]..    def 
-0001e800: 6765 745f 6e61 6d65 280a 2020 2020 2020  get_name(.      
-0001e810: 2020 7365 6c66 2c20 7375 6666 6978 3a20    self, suffix: 
-0001e820: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
-0001e830: 4e6f 6e65 2c20 2a2c 206e 616d 653a 204f  None, *, name: O
-0001e840: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
-0001e850: 6f6e 650a 2020 2020 2920 2d3e 2073 7472  one.    ) -> str
-0001e860: 3a0a 2020 2020 2020 2020 6e61 6d65 203d  :.        name =
-0001e870: 206e 616d 6520 6f72 2073 656c 662e 6e61   name or self.na
-0001e880: 6d65 206f 7220 6622 5275 6e6e 6162 6c65  me or f"Runnable
-0001e890: 4561 6368 3c7b 7365 6c66 2e62 6f75 6e64  Each<{self.bound
-0001e8a0: 2e67 6574 5f6e 616d 6528 297d 3e22 0a20  .get_name()}>". 
-0001e8b0: 2020 2020 2020 2072 6574 7572 6e20 7375         return su
-0001e8c0: 7065 7228 292e 6765 745f 6e61 6d65 2873  per().get_name(s
-0001e8d0: 7566 6669 782c 206e 616d 653d 6e61 6d65  uffix, name=name
-0001e8e0: 290a 0a20 2020 2064 6566 2062 696e 6428  )..    def bind(
-0001e8f0: 7365 6c66 2c20 2a2a 6b77 6172 6773 3a20  self, **kwargs: 
-0001e900: 416e 7929 202d 3e20 5275 6e6e 6162 6c65  Any) -> Runnable
-0001e910: 4561 6368 5b49 6e70 7574 2c20 4f75 7470  Each[Input, Outp
-0001e920: 7574 5d3a 0a20 2020 2020 2020 2072 6574  ut]:.        ret
-0001e930: 7572 6e20 5275 6e6e 6162 6c65 4561 6368  urn RunnableEach
-0001e940: 2862 6f75 6e64 3d73 656c 662e 626f 756e  (bound=self.boun
-0001e950: 642e 6269 6e64 282a 2a6b 7761 7267 7329  d.bind(**kwargs)
-0001e960: 290a 0a20 2020 2064 6566 2077 6974 685f  )..    def with_
-0001e970: 636f 6e66 6967 280a 2020 2020 2020 2020  config(.        
-0001e980: 7365 6c66 2c20 636f 6e66 6967 3a20 4f70  self, config: Op
-0001e990: 7469 6f6e 616c 5b52 756e 6e61 626c 6543  tional[RunnableC
-0001e9a0: 6f6e 6669 675d 203d 204e 6f6e 652c 202a  onfig] = None, *
-0001e9b0: 2a6b 7761 7267 733a 2041 6e79 0a20 2020  *kwargs: Any.   
-0001e9c0: 2029 202d 3e20 5275 6e6e 6162 6c65 4561   ) -> RunnableEa
-0001e9d0: 6368 5b49 6e70 7574 2c20 4f75 7470 7574  ch[Input, Output
-0001e9e0: 5d3a 0a20 2020 2020 2020 2072 6574 7572  ]:.        retur
-0001e9f0: 6e20 5275 6e6e 6162 6c65 4561 6368 2862  n RunnableEach(b
-0001ea00: 6f75 6e64 3d73 656c 662e 626f 756e 642e  ound=self.bound.
-0001ea10: 7769 7468 5f63 6f6e 6669 6728 636f 6e66  with_config(conf
-0001ea20: 6967 2c20 2a2a 6b77 6172 6773 2929 0a0a  ig, **kwargs))..
-0001ea30: 2020 2020 6465 6620 7769 7468 5f6c 6973      def with_lis
-0001ea40: 7465 6e65 7273 280a 2020 2020 2020 2020  teners(.        
-0001ea50: 7365 6c66 2c0a 2020 2020 2020 2020 2a2c  self,.        *,
-0001ea60: 0a20 2020 2020 2020 206f 6e5f 7374 6172  .        on_star
-0001ea70: 743a 204f 7074 696f 6e61 6c5b 4c69 7374  t: Optional[List
-0001ea80: 656e 6572 5d20 3d20 4e6f 6e65 2c0a 2020  ener] = None,.  
-0001ea90: 2020 2020 2020 6f6e 5f65 6e64 3a20 4f70        on_end: Op
-0001eaa0: 7469 6f6e 616c 5b4c 6973 7465 6e65 725d  tional[Listener]
-0001eab0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-0001eac0: 206f 6e5f 6572 726f 723a 204f 7074 696f   on_error: Optio
-0001ead0: 6e61 6c5b 4c69 7374 656e 6572 5d20 3d20  nal[Listener] = 
-0001eae0: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 2052  None,.    ) -> R
-0001eaf0: 756e 6e61 626c 6545 6163 685b 496e 7075  unnableEach[Inpu
-0001eb00: 742c 204f 7574 7075 745d 3a0a 2020 2020  t, Output]:.    
-0001eb10: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0001eb20: 4269 6e64 206c 6966 6563 7963 6c65 206c  Bind lifecycle l
-0001eb30: 6973 7465 6e65 7273 2074 6f20 6120 5275  isteners to a Ru
-0001eb40: 6e6e 6162 6c65 2c20 7265 7475 726e 696e  nnable, returnin
-0001eb50: 6720 6120 6e65 7720 5275 6e6e 6162 6c65  g a new Runnable
-0001eb60: 2e0a 0a20 2020 2020 2020 206f 6e5f 7374  ...        on_st
-0001eb70: 6172 743a 2043 616c 6c65 6420 6265 666f  art: Called befo
-0001eb80: 7265 2074 6865 2072 756e 6e61 626c 6520  re the runnable 
-0001eb90: 7374 6172 7473 2072 756e 6e69 6e67 2c20  starts running, 
-0001eba0: 7769 7468 2074 6865 2052 756e 206f 626a  with the Run obj
-0001ebb0: 6563 742e 0a20 2020 2020 2020 206f 6e5f  ect..        on_
-0001ebc0: 656e 643a 2043 616c 6c65 6420 6166 7465  end: Called afte
-0001ebd0: 7220 7468 6520 7275 6e6e 6162 6c65 2066  r the runnable f
-0001ebe0: 696e 6973 6865 7320 7275 6e6e 696e 672c  inishes running,
-0001ebf0: 2077 6974 6820 7468 6520 5275 6e20 6f62   with the Run ob
-0001ec00: 6a65 6374 2e0a 2020 2020 2020 2020 6f6e  ject..        on
-0001ec10: 5f65 7272 6f72 3a20 4361 6c6c 6564 2069  _error: Called i
-0001ec20: 6620 7468 6520 7275 6e6e 6162 6c65 2074  f the runnable t
-0001ec30: 6872 6f77 7320 616e 2065 7272 6f72 2c20  hrows an error, 
-0001ec40: 7769 7468 2074 6865 2052 756e 206f 626a  with the Run obj
-0001ec50: 6563 742e 0a0a 2020 2020 2020 2020 5468  ect...        Th
-0001ec60: 6520 5275 6e20 6f62 6a65 6374 2063 6f6e  e Run object con
-0001ec70: 7461 696e 7320 696e 666f 726d 6174 696f  tains informatio
-0001ec80: 6e20 6162 6f75 7420 7468 6520 7275 6e2c  n about the run,
-0001ec90: 2069 6e63 6c75 6469 6e67 2069 7473 2069   including its i
-0001eca0: 642c 0a20 2020 2020 2020 2074 7970 652c  d,.        type,
-0001ecb0: 2069 6e70 7574 2c20 6f75 7470 7574 2c20   input, output, 
-0001ecc0: 6572 726f 722c 2073 7461 7274 5f74 696d  error, start_tim
-0001ecd0: 652c 2065 6e64 5f74 696d 652c 2061 6e64  e, end_time, and
-0001ece0: 2061 6e79 2074 6167 7320 6f72 206d 6574   any tags or met
-0001ecf0: 6164 6174 610a 2020 2020 2020 2020 6164  adata.        ad
-0001ed00: 6465 6420 746f 2074 6865 2072 756e 2e0a  ded to the run..
-0001ed10: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0001ed20: 2020 2020 7265 7475 726e 2052 756e 6e61      return Runna
-0001ed30: 626c 6545 6163 6828 0a20 2020 2020 2020  bleEach(.       
-0001ed40: 2020 2020 2062 6f75 6e64 3d73 656c 662e       bound=self.
-0001ed50: 626f 756e 642e 7769 7468 5f6c 6973 7465  bound.with_liste
-0001ed60: 6e65 7273 280a 2020 2020 2020 2020 2020  ners(.          
-0001ed70: 2020 2020 2020 6f6e 5f73 7461 7274 3d6f        on_start=o
-0001ed80: 6e5f 7374 6172 742c 206f 6e5f 656e 643d  n_start, on_end=
-0001ed90: 6f6e 5f65 6e64 2c20 6f6e 5f65 7272 6f72  on_end, on_error
-0001eda0: 3d6f 6e5f 6572 726f 720a 2020 2020 2020  =on_error.      
-0001edb0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001edc0: 290a 0a0a 636c 6173 7320 5275 6e6e 6162  )...class Runnab
-0001edd0: 6c65 4269 6e64 696e 6742 6173 6528 5275  leBindingBase(Ru
-0001ede0: 6e6e 6162 6c65 5365 7269 616c 697a 6162  nnableSerializab
-0001edf0: 6c65 5b49 6e70 7574 2c20 4f75 7470 7574  le[Input, Output
-0001ee00: 5d29 3a0a 2020 2020 2222 2241 2072 756e  ]):.    """A run
-0001ee10: 6e61 626c 6520 7468 6174 2064 656c 6567  nable that deleg
-0001ee20: 6174 6573 2063 616c 6c73 2074 6f20 616e  ates calls to an
-0001ee30: 6f74 6865 7220 7275 6e6e 6162 6c65 2077  other runnable w
-0001ee40: 6974 6820 6120 7365 7420 6f66 206b 7761  ith a set of kwa
-0001ee50: 7267 732e 0a0a 2020 2020 5573 6520 6f6e  rgs...    Use on
-0001ee60: 6c79 2069 6620 6372 6561 7469 6e67 2061  ly if creating a
-0001ee70: 206e 6577 2052 756e 6e61 626c 6542 696e   new RunnableBin
-0001ee80: 6469 6e67 2073 7562 636c 6173 7320 7769  ding subclass wi
-0001ee90: 7468 2064 6966 6665 7265 6e74 205f 5f69  th different __i
-0001eea0: 6e69 745f 5f20 6172 6773 2e0a 0a20 2020  nit__ args...   
-0001eeb0: 2053 6565 2064 6f63 756d 656e 7461 7469   See documentati
-0001eec0: 6f6e 2066 6f72 2052 756e 6e61 626c 6542  on for RunnableB
-0001eed0: 696e 6469 6e67 2066 6f72 206d 6f72 6520  inding for more 
-0001eee0: 6465 7461 696c 732e 0a20 2020 2022 2222  details..    """
-0001eef0: 0a0a 2020 2020 626f 756e 643a 2052 756e  ..    bound: Run
-0001ef00: 6e61 626c 655b 496e 7075 742c 204f 7574  nable[Input, Out
-0001ef10: 7075 745d 0a20 2020 2022 2222 5468 6520  put].    """The 
-0001ef20: 756e 6465 726c 7969 6e67 2072 756e 6e61  underlying runna
-0001ef30: 626c 6520 7468 6174 2074 6869 7320 7275  ble that this ru
-0001ef40: 6e6e 6162 6c65 2064 656c 6567 6174 6573  nnable delegates
-0001ef50: 2074 6f2e 2222 220a 0a20 2020 206b 7761   to."""..    kwa
-0001ef60: 7267 733a 204d 6170 7069 6e67 5b73 7472  rgs: Mapping[str
-0001ef70: 2c20 416e 795d 203d 2046 6965 6c64 2864  , Any] = Field(d
-0001ef80: 6566 6175 6c74 5f66 6163 746f 7279 3d64  efault_factory=d
-0001ef90: 6963 7429 0a20 2020 2022 2222 6b77 6172  ict).    """kwar
-0001efa0: 6773 2074 6f20 7061 7373 2074 6f20 7468  gs to pass to th
-0001efb0: 6520 756e 6465 726c 7969 6e67 2072 756e  e underlying run
-0001efc0: 6e61 626c 6520 7768 656e 2072 756e 6e69  nable when runni
-0001efd0: 6e67 2e0a 0a20 2020 2046 6f72 2065 7861  ng...    For exa
-0001efe0: 6d70 6c65 2c20 7768 656e 2074 6865 2072  mple, when the r
-0001eff0: 756e 6e61 626c 6520 6269 6e64 696e 6720  unnable binding 
-0001f000: 6973 2069 6e76 6f6b 6564 2074 6865 2075  is invoked the u
-0001f010: 6e64 6572 6c79 696e 670a 2020 2020 7275  nderlying.    ru
-0001f020: 6e6e 6162 6c65 2077 696c 6c20 6265 2069  nnable will be i
-0001f030: 6e76 6f6b 6564 2077 6974 6820 7468 6520  nvoked with the 
-0001f040: 7361 6d65 2069 6e70 7574 2062 7574 2077  same input but w
-0001f050: 6974 6820 7468 6573 6520 6164 6469 7469  ith these additi
-0001f060: 6f6e 616c 0a20 2020 206b 7761 7267 732e  onal.    kwargs.
-0001f070: 0a20 2020 2022 2222 0a0a 2020 2020 636f  .    """..    co
-0001f080: 6e66 6967 3a20 5275 6e6e 6162 6c65 436f  nfig: RunnableCo
-0001f090: 6e66 6967 203d 2046 6965 6c64 2864 6566  nfig = Field(def
-0001f0a0: 6175 6c74 5f66 6163 746f 7279 3d64 6963  ault_factory=dic
-0001f0b0: 7429 0a20 2020 2022 2222 5468 6520 636f  t).    """The co
-0001f0c0: 6e66 6967 2074 6f20 6269 6e64 2074 6f20  nfig to bind to 
-0001f0d0: 7468 6520 756e 6465 726c 7969 6e67 2072  the underlying r
-0001f0e0: 756e 6e61 626c 652e 2222 220a 0a20 2020  unnable."""..   
-0001f0f0: 2063 6f6e 6669 675f 6661 6374 6f72 6965   config_factorie
-0001f100: 733a 204c 6973 745b 4361 6c6c 6162 6c65  s: List[Callable
-0001f110: 5b5b 5275 6e6e 6162 6c65 436f 6e66 6967  [[RunnableConfig
-0001f120: 5d2c 2052 756e 6e61 626c 6543 6f6e 6669  ], RunnableConfi
-0001f130: 675d 5d20 3d20 4669 656c 6428 0a20 2020  g]] = Field(.   
-0001f140: 2020 2020 2064 6566 6175 6c74 5f66 6163       default_fac
-0001f150: 746f 7279 3d6c 6973 740a 2020 2020 290a  tory=list.    ).
-0001f160: 2020 2020 2222 2254 6865 2063 6f6e 6669      """The confi
-0001f170: 6720 6661 6374 6f72 6965 7320 746f 2062  g factories to b
-0001f180: 696e 6420 746f 2074 6865 2075 6e64 6572  ind to the under
-0001f190: 6c79 696e 6720 7275 6e6e 6162 6c65 2e22  lying runnable."
-0001f1a0: 2222 0a0a 2020 2020 2320 556e 696f 6e5b  ""..    # Union[
-0001f1b0: 5479 7065 5b49 6e70 7574 5d2c 2042 6173  Type[Input], Bas
-0001f1c0: 654d 6f64 656c 5d20 2b20 7468 696e 6773  eModel] + things
-0001f1d0: 206c 696b 6520 4c69 7374 5b73 7472 5d0a   like List[str].
-0001f1e0: 2020 2020 6375 7374 6f6d 5f69 6e70 7574      custom_input
-0001f1f0: 5f74 7970 653a 204f 7074 696f 6e61 6c5b  _type: Optional[
-0001f200: 416e 795d 203d 204e 6f6e 650a 2020 2020  Any] = None.    
-0001f210: 2222 224f 7665 7272 6964 6520 7468 6520  """Override the 
-0001f220: 696e 7075 7420 7479 7065 206f 6620 7468  input type of th
-0001f230: 6520 756e 6465 726c 7969 6e67 2072 756e  e underlying run
-0001f240: 6e61 626c 6520 7769 7468 2061 2063 7573  nable with a cus
-0001f250: 746f 6d20 7479 7065 2e0a 0a20 2020 2054  tom type...    T
-0001f260: 6865 2074 7970 6520 6361 6e20 6265 2061  he type can be a
-0001f270: 2070 7964 616e 7469 6320 6d6f 6465 6c2c   pydantic model,
-0001f280: 206f 7220 6120 7479 7065 2061 6e6e 6f74   or a type annot
-0001f290: 6174 696f 6e20 2865 2e67 2e2c 2060 4c69  ation (e.g., `Li
-0001f2a0: 7374 5b73 7472 5d60 292e 0a20 2020 2022  st[str]`)..    "
-0001f2b0: 2222 0a20 2020 2023 2055 6e69 6f6e 5b54  "".    # Union[T
-0001f2c0: 7970 655b 4f75 7470 7574 5d2c 2042 6173  ype[Output], Bas
-0001f2d0: 654d 6f64 656c 5d20 2b20 7468 696e 6773  eModel] + things
-0001f2e0: 206c 696b 6520 4c69 7374 5b73 7472 5d0a   like List[str].
-0001f2f0: 2020 2020 6375 7374 6f6d 5f6f 7574 7075      custom_outpu
-0001f300: 745f 7479 7065 3a20 4f70 7469 6f6e 616c  t_type: Optional
-0001f310: 5b41 6e79 5d20 3d20 4e6f 6e65 0a20 2020  [Any] = None.   
-0001f320: 2022 2222 4f76 6572 7269 6465 2074 6865   """Override the
-0001f330: 206f 7574 7075 7420 7479 7065 206f 6620   output type of 
-0001f340: 7468 6520 756e 6465 726c 7969 6e67 2072  the underlying r
-0001f350: 756e 6e61 626c 6520 7769 7468 2061 2063  unnable with a c
-0001f360: 7573 746f 6d20 7479 7065 2e0a 0a20 2020  ustom type...   
-0001f370: 2054 6865 2074 7970 6520 6361 6e20 6265   The type can be
-0001f380: 2061 2070 7964 616e 7469 6320 6d6f 6465   a pydantic mode
-0001f390: 6c2c 206f 7220 6120 7479 7065 2061 6e6e  l, or a type ann
-0001f3a0: 6f74 6174 696f 6e20 2865 2e67 2e2c 2060  otation (e.g., `
-0001f3b0: 4c69 7374 5b73 7472 5d60 292e 0a20 2020  List[str]`)..   
-0001f3c0: 2022 2222 0a0a 2020 2020 636c 6173 7320   """..    class 
-0001f3d0: 436f 6e66 6967 3a0a 2020 2020 2020 2020  Config:.        
-0001f3e0: 6172 6269 7472 6172 795f 7479 7065 735f  arbitrary_types_
-0001f3f0: 616c 6c6f 7765 6420 3d20 5472 7565 0a0a  allowed = True..
-0001f400: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-0001f410: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-0001f420: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
-0001f430: 2020 2062 6f75 6e64 3a20 5275 6e6e 6162     bound: Runnab
-0001f440: 6c65 5b49 6e70 7574 2c20 4f75 7470 7574  le[Input, Output
-0001f450: 5d2c 0a20 2020 2020 2020 206b 7761 7267  ],.        kwarg
-0001f460: 733a 204f 7074 696f 6e61 6c5b 4d61 7070  s: Optional[Mapp
-0001f470: 696e 675b 7374 722c 2041 6e79 5d5d 203d  ing[str, Any]] =
-0001f480: 204e 6f6e 652c 0a20 2020 2020 2020 2063   None,.        c
-0001f490: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
-0001f4a0: 5275 6e6e 6162 6c65 436f 6e66 6967 5d20  RunnableConfig] 
-0001f4b0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-0001f4c0: 636f 6e66 6967 5f66 6163 746f 7269 6573  config_factories
-0001f4d0: 3a20 4f70 7469 6f6e 616c 5b0a 2020 2020  : Optional[.    
-0001f4e0: 2020 2020 2020 2020 4c69 7374 5b43 616c          List[Cal
-0001f4f0: 6c61 626c 655b 5b52 756e 6e61 626c 6543  lable[[RunnableC
-0001f500: 6f6e 6669 675d 2c20 5275 6e6e 6162 6c65  onfig], Runnable
-0001f510: 436f 6e66 6967 5d5d 0a20 2020 2020 2020  Config]].       
-0001f520: 205d 203d 204e 6f6e 652c 0a20 2020 2020   ] = None,.     
-0001f530: 2020 2063 7573 746f 6d5f 696e 7075 745f     custom_input_
-0001f540: 7479 7065 3a20 4f70 7469 6f6e 616c 5b55  type: Optional[U
-0001f550: 6e69 6f6e 5b54 7970 655b 496e 7075 745d  nion[Type[Input]
-0001f560: 2c20 4261 7365 4d6f 6465 6c5d 5d20 3d20  , BaseModel]] = 
-0001f570: 4e6f 6e65 2c0a 2020 2020 2020 2020 6375  None,.        cu
-0001f580: 7374 6f6d 5f6f 7574 7075 745f 7479 7065  stom_output_type
-0001f590: 3a20 4f70 7469 6f6e 616c 5b55 6e69 6f6e  : Optional[Union
-0001f5a0: 5b54 7970 655b 4f75 7470 7574 5d2c 2042  [Type[Output], B
-0001f5b0: 6173 654d 6f64 656c 5d5d 203d 204e 6f6e  aseModel]] = Non
-0001f5c0: 652c 0a20 2020 2020 2020 202a 2a6f 7468  e,.        **oth
-0001f5d0: 6572 5f6b 7761 7267 733a 2041 6e79 2c0a  er_kwargs: Any,.
-0001f5e0: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
-0001f5f0: 2020 2020 2020 2022 2222 4372 6561 7465         """Create
-0001f600: 2061 2052 756e 6e61 626c 6542 696e 6469   a RunnableBindi
-0001f610: 6e67 2066 726f 6d20 6120 7275 6e6e 6162  ng from a runnab
-0001f620: 6c65 2061 6e64 206b 7761 7267 732e 0a0a  le and kwargs...
-0001f630: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
-0001f640: 2020 2020 2020 2020 2020 626f 756e 643a            bound:
-0001f650: 2054 6865 2075 6e64 6572 6c79 696e 6720   The underlying 
-0001f660: 7275 6e6e 6162 6c65 2074 6861 7420 7468  runnable that th
-0001f670: 6973 2072 756e 6e61 626c 6520 6465 6c65  is runnable dele
-0001f680: 6761 7465 7320 6361 6c6c 7320 746f 2e0a  gates calls to..
-0001f690: 2020 2020 2020 2020 2020 2020 6b77 6172              kwar
-0001f6a0: 6773 3a20 6f70 7469 6f6e 616c 206b 7761  gs: optional kwa
-0001f6b0: 7267 7320 746f 2070 6173 7320 746f 2074  rgs to pass to t
-0001f6c0: 6865 2075 6e64 6572 6c79 696e 6720 7275  he underlying ru
-0001f6d0: 6e6e 6162 6c65 2c20 7768 656e 2072 756e  nnable, when run
-0001f6e0: 6e69 6e67 0a20 2020 2020 2020 2020 2020  ning.           
-0001f6f0: 2020 2020 2020 2020 2074 6865 2075 6e64           the und
-0001f700: 6572 6c79 696e 6720 7275 6e6e 6162 6c65  erlying runnable
-0001f710: 2028 652e 672e 2c20 7669 6120 6069 6e76   (e.g., via `inv
-0001f720: 6f6b 6560 2c20 6062 6174 6368 602c 0a20  oke`, `batch`,. 
-0001f730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f740: 2020 2060 7472 616e 7366 6f72 6d60 2c20     `transform`, 
-0001f750: 6f72 2060 7374 7265 616d 6020 6f72 2061  or `stream` or a
-0001f760: 7379 6e63 2076 6172 6961 6e74 7329 0a20  sync variants). 
-0001f770: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
-0001f780: 673a 2063 6f6e 6669 675f 6661 6374 6f72  g: config_factor
-0001f790: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
-0001f7a0: 2063 6f6e 6669 675f 6661 6374 6f72 6965   config_factorie
-0001f7b0: 733a 206f 7074 696f 6e61 6c20 6c69 7374  s: optional list
-0001f7c0: 206f 6620 636f 6e66 6967 2066 6163 746f   of config facto
-0001f7d0: 7269 6573 2074 6f20 6170 706c 7920 746f  ries to apply to
-0001f7e0: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
-0001f7f0: 2063 7573 746f 6d5f 696e 7075 745f 7479   custom_input_ty
-0001f800: 7065 3a20 5370 6563 6966 7920 746f 206f  pe: Specify to o
-0001f810: 7665 7272 6964 6520 7468 6520 696e 7075  verride the inpu
-0001f820: 7420 7479 7065 206f 6620 7468 6520 756e  t type of the un
-0001f830: 6465 726c 7969 6e67 0a20 2020 2020 2020  derlying.       
-0001f840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f850: 2020 2020 2020 2020 7275 6e6e 6162 6c65          runnable
-0001f860: 2077 6974 6820 6120 6375 7374 6f6d 2074   with a custom t
-0001f870: 7970 652e 0a20 2020 2020 2020 2020 2020  ype..           
-0001f880: 2063 7573 746f 6d5f 6f75 7470 7574 5f74   custom_output_t
-0001f890: 7970 653a 2053 7065 6369 6679 2074 6f20  ype: Specify to 
-0001f8a0: 6f76 6572 7269 6465 2074 6865 206f 7574  override the out
-0001f8b0: 7075 7420 7479 7065 206f 6620 7468 6520  put type of the 
-0001f8c0: 756e 6465 726c 7969 6e67 0a20 2020 2020  underlying.     
-0001f8d0: 2020 2020 2020 2020 2020 2072 756e 6e61             runna
-0001f8e0: 626c 6520 7769 7468 2061 2063 7573 746f  ble with a custo
-0001f8f0: 6d20 7479 7065 2e0a 2020 2020 2020 2020  m type..        
-0001f900: 2020 2020 2a2a 6f74 6865 725f 6b77 6172      **other_kwar
-0001f910: 6773 3a20 556e 7061 636b 6564 2069 6e74  gs: Unpacked int
-0001f920: 6f20 7468 6520 6261 7365 2063 6c61 7373  o the base class
-0001f930: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-0001f940: 2020 2020 2020 636f 6e66 6967 203d 2063        config = c
-0001f950: 6f6e 6669 6720 6f72 207b 7d0a 2020 2020  onfig or {}.    
-0001f960: 2020 2020 2320 636f 6e66 6967 5f73 7065      # config_spe
-0001f970: 6373 2063 6f6e 7461 696e 7320 7468 6520  cs contains the 
-0001f980: 6c69 7374 206f 6620 7661 6c69 6420 6063  list of valid `c
-0001f990: 6f6e 6669 6775 7261 626c 6560 206b 6579  onfigurable` key
-0001f9a0: 730a 2020 2020 2020 2020 6966 2063 6f6e  s.        if con
-0001f9b0: 6669 6775 7261 626c 6520 3a3d 2063 6f6e  figurable := con
-0001f9c0: 6669 672e 6765 7428 2263 6f6e 6669 6775  fig.get("configu
-0001f9d0: 7261 626c 6522 2c20 4e6f 6e65 293a 0a20  rable", None):. 
-0001f9e0: 2020 2020 2020 2020 2020 2061 6c6c 6f77             allow
-0001f9f0: 6564 5f6b 6579 7320 3d20 7365 7428 732e  ed_keys = set(s.
-0001fa00: 6964 2066 6f72 2073 2069 6e20 626f 756e  id for s in boun
-0001fa10: 642e 636f 6e66 6967 5f73 7065 6373 290a  d.config_specs).
-0001fa20: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0001fa30: 6b65 7920 696e 2063 6f6e 6669 6775 7261  key in configura
-0001fa40: 626c 653a 0a20 2020 2020 2020 2020 2020  ble:.           
-0001fa50: 2020 2020 2069 6620 6b65 7920 6e6f 7420       if key not 
-0001fa60: 696e 2061 6c6c 6f77 6564 5f6b 6579 733a  in allowed_keys:
-0001fa70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fa80: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-0001fa90: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-0001faa0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001fab0: 2243 6f6e 6669 6775 7261 626c 6520 6b65  "Configurable ke
-0001fac0: 7920 277b 6b65 797d 2720 6e6f 7420 666f  y '{key}' not fo
-0001fad0: 756e 6420 696e 2072 756e 6e61 626c 6520  und in runnable 
-0001fae0: 7769 7468 220a 2020 2020 2020 2020 2020  with".          
-0001faf0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0001fb00: 2063 6f6e 6669 6720 6b65 7973 3a20 7b61   config keys: {a
-0001fb10: 6c6c 6f77 6564 5f6b 6579 737d 220a 2020  llowed_keys}".  
-0001fb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fb30: 2020 290a 2020 2020 2020 2020 7375 7065    ).        supe
-0001fb40: 7228 292e 5f5f 696e 6974 5f5f 280a 2020  r().__init__(.  
-0001fb50: 2020 2020 2020 2020 2020 626f 756e 643d            bound=
-0001fb60: 626f 756e 642c 0a20 2020 2020 2020 2020  bound,.         
-0001fb70: 2020 206b 7761 7267 733d 6b77 6172 6773     kwargs=kwargs
-0001fb80: 206f 7220 7b7d 2c0a 2020 2020 2020 2020   or {},.        
-0001fb90: 2020 2020 636f 6e66 6967 3d63 6f6e 6669      config=confi
-0001fba0: 6720 6f72 207b 7d2c 0a20 2020 2020 2020  g or {},.       
-0001fbb0: 2020 2020 2063 6f6e 6669 675f 6661 6374       config_fact
-0001fbc0: 6f72 6965 733d 636f 6e66 6967 5f66 6163  ories=config_fac
-0001fbd0: 746f 7269 6573 206f 7220 5b5d 2c0a 2020  tories or [],.  
-0001fbe0: 2020 2020 2020 2020 2020 6375 7374 6f6d            custom
-0001fbf0: 5f69 6e70 7574 5f74 7970 653d 6375 7374  _input_type=cust
-0001fc00: 6f6d 5f69 6e70 7574 5f74 7970 652c 0a20  om_input_type,. 
-0001fc10: 2020 2020 2020 2020 2020 2063 7573 746f             custo
-0001fc20: 6d5f 6f75 7470 7574 5f74 7970 653d 6375  m_output_type=cu
-0001fc30: 7374 6f6d 5f6f 7574 7075 745f 7479 7065  stom_output_type
-0001fc40: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
-0001fc50: 6f74 6865 725f 6b77 6172 6773 2c0a 2020  other_kwargs,.  
-0001fc60: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-0001fc70: 2067 6574 5f6e 616d 6528 0a20 2020 2020   get_name(.     
-0001fc80: 2020 2073 656c 662c 2073 7566 6669 783a     self, suffix:
-0001fc90: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-0001fca0: 204e 6f6e 652c 202a 2c20 6e61 6d65 3a20   None, *, name: 
-0001fcb0: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
-0001fcc0: 4e6f 6e65 0a20 2020 2029 202d 3e20 7374  None.    ) -> st
-0001fcd0: 723a 0a20 2020 2020 2020 2072 6574 7572  r:.        retur
-0001fce0: 6e20 7365 6c66 2e62 6f75 6e64 2e67 6574  n self.bound.get
-0001fcf0: 5f6e 616d 6528 7375 6666 6978 2c20 6e61  _name(suffix, na
-0001fd00: 6d65 3d6e 616d 6529 0a0a 2020 2020 4070  me=name)..    @p
-0001fd10: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-0001fd20: 496e 7075 7454 7970 6528 7365 6c66 2920  InputType(self) 
-0001fd30: 2d3e 2054 7970 655b 496e 7075 745d 3a0a  -> Type[Input]:.
-0001fd40: 2020 2020 2020 2020 7265 7475 726e 2028          return (
-0001fd50: 0a20 2020 2020 2020 2020 2020 2063 6173  .            cas
-0001fd60: 7428 5479 7065 5b49 6e70 7574 5d2c 2073  t(Type[Input], s
-0001fd70: 656c 662e 6375 7374 6f6d 5f69 6e70 7574  elf.custom_input
-0001fd80: 5f74 7970 6529 0a20 2020 2020 2020 2020  _type).         
-0001fd90: 2020 2069 6620 7365 6c66 2e63 7573 746f     if self.custo
-0001fda0: 6d5f 696e 7075 745f 7479 7065 2069 7320  m_input_type is 
-0001fdb0: 6e6f 7420 4e6f 6e65 0a20 2020 2020 2020  not None.       
-0001fdc0: 2020 2020 2065 6c73 6520 7365 6c66 2e62       else self.b
-0001fdd0: 6f75 6e64 2e49 6e70 7574 5479 7065 0a20  ound.InputType. 
-0001fde0: 2020 2020 2020 2029 0a0a 2020 2020 4070         )..    @p
-0001fdf0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-0001fe00: 4f75 7470 7574 5479 7065 2873 656c 6629  OutputType(self)
-0001fe10: 202d 3e20 5479 7065 5b4f 7574 7075 745d   -> Type[Output]
-0001fe20: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0001fe30: 2028 0a20 2020 2020 2020 2020 2020 2063   (.            c
-0001fe40: 6173 7428 5479 7065 5b4f 7574 7075 745d  ast(Type[Output]
-0001fe50: 2c20 7365 6c66 2e63 7573 746f 6d5f 6f75  , self.custom_ou
-0001fe60: 7470 7574 5f74 7970 6529 0a20 2020 2020  tput_type).     
-0001fe70: 2020 2020 2020 2069 6620 7365 6c66 2e63         if self.c
-0001fe80: 7573 746f 6d5f 6f75 7470 7574 5f74 7970  ustom_output_typ
-0001fe90: 6520 6973 206e 6f74 204e 6f6e 650a 2020  e is not None.  
-0001fea0: 2020 2020 2020 2020 2020 656c 7365 2073            else s
-0001feb0: 656c 662e 626f 756e 642e 4f75 7470 7574  elf.bound.Output
-0001fec0: 5479 7065 0a20 2020 2020 2020 2029 0a0a  Type.        )..
-0001fed0: 2020 2020 6465 6620 6765 745f 696e 7075      def get_inpu
-0001fee0: 745f 7363 6865 6d61 280a 2020 2020 2020  t_schema(.      
-0001fef0: 2020 7365 6c66 2c20 636f 6e66 6967 3a20    self, config: 
-0001ff00: 4f70 7469 6f6e 616c 5b52 756e 6e61 626c  Optional[Runnabl
-0001ff10: 6543 6f6e 6669 675d 203d 204e 6f6e 650a  eConfig] = None.
-0001ff20: 2020 2020 2920 2d3e 2054 7970 655b 4261      ) -> Type[Ba
-0001ff30: 7365 4d6f 6465 6c5d 3a0a 2020 2020 2020  seModel]:.      
-0001ff40: 2020 6966 2073 656c 662e 6375 7374 6f6d    if self.custom
-0001ff50: 5f69 6e70 7574 5f74 7970 6520 6973 206e  _input_type is n
-0001ff60: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0001ff70: 2020 2020 2072 6574 7572 6e20 7375 7065       return supe
-0001ff80: 7228 292e 6765 745f 696e 7075 745f 7363  r().get_input_sc
-0001ff90: 6865 6d61 2863 6f6e 6669 6729 0a20 2020  hema(config).   
-0001ffa0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0001ffb0: 2e62 6f75 6e64 2e67 6574 5f69 6e70 7574  .bound.get_input
-0001ffc0: 5f73 6368 656d 6128 6d65 7267 655f 636f  _schema(merge_co
-0001ffd0: 6e66 6967 7328 7365 6c66 2e63 6f6e 6669  nfigs(self.confi
-0001ffe0: 672c 2063 6f6e 6669 6729 290a 0a20 2020  g, config))..   
-0001fff0: 2064 6566 2067 6574 5f6f 7574 7075 745f   def get_output_
-00020000: 7363 6865 6d61 280a 2020 2020 2020 2020  schema(.        
-00020010: 7365 6c66 2c20 636f 6e66 6967 3a20 4f70  self, config: Op
-00020020: 7469 6f6e 616c 5b52 756e 6e61 626c 6543  tional[RunnableC
-00020030: 6f6e 6669 675d 203d 204e 6f6e 650a 2020  onfig] = None.  
-00020040: 2020 2920 2d3e 2054 7970 655b 4261 7365    ) -> Type[Base
-00020050: 4d6f 6465 6c5d 3a0a 2020 2020 2020 2020  Model]:.        
-00020060: 6966 2073 656c 662e 6375 7374 6f6d 5f6f  if self.custom_o
-00020070: 7574 7075 745f 7479 7065 2069 7320 6e6f  utput_type is no
-00020080: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00020090: 2020 2020 7265 7475 726e 2073 7570 6572      return super
-000200a0: 2829 2e67 6574 5f6f 7574 7075 745f 7363  ().get_output_sc
-000200b0: 6865 6d61 2863 6f6e 6669 6729 0a20 2020  hema(config).   
-000200c0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-000200d0: 2e62 6f75 6e64 2e67 6574 5f6f 7574 7075  .bound.get_outpu
-000200e0: 745f 7363 6865 6d61 286d 6572 6765 5f63  t_schema(merge_c
-000200f0: 6f6e 6669 6773 2873 656c 662e 636f 6e66  onfigs(self.conf
-00020100: 6967 2c20 636f 6e66 6967 2929 0a0a 2020  ig, config))..  
-00020110: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00020120: 6465 6620 636f 6e66 6967 5f73 7065 6373  def config_specs
-00020130: 2873 656c 6629 202d 3e20 4c69 7374 5b43  (self) -> List[C
-00020140: 6f6e 6669 6775 7261 626c 6546 6965 6c64  onfigurableField
-00020150: 5370 6563 5d3a 0a20 2020 2020 2020 2072  Spec]:.        r
-00020160: 6574 7572 6e20 7365 6c66 2e62 6f75 6e64  eturn self.bound
-00020170: 2e63 6f6e 6669 675f 7370 6563 730a 0a20  .config_specs.. 
-00020180: 2020 2064 6566 2067 6574 5f67 7261 7068     def get_graph
-00020190: 2873 656c 662c 2063 6f6e 6669 673a 204f  (self, config: O
-000201a0: 7074 696f 6e61 6c5b 5275 6e6e 6162 6c65  ptional[Runnable
-000201b0: 436f 6e66 6967 5d20 3d20 4e6f 6e65 2920  Config] = None) 
-000201c0: 2d3e 2047 7261 7068 3a0a 2020 2020 2020  -> Graph:.      
-000201d0: 2020 7265 7475 726e 2073 656c 662e 626f    return self.bo
-000201e0: 756e 642e 6765 745f 6772 6170 6828 636f  und.get_graph(co
-000201f0: 6e66 6967 290a 0a20 2020 2040 636c 6173  nfig)..    @clas
-00020200: 736d 6574 686f 640a 2020 2020 6465 6620  smethod.    def 
-00020210: 6973 5f6c 635f 7365 7269 616c 697a 6162  is_lc_serializab
-00020220: 6c65 2863 6c73 2920 2d3e 2062 6f6f 6c3a  le(cls) -> bool:
-00020230: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00020240: 5472 7565 0a0a 2020 2020 4063 6c61 7373  True..    @class
-00020250: 6d65 7468 6f64 0a20 2020 2064 6566 2067  method.    def g
-00020260: 6574 5f6c 635f 6e61 6d65 7370 6163 6528  et_lc_namespace(
-00020270: 636c 7329 202d 3e20 4c69 7374 5b73 7472  cls) -> List[str
-00020280: 5d3a 0a20 2020 2020 2020 2022 2222 4765  ]:.        """Ge
-00020290: 7420 7468 6520 6e61 6d65 7370 6163 6520  t the namespace 
-000202a0: 6f66 2074 6865 206c 616e 6763 6861 696e  of the langchain
-000202b0: 206f 626a 6563 742e 2222 220a 2020 2020   object.""".    
-000202c0: 2020 2020 7265 7475 726e 205b 226c 616e      return ["lan
-000202d0: 6763 6861 696e 222c 2022 7363 6865 6d61  gchain", "schema
-000202e0: 222c 2022 7275 6e6e 6162 6c65 225d 0a0a  ", "runnable"]..
-000202f0: 2020 2020 6465 6620 5f6d 6572 6765 5f63      def _merge_c
-00020300: 6f6e 6669 6773 2873 656c 662c 202a 636f  onfigs(self, *co
-00020310: 6e66 6967 733a 204f 7074 696f 6e61 6c5b  nfigs: Optional[
-00020320: 5275 6e6e 6162 6c65 436f 6e66 6967 5d29  RunnableConfig])
-00020330: 202d 3e20 5275 6e6e 6162 6c65 436f 6e66   -> RunnableConf
-00020340: 6967 3a0a 2020 2020 2020 2020 636f 6e66  ig:.        conf
-00020350: 6967 203d 206d 6572 6765 5f63 6f6e 6669  ig = merge_confi
-00020360: 6773 2873 656c 662e 636f 6e66 6967 2c20  gs(self.config, 
-00020370: 2a63 6f6e 6669 6773 290a 2020 2020 2020  *configs).      
-00020380: 2020 7265 7475 726e 206d 6572 6765 5f63    return merge_c
-00020390: 6f6e 6669 6773 2863 6f6e 6669 672c 202a  onfigs(config, *
-000203a0: 2866 2863 6f6e 6669 6729 2066 6f72 2066  (f(config) for f
-000203b0: 2069 6e20 7365 6c66 2e63 6f6e 6669 675f   in self.config_
-000203c0: 6661 6374 6f72 6965 7329 290a 0a20 2020  factories))..   
-000203d0: 2064 6566 2069 6e76 6f6b 6528 0a20 2020   def invoke(.   
-000203e0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-000203f0: 2020 2069 6e70 7574 3a20 496e 7075 742c     input: Input,
-00020400: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
-00020410: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
-00020420: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
-00020430: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
-00020440: 6773 3a20 4f70 7469 6f6e 616c 5b41 6e79  gs: Optional[Any
-00020450: 5d2c 0a20 2020 2029 202d 3e20 4f75 7470  ],.    ) -> Outp
-00020460: 7574 3a0a 2020 2020 2020 2020 7265 7475  ut:.        retu
-00020470: 726e 2073 656c 662e 626f 756e 642e 696e  rn self.bound.in
-00020480: 766f 6b65 280a 2020 2020 2020 2020 2020  voke(.          
-00020490: 2020 696e 7075 742c 0a20 2020 2020 2020    input,.       
-000204a0: 2020 2020 2073 656c 662e 5f6d 6572 6765       self._merge
-000204b0: 5f63 6f6e 6669 6773 2863 6f6e 6669 6729  _configs(config)
-000204c0: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
-000204d0: 7b2a 2a73 656c 662e 6b77 6172 6773 2c20  {**self.kwargs, 
-000204e0: 2a2a 6b77 6172 6773 7d2c 0a20 2020 2020  **kwargs},.     
-000204f0: 2020 2029 0a0a 2020 2020 6173 796e 6320     )..    async 
-00020500: 6465 6620 6169 6e76 6f6b 6528 0a20 2020  def ainvoke(.   
-00020510: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00020520: 2020 2069 6e70 7574 3a20 496e 7075 742c     input: Input,
-00020530: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
-00020540: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
-00020550: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
-00020560: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
-00020570: 6773 3a20 4f70 7469 6f6e 616c 5b41 6e79  gs: Optional[Any
-00020580: 5d2c 0a20 2020 2029 202d 3e20 4f75 7470  ],.    ) -> Outp
-00020590: 7574 3a0a 2020 2020 2020 2020 7265 7475  ut:.        retu
-000205a0: 726e 2061 7761 6974 2073 656c 662e 626f  rn await self.bo
-000205b0: 756e 642e 6169 6e76 6f6b 6528 0a20 2020  und.ainvoke(.   
-000205c0: 2020 2020 2020 2020 2069 6e70 7574 2c0a           input,.
-000205d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000205e0: 2e5f 6d65 7267 655f 636f 6e66 6967 7328  ._merge_configs(
-000205f0: 636f 6e66 6967 292c 0a20 2020 2020 2020  config),.       
-00020600: 2020 2020 202a 2a7b 2a2a 7365 6c66 2e6b       **{**self.k
-00020610: 7761 7267 732c 202a 2a6b 7761 7267 737d  wargs, **kwargs}
-00020620: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-00020630: 2064 6566 2062 6174 6368 280a 2020 2020   def batch(.    
-00020640: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00020650: 2020 696e 7075 7473 3a20 4c69 7374 5b49    inputs: List[I
-00020660: 6e70 7574 5d2c 0a20 2020 2020 2020 2063  nput],.        c
-00020670: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
-00020680: 556e 696f 6e5b 5275 6e6e 6162 6c65 436f  Union[RunnableCo
-00020690: 6e66 6967 2c20 4c69 7374 5b52 756e 6e61  nfig, List[Runna
-000206a0: 626c 6543 6f6e 6669 675d 5d5d 203d 204e  bleConfig]]] = N
-000206b0: 6f6e 652c 0a20 2020 2020 2020 202a 2c0a  one,.        *,.
-000206c0: 2020 2020 2020 2020 7265 7475 726e 5f65          return_e
-000206d0: 7863 6570 7469 6f6e 733a 2062 6f6f 6c20  xceptions: bool 
-000206e0: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
-000206f0: 202a 2a6b 7761 7267 733a 204f 7074 696f   **kwargs: Optio
-00020700: 6e61 6c5b 416e 795d 2c0a 2020 2020 2920  nal[Any],.    ) 
-00020710: 2d3e 204c 6973 745b 4f75 7470 7574 5d3a  -> List[Output]:
-00020720: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-00020730: 7374 616e 6365 2863 6f6e 6669 672c 206c  stance(config, l
-00020740: 6973 7429 3a0a 2020 2020 2020 2020 2020  ist):.          
-00020750: 2020 636f 6e66 6967 7320 3d20 6361 7374    configs = cast
-00020760: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00020770: 2020 4c69 7374 5b52 756e 6e61 626c 6543    List[RunnableC
-00020780: 6f6e 6669 675d 2c0a 2020 2020 2020 2020  onfig],.        
-00020790: 2020 2020 2020 2020 5b73 656c 662e 5f6d          [self._m
-000207a0: 6572 6765 5f63 6f6e 6669 6773 2863 6f6e  erge_configs(con
-000207b0: 6629 2066 6f72 2063 6f6e 6620 696e 2063  f) for conf in c
-000207c0: 6f6e 6669 675d 2c0a 2020 2020 2020 2020  onfig],.        
-000207d0: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
-000207e0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000207f0: 636f 6e66 6967 7320 3d20 5b73 656c 662e  configs = [self.
-00020800: 5f6d 6572 6765 5f63 6f6e 6669 6773 2863  _merge_configs(c
-00020810: 6f6e 6669 6729 2066 6f72 205f 2069 6e20  onfig) for _ in 
-00020820: 7261 6e67 6528 6c65 6e28 696e 7075 7473  range(len(inputs
-00020830: 2929 5d0a 2020 2020 2020 2020 7265 7475  ))].        retu
-00020840: 726e 2073 656c 662e 626f 756e 642e 6261  rn self.bound.ba
-00020850: 7463 6828 0a20 2020 2020 2020 2020 2020  tch(.           
-00020860: 2069 6e70 7574 732c 0a20 2020 2020 2020   inputs,.       
-00020870: 2020 2020 2063 6f6e 6669 6773 2c0a 2020       configs,.  
-00020880: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00020890: 5f65 7863 6570 7469 6f6e 733d 7265 7475  _exceptions=retu
-000208a0: 726e 5f65 7863 6570 7469 6f6e 732c 0a20  rn_exceptions,. 
-000208b0: 2020 2020 2020 2020 2020 202a 2a7b 2a2a             **{**
-000208c0: 7365 6c66 2e6b 7761 7267 732c 202a 2a6b  self.kwargs, **k
-000208d0: 7761 7267 737d 2c0a 2020 2020 2020 2020  wargs},.        
-000208e0: 290a 0a20 2020 2061 7379 6e63 2064 6566  )..    async def
-000208f0: 2061 6261 7463 6828 0a20 2020 2020 2020   abatch(.       
-00020900: 2073 656c 662c 0a20 2020 2020 2020 2069   self,.        i
-00020910: 6e70 7574 733a 204c 6973 745b 496e 7075  nputs: List[Inpu
-00020920: 745d 2c0a 2020 2020 2020 2020 636f 6e66  t],.        conf
-00020930: 6967 3a20 4f70 7469 6f6e 616c 5b55 6e69  ig: Optional[Uni
-00020940: 6f6e 5b52 756e 6e61 626c 6543 6f6e 6669  on[RunnableConfi
-00020950: 672c 204c 6973 745b 5275 6e6e 6162 6c65  g, List[Runnable
-00020960: 436f 6e66 6967 5d5d 5d20 3d20 4e6f 6e65  Config]]] = None
-00020970: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
-00020980: 2020 2020 2072 6574 7572 6e5f 6578 6365       return_exce
-00020990: 7074 696f 6e73 3a20 626f 6f6c 203d 2046  ptions: bool = F
-000209a0: 616c 7365 2c0a 2020 2020 2020 2020 2a2a  alse,.        **
-000209b0: 6b77 6172 6773 3a20 4f70 7469 6f6e 616c  kwargs: Optional
-000209c0: 5b41 6e79 5d2c 0a20 2020 2029 202d 3e20  [Any],.    ) -> 
-000209d0: 4c69 7374 5b4f 7574 7075 745d 3a0a 2020  List[Output]:.  
-000209e0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-000209f0: 6e63 6528 636f 6e66 6967 2c20 6c69 7374  nce(config, list
-00020a00: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-00020a10: 6f6e 6669 6773 203d 2063 6173 7428 0a20  onfigs = cast(. 
-00020a20: 2020 2020 2020 2020 2020 2020 2020 204c                 L
-00020a30: 6973 745b 5275 6e6e 6162 6c65 436f 6e66  ist[RunnableConf
-00020a40: 6967 5d2c 0a20 2020 2020 2020 2020 2020  ig],.           
-00020a50: 2020 2020 205b 7365 6c66 2e5f 6d65 7267       [self._merg
-00020a60: 655f 636f 6e66 6967 7328 636f 6e66 2920  e_configs(conf) 
-00020a70: 666f 7220 636f 6e66 2069 6e20 636f 6e66  for conf in conf
-00020a80: 6967 5d2c 0a20 2020 2020 2020 2020 2020  ig],.           
-00020a90: 2029 0a20 2020 2020 2020 2065 6c73 653a   ).        else:
-00020aa0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00020ab0: 6669 6773 203d 205b 7365 6c66 2e5f 6d65  figs = [self._me
-00020ac0: 7267 655f 636f 6e66 6967 7328 636f 6e66  rge_configs(conf
-00020ad0: 6967 2920 666f 7220 5f20 696e 2072 616e  ig) for _ in ran
-00020ae0: 6765 286c 656e 2869 6e70 7574 7329 295d  ge(len(inputs))]
-00020af0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00020b00: 6177 6169 7420 7365 6c66 2e62 6f75 6e64  await self.bound
-00020b10: 2e61 6261 7463 6828 0a20 2020 2020 2020  .abatch(.       
-00020b20: 2020 2020 2069 6e70 7574 732c 0a20 2020       inputs,.   
-00020b30: 2020 2020 2020 2020 2063 6f6e 6669 6773           configs
-00020b40: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
-00020b50: 7475 726e 5f65 7863 6570 7469 6f6e 733d  turn_exceptions=
-00020b60: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
-00020b70: 732c 0a20 2020 2020 2020 2020 2020 202a  s,.            *
-00020b80: 2a7b 2a2a 7365 6c66 2e6b 7761 7267 732c  *{**self.kwargs,
-00020b90: 202a 2a6b 7761 7267 737d 2c0a 2020 2020   **kwargs},.    
-00020ba0: 2020 2020 290a 0a20 2020 2064 6566 2073      )..    def s
-00020bb0: 7472 6561 6d28 0a20 2020 2020 2020 2073  tream(.        s
-00020bc0: 656c 662c 0a20 2020 2020 2020 2069 6e70  elf,.        inp
-00020bd0: 7574 3a20 496e 7075 742c 0a20 2020 2020  ut: Input,.     
-00020be0: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
-00020bf0: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-00020c00: 6967 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ig] = None,.    
-00020c10: 2020 2020 2a2a 6b77 6172 6773 3a20 4f70      **kwargs: Op
-00020c20: 7469 6f6e 616c 5b41 6e79 5d2c 0a20 2020  tional[Any],.   
-00020c30: 2029 202d 3e20 4974 6572 6174 6f72 5b4f   ) -> Iterator[O
-00020c40: 7574 7075 745d 3a0a 2020 2020 2020 2020  utput]:.        
-00020c50: 7969 656c 6420 6672 6f6d 2073 656c 662e  yield from self.
-00020c60: 626f 756e 642e 7374 7265 616d 280a 2020  bound.stream(.  
-00020c70: 2020 2020 2020 2020 2020 696e 7075 742c            input,
-00020c80: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00020c90: 662e 5f6d 6572 6765 5f63 6f6e 6669 6773  f._merge_configs
-00020ca0: 2863 6f6e 6669 6729 2c0a 2020 2020 2020  (config),.      
-00020cb0: 2020 2020 2020 2a2a 7b2a 2a73 656c 662e        **{**self.
-00020cc0: 6b77 6172 6773 2c20 2a2a 6b77 6172 6773  kwargs, **kwargs
-00020cd0: 7d2c 0a20 2020 2020 2020 2029 0a0a 2020  },.        )..  
-00020ce0: 2020 6173 796e 6320 6465 6620 6173 7472    async def astr
-00020cf0: 6561 6d28 0a20 2020 2020 2020 2073 656c  eam(.        sel
-00020d00: 662c 0a20 2020 2020 2020 2069 6e70 7574  f,.        input
-00020d10: 3a20 496e 7075 742c 0a20 2020 2020 2020  : Input,.       
-00020d20: 2063 6f6e 6669 673a 204f 7074 696f 6e61   config: Optiona
-00020d30: 6c5b 5275 6e6e 6162 6c65 436f 6e66 6967  l[RunnableConfig
-00020d40: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-00020d50: 2020 2a2a 6b77 6172 6773 3a20 4f70 7469    **kwargs: Opti
-00020d60: 6f6e 616c 5b41 6e79 5d2c 0a20 2020 2029  onal[Any],.    )
-00020d70: 202d 3e20 4173 796e 6349 7465 7261 746f   -> AsyncIterato
-00020d80: 725b 4f75 7470 7574 5d3a 0a20 2020 2020  r[Output]:.     
-00020d90: 2020 2061 7379 6e63 2066 6f72 2069 7465     async for ite
-00020da0: 6d20 696e 2073 656c 662e 626f 756e 642e  m in self.bound.
-00020db0: 6173 7472 6561 6d28 0a20 2020 2020 2020  astream(.       
-00020dc0: 2020 2020 2069 6e70 7574 2c0a 2020 2020       input,.    
-00020dd0: 2020 2020 2020 2020 7365 6c66 2e5f 6d65          self._me
-00020de0: 7267 655f 636f 6e66 6967 7328 636f 6e66  rge_configs(conf
-00020df0: 6967 292c 0a20 2020 2020 2020 2020 2020  ig),.           
-00020e00: 202a 2a7b 2a2a 7365 6c66 2e6b 7761 7267   **{**self.kwarg
-00020e10: 732c 202a 2a6b 7761 7267 737d 2c0a 2020  s, **kwargs},.  
-00020e20: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
-00020e30: 2020 2020 2079 6965 6c64 2069 7465 6d0a       yield item.
-00020e40: 0a20 2020 2064 6566 2074 7261 6e73 666f  .    def transfo
-00020e50: 726d 280a 2020 2020 2020 2020 7365 6c66  rm(.        self
-00020e60: 2c0a 2020 2020 2020 2020 696e 7075 743a  ,.        input:
-00020e70: 2049 7465 7261 746f 725b 496e 7075 745d   Iterator[Input]
-00020e80: 2c0a 2020 2020 2020 2020 636f 6e66 6967  ,.        config
-00020e90: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
-00020ea0: 626c 6543 6f6e 6669 675d 203d 204e 6f6e  bleConfig] = Non
-00020eb0: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
-00020ec0: 7267 733a 2041 6e79 2c0a 2020 2020 2920  rgs: Any,.    ) 
-00020ed0: 2d3e 2049 7465 7261 746f 725b 4f75 7470  -> Iterator[Outp
-00020ee0: 7574 5d3a 0a20 2020 2020 2020 2079 6965  ut]:.        yie
-00020ef0: 6c64 2066 726f 6d20 7365 6c66 2e62 6f75  ld from self.bou
-00020f00: 6e64 2e74 7261 6e73 666f 726d 280a 2020  nd.transform(.  
-00020f10: 2020 2020 2020 2020 2020 696e 7075 742c            input,
-00020f20: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00020f30: 662e 5f6d 6572 6765 5f63 6f6e 6669 6773  f._merge_configs
-00020f40: 2863 6f6e 6669 6729 2c0a 2020 2020 2020  (config),.      
-00020f50: 2020 2020 2020 2a2a 7b2a 2a73 656c 662e        **{**self.
-00020f60: 6b77 6172 6773 2c20 2a2a 6b77 6172 6773  kwargs, **kwargs
-00020f70: 7d2c 0a20 2020 2020 2020 2029 0a0a 2020  },.        )..  
-00020f80: 2020 6173 796e 6320 6465 6620 6174 7261    async def atra
-00020f90: 6e73 666f 726d 280a 2020 2020 2020 2020  nsform(.        
-00020fa0: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
-00020fb0: 7075 743a 2041 7379 6e63 4974 6572 6174  put: AsyncIterat
-00020fc0: 6f72 5b49 6e70 7574 5d2c 0a20 2020 2020  or[Input],.     
-00020fd0: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
-00020fe0: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
-00020ff0: 6967 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ig] = None,.    
-00021000: 2020 2020 2a2a 6b77 6172 6773 3a20 416e      **kwargs: An
-00021010: 792c 0a20 2020 2029 202d 3e20 4173 796e  y,.    ) -> Asyn
-00021020: 6349 7465 7261 746f 725b 4f75 7470 7574  cIterator[Output
-00021030: 5d3a 0a20 2020 2020 2020 2061 7379 6e63  ]:.        async
-00021040: 2066 6f72 2069 7465 6d20 696e 2073 656c   for item in sel
-00021050: 662e 626f 756e 642e 6174 7261 6e73 666f  f.bound.atransfo
-00021060: 726d 280a 2020 2020 2020 2020 2020 2020  rm(.            
-00021070: 696e 7075 742c 0a20 2020 2020 2020 2020  input,.         
-00021080: 2020 2073 656c 662e 5f6d 6572 6765 5f63     self._merge_c
-00021090: 6f6e 6669 6773 2863 6f6e 6669 6729 2c0a  onfigs(config),.
-000210a0: 2020 2020 2020 2020 2020 2020 2a2a 7b2a              **{*
-000210b0: 2a73 656c 662e 6b77 6172 6773 2c20 2a2a  *self.kwargs, **
-000210c0: 6b77 6172 6773 7d2c 0a20 2020 2020 2020  kwargs},.       
-000210d0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-000210e0: 7969 656c 6420 6974 656d 0a0a 0a52 756e  yield item...Run
-000210f0: 6e61 626c 6542 696e 6469 6e67 4261 7365  nableBindingBase
-00021100: 2e75 7064 6174 655f 666f 7277 6172 645f  .update_forward_
-00021110: 7265 6673 2852 756e 6e61 626c 6543 6f6e  refs(RunnableCon
-00021120: 6669 673d 5275 6e6e 6162 6c65 436f 6e66  fig=RunnableConf
-00021130: 6967 290a 0a0a 636c 6173 7320 5275 6e6e  ig)...class Runn
-00021140: 6162 6c65 4269 6e64 696e 6728 5275 6e6e  ableBinding(Runn
-00021150: 6162 6c65 4269 6e64 696e 6742 6173 655b  ableBindingBase[
-00021160: 496e 7075 742c 204f 7574 7075 745d 293a  Input, Output]):
-00021170: 0a20 2020 2022 2222 5772 6170 2061 2072  .    """Wrap a r
-00021180: 756e 6e61 626c 6520 7769 7468 2061 6464  unnable with add
-00021190: 6974 696f 6e61 6c20 6675 6e63 7469 6f6e  itional function
-000211a0: 616c 6974 792e 0a0a 2020 2020 4120 5275  ality...    A Ru
-000211b0: 6e6e 6162 6c65 4269 6e64 696e 6720 6361  nnableBinding ca
-000211c0: 6e20 6265 2074 686f 7567 6874 206f 6620  n be thought of 
-000211d0: 6173 2061 2022 7275 6e6e 6162 6c65 2064  as a "runnable d
-000211e0: 6563 6f72 6174 6f72 2220 7468 6174 0a20  ecorator" that. 
-000211f0: 2020 2070 7265 7365 7276 6573 2074 6865     preserves the
-00021200: 2065 7373 656e 7469 616c 2066 6561 7475   essential featu
-00021210: 7265 7320 6f66 2052 756e 6e61 626c 653b  res of Runnable;
-00021220: 2069 2e65 2e2c 2062 6174 6368 696e 672c   i.e., batching,
-00021230: 2073 7472 6561 6d69 6e67 2c0a 2020 2020   streaming,.    
-00021240: 616e 6420 6173 796e 6320 7375 7070 6f72  and async suppor
-00021250: 742c 2077 6869 6c65 2061 6464 696e 6720  t, while adding 
-00021260: 6164 6469 7469 6f6e 616c 2066 756e 6374  additional funct
-00021270: 696f 6e61 6c69 7479 2e0a 0a20 2020 2041  ionality...    A
-00021280: 6e79 2063 6c61 7373 2074 6861 7420 696e  ny class that in
-00021290: 6865 7269 7473 2066 726f 6d20 5275 6e6e  herits from Runn
-000212a0: 6162 6c65 2063 616e 2062 6520 626f 756e  able can be boun
-000212b0: 6420 746f 2061 2060 5275 6e6e 6162 6c65  d to a `Runnable
-000212c0: 4269 6e64 696e 6760 2e0a 2020 2020 5275  Binding`..    Ru
-000212d0: 6e6e 6162 6c65 7320 6578 706f 7365 2061  nnables expose a
-000212e0: 2073 7461 6e64 6172 6420 7365 7420 6f66   standard set of
-000212f0: 206d 6574 686f 6473 2066 6f72 2063 7265   methods for cre
-00021300: 6174 696e 6720 6052 756e 6e61 626c 6542  ating `RunnableB
-00021310: 696e 6469 6e67 7360 0a20 2020 206f 7220  indings`.    or 
-00021320: 7375 622d 636c 6173 7365 7320 6f66 2060  sub-classes of `
-00021330: 5275 6e6e 6162 6c65 4269 6e64 696e 6773  RunnableBindings
-00021340: 6020 2865 2e67 2e2c 2060 5275 6e6e 6162  ` (e.g., `Runnab
-00021350: 6c65 5265 7472 7960 2c0a 2020 2020 6052  leRetry`,.    `R
-00021360: 756e 6e61 626c 6557 6974 6846 616c 6c62  unnableWithFallb
-00021370: 6163 6b73 6029 2074 6861 7420 6164 6420  acks`) that add 
-00021380: 6164 6469 7469 6f6e 616c 2066 756e 6374  additional funct
-00021390: 696f 6e61 6c69 7479 2e0a 0a20 2020 2054  ionality...    T
-000213a0: 6865 7365 206d 6574 686f 6473 2069 6e63  hese methods inc
-000213b0: 6c75 6465 3a0a 2020 2020 2d20 6062 696e  lude:.    - `bin
-000213c0: 6460 3a20 4269 6e64 206b 7761 7267 7320  d`: Bind kwargs 
-000213d0: 746f 2070 6173 7320 746f 2074 6865 2075  to pass to the u
-000213e0: 6e64 6572 6c79 696e 6720 7275 6e6e 6162  nderlying runnab
-000213f0: 6c65 2077 6865 6e20 7275 6e6e 696e 6720  le when running 
-00021400: 6974 2e0a 2020 2020 2d20 6077 6974 685f  it..    - `with_
-00021410: 636f 6e66 6967 603a 2042 696e 6420 636f  config`: Bind co
-00021420: 6e66 6967 2074 6f20 7061 7373 2074 6f20  nfig to pass to 
-00021430: 7468 6520 756e 6465 726c 7969 6e67 2072  the underlying r
-00021440: 756e 6e61 626c 6520 7768 656e 2072 756e  unnable when run
-00021450: 6e69 6e67 2069 742e 0a20 2020 202d 2060  ning it..    - `
-00021460: 7769 7468 5f6c 6973 7465 6e65 7273 603a  with_listeners`:
-00021470: 2020 4269 6e64 206c 6966 6563 7963 6c65    Bind lifecycle
-00021480: 206c 6973 7465 6e65 7273 2074 6f20 7468   listeners to th
-00021490: 6520 756e 6465 726c 7969 6e67 2072 756e  e underlying run
-000214a0: 6e61 626c 652e 0a20 2020 202d 2060 7769  nable..    - `wi
-000214b0: 7468 5f74 7970 6573 603a 204f 7665 7272  th_types`: Overr
-000214c0: 6964 6520 7468 6520 696e 7075 7420 616e  ide the input an
-000214d0: 6420 6f75 7470 7574 2074 7970 6573 206f  d output types o
-000214e0: 6620 7468 6520 756e 6465 726c 7969 6e67  f the underlying
-000214f0: 2072 756e 6e61 626c 652e 0a20 2020 202d   runnable..    -
-00021500: 2060 7769 7468 5f72 6574 7279 603a 2042   `with_retry`: B
-00021510: 696e 6420 6120 7265 7472 7920 706f 6c69  ind a retry poli
-00021520: 6379 2074 6f20 7468 6520 756e 6465 726c  cy to the underl
-00021530: 7969 6e67 2072 756e 6e61 626c 652e 0a20  ying runnable.. 
-00021540: 2020 202d 2060 7769 7468 5f66 616c 6c62     - `with_fallb
-00021550: 6163 6b73 603a 2042 696e 6420 6120 6661  acks`: Bind a fa
-00021560: 6c6c 6261 636b 2070 6f6c 6963 7920 746f  llback policy to
-00021570: 2074 6865 2075 6e64 6572 6c79 696e 6720   the underlying 
-00021580: 7275 6e6e 6162 6c65 2e0a 0a20 2020 2045  runnable...    E
-00021590: 7861 6d70 6c65 3a0a 0a20 2020 2060 6269  xample:..    `bi
-000215a0: 6e64 603a 2042 696e 6420 6b77 6172 6773  nd`: Bind kwargs
-000215b0: 2074 6f20 7061 7373 2074 6f20 7468 6520   to pass to the 
-000215c0: 756e 6465 726c 7969 6e67 2072 756e 6e61  underlying runna
-000215d0: 626c 6520 7768 656e 2072 756e 6e69 6e67  ble when running
-000215e0: 2069 742e 0a0a 2020 2020 2020 2020 2e2e   it...        ..
-000215f0: 2063 6f64 652d 626c 6f63 6b3a 3a20 7079   code-block:: py
-00021600: 7468 6f6e 0a0a 2020 2020 2020 2020 2020  thon..          
-00021610: 2020 2320 4372 6561 7465 2061 2072 756e    # Create a run
-00021620: 6e61 626c 6520 6269 6e64 696e 6720 7468  nable binding th
-00021630: 6174 2069 6e76 6f6b 6573 2074 6865 2043  at invokes the C
-00021640: 6861 744d 6f64 656c 2077 6974 6820 7468  hatModel with th
-00021650: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-00021660: 6164 6469 7469 6f6e 616c 206b 7761 7267  additional kwarg
-00021670: 2060 7374 6f70 3d5b 272d 275d 6020 7768   `stop=['-']` wh
-00021680: 656e 2072 756e 6e69 6e67 2069 742e 0a20  en running it.. 
-00021690: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
-000216a0: 6c61 6e67 6368 6169 6e5f 636f 6d6d 756e  langchain_commun
-000216b0: 6974 792e 6368 6174 5f6d 6f64 656c 7320  ity.chat_models 
-000216c0: 696d 706f 7274 2043 6861 744f 7065 6e41  import ChatOpenA
-000216d0: 490a 2020 2020 2020 2020 2020 2020 6d6f  I.            mo
-000216e0: 6465 6c20 3d20 4368 6174 4f70 656e 4149  del = ChatOpenAI
-000216f0: 2829 0a20 2020 2020 2020 2020 2020 206d  ().            m
-00021700: 6f64 656c 2e69 6e76 6f6b 6528 2753 6179  odel.invoke('Say
-00021710: 2022 5061 7272 6f74 2d4d 4147 4943 2227   "Parrot-MAGIC"'
-00021720: 2c20 7374 6f70 3d5b 272d 275d 2920 2320  , stop=['-']) # 
-00021730: 5368 6f75 6c64 2072 6574 7572 6e20 6050  Should return `P
-00021740: 6172 726f 7460 0a20 2020 2020 2020 2020  arrot`.         
-00021750: 2020 2023 2055 7369 6e67 2069 7420 7468     # Using it th
-00021760: 6520 6561 7379 2077 6179 2076 6961 2060  e easy way via `
-00021770: 6269 6e64 6020 6d65 7468 6f64 2077 6869  bind` method whi
-00021780: 6368 2072 6574 7572 6e73 2061 206e 6577  ch returns a new
-00021790: 0a20 2020 2020 2020 2020 2020 2023 2052  .            # R
-000217a0: 756e 6e61 626c 6542 696e 6469 6e67 0a20  unnableBinding. 
-000217b0: 2020 2020 2020 2020 2020 2072 756e 6e61             runna
-000217c0: 626c 655f 6269 6e64 696e 6720 3d20 6d6f  ble_binding = mo
-000217d0: 6465 6c2e 6269 6e64 2873 746f 703d 5b27  del.bind(stop=['
-000217e0: 2d27 5d29 0a20 2020 2020 2020 2020 2020  -']).           
-000217f0: 2072 756e 6e61 626c 655f 6269 6e64 696e   runnable_bindin
-00021800: 672e 696e 766f 6b65 2827 5361 7920 2250  g.invoke('Say "P
-00021810: 6172 726f 742d 4d41 4749 4322 2729 2023  arrot-MAGIC"') #
-00021820: 2053 686f 756c 6420 7265 7475 726e 2060   Should return `
-00021830: 5061 7272 6f74 600a 0a20 2020 2020 2020  Parrot`..       
-00021840: 2043 616e 2061 6c73 6f20 6265 2064 6f6e   Can also be don
-00021850: 6520 6279 2069 6e73 7461 6e74 6961 7469  e by instantiati
-00021860: 6e67 2061 2052 756e 6e61 626c 6542 696e  ng a RunnableBin
-00021870: 6469 6e67 2064 6972 6563 746c 7920 286e  ding directly (n
-00021880: 6f74 2072 6563 6f6d 6d65 6e64 6564 293a  ot recommended):
-00021890: 0a0a 2020 2020 2020 2020 2e2e 2063 6f64  ..        .. cod
-000218a0: 652d 626c 6f63 6b3a 3a20 7079 7468 6f6e  e-block:: python
-000218b0: 0a0a 2020 2020 2020 2020 2020 2020 6672  ..            fr
-000218c0: 6f6d 206c 616e 6763 6861 696e 5f63 6f72  om langchain_cor
-000218d0: 652e 7275 6e6e 6162 6c65 7320 696d 706f  e.runnables impo
-000218e0: 7274 2052 756e 6e61 626c 6542 696e 6469  rt RunnableBindi
-000218f0: 6e67 0a20 2020 2020 2020 2020 2020 2072  ng.            r
-00021900: 756e 6e61 626c 655f 6269 6e64 696e 6720  unnable_binding 
-00021910: 3d20 5275 6e6e 6162 6c65 4269 6e64 696e  = RunnableBindin
-00021920: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-00021930: 2020 2062 6f75 6e64 3d6d 6f64 656c 2c0a     bound=model,.
-00021940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021950: 6b77 6172 6773 3d7b 2773 746f 7027 3a20  kwargs={'stop': 
-00021960: 5b27 2d27 5d7d 2023 203c 2d2d 204e 6f74  ['-']} # <-- Not
-00021970: 6520 7468 6520 6164 6469 7469 6f6e 616c  e the additional
-00021980: 206b 7761 7267 730a 2020 2020 2020 2020   kwargs.        
-00021990: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-000219a0: 2020 7275 6e6e 6162 6c65 5f62 696e 6469    runnable_bindi
-000219b0: 6e67 2e69 6e76 6f6b 6528 2753 6179 2022  ng.invoke('Say "
-000219c0: 5061 7272 6f74 2d4d 4147 4943 2227 2920  Parrot-MAGIC"') 
-000219d0: 2320 5368 6f75 6c64 2072 6574 7572 6e20  # Should return 
-000219e0: 6050 6172 726f 7460 0a20 2020 2022 2222  `Parrot`.    """
-000219f0: 0a0a 2020 2020 4063 6c61 7373 6d65 7468  ..    @classmeth
-00021a00: 6f64 0a20 2020 2064 6566 2067 6574 5f6c  od.    def get_l
-00021a10: 635f 6e61 6d65 7370 6163 6528 636c 7329  c_namespace(cls)
-00021a20: 202d 3e20 4c69 7374 5b73 7472 5d3a 0a20   -> List[str]:. 
-00021a30: 2020 2020 2020 2022 2222 4765 7420 7468         """Get th
-00021a40: 6520 6e61 6d65 7370 6163 6520 6f66 2074  e namespace of t
-00021a50: 6865 206c 616e 6763 6861 696e 206f 626a  he langchain obj
-00021a60: 6563 742e 2222 220a 2020 2020 2020 2020  ect.""".        
-00021a70: 7265 7475 726e 205b 226c 616e 6763 6861  return ["langcha
-00021a80: 696e 222c 2022 7363 6865 6d61 222c 2022  in", "schema", "
-00021a90: 7275 6e6e 6162 6c65 225d 0a0a 2020 2020  runnable"]..    
-00021aa0: 6465 6620 6269 6e64 2873 656c 662c 202a  def bind(self, *
-00021ab0: 2a6b 7761 7267 733a 2041 6e79 2920 2d3e  *kwargs: Any) ->
-00021ac0: 2052 756e 6e61 626c 655b 496e 7075 742c   Runnable[Input,
-00021ad0: 204f 7574 7075 745d 3a0a 2020 2020 2020   Output]:.      
-00021ae0: 2020 2222 2242 696e 6420 6164 6469 7469    """Bind additi
-00021af0: 6f6e 616c 206b 7761 7267 7320 746f 2061  onal kwargs to a
-00021b00: 2052 756e 6e61 626c 652c 2072 6574 7572   Runnable, retur
-00021b10: 6e69 6e67 2061 206e 6577 2052 756e 6e61  ning a new Runna
-00021b20: 626c 652e 0a0a 2020 2020 2020 2020 4172  ble...        Ar
-00021b30: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-00021b40: 2a2a 6b77 6172 6773 3a20 5468 6520 6b77  **kwargs: The kw
-00021b50: 6172 6773 2074 6f20 6269 6e64 2074 6f20  args to bind to 
-00021b60: 7468 6520 5275 6e6e 6162 6c65 2e0a 0a20  the Runnable... 
-00021b70: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
-00021b80: 2020 2020 2020 2020 2020 2020 4120 6e65              A ne
-00021b90: 7720 5275 6e6e 6162 6c65 2077 6974 6820  w Runnable with 
-00021ba0: 7468 6520 7361 6d65 2074 7970 6520 616e  the same type an
-00021bb0: 6420 636f 6e66 6967 2061 7320 7468 6520  d config as the 
-00021bc0: 6f72 6967 696e 616c 2c0a 2020 2020 2020  original,.      
-00021bd0: 2020 2020 2020 6275 7420 7769 7468 2074        but with t
-00021be0: 6865 2061 6464 6974 696f 6e61 6c20 6b77  he additional kw
-00021bf0: 6172 6773 2062 6f75 6e64 2e0a 2020 2020  args bound..    
-00021c00: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00021c10: 7265 7475 726e 2073 656c 662e 5f5f 636c  return self.__cl
-00021c20: 6173 735f 5f28 0a20 2020 2020 2020 2020  ass__(.         
-00021c30: 2020 2062 6f75 6e64 3d73 656c 662e 626f     bound=self.bo
-00021c40: 756e 642c 0a20 2020 2020 2020 2020 2020  und,.           
-00021c50: 2063 6f6e 6669 673d 7365 6c66 2e63 6f6e   config=self.con
-00021c60: 6669 672c 0a20 2020 2020 2020 2020 2020  fig,.           
-00021c70: 206b 7761 7267 733d 7b2a 2a73 656c 662e   kwargs={**self.
-00021c80: 6b77 6172 6773 2c20 2a2a 6b77 6172 6773  kwargs, **kwargs
-00021c90: 7d2c 0a20 2020 2020 2020 2020 2020 2063  },.            c
-00021ca0: 7573 746f 6d5f 696e 7075 745f 7479 7065  ustom_input_type
-00021cb0: 3d73 656c 662e 6375 7374 6f6d 5f69 6e70  =self.custom_inp
-00021cc0: 7574 5f74 7970 652c 0a20 2020 2020 2020  ut_type,.       
-00021cd0: 2020 2020 2063 7573 746f 6d5f 6f75 7470       custom_outp
-00021ce0: 7574 5f74 7970 653d 7365 6c66 2e63 7573  ut_type=self.cus
-00021cf0: 746f 6d5f 6f75 7470 7574 5f74 7970 652c  tom_output_type,
-00021d00: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00021d10: 6465 6620 7769 7468 5f63 6f6e 6669 6728  def with_config(
-00021d20: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00021d30: 2020 2020 2020 2063 6f6e 6669 673a 204f         config: O
-00021d40: 7074 696f 6e61 6c5b 5275 6e6e 6162 6c65  ptional[Runnable
-00021d50: 436f 6e66 6967 5d20 3d20 4e6f 6e65 2c0a  Config] = None,.
-00021d60: 2020 2020 2020 2020 2320 5361 646c 7920          # Sadly 
-00021d70: 556e 7061 636b 2069 7320 6e6f 7420 7765  Unpack is not we
-00021d80: 6c6c 2073 7570 706f 7274 6564 2062 7920  ll supported by 
-00021d90: 6d79 7079 2073 6f20 7468 6973 2077 696c  mypy so this wil
-00021da0: 6c20 6861 7665 2074 6f20 6265 2075 6e74  l have to be unt
-00021db0: 7970 6564 0a20 2020 2020 2020 202a 2a6b  yped.        **k
-00021dc0: 7761 7267 733a 2041 6e79 2c0a 2020 2020  wargs: Any,.    
-00021dd0: 2920 2d3e 2052 756e 6e61 626c 655b 496e  ) -> Runnable[In
-00021de0: 7075 742c 204f 7574 7075 745d 3a0a 2020  put, Output]:.  
-00021df0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00021e00: 662e 5f5f 636c 6173 735f 5f28 0a20 2020  f.__class__(.   
-00021e10: 2020 2020 2020 2020 2062 6f75 6e64 3d73           bound=s
-00021e20: 656c 662e 626f 756e 642c 0a20 2020 2020  elf.bound,.     
-00021e30: 2020 2020 2020 206b 7761 7267 733d 7365         kwargs=se
-00021e40: 6c66 2e6b 7761 7267 732c 0a20 2020 2020  lf.kwargs,.     
-00021e50: 2020 2020 2020 2063 6f6e 6669 673d 6361         config=ca
-00021e60: 7374 2852 756e 6e61 626c 6543 6f6e 6669  st(RunnableConfi
-00021e70: 672c 207b 2a2a 7365 6c66 2e63 6f6e 6669  g, {**self.confi
-00021e80: 672c 202a 2a28 636f 6e66 6967 206f 7220  g, **(config or 
-00021e90: 7b7d 292c 202a 2a6b 7761 7267 737d 292c  {}), **kwargs}),
-00021ea0: 0a20 2020 2020 2020 2020 2020 2063 7573  .            cus
-00021eb0: 746f 6d5f 696e 7075 745f 7479 7065 3d73  tom_input_type=s
-00021ec0: 656c 662e 6375 7374 6f6d 5f69 6e70 7574  elf.custom_input
-00021ed0: 5f74 7970 652c 0a20 2020 2020 2020 2020  _type,.         
-00021ee0: 2020 2063 7573 746f 6d5f 6f75 7470 7574     custom_output
-00021ef0: 5f74 7970 653d 7365 6c66 2e63 7573 746f  _type=self.custo
-00021f00: 6d5f 6f75 7470 7574 5f74 7970 652c 0a20  m_output_type,. 
-00021f10: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-00021f20: 6620 7769 7468 5f6c 6973 7465 6e65 7273  f with_listeners
-00021f30: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00021f40: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
-00021f50: 2020 206f 6e5f 7374 6172 743a 204f 7074     on_start: Opt
-00021f60: 696f 6e61 6c5b 4c69 7374 656e 6572 5d20  ional[Listener] 
-00021f70: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00021f80: 6f6e 5f65 6e64 3a20 4f70 7469 6f6e 616c  on_end: Optional
-00021f90: 5b4c 6973 7465 6e65 725d 203d 204e 6f6e  [Listener] = Non
-00021fa0: 652c 0a20 2020 2020 2020 206f 6e5f 6572  e,.        on_er
-00021fb0: 726f 723a 204f 7074 696f 6e61 6c5b 4c69  ror: Optional[Li
-00021fc0: 7374 656e 6572 5d20 3d20 4e6f 6e65 2c0a  stener] = None,.
-00021fd0: 2020 2020 2920 2d3e 2052 756e 6e61 626c      ) -> Runnabl
-00021fe0: 655b 496e 7075 742c 204f 7574 7075 745d  e[Input, Output]
-00021ff0: 3a0a 2020 2020 2020 2020 2222 2242 696e  :.        """Bin
-00022000: 6420 6c69 6665 6379 636c 6520 6c69 7374  d lifecycle list
-00022010: 656e 6572 7320 746f 2061 2052 756e 6e61  eners to a Runna
-00022020: 626c 652c 2072 6574 7572 6e69 6e67 2061  ble, returning a
-00022030: 206e 6577 2052 756e 6e61 626c 652e 0a0a   new Runnable...
-00022040: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
-00022050: 2020 2020 2020 2020 2020 6f6e 5f73 7461            on_sta
-00022060: 7274 3a20 4361 6c6c 6564 2062 6566 6f72  rt: Called befor
-00022070: 6520 7468 6520 7275 6e6e 6162 6c65 2073  e the runnable s
-00022080: 7461 7274 7320 7275 6e6e 696e 672c 2077  tarts running, w
-00022090: 6974 6820 7468 6520 5275 6e20 6f62 6a65  ith the Run obje
-000220a0: 6374 2e0a 2020 2020 2020 2020 2020 2020  ct..            
-000220b0: 6f6e 5f65 6e64 3a20 4361 6c6c 6564 2061  on_end: Called a
-000220c0: 6674 6572 2074 6865 2072 756e 6e61 626c  fter the runnabl
-000220d0: 6520 6669 6e69 7368 6573 2072 756e 6e69  e finishes runni
-000220e0: 6e67 2c20 7769 7468 2074 6865 2052 756e  ng, with the Run
-000220f0: 206f 626a 6563 742e 0a20 2020 2020 2020   object..       
-00022100: 2020 2020 206f 6e5f 6572 726f 723a 2043       on_error: C
-00022110: 616c 6c65 6420 6966 2074 6865 2072 756e  alled if the run
-00022120: 6e61 626c 6520 7468 726f 7773 2061 6e20  nable throws an 
-00022130: 6572 726f 722c 2077 6974 6820 7468 6520  error, with the 
-00022140: 5275 6e20 6f62 6a65 6374 2e0a 0a20 2020  Run object...   
-00022150: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
-00022160: 2020 2020 2020 2020 2020 5468 6520 5275            The Ru
-00022170: 6e20 6f62 6a65 6374 2063 6f6e 7461 696e  n object contain
-00022180: 7320 696e 666f 726d 6174 696f 6e20 6162  s information ab
-00022190: 6f75 7420 7468 6520 7275 6e2c 2069 6e63  out the run, inc
-000221a0: 6c75 6469 6e67 2069 7473 2069 642c 0a20  luding its id,. 
-000221b0: 2020 2020 2020 2020 2020 2074 7970 652c             type,
-000221c0: 2069 6e70 7574 2c20 6f75 7470 7574 2c20   input, output, 
-000221d0: 6572 726f 722c 2073 7461 7274 5f74 696d  error, start_tim
-000221e0: 652c 2065 6e64 5f74 696d 652c 2061 6e64  e, end_time, and
-000221f0: 2061 6e79 2074 6167 7320 6f72 206d 6574   any tags or met
-00022200: 6164 6174 610a 2020 2020 2020 2020 2020  adata.          
-00022210: 2020 6164 6465 6420 746f 2074 6865 2072    added to the r
-00022220: 756e 2e0a 2020 2020 2020 2020 2222 220a  un..        """.
-00022230: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
-00022240: 6763 6861 696e 5f63 6f72 652e 7472 6163  gchain_core.trac
-00022250: 6572 732e 726f 6f74 5f6c 6973 7465 6e65  ers.root_listene
-00022260: 7273 2069 6d70 6f72 7420 526f 6f74 4c69  rs import RootLi
-00022270: 7374 656e 6572 7354 7261 6365 720a 0a20  stenersTracer.. 
-00022280: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00022290: 6c66 2e5f 5f63 6c61 7373 5f5f 280a 2020  lf.__class__(.  
-000222a0: 2020 2020 2020 2020 2020 626f 756e 643d            bound=
-000222b0: 7365 6c66 2e62 6f75 6e64 2c0a 2020 2020  self.bound,.    
-000222c0: 2020 2020 2020 2020 6b77 6172 6773 3d73          kwargs=s
-000222d0: 656c 662e 6b77 6172 6773 2c0a 2020 2020  elf.kwargs,.    
-000222e0: 2020 2020 2020 2020 636f 6e66 6967 3d73          config=s
-000222f0: 656c 662e 636f 6e66 6967 2c0a 2020 2020  elf.config,.    
-00022300: 2020 2020 2020 2020 636f 6e66 6967 5f66          config_f
-00022310: 6163 746f 7269 6573 3d5b 0a20 2020 2020  actories=[.     
-00022320: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
-00022330: 6120 636f 6e66 6967 3a20 7b0a 2020 2020  a config: {.    
-00022340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022350: 2263 616c 6c62 6163 6b73 223a 205b 0a20  "callbacks": [. 
-00022360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022370: 2020 2020 2020 2052 6f6f 744c 6973 7465         RootListe
-00022380: 6e65 7273 5472 6163 6572 280a 2020 2020  nersTracer(.    
-00022390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000223a0: 2020 2020 2020 2020 636f 6e66 6967 3d63          config=c
-000223b0: 6f6e 6669 672c 0a20 2020 2020 2020 2020  onfig,.         
-000223c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000223d0: 2020 206f 6e5f 7374 6172 743d 6f6e 5f73     on_start=on_s
-000223e0: 7461 7274 2c0a 2020 2020 2020 2020 2020  tart,.          
-000223f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022400: 2020 6f6e 5f65 6e64 3d6f 6e5f 656e 642c    on_end=on_end,
-00022410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022420: 2020 2020 2020 2020 2020 2020 206f 6e5f               on_
-00022430: 6572 726f 723d 6f6e 5f65 7272 6f72 2c0a  error=on_error,.
-00022440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022450: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00022460: 2020 2020 2020 2020 2020 2020 2020 5d2c                ],
-00022470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022480: 207d 0a20 2020 2020 2020 2020 2020 205d   }.            ]
-00022490: 2c0a 2020 2020 2020 2020 2020 2020 6375  ,.            cu
-000224a0: 7374 6f6d 5f69 6e70 7574 5f74 7970 653d  stom_input_type=
-000224b0: 7365 6c66 2e63 7573 746f 6d5f 696e 7075  self.custom_inpu
-000224c0: 745f 7479 7065 2c0a 2020 2020 2020 2020  t_type,.        
-000224d0: 2020 2020 6375 7374 6f6d 5f6f 7574 7075      custom_outpu
-000224e0: 745f 7479 7065 3d73 656c 662e 6375 7374  t_type=self.cust
-000224f0: 6f6d 5f6f 7574 7075 745f 7479 7065 2c0a  om_output_type,.
-00022500: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
-00022510: 6566 2077 6974 685f 7479 7065 7328 0a20  ef with_types(. 
-00022520: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00022530: 2020 2020 2069 6e70 7574 5f74 7970 653a       input_type:
-00022540: 204f 7074 696f 6e61 6c5b 556e 696f 6e5b   Optional[Union[
-00022550: 5479 7065 5b49 6e70 7574 5d2c 2042 6173  Type[Input], Bas
-00022560: 654d 6f64 656c 5d5d 203d 204e 6f6e 652c  eModel]] = None,
-00022570: 0a20 2020 2020 2020 206f 7574 7075 745f  .        output_
-00022580: 7479 7065 3a20 4f70 7469 6f6e 616c 5b55  type: Optional[U
-00022590: 6e69 6f6e 5b54 7970 655b 4f75 7470 7574  nion[Type[Output
-000225a0: 5d2c 2042 6173 654d 6f64 656c 5d5d 203d  ], BaseModel]] =
-000225b0: 204e 6f6e 652c 0a20 2020 2029 202d 3e20   None,.    ) -> 
-000225c0: 5275 6e6e 6162 6c65 5b49 6e70 7574 2c20  Runnable[Input, 
-000225d0: 4f75 7470 7574 5d3a 0a20 2020 2020 2020  Output]:.       
-000225e0: 2072 6574 7572 6e20 7365 6c66 2e5f 5f63   return self.__c
-000225f0: 6c61 7373 5f5f 280a 2020 2020 2020 2020  lass__(.        
-00022600: 2020 2020 626f 756e 643d 7365 6c66 2e62      bound=self.b
-00022610: 6f75 6e64 2c0a 2020 2020 2020 2020 2020  ound,.          
-00022620: 2020 6b77 6172 6773 3d73 656c 662e 6b77    kwargs=self.kw
-00022630: 6172 6773 2c0a 2020 2020 2020 2020 2020  args,.          
-00022640: 2020 636f 6e66 6967 3d73 656c 662e 636f    config=self.co
-00022650: 6e66 6967 2c0a 2020 2020 2020 2020 2020  nfig,.          
-00022660: 2020 6375 7374 6f6d 5f69 6e70 7574 5f74    custom_input_t
-00022670: 7970 653d 696e 7075 745f 7479 7065 0a20  ype=input_type. 
-00022680: 2020 2020 2020 2020 2020 2069 6620 696e             if in
-00022690: 7075 745f 7479 7065 2069 7320 6e6f 7420  put_type is not 
-000226a0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-000226b0: 2065 6c73 6520 7365 6c66 2e63 7573 746f   else self.custo
-000226c0: 6d5f 696e 7075 745f 7479 7065 2c0a 2020  m_input_type,.  
-000226d0: 2020 2020 2020 2020 2020 6375 7374 6f6d            custom
-000226e0: 5f6f 7574 7075 745f 7479 7065 3d6f 7574  _output_type=out
-000226f0: 7075 745f 7479 7065 0a20 2020 2020 2020  put_type.       
-00022700: 2020 2020 2069 6620 6f75 7470 7574 5f74       if output_t
-00022710: 7970 6520 6973 206e 6f74 204e 6f6e 650a  ype is not None.
-00022720: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00022730: 2073 656c 662e 6375 7374 6f6d 5f6f 7574   self.custom_out
-00022740: 7075 745f 7479 7065 2c0a 2020 2020 2020  put_type,.      
-00022750: 2020 290a 0a20 2020 2064 6566 2077 6974    )..    def wit
-00022760: 685f 7265 7472 7928 7365 6c66 2c20 2a2a  h_retry(self, **
-00022770: 6b77 6172 6773 3a20 416e 7929 202d 3e20  kwargs: Any) -> 
-00022780: 5275 6e6e 6162 6c65 5b49 6e70 7574 2c20  Runnable[Input, 
-00022790: 4f75 7470 7574 5d3a 0a20 2020 2020 2020  Output]:.       
-000227a0: 2072 6574 7572 6e20 7365 6c66 2e5f 5f63   return self.__c
-000227b0: 6c61 7373 5f5f 280a 2020 2020 2020 2020  lass__(.        
-000227c0: 2020 2020 626f 756e 643d 7365 6c66 2e62      bound=self.b
-000227d0: 6f75 6e64 2e77 6974 685f 7265 7472 7928  ound.with_retry(
-000227e0: 2a2a 6b77 6172 6773 292c 0a20 2020 2020  **kwargs),.     
-000227f0: 2020 2020 2020 206b 7761 7267 733d 7365         kwargs=se
-00022800: 6c66 2e6b 7761 7267 732c 0a20 2020 2020  lf.kwargs,.     
-00022810: 2020 2020 2020 2063 6f6e 6669 673d 7365         config=se
-00022820: 6c66 2e63 6f6e 6669 672c 0a20 2020 2020  lf.config,.     
-00022830: 2020 2029 0a0a 0a52 756e 6e61 626c 654c     )...RunnableL
-00022840: 696b 6520 3d20 556e 696f 6e5b 0a20 2020  ike = Union[.   
-00022850: 2052 756e 6e61 626c 655b 496e 7075 742c   Runnable[Input,
-00022860: 204f 7574 7075 745d 2c0a 2020 2020 4361   Output],.    Ca
-00022870: 6c6c 6162 6c65 5b5b 496e 7075 745d 2c20  llable[[Input], 
-00022880: 4f75 7470 7574 5d2c 0a20 2020 2043 616c  Output],.    Cal
-00022890: 6c61 626c 655b 5b49 6e70 7574 5d2c 2041  lable[[Input], A
-000228a0: 7761 6974 6162 6c65 5b4f 7574 7075 745d  waitable[Output]
-000228b0: 5d2c 0a20 2020 2043 616c 6c61 626c 655b  ],.    Callable[
-000228c0: 5b49 7465 7261 746f 725b 496e 7075 745d  [Iterator[Input]
-000228d0: 5d2c 2049 7465 7261 746f 725b 4f75 7470  ], Iterator[Outp
-000228e0: 7574 5d5d 2c0a 2020 2020 4361 6c6c 6162  ut]],.    Callab
-000228f0: 6c65 5b5b 4173 796e 6349 7465 7261 746f  le[[AsyncIterato
-00022900: 725b 496e 7075 745d 5d2c 2041 7379 6e63  r[Input]], Async
-00022910: 4974 6572 6174 6f72 5b4f 7574 7075 745d  Iterator[Output]
-00022920: 5d2c 0a20 2020 204d 6170 7069 6e67 5b73  ],.    Mapping[s
-00022930: 7472 2c20 416e 795d 2c0a 5d0a 0a0a 6465  tr, Any],.]...de
-00022940: 6620 636f 6572 6365 5f74 6f5f 7275 6e6e  f coerce_to_runn
-00022950: 6162 6c65 2874 6869 6e67 3a20 5275 6e6e  able(thing: Runn
-00022960: 6162 6c65 4c69 6b65 2920 2d3e 2052 756e  ableLike) -> Run
-00022970: 6e61 626c 655b 496e 7075 742c 204f 7574  nable[Input, Out
-00022980: 7075 745d 3a0a 2020 2020 2222 2243 6f65  put]:.    """Coe
-00022990: 7263 6520 6120 7275 6e6e 6162 6c65 2d6c  rce a runnable-l
-000229a0: 696b 6520 6f62 6a65 6374 2069 6e74 6f20  ike object into 
-000229b0: 6120 5275 6e6e 6162 6c65 2e0a 0a20 2020  a Runnable...   
-000229c0: 2041 7267 733a 0a20 2020 2020 2020 2074   Args:.        t
-000229d0: 6869 6e67 3a20 4120 7275 6e6e 6162 6c65  hing: A runnable
-000229e0: 2d6c 696b 6520 6f62 6a65 6374 2e0a 0a20  -like object... 
-000229f0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-00022a00: 2020 2020 4120 5275 6e6e 6162 6c65 2e0a      A Runnable..
-00022a10: 2020 2020 2222 220a 2020 2020 6966 2069      """.    if i
-00022a20: 7369 6e73 7461 6e63 6528 7468 696e 672c  sinstance(thing,
-00022a30: 2052 756e 6e61 626c 6529 3a0a 2020 2020   Runnable):.    
-00022a40: 2020 2020 7265 7475 726e 2074 6869 6e67      return thing
-00022a50: 0a20 2020 2065 6c69 6620 696e 7370 6563  .    elif inspec
-00022a60: 742e 6973 6173 796e 6367 656e 6675 6e63  t.isasyncgenfunc
-00022a70: 7469 6f6e 2874 6869 6e67 2920 6f72 2069  tion(thing) or i
-00022a80: 6e73 7065 6374 2e69 7367 656e 6572 6174  nspect.isgenerat
-00022a90: 6f72 6675 6e63 7469 6f6e 2874 6869 6e67  orfunction(thing
-00022aa0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-00022ab0: 6e20 5275 6e6e 6162 6c65 4765 6e65 7261  n RunnableGenera
-00022ac0: 746f 7228 7468 696e 6729 0a20 2020 2065  tor(thing).    e
-00022ad0: 6c69 6620 6361 6c6c 6162 6c65 2874 6869  lif callable(thi
-00022ae0: 6e67 293a 0a20 2020 2020 2020 2072 6574  ng):.        ret
-00022af0: 7572 6e20 5275 6e6e 6162 6c65 4c61 6d62  urn RunnableLamb
-00022b00: 6461 2863 6173 7428 4361 6c6c 6162 6c65  da(cast(Callable
-00022b10: 5b5b 496e 7075 745d 2c20 4f75 7470 7574  [[Input], Output
-00022b20: 5d2c 2074 6869 6e67 2929 0a20 2020 2065  ], thing)).    e
-00022b30: 6c69 6620 6973 696e 7374 616e 6365 2874  lif isinstance(t
-00022b40: 6869 6e67 2c20 6469 6374 293a 0a20 2020  hing, dict):.   
-00022b50: 2020 2020 2072 6574 7572 6e20 6361 7374       return cast
-00022b60: 2852 756e 6e61 626c 655b 496e 7075 742c  (Runnable[Input,
-00022b70: 204f 7574 7075 745d 2c20 5275 6e6e 6162   Output], Runnab
-00022b80: 6c65 5061 7261 6c6c 656c 2874 6869 6e67  leParallel(thing
-00022b90: 2929 0a20 2020 2065 6c73 653a 0a20 2020  )).    else:.   
-00022ba0: 2020 2020 2072 6169 7365 2054 7970 6545       raise TypeE
-00022bb0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00022bc0: 2020 6622 4578 7065 6374 6564 2061 2052    f"Expected a R
-00022bd0: 756e 6e61 626c 652c 2063 616c 6c61 626c  unnable, callabl
-00022be0: 6520 6f72 2064 6963 742e 220a 2020 2020  e or dict.".    
-00022bf0: 2020 2020 2020 2020 6622 496e 7374 6561          f"Instea
-00022c00: 6420 676f 7420 616e 2075 6e73 7570 706f  d got an unsuppo
-00022c10: 7274 6564 2074 7970 653a 207b 7479 7065  rted type: {type
-00022c20: 2874 6869 6e67 297d 220a 2020 2020 2020  (thing)}".      
-00022c30: 2020 290a 0a0a 406f 7665 726c 6f61 640a    )...@overload.
-00022c40: 6465 6620 6368 6169 6e28 0a20 2020 2066  def chain(.    f
-00022c50: 756e 633a 2043 616c 6c61 626c 655b 5b49  unc: Callable[[I
-00022c60: 6e70 7574 5d2c 2043 6f72 6f75 7469 6e65  nput], Coroutine
-00022c70: 5b41 6e79 2c20 416e 792c 204f 7574 7075  [Any, Any, Outpu
-00022c80: 745d 5d2c 0a29 202d 3e20 5275 6e6e 6162  t]],.) -> Runnab
-00022c90: 6c65 5b49 6e70 7574 2c20 4f75 7470 7574  le[Input, Output
-00022ca0: 5d3a 0a20 2020 202e 2e2e 0a0a 0a40 6f76  ]:.    ......@ov
-00022cb0: 6572 6c6f 6164 0a64 6566 2063 6861 696e  erload.def chain
-00022cc0: 280a 2020 2020 6675 6e63 3a20 4361 6c6c  (.    func: Call
-00022cd0: 6162 6c65 5b5b 496e 7075 745d 2c20 4974  able[[Input], It
-00022ce0: 6572 6174 6f72 5b4f 7574 7075 745d 5d2c  erator[Output]],
-00022cf0: 0a29 202d 3e20 5275 6e6e 6162 6c65 5b49  .) -> Runnable[I
-00022d00: 6e70 7574 2c20 4f75 7470 7574 5d3a 0a20  nput, Output]:. 
-00022d10: 2020 202e 2e2e 0a0a 0a40 6f76 6572 6c6f     ......@overlo
-00022d20: 6164 0a64 6566 2063 6861 696e 280a 2020  ad.def chain(.  
-00022d30: 2020 6675 6e63 3a20 4361 6c6c 6162 6c65    func: Callable
-00022d40: 5b5b 496e 7075 745d 2c20 4173 796e 6349  [[Input], AsyncI
-00022d50: 7465 7261 746f 725b 4f75 7470 7574 5d5d  terator[Output]]
-00022d60: 2c0a 2920 2d3e 2052 756e 6e61 626c 655b  ,.) -> Runnable[
-00022d70: 496e 7075 742c 204f 7574 7075 745d 3a0a  Input, Output]:.
-00022d80: 2020 2020 2e2e 2e0a 0a0a 406f 7665 726c      ......@overl
-00022d90: 6f61 640a 6465 6620 6368 6169 6e28 0a20  oad.def chain(. 
-00022da0: 2020 2066 756e 633a 2043 616c 6c61 626c     func: Callabl
-00022db0: 655b 5b49 6e70 7574 5d2c 204f 7574 7075  e[[Input], Outpu
-00022dc0: 745d 2c0a 2920 2d3e 2052 756e 6e61 626c  t],.) -> Runnabl
-00022dd0: 655b 496e 7075 742c 204f 7574 7075 745d  e[Input, Output]
-00022de0: 3a0a 2020 2020 2e2e 2e0a 0a0a 6465 6620  :.    ......def 
-00022df0: 6368 6169 6e28 0a20 2020 2066 756e 633a  chain(.    func:
-00022e00: 2055 6e69 6f6e 5b0a 2020 2020 2020 2020   Union[.        
-00022e10: 4361 6c6c 6162 6c65 5b5b 496e 7075 745d  Callable[[Input]
-00022e20: 2c20 4f75 7470 7574 5d2c 0a20 2020 2020  , Output],.     
-00022e30: 2020 2043 616c 6c61 626c 655b 5b49 6e70     Callable[[Inp
-00022e40: 7574 5d2c 2049 7465 7261 746f 725b 4f75  ut], Iterator[Ou
-00022e50: 7470 7574 5d5d 2c0a 2020 2020 2020 2020  tput]],.        
-00022e60: 4361 6c6c 6162 6c65 5b5b 496e 7075 745d  Callable[[Input]
-00022e70: 2c20 436f 726f 7574 696e 655b 416e 792c  , Coroutine[Any,
-00022e80: 2041 6e79 2c20 4f75 7470 7574 5d5d 2c0a   Any, Output]],.
-00022e90: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
-00022ea0: 5b5b 496e 7075 745d 2c20 4173 796e 6349  [[Input], AsyncI
-00022eb0: 7465 7261 746f 725b 4f75 7470 7574 5d5d  terator[Output]]
-00022ec0: 2c0a 2020 2020 5d2c 0a29 202d 3e20 5275  ,.    ],.) -> Ru
-00022ed0: 6e6e 6162 6c65 5b49 6e70 7574 2c20 4f75  nnable[Input, Ou
-00022ee0: 7470 7574 5d3a 0a20 2020 2022 2222 4465  tput]:.    """De
-00022ef0: 636f 7261 7465 2061 2066 756e 6374 696f  corate a functio
-00022f00: 6e20 746f 206d 616b 6520 6974 2061 2052  n to make it a R
-00022f10: 756e 6e61 626c 652e 0a20 2020 2053 6574  unnable..    Set
-00022f20: 7320 7468 6520 6e61 6d65 206f 6620 7468  s the name of th
-00022f30: 6520 7275 6e6e 6162 6c65 2074 6f20 7468  e runnable to th
-00022f40: 6520 6e61 6d65 206f 6620 7468 6520 6675  e name of the fu
-00022f50: 6e63 7469 6f6e 2e0a 2020 2020 416e 7920  nction..    Any 
-00022f60: 7275 6e6e 6162 6c65 7320 6361 6c6c 6564  runnables called
-00022f70: 2062 7920 7468 6520 6675 6e63 7469 6f6e   by the function
-00022f80: 2077 696c 6c20 6265 2074 7261 6365 6420   will be traced 
-00022f90: 6173 2064 6570 656e 6465 6e63 6965 732e  as dependencies.
-00022fa0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-00022fb0: 2020 2020 6675 6e63 3a20 4120 6361 6c6c      func: A call
-00022fc0: 6162 6c65 2e0a 0a20 2020 2052 6574 7572  able...    Retur
-00022fd0: 6e73 3a0a 2020 2020 2020 2020 4120 5275  ns:.        A Ru
-00022fe0: 6e6e 6162 6c65 2e0a 0a20 2020 2045 7861  nnable...    Exa
-00022ff0: 6d70 6c65 3a0a 0a20 2020 202e 2e20 636f  mple:..    .. co
-00023000: 6465 2d62 6c6f 636b 3a3a 2070 7974 686f  de-block:: pytho
-00023010: 6e0a 0a20 2020 2020 2020 2066 726f 6d20  n..        from 
-00023020: 6c61 6e67 6368 6169 6e5f 636f 7265 2e72  langchain_core.r
-00023030: 756e 6e61 626c 6573 2069 6d70 6f72 7420  unnables import 
-00023040: 6368 6169 6e0a 2020 2020 2020 2020 6672  chain.        fr
-00023050: 6f6d 206c 616e 6763 6861 696e 5f63 6f72  om langchain_cor
-00023060: 652e 7072 6f6d 7074 7320 696d 706f 7274  e.prompts import
-00023070: 2050 726f 6d70 7454 656d 706c 6174 650a   PromptTemplate.
-00023080: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
-00023090: 6763 6861 696e 5f6f 7065 6e61 6920 696d  gchain_openai im
-000230a0: 706f 7274 204f 7065 6e41 490a 0a20 2020  port OpenAI..   
-000230b0: 2020 2020 2040 6368 6169 6e0a 2020 2020       @chain.    
-000230c0: 2020 2020 6465 6620 6d79 5f66 756e 6328      def my_func(
-000230d0: 6669 656c 6473 293a 0a20 2020 2020 2020  fields):.       
-000230e0: 2020 2020 2070 726f 6d70 7420 3d20 5072       prompt = Pr
-000230f0: 6f6d 7074 5465 6d70 6c61 7465 2822 4865  omptTemplate("He
-00023100: 6c6c 6f2c 207b 6e61 6d65 7d21 2229 0a20  llo, {name}!"). 
-00023110: 2020 2020 2020 2020 2020 206c 6c6d 203d             llm =
-00023120: 204f 7065 6e41 4928 290a 2020 2020 2020   OpenAI().      
-00023130: 2020 2020 2020 666f 726d 6174 7465 6420        formatted 
-00023140: 3d20 7072 6f6d 7074 2e69 6e76 6f6b 6528  = prompt.invoke(
-00023150: 2a2a 6669 656c 6473 290a 0a20 2020 2020  **fields)..     
-00023160: 2020 2020 2020 2066 6f72 2063 6875 6e6b         for chunk
-00023170: 2069 6e20 6c6c 6d2e 7374 7265 616d 2866   in llm.stream(f
-00023180: 6f72 6d61 7474 6564 293a 0a20 2020 2020  ormatted):.     
-00023190: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
-000231a0: 2063 6875 6e6b 0a20 2020 2022 2222 0a20   chunk.    """. 
-000231b0: 2020 2072 6574 7572 6e20 5275 6e6e 6162     return Runnab
-000231c0: 6c65 4c61 6d62 6461 2866 756e 6329 0a    leLambda(func).
+0001be40: 2043 6861 7450 726f 6d70 7454 656d 706c   ChatPromptTempl
+0001be50: 6174 652e 6672 6f6d 5f74 656d 706c 6174  ate.from_templat
+0001be60: 6528 2277 7269 7465 2061 2032 2d6c 696e  e("write a 2-lin
+0001be70: 6520 706f 656d 2061 626f 7574 207b 746f  e poem about {to
+0001be80: 7069 637d 2229 0a20 2020 2020 2020 2020  pic}").         
+0001be90: 2020 2020 2020 207c 206d 6f64 656c 0a20         | model. 
+0001bea0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+0001beb0: 2020 2020 2020 2020 2020 7275 6e6e 6162            runnab
+0001bec0: 6c65 203d 2052 756e 6e61 626c 6550 6172  le = RunnablePar
+0001bed0: 616c 6c65 6c28 6a6f 6b65 3d6a 6f6b 655f  allel(joke=joke_
+0001bee0: 6368 6169 6e2c 2070 6f65 6d3d 706f 656d  chain, poem=poem
+0001bef0: 5f63 6861 696e 290a 0a20 2020 2020 2020  _chain)..       
+0001bf00: 2020 2020 2023 2044 6973 706c 6179 2073       # Display s
+0001bf10: 7472 6561 6d0a 2020 2020 2020 2020 2020  tream.          
+0001bf20: 2020 6f75 7470 7574 203d 207b 6b65 793a    output = {key:
+0001bf30: 2022 2220 666f 7220 6b65 792c 205f 2069   "" for key, _ i
+0001bf40: 6e20 7275 6e6e 6162 6c65 2e6f 7574 7075  n runnable.outpu
+0001bf50: 745f 7363 6865 6d61 2829 7d0a 2020 2020  t_schema()}.    
+0001bf60: 2020 2020 2020 2020 666f 7220 6368 756e          for chun
+0001bf70: 6b20 696e 2072 756e 6e61 626c 652e 7374  k in runnable.st
+0001bf80: 7265 616d 287b 2274 6f70 6963 223a 2022  ream({"topic": "
+0001bf90: 6265 6172 227d 293a 0a20 2020 2020 2020  bear"}):.       
+0001bfa0: 2020 2020 2020 2020 2066 6f72 206b 6579           for key
+0001bfb0: 2069 6e20 6368 756e 6b3a 0a20 2020 2020   in chunk:.     
+0001bfc0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0001bfd0: 7574 7075 745b 6b65 795d 203d 206f 7574  utput[key] = out
+0001bfe0: 7075 745b 6b65 795d 202b 2063 6875 6e6b  put[key] + chunk
+0001bff0: 5b6b 6579 5d2e 636f 6e74 656e 740a 2020  [key].content.  
+0001c000: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0001c010: 696e 7428 6f75 7470 7574 2920 2023 206e  int(output)  # n
+0001c020: 6f71 613a 2054 3230 310a 2020 2020 2222  oqa: T201.    ""
+0001c030: 220a 0a20 2020 2073 7465 7073 5f5f 3a20  "..    steps__: 
+0001c040: 4d61 7070 696e 675b 7374 722c 2052 756e  Mapping[str, Run
+0001c050: 6e61 626c 655b 496e 7075 742c 2041 6e79  nable[Input, Any
+0001c060: 5d5d 0a0a 2020 2020 6465 6620 5f5f 696e  ]]..    def __in
+0001c070: 6974 5f5f 280a 2020 2020 2020 2020 7365  it__(.        se
+0001c080: 6c66 2c0a 2020 2020 2020 2020 7374 6570  lf,.        step
+0001c090: 735f 5f3a 204f 7074 696f 6e61 6c5b 0a20  s__: Optional[. 
+0001c0a0: 2020 2020 2020 2020 2020 204d 6170 7069             Mappi
+0001c0b0: 6e67 5b0a 2020 2020 2020 2020 2020 2020  ng[.            
+0001c0c0: 2020 2020 7374 722c 0a20 2020 2020 2020      str,.       
+0001c0d0: 2020 2020 2020 2020 2055 6e69 6f6e 5b0a           Union[.
+0001c0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c0f0: 2020 2020 5275 6e6e 6162 6c65 5b49 6e70      Runnable[Inp
+0001c100: 7574 2c20 416e 795d 2c0a 2020 2020 2020  ut, Any],.      
+0001c110: 2020 2020 2020 2020 2020 2020 2020 4361                Ca
+0001c120: 6c6c 6162 6c65 5b5b 496e 7075 745d 2c20  llable[[Input], 
+0001c130: 416e 795d 2c0a 2020 2020 2020 2020 2020  Any],.          
+0001c140: 2020 2020 2020 2020 2020 4d61 7070 696e            Mappin
+0001c150: 675b 7374 722c 2055 6e69 6f6e 5b52 756e  g[str, Union[Run
+0001c160: 6e61 626c 655b 496e 7075 742c 2041 6e79  nable[Input, Any
+0001c170: 5d2c 2043 616c 6c61 626c 655b 5b49 6e70  ], Callable[[Inp
+0001c180: 7574 5d2c 2041 6e79 5d5d 5d2c 0a20 2020  ut], Any]]],.   
+0001c190: 2020 2020 2020 2020 2020 2020 205d 2c0a               ],.
+0001c1a0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
+0001c1b0: 2020 2020 2020 5d20 3d20 4e6f 6e65 2c0a        ] = None,.
+0001c1c0: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+0001c1d0: 3a20 556e 696f 6e5b 0a20 2020 2020 2020  : Union[.       
+0001c1e0: 2020 2020 2052 756e 6e61 626c 655b 496e       Runnable[In
+0001c1f0: 7075 742c 2041 6e79 5d2c 0a20 2020 2020  put, Any],.     
+0001c200: 2020 2020 2020 2043 616c 6c61 626c 655b         Callable[
+0001c210: 5b49 6e70 7574 5d2c 2041 6e79 5d2c 0a20  [Input], Any],. 
+0001c220: 2020 2020 2020 2020 2020 204d 6170 7069             Mappi
+0001c230: 6e67 5b73 7472 2c20 556e 696f 6e5b 5275  ng[str, Union[Ru
+0001c240: 6e6e 6162 6c65 5b49 6e70 7574 2c20 416e  nnable[Input, An
+0001c250: 795d 2c20 4361 6c6c 6162 6c65 5b5b 496e  y], Callable[[In
+0001c260: 7075 745d 2c20 416e 795d 5d5d 2c0a 2020  put], Any]]],.  
+0001c270: 2020 2020 2020 5d2c 0a20 2020 2029 202d        ],.    ) -
+0001c280: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+0001c290: 6d65 7267 6564 203d 207b 2a2a 7374 6570  merged = {**step
+0001c2a0: 735f 5f7d 2069 6620 7374 6570 735f 5f20  s__} if steps__ 
+0001c2b0: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+0001c2c0: 207b 7d0a 2020 2020 2020 2020 6d65 7267   {}.        merg
+0001c2d0: 6564 2e75 7064 6174 6528 6b77 6172 6773  ed.update(kwargs
+0001c2e0: 290a 2020 2020 2020 2020 7375 7065 7228  ).        super(
+0001c2f0: 292e 5f5f 696e 6974 5f5f 2820 2023 2074  ).__init__(  # t
+0001c300: 7970 653a 2069 676e 6f72 655b 6361 6c6c  ype: ignore[call
+0001c310: 2d61 7267 5d0a 2020 2020 2020 2020 2020  -arg].          
+0001c320: 2020 7374 6570 735f 5f3d 7b6b 6579 3a20    steps__={key: 
+0001c330: 636f 6572 6365 5f74 6f5f 7275 6e6e 6162  coerce_to_runnab
+0001c340: 6c65 2872 2920 666f 7220 6b65 792c 2072  le(r) for key, r
+0001c350: 2069 6e20 6d65 7267 6564 2e69 7465 6d73   in merged.items
+0001c360: 2829 7d0a 2020 2020 2020 2020 290a 0a20  ()}.        ).. 
+0001c370: 2020 2040 636c 6173 736d 6574 686f 640a     @classmethod.
+0001c380: 2020 2020 6465 6620 6973 5f6c 635f 7365      def is_lc_se
+0001c390: 7269 616c 697a 6162 6c65 2863 6c73 2920  rializable(cls) 
+0001c3a0: 2d3e 2062 6f6f 6c3a 0a20 2020 2020 2020  -> bool:.       
+0001c3b0: 2072 6574 7572 6e20 5472 7565 0a0a 2020   return True..  
+0001c3c0: 2020 4063 6c61 7373 6d65 7468 6f64 0a20    @classmethod. 
+0001c3d0: 2020 2064 6566 2067 6574 5f6c 635f 6e61     def get_lc_na
+0001c3e0: 6d65 7370 6163 6528 636c 7329 202d 3e20  mespace(cls) -> 
+0001c3f0: 4c69 7374 5b73 7472 5d3a 0a20 2020 2020  List[str]:.     
+0001c400: 2020 2022 2222 4765 7420 7468 6520 6e61     """Get the na
+0001c410: 6d65 7370 6163 6520 6f66 2074 6865 206c  mespace of the l
+0001c420: 616e 6763 6861 696e 206f 626a 6563 742e  angchain object.
+0001c430: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
+0001c440: 726e 205b 226c 616e 6763 6861 696e 222c  rn ["langchain",
+0001c450: 2022 7363 6865 6d61 222c 2022 7275 6e6e   "schema", "runn
+0001c460: 6162 6c65 225d 0a0a 2020 2020 636c 6173  able"]..    clas
+0001c470: 7320 436f 6e66 6967 3a0a 2020 2020 2020  s Config:.      
+0001c480: 2020 6172 6269 7472 6172 795f 7479 7065    arbitrary_type
+0001c490: 735f 616c 6c6f 7765 6420 3d20 5472 7565  s_allowed = True
+0001c4a0: 0a0a 2020 2020 6465 6620 6765 745f 6e61  ..    def get_na
+0001c4b0: 6d65 280a 2020 2020 2020 2020 7365 6c66  me(.        self
+0001c4c0: 2c20 7375 6666 6978 3a20 4f70 7469 6f6e  , suffix: Option
+0001c4d0: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c20  al[str] = None, 
+0001c4e0: 2a2c 206e 616d 653a 204f 7074 696f 6e61  *, name: Optiona
+0001c4f0: 6c5b 7374 725d 203d 204e 6f6e 650a 2020  l[str] = None.  
+0001c500: 2020 2920 2d3e 2073 7472 3a0a 2020 2020    ) -> str:.    
+0001c510: 2020 2020 6e61 6d65 203d 206e 616d 6520      name = name 
+0001c520: 6f72 2073 656c 662e 6e61 6d65 206f 7220  or self.name or 
+0001c530: 6622 5275 6e6e 6162 6c65 5061 7261 6c6c  f"RunnableParall
+0001c540: 656c 3c7b 272c 272e 6a6f 696e 2873 656c  el<{','.join(sel
+0001c550: 662e 7374 6570 735f 5f2e 6b65 7973 2829  f.steps__.keys()
+0001c560: 297d 3e22 0a20 2020 2020 2020 2072 6574  )}>".        ret
+0001c570: 7572 6e20 7375 7065 7228 292e 6765 745f  urn super().get_
+0001c580: 6e61 6d65 2873 7566 6669 782c 206e 616d  name(suffix, nam
+0001c590: 653d 6e61 6d65 290a 0a20 2020 2040 7072  e=name)..    @pr
+0001c5a0: 6f70 6572 7479 0a20 2020 2064 6566 2049  operty.    def I
+0001c5b0: 6e70 7574 5479 7065 2873 656c 6629 202d  nputType(self) -
+0001c5c0: 3e20 416e 793a 0a20 2020 2020 2020 2066  > Any:.        f
+0001c5d0: 6f72 2073 7465 7020 696e 2073 656c 662e  or step in self.
+0001c5e0: 7374 6570 735f 5f2e 7661 6c75 6573 2829  steps__.values()
+0001c5f0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0001c600: 2073 7465 702e 496e 7075 7454 7970 653a   step.InputType:
+0001c610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c620: 2072 6574 7572 6e20 7374 6570 2e49 6e70   return step.Inp
+0001c630: 7574 5479 7065 0a0a 2020 2020 2020 2020  utType..        
+0001c640: 7265 7475 726e 2041 6e79 0a0a 2020 2020  return Any..    
+0001c650: 6465 6620 6765 745f 696e 7075 745f 7363  def get_input_sc
+0001c660: 6865 6d61 280a 2020 2020 2020 2020 7365  hema(.        se
+0001c670: 6c66 2c20 636f 6e66 6967 3a20 4f70 7469  lf, config: Opti
+0001c680: 6f6e 616c 5b52 756e 6e61 626c 6543 6f6e  onal[RunnableCon
+0001c690: 6669 675d 203d 204e 6f6e 650a 2020 2020  fig] = None.    
+0001c6a0: 2920 2d3e 2054 7970 655b 4261 7365 4d6f  ) -> Type[BaseMo
+0001c6b0: 6465 6c5d 3a0a 2020 2020 2020 2020 6966  del]:.        if
+0001c6c0: 2061 6c6c 280a 2020 2020 2020 2020 2020   all(.          
+0001c6d0: 2020 732e 6765 745f 696e 7075 745f 7363    s.get_input_sc
+0001c6e0: 6865 6d61 2863 6f6e 6669 6729 2e73 6368  hema(config).sch
+0001c6f0: 656d 6128 292e 6765 7428 2274 7970 6522  ema().get("type"
+0001c700: 2c20 226f 626a 6563 7422 2920 3d3d 2022  , "object") == "
+0001c710: 6f62 6a65 6374 220a 2020 2020 2020 2020  object".        
+0001c720: 2020 2020 666f 7220 7320 696e 2073 656c      for s in sel
+0001c730: 662e 7374 6570 735f 5f2e 7661 6c75 6573  f.steps__.values
+0001c740: 2829 0a20 2020 2020 2020 2029 3a0a 2020  ().        ):.  
+0001c750: 2020 2020 2020 2020 2020 2320 5468 6973            # This
+0001c760: 2069 7320 636f 7272 6563 742c 2062 7574   is correct, but
+0001c770: 2070 7964 616e 7469 6320 7479 7069 6e67   pydantic typing
+0001c780: 732f 6d79 7079 2064 6f6e 2774 2074 6869  s/mypy don't thi
+0001c790: 6e6b 2073 6f2e 0a20 2020 2020 2020 2020  nk so..         
+0001c7a0: 2020 2072 6574 7572 6e20 6372 6561 7465     return create
+0001c7b0: 5f6d 6f64 656c 2820 2023 2074 7970 653a  _model(  # type:
+0001c7c0: 2069 676e 6f72 655b 6361 6c6c 2d6f 7665   ignore[call-ove
+0001c7d0: 726c 6f61 645d 0a20 2020 2020 2020 2020  rload].         
+0001c7e0: 2020 2020 2020 2073 656c 662e 6765 745f         self.get_
+0001c7f0: 6e61 6d65 2822 496e 7075 7422 292c 0a20  name("Input"),. 
+0001c800: 2020 2020 2020 2020 2020 2020 2020 202a                 *
+0001c810: 2a7b 0a20 2020 2020 2020 2020 2020 2020  *{.             
+0001c820: 2020 2020 2020 206b 3a20 2876 2e61 6e6e         k: (v.ann
+0001c830: 6f74 6174 696f 6e2c 2076 2e64 6566 6175  otation, v.defau
+0001c840: 6c74 290a 2020 2020 2020 2020 2020 2020  lt).            
+0001c850: 2020 2020 2020 2020 666f 7220 7374 6570          for step
+0001c860: 2069 6e20 7365 6c66 2e73 7465 7073 5f5f   in self.steps__
+0001c870: 2e76 616c 7565 7328 290a 2020 2020 2020  .values().      
+0001c880: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0001c890: 7220 6b2c 2076 2069 6e20 7374 6570 2e67  r k, v in step.g
+0001c8a0: 6574 5f69 6e70 7574 5f73 6368 656d 6128  et_input_schema(
+0001c8b0: 636f 6e66 6967 292e 5f5f 6669 656c 6473  config).__fields
+0001c8c0: 5f5f 2e69 7465 6d73 2829 0a20 2020 2020  __.items().     
+0001c8d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001c8e0: 6620 6b20 213d 2022 5f5f 726f 6f74 5f5f  f k != "__root__
+0001c8f0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0001c900: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
+0001c910: 2029 0a0a 2020 2020 2020 2020 7265 7475   )..        retu
+0001c920: 726e 2073 7570 6572 2829 2e67 6574 5f69  rn super().get_i
+0001c930: 6e70 7574 5f73 6368 656d 6128 636f 6e66  nput_schema(conf
+0001c940: 6967 290a 0a20 2020 2064 6566 2067 6574  ig)..    def get
+0001c950: 5f6f 7574 7075 745f 7363 6865 6d61 280a  _output_schema(.
+0001c960: 2020 2020 2020 2020 7365 6c66 2c20 636f          self, co
+0001c970: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
+0001c980: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
+0001c990: 204e 6f6e 650a 2020 2020 2920 2d3e 2054   None.    ) -> T
+0001c9a0: 7970 655b 4261 7365 4d6f 6465 6c5d 3a0a  ype[BaseModel]:.
+0001c9b0: 2020 2020 2020 2020 2320 5468 6973 2069          # This i
+0001c9c0: 7320 636f 7272 6563 742c 2062 7574 2070  s correct, but p
+0001c9d0: 7964 616e 7469 6320 7479 7069 6e67 732f  ydantic typings/
+0001c9e0: 6d79 7079 2064 6f6e 2774 2074 6869 6e6b  mypy don't think
+0001c9f0: 2073 6f2e 0a20 2020 2020 2020 2072 6574   so..        ret
+0001ca00: 7572 6e20 6372 6561 7465 5f6d 6f64 656c  urn create_model
+0001ca10: 2820 2023 2074 7970 653a 2069 676e 6f72  (  # type: ignor
+0001ca20: 655b 6361 6c6c 2d6f 7665 726c 6f61 645d  e[call-overload]
+0001ca30: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001ca40: 662e 6765 745f 6e61 6d65 2822 4f75 7470  f.get_name("Outp
+0001ca50: 7574 2229 2c0a 2020 2020 2020 2020 2020  ut"),.          
+0001ca60: 2020 2a2a 7b6b 3a20 2876 2e4f 7574 7075    **{k: (v.Outpu
+0001ca70: 7454 7970 652c 204e 6f6e 6529 2066 6f72  tType, None) for
+0001ca80: 206b 2c20 7620 696e 2073 656c 662e 7374   k, v in self.st
+0001ca90: 6570 735f 5f2e 6974 656d 7328 297d 2c0a  eps__.items()},.
+0001caa0: 2020 2020 2020 2020 290a 0a20 2020 2040          )..    @
+0001cab0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+0001cac0: 2063 6f6e 6669 675f 7370 6563 7328 7365   config_specs(se
+0001cad0: 6c66 2920 2d3e 204c 6973 745b 436f 6e66  lf) -> List[Conf
+0001cae0: 6967 7572 6162 6c65 4669 656c 6453 7065  igurableFieldSpe
+0001caf0: 635d 3a0a 2020 2020 2020 2020 7265 7475  c]:.        retu
+0001cb00: 726e 2067 6574 5f75 6e69 7175 655f 636f  rn get_unique_co
+0001cb10: 6e66 6967 5f73 7065 6373 280a 2020 2020  nfig_specs(.    
+0001cb20: 2020 2020 2020 2020 7370 6563 2066 6f72          spec for
+0001cb30: 2073 7465 7020 696e 2073 656c 662e 7374   step in self.st
+0001cb40: 6570 735f 5f2e 7661 6c75 6573 2829 2066  eps__.values() f
+0001cb50: 6f72 2073 7065 6320 696e 2073 7465 702e  or spec in step.
+0001cb60: 636f 6e66 6967 5f73 7065 6373 0a20 2020  config_specs.   
+0001cb70: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+0001cb80: 6765 745f 6772 6170 6828 7365 6c66 2c20  get_graph(self, 
+0001cb90: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
+0001cba0: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+0001cbb0: 203d 204e 6f6e 6529 202d 3e20 4772 6170   = None) -> Grap
+0001cbc0: 683a 0a20 2020 2020 2020 2066 726f 6d20  h:.        from 
+0001cbd0: 6c61 6e67 6368 6169 6e5f 636f 7265 2e72  langchain_core.r
+0001cbe0: 756e 6e61 626c 6573 2e67 7261 7068 2069  unnables.graph i
+0001cbf0: 6d70 6f72 7420 4772 6170 680a 0a20 2020  mport Graph..   
+0001cc00: 2020 2020 2067 7261 7068 203d 2047 7261       graph = Gra
+0001cc10: 7068 2829 0a20 2020 2020 2020 2069 6e70  ph().        inp
+0001cc20: 7574 5f6e 6f64 6520 3d20 6772 6170 682e  ut_node = graph.
+0001cc30: 6164 645f 6e6f 6465 2873 656c 662e 6765  add_node(self.ge
+0001cc40: 745f 696e 7075 745f 7363 6865 6d61 2863  t_input_schema(c
+0001cc50: 6f6e 6669 6729 290a 2020 2020 2020 2020  onfig)).        
+0001cc60: 6f75 7470 7574 5f6e 6f64 6520 3d20 6772  output_node = gr
+0001cc70: 6170 682e 6164 645f 6e6f 6465 2873 656c  aph.add_node(sel
+0001cc80: 662e 6765 745f 6f75 7470 7574 5f73 6368  f.get_output_sch
+0001cc90: 656d 6128 636f 6e66 6967 2929 0a20 2020  ema(config)).   
+0001cca0: 2020 2020 2066 6f72 2073 7465 7020 696e       for step in
+0001ccb0: 2073 656c 662e 7374 6570 735f 5f2e 7661   self.steps__.va
+0001ccc0: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
+0001ccd0: 2020 2020 7374 6570 5f67 7261 7068 203d      step_graph =
+0001cce0: 2073 7465 702e 6765 745f 6772 6170 6828   step.get_graph(
+0001ccf0: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
+0001cd00: 6570 5f67 7261 7068 2e74 7269 6d5f 6669  ep_graph.trim_fi
+0001cd10: 7273 745f 6e6f 6465 2829 0a20 2020 2020  rst_node().     
+0001cd20: 2020 2020 2020 2073 7465 705f 6772 6170         step_grap
+0001cd30: 682e 7472 696d 5f6c 6173 745f 6e6f 6465  h.trim_last_node
+0001cd40: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
+0001cd50: 6620 6e6f 7420 7374 6570 5f67 7261 7068  f not step_graph
+0001cd60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001cd70: 2020 6772 6170 682e 6164 645f 6564 6765    graph.add_edge
+0001cd80: 2869 6e70 7574 5f6e 6f64 652c 206f 7574  (input_node, out
+0001cd90: 7075 745f 6e6f 6465 290a 2020 2020 2020  put_node).      
+0001cda0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001cdb0: 2020 2020 2020 2020 2020 2020 7374 6570              step
+0001cdc0: 5f66 6972 7374 5f6e 6f64 652c 2073 7465  _first_node, ste
+0001cdd0: 705f 6c61 7374 5f6e 6f64 6520 3d20 6772  p_last_node = gr
+0001cde0: 6170 682e 6578 7465 6e64 2873 7465 705f  aph.extend(step_
+0001cdf0: 6772 6170 6829 0a20 2020 2020 2020 2020  graph).         
+0001ce00: 2020 2020 2020 2069 6620 6e6f 7420 7374         if not st
+0001ce10: 6570 5f66 6972 7374 5f6e 6f64 653a 0a20  ep_first_node:. 
+0001ce20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce30: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+0001ce40: 726f 7228 6622 5275 6e6e 6162 6c65 207b  ror(f"Runnable {
+0001ce50: 7374 6570 7d20 6861 7320 6e6f 2066 6972  step} has no fir
+0001ce60: 7374 206e 6f64 6522 290a 2020 2020 2020  st node").      
+0001ce70: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+0001ce80: 2073 7465 705f 6c61 7374 5f6e 6f64 653a   step_last_node:
+0001ce90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cea0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+0001ceb0: 4572 726f 7228 6622 5275 6e6e 6162 6c65  Error(f"Runnable
+0001cec0: 207b 7374 6570 7d20 6861 7320 6e6f 206c   {step} has no l
+0001ced0: 6173 7420 6e6f 6465 2229 0a20 2020 2020  ast node").     
+0001cee0: 2020 2020 2020 2020 2020 2067 7261 7068             graph
+0001cef0: 2e61 6464 5f65 6467 6528 696e 7075 745f  .add_edge(input_
+0001cf00: 6e6f 6465 2c20 7374 6570 5f66 6972 7374  node, step_first
+0001cf10: 5f6e 6f64 6529 0a20 2020 2020 2020 2020  _node).         
+0001cf20: 2020 2020 2020 2067 7261 7068 2e61 6464         graph.add
+0001cf30: 5f65 6467 6528 7374 6570 5f6c 6173 745f  _edge(step_last_
+0001cf40: 6e6f 6465 2c20 6f75 7470 7574 5f6e 6f64  node, output_nod
+0001cf50: 6529 0a0a 2020 2020 2020 2020 7265 7475  e)..        retu
+0001cf60: 726e 2067 7261 7068 0a0a 2020 2020 6465  rn graph..    de
+0001cf70: 6620 5f5f 7265 7072 5f5f 2873 656c 6629  f __repr__(self)
+0001cf80: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
+0001cf90: 206d 6170 5f66 6f72 5f72 6570 7220 3d20   map_for_repr = 
+0001cfa0: 222c 5c6e 2020 222e 6a6f 696e 280a 2020  ",\n  ".join(.  
+0001cfb0: 2020 2020 2020 2020 2020 6622 7b6b 7d3a            f"{k}:
+0001cfc0: 207b 696e 6465 6e74 5f6c 696e 6573 5f61   {indent_lines_a
+0001cfd0: 6674 6572 5f66 6972 7374 2872 6570 7228  fter_first(repr(
+0001cfe0: 7629 2c20 2720 2027 202b 206b 202b 2027  v), '  ' + k + '
+0001cff0: 3a20 2729 7d22 0a20 2020 2020 2020 2020  : ')}".         
+0001d000: 2020 2066 6f72 206b 2c20 7620 696e 2073     for k, v in s
+0001d010: 656c 662e 7374 6570 735f 5f2e 6974 656d  elf.steps__.item
+0001d020: 7328 290a 2020 2020 2020 2020 290a 2020  s().        ).  
+0001d030: 2020 2020 2020 7265 7475 726e 2022 7b5c        return "{\
+0001d040: 6e20 2022 202b 206d 6170 5f66 6f72 5f72  n  " + map_for_r
+0001d050: 6570 7220 2b20 225c 6e7d 220a 0a20 2020  epr + "\n}"..   
+0001d060: 2064 6566 2069 6e76 6f6b 6528 0a20 2020   def invoke(.   
+0001d070: 2020 2020 2073 656c 662c 2069 6e70 7574       self, input
+0001d080: 3a20 496e 7075 742c 2063 6f6e 6669 673a  : Input, config:
+0001d090: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
+0001d0a0: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
+0001d0b0: 0a20 2020 2029 202d 3e20 4469 6374 5b73  .    ) -> Dict[s
+0001d0c0: 7472 2c20 416e 795d 3a0a 2020 2020 2020  tr, Any]:.      
+0001d0d0: 2020 6672 6f6d 206c 616e 6763 6861 696e    from langchain
+0001d0e0: 5f63 6f72 652e 6361 6c6c 6261 636b 732e  _core.callbacks.
+0001d0f0: 6d61 6e61 6765 7220 696d 706f 7274 2043  manager import C
+0001d100: 616c 6c62 6163 6b4d 616e 6167 6572 0a0a  allbackManager..
+0001d110: 2020 2020 2020 2020 2320 7365 7475 7020          # setup 
+0001d120: 6361 6c6c 6261 636b 730a 2020 2020 2020  callbacks.      
+0001d130: 2020 636f 6e66 6967 203d 2065 6e73 7572    config = ensur
+0001d140: 655f 636f 6e66 6967 2863 6f6e 6669 6729  e_config(config)
+0001d150: 0a20 2020 2020 2020 2063 616c 6c62 6163  .        callbac
+0001d160: 6b5f 6d61 6e61 6765 7220 3d20 4361 6c6c  k_manager = Call
+0001d170: 6261 636b 4d61 6e61 6765 722e 636f 6e66  backManager.conf
+0001d180: 6967 7572 6528 0a20 2020 2020 2020 2020  igure(.         
+0001d190: 2020 2069 6e68 6572 6974 6162 6c65 5f63     inheritable_c
+0001d1a0: 616c 6c62 6163 6b73 3d63 6f6e 6669 672e  allbacks=config.
+0001d1b0: 6765 7428 2263 616c 6c62 6163 6b73 2229  get("callbacks")
+0001d1c0: 2c0a 2020 2020 2020 2020 2020 2020 6c6f  ,.            lo
+0001d1d0: 6361 6c5f 6361 6c6c 6261 636b 733d 4e6f  cal_callbacks=No
+0001d1e0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+0001d1f0: 7665 7262 6f73 653d 4661 6c73 652c 0a20  verbose=False,. 
+0001d200: 2020 2020 2020 2020 2020 2069 6e68 6572             inher
+0001d210: 6974 6162 6c65 5f74 6167 733d 636f 6e66  itable_tags=conf
+0001d220: 6967 2e67 6574 2822 7461 6773 2229 2c0a  ig.get("tags"),.
+0001d230: 2020 2020 2020 2020 2020 2020 6c6f 6361              loca
+0001d240: 6c5f 7461 6773 3d4e 6f6e 652c 0a20 2020  l_tags=None,.   
+0001d250: 2020 2020 2020 2020 2069 6e68 6572 6974           inherit
+0001d260: 6162 6c65 5f6d 6574 6164 6174 613d 636f  able_metadata=co
+0001d270: 6e66 6967 2e67 6574 2822 6d65 7461 6461  nfig.get("metada
+0001d280: 7461 2229 2c0a 2020 2020 2020 2020 2020  ta"),.          
+0001d290: 2020 6c6f 6361 6c5f 6d65 7461 6461 7461    local_metadata
+0001d2a0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2029  =None,.        )
+0001d2b0: 0a20 2020 2020 2020 2023 2073 7461 7274  .        # start
+0001d2c0: 2074 6865 2072 6f6f 7420 7275 6e0a 2020   the root run.  
+0001d2d0: 2020 2020 2020 7275 6e5f 6d61 6e61 6765        run_manage
+0001d2e0: 7220 3d20 6361 6c6c 6261 636b 5f6d 616e  r = callback_man
+0001d2f0: 6167 6572 2e6f 6e5f 6368 6169 6e5f 7374  ager.on_chain_st
+0001d300: 6172 7428 0a20 2020 2020 2020 2020 2020  art(.           
+0001d310: 2064 756d 7064 2873 656c 6629 2c0a 2020   dumpd(self),.  
+0001d320: 2020 2020 2020 2020 2020 696e 7075 742c            input,
+0001d330: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+0001d340: 653d 636f 6e66 6967 2e67 6574 2822 7275  e=config.get("ru
+0001d350: 6e5f 6e61 6d65 2229 206f 7220 7365 6c66  n_name") or self
+0001d360: 2e67 6574 5f6e 616d 6528 292c 0a20 2020  .get_name(),.   
+0001d370: 2020 2020 2020 2020 2072 756e 5f69 643d           run_id=
+0001d380: 636f 6e66 6967 2e70 6f70 2822 7275 6e5f  config.pop("run_
+0001d390: 6964 222c 204e 6f6e 6529 2c0a 2020 2020  id", None),.    
+0001d3a0: 2020 2020 290a 0a20 2020 2020 2020 2023      )..        #
+0001d3b0: 2067 6174 6865 7220 7265 7375 6c74 7320   gather results 
+0001d3c0: 6672 6f6d 2061 6c6c 2073 7465 7073 0a20  from all steps. 
+0001d3d0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0001d3e0: 2020 2020 2020 2020 2320 636f 7079 2074          # copy t
+0001d3f0: 6f20 6176 6f69 6420 6973 7375 6573 2066  o avoid issues f
+0001d400: 726f 6d20 7468 6520 6361 6c6c 6572 206d  rom the caller m
+0001d410: 7574 6174 696e 6720 7468 6520 7374 6570  utating the step
+0001d420: 7320 6475 7269 6e67 2069 6e76 6f6b 6528  s during invoke(
+0001d430: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
+0001d440: 6570 7320 3d20 6469 6374 2873 656c 662e  eps = dict(self.
+0001d450: 7374 6570 735f 5f29 0a20 2020 2020 2020  steps__).       
+0001d460: 2020 2020 2077 6974 6820 6765 745f 6578       with get_ex
+0001d470: 6563 7574 6f72 5f66 6f72 5f63 6f6e 6669  ecutor_for_confi
+0001d480: 6728 636f 6e66 6967 2920 6173 2065 7865  g(config) as exe
+0001d490: 6375 746f 723a 0a20 2020 2020 2020 2020  cutor:.         
+0001d4a0: 2020 2020 2020 2066 7574 7572 6573 203d         futures =
+0001d4b0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+0001d4c0: 2020 2020 2020 2065 7865 6375 746f 722e         executor.
+0001d4d0: 7375 626d 6974 280a 2020 2020 2020 2020  submit(.        
+0001d4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d4f0: 7374 6570 2e69 6e76 6f6b 652c 0a20 2020  step.invoke,.   
+0001d500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d510: 2020 2020 2069 6e70 7574 2c0a 2020 2020       input,.    
+0001d520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d530: 2020 2020 2320 6d61 726b 2065 6163 6820      # mark each 
+0001d540: 7374 6570 2061 7320 6120 6368 696c 6420  step as a child 
+0001d550: 7275 6e0a 2020 2020 2020 2020 2020 2020  run.            
+0001d560: 2020 2020 2020 2020 2020 2020 7061 7463              patc
+0001d570: 685f 636f 6e66 6967 280a 2020 2020 2020  h_config(.      
+0001d580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d590: 2020 2020 2020 636f 6e66 6967 2c0a 2020        config,.  
+0001d5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d5b0: 2020 2020 2020 2020 2020 6361 6c6c 6261            callba
+0001d5c0: 636b 733d 7275 6e5f 6d61 6e61 6765 722e  cks=run_manager.
+0001d5d0: 6765 745f 6368 696c 6428 6622 6d61 703a  get_child(f"map:
+0001d5e0: 6b65 793a 7b6b 6579 7d22 292c 0a20 2020  key:{key}"),.   
+0001d5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d600: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+0001d610: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0001d620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d630: 2020 666f 7220 6b65 792c 2073 7465 7020    for key, step 
+0001d640: 696e 2073 7465 7073 2e69 7465 6d73 2829  in steps.items()
+0001d650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d660: 205d 0a20 2020 2020 2020 2020 2020 2020   ].             
+0001d670: 2020 206f 7574 7075 7420 3d20 7b6b 6579     output = {key
+0001d680: 3a20 6675 7475 7265 2e72 6573 756c 7428  : future.result(
+0001d690: 2920 666f 7220 6b65 792c 2066 7574 7572  ) for key, futur
+0001d6a0: 6520 696e 207a 6970 2873 7465 7073 2c20  e in zip(steps, 
+0001d6b0: 6675 7475 7265 7329 7d0a 2020 2020 2020  futures)}.      
+0001d6c0: 2020 2320 6669 6e69 7368 2074 6865 2072    # finish the r
+0001d6d0: 6f6f 7420 7275 6e0a 2020 2020 2020 2020  oot run.        
+0001d6e0: 6578 6365 7074 2042 6173 6545 7863 6570  except BaseExcep
+0001d6f0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+0001d700: 2020 2020 2020 2072 756e 5f6d 616e 6167         run_manag
+0001d710: 6572 2e6f 6e5f 6368 6169 6e5f 6572 726f  er.on_chain_erro
+0001d720: 7228 6529 0a20 2020 2020 2020 2020 2020  r(e).           
+0001d730: 2072 6169 7365 0a20 2020 2020 2020 2065   raise.        e
+0001d740: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001d750: 2072 756e 5f6d 616e 6167 6572 2e6f 6e5f   run_manager.on_
+0001d760: 6368 6169 6e5f 656e 6428 6f75 7470 7574  chain_end(output
+0001d770: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+0001d780: 7475 726e 206f 7574 7075 740a 0a20 2020  turn output..   
+0001d790: 2061 7379 6e63 2064 6566 2061 696e 766f   async def ainvo
+0001d7a0: 6b65 280a 2020 2020 2020 2020 7365 6c66  ke(.        self
+0001d7b0: 2c0a 2020 2020 2020 2020 696e 7075 743a  ,.        input:
+0001d7c0: 2049 6e70 7574 2c0a 2020 2020 2020 2020   Input,.        
+0001d7d0: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
+0001d7e0: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+0001d7f0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0001d800: 202a 2a6b 7761 7267 733a 204f 7074 696f   **kwargs: Optio
+0001d810: 6e61 6c5b 416e 795d 2c0a 2020 2020 2920  nal[Any],.    ) 
+0001d820: 2d3e 2044 6963 745b 7374 722c 2041 6e79  -> Dict[str, Any
+0001d830: 5d3a 0a20 2020 2020 2020 2023 2073 6574  ]:.        # set
+0001d840: 7570 2063 616c 6c62 6163 6b73 0a20 2020  up callbacks.   
+0001d850: 2020 2020 2063 6f6e 6669 6720 3d20 656e       config = en
+0001d860: 7375 7265 5f63 6f6e 6669 6728 636f 6e66  sure_config(conf
+0001d870: 6967 290a 2020 2020 2020 2020 6361 6c6c  ig).        call
+0001d880: 6261 636b 5f6d 616e 6167 6572 203d 2067  back_manager = g
+0001d890: 6574 5f61 7379 6e63 5f63 616c 6c62 6163  et_async_callbac
+0001d8a0: 6b5f 6d61 6e61 6765 725f 666f 725f 636f  k_manager_for_co
+0001d8b0: 6e66 6967 2863 6f6e 6669 6729 0a20 2020  nfig(config).   
+0001d8c0: 2020 2020 2023 2073 7461 7274 2074 6865       # start the
+0001d8d0: 2072 6f6f 7420 7275 6e0a 2020 2020 2020   root run.      
+0001d8e0: 2020 7275 6e5f 6d61 6e61 6765 7220 3d20    run_manager = 
+0001d8f0: 6177 6169 7420 6361 6c6c 6261 636b 5f6d  await callback_m
+0001d900: 616e 6167 6572 2e6f 6e5f 6368 6169 6e5f  anager.on_chain_
+0001d910: 7374 6172 7428 0a20 2020 2020 2020 2020  start(.         
+0001d920: 2020 2064 756d 7064 2873 656c 6629 2c0a     dumpd(self),.
+0001d930: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+0001d940: 742c 0a20 2020 2020 2020 2020 2020 206e  t,.            n
+0001d950: 616d 653d 636f 6e66 6967 2e67 6574 2822  ame=config.get("
+0001d960: 7275 6e5f 6e61 6d65 2229 206f 7220 7365  run_name") or se
+0001d970: 6c66 2e67 6574 5f6e 616d 6528 292c 0a20  lf.get_name(),. 
+0001d980: 2020 2020 2020 2020 2020 2072 756e 5f69             run_i
+0001d990: 643d 636f 6e66 6967 2e70 6f70 2822 7275  d=config.pop("ru
+0001d9a0: 6e5f 6964 222c 204e 6f6e 6529 2c0a 2020  n_id", None),.  
+0001d9b0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0001d9c0: 2023 2067 6174 6865 7220 7265 7375 6c74   # gather result
+0001d9d0: 7320 6672 6f6d 2061 6c6c 2073 7465 7073  s from all steps
+0001d9e0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+0001d9f0: 2020 2020 2020 2020 2020 2320 636f 7079            # copy
+0001da00: 2074 6f20 6176 6f69 6420 6973 7375 6573   to avoid issues
+0001da10: 2066 726f 6d20 7468 6520 6361 6c6c 6572   from the caller
+0001da20: 206d 7574 6174 696e 6720 7468 6520 7374   mutating the st
+0001da30: 6570 7320 6475 7269 6e67 2069 6e76 6f6b  eps during invok
+0001da40: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+0001da50: 7374 6570 7320 3d20 6469 6374 2873 656c  steps = dict(sel
+0001da60: 662e 7374 6570 735f 5f29 0a20 2020 2020  f.steps__).     
+0001da70: 2020 2020 2020 2072 6573 756c 7473 203d         results =
+0001da80: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
+0001da90: 6174 6865 7228 0a20 2020 2020 2020 2020  ather(.         
+0001daa0: 2020 2020 2020 202a 280a 2020 2020 2020         *(.      
+0001dab0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0001dac0: 6570 2e61 696e 766f 6b65 280a 2020 2020  ep.ainvoke(.    
+0001dad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dae0: 2020 2020 696e 7075 742c 0a20 2020 2020      input,.     
+0001daf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001db00: 2020 2023 206d 6172 6b20 6561 6368 2073     # mark each s
+0001db10: 7465 7020 6173 2061 2063 6869 6c64 2072  tep as a child r
+0001db20: 756e 0a20 2020 2020 2020 2020 2020 2020  un.             
+0001db30: 2020 2020 2020 2020 2020 2070 6174 6368             patch
+0001db40: 5f63 6f6e 6669 6728 0a20 2020 2020 2020  _config(.       
+0001db50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001db60: 2020 2020 2063 6f6e 6669 672c 2063 616c       config, cal
+0001db70: 6c62 6163 6b73 3d72 756e 5f6d 616e 6167  lbacks=run_manag
+0001db80: 6572 2e67 6574 5f63 6869 6c64 2866 226d  er.get_child(f"m
+0001db90: 6170 3a6b 6579 3a7b 6b65 797d 2229 0a20  ap:key:{key}"). 
+0001dba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dbb0: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
+0001dbc0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0001dbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dbe0: 2020 2020 666f 7220 6b65 792c 2073 7465      for key, ste
+0001dbf0: 7020 696e 2073 7465 7073 2e69 7465 6d73  p in steps.items
+0001dc00: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0001dc10: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0001dc20: 2029 0a20 2020 2020 2020 2020 2020 206f   ).            o
+0001dc30: 7574 7075 7420 3d20 7b6b 6579 3a20 7661  utput = {key: va
+0001dc40: 6c75 6520 666f 7220 6b65 792c 2076 616c  lue for key, val
+0001dc50: 7565 2069 6e20 7a69 7028 7374 6570 732c  ue in zip(steps,
+0001dc60: 2072 6573 756c 7473 297d 0a20 2020 2020   results)}.     
+0001dc70: 2020 2023 2066 696e 6973 6820 7468 6520     # finish the 
+0001dc80: 726f 6f74 2072 756e 0a20 2020 2020 2020  root run.       
+0001dc90: 2065 7863 6570 7420 4261 7365 4578 6365   except BaseExce
+0001dca0: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
+0001dcb0: 2020 2020 2020 2020 6177 6169 7420 7275          await ru
+0001dcc0: 6e5f 6d61 6e61 6765 722e 6f6e 5f63 6861  n_manager.on_cha
+0001dcd0: 696e 5f65 7272 6f72 2865 290a 2020 2020  in_error(e).    
+0001dce0: 2020 2020 2020 2020 7261 6973 650a 2020          raise.  
+0001dcf0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001dd00: 2020 2020 2020 2020 6177 6169 7420 7275          await ru
+0001dd10: 6e5f 6d61 6e61 6765 722e 6f6e 5f63 6861  n_manager.on_cha
+0001dd20: 696e 5f65 6e64 286f 7574 7075 7429 0a20  in_end(output). 
+0001dd30: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001dd40: 6e20 6f75 7470 7574 0a0a 2020 2020 6465  n output..    de
+0001dd50: 6620 5f74 7261 6e73 666f 726d 280a 2020  f _transform(.  
+0001dd60: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+0001dd70: 2020 2020 696e 7075 743a 2049 7465 7261      input: Itera
+0001dd80: 746f 725b 496e 7075 745d 2c0a 2020 2020  tor[Input],.    
+0001dd90: 2020 2020 7275 6e5f 6d61 6e61 6765 723a      run_manager:
+0001dda0: 2043 616c 6c62 6163 6b4d 616e 6167 6572   CallbackManager
+0001ddb0: 466f 7243 6861 696e 5275 6e2c 0a20 2020  ForChainRun,.   
+0001ddc0: 2020 2020 2063 6f6e 6669 673a 2052 756e       config: Run
+0001ddd0: 6e61 626c 6543 6f6e 6669 672c 0a20 2020  nableConfig,.   
+0001dde0: 2029 202d 3e20 4974 6572 6174 6f72 5b41   ) -> Iterator[A
+0001ddf0: 6464 6162 6c65 4469 6374 5d3a 0a20 2020  ddableDict]:.   
+0001de00: 2020 2020 2023 2053 6861 6c6c 6f77 2063       # Shallow c
+0001de10: 6f70 7920 7374 6570 7320 746f 2069 676e  opy steps to ign
+0001de20: 6f72 6520 6d75 7461 7469 6f6e 7320 7768  ore mutations wh
+0001de30: 696c 6520 696e 2070 726f 6772 6573 730a  ile in progress.
+0001de40: 2020 2020 2020 2020 7374 6570 7320 3d20          steps = 
+0001de50: 6469 6374 2873 656c 662e 7374 6570 735f  dict(self.steps_
+0001de60: 5f29 0a20 2020 2020 2020 2023 2045 6163  _).        # Eac
+0001de70: 6820 7374 6570 2067 6574 7320 6120 636f  h step gets a co
+0001de80: 7079 206f 6620 7468 6520 696e 7075 7420  py of the input 
+0001de90: 6974 6572 6174 6f72 2c0a 2020 2020 2020  iterator,.      
+0001dea0: 2020 2320 7768 6963 6820 6973 2063 6f6e    # which is con
+0001deb0: 7375 6d65 6420 696e 2070 6172 616c 6c65  sumed in paralle
+0001dec0: 6c20 696e 2061 2073 6570 6172 6174 6520  l in a separate 
+0001ded0: 7468 7265 6164 2e0a 2020 2020 2020 2020  thread..        
+0001dee0: 696e 7075 745f 636f 7069 6573 203d 206c  input_copies = l
+0001def0: 6973 7428 7361 6665 7465 6528 696e 7075  ist(safetee(inpu
+0001df00: 742c 206c 656e 2873 7465 7073 292c 206c  t, len(steps), l
+0001df10: 6f63 6b3d 7468 7265 6164 696e 672e 4c6f  ock=threading.Lo
+0001df20: 636b 2829 2929 0a20 2020 2020 2020 2077  ck())).        w
+0001df30: 6974 6820 6765 745f 6578 6563 7574 6f72  ith get_executor
+0001df40: 5f66 6f72 5f63 6f6e 6669 6728 636f 6e66  _for_config(conf
+0001df50: 6967 2920 6173 2065 7865 6375 746f 723a  ig) as executor:
+0001df60: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
+0001df70: 7265 6174 6520 7468 6520 7472 616e 7366  reate the transf
+0001df80: 6f72 6d28 2920 6765 6e65 7261 746f 7220  orm() generator 
+0001df90: 666f 7220 6561 6368 2073 7465 700a 2020  for each step.  
+0001dfa0: 2020 2020 2020 2020 2020 6e61 6d65 645f            named_
+0001dfb0: 6765 6e65 7261 746f 7273 203d 205b 0a20  generators = [. 
+0001dfc0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+0001dfd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001dfe0: 2020 2020 206e 616d 652c 0a20 2020 2020       name,.     
+0001dff0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001e000: 7465 702e 7472 616e 7366 6f72 6d28 0a20  tep.transform(. 
+0001e010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e020: 2020 2020 2020 2069 6e70 7574 5f63 6f70         input_cop
+0001e030: 6965 732e 706f 7028 292c 0a20 2020 2020  ies.pop(),.     
+0001e040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e050: 2020 2070 6174 6368 5f63 6f6e 6669 6728     patch_config(
+0001e060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e070: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0001e080: 6669 672c 2063 616c 6c62 6163 6b73 3d72  fig, callbacks=r
+0001e090: 756e 5f6d 616e 6167 6572 2e67 6574 5f63  un_manager.get_c
+0001e0a0: 6869 6c64 2866 226d 6170 3a6b 6579 3a7b  hild(f"map:key:{
+0001e0b0: 6e61 6d65 7d22 290a 2020 2020 2020 2020  name}").        
+0001e0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e0d0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0001e0e0: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
+0001e0f0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001e100: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0001e110: 6e61 6d65 2c20 7374 6570 2069 6e20 7374  name, step in st
+0001e120: 6570 732e 6974 656d 7328 290a 2020 2020  eps.items().    
+0001e130: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+0001e140: 2020 2020 2020 2320 5374 6172 7420 7468        # Start th
+0001e150: 6520 6669 7273 7420 6974 6572 6174 696f  e first iteratio
+0001e160: 6e20 6f66 2065 6163 6820 6765 6e65 7261  n of each genera
+0001e170: 746f 720a 2020 2020 2020 2020 2020 2020  tor.            
+0001e180: 6675 7475 7265 7320 3d20 7b0a 2020 2020  futures = {.    
+0001e190: 2020 2020 2020 2020 2020 2020 6578 6563              exec
+0001e1a0: 7574 6f72 2e73 7562 6d69 7428 6e65 7874  utor.submit(next
+0001e1b0: 2c20 6765 6e65 7261 746f 7229 3a20 2873  , generator): (s
+0001e1c0: 7465 705f 6e61 6d65 2c20 6765 6e65 7261  tep_name, genera
+0001e1d0: 746f 7229 0a20 2020 2020 2020 2020 2020  tor).           
+0001e1e0: 2020 2020 2066 6f72 2073 7465 705f 6e61       for step_na
+0001e1f0: 6d65 2c20 6765 6e65 7261 746f 7220 696e  me, generator in
+0001e200: 206e 616d 6564 5f67 656e 6572 6174 6f72   named_generator
+0001e210: 730a 2020 2020 2020 2020 2020 2020 7d0a  s.            }.
+0001e220: 2020 2020 2020 2020 2020 2020 2320 5969              # Yi
+0001e230: 656c 6420 6368 756e 6b73 2066 726f 6d20  eld chunks from 
+0001e240: 6561 6368 2061 7320 7468 6579 2062 6563  each as they bec
+0001e250: 6f6d 6520 6176 6169 6c61 626c 652c 0a20  ome available,. 
+0001e260: 2020 2020 2020 2020 2020 2023 2061 6e64             # and
+0001e270: 2073 7461 7274 2074 6865 206e 6578 7420   start the next 
+0001e280: 6974 6572 6174 696f 6e20 6f66 2074 6861  iteration of tha
+0001e290: 7420 6765 6e65 7261 746f 7220 7468 6174  t generator that
+0001e2a0: 2079 6965 6c64 6564 2069 742e 0a20 2020   yielded it..   
+0001e2b0: 2020 2020 2020 2020 2023 2057 6865 6e20           # When 
+0001e2c0: 616c 6c20 6765 6e65 7261 746f 7273 2061  all generators a
+0001e2d0: 7265 2065 7868 6175 7374 6564 2c20 7374  re exhausted, st
+0001e2e0: 6f70 2e0a 2020 2020 2020 2020 2020 2020  op..            
+0001e2f0: 7768 696c 6520 6675 7475 7265 733a 0a20  while futures:. 
+0001e300: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0001e310: 6f6d 706c 6574 6564 5f66 7574 7572 6573  ompleted_futures
+0001e320: 2c20 5f20 3d20 7761 6974 2866 7574 7572  , _ = wait(futur
+0001e330: 6573 2c20 7265 7475 726e 5f77 6865 6e3d  es, return_when=
+0001e340: 4649 5253 545f 434f 4d50 4c45 5445 4429  FIRST_COMPLETED)
+0001e350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e360: 2066 6f72 2066 7574 7572 6520 696e 2063   for future in c
+0001e370: 6f6d 706c 6574 6564 5f66 7574 7572 6573  ompleted_futures
+0001e380: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001e390: 2020 2020 2020 2873 7465 705f 6e61 6d65        (step_name
+0001e3a0: 2c20 6765 6e65 7261 746f 7229 203d 2066  , generator) = f
+0001e3b0: 7574 7572 6573 2e70 6f70 2866 7574 7572  utures.pop(futur
+0001e3c0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0001e3d0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0001e3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e3f0: 2020 2020 6368 756e 6b20 3d20 4164 6461      chunk = Adda
+0001e400: 626c 6544 6963 7428 7b73 7465 705f 6e61  bleDict({step_na
+0001e410: 6d65 3a20 6675 7475 7265 2e72 6573 756c  me: future.resul
+0001e420: 7428 297d 290a 2020 2020 2020 2020 2020  t()}).          
+0001e430: 2020 2020 2020 2020 2020 2020 2020 7969                yi
+0001e440: 656c 6420 6368 756e 6b0a 2020 2020 2020  eld chunk.      
+0001e450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e460: 2020 6675 7475 7265 735b 6578 6563 7574    futures[execut
+0001e470: 6f72 2e73 7562 6d69 7428 6e65 7874 2c20  or.submit(next, 
+0001e480: 6765 6e65 7261 746f 7229 5d20 3d20 280a  generator)] = (.
+0001e490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e4a0: 2020 2020 2020 2020 2020 2020 7374 6570              step
+0001e4b0: 5f6e 616d 652c 0a20 2020 2020 2020 2020  _name,.         
+0001e4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e4d0: 2020 2067 656e 6572 6174 6f72 2c0a 2020     generator,.  
+0001e4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e4f0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0001e500: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+0001e510: 7074 2053 746f 7049 7465 7261 7469 6f6e  pt StopIteration
+0001e520: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001e530: 2020 2020 2020 2020 2020 7061 7373 0a0a            pass..
+0001e540: 2020 2020 6465 6620 7472 616e 7366 6f72      def transfor
+0001e550: 6d28 0a20 2020 2020 2020 2073 656c 662c  m(.        self,
+0001e560: 0a20 2020 2020 2020 2069 6e70 7574 3a20  .        input: 
+0001e570: 4974 6572 6174 6f72 5b49 6e70 7574 5d2c  Iterator[Input],
+0001e580: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
+0001e590: 204f 7074 696f 6e61 6c5b 5275 6e6e 6162   Optional[Runnab
+0001e5a0: 6c65 436f 6e66 6967 5d20 3d20 4e6f 6e65  leConfig] = None
+0001e5b0: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
+0001e5c0: 6773 3a20 416e 792c 0a20 2020 2029 202d  gs: Any,.    ) -
+0001e5d0: 3e20 4974 6572 6174 6f72 5b44 6963 745b  > Iterator[Dict[
+0001e5e0: 7374 722c 2041 6e79 5d5d 3a0a 2020 2020  str, Any]]:.    
+0001e5f0: 2020 2020 7969 656c 6420 6672 6f6d 2073      yield from s
+0001e600: 656c 662e 5f74 7261 6e73 666f 726d 5f73  elf._transform_s
+0001e610: 7472 6561 6d5f 7769 7468 5f63 6f6e 6669  tream_with_confi
+0001e620: 6728 0a20 2020 2020 2020 2020 2020 2069  g(.            i
+0001e630: 6e70 7574 2c20 7365 6c66 2e5f 7472 616e  nput, self._tran
+0001e640: 7366 6f72 6d2c 2063 6f6e 6669 672c 202a  sform, config, *
+0001e650: 2a6b 7761 7267 730a 2020 2020 2020 2020  *kwargs.        
+0001e660: 290a 0a20 2020 2064 6566 2073 7472 6561  )..    def strea
+0001e670: 6d28 0a20 2020 2020 2020 2073 656c 662c  m(.        self,
+0001e680: 0a20 2020 2020 2020 2069 6e70 7574 3a20  .        input: 
+0001e690: 496e 7075 742c 0a20 2020 2020 2020 2063  Input,.        c
+0001e6a0: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
+0001e6b0: 5275 6e6e 6162 6c65 436f 6e66 6967 5d20  RunnableConfig] 
+0001e6c0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0001e6d0: 2a2a 6b77 6172 6773 3a20 4f70 7469 6f6e  **kwargs: Option
+0001e6e0: 616c 5b41 6e79 5d2c 0a20 2020 2029 202d  al[Any],.    ) -
+0001e6f0: 3e20 4974 6572 6174 6f72 5b44 6963 745b  > Iterator[Dict[
+0001e700: 7374 722c 2041 6e79 5d5d 3a0a 2020 2020  str, Any]]:.    
+0001e710: 2020 2020 7969 656c 6420 6672 6f6d 2073      yield from s
+0001e720: 656c 662e 7472 616e 7366 6f72 6d28 6974  elf.transform(it
+0001e730: 6572 285b 696e 7075 745d 292c 2063 6f6e  er([input]), con
+0001e740: 6669 6729 0a0a 2020 2020 6173 796e 6320  fig)..    async 
+0001e750: 6465 6620 5f61 7472 616e 7366 6f72 6d28  def _atransform(
+0001e760: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+0001e770: 2020 2020 2020 2069 6e70 7574 3a20 4173         input: As
+0001e780: 796e 6349 7465 7261 746f 725b 496e 7075  yncIterator[Inpu
+0001e790: 745d 2c0a 2020 2020 2020 2020 7275 6e5f  t],.        run_
+0001e7a0: 6d61 6e61 6765 723a 2041 7379 6e63 4361  manager: AsyncCa
+0001e7b0: 6c6c 6261 636b 4d61 6e61 6765 7246 6f72  llbackManagerFor
+0001e7c0: 4368 6169 6e52 756e 2c0a 2020 2020 2020  ChainRun,.      
+0001e7d0: 2020 636f 6e66 6967 3a20 5275 6e6e 6162    config: Runnab
+0001e7e0: 6c65 436f 6e66 6967 2c0a 2020 2020 2920  leConfig,.    ) 
+0001e7f0: 2d3e 2041 7379 6e63 4974 6572 6174 6f72  -> AsyncIterator
+0001e800: 5b41 6464 6162 6c65 4469 6374 5d3a 0a20  [AddableDict]:. 
+0001e810: 2020 2020 2020 2023 2053 6861 6c6c 6f77         # Shallow
+0001e820: 2063 6f70 7920 7374 6570 7320 746f 2069   copy steps to i
+0001e830: 676e 6f72 6520 6d75 7461 7469 6f6e 7320  gnore mutations 
+0001e840: 7768 696c 6520 696e 2070 726f 6772 6573  while in progres
+0001e850: 730a 2020 2020 2020 2020 7374 6570 7320  s.        steps 
+0001e860: 3d20 6469 6374 2873 656c 662e 7374 6570  = dict(self.step
+0001e870: 735f 5f29 0a20 2020 2020 2020 2023 2045  s__).        # E
+0001e880: 6163 6820 7374 6570 2067 6574 7320 6120  ach step gets a 
+0001e890: 636f 7079 206f 6620 7468 6520 696e 7075  copy of the inpu
+0001e8a0: 7420 6974 6572 6174 6f72 2c0a 2020 2020  t iterator,.    
+0001e8b0: 2020 2020 2320 7768 6963 6820 6973 2063      # which is c
+0001e8c0: 6f6e 7375 6d65 6420 696e 2070 6172 616c  onsumed in paral
+0001e8d0: 6c65 6c20 696e 2061 2073 6570 6172 6174  lel in a separat
+0001e8e0: 6520 7468 7265 6164 2e0a 2020 2020 2020  e thread..      
+0001e8f0: 2020 696e 7075 745f 636f 7069 6573 203d    input_copies =
+0001e900: 206c 6973 7428 6174 6565 2869 6e70 7574   list(atee(input
+0001e910: 2c20 6c65 6e28 7374 6570 7329 2c20 6c6f  , len(steps), lo
+0001e920: 636b 3d61 7379 6e63 696f 2e4c 6f63 6b28  ck=asyncio.Lock(
+0001e930: 2929 290a 2020 2020 2020 2020 2320 4372  ))).        # Cr
+0001e940: 6561 7465 2074 6865 2074 7261 6e73 666f  eate the transfo
+0001e950: 726d 2829 2067 656e 6572 6174 6f72 2066  rm() generator f
+0001e960: 6f72 2065 6163 6820 7374 6570 0a20 2020  or each step.   
+0001e970: 2020 2020 206e 616d 6564 5f67 656e 6572       named_gener
+0001e980: 6174 6f72 7320 3d20 5b0a 2020 2020 2020  ators = [.      
+0001e990: 2020 2020 2020 280a 2020 2020 2020 2020        (.        
+0001e9a0: 2020 2020 2020 2020 6e61 6d65 2c0a 2020          name,.  
+0001e9b0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0001e9c0: 6570 2e61 7472 616e 7366 6f72 6d28 0a20  ep.atransform(. 
+0001e9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e9e0: 2020 2069 6e70 7574 5f63 6f70 6965 732e     input_copies.
+0001e9f0: 706f 7028 292c 0a20 2020 2020 2020 2020  pop(),.         
+0001ea00: 2020 2020 2020 2020 2020 2070 6174 6368             patch
+0001ea10: 5f63 6f6e 6669 6728 0a20 2020 2020 2020  _config(.       
+0001ea20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ea30: 2063 6f6e 6669 672c 2063 616c 6c62 6163   config, callbac
+0001ea40: 6b73 3d72 756e 5f6d 616e 6167 6572 2e67  ks=run_manager.g
+0001ea50: 6574 5f63 6869 6c64 2866 226d 6170 3a6b  et_child(f"map:k
+0001ea60: 6579 3a7b 6e61 6d65 7d22 290a 2020 2020  ey:{name}").    
+0001ea70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ea80: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0001ea90: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+0001eaa0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0001eab0: 666f 7220 6e61 6d65 2c20 7374 6570 2069  for name, step i
+0001eac0: 6e20 7374 6570 732e 6974 656d 7328 290a  n steps.items().
+0001ead0: 2020 2020 2020 2020 5d0a 0a20 2020 2020          ]..     
+0001eae0: 2020 2023 2057 7261 7020 696e 2061 2063     # Wrap in a c
+0001eaf0: 6f72 6f75 7469 6e65 2074 6f20 7361 7469  oroutine to sati
+0001eb00: 7366 7920 6c69 6e74 6572 0a20 2020 2020  sfy linter.     
+0001eb10: 2020 2061 7379 6e63 2064 6566 2067 6574     async def get
+0001eb20: 5f6e 6578 745f 6368 756e 6b28 6765 6e65  _next_chunk(gene
+0001eb30: 7261 746f 723a 2041 7379 6e63 4974 6572  rator: AsyncIter
+0001eb40: 6174 6f72 2920 2d3e 204f 7074 696f 6e61  ator) -> Optiona
+0001eb50: 6c5b 4f75 7470 7574 5d3a 0a20 2020 2020  l[Output]:.     
+0001eb60: 2020 2020 2020 2072 6574 7572 6e20 6177         return aw
+0001eb70: 6169 7420 7079 5f61 6e65 7874 2867 656e  ait py_anext(gen
+0001eb80: 6572 6174 6f72 290a 0a20 2020 2020 2020  erator)..       
+0001eb90: 2023 2053 7461 7274 2074 6865 2066 6972   # Start the fir
+0001eba0: 7374 2069 7465 7261 7469 6f6e 206f 6620  st iteration of 
+0001ebb0: 6561 6368 2067 656e 6572 6174 6f72 0a20  each generator. 
+0001ebc0: 2020 2020 2020 2074 6173 6b73 203d 207b         tasks = {
+0001ebd0: 0a20 2020 2020 2020 2020 2020 2061 7379  .            asy
+0001ebe0: 6e63 696f 2e63 7265 6174 655f 7461 736b  ncio.create_task
+0001ebf0: 2867 6574 5f6e 6578 745f 6368 756e 6b28  (get_next_chunk(
+0001ec00: 6765 6e65 7261 746f 7229 293a 2028 7374  generator)): (st
+0001ec10: 6570 5f6e 616d 652c 2067 656e 6572 6174  ep_name, generat
+0001ec20: 6f72 290a 2020 2020 2020 2020 2020 2020  or).            
+0001ec30: 666f 7220 7374 6570 5f6e 616d 652c 2067  for step_name, g
+0001ec40: 656e 6572 6174 6f72 2069 6e20 6e61 6d65  enerator in name
+0001ec50: 645f 6765 6e65 7261 746f 7273 0a20 2020  d_generators.   
+0001ec60: 2020 2020 207d 0a20 2020 2020 2020 2023       }.        #
+0001ec70: 2059 6965 6c64 2063 6875 6e6b 7320 6672   Yield chunks fr
+0001ec80: 6f6d 2065 6163 6820 6173 2074 6865 7920  om each as they 
+0001ec90: 6265 636f 6d65 2061 7661 696c 6162 6c65  become available
+0001eca0: 2c0a 2020 2020 2020 2020 2320 616e 6420  ,.        # and 
+0001ecb0: 7374 6172 7420 7468 6520 6e65 7874 2069  start the next i
+0001ecc0: 7465 7261 7469 6f6e 206f 6620 7468 6520  teration of the 
+0001ecd0: 6765 6e65 7261 746f 7220 7468 6174 2079  generator that y
+0001ece0: 6965 6c64 6564 2069 742e 0a20 2020 2020  ielded it..     
+0001ecf0: 2020 2023 2057 6865 6e20 616c 6c20 6765     # When all ge
+0001ed00: 6e65 7261 746f 7273 2061 7265 2065 7868  nerators are exh
+0001ed10: 6175 7374 6564 2c20 7374 6f70 2e0a 2020  austed, stop..  
+0001ed20: 2020 2020 2020 7768 696c 6520 7461 736b        while task
+0001ed30: 733a 0a20 2020 2020 2020 2020 2020 2063  s:.            c
+0001ed40: 6f6d 706c 6574 6564 5f74 6173 6b73 2c20  ompleted_tasks, 
+0001ed50: 5f20 3d20 6177 6169 7420 6173 796e 6369  _ = await asynci
+0001ed60: 6f2e 7761 6974 280a 2020 2020 2020 2020  o.wait(.        
+0001ed70: 2020 2020 2020 2020 7461 736b 732c 2072          tasks, r
+0001ed80: 6574 7572 6e5f 7768 656e 3d61 7379 6e63  eturn_when=async
+0001ed90: 696f 2e46 4952 5354 5f43 4f4d 504c 4554  io.FIRST_COMPLET
+0001eda0: 4544 0a20 2020 2020 2020 2020 2020 2029  ED.            )
+0001edb0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0001edc0: 2074 6173 6b20 696e 2063 6f6d 706c 6574   task in complet
+0001edd0: 6564 5f74 6173 6b73 3a0a 2020 2020 2020  ed_tasks:.      
+0001ede0: 2020 2020 2020 2020 2020 2873 7465 705f            (step_
+0001edf0: 6e61 6d65 2c20 6765 6e65 7261 746f 7229  name, generator)
+0001ee00: 203d 2074 6173 6b73 2e70 6f70 2874 6173   = tasks.pop(tas
+0001ee10: 6b29 0a20 2020 2020 2020 2020 2020 2020  k).             
+0001ee20: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0001ee30: 2020 2020 2020 2020 2020 2020 6368 756e              chun
+0001ee40: 6b20 3d20 4164 6461 626c 6544 6963 7428  k = AddableDict(
+0001ee50: 7b73 7465 705f 6e61 6d65 3a20 7461 736b  {step_name: task
+0001ee60: 2e72 6573 756c 7428 297d 290a 2020 2020  .result()}).    
+0001ee70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee80: 7969 656c 6420 6368 756e 6b0a 2020 2020  yield chunk.    
+0001ee90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eea0: 6e65 775f 7461 736b 203d 2061 7379 6e63  new_task = async
+0001eeb0: 696f 2e63 7265 6174 655f 7461 736b 2867  io.create_task(g
+0001eec0: 6574 5f6e 6578 745f 6368 756e 6b28 6765  et_next_chunk(ge
+0001eed0: 6e65 7261 746f 7229 290a 2020 2020 2020  nerator)).      
+0001eee0: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+0001eef0: 736b 735b 6e65 775f 7461 736b 5d20 3d20  sks[new_task] = 
+0001ef00: 2873 7465 705f 6e61 6d65 2c20 6765 6e65  (step_name, gene
+0001ef10: 7261 746f 7229 0a20 2020 2020 2020 2020  rator).         
+0001ef20: 2020 2020 2020 2065 7863 6570 7420 5374         except St
+0001ef30: 6f70 4173 796e 6349 7465 7261 7469 6f6e  opAsyncIteration
+0001ef40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001ef50: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
+0001ef60: 6173 796e 6320 6465 6620 6174 7261 6e73  async def atrans
+0001ef70: 666f 726d 280a 2020 2020 2020 2020 7365  form(.        se
+0001ef80: 6c66 2c0a 2020 2020 2020 2020 696e 7075  lf,.        inpu
+0001ef90: 743a 2041 7379 6e63 4974 6572 6174 6f72  t: AsyncIterator
+0001efa0: 5b49 6e70 7574 5d2c 0a20 2020 2020 2020  [Input],.       
+0001efb0: 2063 6f6e 6669 673a 204f 7074 696f 6e61   config: Optiona
+0001efc0: 6c5b 5275 6e6e 6162 6c65 436f 6e66 6967  l[RunnableConfig
+0001efd0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0001efe0: 2020 2a2a 6b77 6172 6773 3a20 416e 792c    **kwargs: Any,
+0001eff0: 0a20 2020 2029 202d 3e20 4173 796e 6349  .    ) -> AsyncI
+0001f000: 7465 7261 746f 725b 4469 6374 5b73 7472  terator[Dict[str
+0001f010: 2c20 416e 795d 5d3a 0a20 2020 2020 2020  , Any]]:.       
+0001f020: 2061 7379 6e63 2066 6f72 2063 6875 6e6b   async for chunk
+0001f030: 2069 6e20 7365 6c66 2e5f 6174 7261 6e73   in self._atrans
+0001f040: 666f 726d 5f73 7472 6561 6d5f 7769 7468  form_stream_with
+0001f050: 5f63 6f6e 6669 6728 0a20 2020 2020 2020  _config(.       
+0001f060: 2020 2020 2069 6e70 7574 2c20 7365 6c66       input, self
+0001f070: 2e5f 6174 7261 6e73 666f 726d 2c20 636f  ._atransform, co
+0001f080: 6e66 6967 2c20 2a2a 6b77 6172 6773 0a20  nfig, **kwargs. 
+0001f090: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
+0001f0a0: 2020 2020 2020 7969 656c 6420 6368 756e        yield chun
+0001f0b0: 6b0a 0a20 2020 2061 7379 6e63 2064 6566  k..    async def
+0001f0c0: 2061 7374 7265 616d 280a 2020 2020 2020   astream(.      
+0001f0d0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+0001f0e0: 696e 7075 743a 2049 6e70 7574 2c0a 2020  input: Input,.  
+0001f0f0: 2020 2020 2020 636f 6e66 6967 3a20 4f70        config: Op
+0001f100: 7469 6f6e 616c 5b52 756e 6e61 626c 6543  tional[RunnableC
+0001f110: 6f6e 6669 675d 203d 204e 6f6e 652c 0a20  onfig] = None,. 
+0001f120: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
+0001f130: 204f 7074 696f 6e61 6c5b 416e 795d 2c0a   Optional[Any],.
+0001f140: 2020 2020 2920 2d3e 2041 7379 6e63 4974      ) -> AsyncIt
+0001f150: 6572 6174 6f72 5b44 6963 745b 7374 722c  erator[Dict[str,
+0001f160: 2041 6e79 5d5d 3a0a 2020 2020 2020 2020   Any]]:.        
+0001f170: 6173 796e 6320 6465 6620 696e 7075 745f  async def input_
+0001f180: 6169 7465 7228 2920 2d3e 2041 7379 6e63  aiter() -> Async
+0001f190: 4974 6572 6174 6f72 5b49 6e70 7574 5d3a  Iterator[Input]:
+0001f1a0: 0a20 2020 2020 2020 2020 2020 2079 6965  .            yie
+0001f1b0: 6c64 2069 6e70 7574 0a0a 2020 2020 2020  ld input..      
+0001f1c0: 2020 6173 796e 6320 666f 7220 6368 756e    async for chun
+0001f1d0: 6b20 696e 2073 656c 662e 6174 7261 6e73  k in self.atrans
+0001f1e0: 666f 726d 2869 6e70 7574 5f61 6974 6572  form(input_aiter
+0001f1f0: 2829 2c20 636f 6e66 6967 293a 0a20 2020  (), config):.   
+0001f200: 2020 2020 2020 2020 2079 6965 6c64 2063           yield c
+0001f210: 6875 6e6b 0a0a 0a23 2057 6520 7375 7070  hunk...# We supp
+0001f220: 6f72 7420 626f 7468 206e 616d 6573 0a52  ort both names.R
+0001f230: 756e 6e61 626c 654d 6170 203d 2052 756e  unnableMap = Run
+0001f240: 6e61 626c 6550 6172 616c 6c65 6c0a 0a0a  nableParallel...
+0001f250: 636c 6173 7320 5275 6e6e 6162 6c65 4765  class RunnableGe
+0001f260: 6e65 7261 746f 7228 5275 6e6e 6162 6c65  nerator(Runnable
+0001f270: 5b49 6e70 7574 2c20 4f75 7470 7574 5d29  [Input, Output])
+0001f280: 3a0a 2020 2020 2222 2252 756e 6e61 626c  :.    """Runnabl
+0001f290: 6520 7468 6174 2072 756e 7320 6120 6765  e that runs a ge
+0001f2a0: 6e65 7261 746f 7220 6675 6e63 7469 6f6e  nerator function
+0001f2b0: 2e0a 0a20 2020 2052 756e 6e61 626c 6547  ...    RunnableG
+0001f2c0: 656e 6572 6174 6f72 7320 6361 6e20 6265  enerators can be
+0001f2d0: 2069 6e73 7461 6e74 6961 7465 6420 6469   instantiated di
+0001f2e0: 7265 6374 6c79 206f 7220 6279 2075 7369  rectly or by usi
+0001f2f0: 6e67 2061 2067 656e 6572 6174 6f72 2077  ng a generator w
+0001f300: 6974 6869 6e0a 2020 2020 6120 7365 7175  ithin.    a sequ
+0001f310: 656e 6365 2e0a 0a20 2020 2052 756e 6e61  ence...    Runna
+0001f320: 626c 6547 656e 6572 6174 6f72 7320 6361  bleGenerators ca
+0001f330: 6e20 6265 2075 7365 6420 746f 2069 6d70  n be used to imp
+0001f340: 6c65 6d65 6e74 2063 7573 746f 6d20 6265  lement custom be
+0001f350: 6861 7669 6f72 2c20 7375 6368 2061 7320  havior, such as 
+0001f360: 6375 7374 6f6d 206f 7574 7075 740a 2020  custom output.  
+0001f370: 2020 7061 7273 6572 732c 2077 6869 6c65    parsers, while
+0001f380: 2070 7265 7365 7276 696e 6720 7374 7265   preserving stre
+0001f390: 616d 696e 6720 6361 7061 6269 6c69 7469  aming capabiliti
+0001f3a0: 6573 2e20 4769 7665 6e20 6120 6765 6e65  es. Given a gene
+0001f3b0: 7261 746f 7220 6675 6e63 7469 6f6e 2077  rator function w
+0001f3c0: 6974 680a 2020 2020 6120 7369 676e 6174  ith.    a signat
+0001f3d0: 7572 6520 4974 6572 6174 6f72 5b41 5d20  ure Iterator[A] 
+0001f3e0: 2d3e 2049 7465 7261 746f 725b 425d 2c20  -> Iterator[B], 
+0001f3f0: 7772 6170 7069 6e67 2069 7420 696e 2061  wrapping it in a
+0001f400: 2052 756e 6e61 626c 6547 656e 6572 6174   RunnableGenerat
+0001f410: 6f72 2061 6c6c 6f77 730a 2020 2020 6974  or allows.    it
+0001f420: 2074 6f20 656d 6974 206f 7574 7075 7420   to emit output 
+0001f430: 6368 756e 6b73 2061 7320 736f 6f6e 2061  chunks as soon a
+0001f440: 7320 7468 6579 2061 7265 2073 7472 6561  s they are strea
+0001f450: 6d65 6420 696e 2066 726f 6d20 7468 6520  med in from the 
+0001f460: 7072 6576 696f 7573 2073 7465 702e 0a0a  previous step...
+0001f470: 2020 2020 4e6f 7465 2074 6861 7420 6966      Note that if
+0001f480: 2061 2067 656e 6572 6174 6f72 2066 756e   a generator fun
+0001f490: 6374 696f 6e20 6861 7320 6120 7369 676e  ction has a sign
+0001f4a0: 6174 7572 6520 4120 2d3e 2049 7465 7261  ature A -> Itera
+0001f4b0: 746f 725b 425d 2c20 7375 6368 2074 6861  tor[B], such tha
+0001f4c0: 7420 6974 0a20 2020 2072 6571 7569 7265  t it.    require
+0001f4d0: 7320 6974 7320 696e 7075 7420 6672 6f6d  s its input from
+0001f4e0: 2074 6865 2070 7265 7669 6f75 7320 7374   the previous st
+0001f4f0: 6570 2074 6f20 6265 2063 6f6d 706c 6574  ep to be complet
+0001f500: 6564 2062 6566 6f72 6520 656d 6974 7469  ed before emitti
+0001f510: 6e67 2063 6875 6e6b 730a 2020 2020 2865  ng chunks.    (e
+0001f520: 2e67 2e2c 206d 6f73 7420 4c4c 4d73 206e  .g., most LLMs n
+0001f530: 6565 6420 7468 6520 656e 7469 7265 2070  eed the entire p
+0001f540: 726f 6d70 7420 6176 6169 6c61 626c 6520  rompt available 
+0001f550: 746f 2073 7461 7274 2067 656e 6572 6174  to start generat
+0001f560: 696e 6729 2c20 6974 2063 616e 0a20 2020  ing), it can.   
+0001f570: 2069 6e73 7465 6164 2062 6520 7772 6170   instead be wrap
+0001f580: 7065 6420 696e 2061 2052 756e 6e61 626c  ped in a Runnabl
+0001f590: 654c 616d 6264 612e 0a0a 2020 2020 4865  eLambda...    He
+0001f5a0: 7265 2069 7320 616e 2065 7861 6d70 6c65  re is an example
+0001f5b0: 2074 6f20 7368 6f77 2074 6865 2062 6173   to show the bas
+0001f5c0: 6963 206d 6563 6861 6e69 6373 206f 6620  ic mechanics of 
+0001f5d0: 6120 5275 6e6e 6162 6c65 4765 6e65 7261  a RunnableGenera
+0001f5e0: 746f 723a 0a0a 2020 2020 2020 2020 2e2e  tor:..        ..
+0001f5f0: 2063 6f64 652d 626c 6f63 6b3a 3a20 7079   code-block:: py
+0001f600: 7468 6f6e 0a0a 2020 2020 2020 2020 2020  thon..          
+0001f610: 2020 6672 6f6d 2074 7970 696e 6720 696d    from typing im
+0001f620: 706f 7274 2041 6e79 2c20 4173 796e 6349  port Any, AsyncI
+0001f630: 7465 7261 746f 722c 2049 7465 7261 746f  terator, Iterato
+0001f640: 720a 0a20 2020 2020 2020 2020 2020 2066  r..            f
+0001f650: 726f 6d20 6c61 6e67 6368 6169 6e5f 636f  rom langchain_co
+0001f660: 7265 2e72 756e 6e61 626c 6573 2069 6d70  re.runnables imp
+0001f670: 6f72 7420 5275 6e6e 6162 6c65 4765 6e65  ort RunnableGene
+0001f680: 7261 746f 720a 0a0a 2020 2020 2020 2020  rator...        
+0001f690: 2020 2020 6465 6620 6765 6e28 696e 7075      def gen(inpu
+0001f6a0: 743a 2049 7465 7261 746f 725b 416e 795d  t: Iterator[Any]
+0001f6b0: 2920 2d3e 2049 7465 7261 746f 725b 7374  ) -> Iterator[st
+0001f6c0: 725d 3a0a 2020 2020 2020 2020 2020 2020  r]:.            
+0001f6d0: 2020 2020 666f 7220 746f 6b65 6e20 696e      for token in
+0001f6e0: 205b 2248 6176 6522 2c20 2220 6122 2c20   ["Have", " a", 
+0001f6f0: 2220 6e69 6365 222c 2022 2064 6179 225d  " nice", " day"]
+0001f700: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001f710: 2020 2020 2020 7969 656c 6420 746f 6b65        yield toke
+0001f720: 6e0a 0a0a 2020 2020 2020 2020 2020 2020  n...            
+0001f730: 7275 6e6e 6162 6c65 203d 2052 756e 6e61  runnable = Runna
+0001f740: 626c 6547 656e 6572 6174 6f72 2867 656e  bleGenerator(gen
+0001f750: 290a 2020 2020 2020 2020 2020 2020 7275  ).            ru
+0001f760: 6e6e 6162 6c65 2e69 6e76 6f6b 6528 4e6f  nnable.invoke(No
+0001f770: 6e65 2920 2023 2022 4861 7665 2061 206e  ne)  # "Have a n
+0001f780: 6963 6520 6461 7922 0a20 2020 2020 2020  ice day".       
+0001f790: 2020 2020 206c 6973 7428 7275 6e6e 6162       list(runnab
+0001f7a0: 6c65 2e73 7472 6561 6d28 4e6f 6e65 2929  le.stream(None))
+0001f7b0: 2020 2320 5b22 4861 7665 222c 2022 2061    # ["Have", " a
+0001f7c0: 222c 2022 206e 6963 6522 2c20 2220 6461  ", " nice", " da
+0001f7d0: 7922 5d0a 2020 2020 2020 2020 2020 2020  y"].            
+0001f7e0: 7275 6e6e 6162 6c65 2e62 6174 6368 285b  runnable.batch([
+0001f7f0: 4e6f 6e65 2c20 4e6f 6e65 5d29 2020 2320  None, None])  # 
+0001f800: 5b22 4861 7665 2061 206e 6963 6520 6461  ["Have a nice da
+0001f810: 7922 2c20 2248 6176 6520 6120 6e69 6365  y", "Have a nice
+0001f820: 2064 6179 225d 0a0a 0a20 2020 2020 2020   day"]...       
+0001f830: 2020 2020 2023 2041 7379 6e63 2076 6572       # Async ver
+0001f840: 7369 6f6e 3a0a 2020 2020 2020 2020 2020  sion:.          
+0001f850: 2020 6173 796e 6320 6465 6620 6167 656e    async def agen
+0001f860: 2869 6e70 7574 3a20 4173 796e 6349 7465  (input: AsyncIte
+0001f870: 7261 746f 725b 416e 795d 2920 2d3e 2041  rator[Any]) -> A
+0001f880: 7379 6e63 4974 6572 6174 6f72 5b73 7472  syncIterator[str
+0001f890: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
+0001f8a0: 2020 2066 6f72 2074 6f6b 656e 2069 6e20     for token in 
+0001f8b0: 5b22 4861 7665 222c 2022 2061 222c 2022  ["Have", " a", "
+0001f8c0: 206e 6963 6522 2c20 2220 6461 7922 5d3a   nice", " day"]:
+0001f8d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f8e0: 2020 2020 2079 6965 6c64 2074 6f6b 656e       yield token
+0001f8f0: 0a0a 2020 2020 2020 2020 2020 2020 7275  ..            ru
+0001f900: 6e6e 6162 6c65 203d 2052 756e 6e61 626c  nnable = Runnabl
+0001f910: 6547 656e 6572 6174 6f72 2861 6765 6e29  eGenerator(agen)
+0001f920: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+0001f930: 6974 2072 756e 6e61 626c 652e 6169 6e76  it runnable.ainv
+0001f940: 6f6b 6528 4e6f 6e65 2920 2023 2022 4861  oke(None)  # "Ha
+0001f950: 7665 2061 206e 6963 6520 6461 7922 0a20  ve a nice day". 
+0001f960: 2020 2020 2020 2020 2020 205b 7020 6173             [p as
+0001f970: 796e 6320 666f 7220 7020 696e 2072 756e  ync for p in run
+0001f980: 6e61 626c 652e 6173 7472 6561 6d28 4e6f  nable.astream(No
+0001f990: 6e65 295d 2023 205b 2248 6176 6522 2c20  ne)] # ["Have", 
+0001f9a0: 2220 6122 2c20 2220 6e69 6365 222c 2022  " a", " nice", "
+0001f9b0: 2064 6179 225d 0a0a 2020 2020 5275 6e6e   day"]..    Runn
+0001f9c0: 6162 6c65 4765 6e65 7261 746f 7220 6d61  ableGenerator ma
+0001f9d0: 6b65 7320 6974 2065 6173 7920 746f 2069  kes it easy to i
+0001f9e0: 6d70 6c65 6d65 6e74 2063 7573 746f 6d20  mplement custom 
+0001f9f0: 6265 6861 7669 6f72 2077 6974 6869 6e20  behavior within 
+0001fa00: 6120 7374 7265 616d 696e 670a 2020 2020  a streaming.    
+0001fa10: 636f 6e74 6578 742e 2042 656c 6f77 2077  context. Below w
+0001fa20: 6520 7368 6f77 2061 6e20 6578 616d 706c  e show an exampl
+0001fa30: 653a 0a20 2020 2020 2020 202e 2e20 636f  e:.        .. co
+0001fa40: 6465 2d62 6c6f 636b 3a3a 2070 7974 686f  de-block:: pytho
+0001fa50: 6e0a 0a20 2020 2020 2020 2020 2020 2066  n..            f
+0001fa60: 726f 6d20 6c61 6e67 6368 6169 6e5f 636f  rom langchain_co
+0001fa70: 7265 2e70 726f 6d70 7473 2069 6d70 6f72  re.prompts impor
+0001fa80: 7420 4368 6174 5072 6f6d 7074 5465 6d70  t ChatPromptTemp
+0001fa90: 6c61 7465 0a20 2020 2020 2020 2020 2020  late.           
+0001faa0: 2066 726f 6d20 6c61 6e67 6368 6169 6e5f   from langchain_
+0001fab0: 636f 7265 2e72 756e 6e61 626c 6573 2069  core.runnables i
+0001fac0: 6d70 6f72 7420 5275 6e6e 6162 6c65 4765  mport RunnableGe
+0001fad0: 6e65 7261 746f 722c 2052 756e 6e61 626c  nerator, Runnabl
+0001fae0: 654c 616d 6264 610a 2020 2020 2020 2020  eLambda.        
+0001faf0: 2020 2020 6672 6f6d 206c 616e 6763 6861      from langcha
+0001fb00: 696e 5f6f 7065 6e61 6920 696d 706f 7274  in_openai import
+0001fb10: 2043 6861 744f 7065 6e41 490a 2020 2020   ChatOpenAI.    
+0001fb20: 2020 2020 2020 2020 6672 6f6d 206c 616e          from lan
+0001fb30: 6763 6861 696e 5f63 6f72 652e 6f75 7470  gchain_core.outp
+0001fb40: 7574 5f70 6172 7365 7273 2069 6d70 6f72  ut_parsers impor
+0001fb50: 7420 5374 724f 7574 7075 7450 6172 7365  t StrOutputParse
+0001fb60: 720a 0a0a 2020 2020 2020 2020 2020 2020  r...            
+0001fb70: 6d6f 6465 6c20 3d20 4368 6174 4f70 656e  model = ChatOpen
+0001fb80: 4149 2829 0a20 2020 2020 2020 2020 2020  AI().           
+0001fb90: 2063 6861 6e74 5f63 6861 696e 203d 2028   chant_chain = (
+0001fba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001fbb0: 2043 6861 7450 726f 6d70 7454 656d 706c   ChatPromptTempl
+0001fbc0: 6174 652e 6672 6f6d 5f74 656d 706c 6174  ate.from_templat
+0001fbd0: 6528 2247 6976 6520 6d65 2061 2033 2077  e("Give me a 3 w
+0001fbe0: 6f72 6420 6368 616e 7420 6162 6f75 7420  ord chant about 
+0001fbf0: 7b74 6f70 6963 7d22 290a 2020 2020 2020  {topic}").      
+0001fc00: 2020 2020 2020 2020 2020 7c20 6d6f 6465            | mode
+0001fc10: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
+0001fc20: 2020 7c20 5374 724f 7574 7075 7450 6172    | StrOutputPar
+0001fc30: 7365 7228 290a 2020 2020 2020 2020 2020  ser().          
+0001fc40: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+0001fc50: 2064 6566 2063 6861 7261 6374 6572 5f67   def character_g
+0001fc60: 656e 6572 6174 6f72 2869 6e70 7574 3a20  enerator(input: 
+0001fc70: 4974 6572 6174 6f72 5b73 7472 5d29 202d  Iterator[str]) -
+0001fc80: 3e20 4974 6572 6174 6f72 5b73 7472 5d3a  > Iterator[str]:
+0001fc90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001fca0: 2066 6f72 2074 6f6b 656e 2069 6e20 696e   for token in in
+0001fcb0: 7075 743a 0a20 2020 2020 2020 2020 2020  put:.           
+0001fcc0: 2020 2020 2020 2020 2069 6620 222c 2220           if "," 
+0001fcd0: 696e 2074 6f6b 656e 206f 7220 222e 2220  in token or "." 
+0001fce0: 696e 2074 6f6b 656e 3a0a 2020 2020 2020  in token:.      
+0001fcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fd00: 2020 7969 656c 6420 22f0 9f91 8f22 202b    yield "...." +
+0001fd10: 2074 6f6b 656e 0a20 2020 2020 2020 2020   token.         
+0001fd20: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0001fd30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001fd40: 2020 2020 2020 2020 2079 6965 6c64 2074           yield t
+0001fd50: 6f6b 656e 0a0a 0a20 2020 2020 2020 2020  oken...         
+0001fd60: 2020 2072 756e 6e61 626c 6520 3d20 6368     runnable = ch
+0001fd70: 616e 745f 6368 6169 6e20 7c20 6368 6172  ant_chain | char
+0001fd80: 6163 7465 725f 6765 6e65 7261 746f 720a  acter_generator.
+0001fd90: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0001fda0: 7274 2074 7970 6528 7275 6e6e 6162 6c65  rt type(runnable
+0001fdb0: 2e6c 6173 7429 2069 7320 5275 6e6e 6162  .last) is Runnab
+0001fdc0: 6c65 4765 6e65 7261 746f 720a 2020 2020  leGenerator.    
+0001fdd0: 2020 2020 2020 2020 2222 2e6a 6f69 6e28          "".join(
+0001fde0: 7275 6e6e 6162 6c65 2e73 7472 6561 6d28  runnable.stream(
+0001fdf0: 7b22 746f 7069 6322 3a20 2277 6173 7465  {"topic": "waste
+0001fe00: 227d 2929 2023 2052 6564 7563 65f0 9f91  "})) # Reduce...
+0001fe10: 8f2c 2052 6575 7365 f09f 918f 2c20 5265  ., Reuse...., Re
+0001fe20: 6379 636c 65f0 9f91 8f2e 0a0a 2020 2020  cycle.......    
+0001fe30: 2020 2020 2020 2020 2320 4e6f 7465 2074          # Note t
+0001fe40: 6861 7420 5275 6e6e 6162 6c65 4c61 6d62  hat RunnableLamb
+0001fe50: 6461 2063 616e 2062 6520 7573 6564 2074  da can be used t
+0001fe60: 6f20 6465 6c61 7920 7374 7265 616d 696e  o delay streamin
+0001fe70: 6720 6f66 206f 6e65 2073 7465 7020 696e  g of one step in
+0001fe80: 2061 0a20 2020 2020 2020 2020 2020 2023   a.            #
+0001fe90: 2073 6571 7565 6e63 6520 756e 7469 6c20   sequence until 
+0001fea0: 7468 6520 7072 6576 696f 7573 2073 7465  the previous ste
+0001feb0: 7020 6973 2066 696e 6973 6865 643a 0a20  p is finished:. 
+0001fec0: 2020 2020 2020 2020 2020 2064 6566 2072             def r
+0001fed0: 6576 6572 7365 5f67 656e 6572 6174 6f72  everse_generator
+0001fee0: 2869 6e70 7574 3a20 7374 7229 202d 3e20  (input: str) -> 
+0001fef0: 4974 6572 6174 6f72 5b73 7472 5d3a 0a20  Iterator[str]:. 
+0001ff00: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001ff10: 2059 6965 6c64 2063 6861 7261 6374 6572   Yield character
+0001ff20: 7320 6f66 2069 6e70 7574 2069 6e20 7265  s of input in re
+0001ff30: 7665 7273 6520 6f72 6465 722e 0a20 2020  verse order..   
+0001ff40: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0001ff50: 2063 6861 7261 6374 6572 2069 6e20 696e   character in in
+0001ff60: 7075 745b 3a3a 2d31 5d3a 0a20 2020 2020  put[::-1]:.     
+0001ff70: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+0001ff80: 6965 6c64 2063 6861 7261 6374 6572 0a0a  ield character..
+0001ff90: 2020 2020 2020 2020 2020 2020 7275 6e6e              runn
+0001ffa0: 6162 6c65 203d 2063 6861 6e74 5f63 6861  able = chant_cha
+0001ffb0: 696e 207c 2052 756e 6e61 626c 654c 616d  in | RunnableLam
+0001ffc0: 6264 6128 7265 7665 7273 655f 6765 6e65  bda(reverse_gene
+0001ffd0: 7261 746f 7229 0a20 2020 2020 2020 2020  rator).         
+0001ffe0: 2020 2022 222e 6a6f 696e 2872 756e 6e61     "".join(runna
+0001fff0: 626c 652e 7374 7265 616d 287b 2274 6f70  ble.stream({"top
+00020000: 6963 223a 2022 7761 7374 6522 7d29 2920  ic": "waste"})) 
+00020010: 2023 2022 2e65 6c63 7963 6572 202c 6573   # ".elcycer ,es
+00020020: 7565 7220 2c65 6375 6465 5222 0a20 2020  uer ,ecudeR".   
+00020030: 2022 2222 0a0a 2020 2020 6465 6620 5f5f   """..    def __
+00020040: 696e 6974 5f5f 280a 2020 2020 2020 2020  init__(.        
+00020050: 7365 6c66 2c0a 2020 2020 2020 2020 7472  self,.        tr
+00020060: 616e 7366 6f72 6d3a 2055 6e69 6f6e 5b0a  ansform: Union[.
+00020070: 2020 2020 2020 2020 2020 2020 4361 6c6c              Call
+00020080: 6162 6c65 5b5b 4974 6572 6174 6f72 5b49  able[[Iterator[I
+00020090: 6e70 7574 5d5d 2c20 4974 6572 6174 6f72  nput]], Iterator
+000200a0: 5b4f 7574 7075 745d 5d2c 0a20 2020 2020  [Output]],.     
+000200b0: 2020 2020 2020 2043 616c 6c61 626c 655b         Callable[
+000200c0: 5b41 7379 6e63 4974 6572 6174 6f72 5b49  [AsyncIterator[I
+000200d0: 6e70 7574 5d5d 2c20 4173 796e 6349 7465  nput]], AsyncIte
+000200e0: 7261 746f 725b 4f75 7470 7574 5d5d 2c0a  rator[Output]],.
+000200f0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00020100: 2020 2061 7472 616e 7366 6f72 6d3a 204f     atransform: O
+00020110: 7074 696f 6e61 6c5b 0a20 2020 2020 2020  ptional[.       
+00020120: 2020 2020 2043 616c 6c61 626c 655b 5b41       Callable[[A
+00020130: 7379 6e63 4974 6572 6174 6f72 5b49 6e70  syncIterator[Inp
+00020140: 7574 5d5d 2c20 4173 796e 6349 7465 7261  ut]], AsyncItera
+00020150: 746f 725b 4f75 7470 7574 5d5d 0a20 2020  tor[Output]].   
+00020160: 2020 2020 205d 203d 204e 6f6e 652c 0a20       ] = None,. 
+00020170: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+00020180: 2020 2020 2020 6966 2061 7472 616e 7366        if atransf
+00020190: 6f72 6d20 6973 206e 6f74 204e 6f6e 653a  orm is not None:
+000201a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000201b0: 662e 5f61 7472 616e 7366 6f72 6d20 3d20  f._atransform = 
+000201c0: 6174 7261 6e73 666f 726d 0a20 2020 2020  atransform.     
+000201d0: 2020 2020 2020 2066 756e 635f 666f 725f         func_for_
+000201e0: 6e61 6d65 3a20 4361 6c6c 6162 6c65 203d  name: Callable =
+000201f0: 2061 7472 616e 7366 6f72 6d0a 0a20 2020   atransform..   
+00020200: 2020 2020 2069 6620 696e 7370 6563 742e       if inspect.
+00020210: 6973 6173 796e 6367 656e 6675 6e63 7469  isasyncgenfuncti
+00020220: 6f6e 2874 7261 6e73 666f 726d 293a 0a20  on(transform):. 
+00020230: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00020240: 5f61 7472 616e 7366 6f72 6d20 3d20 7472  _atransform = tr
+00020250: 616e 7366 6f72 6d20 2023 2074 7970 653a  ansform  # type:
+00020260: 2069 676e 6f72 655b 6173 7369 676e 6d65   ignore[assignme
+00020270: 6e74 5d0a 2020 2020 2020 2020 2020 2020  nt].            
+00020280: 6675 6e63 5f66 6f72 5f6e 616d 6520 3d20  func_for_name = 
+00020290: 7472 616e 7366 6f72 6d0a 2020 2020 2020  transform.      
+000202a0: 2020 656c 6966 2069 6e73 7065 6374 2e69    elif inspect.i
+000202b0: 7367 656e 6572 6174 6f72 6675 6e63 7469  sgeneratorfuncti
+000202c0: 6f6e 2874 7261 6e73 666f 726d 293a 0a20  on(transform):. 
+000202d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000202e0: 5f74 7261 6e73 666f 726d 203d 2074 7261  _transform = tra
+000202f0: 6e73 666f 726d 0a20 2020 2020 2020 2020  nsform.         
+00020300: 2020 2066 756e 635f 666f 725f 6e61 6d65     func_for_name
+00020310: 203d 2074 7261 6e73 666f 726d 0a20 2020   = transform.   
+00020320: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00020330: 2020 2020 2020 2072 6169 7365 2054 7970         raise Typ
+00020340: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
+00020350: 2020 2020 2020 2020 2245 7870 6563 7465          "Expecte
+00020360: 6420 6120 6765 6e65 7261 746f 7220 6675  d a generator fu
+00020370: 6e63 7469 6f6e 2074 7970 6520 666f 7220  nction type for 
+00020380: 6074 7261 6e73 666f 726d 602e 220a 2020  `transform`.".  
+00020390: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+000203a0: 496e 7374 6561 6420 676f 7420 616e 2075  Instead got an u
+000203b0: 6e73 7570 706f 7274 6564 2074 7970 653a  nsupported type:
+000203c0: 207b 7479 7065 2874 7261 6e73 666f 726d   {type(transform
+000203d0: 297d 220a 2020 2020 2020 2020 2020 2020  )}".            
+000203e0: 290a 0a20 2020 2020 2020 2074 7279 3a0a  )..        try:.
+000203f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00020400: 2e6e 616d 6520 3d20 6675 6e63 5f66 6f72  .name = func_for
+00020410: 5f6e 616d 652e 5f5f 6e61 6d65 5f5f 0a20  _name.__name__. 
+00020420: 2020 2020 2020 2065 7863 6570 7420 4174         except At
+00020430: 7472 6962 7574 6545 7272 6f72 3a0a 2020  tributeError:.  
+00020440: 2020 2020 2020 2020 2020 7061 7373 0a0a            pass..
+00020450: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+00020460: 2020 6465 6620 496e 7075 7454 7970 6528    def InputType(
+00020470: 7365 6c66 2920 2d3e 2041 6e79 3a0a 2020  self) -> Any:.  
+00020480: 2020 2020 2020 6675 6e63 203d 2067 6574        func = get
+00020490: 6174 7472 2873 656c 662c 2022 5f74 7261  attr(self, "_tra
+000204a0: 6e73 666f 726d 222c 204e 6f6e 6529 206f  nsform", None) o
+000204b0: 7220 6765 7461 7474 7228 7365 6c66 2c20  r getattr(self, 
+000204c0: 225f 6174 7261 6e73 666f 726d 2229 0a20  "_atransform"). 
+000204d0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000204e0: 2020 2020 2020 2020 7061 7261 6d73 203d          params =
+000204f0: 2069 6e73 7065 6374 2e73 6967 6e61 7475   inspect.signatu
+00020500: 7265 2866 756e 6329 2e70 6172 616d 6574  re(func).paramet
+00020510: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
+00020520: 6669 7273 745f 7061 7261 6d20 3d20 6e65  first_param = ne
+00020530: 7874 2869 7465 7228 7061 7261 6d73 2e76  xt(iter(params.v
+00020540: 616c 7565 7328 2929 2c20 4e6f 6e65 290a  alues()), None).
+00020550: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+00020560: 6972 7374 5f70 6172 616d 2061 6e64 2066  irst_param and f
+00020570: 6972 7374 5f70 6172 616d 2e61 6e6e 6f74  irst_param.annot
+00020580: 6174 696f 6e20 213d 2069 6e73 7065 6374  ation != inspect
+00020590: 2e50 6172 616d 6574 6572 2e65 6d70 7479  .Parameter.empty
+000205a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000205b0: 2020 7265 7475 726e 2067 6574 6174 7472    return getattr
+000205c0: 2866 6972 7374 5f70 6172 616d 2e61 6e6e  (first_param.ann
+000205d0: 6f74 6174 696f 6e2c 2022 5f5f 6172 6773  otation, "__args
+000205e0: 5f5f 222c 2028 416e 792c 2929 5b30 5d0a  __", (Any,))[0].
+000205f0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00020600: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00020610: 2020 7265 7475 726e 2041 6e79 0a20 2020    return Any.   
+00020620: 2020 2020 2065 7863 6570 7420 5661 6c75       except Valu
+00020630: 6545 7272 6f72 3a0a 2020 2020 2020 2020  eError:.        
+00020640: 2020 2020 7265 7475 726e 2041 6e79 0a0a      return Any..
+00020650: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+00020660: 2020 6465 6620 4f75 7470 7574 5479 7065    def OutputType
+00020670: 2873 656c 6629 202d 3e20 416e 793a 0a20  (self) -> Any:. 
+00020680: 2020 2020 2020 2066 756e 6320 3d20 6765         func = ge
+00020690: 7461 7474 7228 7365 6c66 2c20 225f 7472  tattr(self, "_tr
+000206a0: 616e 7366 6f72 6d22 2c20 4e6f 6e65 2920  ansform", None) 
+000206b0: 6f72 2067 6574 6174 7472 2873 656c 662c  or getattr(self,
+000206c0: 2022 5f61 7472 616e 7366 6f72 6d22 290a   "_atransform").
+000206d0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+000206e0: 2020 2020 2020 2020 2073 6967 203d 2069           sig = i
+000206f0: 6e73 7065 6374 2e73 6967 6e61 7475 7265  nspect.signature
+00020700: 2866 756e 6329 0a20 2020 2020 2020 2020  (func).         
+00020710: 2020 2072 6574 7572 6e20 280a 2020 2020     return (.    
+00020720: 2020 2020 2020 2020 2020 2020 6765 7461              geta
+00020730: 7474 7228 7369 672e 7265 7475 726e 5f61  ttr(sig.return_a
+00020740: 6e6e 6f74 6174 696f 6e2c 2022 5f5f 6172  nnotation, "__ar
+00020750: 6773 5f5f 222c 2028 416e 792c 2929 5b30  gs__", (Any,))[0
+00020760: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00020770: 2020 6966 2073 6967 2e72 6574 7572 6e5f    if sig.return_
+00020780: 616e 6e6f 7461 7469 6f6e 2021 3d20 696e  annotation != in
+00020790: 7370 6563 742e 5369 676e 6174 7572 652e  spect.Signature.
+000207a0: 656d 7074 790a 2020 2020 2020 2020 2020  empty.          
+000207b0: 2020 2020 2020 656c 7365 2041 6e79 0a20        else Any. 
+000207c0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+000207d0: 2020 2020 2065 7863 6570 7420 5661 6c75       except Valu
+000207e0: 6545 7272 6f72 3a0a 2020 2020 2020 2020  eError:.        
+000207f0: 2020 2020 7265 7475 726e 2041 6e79 0a0a      return Any..
+00020800: 2020 2020 6465 6620 5f5f 6571 5f5f 2873      def __eq__(s
+00020810: 656c 662c 206f 7468 6572 3a20 416e 7929  elf, other: Any)
+00020820: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
+00020830: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00020840: 6f74 6865 722c 2052 756e 6e61 626c 6547  other, RunnableG
+00020850: 656e 6572 6174 6f72 293a 0a20 2020 2020  enerator):.     
+00020860: 2020 2020 2020 2069 6620 6861 7361 7474         if hasatt
+00020870: 7228 7365 6c66 2c20 225f 7472 616e 7366  r(self, "_transf
+00020880: 6f72 6d22 2920 616e 6420 6861 7361 7474  orm") and hasatt
+00020890: 7228 6f74 6865 722c 2022 5f74 7261 6e73  r(other, "_trans
+000208a0: 666f 726d 2229 3a0a 2020 2020 2020 2020  form"):.        
+000208b0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+000208c0: 656c 662e 5f74 7261 6e73 666f 726d 203d  elf._transform =
+000208d0: 3d20 6f74 6865 722e 5f74 7261 6e73 666f  = other._transfo
+000208e0: 726d 0a20 2020 2020 2020 2020 2020 2065  rm.            e
+000208f0: 6c69 6620 6861 7361 7474 7228 7365 6c66  lif hasattr(self
+00020900: 2c20 225f 6174 7261 6e73 666f 726d 2229  , "_atransform")
+00020910: 2061 6e64 2068 6173 6174 7472 286f 7468   and hasattr(oth
+00020920: 6572 2c20 225f 6174 7261 6e73 666f 726d  er, "_atransform
+00020930: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
+00020940: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00020950: 5f61 7472 616e 7366 6f72 6d20 3d3d 206f  _atransform == o
+00020960: 7468 6572 2e5f 6174 7261 6e73 666f 726d  ther._atransform
+00020970: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00020980: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00020990: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+000209a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000209b0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000209c0: 2046 616c 7365 0a0a 2020 2020 6465 6620   False..    def 
+000209d0: 5f5f 7265 7072 5f5f 2873 656c 6629 202d  __repr__(self) -
+000209e0: 3e20 7374 723a 0a20 2020 2020 2020 2072  > str:.        r
+000209f0: 6574 7572 6e20 6622 5275 6e6e 6162 6c65  eturn f"Runnable
+00020a00: 4765 6e65 7261 746f 7228 7b73 656c 662e  Generator({self.
+00020a10: 6e61 6d65 7d29 220a 0a20 2020 2064 6566  name})"..    def
+00020a20: 2074 7261 6e73 666f 726d 280a 2020 2020   transform(.    
+00020a30: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00020a40: 2020 696e 7075 743a 2049 7465 7261 746f    input: Iterato
+00020a50: 725b 496e 7075 745d 2c0a 2020 2020 2020  r[Input],.      
+00020a60: 2020 636f 6e66 6967 3a20 4f70 7469 6f6e    config: Option
+00020a70: 616c 5b52 756e 6e61 626c 6543 6f6e 6669  al[RunnableConfi
+00020a80: 675d 203d 204e 6f6e 652c 0a20 2020 2020  g] = None,.     
+00020a90: 2020 202a 2a6b 7761 7267 733a 2041 6e79     **kwargs: Any
+00020aa0: 2c0a 2020 2020 2920 2d3e 2049 7465 7261  ,.    ) -> Itera
+00020ab0: 746f 725b 4f75 7470 7574 5d3a 0a20 2020  tor[Output]:.   
+00020ac0: 2020 2020 2069 6620 6e6f 7420 6861 7361       if not hasa
+00020ad0: 7474 7228 7365 6c66 2c20 225f 7472 616e  ttr(self, "_tran
+00020ae0: 7366 6f72 6d22 293a 0a20 2020 2020 2020  sform"):.       
+00020af0: 2020 2020 2072 6169 7365 204e 6f74 496d       raise NotIm
+00020b00: 706c 656d 656e 7465 6445 7272 6f72 2866  plementedError(f
+00020b10: 227b 7265 7072 2873 656c 6629 7d20 6f6e  "{repr(self)} on
+00020b20: 6c79 2073 7570 706f 7274 7320 6173 796e  ly supports asyn
+00020b30: 6320 6d65 7468 6f64 732e 2229 0a20 2020  c methods.").   
+00020b40: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00020b50: 2e5f 7472 616e 7366 6f72 6d5f 7374 7265  ._transform_stre
+00020b60: 616d 5f77 6974 685f 636f 6e66 6967 280a  am_with_config(.
+00020b70: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+00020b80: 742c 0a20 2020 2020 2020 2020 2020 2073  t,.            s
+00020b90: 656c 662e 5f74 7261 6e73 666f 726d 2c20  elf._transform, 
+00020ba0: 2023 2074 7970 653a 2069 676e 6f72 655b   # type: ignore[
+00020bb0: 6172 672d 7479 7065 5d0a 2020 2020 2020  arg-type].      
+00020bc0: 2020 2020 2020 636f 6e66 6967 2c0a 2020        config,.  
+00020bd0: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
+00020be0: 6773 2c20 2023 2074 7970 653a 2069 676e  gs,  # type: ign
+00020bf0: 6f72 655b 6172 672d 7479 7065 5d0a 2020  ore[arg-type].  
+00020c00: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
+00020c10: 2073 7472 6561 6d28 0a20 2020 2020 2020   stream(.       
+00020c20: 2073 656c 662c 0a20 2020 2020 2020 2069   self,.        i
+00020c30: 6e70 7574 3a20 496e 7075 742c 0a20 2020  nput: Input,.   
+00020c40: 2020 2020 2063 6f6e 6669 673a 204f 7074       config: Opt
+00020c50: 696f 6e61 6c5b 5275 6e6e 6162 6c65 436f  ional[RunnableCo
+00020c60: 6e66 6967 5d20 3d20 4e6f 6e65 2c0a 2020  nfig] = None,.  
+00020c70: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
+00020c80: 416e 792c 0a20 2020 2029 202d 3e20 4974  Any,.    ) -> It
+00020c90: 6572 6174 6f72 5b4f 7574 7075 745d 3a0a  erator[Output]:.
+00020ca0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00020cb0: 656c 662e 7472 616e 7366 6f72 6d28 6974  elf.transform(it
+00020cc0: 6572 285b 696e 7075 745d 292c 2063 6f6e  er([input]), con
+00020cd0: 6669 672c 202a 2a6b 7761 7267 7329 0a0a  fig, **kwargs)..
+00020ce0: 2020 2020 6465 6620 696e 766f 6b65 280a      def invoke(.
+00020cf0: 2020 2020 2020 2020 7365 6c66 2c20 696e          self, in
+00020d00: 7075 743a 2049 6e70 7574 2c20 636f 6e66  put: Input, conf
+00020d10: 6967 3a20 4f70 7469 6f6e 616c 5b52 756e  ig: Optional[Run
+00020d20: 6e61 626c 6543 6f6e 6669 675d 203d 204e  nableConfig] = N
+00020d30: 6f6e 652c 202a 2a6b 7761 7267 733a 2041  one, **kwargs: A
+00020d40: 6e79 0a20 2020 2029 202d 3e20 4f75 7470  ny.    ) -> Outp
+00020d50: 7574 3a0a 2020 2020 2020 2020 6669 6e61  ut:.        fina
+00020d60: 6c20 3d20 4e6f 6e65 0a20 2020 2020 2020  l = None.       
+00020d70: 2066 6f72 206f 7574 7075 7420 696e 2073   for output in s
+00020d80: 656c 662e 7374 7265 616d 2869 6e70 7574  elf.stream(input
+00020d90: 2c20 636f 6e66 6967 2c20 2a2a 6b77 6172  , config, **kwar
+00020da0: 6773 293a 0a20 2020 2020 2020 2020 2020  gs):.           
+00020db0: 2069 6620 6669 6e61 6c20 6973 204e 6f6e   if final is Non
+00020dc0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00020dd0: 2020 2066 696e 616c 203d 206f 7574 7075     final = outpu
+00020de0: 740a 2020 2020 2020 2020 2020 2020 656c  t.            el
+00020df0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00020e00: 2020 2020 6669 6e61 6c20 3d20 6669 6e61      final = fina
+00020e10: 6c20 2b20 6f75 7470 7574 0a20 2020 2020  l + output.     
+00020e20: 2020 2072 6574 7572 6e20 6361 7374 284f     return cast(O
+00020e30: 7574 7075 742c 2066 696e 616c 290a 0a20  utput, final).. 
+00020e40: 2020 2064 6566 2061 7472 616e 7366 6f72     def atransfor
+00020e50: 6d28 0a20 2020 2020 2020 2073 656c 662c  m(.        self,
+00020e60: 0a20 2020 2020 2020 2069 6e70 7574 3a20  .        input: 
+00020e70: 4173 796e 6349 7465 7261 746f 725b 496e  AsyncIterator[In
+00020e80: 7075 745d 2c0a 2020 2020 2020 2020 636f  put],.        co
+00020e90: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
+00020ea0: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
+00020eb0: 204e 6f6e 652c 0a20 2020 2020 2020 202a   None,.        *
+00020ec0: 2a6b 7761 7267 733a 2041 6e79 2c0a 2020  *kwargs: Any,.  
+00020ed0: 2020 2920 2d3e 2041 7379 6e63 4974 6572    ) -> AsyncIter
+00020ee0: 6174 6f72 5b4f 7574 7075 745d 3a0a 2020  ator[Output]:.  
+00020ef0: 2020 2020 2020 6966 206e 6f74 2068 6173        if not has
+00020f00: 6174 7472 2873 656c 662c 2022 5f61 7472  attr(self, "_atr
+00020f10: 616e 7366 6f72 6d22 293a 0a20 2020 2020  ansform"):.     
+00020f20: 2020 2020 2020 2072 6169 7365 204e 6f74         raise Not
+00020f30: 496d 706c 656d 656e 7465 6445 7272 6f72  ImplementedError
+00020f40: 2866 227b 7265 7072 2873 656c 6629 7d20  (f"{repr(self)} 
+00020f50: 6f6e 6c79 2073 7570 706f 7274 7320 7379  only supports sy
+00020f60: 6e63 206d 6574 686f 6473 2e22 290a 0a20  nc methods.").. 
+00020f70: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00020f80: 6c66 2e5f 6174 7261 6e73 666f 726d 5f73  lf._atransform_s
+00020f90: 7472 6561 6d5f 7769 7468 5f63 6f6e 6669  tream_with_confi
+00020fa0: 6728 0a20 2020 2020 2020 2020 2020 2069  g(.            i
+00020fb0: 6e70 7574 2c20 7365 6c66 2e5f 6174 7261  nput, self._atra
+00020fc0: 6e73 666f 726d 2c20 636f 6e66 6967 2c20  nsform, config, 
+00020fd0: 2a2a 6b77 6172 6773 0a20 2020 2020 2020  **kwargs.       
+00020fe0: 2029 0a0a 2020 2020 6465 6620 6173 7472   )..    def astr
+00020ff0: 6561 6d28 0a20 2020 2020 2020 2073 656c  eam(.        sel
+00021000: 662c 0a20 2020 2020 2020 2069 6e70 7574  f,.        input
+00021010: 3a20 496e 7075 742c 0a20 2020 2020 2020  : Input,.       
+00021020: 2063 6f6e 6669 673a 204f 7074 696f 6e61   config: Optiona
+00021030: 6c5b 5275 6e6e 6162 6c65 436f 6e66 6967  l[RunnableConfig
+00021040: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00021050: 2020 2a2a 6b77 6172 6773 3a20 416e 792c    **kwargs: Any,
+00021060: 0a20 2020 2029 202d 3e20 4173 796e 6349  .    ) -> AsyncI
+00021070: 7465 7261 746f 725b 4f75 7470 7574 5d3a  terator[Output]:
+00021080: 0a20 2020 2020 2020 2061 7379 6e63 2064  .        async d
+00021090: 6566 2069 6e70 7574 5f61 6974 6572 2829  ef input_aiter()
+000210a0: 202d 3e20 4173 796e 6349 7465 7261 746f   -> AsyncIterato
+000210b0: 725b 496e 7075 745d 3a0a 2020 2020 2020  r[Input]:.      
+000210c0: 2020 2020 2020 7969 656c 6420 696e 7075        yield inpu
+000210d0: 740a 0a20 2020 2020 2020 2072 6574 7572  t..        retur
+000210e0: 6e20 7365 6c66 2e61 7472 616e 7366 6f72  n self.atransfor
+000210f0: 6d28 696e 7075 745f 6169 7465 7228 292c  m(input_aiter(),
+00021100: 2063 6f6e 6669 672c 202a 2a6b 7761 7267   config, **kwarg
+00021110: 7329 0a0a 2020 2020 6173 796e 6320 6465  s)..    async de
+00021120: 6620 6169 6e76 6f6b 6528 0a20 2020 2020  f ainvoke(.     
+00021130: 2020 2073 656c 662c 2069 6e70 7574 3a20     self, input: 
+00021140: 496e 7075 742c 2063 6f6e 6669 673a 204f  Input, config: O
+00021150: 7074 696f 6e61 6c5b 5275 6e6e 6162 6c65  ptional[Runnable
+00021160: 436f 6e66 6967 5d20 3d20 4e6f 6e65 2c20  Config] = None, 
+00021170: 2a2a 6b77 6172 6773 3a20 416e 790a 2020  **kwargs: Any.  
+00021180: 2020 2920 2d3e 204f 7574 7075 743a 0a20    ) -> Output:. 
+00021190: 2020 2020 2020 2066 696e 616c 203d 204e         final = N
+000211a0: 6f6e 650a 2020 2020 2020 2020 6173 796e  one.        asyn
+000211b0: 6320 666f 7220 6f75 7470 7574 2069 6e20  c for output in 
+000211c0: 7365 6c66 2e61 7374 7265 616d 2869 6e70  self.astream(inp
+000211d0: 7574 2c20 636f 6e66 6967 2c20 2a2a 6b77  ut, config, **kw
+000211e0: 6172 6773 293a 0a20 2020 2020 2020 2020  args):.         
+000211f0: 2020 2069 6620 6669 6e61 6c20 6973 204e     if final is N
+00021200: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00021210: 2020 2020 2066 696e 616c 203d 206f 7574       final = out
+00021220: 7075 740a 2020 2020 2020 2020 2020 2020  put.            
+00021230: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00021240: 2020 2020 2020 6669 6e61 6c20 3d20 6669        final = fi
+00021250: 6e61 6c20 2b20 6f75 7470 7574 0a20 2020  nal + output.   
+00021260: 2020 2020 2072 6574 7572 6e20 6361 7374       return cast
+00021270: 284f 7574 7075 742c 2066 696e 616c 290a  (Output, final).
+00021280: 0a0a 636c 6173 7320 5275 6e6e 6162 6c65  ..class Runnable
+00021290: 4c61 6d62 6461 2852 756e 6e61 626c 655b  Lambda(Runnable[
+000212a0: 496e 7075 742c 204f 7574 7075 745d 293a  Input, Output]):
+000212b0: 0a20 2020 2022 2222 5275 6e6e 6162 6c65  .    """Runnable
+000212c0: 4c61 6d62 6461 2063 6f6e 7665 7274 7320  Lambda converts 
+000212d0: 6120 7079 7468 6f6e 2063 616c 6c61 626c  a python callabl
+000212e0: 6520 696e 746f 2061 2052 756e 6e61 626c  e into a Runnabl
+000212f0: 652e 0a0a 2020 2020 5772 6170 7069 6e67  e...    Wrapping
+00021300: 2061 2063 616c 6c61 626c 6520 696e 2061   a callable in a
+00021310: 2052 756e 6e61 626c 654c 616d 6264 6120   RunnableLambda 
+00021320: 6d61 6b65 7320 7468 6520 6361 6c6c 6162  makes the callab
+00021330: 6c65 2075 7361 626c 650a 2020 2020 7769  le usable.    wi
+00021340: 7468 696e 2065 6974 6865 7220 6120 7379  thin either a sy
+00021350: 6e63 206f 7220 6173 796e 6320 636f 6e74  nc or async cont
+00021360: 6578 742e 0a0a 2020 2020 5275 6e6e 6162  ext...    Runnab
+00021370: 6c65 4c61 6d62 6461 2063 616e 2062 6520  leLambda can be 
+00021380: 636f 6d70 6f73 6564 2061 7320 616e 7920  composed as any 
+00021390: 6f74 6865 7220 5275 6e6e 6162 6c65 2061  other Runnable a
+000213a0: 6e64 2070 726f 7669 6465 730a 2020 2020  nd provides.    
+000213b0: 7365 616d 6c65 7373 2069 6e74 6567 7261  seamless integra
+000213c0: 7469 6f6e 2077 6974 6820 4c61 6e67 4368  tion with LangCh
+000213d0: 6169 6e20 7472 6163 696e 672e 0a0a 2020  ain tracing...  
+000213e0: 2020 4578 616d 706c 6573 3a0a 0a20 2020    Examples:..   
+000213f0: 2020 2020 202e 2e20 636f 6465 2d62 6c6f       .. code-blo
+00021400: 636b 3a3a 2070 7974 686f 6e0a 0a20 2020  ck:: python..   
+00021410: 2020 2020 2020 2020 2023 2054 6869 7320           # This 
+00021420: 6973 2061 2052 756e 6e61 626c 654c 616d  is a RunnableLam
+00021430: 6264 610a 2020 2020 2020 2020 2020 2020  bda.            
+00021440: 6672 6f6d 206c 616e 6763 6861 696e 5f63  from langchain_c
+00021450: 6f72 652e 7275 6e6e 6162 6c65 7320 696d  ore.runnables im
+00021460: 706f 7274 2052 756e 6e61 626c 654c 616d  port RunnableLam
+00021470: 6264 610a 0a20 2020 2020 2020 2020 2020  bda..           
+00021480: 2064 6566 2061 6464 5f6f 6e65 2878 3a20   def add_one(x: 
+00021490: 696e 7429 202d 3e20 696e 743a 0a20 2020  int) -> int:.   
+000214a0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+000214b0: 7572 6e20 7820 2b20 310a 0a20 2020 2020  urn x + 1..     
+000214c0: 2020 2020 2020 2072 756e 6e61 626c 6520         runnable 
+000214d0: 3d20 5275 6e6e 6162 6c65 4c61 6d62 6461  = RunnableLambda
+000214e0: 2861 6464 5f6f 6e65 290a 0a20 2020 2020  (add_one)..     
+000214f0: 2020 2020 2020 2072 756e 6e61 626c 652e         runnable.
+00021500: 696e 766f 6b65 2831 2920 2320 7265 7475  invoke(1) # retu
+00021510: 726e 7320 320a 2020 2020 2020 2020 2020  rns 2.          
+00021520: 2020 7275 6e6e 6162 6c65 2e62 6174 6368    runnable.batch
+00021530: 285b 312c 2032 2c20 335d 2920 2320 7265  ([1, 2, 3]) # re
+00021540: 7475 726e 7320 5b32 2c20 332c 2034 5d0a  turns [2, 3, 4].
+00021550: 0a20 2020 2020 2020 2020 2020 2023 2041  .            # A
+00021560: 7379 6e63 2069 7320 7375 7070 6f72 7465  sync is supporte
+00021570: 6420 6279 2064 6566 6175 6c74 2062 7920  d by default by 
+00021580: 6465 6c65 6761 7469 6e67 2074 6f20 7468  delegating to th
+00021590: 6520 7379 6e63 2069 6d70 6c65 6d65 6e74  e sync implement
+000215a0: 6174 696f 6e0a 2020 2020 2020 2020 2020  ation.          
+000215b0: 2020 6177 6169 7420 7275 6e6e 6162 6c65    await runnable
+000215c0: 2e61 696e 766f 6b65 2831 2920 2320 7265  .ainvoke(1) # re
+000215d0: 7475 726e 7320 320a 2020 2020 2020 2020  turns 2.        
+000215e0: 2020 2020 6177 6169 7420 7275 6e6e 6162      await runnab
+000215f0: 6c65 2e61 6261 7463 6828 5b31 2c20 322c  le.abatch([1, 2,
+00021600: 2033 5d29 2023 2072 6574 7572 6e73 205b   3]) # returns [
+00021610: 322c 2033 2c20 345d 0a0a 0a20 2020 2020  2, 3, 4]...     
+00021620: 2020 2020 2020 2023 2041 6c74 6572 6e61         # Alterna
+00021630: 7469 7665 6c79 2c20 6361 6e20 7072 6f76  tively, can prov
+00021640: 6964 6520 626f 7468 2073 796e 6420 616e  ide both synd an
+00021650: 6420 7379 6e63 2069 6d70 6c65 6d65 6e74  d sync implement
+00021660: 6174 696f 6e73 0a20 2020 2020 2020 2020  ations.         
+00021670: 2020 2061 7379 6e63 2064 6566 2061 6464     async def add
+00021680: 5f6f 6e65 5f61 7379 6e63 2878 3a20 696e  _one_async(x: in
+00021690: 7429 202d 3e20 696e 743a 0a20 2020 2020  t) -> int:.     
+000216a0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000216b0: 6e20 7820 2b20 310a 0a20 2020 2020 2020  n x + 1..       
+000216c0: 2020 2020 2072 756e 6e61 626c 6520 3d20       runnable = 
+000216d0: 5275 6e6e 6162 6c65 4c61 6d62 6461 2861  RunnableLambda(a
+000216e0: 6464 5f6f 6e65 2c20 6166 756e 633d 6164  dd_one, afunc=ad
+000216f0: 645f 6f6e 655f 6173 796e 6329 0a20 2020  d_one_async).   
+00021700: 2020 2020 2020 2020 2072 756e 6e61 626c           runnabl
+00021710: 652e 696e 766f 6b65 2831 2920 2320 5573  e.invoke(1) # Us
+00021720: 6573 2061 6464 5f6f 6e65 0a20 2020 2020  es add_one.     
+00021730: 2020 2020 2020 2061 7761 6974 2072 756e         await run
+00021740: 6e61 626c 652e 6169 6e76 6f6b 6528 3129  nable.ainvoke(1)
+00021750: 2023 2055 7365 7320 6164 645f 6f6e 655f   # Uses add_one_
+00021760: 6173 796e 630a 2020 2020 2222 220a 0a20  async.    """.. 
+00021770: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+00021780: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+00021790: 2020 2020 2020 2066 756e 633a 2055 6e69         func: Uni
+000217a0: 6f6e 5b0a 2020 2020 2020 2020 2020 2020  on[.            
+000217b0: 556e 696f 6e5b 0a20 2020 2020 2020 2020  Union[.         
+000217c0: 2020 2020 2020 2043 616c 6c61 626c 655b         Callable[
+000217d0: 5b49 6e70 7574 5d2c 204f 7574 7075 745d  [Input], Output]
+000217e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000217f0: 2020 4361 6c6c 6162 6c65 5b5b 496e 7075    Callable[[Inpu
+00021800: 745d 2c20 4974 6572 6174 6f72 5b4f 7574  t], Iterator[Out
+00021810: 7075 745d 5d2c 0a20 2020 2020 2020 2020  put]],.         
+00021820: 2020 2020 2020 2043 616c 6c61 626c 655b         Callable[
+00021830: 5b49 6e70 7574 2c20 5275 6e6e 6162 6c65  [Input, Runnable
+00021840: 436f 6e66 6967 5d2c 204f 7574 7075 745d  Config], Output]
+00021850: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00021860: 2020 4361 6c6c 6162 6c65 5b5b 496e 7075    Callable[[Inpu
+00021870: 742c 2043 616c 6c62 6163 6b4d 616e 6167  t, CallbackManag
+00021880: 6572 466f 7243 6861 696e 5275 6e5d 2c20  erForChainRun], 
+00021890: 4f75 7470 7574 5d2c 0a20 2020 2020 2020  Output],.       
+000218a0: 2020 2020 2020 2020 2043 616c 6c61 626c           Callabl
+000218b0: 655b 5b49 6e70 7574 2c20 4361 6c6c 6261  e[[Input, Callba
+000218c0: 636b 4d61 6e61 6765 7246 6f72 4368 6169  ckManagerForChai
+000218d0: 6e52 756e 2c20 5275 6e6e 6162 6c65 436f  nRun, RunnableCo
+000218e0: 6e66 6967 5d2c 204f 7574 7075 745d 2c0a  nfig], Output],.
+000218f0: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
+00021900: 2020 2020 2020 2020 2020 2055 6e69 6f6e             Union
+00021910: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00021920: 2020 4361 6c6c 6162 6c65 5b5b 496e 7075    Callable[[Inpu
+00021930: 745d 2c20 4177 6169 7461 626c 655b 4f75  t], Awaitable[Ou
+00021940: 7470 7574 5d5d 2c0a 2020 2020 2020 2020  tput]],.        
+00021950: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
+00021960: 5b5b 496e 7075 745d 2c20 4173 796e 6349  [[Input], AsyncI
+00021970: 7465 7261 746f 725b 4f75 7470 7574 5d5d  terator[Output]]
+00021980: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00021990: 2020 4361 6c6c 6162 6c65 5b5b 496e 7075    Callable[[Inpu
+000219a0: 742c 2052 756e 6e61 626c 6543 6f6e 6669  t, RunnableConfi
+000219b0: 675d 2c20 4177 6169 7461 626c 655b 4f75  g], Awaitable[Ou
+000219c0: 7470 7574 5d5d 2c0a 2020 2020 2020 2020  tput]],.        
+000219d0: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
+000219e0: 5b5b 496e 7075 742c 2041 7379 6e63 4361  [[Input, AsyncCa
+000219f0: 6c6c 6261 636b 4d61 6e61 6765 7246 6f72  llbackManagerFor
+00021a00: 4368 6169 6e52 756e 5d2c 2041 7761 6974  ChainRun], Await
+00021a10: 6162 6c65 5b4f 7574 7075 745d 5d2c 0a20  able[Output]],. 
+00021a20: 2020 2020 2020 2020 2020 2020 2020 2043                 C
+00021a30: 616c 6c61 626c 655b 0a20 2020 2020 2020  allable[.       
+00021a40: 2020 2020 2020 2020 2020 2020 205b 496e               [In
+00021a50: 7075 742c 2041 7379 6e63 4361 6c6c 6261  put, AsyncCallba
+00021a60: 636b 4d61 6e61 6765 7246 6f72 4368 6169  ckManagerForChai
+00021a70: 6e52 756e 2c20 5275 6e6e 6162 6c65 436f  nRun, RunnableCo
+00021a80: 6e66 6967 5d2c 0a20 2020 2020 2020 2020  nfig],.         
+00021a90: 2020 2020 2020 2020 2020 2041 7761 6974             Await
+00021aa0: 6162 6c65 5b4f 7574 7075 745d 2c0a 2020  able[Output],.  
+00021ab0: 2020 2020 2020 2020 2020 2020 2020 5d2c                ],
+00021ac0: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
+00021ad0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00021ae0: 2020 2061 6675 6e63 3a20 4f70 7469 6f6e     afunc: Option
+00021af0: 616c 5b0a 2020 2020 2020 2020 2020 2020  al[.            
+00021b00: 556e 696f 6e5b 0a20 2020 2020 2020 2020  Union[.         
+00021b10: 2020 2020 2020 2043 616c 6c61 626c 655b         Callable[
+00021b20: 5b49 6e70 7574 5d2c 2041 7761 6974 6162  [Input], Awaitab
+00021b30: 6c65 5b4f 7574 7075 745d 5d2c 0a20 2020  le[Output]],.   
+00021b40: 2020 2020 2020 2020 2020 2020 2043 616c               Cal
+00021b50: 6c61 626c 655b 5b49 6e70 7574 5d2c 2041  lable[[Input], A
+00021b60: 7379 6e63 4974 6572 6174 6f72 5b4f 7574  syncIterator[Out
+00021b70: 7075 745d 5d2c 0a20 2020 2020 2020 2020  put]],.         
+00021b80: 2020 2020 2020 2043 616c 6c61 626c 655b         Callable[
+00021b90: 5b49 6e70 7574 2c20 5275 6e6e 6162 6c65  [Input, Runnable
+00021ba0: 436f 6e66 6967 5d2c 2041 7761 6974 6162  Config], Awaitab
+00021bb0: 6c65 5b4f 7574 7075 745d 5d2c 0a20 2020  le[Output]],.   
+00021bc0: 2020 2020 2020 2020 2020 2020 2043 616c               Cal
+00021bd0: 6c61 626c 655b 5b49 6e70 7574 2c20 4173  lable[[Input, As
+00021be0: 796e 6343 616c 6c62 6163 6b4d 616e 6167  yncCallbackManag
+00021bf0: 6572 466f 7243 6861 696e 5275 6e5d 2c20  erForChainRun], 
+00021c00: 4177 6169 7461 626c 655b 4f75 7470 7574  Awaitable[Output
+00021c10: 5d5d 2c0a 2020 2020 2020 2020 2020 2020  ]],.            
+00021c20: 2020 2020 4361 6c6c 6162 6c65 5b0a 2020      Callable[.  
+00021c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021c40: 2020 5b49 6e70 7574 2c20 4173 796e 6343    [Input, AsyncC
+00021c50: 616c 6c62 6163 6b4d 616e 6167 6572 466f  allbackManagerFo
+00021c60: 7243 6861 696e 5275 6e2c 2052 756e 6e61  rChainRun, Runna
+00021c70: 626c 6543 6f6e 6669 675d 2c0a 2020 2020  bleConfig],.    
+00021c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021c90: 4177 6169 7461 626c 655b 4f75 7470 7574  Awaitable[Output
+00021ca0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00021cb0: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
+00021cc0: 2020 5d0a 2020 2020 2020 2020 5d20 3d20    ].        ] = 
+00021cd0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6e61  None,.        na
+00021ce0: 6d65 3a20 4f70 7469 6f6e 616c 5b73 7472  me: Optional[str
+00021cf0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2920  ] = None,.    ) 
+00021d00: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00021d10: 2022 2222 4372 6561 7465 2061 2052 756e   """Create a Run
+00021d20: 6e61 626c 654c 616d 6264 6120 6672 6f6d  nableLambda from
+00021d30: 2061 2063 616c 6c61 626c 652c 2061 6e64   a callable, and
+00021d40: 2061 7379 6e63 2063 616c 6c61 626c 6520   async callable 
+00021d50: 6f72 2062 6f74 682e 0a0a 2020 2020 2020  or both...      
+00021d60: 2020 4163 6365 7074 7320 626f 7468 2073    Accepts both s
+00021d70: 796e 6320 616e 6420 6173 796e 6320 7661  ync and async va
+00021d80: 7269 616e 7473 2074 6f20 616c 6c6f 7720  riants to allow 
+00021d90: 7072 6f76 6964 696e 6720 6566 6669 6369  providing effici
+00021da0: 656e 740a 2020 2020 2020 2020 696d 706c  ent.        impl
+00021db0: 656d 656e 7461 7469 6f6e 7320 666f 7220  ementations for 
+00021dc0: 7379 6e63 2061 6e64 2061 7379 6e63 2065  sync and async e
+00021dd0: 7865 6375 7469 6f6e 2e0a 0a20 2020 2020  xecution...     
+00021de0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+00021df0: 2020 2020 2066 756e 633a 2045 6974 6865       func: Eithe
+00021e00: 7220 7379 6e63 206f 7220 6173 796e 6320  r sync or async 
+00021e10: 6361 6c6c 6162 6c65 0a20 2020 2020 2020  callable.       
+00021e20: 2020 2020 2061 6675 6e63 3a20 416e 2061       afunc: An a
+00021e30: 7379 6e63 2063 616c 6c61 626c 6520 7468  sync callable th
+00021e40: 6174 2074 616b 6573 2061 6e20 696e 7075  at takes an inpu
+00021e50: 7420 616e 6420 7265 7475 726e 7320 616e  t and returns an
+00021e60: 206f 7574 7075 742e 0a20 2020 2020 2020   output..       
+00021e70: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
+00021e80: 6166 756e 6320 6973 206e 6f74 204e 6f6e  afunc is not Non
+00021e90: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+00021ea0: 656c 662e 6166 756e 6320 3d20 6166 756e  elf.afunc = afun
+00021eb0: 630a 2020 2020 2020 2020 2020 2020 6675  c.            fu
+00021ec0: 6e63 5f66 6f72 5f6e 616d 653a 2043 616c  nc_for_name: Cal
+00021ed0: 6c61 626c 6520 3d20 6166 756e 630a 0a20  lable = afunc.. 
+00021ee0: 2020 2020 2020 2069 6620 696e 7370 6563         if inspec
+00021ef0: 742e 6973 636f 726f 7574 696e 6566 756e  t.iscoroutinefun
+00021f00: 6374 696f 6e28 6675 6e63 2920 6f72 2069  ction(func) or i
+00021f10: 6e73 7065 6374 2e69 7361 7379 6e63 6765  nspect.isasyncge
+00021f20: 6e66 756e 6374 696f 6e28 6675 6e63 293a  nfunction(func):
+00021f30: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00021f40: 6166 756e 6320 6973 206e 6f74 204e 6f6e  afunc is not Non
+00021f50: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00021f60: 2020 2072 6169 7365 2054 7970 6545 7272     raise TypeErr
+00021f70: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00021f80: 2020 2020 2020 2020 2246 756e 6320 7761          "Func wa
+00021f90: 7320 7072 6f76 6964 6564 2061 7320 6120  s provided as a 
+00021fa0: 636f 726f 7574 696e 6520 6675 6e63 7469  coroutine functi
+00021fb0: 6f6e 2c20 6275 7420 6166 756e 6320 7761  on, but afunc wa
+00021fc0: 7320 220a 2020 2020 2020 2020 2020 2020  s ".            
+00021fd0: 2020 2020 2020 2020 2261 6c73 6f20 7072          "also pr
+00021fe0: 6f76 6964 6564 2e20 4966 2070 726f 7669  ovided. If provi
+00021ff0: 6469 6e67 2062 6f74 682c 2066 756e 6320  ding both, func 
+00022000: 7368 6f75 6c64 2062 6520 6120 7265 6775  should be a regu
+00022010: 6c61 7220 220a 2020 2020 2020 2020 2020  lar ".          
+00022020: 2020 2020 2020 2020 2020 2266 756e 6374            "funct
+00022030: 696f 6e20 746f 2061 766f 6964 2061 6d62  ion to avoid amb
+00022040: 6967 7569 7479 2e22 0a20 2020 2020 2020  iguity.".       
+00022050: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00022060: 2020 2020 2020 2073 656c 662e 6166 756e         self.afun
+00022070: 6320 3d20 6675 6e63 0a20 2020 2020 2020  c = func.       
+00022080: 2020 2020 2066 756e 635f 666f 725f 6e61       func_for_na
+00022090: 6d65 203d 2066 756e 630a 2020 2020 2020  me = func.      
+000220a0: 2020 656c 6966 2063 616c 6c61 626c 6528    elif callable(
+000220b0: 6675 6e63 293a 0a20 2020 2020 2020 2020  func):.         
+000220c0: 2020 2073 656c 662e 6675 6e63 203d 2063     self.func = c
+000220d0: 6173 7428 4361 6c6c 6162 6c65 5b5b 496e  ast(Callable[[In
+000220e0: 7075 745d 2c20 4f75 7470 7574 5d2c 2066  put], Output], f
+000220f0: 756e 6329 0a20 2020 2020 2020 2020 2020  unc).           
+00022100: 2066 756e 635f 666f 725f 6e61 6d65 203d   func_for_name =
+00022110: 2066 756e 630a 2020 2020 2020 2020 656c   func.        el
+00022120: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00022130: 7261 6973 6520 5479 7065 4572 726f 7228  raise TypeError(
+00022140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022150: 2022 4578 7065 6374 6564 2061 2063 616c   "Expected a cal
+00022160: 6c61 626c 6520 7479 7065 2066 6f72 2060  lable type for `
+00022170: 6675 6e63 602e 220a 2020 2020 2020 2020  func`.".        
+00022180: 2020 2020 2020 2020 6622 496e 7374 6561          f"Instea
+00022190: 6420 676f 7420 616e 2075 6e73 7570 706f  d got an unsuppo
+000221a0: 7274 6564 2074 7970 653a 207b 7479 7065  rted type: {type
+000221b0: 2866 756e 6329 7d22 0a20 2020 2020 2020  (func)}".       
+000221c0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+000221d0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+000221e0: 2069 6620 6e61 6d65 2069 7320 6e6f 7420   if name is not 
+000221f0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00022200: 2020 2020 2020 7365 6c66 2e6e 616d 6520        self.name 
+00022210: 3d20 6e61 6d65 0a20 2020 2020 2020 2020  = name.         
+00022220: 2020 2065 6c69 6620 6675 6e63 5f66 6f72     elif func_for
+00022230: 5f6e 616d 652e 5f5f 6e61 6d65 5f5f 2021  _name.__name__ !
+00022240: 3d20 223c 6c61 6d62 6461 3e22 3a0a 2020  = "<lambda>":.  
+00022250: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00022260: 6c66 2e6e 616d 6520 3d20 6675 6e63 5f66  lf.name = func_f
+00022270: 6f72 5f6e 616d 652e 5f5f 6e61 6d65 5f5f  or_name.__name__
+00022280: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+00022290: 4174 7472 6962 7574 6545 7272 6f72 3a0a  AttributeError:.
+000222a0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+000222b0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+000222c0: 2020 2020 6465 6620 496e 7075 7454 7970      def InputTyp
+000222d0: 6528 7365 6c66 2920 2d3e 2041 6e79 3a0a  e(self) -> Any:.
+000222e0: 2020 2020 2020 2020 2222 2254 6865 2074          """The t
+000222f0: 7970 6520 6f66 2074 6865 2069 6e70 7574  ype of the input
+00022300: 2074 6f20 7468 6973 2072 756e 6e61 626c   to this runnabl
+00022310: 652e 2222 220a 2020 2020 2020 2020 6675  e.""".        fu
+00022320: 6e63 203d 2067 6574 6174 7472 2873 656c  nc = getattr(sel
+00022330: 662c 2022 6675 6e63 222c 204e 6f6e 6529  f, "func", None)
+00022340: 206f 7220 6765 7461 7474 7228 7365 6c66   or getattr(self
+00022350: 2c20 2261 6675 6e63 2229 0a20 2020 2020  , "afunc").     
+00022360: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00022370: 2020 2020 7061 7261 6d73 203d 2069 6e73      params = ins
+00022380: 7065 6374 2e73 6967 6e61 7475 7265 2866  pect.signature(f
+00022390: 756e 6329 2e70 6172 616d 6574 6572 730a  unc).parameters.
+000223a0: 2020 2020 2020 2020 2020 2020 6669 7273              firs
+000223b0: 745f 7061 7261 6d20 3d20 6e65 7874 2869  t_param = next(i
+000223c0: 7465 7228 7061 7261 6d73 2e76 616c 7565  ter(params.value
+000223d0: 7328 2929 2c20 4e6f 6e65 290a 2020 2020  s()), None).    
+000223e0: 2020 2020 2020 2020 6966 2066 6972 7374          if first
+000223f0: 5f70 6172 616d 2061 6e64 2066 6972 7374  _param and first
+00022400: 5f70 6172 616d 2e61 6e6e 6f74 6174 696f  _param.annotatio
+00022410: 6e20 213d 2069 6e73 7065 6374 2e50 6172  n != inspect.Par
+00022420: 616d 6574 6572 2e65 6d70 7479 3a0a 2020  ameter.empty:.  
+00022430: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00022440: 7475 726e 2066 6972 7374 5f70 6172 616d  turn first_param
+00022450: 2e61 6e6e 6f74 6174 696f 6e0a 2020 2020  .annotation.    
+00022460: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00022470: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00022480: 7475 726e 2041 6e79 0a20 2020 2020 2020  turn Any.       
+00022490: 2065 7863 6570 7420 5661 6c75 6545 7272   except ValueErr
+000224a0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+000224b0: 7265 7475 726e 2041 6e79 0a0a 2020 2020  return Any..    
+000224c0: 6465 6620 6765 745f 696e 7075 745f 7363  def get_input_sc
+000224d0: 6865 6d61 280a 2020 2020 2020 2020 7365  hema(.        se
+000224e0: 6c66 2c20 636f 6e66 6967 3a20 4f70 7469  lf, config: Opti
+000224f0: 6f6e 616c 5b52 756e 6e61 626c 6543 6f6e  onal[RunnableCon
+00022500: 6669 675d 203d 204e 6f6e 650a 2020 2020  fig] = None.    
+00022510: 2920 2d3e 2054 7970 655b 4261 7365 4d6f  ) -> Type[BaseMo
+00022520: 6465 6c5d 3a0a 2020 2020 2020 2020 2222  del]:.        ""
+00022530: 2254 6865 2070 7964 616e 7469 6320 7363  "The pydantic sc
+00022540: 6865 6d61 2066 6f72 2074 6865 2069 6e70  hema for the inp
+00022550: 7574 2074 6f20 7468 6973 2072 756e 6e61  ut to this runna
+00022560: 626c 652e 2222 220a 2020 2020 2020 2020  ble.""".        
+00022570: 6675 6e63 203d 2067 6574 6174 7472 2873  func = getattr(s
+00022580: 656c 662c 2022 6675 6e63 222c 204e 6f6e  elf, "func", Non
+00022590: 6529 206f 7220 6765 7461 7474 7228 7365  e) or getattr(se
+000225a0: 6c66 2c20 2261 6675 6e63 2229 0a0a 2020  lf, "afunc")..  
+000225b0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+000225c0: 6e63 6528 6675 6e63 2c20 6974 656d 6765  nce(func, itemge
+000225d0: 7474 6572 293a 0a20 2020 2020 2020 2020  tter):.         
+000225e0: 2020 2023 2054 6869 7320 6973 2074 6572     # This is ter
+000225f0: 7269 626c 652c 2062 7574 2061 6661 6963  rible, but afaic
+00022600: 7420 6974 2773 206e 6f74 2070 6f73 7369  t it's not possi
+00022610: 626c 6520 746f 2061 6363 6573 7320 5f69  ble to access _i
+00022620: 7465 6d73 0a20 2020 2020 2020 2020 2020  tems.           
+00022630: 2023 206f 6e20 6974 656d 6765 7474 6572   # on itemgetter
+00022640: 206f 626a 6563 7473 2c20 736f 2077 6520   objects, so we 
+00022650: 6861 7665 2074 6f20 7061 7273 6520 7468  have to parse th
+00022660: 6520 7265 7072 0a20 2020 2020 2020 2020  e repr.         
+00022670: 2020 2069 7465 6d73 203d 2073 7472 2866     items = str(f
+00022680: 756e 6329 2e72 6570 6c61 6365 2822 6f70  unc).replace("op
+00022690: 6572 6174 6f72 2e69 7465 6d67 6574 7465  erator.itemgette
+000226a0: 7228 222c 2022 2229 5b3a 2d31 5d2e 7370  r(", "")[:-1].sp
+000226b0: 6c69 7428 222c 2022 290a 2020 2020 2020  lit(", ").      
+000226c0: 2020 2020 2020 6966 2061 6c6c 280a 2020        if all(.  
+000226d0: 2020 2020 2020 2020 2020 2020 2020 6974                it
+000226e0: 656d 5b30 5d20 3d3d 2022 2722 2061 6e64  em[0] == "'" and
+000226f0: 2069 7465 6d5b 2d31 5d20 3d3d 2022 2722   item[-1] == "'"
+00022700: 2061 6e64 206c 656e 2869 7465 6d29 203e   and len(item) >
+00022710: 2032 2066 6f72 2069 7465 6d20 696e 2069   2 for item in i
+00022720: 7465 6d73 0a20 2020 2020 2020 2020 2020  tems.           
+00022730: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+00022740: 2020 2020 2320 4974 2773 2061 2064 6963      # It's a dic
+00022750: 742c 206c 6f6c 0a20 2020 2020 2020 2020  t, lol.         
+00022760: 2020 2020 2020 2072 6574 7572 6e20 6372         return cr
+00022770: 6561 7465 5f6d 6f64 656c 280a 2020 2020  eate_model(.    
+00022780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022790: 7365 6c66 2e67 6574 5f6e 616d 6528 2249  self.get_name("I
+000227a0: 6e70 7574 2229 2c0a 2020 2020 2020 2020  nput"),.        
+000227b0: 2020 2020 2020 2020 2020 2020 2a2a 7b69              **{i
+000227c0: 7465 6d5b 313a 2d31 5d3a 2028 416e 792c  tem[1:-1]: (Any,
+000227d0: 204e 6f6e 6529 2066 6f72 2069 7465 6d20   None) for item 
+000227e0: 696e 2069 7465 6d73 7d2c 2020 2320 7479  in items},  # ty
+000227f0: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
+00022800: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00022810: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00022820: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00022830: 6574 7572 6e20 6372 6561 7465 5f6d 6f64  eturn create_mod
+00022840: 656c 280a 2020 2020 2020 2020 2020 2020  el(.            
+00022850: 2020 2020 2020 2020 7365 6c66 2e67 6574          self.get
+00022860: 5f6e 616d 6528 2249 6e70 7574 2229 2c0a  _name("Input"),.
+00022870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022880: 2020 2020 5f5f 726f 6f74 5f5f 3d28 4c69      __root__=(Li
+00022890: 7374 5b41 6e79 5d2c 204e 6f6e 6529 2c0a  st[Any], None),.
+000228a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000228b0: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
+000228c0: 6c66 2e49 6e70 7574 5479 7065 2021 3d20  lf.InputType != 
+000228d0: 416e 793a 0a20 2020 2020 2020 2020 2020  Any:.           
+000228e0: 2072 6574 7572 6e20 7375 7065 7228 292e   return super().
+000228f0: 6765 745f 696e 7075 745f 7363 6865 6d61  get_input_schema
+00022900: 2863 6f6e 6669 6729 0a0a 2020 2020 2020  (config)..      
+00022910: 2020 6966 2064 6963 745f 6b65 7973 203a    if dict_keys :
+00022920: 3d20 6765 745f 6675 6e63 7469 6f6e 5f66  = get_function_f
+00022930: 6972 7374 5f61 7267 5f64 6963 745f 6b65  irst_arg_dict_ke
+00022940: 7973 2866 756e 6329 3a0a 2020 2020 2020  ys(func):.      
+00022950: 2020 2020 2020 7265 7475 726e 2063 7265        return cre
+00022960: 6174 655f 6d6f 6465 6c28 0a20 2020 2020  ate_model(.     
+00022970: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00022980: 6765 745f 6e61 6d65 2822 496e 7075 7422  get_name("Input"
+00022990: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000229a0: 2020 202a 2a7b 6b65 793a 2028 416e 792c     **{key: (Any,
+000229b0: 204e 6f6e 6529 2066 6f72 206b 6579 2069   None) for key i
+000229c0: 6e20 6469 6374 5f6b 6579 737d 2c20 2023  n dict_keys},  #
+000229d0: 2074 7970 653a 2069 676e 6f72 650a 2020   type: ignore.  
+000229e0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+000229f0: 2020 2020 2072 6574 7572 6e20 7375 7065       return supe
+00022a00: 7228 292e 6765 745f 696e 7075 745f 7363  r().get_input_sc
+00022a10: 6865 6d61 2863 6f6e 6669 6729 0a0a 2020  hema(config)..  
+00022a20: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+00022a30: 6465 6620 4f75 7470 7574 5479 7065 2873  def OutputType(s
+00022a40: 656c 6629 202d 3e20 416e 793a 0a20 2020  elf) -> Any:.   
+00022a50: 2020 2020 2022 2222 5468 6520 7479 7065       """The type
+00022a60: 206f 6620 7468 6520 6f75 7470 7574 206f   of the output o
+00022a70: 6620 7468 6973 2072 756e 6e61 626c 6520  f this runnable 
+00022a80: 6173 2061 2074 7970 6520 616e 6e6f 7461  as a type annota
+00022a90: 7469 6f6e 2e22 2222 0a20 2020 2020 2020  tion.""".       
+00022aa0: 2066 756e 6320 3d20 6765 7461 7474 7228   func = getattr(
+00022ab0: 7365 6c66 2c20 2266 756e 6322 2c20 4e6f  self, "func", No
+00022ac0: 6e65 2920 6f72 2067 6574 6174 7472 2873  ne) or getattr(s
+00022ad0: 656c 662c 2022 6166 756e 6322 290a 2020  elf, "afunc").  
+00022ae0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00022af0: 2020 2020 2020 2073 6967 203d 2069 6e73         sig = ins
+00022b00: 7065 6374 2e73 6967 6e61 7475 7265 2866  pect.signature(f
+00022b10: 756e 6329 0a20 2020 2020 2020 2020 2020  unc).           
+00022b20: 2069 6620 7369 672e 7265 7475 726e 5f61   if sig.return_a
+00022b30: 6e6e 6f74 6174 696f 6e20 213d 2069 6e73  nnotation != ins
+00022b40: 7065 6374 2e53 6967 6e61 7475 7265 2e65  pect.Signature.e
+00022b50: 6d70 7479 3a0a 2020 2020 2020 2020 2020  mpty:.          
+00022b60: 2020 2020 2020 2320 756e 7772 6170 2069        # unwrap i
+00022b70: 7465 7261 746f 7220 7479 7065 730a 2020  terator types.  
+00022b80: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00022b90: 2067 6574 6174 7472 2873 6967 2e72 6574   getattr(sig.ret
+00022ba0: 7572 6e5f 616e 6e6f 7461 7469 6f6e 2c20  urn_annotation, 
+00022bb0: 225f 5f6f 7269 6769 6e5f 5f22 2c20 4e6f  "__origin__", No
+00022bc0: 6e65 2920 696e 2028 0a20 2020 2020 2020  ne) in (.       
+00022bd0: 2020 2020 2020 2020 2020 2020 2063 6f6c               col
+00022be0: 6c65 6374 696f 6e73 2e61 6263 2e49 7465  lections.abc.Ite
+00022bf0: 7261 746f 722c 0a20 2020 2020 2020 2020  rator,.         
+00022c00: 2020 2020 2020 2020 2020 2063 6f6c 6c65             colle
+00022c10: 6374 696f 6e73 2e61 6263 2e41 7379 6e63  ctions.abc.Async
+00022c20: 4974 6572 6174 6f72 2c0a 2020 2020 2020  Iterator,.      
+00022c30: 2020 2020 2020 2020 2020 293a 0a20 2020            ):.   
+00022c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022c50: 2072 6574 7572 6e20 6765 7461 7474 7228   return getattr(
+00022c60: 7369 672e 7265 7475 726e 5f61 6e6e 6f74  sig.return_annot
+00022c70: 6174 696f 6e2c 2022 5f5f 6172 6773 5f5f  ation, "__args__
+00022c80: 222c 2028 416e 792c 2929 5b30 5d0a 2020  ", (Any,))[0].  
+00022c90: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00022ca0: 7475 726e 2073 6967 2e72 6574 7572 6e5f  turn sig.return_
+00022cb0: 616e 6e6f 7461 7469 6f6e 0a20 2020 2020  annotation.     
+00022cc0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00022cd0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00022ce0: 7572 6e20 416e 790a 2020 2020 2020 2020  urn Any.        
+00022cf0: 6578 6365 7074 2056 616c 7565 4572 726f  except ValueErro
+00022d00: 723a 0a20 2020 2020 2020 2020 2020 2072  r:.            r
+00022d10: 6574 7572 6e20 416e 790a 0a20 2020 2040  eturn Any..    @
+00022d20: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+00022d30: 2064 6570 7328 7365 6c66 2920 2d3e 204c   deps(self) -> L
+00022d40: 6973 745b 5275 6e6e 6162 6c65 5d3a 0a20  ist[Runnable]:. 
+00022d50: 2020 2020 2020 2022 2222 5468 6520 6465         """The de
+00022d60: 7065 6e64 656e 6369 6573 206f 6620 7468  pendencies of th
+00022d70: 6973 2072 756e 6e61 626c 652e 2222 220a  is runnable.""".
+00022d80: 2020 2020 2020 2020 6966 2068 6173 6174          if hasat
+00022d90: 7472 2873 656c 662c 2022 6675 6e63 2229  tr(self, "func")
+00022da0: 3a0a 2020 2020 2020 2020 2020 2020 6f62  :.            ob
+00022db0: 6a65 6374 7320 3d20 6765 745f 6675 6e63  jects = get_func
+00022dc0: 7469 6f6e 5f6e 6f6e 6c6f 6361 6c73 2873  tion_nonlocals(s
+00022dd0: 656c 662e 6675 6e63 290a 2020 2020 2020  elf.func).      
+00022de0: 2020 656c 6966 2068 6173 6174 7472 2873    elif hasattr(s
+00022df0: 656c 662c 2022 6166 756e 6322 293a 0a20  elf, "afunc"):. 
+00022e00: 2020 2020 2020 2020 2020 206f 626a 6563             objec
+00022e10: 7473 203d 2067 6574 5f66 756e 6374 696f  ts = get_functio
+00022e20: 6e5f 6e6f 6e6c 6f63 616c 7328 7365 6c66  n_nonlocals(self
+00022e30: 2e61 6675 6e63 290a 2020 2020 2020 2020  .afunc).        
+00022e40: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00022e50: 2020 6f62 6a65 6374 7320 3d20 5b5d 0a0a    objects = []..
+00022e60: 2020 2020 2020 2020 6465 7073 3a20 4c69          deps: Li
+00022e70: 7374 5b52 756e 6e61 626c 655d 203d 205b  st[Runnable] = [
+00022e80: 5d0a 2020 2020 2020 2020 666f 7220 6f62  ].        for ob
+00022e90: 6a20 696e 206f 626a 6563 7473 3a0a 2020  j in objects:.  
+00022ea0: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
+00022eb0: 6e73 7461 6e63 6528 6f62 6a2c 2052 756e  nstance(obj, Run
+00022ec0: 6e61 626c 6529 3a0a 2020 2020 2020 2020  nable):.        
+00022ed0: 2020 2020 2020 2020 6465 7073 2e61 7070          deps.app
+00022ee0: 656e 6428 6f62 6a29 0a20 2020 2020 2020  end(obj).       
+00022ef0: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
+00022f00: 616e 6365 2867 6574 6174 7472 286f 626a  ance(getattr(obj
+00022f10: 2c20 225f 5f73 656c 665f 5f22 2c20 4e6f  , "__self__", No
+00022f20: 6e65 292c 2052 756e 6e61 626c 6529 3a0a  ne), Runnable):.
+00022f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022f40: 6465 7073 2e61 7070 656e 6428 6f62 6a2e  deps.append(obj.
+00022f50: 5f5f 7365 6c66 5f5f 290a 2020 2020 2020  __self__).      
+00022f60: 2020 7265 7475 726e 2064 6570 730a 0a20    return deps.. 
+00022f70: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+00022f80: 2064 6566 2063 6f6e 6669 675f 7370 6563   def config_spec
+00022f90: 7328 7365 6c66 2920 2d3e 204c 6973 745b  s(self) -> List[
+00022fa0: 436f 6e66 6967 7572 6162 6c65 4669 656c  ConfigurableFiel
+00022fb0: 6453 7065 635d 3a0a 2020 2020 2020 2020  dSpec]:.        
+00022fc0: 7265 7475 726e 2067 6574 5f75 6e69 7175  return get_uniqu
+00022fd0: 655f 636f 6e66 6967 5f73 7065 6373 280a  e_config_specs(.
+00022fe0: 2020 2020 2020 2020 2020 2020 7370 6563              spec
+00022ff0: 2066 6f72 2064 6570 2069 6e20 7365 6c66   for dep in self
+00023000: 2e64 6570 7320 666f 7220 7370 6563 2069  .deps for spec i
+00023010: 6e20 6465 702e 636f 6e66 6967 5f73 7065  n dep.config_spe
+00023020: 6373 0a20 2020 2020 2020 2029 0a0a 2020  cs.        )..  
+00023030: 2020 6465 6620 6765 745f 6772 6170 6828    def get_graph(
+00023040: 7365 6c66 2c20 636f 6e66 6967 3a20 5275  self, config: Ru
+00023050: 6e6e 6162 6c65 436f 6e66 6967 207c 204e  nnableConfig | N
+00023060: 6f6e 6520 3d20 4e6f 6e65 2920 2d3e 2047  one = None) -> G
+00023070: 7261 7068 3a0a 2020 2020 2020 2020 6966  raph:.        if
+00023080: 2064 6570 7320 3a3d 2073 656c 662e 6465   deps := self.de
+00023090: 7073 3a0a 2020 2020 2020 2020 2020 2020  ps:.            
+000230a0: 6772 6170 6820 3d20 4772 6170 6828 290a  graph = Graph().
+000230b0: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+000230c0: 745f 6e6f 6465 203d 2067 7261 7068 2e61  t_node = graph.a
+000230d0: 6464 5f6e 6f64 6528 7365 6c66 2e67 6574  dd_node(self.get
+000230e0: 5f69 6e70 7574 5f73 6368 656d 6128 636f  _input_schema(co
+000230f0: 6e66 6967 2929 0a20 2020 2020 2020 2020  nfig)).         
+00023100: 2020 206f 7574 7075 745f 6e6f 6465 203d     output_node =
+00023110: 2067 7261 7068 2e61 6464 5f6e 6f64 6528   graph.add_node(
+00023120: 7365 6c66 2e67 6574 5f6f 7574 7075 745f  self.get_output_
+00023130: 7363 6865 6d61 2863 6f6e 6669 6729 290a  schema(config)).
+00023140: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00023150: 6465 7020 696e 2064 6570 733a 0a20 2020  dep in deps:.   
+00023160: 2020 2020 2020 2020 2020 2020 2064 6570               dep
+00023170: 5f67 7261 7068 203d 2064 6570 2e67 6574  _graph = dep.get
+00023180: 5f67 7261 7068 2829 0a20 2020 2020 2020  _graph().       
+00023190: 2020 2020 2020 2020 2064 6570 5f67 7261           dep_gra
+000231a0: 7068 2e74 7269 6d5f 6669 7273 745f 6e6f  ph.trim_first_no
+000231b0: 6465 2829 0a20 2020 2020 2020 2020 2020  de().           
+000231c0: 2020 2020 2064 6570 5f67 7261 7068 2e74       dep_graph.t
+000231d0: 7269 6d5f 6c61 7374 5f6e 6f64 6528 290a  rim_last_node().
+000231e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000231f0: 6966 206e 6f74 2064 6570 5f67 7261 7068  if not dep_graph
+00023200: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00023210: 2020 2020 2020 6772 6170 682e 6164 645f        graph.add_
+00023220: 6564 6765 2869 6e70 7574 5f6e 6f64 652c  edge(input_node,
+00023230: 206f 7574 7075 745f 6e6f 6465 290a 2020   output_node).  
+00023240: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00023250: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00023260: 2020 2020 2020 2020 6465 705f 6669 7273          dep_firs
+00023270: 745f 6e6f 6465 2c20 6465 705f 6c61 7374  t_node, dep_last
+00023280: 5f6e 6f64 6520 3d20 6772 6170 682e 6578  _node = graph.ex
+00023290: 7465 6e64 2864 6570 5f67 7261 7068 290a  tend(dep_graph).
+000232a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000232b0: 2020 2020 6966 206e 6f74 2064 6570 5f66      if not dep_f
+000232c0: 6972 7374 5f6e 6f64 653a 0a20 2020 2020  irst_node:.     
+000232d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000232e0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+000232f0: 726f 7228 6622 5275 6e6e 6162 6c65 207b  ror(f"Runnable {
+00023300: 6465 707d 2068 6173 206e 6f20 6669 7273  dep} has no firs
+00023310: 7420 6e6f 6465 2229 0a20 2020 2020 2020  t node").       
+00023320: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00023330: 6e6f 7420 6465 705f 6c61 7374 5f6e 6f64  not dep_last_nod
+00023340: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00023350: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00023360: 2056 616c 7565 4572 726f 7228 6622 5275   ValueError(f"Ru
+00023370: 6e6e 6162 6c65 207b 6465 707d 2068 6173  nnable {dep} has
+00023380: 206e 6f20 6c61 7374 206e 6f64 6522 290a   no last node").
+00023390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000233a0: 2020 2020 6772 6170 682e 6164 645f 6564      graph.add_ed
+000233b0: 6765 2869 6e70 7574 5f6e 6f64 652c 2064  ge(input_node, d
+000233c0: 6570 5f66 6972 7374 5f6e 6f64 6529 0a20  ep_first_node). 
+000233d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000233e0: 2020 2067 7261 7068 2e61 6464 5f65 6467     graph.add_edg
+000233f0: 6528 6465 705f 6c61 7374 5f6e 6f64 652c  e(dep_last_node,
+00023400: 206f 7574 7075 745f 6e6f 6465 290a 2020   output_node).  
+00023410: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00023420: 2020 2020 2020 2020 6772 6170 6820 3d20          graph = 
+00023430: 7375 7065 7228 292e 6765 745f 6772 6170  super().get_grap
+00023440: 6828 636f 6e66 6967 290a 0a20 2020 2020  h(config)..     
+00023450: 2020 2072 6574 7572 6e20 6772 6170 680a     return graph.
+00023460: 0a20 2020 2064 6566 205f 5f65 715f 5f28  .    def __eq__(
+00023470: 7365 6c66 2c20 6f74 6865 723a 2041 6e79  self, other: Any
+00023480: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
+00023490: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+000234a0: 286f 7468 6572 2c20 5275 6e6e 6162 6c65  (other, Runnable
+000234b0: 4c61 6d62 6461 293a 0a20 2020 2020 2020  Lambda):.       
+000234c0: 2020 2020 2069 6620 6861 7361 7474 7228       if hasattr(
+000234d0: 7365 6c66 2c20 2266 756e 6322 2920 616e  self, "func") an
+000234e0: 6420 6861 7361 7474 7228 6f74 6865 722c  d hasattr(other,
+000234f0: 2022 6675 6e63 2229 3a0a 2020 2020 2020   "func"):.      
+00023500: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00023510: 2073 656c 662e 6675 6e63 203d 3d20 6f74   self.func == ot
+00023520: 6865 722e 6675 6e63 0a20 2020 2020 2020  her.func.       
+00023530: 2020 2020 2065 6c69 6620 6861 7361 7474       elif hasatt
+00023540: 7228 7365 6c66 2c20 2261 6675 6e63 2229  r(self, "afunc")
+00023550: 2061 6e64 2068 6173 6174 7472 286f 7468   and hasattr(oth
+00023560: 6572 2c20 2261 6675 6e63 2229 3a0a 2020  er, "afunc"):.  
+00023570: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00023580: 7475 726e 2073 656c 662e 6166 756e 6320  turn self.afunc 
+00023590: 3d3d 206f 7468 6572 2e61 6675 6e63 0a20  == other.afunc. 
+000235a0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000235b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000235c0: 2072 6574 7572 6e20 4661 6c73 650a 2020   return False.  
+000235d0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000235e0: 2020 2020 2020 2020 7265 7475 726e 2046          return F
+000235f0: 616c 7365 0a0a 2020 2020 6465 6620 5f5f  alse..    def __
+00023600: 7265 7072 5f5f 2873 656c 6629 202d 3e20  repr__(self) -> 
+00023610: 7374 723a 0a20 2020 2020 2020 2022 2222  str:.        """
+00023620: 4120 7374 7269 6e67 2072 6570 7265 7365  A string represe
+00023630: 6e74 6174 696f 6e20 6f66 2074 6869 7320  ntation of this 
+00023640: 7275 6e6e 6162 6c65 2e22 2222 0a20 2020  runnable.""".   
+00023650: 2020 2020 2069 6620 6861 7361 7474 7228       if hasattr(
+00023660: 7365 6c66 2c20 2266 756e 6322 2920 616e  self, "func") an
+00023670: 6420 6973 696e 7374 616e 6365 2873 656c  d isinstance(sel
+00023680: 662e 6675 6e63 2c20 6974 656d 6765 7474  f.func, itemgett
+00023690: 6572 293a 0a20 2020 2020 2020 2020 2020  er):.           
+000236a0: 2072 6574 7572 6e20 6622 5275 6e6e 6162   return f"Runnab
+000236b0: 6c65 4c61 6d62 6461 287b 7374 7228 7365  leLambda({str(se
+000236c0: 6c66 2e66 756e 6329 5b6c 656e 2827 6f70  lf.func)[len('op
+000236d0: 6572 6174 6f72 2e27 293a 5d7d 2922 0a20  erator.'):]})". 
+000236e0: 2020 2020 2020 2065 6c69 6620 6861 7361         elif hasa
+000236f0: 7474 7228 7365 6c66 2c20 2266 756e 6322  ttr(self, "func"
+00023700: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00023710: 6574 7572 6e20 6622 5275 6e6e 6162 6c65  eturn f"Runnable
+00023720: 4c61 6d62 6461 287b 6765 745f 6c61 6d62  Lambda({get_lamb
+00023730: 6461 5f73 6f75 7263 6528 7365 6c66 2e66  da_source(self.f
+00023740: 756e 6329 206f 7220 272e 2e2e 277d 2922  unc) or '...'})"
+00023750: 0a20 2020 2020 2020 2065 6c69 6620 6861  .        elif ha
+00023760: 7361 7474 7228 7365 6c66 2c20 2261 6675  sattr(self, "afu
+00023770: 6e63 2229 3a0a 2020 2020 2020 2020 2020  nc"):.          
+00023780: 2020 7265 7475 726e 2066 2252 756e 6e61    return f"Runna
+00023790: 626c 654c 616d 6264 6128 6166 756e 633d  bleLambda(afunc=
+000237a0: 7b67 6574 5f6c 616d 6264 615f 736f 7572  {get_lambda_sour
+000237b0: 6365 2873 656c 662e 6166 756e 6329 206f  ce(self.afunc) o
+000237c0: 7220 272e 2e2e 277d 2922 0a20 2020 2020  r '...'})".     
+000237d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000237e0: 2020 2020 2072 6574 7572 6e20 2252 756e       return "Run
+000237f0: 6e61 626c 654c 616d 6264 6128 2e2e 2e29  nableLambda(...)
+00023800: 220a 0a20 2020 2064 6566 205f 696e 766f  "..    def _invo
+00023810: 6b65 280a 2020 2020 2020 2020 7365 6c66  ke(.        self
+00023820: 2c0a 2020 2020 2020 2020 696e 7075 743a  ,.        input:
+00023830: 2049 6e70 7574 2c0a 2020 2020 2020 2020   Input,.        
+00023840: 7275 6e5f 6d61 6e61 6765 723a 2043 616c  run_manager: Cal
+00023850: 6c62 6163 6b4d 616e 6167 6572 466f 7243  lbackManagerForC
+00023860: 6861 696e 5275 6e2c 0a20 2020 2020 2020  hainRun,.       
+00023870: 2063 6f6e 6669 673a 2052 756e 6e61 626c   config: Runnabl
+00023880: 6543 6f6e 6669 672c 0a20 2020 2020 2020  eConfig,.       
+00023890: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
+000238a0: 2020 2020 2920 2d3e 204f 7574 7075 743a      ) -> Output:
+000238b0: 0a20 2020 2020 2020 2069 6620 696e 7370  .        if insp
+000238c0: 6563 742e 6973 6765 6e65 7261 746f 7266  ect.isgeneratorf
+000238d0: 756e 6374 696f 6e28 7365 6c66 2e66 756e  unction(self.fun
+000238e0: 6329 3a0a 2020 2020 2020 2020 2020 2020  c):.            
+000238f0: 6f75 7470 7574 3a20 4f70 7469 6f6e 616c  output: Optional
+00023900: 5b4f 7574 7075 745d 203d 204e 6f6e 650a  [Output] = None.
+00023910: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00023920: 6368 756e 6b20 696e 2063 616c 6c5f 6675  chunk in call_fu
+00023930: 6e63 5f77 6974 685f 7661 7269 6162 6c65  nc_with_variable
+00023940: 5f61 7267 7328 0a20 2020 2020 2020 2020  _args(.         
+00023950: 2020 2020 2020 2063 6173 7428 4361 6c6c         cast(Call
+00023960: 6162 6c65 5b5b 496e 7075 745d 2c20 4974  able[[Input], It
+00023970: 6572 6174 6f72 5b4f 7574 7075 745d 5d2c  erator[Output]],
+00023980: 2073 656c 662e 6675 6e63 292c 0a20 2020   self.func),.   
+00023990: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
+000239a0: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
+000239b0: 2020 2020 636f 6e66 6967 2c0a 2020 2020      config,.    
+000239c0: 2020 2020 2020 2020 2020 2020 7275 6e5f              run_
+000239d0: 6d61 6e61 6765 722c 0a20 2020 2020 2020  manager,.       
+000239e0: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
+000239f0: 732c 0a20 2020 2020 2020 2020 2020 2029  s,.            )
+00023a00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00023a10: 2020 6966 206f 7574 7075 7420 6973 204e    if output is N
+00023a20: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00023a30: 2020 2020 2020 2020 206f 7574 7075 7420           output 
+00023a40: 3d20 6368 756e 6b0a 2020 2020 2020 2020  = chunk.        
+00023a50: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00023a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023a70: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00023a80: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00023a90: 7574 7075 7420 3d20 6f75 7470 7574 202b  utput = output +
+00023aa0: 2063 6875 6e6b 2020 2320 7479 7065 3a20   chunk  # type: 
+00023ab0: 6967 6e6f 7265 5b6f 7065 7261 746f 725d  ignore[operator]
+00023ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023ad0: 2020 2020 2065 7863 6570 7420 5479 7065       except Type
+00023ae0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+00023af0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00023b00: 7574 7075 7420 3d20 6368 756e 6b0a 2020  utput = chunk.  
+00023b10: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00023b20: 2020 2020 2020 2020 6f75 7470 7574 203d          output =
+00023b30: 2063 616c 6c5f 6675 6e63 5f77 6974 685f   call_func_with_
+00023b40: 7661 7269 6162 6c65 5f61 7267 7328 0a20  variable_args(. 
+00023b50: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00023b60: 656c 662e 6675 6e63 2c20 696e 7075 742c  elf.func, input,
+00023b70: 2063 6f6e 6669 672c 2072 756e 5f6d 616e   config, run_man
+00023b80: 6167 6572 2c20 2a2a 6b77 6172 6773 0a20  ager, **kwargs. 
+00023b90: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00023ba0: 2020 2020 2023 2049 6620 7468 6520 6f75       # If the ou
+00023bb0: 7470 7574 2069 7320 6120 7275 6e6e 6162  tput is a runnab
+00023bc0: 6c65 2c20 696e 766f 6b65 2069 740a 2020  le, invoke it.  
+00023bd0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00023be0: 6e63 6528 6f75 7470 7574 2c20 5275 6e6e  nce(output, Runn
+00023bf0: 6162 6c65 293a 0a20 2020 2020 2020 2020  able):.         
+00023c00: 2020 2072 6563 7572 7369 6f6e 5f6c 696d     recursion_lim
+00023c10: 6974 203d 2063 6f6e 6669 675b 2272 6563  it = config["rec
+00023c20: 7572 7369 6f6e 5f6c 696d 6974 225d 0a20  ursion_limit"]. 
+00023c30: 2020 2020 2020 2020 2020 2069 6620 7265             if re
+00023c40: 6375 7273 696f 6e5f 6c69 6d69 7420 3c3d  cursion_limit <=
+00023c50: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00023c60: 2020 2020 7261 6973 6520 5265 6375 7273      raise Recurs
+00023c70: 696f 6e45 7272 6f72 280a 2020 2020 2020  ionError(.      
+00023c80: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00023c90: 5265 6375 7273 696f 6e20 6c69 6d69 7420  Recursion limit 
+00023ca0: 7265 6163 6865 6420 7768 656e 2069 6e76  reached when inv
+00023cb0: 6f6b 696e 6720 7b73 656c 667d 2077 6974  oking {self} wit
+00023cc0: 6820 696e 7075 7420 7b69 6e70 7574 7d2e  h input {input}.
+00023cd0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00023ce0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00023cf0: 6f75 7470 7574 203d 206f 7574 7075 742e  output = output.
+00023d00: 696e 766f 6b65 280a 2020 2020 2020 2020  invoke(.        
+00023d10: 2020 2020 2020 2020 696e 7075 742c 0a20          input,. 
+00023d20: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00023d30: 6174 6368 5f63 6f6e 6669 6728 0a20 2020  atch_config(.   
+00023d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023d50: 2063 6f6e 6669 672c 0a20 2020 2020 2020   config,.       
+00023d60: 2020 2020 2020 2020 2020 2020 2063 616c               cal
+00023d70: 6c62 6163 6b73 3d72 756e 5f6d 616e 6167  lbacks=run_manag
+00023d80: 6572 2e67 6574 5f63 6869 6c64 2829 2c0a  er.get_child(),.
+00023d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023da0: 2020 2020 7265 6375 7273 696f 6e5f 6c69      recursion_li
+00023db0: 6d69 743d 7265 6375 7273 696f 6e5f 6c69  mit=recursion_li
+00023dc0: 6d69 7420 2d20 312c 0a20 2020 2020 2020  mit - 1,.       
+00023dd0: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+00023de0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00023df0: 2020 7265 7475 726e 2063 6173 7428 4f75    return cast(Ou
+00023e00: 7470 7574 2c20 6f75 7470 7574 290a 0a20  tput, output).. 
+00023e10: 2020 2061 7379 6e63 2064 6566 205f 6169     async def _ai
+00023e20: 6e76 6f6b 6528 0a20 2020 2020 2020 2073  nvoke(.        s
+00023e30: 656c 662c 0a20 2020 2020 2020 2069 6e70  elf,.        inp
+00023e40: 7574 3a20 496e 7075 742c 0a20 2020 2020  ut: Input,.     
+00023e50: 2020 2072 756e 5f6d 616e 6167 6572 3a20     run_manager: 
+00023e60: 4173 796e 6343 616c 6c62 6163 6b4d 616e  AsyncCallbackMan
+00023e70: 6167 6572 466f 7243 6861 696e 5275 6e2c  agerForChainRun,
+00023e80: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
+00023e90: 2052 756e 6e61 626c 6543 6f6e 6669 672c   RunnableConfig,
+00023ea0: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+00023eb0: 733a 2041 6e79 2c0a 2020 2020 2920 2d3e  s: Any,.    ) ->
+00023ec0: 204f 7574 7075 743a 0a20 2020 2020 2020   Output:.       
+00023ed0: 2069 6620 6861 7361 7474 7228 7365 6c66   if hasattr(self
+00023ee0: 2c20 2261 6675 6e63 2229 3a0a 2020 2020  , "afunc"):.    
+00023ef0: 2020 2020 2020 2020 6166 756e 6320 3d20          afunc = 
+00023f00: 7365 6c66 2e61 6675 6e63 0a20 2020 2020  self.afunc.     
+00023f10: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00023f20: 2020 2020 2069 6620 696e 7370 6563 742e       if inspect.
+00023f30: 6973 6765 6e65 7261 746f 7266 756e 6374  isgeneratorfunct
+00023f40: 696f 6e28 7365 6c66 2e66 756e 6329 3a0a  ion(self.func):.
+00023f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023f60: 2064 6566 2066 756e 6328 0a20 2020 2020   def func(.     
+00023f70: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00023f80: 6e70 7574 3a20 496e 7075 742c 0a20 2020  nput: Input,.   
+00023f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023fa0: 2072 756e 5f6d 616e 6167 6572 3a20 4173   run_manager: As
+00023fb0: 796e 6343 616c 6c62 6163 6b4d 616e 6167  yncCallbackManag
+00023fc0: 6572 466f 7243 6861 696e 5275 6e2c 0a20  erForChainRun,. 
+00023fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023fe0: 2020 2063 6f6e 6669 673a 2052 756e 6e61     config: Runna
+00023ff0: 626c 6543 6f6e 6669 672c 0a20 2020 2020  bleConfig,.     
+00024000: 2020 2020 2020 2020 2020 2020 2020 202a                 *
+00024010: 2a6b 7761 7267 733a 2041 6e79 2c0a 2020  *kwargs: Any,.  
+00024020: 2020 2020 2020 2020 2020 2020 2020 2920                ) 
+00024030: 2d3e 204f 7574 7075 743a 0a20 2020 2020  -> Output:.     
+00024040: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00024050: 7574 7075 743a 204f 7074 696f 6e61 6c5b  utput: Optional[
+00024060: 4f75 7470 7574 5d20 3d20 4e6f 6e65 0a20  Output] = None. 
+00024070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024080: 2020 2066 6f72 2063 6875 6e6b 2069 6e20     for chunk in 
+00024090: 6361 6c6c 5f66 756e 635f 7769 7468 5f76  call_func_with_v
+000240a0: 6172 6961 626c 655f 6172 6773 280a 2020  ariable_args(.  
+000240b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000240c0: 2020 2020 2020 6361 7374 2843 616c 6c61        cast(Calla
+000240d0: 626c 655b 5b49 6e70 7574 5d2c 2049 7465  ble[[Input], Ite
+000240e0: 7261 746f 725b 4f75 7470 7574 5d5d 2c20  rator[Output]], 
+000240f0: 7365 6c66 2e66 756e 6329 2c0a 2020 2020  self.func),.    
+00024100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024110: 2020 2020 696e 7075 742c 0a20 2020 2020      input,.     
+00024120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024130: 2020 2063 6f6e 6669 672c 0a20 2020 2020     config,.     
+00024140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024150: 2020 2072 756e 5f6d 616e 6167 6572 2e67     run_manager.g
+00024160: 6574 5f73 796e 6328 292c 0a20 2020 2020  et_sync(),.     
+00024170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024180: 2020 202a 2a6b 7761 7267 732c 0a20 2020     **kwargs,.   
+00024190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000241a0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+000241b0: 2020 2020 2020 2020 2020 2020 6966 206f              if o
+000241c0: 7574 7075 7420 6973 204e 6f6e 653a 0a20  utput is None:. 
+000241d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000241e0: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+000241f0: 7420 3d20 6368 756e 6b0a 2020 2020 2020  t = chunk.      
+00024200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024210: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00024220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024230: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00024240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024250: 2020 2020 2020 2020 206f 7574 7075 7420           output 
+00024260: 3d20 6f75 7470 7574 202b 2063 6875 6e6b  = output + chunk
+00024270: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
+00024280: 5b6f 7065 7261 746f 725d 0a20 2020 2020  [operator].     
+00024290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000242a0: 2020 2020 2020 2065 7863 6570 7420 5479         except Ty
+000242b0: 7065 4572 726f 723a 0a20 2020 2020 2020  peError:.       
+000242c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000242d0: 2020 2020 2020 2020 206f 7574 7075 7420           output 
+000242e0: 3d20 6368 756e 6b0a 2020 2020 2020 2020  = chunk.        
+000242f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00024300: 726e 2063 6173 7428 4f75 7470 7574 2c20  rn cast(Output, 
+00024310: 6f75 7470 7574 290a 0a20 2020 2020 2020  output)..       
+00024320: 2020 2020 2065 6c73 653a 0a0a 2020 2020       else:..    
+00024330: 2020 2020 2020 2020 2020 2020 6465 6620              def 
+00024340: 6675 6e63 280a 2020 2020 2020 2020 2020  func(.          
+00024350: 2020 2020 2020 2020 2020 696e 7075 743a            input:
+00024360: 2049 6e70 7574 2c0a 2020 2020 2020 2020   Input,.        
+00024370: 2020 2020 2020 2020 2020 2020 7275 6e5f              run_
+00024380: 6d61 6e61 6765 723a 2041 7379 6e63 4361  manager: AsyncCa
+00024390: 6c6c 6261 636b 4d61 6e61 6765 7246 6f72  llbackManagerFor
+000243a0: 4368 6169 6e52 756e 2c0a 2020 2020 2020  ChainRun,.      
+000243b0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+000243c0: 6e66 6967 3a20 5275 6e6e 6162 6c65 436f  nfig: RunnableCo
+000243d0: 6e66 6967 2c0a 2020 2020 2020 2020 2020  nfig,.          
+000243e0: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
+000243f0: 6773 3a20 416e 792c 0a20 2020 2020 2020  gs: Any,.       
+00024400: 2020 2020 2020 2020 2029 202d 3e20 4f75           ) -> Ou
+00024410: 7470 7574 3a0a 2020 2020 2020 2020 2020  tput:.          
+00024420: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00024430: 2063 616c 6c5f 6675 6e63 5f77 6974 685f   call_func_with_
+00024440: 7661 7269 6162 6c65 5f61 7267 7328 0a20  variable_args(. 
+00024450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024460: 2020 2020 2020 2073 656c 662e 6675 6e63         self.func
+00024470: 2c20 696e 7075 742c 2063 6f6e 6669 672c  , input, config,
+00024480: 2072 756e 5f6d 616e 6167 6572 2e67 6574   run_manager.get
+00024490: 5f73 796e 6328 292c 202a 2a6b 7761 7267  _sync(), **kwarg
+000244a0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+000244b0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+000244c0: 2020 2020 2040 7772 6170 7328 6675 6e63       @wraps(func
+000244d0: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+000244e0: 796e 6320 6465 6620 6628 2a61 7267 732c  ync def f(*args,
+000244f0: 202a 2a6b 7761 7267 7329 3a20 2023 2074   **kwargs):  # t
+00024500: 7970 653a 2069 676e 6f72 655b 6e6f 2d75  ype: ignore[no-u
+00024510: 6e74 7970 6564 2d64 6566 5d0a 2020 2020  ntyped-def].    
+00024520: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00024530: 726e 2061 7761 6974 2072 756e 5f69 6e5f  rn await run_in_
+00024540: 6578 6563 7574 6f72 2863 6f6e 6669 672c  executor(config,
+00024550: 2066 756e 632c 202a 6172 6773 2c20 2a2a   func, *args, **
+00024560: 6b77 6172 6773 290a 0a20 2020 2020 2020  kwargs)..       
+00024570: 2020 2020 2061 6675 6e63 203d 2066 0a0a       afunc = f..
+00024580: 2020 2020 2020 2020 6966 2069 6e73 7065          if inspe
+00024590: 6374 2e69 7361 7379 6e63 6765 6e66 756e  ct.isasyncgenfun
+000245a0: 6374 696f 6e28 6166 756e 6329 3a0a 2020  ction(afunc):.  
+000245b0: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+000245c0: 3a20 4f70 7469 6f6e 616c 5b4f 7574 7075  : Optional[Outpu
+000245d0: 745d 203d 204e 6f6e 650a 2020 2020 2020  t] = None.      
+000245e0: 2020 2020 2020 6173 796e 6320 666f 7220        async for 
+000245f0: 6368 756e 6b20 696e 2063 6173 7428 0a20  chunk in cast(. 
+00024600: 2020 2020 2020 2020 2020 2020 2020 2041                 A
+00024610: 7379 6e63 4974 6572 6174 6f72 5b4f 7574  syncIterator[Out
+00024620: 7075 745d 2c0a 2020 2020 2020 2020 2020  put],.          
+00024630: 2020 2020 2020 6163 616c 6c5f 6675 6e63        acall_func
+00024640: 5f77 6974 685f 7661 7269 6162 6c65 5f61  _with_variable_a
+00024650: 7267 7328 0a20 2020 2020 2020 2020 2020  rgs(.           
+00024660: 2020 2020 2020 2020 2063 6173 7428 4361           cast(Ca
+00024670: 6c6c 6162 6c65 2c20 6166 756e 6329 2c0a  llable, afunc),.
+00024680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024690: 2020 2020 696e 7075 742c 0a20 2020 2020      input,.     
+000246a0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000246b0: 6f6e 6669 672c 0a20 2020 2020 2020 2020  onfig,.         
+000246c0: 2020 2020 2020 2020 2020 2072 756e 5f6d             run_m
+000246d0: 616e 6167 6572 2c0a 2020 2020 2020 2020  anager,.        
+000246e0: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
+000246f0: 6172 6773 2c0a 2020 2020 2020 2020 2020  args,.          
+00024700: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
+00024710: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
+00024720: 2020 2020 2020 2020 6966 206f 7574 7075          if outpu
+00024730: 7420 6973 204e 6f6e 653a 0a20 2020 2020  t is None:.     
+00024740: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00024750: 7574 7075 7420 3d20 6368 756e 6b0a 2020  utput = chunk.  
+00024760: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00024770: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00024780: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00024790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000247a0: 2020 2020 206f 7574 7075 7420 3d20 6f75       output = ou
+000247b0: 7470 7574 202b 2063 6875 6e6b 2020 2320  tput + chunk  # 
+000247c0: 7479 7065 3a20 6967 6e6f 7265 5b6f 7065  type: ignore[ope
+000247d0: 7261 746f 725d 0a20 2020 2020 2020 2020  rator].         
+000247e0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+000247f0: 7420 5479 7065 4572 726f 723a 0a20 2020  t TypeError:.   
+00024800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024810: 2020 2020 206f 7574 7075 7420 3d20 6368       output = ch
+00024820: 756e 6b0a 2020 2020 2020 2020 656c 7365  unk.        else
+00024830: 3a0a 2020 2020 2020 2020 2020 2020 6f75  :.            ou
+00024840: 7470 7574 203d 2061 7761 6974 2061 6361  tput = await aca
+00024850: 6c6c 5f66 756e 635f 7769 7468 5f76 6172  ll_func_with_var
+00024860: 6961 626c 655f 6172 6773 280a 2020 2020  iable_args(.    
+00024870: 2020 2020 2020 2020 2020 2020 6361 7374              cast
+00024880: 2843 616c 6c61 626c 652c 2061 6675 6e63  (Callable, afunc
+00024890: 292c 2069 6e70 7574 2c20 636f 6e66 6967  ), input, config
+000248a0: 2c20 7275 6e5f 6d61 6e61 6765 722c 202a  , run_manager, *
+000248b0: 2a6b 7761 7267 730a 2020 2020 2020 2020  *kwargs.        
+000248c0: 2020 2020 290a 2020 2020 2020 2020 2320      ).        # 
+000248d0: 4966 2074 6865 206f 7574 7075 7420 6973  If the output is
+000248e0: 2061 2072 756e 6e61 626c 652c 2069 6e76   a runnable, inv
+000248f0: 6f6b 6520 6974 0a20 2020 2020 2020 2069  oke it.        i
+00024900: 6620 6973 696e 7374 616e 6365 286f 7574  f isinstance(out
+00024910: 7075 742c 2052 756e 6e61 626c 6529 3a0a  put, Runnable):.
+00024920: 2020 2020 2020 2020 2020 2020 7265 6375              recu
+00024930: 7273 696f 6e5f 6c69 6d69 7420 3d20 636f  rsion_limit = co
+00024940: 6e66 6967 5b22 7265 6375 7273 696f 6e5f  nfig["recursion_
+00024950: 6c69 6d69 7422 5d0a 2020 2020 2020 2020  limit"].        
+00024960: 2020 2020 6966 2072 6563 7572 7369 6f6e      if recursion
+00024970: 5f6c 696d 6974 203c 3d20 303a 0a20 2020  _limit <= 0:.   
+00024980: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00024990: 7365 2052 6563 7572 7369 6f6e 4572 726f  se RecursionErro
+000249a0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+000249b0: 2020 2020 2020 2066 2252 6563 7572 7369         f"Recursi
+000249c0: 6f6e 206c 696d 6974 2072 6561 6368 6564  on limit reached
+000249d0: 2077 6865 6e20 696e 766f 6b69 6e67 207b   when invoking {
+000249e0: 7365 6c66 7d20 7769 7468 2069 6e70 7574  self} with input
+000249f0: 207b 696e 7075 747d 2e22 0a20 2020 2020   {input}.".     
+00024a00: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00024a10: 2020 2020 2020 2020 206f 7574 7075 7420           output 
+00024a20: 3d20 6177 6169 7420 6f75 7470 7574 2e61  = await output.a
+00024a30: 696e 766f 6b65 280a 2020 2020 2020 2020  invoke(.        
+00024a40: 2020 2020 2020 2020 696e 7075 742c 0a20          input,. 
+00024a50: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00024a60: 6174 6368 5f63 6f6e 6669 6728 0a20 2020  atch_config(.   
+00024a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024a80: 2063 6f6e 6669 672c 0a20 2020 2020 2020   config,.       
+00024a90: 2020 2020 2020 2020 2020 2020 2063 616c               cal
+00024aa0: 6c62 6163 6b73 3d72 756e 5f6d 616e 6167  lbacks=run_manag
+00024ab0: 6572 2e67 6574 5f63 6869 6c64 2829 2c0a  er.get_child(),.
+00024ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024ad0: 2020 2020 7265 6375 7273 696f 6e5f 6c69      recursion_li
+00024ae0: 6d69 743d 7265 6375 7273 696f 6e5f 6c69  mit=recursion_li
+00024af0: 6d69 7420 2d20 312c 0a20 2020 2020 2020  mit - 1,.       
+00024b00: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+00024b10: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00024b20: 2020 7265 7475 726e 2063 6173 7428 4f75    return cast(Ou
+00024b30: 7470 7574 2c20 6f75 7470 7574 290a 0a20  tput, output).. 
+00024b40: 2020 2064 6566 205f 636f 6e66 6967 280a     def _config(.
+00024b50: 2020 2020 2020 2020 7365 6c66 2c20 636f          self, co
+00024b60: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
+00024b70: 756e 6e61 626c 6543 6f6e 6669 675d 2c20  unnableConfig], 
+00024b80: 6361 6c6c 6162 6c65 3a20 4361 6c6c 6162  callable: Callab
+00024b90: 6c65 5b2e 2e2e 2c20 416e 795d 0a20 2020  le[..., Any].   
+00024ba0: 2029 202d 3e20 5275 6e6e 6162 6c65 436f   ) -> RunnableCo
+00024bb0: 6e66 6967 3a0a 2020 2020 2020 2020 7265  nfig:.        re
+00024bc0: 7475 726e 2065 6e73 7572 655f 636f 6e66  turn ensure_conf
+00024bd0: 6967 2863 6f6e 6669 6729 0a0a 2020 2020  ig(config)..    
+00024be0: 6465 6620 696e 766f 6b65 280a 2020 2020  def invoke(.    
+00024bf0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00024c00: 2020 696e 7075 743a 2049 6e70 7574 2c0a    input: Input,.
+00024c10: 2020 2020 2020 2020 636f 6e66 6967 3a20          config: 
+00024c20: 4f70 7469 6f6e 616c 5b52 756e 6e61 626c  Optional[Runnabl
+00024c30: 6543 6f6e 6669 675d 203d 204e 6f6e 652c  eConfig] = None,
+00024c40: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+00024c50: 733a 204f 7074 696f 6e61 6c5b 416e 795d  s: Optional[Any]
+00024c60: 2c0a 2020 2020 2920 2d3e 204f 7574 7075  ,.    ) -> Outpu
+00024c70: 743a 0a20 2020 2020 2020 2022 2222 496e  t:.        """In
+00024c80: 766f 6b65 2074 6869 7320 7275 6e6e 6162  voke this runnab
+00024c90: 6c65 2073 796e 6368 726f 6e6f 7573 6c79  le synchronously
+00024ca0: 2e22 2222 0a20 2020 2020 2020 2069 6620  .""".        if 
+00024cb0: 6861 7361 7474 7228 7365 6c66 2c20 2266  hasattr(self, "f
+00024cc0: 756e 6322 293a 0a20 2020 2020 2020 2020  unc"):.         
+00024cd0: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+00024ce0: 6361 6c6c 5f77 6974 685f 636f 6e66 6967  call_with_config
+00024cf0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00024d00: 2020 7365 6c66 2e5f 696e 766f 6b65 2c0a    self._invoke,.
+00024d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024d20: 696e 7075 742c 0a20 2020 2020 2020 2020  input,.         
+00024d30: 2020 2020 2020 2073 656c 662e 5f63 6f6e         self._con
+00024d40: 6669 6728 636f 6e66 6967 2c20 7365 6c66  fig(config, self
+00024d50: 2e66 756e 6329 2c0a 2020 2020 2020 2020  .func),.        
+00024d60: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+00024d70: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00024d80: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00024d90: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00024da0: 5479 7065 4572 726f 7228 0a20 2020 2020  TypeError(.     
+00024db0: 2020 2020 2020 2020 2020 2022 4361 6e6e             "Cann
+00024dc0: 6f74 2069 6e76 6f6b 6520 6120 636f 726f  ot invoke a coro
+00024dd0: 7574 696e 6520 6675 6e63 7469 6f6e 2073  utine function s
+00024de0: 796e 6368 726f 6e6f 7573 6c79 2e22 0a20  ynchronously.". 
+00024df0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00024e00: 5573 6520 6061 696e 766f 6b65 6020 696e  Use `ainvoke` in
+00024e10: 7374 6561 642e 220a 2020 2020 2020 2020  stead.".        
+00024e20: 2020 2020 290a 0a20 2020 2061 7379 6e63      )..    async
+00024e30: 2064 6566 2061 696e 766f 6b65 280a 2020   def ainvoke(.  
+00024e40: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00024e50: 2020 2020 696e 7075 743a 2049 6e70 7574      input: Input
+00024e60: 2c0a 2020 2020 2020 2020 636f 6e66 6967  ,.        config
+00024e70: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
+00024e80: 626c 6543 6f6e 6669 675d 203d 204e 6f6e  bleConfig] = Non
+00024e90: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
+00024ea0: 7267 733a 204f 7074 696f 6e61 6c5b 416e  rgs: Optional[An
+00024eb0: 795d 2c0a 2020 2020 2920 2d3e 204f 7574  y],.    ) -> Out
+00024ec0: 7075 743a 0a20 2020 2020 2020 2022 2222  put:.        """
+00024ed0: 496e 766f 6b65 2074 6869 7320 7275 6e6e  Invoke this runn
+00024ee0: 6162 6c65 2061 7379 6e63 6872 6f6e 6f75  able asynchronou
+00024ef0: 736c 792e 2222 220a 2020 2020 2020 2020  sly.""".        
+00024f00: 7468 655f 6675 6e63 203d 2073 656c 662e  the_func = self.
+00024f10: 6166 756e 6320 6966 2068 6173 6174 7472  afunc if hasattr
+00024f20: 2873 656c 662c 2022 6166 756e 6322 2920  (self, "afunc") 
+00024f30: 656c 7365 2073 656c 662e 6675 6e63 0a20  else self.func. 
+00024f40: 2020 2020 2020 2072 6574 7572 6e20 6177         return aw
+00024f50: 6169 7420 7365 6c66 2e5f 6163 616c 6c5f  ait self._acall_
+00024f60: 7769 7468 5f63 6f6e 6669 6728 0a20 2020  with_config(.   
+00024f70: 2020 2020 2020 2020 2073 656c 662e 5f61           self._a
+00024f80: 696e 766f 6b65 2c0a 2020 2020 2020 2020  invoke,.        
+00024f90: 2020 2020 696e 7075 742c 0a20 2020 2020      input,.     
+00024fa0: 2020 2020 2020 2073 656c 662e 5f63 6f6e         self._con
+00024fb0: 6669 6728 636f 6e66 6967 2c20 7468 655f  fig(config, the_
+00024fc0: 6675 6e63 292c 0a20 2020 2020 2020 2020  func),.         
+00024fd0: 2020 202a 2a6b 7761 7267 732c 0a20 2020     **kwargs,.   
+00024fe0: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+00024ff0: 5f74 7261 6e73 666f 726d 280a 2020 2020  _transform(.    
+00025000: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00025010: 2020 696e 7075 743a 2049 7465 7261 746f    input: Iterato
+00025020: 725b 496e 7075 745d 2c0a 2020 2020 2020  r[Input],.      
+00025030: 2020 7275 6e5f 6d61 6e61 6765 723a 2043    run_manager: C
+00025040: 616c 6c62 6163 6b4d 616e 6167 6572 466f  allbackManagerFo
+00025050: 7243 6861 696e 5275 6e2c 0a20 2020 2020  rChainRun,.     
+00025060: 2020 2063 6f6e 6669 673a 2052 756e 6e61     config: Runna
+00025070: 626c 6543 6f6e 6669 672c 0a20 2020 2020  bleConfig,.     
+00025080: 2020 202a 2a6b 7761 7267 733a 2041 6e79     **kwargs: Any
+00025090: 2c0a 2020 2020 2920 2d3e 2049 7465 7261  ,.    ) -> Itera
+000250a0: 746f 725b 4f75 7470 7574 5d3a 0a20 2020  tor[Output]:.   
+000250b0: 2020 2020 2066 696e 616c 3a20 496e 7075       final: Inpu
+000250c0: 740a 2020 2020 2020 2020 676f 745f 6669  t.        got_fi
+000250d0: 7273 745f 7661 6c20 3d20 4661 6c73 650a  rst_val = False.
+000250e0: 2020 2020 2020 2020 666f 7220 6963 6875          for ichu
+000250f0: 6e6b 2069 6e20 696e 7075 743a 0a20 2020  nk in input:.   
+00025100: 2020 2020 2020 2020 2023 2042 7920 6465           # By de
+00025110: 6669 6e69 7469 6f6e 732c 2052 756e 6e61  finitions, Runna
+00025120: 626c 654c 616d 6264 6173 2063 6f6e 7375  bleLambdas consu
+00025130: 6d65 2061 6c6c 2069 6e70 7574 2062 6566  me all input bef
+00025140: 6f72 6520 656d 6974 7469 6e67 206f 7574  ore emitting out
+00025150: 7075 742e 0a20 2020 2020 2020 2020 2020  put..           
+00025160: 2023 2049 6620 7468 6520 696e 7075 7420   # If the input 
+00025170: 6973 206e 6f74 2061 6464 6162 6c65 2c20  is not addable, 
+00025180: 7468 656e 2077 6527 6c6c 2061 7373 756d  then we'll assum
+00025190: 6520 7468 6174 2077 6520 6361 6e0a 2020  e that we can.  
+000251a0: 2020 2020 2020 2020 2020 2320 6f6e 6c79            # only
+000251b0: 206f 7065 7261 7465 206f 6e20 7468 6520   operate on the 
+000251c0: 6c61 7374 2063 6875 6e6b 2e0a 2020 2020  last chunk..    
+000251d0: 2020 2020 2020 2020 2320 536f 2077 6527          # So we'
+000251e0: 6c6c 2069 7465 7261 7465 2075 6e74 696c  ll iterate until
+000251f0: 2077 6520 6765 7420 746f 2074 6865 206c   we get to the l
+00025200: 6173 7420 6368 756e 6b21 0a20 2020 2020  ast chunk!.     
+00025210: 2020 2020 2020 2069 6620 6e6f 7420 676f         if not go
+00025220: 745f 6669 7273 745f 7661 6c3a 0a20 2020  t_first_val:.   
+00025230: 2020 2020 2020 2020 2020 2020 2066 696e               fin
+00025240: 616c 203d 2069 6368 756e 6b0a 2020 2020  al = ichunk.    
+00025250: 2020 2020 2020 2020 2020 2020 676f 745f              got_
+00025260: 6669 7273 745f 7661 6c20 3d20 5472 7565  first_val = True
+00025270: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00025280: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00025290: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+000252a0: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
+000252b0: 6c20 3d20 6669 6e61 6c20 2b20 6963 6875  l = final + ichu
+000252c0: 6e6b 2020 2320 7479 7065 3a20 6967 6e6f  nk  # type: igno
+000252d0: 7265 5b6f 7065 7261 746f 725d 0a20 2020  re[operator].   
+000252e0: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+000252f0: 6570 7420 5479 7065 4572 726f 723a 0a20  ept TypeError:. 
+00025300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025310: 2020 2066 696e 616c 203d 2069 6368 756e     final = ichun
+00025320: 6b0a 0a20 2020 2020 2020 2069 6620 696e  k..        if in
+00025330: 7370 6563 742e 6973 6765 6e65 7261 746f  spect.isgenerato
+00025340: 7266 756e 6374 696f 6e28 7365 6c66 2e66  rfunction(self.f
+00025350: 756e 6329 3a0a 2020 2020 2020 2020 2020  unc):.          
+00025360: 2020 6f75 7470 7574 3a20 4f70 7469 6f6e    output: Option
+00025370: 616c 5b4f 7574 7075 745d 203d 204e 6f6e  al[Output] = Non
+00025380: 650a 2020 2020 2020 2020 2020 2020 666f  e.            fo
+00025390: 7220 6368 756e 6b20 696e 2063 616c 6c5f  r chunk in call_
+000253a0: 6675 6e63 5f77 6974 685f 7661 7269 6162  func_with_variab
+000253b0: 6c65 5f61 7267 7328 0a20 2020 2020 2020  le_args(.       
+000253c0: 2020 2020 2020 2020 2073 656c 662e 6675           self.fu
+000253d0: 6e63 2c20 6361 7374 2849 6e70 7574 2c20  nc, cast(Input, 
+000253e0: 6669 6e61 6c29 2c20 636f 6e66 6967 2c20  final), config, 
+000253f0: 7275 6e5f 6d61 6e61 6765 722c 202a 2a6b  run_manager, **k
+00025400: 7761 7267 730a 2020 2020 2020 2020 2020  wargs.          
+00025410: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+00025420: 2020 2020 2079 6965 6c64 2063 6875 6e6b       yield chunk
+00025430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025440: 2069 6620 6f75 7470 7574 2069 7320 4e6f   if output is No
+00025450: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00025460: 2020 2020 2020 2020 6f75 7470 7574 203d          output =
+00025470: 2063 6875 6e6b 0a20 2020 2020 2020 2020   chunk.         
+00025480: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00025490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000254a0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+000254b0: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
+000254c0: 7470 7574 203d 206f 7574 7075 7420 2b20  tput = output + 
+000254d0: 6368 756e 6b0a 2020 2020 2020 2020 2020  chunk.          
+000254e0: 2020 2020 2020 2020 2020 6578 6365 7074            except
+000254f0: 2054 7970 6545 7272 6f72 3a0a 2020 2020   TypeError:.    
+00025500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025510: 2020 2020 6f75 7470 7574 203d 2063 6875      output = chu
+00025520: 6e6b 0a20 2020 2020 2020 2065 6c73 653a  nk.        else:
+00025530: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+00025540: 7075 7420 3d20 6361 6c6c 5f66 756e 635f  put = call_func_
+00025550: 7769 7468 5f76 6172 6961 626c 655f 6172  with_variable_ar
+00025560: 6773 280a 2020 2020 2020 2020 2020 2020  gs(.            
+00025570: 2020 2020 7365 6c66 2e66 756e 632c 2063      self.func, c
+00025580: 6173 7428 496e 7075 742c 2066 696e 616c  ast(Input, final
+00025590: 292c 2063 6f6e 6669 672c 2072 756e 5f6d  ), config, run_m
+000255a0: 616e 6167 6572 2c20 2a2a 6b77 6172 6773  anager, **kwargs
+000255b0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+000255c0: 2020 2020 2020 2020 2320 4966 2074 6865          # If the
+000255d0: 206f 7574 7075 7420 6973 2061 2072 756e   output is a run
+000255e0: 6e61 626c 652c 2075 7365 2069 7473 2073  nable, use its s
+000255f0: 7472 6561 6d20 6f75 7470 7574 0a20 2020  tream output.   
+00025600: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00025610: 6365 286f 7574 7075 742c 2052 756e 6e61  ce(output, Runna
+00025620: 626c 6529 3a0a 2020 2020 2020 2020 2020  ble):.          
+00025630: 2020 7265 6375 7273 696f 6e5f 6c69 6d69    recursion_limi
+00025640: 7420 3d20 636f 6e66 6967 5b22 7265 6375  t = config["recu
+00025650: 7273 696f 6e5f 6c69 6d69 7422 5d0a 2020  rsion_limit"].  
+00025660: 2020 2020 2020 2020 2020 6966 2072 6563            if rec
+00025670: 7572 7369 6f6e 5f6c 696d 6974 203c 3d20  ursion_limit <= 
+00025680: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+00025690: 2020 2072 6169 7365 2052 6563 7572 7369     raise Recursi
+000256a0: 6f6e 4572 726f 7228 0a20 2020 2020 2020  onError(.       
+000256b0: 2020 2020 2020 2020 2020 2020 2066 2252               f"R
+000256c0: 6563 7572 7369 6f6e 206c 696d 6974 2072  ecursion limit r
+000256d0: 6561 6368 6564 2077 6865 6e20 696e 766f  eached when invo
+000256e0: 6b69 6e67 2022 0a20 2020 2020 2020 2020  king ".         
+000256f0: 2020 2020 2020 2020 2020 2066 227b 7365             f"{se
+00025700: 6c66 7d20 7769 7468 2069 6e70 7574 207b  lf} with input {
+00025710: 6669 6e61 6c7d 2e22 0a20 2020 2020 2020  final}.".       
+00025720: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00025730: 2020 2020 2020 2066 6f72 2063 6875 6e6b         for chunk
+00025740: 2069 6e20 6f75 7470 7574 2e73 7472 6561   in output.strea
+00025750: 6d28 0a20 2020 2020 2020 2020 2020 2020  m(.             
+00025760: 2020 2066 696e 616c 2c0a 2020 2020 2020     final,.      
+00025770: 2020 2020 2020 2020 2020 7061 7463 685f            patch_
+00025780: 636f 6e66 6967 280a 2020 2020 2020 2020  config(.        
+00025790: 2020 2020 2020 2020 2020 2020 636f 6e66              conf
+000257a0: 6967 2c0a 2020 2020 2020 2020 2020 2020  ig,.            
+000257b0: 2020 2020 2020 2020 6361 6c6c 6261 636b          callback
+000257c0: 733d 7275 6e5f 6d61 6e61 6765 722e 6765  s=run_manager.ge
+000257d0: 745f 6368 696c 6428 292c 0a20 2020 2020  t_child(),.     
+000257e0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000257f0: 6563 7572 7369 6f6e 5f6c 696d 6974 3d72  ecursion_limit=r
+00025800: 6563 7572 7369 6f6e 5f6c 696d 6974 202d  ecursion_limit -
+00025810: 2031 2c0a 2020 2020 2020 2020 2020 2020   1,.            
+00025820: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
+00025830: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
+00025840: 2020 2020 2020 7969 656c 6420 6368 756e        yield chun
+00025850: 6b0a 2020 2020 2020 2020 656c 6966 206e  k.        elif n
+00025860: 6f74 2069 6e73 7065 6374 2e69 7367 656e  ot inspect.isgen
+00025870: 6572 6174 6f72 6675 6e63 7469 6f6e 2873  eratorfunction(s
+00025880: 656c 662e 6675 6e63 293a 0a20 2020 2020  elf.func):.     
+00025890: 2020 2020 2020 2023 204f 7468 6572 7769         # Otherwi
+000258a0: 7365 2c20 6a75 7374 2079 6965 6c64 2069  se, just yield i
+000258b0: 740a 2020 2020 2020 2020 2020 2020 7969  t.            yi
+000258c0: 656c 6420 6361 7374 284f 7574 7075 742c  eld cast(Output,
+000258d0: 206f 7574 7075 7429 0a0a 2020 2020 6465   output)..    de
+000258e0: 6620 7472 616e 7366 6f72 6d28 0a20 2020  f transform(.   
+000258f0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00025900: 2020 2069 6e70 7574 3a20 4974 6572 6174     input: Iterat
+00025910: 6f72 5b49 6e70 7574 5d2c 0a20 2020 2020  or[Input],.     
+00025920: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
+00025930: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
+00025940: 6967 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ig] = None,.    
+00025950: 2020 2020 2a2a 6b77 6172 6773 3a20 4f70      **kwargs: Op
+00025960: 7469 6f6e 616c 5b41 6e79 5d2c 0a20 2020  tional[Any],.   
+00025970: 2029 202d 3e20 4974 6572 6174 6f72 5b4f   ) -> Iterator[O
+00025980: 7574 7075 745d 3a0a 2020 2020 2020 2020  utput]:.        
+00025990: 6966 2068 6173 6174 7472 2873 656c 662c  if hasattr(self,
+000259a0: 2022 6675 6e63 2229 3a0a 2020 2020 2020   "func"):.      
+000259b0: 2020 2020 2020 666f 7220 6f75 7470 7574        for output
+000259c0: 2069 6e20 7365 6c66 2e5f 7472 616e 7366   in self._transf
+000259d0: 6f72 6d5f 7374 7265 616d 5f77 6974 685f  orm_stream_with_
+000259e0: 636f 6e66 6967 280a 2020 2020 2020 2020  config(.        
+000259f0: 2020 2020 2020 2020 696e 7075 742c 0a20          input,. 
+00025a00: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00025a10: 656c 662e 5f74 7261 6e73 666f 726d 2c0a  elf._transform,.
+00025a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025a30: 7365 6c66 2e5f 636f 6e66 6967 2863 6f6e  self._config(con
+00025a40: 6669 672c 2073 656c 662e 6675 6e63 292c  fig, self.func),
+00025a50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025a60: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
+00025a70: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
+00025a80: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
+00025a90: 6f75 7470 7574 0a20 2020 2020 2020 2065  output.        e
+00025aa0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00025ab0: 2072 6169 7365 2054 7970 6545 7272 6f72   raise TypeError
+00025ac0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00025ad0: 2020 2243 616e 6e6f 7420 7374 7265 616d    "Cannot stream
+00025ae0: 2061 2063 6f72 6f75 7469 6e65 2066 756e   a coroutine fun
+00025af0: 6374 696f 6e20 7379 6e63 6872 6f6e 6f75  ction synchronou
+00025b00: 736c 792e 220a 2020 2020 2020 2020 2020  sly.".          
+00025b10: 2020 2020 2020 2255 7365 2060 6173 7472        "Use `astr
+00025b20: 6561 6d60 2069 6e73 7465 6164 2e22 0a20  eam` instead.". 
+00025b30: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00025b40: 2020 6465 6620 7374 7265 616d 280a 2020    def stream(.  
+00025b50: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00025b60: 2020 2020 696e 7075 743a 2049 6e70 7574      input: Input
+00025b70: 2c0a 2020 2020 2020 2020 636f 6e66 6967  ,.        config
+00025b80: 3a20 4f70 7469 6f6e 616c 5b52 756e 6e61  : Optional[Runna
+00025b90: 626c 6543 6f6e 6669 675d 203d 204e 6f6e  bleConfig] = Non
+00025ba0: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
+00025bb0: 7267 733a 204f 7074 696f 6e61 6c5b 416e  rgs: Optional[An
+00025bc0: 795d 2c0a 2020 2020 2920 2d3e 2049 7465  y],.    ) -> Ite
+00025bd0: 7261 746f 725b 4f75 7470 7574 5d3a 0a20  rator[Output]:. 
+00025be0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00025bf0: 6c66 2e74 7261 6e73 666f 726d 2869 7465  lf.transform(ite
+00025c00: 7228 5b69 6e70 7574 5d29 2c20 636f 6e66  r([input]), conf
+00025c10: 6967 2c20 2a2a 6b77 6172 6773 290a 0a20  ig, **kwargs).. 
+00025c20: 2020 2061 7379 6e63 2064 6566 205f 6174     async def _at
+00025c30: 7261 6e73 666f 726d 280a 2020 2020 2020  ransform(.      
+00025c40: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00025c50: 696e 7075 743a 2041 7379 6e63 4974 6572  input: AsyncIter
+00025c60: 6174 6f72 5b49 6e70 7574 5d2c 0a20 2020  ator[Input],.   
+00025c70: 2020 2020 2072 756e 5f6d 616e 6167 6572       run_manager
+00025c80: 3a20 4173 796e 6343 616c 6c62 6163 6b4d  : AsyncCallbackM
+00025c90: 616e 6167 6572 466f 7243 6861 696e 5275  anagerForChainRu
+00025ca0: 6e2c 0a20 2020 2020 2020 2063 6f6e 6669  n,.        confi
+00025cb0: 673a 2052 756e 6e61 626c 6543 6f6e 6669  g: RunnableConfi
+00025cc0: 672c 0a20 2020 2020 2020 202a 2a6b 7761  g,.        **kwa
+00025cd0: 7267 733a 2041 6e79 2c0a 2020 2020 2920  rgs: Any,.    ) 
+00025ce0: 2d3e 2041 7379 6e63 4974 6572 6174 6f72  -> AsyncIterator
+00025cf0: 5b4f 7574 7075 745d 3a0a 2020 2020 2020  [Output]:.      
+00025d00: 2020 6669 6e61 6c3a 2049 6e70 7574 0a20    final: Input. 
+00025d10: 2020 2020 2020 2067 6f74 5f66 6972 7374         got_first
+00025d20: 5f76 616c 203d 2046 616c 7365 0a20 2020  _val = False.   
+00025d30: 2020 2020 2061 7379 6e63 2066 6f72 2069       async for i
+00025d40: 6368 756e 6b20 696e 2069 6e70 7574 3a0a  chunk in input:.
+00025d50: 2020 2020 2020 2020 2020 2020 2320 4279              # By
+00025d60: 2064 6566 696e 6974 696f 6e73 2c20 5275   definitions, Ru
+00025d70: 6e6e 6162 6c65 4c61 6d62 6461 7320 636f  nnableLambdas co
+00025d80: 6e73 756d 6520 616c 6c20 696e 7075 7420  nsume all input 
+00025d90: 6265 666f 7265 2065 6d69 7474 696e 6720  before emitting 
+00025da0: 6f75 7470 7574 2e0a 2020 2020 2020 2020  output..        
+00025db0: 2020 2020 2320 4966 2074 6865 2069 6e70      # If the inp
+00025dc0: 7574 2069 7320 6e6f 7420 6164 6461 626c  ut is not addabl
+00025dd0: 652c 2074 6865 6e20 7765 276c 6c20 6173  e, then we'll as
+00025de0: 7375 6d65 2074 6861 7420 7765 2063 616e  sume that we can
+00025df0: 0a20 2020 2020 2020 2020 2020 2023 206f  .            # o
+00025e00: 6e6c 7920 6f70 6572 6174 6520 6f6e 2074  nly operate on t
+00025e10: 6865 206c 6173 7420 6368 756e 6b2e 0a20  he last chunk.. 
+00025e20: 2020 2020 2020 2020 2020 2023 2053 6f20             # So 
+00025e30: 7765 276c 6c20 6974 6572 6174 6520 756e  we'll iterate un
+00025e40: 7469 6c20 7765 2067 6574 2074 6f20 7468  til we get to th
+00025e50: 6520 6c61 7374 2063 6875 6e6b 210a 2020  e last chunk!.  
+00025e60: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00025e70: 2067 6f74 5f66 6972 7374 5f76 616c 3a0a   got_first_val:.
+00025e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025e90: 6669 6e61 6c20 3d20 6963 6875 6e6b 0a20  final = ichunk. 
+00025ea0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00025eb0: 6f74 5f66 6972 7374 5f76 616c 203d 2054  ot_first_val = T
+00025ec0: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+00025ed0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00025ee0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00025ef0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00025f00: 696e 616c 203d 2066 696e 616c 202b 2069  inal = final + i
+00025f10: 6368 756e 6b20 2023 2074 7970 653a 2069  chunk  # type: i
+00025f20: 676e 6f72 655b 6f70 6572 6174 6f72 5d0a  gnore[operator].
+00025f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025f40: 6578 6365 7074 2054 7970 6545 7272 6f72  except TypeError
+00025f50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00025f60: 2020 2020 2020 6669 6e61 6c20 3d20 6963        final = ic
+00025f70: 6875 6e6b 0a0a 2020 2020 2020 2020 6966  hunk..        if
+00025f80: 2068 6173 6174 7472 2873 656c 662c 2022   hasattr(self, "
+00025f90: 6166 756e 6322 293a 0a20 2020 2020 2020  afunc"):.       
+00025fa0: 2020 2020 2061 6675 6e63 203d 2073 656c       afunc = sel
+00025fb0: 662e 6166 756e 630a 2020 2020 2020 2020  f.afunc.        
+00025fc0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00025fd0: 2020 6966 2069 6e73 7065 6374 2e69 7367    if inspect.isg
+00025fe0: 656e 6572 6174 6f72 6675 6e63 7469 6f6e  eneratorfunction
+00025ff0: 2873 656c 662e 6675 6e63 293a 0a20 2020  (self.func):.   
+00026000: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00026010: 7365 2054 7970 6545 7272 6f72 280a 2020  se TypeError(.  
+00026020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026030: 2020 2243 616e 6e6f 7420 7374 7265 616d    "Cannot stream
+00026040: 2066 726f 6d20 6120 6765 6e65 7261 746f   from a generato
+00026050: 7220 6675 6e63 7469 6f6e 2061 7379 6e63  r function async
+00026060: 6872 6f6e 6f75 736c 792e 220a 2020 2020  hronously.".    
+00026070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026080: 2255 7365 202e 7374 7265 616d 2829 2069  "Use .stream() i
+00026090: 6e73 7465 6164 2e22 0a20 2020 2020 2020  nstead.".       
+000260a0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+000260b0: 2020 2020 2020 2020 6465 6620 6675 6e63          def func
+000260c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000260d0: 2020 696e 7075 743a 2049 6e70 7574 2c0a    input: Input,.
+000260e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000260f0: 7275 6e5f 6d61 6e61 6765 723a 2041 7379  run_manager: Asy
+00026100: 6e63 4361 6c6c 6261 636b 4d61 6e61 6765  ncCallbackManage
+00026110: 7246 6f72 4368 6169 6e52 756e 2c0a 2020  rForChainRun,.  
+00026120: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00026130: 6e66 6967 3a20 5275 6e6e 6162 6c65 436f  nfig: RunnableCo
+00026140: 6e66 6967 2c0a 2020 2020 2020 2020 2020  nfig,.          
+00026150: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
+00026160: 416e 792c 0a20 2020 2020 2020 2020 2020  Any,.           
+00026170: 2029 202d 3e20 4f75 7470 7574 3a0a 2020   ) -> Output:.  
+00026180: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00026190: 7475 726e 2063 616c 6c5f 6675 6e63 5f77  turn call_func_w
+000261a0: 6974 685f 7661 7269 6162 6c65 5f61 7267  ith_variable_arg
+000261b0: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
+000261c0: 2020 2020 2020 2073 656c 662e 6675 6e63         self.func
+000261d0: 2c20 696e 7075 742c 2063 6f6e 6669 672c  , input, config,
+000261e0: 2072 756e 5f6d 616e 6167 6572 2e67 6574   run_manager.get
+000261f0: 5f73 796e 6328 292c 202a 2a6b 7761 7267  _sync(), **kwarg
+00026200: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00026210: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+00026220: 2040 7772 6170 7328 6675 6e63 290a 2020   @wraps(func).  
+00026230: 2020 2020 2020 2020 2020 6173 796e 6320            async 
+00026240: 6465 6620 6628 2a61 7267 732c 202a 2a6b  def f(*args, **k
+00026250: 7761 7267 7329 3a20 2023 2074 7970 653a  wargs):  # type:
+00026260: 2069 676e 6f72 655b 6e6f 2d75 6e74 7970   ignore[no-untyp
+00026270: 6564 2d64 6566 5d0a 2020 2020 2020 2020  ed-def].        
+00026280: 2020 2020 2020 2020 7265 7475 726e 2061          return a
+00026290: 7761 6974 2072 756e 5f69 6e5f 6578 6563  wait run_in_exec
+000262a0: 7574 6f72 2863 6f6e 6669 672c 2066 756e  utor(config, fun
+000262b0: 632c 202a 6172 6773 2c20 2a2a 6b77 6172  c, *args, **kwar
+000262c0: 6773 290a 0a20 2020 2020 2020 2020 2020  gs)..           
+000262d0: 2061 6675 6e63 203d 2066 0a0a 2020 2020   afunc = f..    
+000262e0: 2020 2020 6966 2069 6e73 7065 6374 2e69      if inspect.i
+000262f0: 7361 7379 6e63 6765 6e66 756e 6374 696f  sasyncgenfunctio
+00026300: 6e28 6166 756e 6329 3a0a 2020 2020 2020  n(afunc):.      
+00026310: 2020 2020 2020 6f75 7470 7574 3a20 4f70        output: Op
+00026320: 7469 6f6e 616c 5b4f 7574 7075 745d 203d  tional[Output] =
+00026330: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+00026340: 2020 6173 796e 6320 666f 7220 6368 756e    async for chun
+00026350: 6b20 696e 2063 6173 7428 0a20 2020 2020  k in cast(.     
+00026360: 2020 2020 2020 2020 2020 2041 7379 6e63             Async
+00026370: 4974 6572 6174 6f72 5b4f 7574 7075 745d  Iterator[Output]
+00026380: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00026390: 2020 6163 616c 6c5f 6675 6e63 5f77 6974    acall_func_wit
+000263a0: 685f 7661 7269 6162 6c65 5f61 7267 7328  h_variable_args(
+000263b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000263c0: 2020 2020 2063 6173 7428 4361 6c6c 6162       cast(Callab
+000263d0: 6c65 2c20 6166 756e 6329 2c0a 2020 2020  le, afunc),.    
+000263e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000263f0: 6361 7374 2849 6e70 7574 2c20 6669 6e61  cast(Input, fina
+00026400: 6c29 2c0a 2020 2020 2020 2020 2020 2020  l),.            
+00026410: 2020 2020 2020 2020 636f 6e66 6967 2c0a          config,.
+00026420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026430: 2020 2020 7275 6e5f 6d61 6e61 6765 722c      run_manager,
+00026440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026450: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
+00026460: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00026470: 2c0a 2020 2020 2020 2020 2020 2020 293a  ,.            ):
+00026480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026490: 2079 6965 6c64 2063 6875 6e6b 0a20 2020   yield chunk.   
+000264a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000264b0: 6f75 7470 7574 2069 7320 4e6f 6e65 3a0a  output is None:.
+000264c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000264d0: 2020 2020 6f75 7470 7574 203d 2063 6875      output = chu
+000264e0: 6e6b 0a20 2020 2020 2020 2020 2020 2020  nk.             
+000264f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00026500: 2020 2020 2020 2020 2020 2020 2074 7279               try
+00026510: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00026520: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+00026530: 203d 206f 7574 7075 7420 2b20 6368 756e   = output + chun
+00026540: 6b20 2023 2074 7970 653a 2069 676e 6f72  k  # type: ignor
+00026550: 655b 6f70 6572 6174 6f72 5d0a 2020 2020  e[operator].    
+00026560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026570: 6578 6365 7074 2054 7970 6545 7272 6f72  except TypeError
+00026580: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00026590: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+000265a0: 203d 2063 6875 6e6b 0a20 2020 2020 2020   = chunk.       
+000265b0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000265c0: 2020 206f 7574 7075 7420 3d20 6177 6169     output = awai
+000265d0: 7420 6163 616c 6c5f 6675 6e63 5f77 6974  t acall_func_wit
+000265e0: 685f 7661 7269 6162 6c65 5f61 7267 7328  h_variable_args(
+000265f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026600: 2063 6173 7428 4361 6c6c 6162 6c65 2c20   cast(Callable, 
+00026610: 6166 756e 6329 2c20 6361 7374 2849 6e70  afunc), cast(Inp
+00026620: 7574 2c20 6669 6e61 6c29 2c20 636f 6e66  ut, final), conf
+00026630: 6967 2c20 7275 6e5f 6d61 6e61 6765 722c  ig, run_manager,
+00026640: 202a 2a6b 7761 7267 730a 2020 2020 2020   **kwargs.      
+00026650: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00026660: 2023 2049 6620 7468 6520 6f75 7470 7574   # If the output
+00026670: 2069 7320 6120 7275 6e6e 6162 6c65 2c20   is a runnable, 
+00026680: 7573 6520 6974 7320 6173 7472 6561 6d20  use its astream 
+00026690: 6f75 7470 7574 0a20 2020 2020 2020 2069  output.        i
+000266a0: 6620 6973 696e 7374 616e 6365 286f 7574  f isinstance(out
+000266b0: 7075 742c 2052 756e 6e61 626c 6529 3a0a  put, Runnable):.
+000266c0: 2020 2020 2020 2020 2020 2020 7265 6375              recu
+000266d0: 7273 696f 6e5f 6c69 6d69 7420 3d20 636f  rsion_limit = co
+000266e0: 6e66 6967 5b22 7265 6375 7273 696f 6e5f  nfig["recursion_
+000266f0: 6c69 6d69 7422 5d0a 2020 2020 2020 2020  limit"].        
+00026700: 2020 2020 6966 2072 6563 7572 7369 6f6e      if recursion
+00026710: 5f6c 696d 6974 203c 3d20 303a 0a20 2020  _limit <= 0:.   
+00026720: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00026730: 7365 2052 6563 7572 7369 6f6e 4572 726f  se RecursionErro
+00026740: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00026750: 2020 2020 2020 2066 2252 6563 7572 7369         f"Recursi
+00026760: 6f6e 206c 696d 6974 2072 6561 6368 6564  on limit reached
+00026770: 2077 6865 6e20 696e 766f 6b69 6e67 2022   when invoking "
+00026780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026790: 2020 2020 2066 227b 7365 6c66 7d20 7769       f"{self} wi
+000267a0: 7468 2069 6e70 7574 207b 6669 6e61 6c7d  th input {final}
+000267b0: 2e22 0a20 2020 2020 2020 2020 2020 2020  .".             
+000267c0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+000267d0: 2061 7379 6e63 2066 6f72 2063 6875 6e6b   async for chunk
+000267e0: 2069 6e20 6f75 7470 7574 2e61 7374 7265   in output.astre
+000267f0: 616d 280a 2020 2020 2020 2020 2020 2020  am(.            
+00026800: 2020 2020 6669 6e61 6c2c 0a20 2020 2020      final,.     
+00026810: 2020 2020 2020 2020 2020 2070 6174 6368             patch
+00026820: 5f63 6f6e 6669 6728 0a20 2020 2020 2020  _config(.       
+00026830: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00026840: 6669 672c 0a20 2020 2020 2020 2020 2020  fig,.           
+00026850: 2020 2020 2020 2020 2063 616c 6c62 6163           callbac
+00026860: 6b73 3d72 756e 5f6d 616e 6167 6572 2e67  ks=run_manager.g
+00026870: 6574 5f63 6869 6c64 2829 2c0a 2020 2020  et_child(),.    
+00026880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026890: 7265 6375 7273 696f 6e5f 6c69 6d69 743d  recursion_limit=
+000268a0: 7265 6375 7273 696f 6e5f 6c69 6d69 7420  recursion_limit 
+000268b0: 2d20 312c 0a20 2020 2020 2020 2020 2020  - 1,.           
+000268c0: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+000268d0: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+000268e0: 2020 2020 2020 2079 6965 6c64 2063 6875         yield chu
+000268f0: 6e6b 0a20 2020 2020 2020 2065 6c69 6620  nk.        elif 
+00026900: 6e6f 7420 696e 7370 6563 742e 6973 6173  not inspect.isas
+00026910: 796e 6367 656e 6675 6e63 7469 6f6e 2861  yncgenfunction(a
+00026920: 6675 6e63 293a 0a20 2020 2020 2020 2020  func):.         
+00026930: 2020 2023 204f 7468 6572 7769 7365 2c20     # Otherwise, 
+00026940: 6a75 7374 2079 6965 6c64 2069 740a 2020  just yield it.  
+00026950: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
+00026960: 6361 7374 284f 7574 7075 742c 206f 7574  cast(Output, out
+00026970: 7075 7429 0a0a 2020 2020 6173 796e 6320  put)..    async 
+00026980: 6465 6620 6174 7261 6e73 666f 726d 280a  def atransform(.
+00026990: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+000269a0: 2020 2020 2020 696e 7075 743a 2041 7379        input: Asy
+000269b0: 6e63 4974 6572 6174 6f72 5b49 6e70 7574  ncIterator[Input
+000269c0: 5d2c 0a20 2020 2020 2020 2063 6f6e 6669  ],.        confi
+000269d0: 673a 204f 7074 696f 6e61 6c5b 5275 6e6e  g: Optional[Runn
+000269e0: 6162 6c65 436f 6e66 6967 5d20 3d20 4e6f  ableConfig] = No
+000269f0: 6e65 2c0a 2020 2020 2020 2020 2a2a 6b77  ne,.        **kw
+00026a00: 6172 6773 3a20 4f70 7469 6f6e 616c 5b41  args: Optional[A
+00026a10: 6e79 5d2c 0a20 2020 2029 202d 3e20 4173  ny],.    ) -> As
+00026a20: 796e 6349 7465 7261 746f 725b 4f75 7470  yncIterator[Outp
+00026a30: 7574 5d3a 0a20 2020 2020 2020 2061 7379  ut]:.        asy
+00026a40: 6e63 2066 6f72 206f 7574 7075 7420 696e  nc for output in
+00026a50: 2073 656c 662e 5f61 7472 616e 7366 6f72   self._atransfor
+00026a60: 6d5f 7374 7265 616d 5f77 6974 685f 636f  m_stream_with_co
+00026a70: 6e66 6967 280a 2020 2020 2020 2020 2020  nfig(.          
+00026a80: 2020 696e 7075 742c 0a20 2020 2020 2020    input,.       
+00026a90: 2020 2020 2073 656c 662e 5f61 7472 616e       self._atran
+00026aa0: 7366 6f72 6d2c 0a20 2020 2020 2020 2020  sform,.         
+00026ab0: 2020 2073 656c 662e 5f63 6f6e 6669 6728     self._config(
+00026ac0: 636f 6e66 6967 2c20 7365 6c66 2e61 6675  config, self.afu
+00026ad0: 6e63 2069 6620 6861 7361 7474 7228 7365  nc if hasattr(se
+00026ae0: 6c66 2c20 2261 6675 6e63 2229 2065 6c73  lf, "afunc") els
+00026af0: 6520 7365 6c66 2e66 756e 6329 2c0a 2020  e self.func),.  
+00026b00: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
+00026b10: 6773 2c0a 2020 2020 2020 2020 293a 0a20  gs,.        ):. 
+00026b20: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
+00026b30: 206f 7574 7075 740a 0a20 2020 2061 7379   output..    asy
+00026b40: 6e63 2064 6566 2061 7374 7265 616d 280a  nc def astream(.
+00026b50: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00026b60: 2020 2020 2020 696e 7075 743a 2049 6e70        input: Inp
+00026b70: 7574 2c0a 2020 2020 2020 2020 636f 6e66  ut,.        conf
+00026b80: 6967 3a20 4f70 7469 6f6e 616c 5b52 756e  ig: Optional[Run
+00026b90: 6e61 626c 6543 6f6e 6669 675d 203d 204e  nableConfig] = N
+00026ba0: 6f6e 652c 0a20 2020 2020 2020 202a 2a6b  one,.        **k
+00026bb0: 7761 7267 733a 204f 7074 696f 6e61 6c5b  wargs: Optional[
+00026bc0: 416e 795d 2c0a 2020 2020 2920 2d3e 2041  Any],.    ) -> A
+00026bd0: 7379 6e63 4974 6572 6174 6f72 5b4f 7574  syncIterator[Out
+00026be0: 7075 745d 3a0a 2020 2020 2020 2020 6173  put]:.        as
+00026bf0: 796e 6320 6465 6620 696e 7075 745f 6169  ync def input_ai
+00026c00: 7465 7228 2920 2d3e 2041 7379 6e63 4974  ter() -> AsyncIt
+00026c10: 6572 6174 6f72 5b49 6e70 7574 5d3a 0a20  erator[Input]:. 
+00026c20: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
+00026c30: 2069 6e70 7574 0a0a 2020 2020 2020 2020   input..        
+00026c40: 6173 796e 6320 666f 7220 6368 756e 6b20  async for chunk 
+00026c50: 696e 2073 656c 662e 6174 7261 6e73 666f  in self.atransfo
+00026c60: 726d 2869 6e70 7574 5f61 6974 6572 2829  rm(input_aiter()
+00026c70: 2c20 636f 6e66 6967 2c20 2a2a 6b77 6172  , config, **kwar
+00026c80: 6773 293a 0a20 2020 2020 2020 2020 2020  gs):.           
+00026c90: 2079 6965 6c64 2063 6875 6e6b 0a0a 0a63   yield chunk...c
+00026ca0: 6c61 7373 2052 756e 6e61 626c 6545 6163  lass RunnableEac
+00026cb0: 6842 6173 6528 5275 6e6e 6162 6c65 5365  hBase(RunnableSe
+00026cc0: 7269 616c 697a 6162 6c65 5b4c 6973 745b  rializable[List[
+00026cd0: 496e 7075 745d 2c20 4c69 7374 5b4f 7574  Input], List[Out
+00026ce0: 7075 745d 5d29 3a0a 2020 2020 2222 2252  put]]):.    """R
+00026cf0: 756e 6e61 626c 6520 7468 6174 2064 656c  unnable that del
+00026d00: 6567 6174 6573 2063 616c 6c73 2074 6f20  egates calls to 
+00026d10: 616e 6f74 6865 7220 5275 6e6e 6162 6c65  another Runnable
+00026d20: 0a20 2020 2077 6974 6820 6561 6368 2065  .    with each e
+00026d30: 6c65 6d65 6e74 206f 6620 7468 6520 696e  lement of the in
+00026d40: 7075 7420 7365 7175 656e 6365 2e0a 0a20  put sequence... 
+00026d50: 2020 2055 7365 206f 6e6c 7920 6966 2063     Use only if c
+00026d60: 7265 6174 696e 6720 6120 6e65 7720 5275  reating a new Ru
+00026d70: 6e6e 6162 6c65 4561 6368 2073 7562 636c  nnableEach subcl
+00026d80: 6173 7320 7769 7468 2064 6966 6665 7265  ass with differe
+00026d90: 6e74 205f 5f69 6e69 745f 5f20 6172 6773  nt __init__ args
+00026da0: 2e0a 0a20 2020 2053 6565 2064 6f63 756d  ...    See docum
+00026db0: 656e 7461 7469 6f6e 2066 6f72 2052 756e  entation for Run
+00026dc0: 6e61 626c 6545 6163 6820 666f 7220 6d6f  nableEach for mo
+00026dd0: 7265 2064 6574 6169 6c73 2e0a 2020 2020  re details..    
+00026de0: 2222 220a 0a20 2020 2062 6f75 6e64 3a20  """..    bound: 
+00026df0: 5275 6e6e 6162 6c65 5b49 6e70 7574 2c20  Runnable[Input, 
+00026e00: 4f75 7470 7574 5d0a 0a20 2020 2063 6c61  Output]..    cla
+00026e10: 7373 2043 6f6e 6669 673a 0a20 2020 2020  ss Config:.     
+00026e20: 2020 2061 7262 6974 7261 7279 5f74 7970     arbitrary_typ
+00026e30: 6573 5f61 6c6c 6f77 6564 203d 2054 7275  es_allowed = Tru
+00026e40: 650a 0a20 2020 2040 7072 6f70 6572 7479  e..    @property
+00026e50: 0a20 2020 2064 6566 2049 6e70 7574 5479  .    def InputTy
+00026e60: 7065 2873 656c 6629 202d 3e20 416e 793a  pe(self) -> Any:
+00026e70: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00026e80: 4c69 7374 5b73 656c 662e 626f 756e 642e  List[self.bound.
+00026e90: 496e 7075 7454 7970 655d 2020 2320 7479  InputType]  # ty
+00026ea0: 7065 3a20 6967 6e6f 7265 5b6e 616d 652d  pe: ignore[name-
+00026eb0: 6465 6669 6e65 645d 0a0a 2020 2020 6465  defined]..    de
+00026ec0: 6620 6765 745f 696e 7075 745f 7363 6865  f get_input_sche
+00026ed0: 6d61 280a 2020 2020 2020 2020 7365 6c66  ma(.        self
+00026ee0: 2c20 636f 6e66 6967 3a20 4f70 7469 6f6e  , config: Option
+00026ef0: 616c 5b52 756e 6e61 626c 6543 6f6e 6669  al[RunnableConfi
+00026f00: 675d 203d 204e 6f6e 650a 2020 2020 2920  g] = None.    ) 
+00026f10: 2d3e 2054 7970 655b 4261 7365 4d6f 6465  -> Type[BaseMode
+00026f20: 6c5d 3a0a 2020 2020 2020 2020 7265 7475  l]:.        retu
+00026f30: 726e 2063 7265 6174 655f 6d6f 6465 6c28  rn create_model(
+00026f40: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00026f50: 662e 6765 745f 6e61 6d65 2822 496e 7075  f.get_name("Inpu
+00026f60: 7422 292c 0a20 2020 2020 2020 2020 2020  t"),.           
+00026f70: 205f 5f72 6f6f 745f 5f3d 280a 2020 2020   __root__=(.    
+00026f80: 2020 2020 2020 2020 2020 2020 4c69 7374              List
+00026f90: 5b73 656c 662e 626f 756e 642e 6765 745f  [self.bound.get_
+00026fa0: 696e 7075 745f 7363 6865 6d61 2863 6f6e  input_schema(con
+00026fb0: 6669 6729 5d2c 2020 2320 7479 7065 3a20  fig)],  # type: 
+00026fc0: 6967 6e6f 7265 0a20 2020 2020 2020 2020  ignore.         
+00026fd0: 2020 2020 2020 204e 6f6e 652c 0a20 2020         None,.   
+00026fe0: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+00026ff0: 2020 2020 290a 0a20 2020 2040 7072 6f70      )..    @prop
+00027000: 6572 7479 0a20 2020 2064 6566 204f 7574  erty.    def Out
+00027010: 7075 7454 7970 6528 7365 6c66 2920 2d3e  putType(self) ->
+00027020: 2054 7970 655b 4c69 7374 5b4f 7574 7075   Type[List[Outpu
+00027030: 745d 5d3a 0a20 2020 2020 2020 2072 6574  t]]:.        ret
+00027040: 7572 6e20 4c69 7374 5b73 656c 662e 626f  urn List[self.bo
+00027050: 756e 642e 4f75 7470 7574 5479 7065 5d20  und.OutputType] 
+00027060: 2023 2074 7970 653a 2069 676e 6f72 655b   # type: ignore[
+00027070: 6e61 6d65 2d64 6566 696e 6564 5d0a 0a20  name-defined].. 
+00027080: 2020 2064 6566 2067 6574 5f6f 7574 7075     def get_outpu
+00027090: 745f 7363 6865 6d61 280a 2020 2020 2020  t_schema(.      
+000270a0: 2020 7365 6c66 2c20 636f 6e66 6967 3a20    self, config: 
+000270b0: 4f70 7469 6f6e 616c 5b52 756e 6e61 626c  Optional[Runnabl
+000270c0: 6543 6f6e 6669 675d 203d 204e 6f6e 650a  eConfig] = None.
+000270d0: 2020 2020 2920 2d3e 2054 7970 655b 4261      ) -> Type[Ba
+000270e0: 7365 4d6f 6465 6c5d 3a0a 2020 2020 2020  seModel]:.      
+000270f0: 2020 7363 6865 6d61 203d 2073 656c 662e    schema = self.
+00027100: 626f 756e 642e 6765 745f 6f75 7470 7574  bound.get_output
+00027110: 5f73 6368 656d 6128 636f 6e66 6967 290a  _schema(config).
+00027120: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+00027130: 7265 6174 655f 6d6f 6465 6c28 0a20 2020  reate_model(.   
+00027140: 2020 2020 2020 2020 2073 656c 662e 6765           self.ge
+00027150: 745f 6e61 6d65 2822 4f75 7470 7574 2229  t_name("Output")
+00027160: 2c0a 2020 2020 2020 2020 2020 2020 5f5f  ,.            __
+00027170: 726f 6f74 5f5f 3d28 0a20 2020 2020 2020  root__=(.       
+00027180: 2020 2020 2020 2020 204c 6973 745b 7363           List[sc
+00027190: 6865 6d61 5d2c 2020 2320 7479 7065 3a20  hema],  # type: 
+000271a0: 6967 6e6f 7265 0a20 2020 2020 2020 2020  ignore.         
+000271b0: 2020 2020 2020 204e 6f6e 652c 0a20 2020         None,.   
+000271c0: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+000271d0: 2020 2020 290a 0a20 2020 2040 7072 6f70      )..    @prop
+000271e0: 6572 7479 0a20 2020 2064 6566 2063 6f6e  erty.    def con
+000271f0: 6669 675f 7370 6563 7328 7365 6c66 2920  fig_specs(self) 
+00027200: 2d3e 204c 6973 745b 436f 6e66 6967 7572  -> List[Configur
+00027210: 6162 6c65 4669 656c 6453 7065 635d 3a0a  ableFieldSpec]:.
+00027220: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00027230: 656c 662e 626f 756e 642e 636f 6e66 6967  elf.bound.config
+00027240: 5f73 7065 6373 0a0a 2020 2020 6465 6620  _specs..    def 
+00027250: 6765 745f 6772 6170 6828 7365 6c66 2c20  get_graph(self, 
+00027260: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
+00027270: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+00027280: 203d 204e 6f6e 6529 202d 3e20 4772 6170   = None) -> Grap
+00027290: 683a 0a20 2020 2020 2020 2072 6574 7572  h:.        retur
+000272a0: 6e20 7365 6c66 2e62 6f75 6e64 2e67 6574  n self.bound.get
+000272b0: 5f67 7261 7068 2863 6f6e 6669 6729 0a0a  _graph(config)..
+000272c0: 2020 2020 4063 6c61 7373 6d65 7468 6f64      @classmethod
+000272d0: 0a20 2020 2064 6566 2069 735f 6c63 5f73  .    def is_lc_s
+000272e0: 6572 6961 6c69 7a61 626c 6528 636c 7329  erializable(cls)
+000272f0: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
+00027300: 2020 7265 7475 726e 2054 7275 650a 0a20    return True.. 
+00027310: 2020 2040 636c 6173 736d 6574 686f 640a     @classmethod.
+00027320: 2020 2020 6465 6620 6765 745f 6c63 5f6e      def get_lc_n
+00027330: 616d 6573 7061 6365 2863 6c73 2920 2d3e  amespace(cls) ->
+00027340: 204c 6973 745b 7374 725d 3a0a 2020 2020   List[str]:.    
+00027350: 2020 2020 2222 2247 6574 2074 6865 206e      """Get the n
+00027360: 616d 6573 7061 6365 206f 6620 7468 6520  amespace of the 
+00027370: 6c61 6e67 6368 6169 6e20 6f62 6a65 6374  langchain object
+00027380: 2e22 2222 0a20 2020 2020 2020 2072 6574  .""".        ret
+00027390: 7572 6e20 5b22 6c61 6e67 6368 6169 6e22  urn ["langchain"
+000273a0: 2c20 2273 6368 656d 6122 2c20 2272 756e  , "schema", "run
+000273b0: 6e61 626c 6522 5d0a 0a20 2020 2064 6566  nable"]..    def
+000273c0: 205f 696e 766f 6b65 280a 2020 2020 2020   _invoke(.      
+000273d0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+000273e0: 696e 7075 7473 3a20 4c69 7374 5b49 6e70  inputs: List[Inp
+000273f0: 7574 5d2c 0a20 2020 2020 2020 2072 756e  ut],.        run
+00027400: 5f6d 616e 6167 6572 3a20 4361 6c6c 6261  _manager: Callba
+00027410: 636b 4d61 6e61 6765 7246 6f72 4368 6169  ckManagerForChai
+00027420: 6e52 756e 2c0a 2020 2020 2020 2020 636f  nRun,.        co
+00027430: 6e66 6967 3a20 5275 6e6e 6162 6c65 436f  nfig: RunnableCo
+00027440: 6e66 6967 2c0a 2020 2020 2020 2020 2a2a  nfig,.        **
+00027450: 6b77 6172 6773 3a20 416e 792c 0a20 2020  kwargs: Any,.   
+00027460: 2029 202d 3e20 4c69 7374 5b4f 7574 7075   ) -> List[Outpu
+00027470: 745d 3a0a 2020 2020 2020 2020 636f 6e66  t]:.        conf
+00027480: 6967 7320 3d20 5b0a 2020 2020 2020 2020  igs = [.        
+00027490: 2020 2020 7061 7463 685f 636f 6e66 6967      patch_config
+000274a0: 2863 6f6e 6669 672c 2063 616c 6c62 6163  (config, callbac
+000274b0: 6b73 3d72 756e 5f6d 616e 6167 6572 2e67  ks=run_manager.g
+000274c0: 6574 5f63 6869 6c64 2829 2920 666f 7220  et_child()) for 
+000274d0: 5f20 696e 2069 6e70 7574 730a 2020 2020  _ in inputs.    
+000274e0: 2020 2020 5d0a 2020 2020 2020 2020 7265      ].        re
+000274f0: 7475 726e 2073 656c 662e 626f 756e 642e  turn self.bound.
+00027500: 6261 7463 6828 696e 7075 7473 2c20 636f  batch(inputs, co
+00027510: 6e66 6967 732c 202a 2a6b 7761 7267 7329  nfigs, **kwargs)
+00027520: 0a0a 2020 2020 6465 6620 696e 766f 6b65  ..    def invoke
+00027530: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+00027540: 696e 7075 743a 204c 6973 745b 496e 7075  input: List[Inpu
+00027550: 745d 2c20 636f 6e66 6967 3a20 4f70 7469  t], config: Opti
+00027560: 6f6e 616c 5b52 756e 6e61 626c 6543 6f6e  onal[RunnableCon
+00027570: 6669 675d 203d 204e 6f6e 652c 202a 2a6b  fig] = None, **k
+00027580: 7761 7267 733a 2041 6e79 0a20 2020 2029  wargs: Any.    )
+00027590: 202d 3e20 4c69 7374 5b4f 7574 7075 745d   -> List[Output]
+000275a0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+000275b0: 2073 656c 662e 5f63 616c 6c5f 7769 7468   self._call_with
+000275c0: 5f63 6f6e 6669 6728 7365 6c66 2e5f 696e  _config(self._in
+000275d0: 766f 6b65 2c20 696e 7075 742c 2063 6f6e  voke, input, con
+000275e0: 6669 672c 202a 2a6b 7761 7267 7329 0a0a  fig, **kwargs)..
+000275f0: 2020 2020 6173 796e 6320 6465 6620 5f61      async def _a
+00027600: 696e 766f 6b65 280a 2020 2020 2020 2020  invoke(.        
+00027610: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
+00027620: 7075 7473 3a20 4c69 7374 5b49 6e70 7574  puts: List[Input
+00027630: 5d2c 0a20 2020 2020 2020 2072 756e 5f6d  ],.        run_m
+00027640: 616e 6167 6572 3a20 4173 796e 6343 616c  anager: AsyncCal
+00027650: 6c62 6163 6b4d 616e 6167 6572 466f 7243  lbackManagerForC
+00027660: 6861 696e 5275 6e2c 0a20 2020 2020 2020  hainRun,.       
+00027670: 2063 6f6e 6669 673a 2052 756e 6e61 626c   config: Runnabl
+00027680: 6543 6f6e 6669 672c 0a20 2020 2020 2020  eConfig,.       
+00027690: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
+000276a0: 2020 2020 2920 2d3e 204c 6973 745b 4f75      ) -> List[Ou
+000276b0: 7470 7574 5d3a 0a20 2020 2020 2020 2063  tput]:.        c
+000276c0: 6f6e 6669 6773 203d 205b 0a20 2020 2020  onfigs = [.     
+000276d0: 2020 2020 2020 2070 6174 6368 5f63 6f6e         patch_con
+000276e0: 6669 6728 636f 6e66 6967 2c20 6361 6c6c  fig(config, call
+000276f0: 6261 636b 733d 7275 6e5f 6d61 6e61 6765  backs=run_manage
+00027700: 722e 6765 745f 6368 696c 6428 2929 2066  r.get_child()) f
+00027710: 6f72 205f 2069 6e20 696e 7075 7473 0a20  or _ in inputs. 
+00027720: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+00027730: 2072 6574 7572 6e20 6177 6169 7420 7365   return await se
+00027740: 6c66 2e62 6f75 6e64 2e61 6261 7463 6828  lf.bound.abatch(
+00027750: 696e 7075 7473 2c20 636f 6e66 6967 732c  inputs, configs,
+00027760: 202a 2a6b 7761 7267 7329 0a0a 2020 2020   **kwargs)..    
+00027770: 6173 796e 6320 6465 6620 6169 6e76 6f6b  async def ainvok
+00027780: 6528 0a20 2020 2020 2020 2073 656c 662c  e(.        self,
+00027790: 2069 6e70 7574 3a20 4c69 7374 5b49 6e70   input: List[Inp
+000277a0: 7574 5d2c 2063 6f6e 6669 673a 204f 7074  ut], config: Opt
+000277b0: 696f 6e61 6c5b 5275 6e6e 6162 6c65 436f  ional[RunnableCo
+000277c0: 6e66 6967 5d20 3d20 4e6f 6e65 2c20 2a2a  nfig] = None, **
+000277d0: 6b77 6172 6773 3a20 416e 790a 2020 2020  kwargs: Any.    
+000277e0: 2920 2d3e 204c 6973 745b 4f75 7470 7574  ) -> List[Output
+000277f0: 5d3a 0a20 2020 2020 2020 2072 6574 7572  ]:.        retur
+00027800: 6e20 6177 6169 7420 7365 6c66 2e5f 6163  n await self._ac
+00027810: 616c 6c5f 7769 7468 5f63 6f6e 6669 6728  all_with_config(
+00027820: 7365 6c66 2e5f 6169 6e76 6f6b 652c 2069  self._ainvoke, i
+00027830: 6e70 7574 2c20 636f 6e66 6967 2c20 2a2a  nput, config, **
+00027840: 6b77 6172 6773 290a 0a20 2020 2061 7379  kwargs)..    asy
+00027850: 6e63 2064 6566 2061 7374 7265 616d 5f65  nc def astream_e
+00027860: 7665 6e74 7328 0a20 2020 2020 2020 2073  vents(.        s
+00027870: 656c 662c 0a20 2020 2020 2020 2069 6e70  elf,.        inp
+00027880: 7574 3a20 496e 7075 742c 0a20 2020 2020  ut: Input,.     
+00027890: 2020 2063 6f6e 6669 673a 204f 7074 696f     config: Optio
+000278a0: 6e61 6c5b 5275 6e6e 6162 6c65 436f 6e66  nal[RunnableConf
+000278b0: 6967 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ig] = None,.    
+000278c0: 2020 2020 2a2a 6b77 6172 6773 3a20 4f70      **kwargs: Op
+000278d0: 7469 6f6e 616c 5b41 6e79 5d2c 0a20 2020  tional[Any],.   
+000278e0: 2029 202d 3e20 4173 796e 6349 7465 7261   ) -> AsyncItera
+000278f0: 746f 725b 5374 7265 616d 4576 656e 745d  tor[StreamEvent]
+00027900: 3a0a 2020 2020 2020 2020 666f 7220 5f20  :.        for _ 
+00027910: 696e 2072 616e 6765 2831 293a 0a20 2020  in range(1):.   
+00027920: 2020 2020 2020 2020 2072 6169 7365 204e           raise N
+00027930: 6f74 496d 706c 656d 656e 7465 6445 7272  otImplementedErr
+00027940: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00027950: 2020 2020 2252 756e 6e61 626c 6545 6163      "RunnableEac
+00027960: 6820 646f 6573 206e 6f74 2073 7570 706f  h does not suppo
+00027970: 7274 2061 7374 7265 616d 5f65 7665 6e74  rt astream_event
+00027980: 7320 7965 742e 220a 2020 2020 2020 2020  s yet.".        
+00027990: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+000279a0: 2020 7969 656c 640a 0a0a 636c 6173 7320    yield...class 
+000279b0: 5275 6e6e 6162 6c65 4561 6368 2852 756e  RunnableEach(Run
+000279c0: 6e61 626c 6545 6163 6842 6173 655b 496e  nableEachBase[In
+000279d0: 7075 742c 204f 7574 7075 745d 293a 0a20  put, Output]):. 
+000279e0: 2020 2022 2222 5275 6e6e 6162 6c65 2074     """Runnable t
+000279f0: 6861 7420 6465 6c65 6761 7465 7320 6361  hat delegates ca
+00027a00: 6c6c 7320 746f 2061 6e6f 7468 6572 2052  lls to another R
+00027a10: 756e 6e61 626c 650a 2020 2020 7769 7468  unnable.    with
+00027a20: 2065 6163 6820 656c 656d 656e 7420 6f66   each element of
+00027a30: 2074 6865 2069 6e70 7574 2073 6571 7565   the input seque
+00027a40: 6e63 652e 0a0a 2020 2020 4974 2061 6c6c  nce...    It all
+00027a50: 6f77 7320 796f 7520 746f 2063 616c 6c20  ows you to call 
+00027a60: 6d75 6c74 6970 6c65 2069 6e70 7574 7320  multiple inputs 
+00027a70: 7769 7468 2074 6865 2062 6f75 6e64 6564  with the bounded
+00027a80: 2052 756e 6e61 626c 652e 0a0a 2020 2020   Runnable...    
+00027a90: 5275 6e6e 6162 6c65 4561 6368 206d 616b  RunnableEach mak
+00027aa0: 6573 2069 7420 6561 7379 2074 6f20 7275  es it easy to ru
+00027ab0: 6e20 6d75 6c74 6970 6c65 2069 6e70 7574  n multiple input
+00027ac0: 7320 666f 7220 7468 6520 7275 6e6e 6162  s for the runnab
+00027ad0: 6c65 2e0a 2020 2020 496e 2074 6865 2062  le..    In the b
+00027ae0: 656c 6f77 2065 7861 6d70 6c65 2c20 7765  elow example, we
+00027af0: 2061 7373 6f63 6961 7465 2061 6e64 2072   associate and r
+00027b00: 756e 2074 6872 6565 2069 6e70 7574 730a  un three inputs.
+00027b10: 2020 2020 7769 7468 2061 2052 756e 6e61      with a Runna
+00027b20: 626c 653a 0a0a 2020 2020 2020 2020 2e2e  ble:..        ..
+00027b30: 2063 6f64 652d 626c 6f63 6b3a 3a20 7079   code-block:: py
+00027b40: 7468 6f6e 0a0a 2020 2020 2020 2020 2020  thon..          
+00027b50: 2020 6672 6f6d 206c 616e 6763 6861 696e    from langchain
+00027b60: 5f63 6f72 652e 7275 6e6e 6162 6c65 732e  _core.runnables.
+00027b70: 6261 7365 2069 6d70 6f72 7420 5275 6e6e  base import Runn
+00027b80: 6162 6c65 4561 6368 0a20 2020 2020 2020  ableEach.       
+00027b90: 2020 2020 2066 726f 6d20 6c61 6e67 6368       from langch
+00027ba0: 6169 6e5f 6f70 656e 6169 2069 6d70 6f72  ain_openai impor
+00027bb0: 7420 4368 6174 4f70 656e 4149 0a20 2020  t ChatOpenAI.   
+00027bc0: 2020 2020 2020 2020 2066 726f 6d20 6c61           from la
+00027bd0: 6e67 6368 6169 6e5f 636f 7265 2e70 726f  ngchain_core.pro
+00027be0: 6d70 7473 2069 6d70 6f72 7420 4368 6174  mpts import Chat
+00027bf0: 5072 6f6d 7074 5465 6d70 6c61 7465 0a20  PromptTemplate. 
+00027c00: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
+00027c10: 6c61 6e67 6368 6169 6e5f 636f 7265 2e6f  langchain_core.o
+00027c20: 7574 7075 745f 7061 7273 6572 7320 696d  utput_parsers im
+00027c30: 706f 7274 2053 7472 4f75 7470 7574 5061  port StrOutputPa
+00027c40: 7273 6572 0a20 2020 2020 2020 2020 2020  rser.           
+00027c50: 2070 726f 6d70 7420 3d20 4368 6174 5072   prompt = ChatPr
+00027c60: 6f6d 7074 5465 6d70 6c61 7465 2e66 726f  omptTemplate.fro
+00027c70: 6d5f 7465 6d70 6c61 7465 2822 5465 6c6c  m_template("Tell
+00027c80: 206d 6520 6120 7368 6f72 7420 6a6f 6b65   me a short joke
+00027c90: 2061 626f 7574 0a20 2020 2020 2020 2020   about.         
+00027ca0: 2020 207b 746f 7069 637d 2229 0a20 2020     {topic}").   
+00027cb0: 2020 2020 2020 2020 206d 6f64 656c 203d           model =
+00027cc0: 2043 6861 744f 7065 6e41 4928 290a 2020   ChatOpenAI().  
+00027cd0: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+00027ce0: 5f70 6172 7365 7220 3d20 5374 724f 7574  _parser = StrOut
+00027cf0: 7075 7450 6172 7365 7228 290a 2020 2020  putParser().    
+00027d00: 2020 2020 2020 2020 7275 6e6e 6162 6c65          runnable
+00027d10: 203d 2070 726f 6d70 7420 7c20 6d6f 6465   = prompt | mode
+00027d20: 6c20 7c20 6f75 7470 7574 5f70 6172 7365  l | output_parse
+00027d30: 720a 2020 2020 2020 2020 2020 2020 7275  r.            ru
+00027d40: 6e6e 6162 6c65 5f65 6163 6820 3d20 5275  nnable_each = Ru
+00027d50: 6e6e 6162 6c65 4561 6368 2862 6f75 6e64  nnableEach(bound
+00027d60: 3d72 756e 6e61 626c 6529 0a20 2020 2020  =runnable).     
+00027d70: 2020 2020 2020 206f 7574 7075 7420 3d20         output = 
+00027d80: 7275 6e6e 6162 6c65 5f65 6163 682e 696e  runnable_each.in
+00027d90: 766f 6b65 285b 7b27 746f 7069 6327 3a27  voke([{'topic':'
+00027da0: 436f 6d70 7574 6572 2053 6369 656e 6365  Computer Science
+00027db0: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
+00027dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027dd0: 2020 2020 2020 2020 2020 2020 7b27 746f              {'to
+00027de0: 7069 6327 3a27 4172 7427 7d2c 0a20 2020  pic':'Art'},.   
+00027df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027e10: 2020 2020 207b 2774 6f70 6963 273a 2742       {'topic':'B
+00027e20: 696f 6c6f 6779 277d 5d29 0a20 2020 2020  iology'}]).     
+00027e30: 2020 2020 2020 2070 7269 6e74 286f 7574         print(out
+00027e40: 7075 7429 2020 2320 6e6f 7161 3a20 5432  put)  # noqa: T2
+00027e50: 3031 0a20 2020 2022 2222 0a0a 2020 2020  01.    """..    
+00027e60: 4063 6c61 7373 6d65 7468 6f64 0a20 2020  @classmethod.   
+00027e70: 2064 6566 2067 6574 5f6c 635f 6e61 6d65   def get_lc_name
+00027e80: 7370 6163 6528 636c 7329 202d 3e20 4c69  space(cls) -> Li
+00027e90: 7374 5b73 7472 5d3a 0a20 2020 2020 2020  st[str]:.       
+00027ea0: 2022 2222 4765 7420 7468 6520 6e61 6d65   """Get the name
+00027eb0: 7370 6163 6520 6f66 2074 6865 206c 616e  space of the lan
+00027ec0: 6763 6861 696e 206f 626a 6563 742e 2222  gchain object.""
+00027ed0: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
+00027ee0: 205b 226c 616e 6763 6861 696e 222c 2022   ["langchain", "
+00027ef0: 7363 6865 6d61 222c 2022 7275 6e6e 6162  schema", "runnab
+00027f00: 6c65 225d 0a0a 2020 2020 6465 6620 6765  le"]..    def ge
+00027f10: 745f 6e61 6d65 280a 2020 2020 2020 2020  t_name(.        
+00027f20: 7365 6c66 2c20 7375 6666 6978 3a20 4f70  self, suffix: Op
+00027f30: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+00027f40: 6e65 2c20 2a2c 206e 616d 653a 204f 7074  ne, *, name: Opt
+00027f50: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
+00027f60: 650a 2020 2020 2920 2d3e 2073 7472 3a0a  e.    ) -> str:.
+00027f70: 2020 2020 2020 2020 6e61 6d65 203d 206e          name = n
+00027f80: 616d 6520 6f72 2073 656c 662e 6e61 6d65  ame or self.name
+00027f90: 206f 7220 6622 5275 6e6e 6162 6c65 4561   or f"RunnableEa
+00027fa0: 6368 3c7b 7365 6c66 2e62 6f75 6e64 2e67  ch<{self.bound.g
+00027fb0: 6574 5f6e 616d 6528 297d 3e22 0a20 2020  et_name()}>".   
+00027fc0: 2020 2020 2072 6574 7572 6e20 7375 7065       return supe
+00027fd0: 7228 292e 6765 745f 6e61 6d65 2873 7566  r().get_name(suf
+00027fe0: 6669 782c 206e 616d 653d 6e61 6d65 290a  fix, name=name).
+00027ff0: 0a20 2020 2064 6566 2062 696e 6428 7365  .    def bind(se
+00028000: 6c66 2c20 2a2a 6b77 6172 6773 3a20 416e  lf, **kwargs: An
+00028010: 7929 202d 3e20 5275 6e6e 6162 6c65 4561  y) -> RunnableEa
+00028020: 6368 5b49 6e70 7574 2c20 4f75 7470 7574  ch[Input, Output
+00028030: 5d3a 0a20 2020 2020 2020 2072 6574 7572  ]:.        retur
+00028040: 6e20 5275 6e6e 6162 6c65 4561 6368 2862  n RunnableEach(b
+00028050: 6f75 6e64 3d73 656c 662e 626f 756e 642e  ound=self.bound.
+00028060: 6269 6e64 282a 2a6b 7761 7267 7329 290a  bind(**kwargs)).
+00028070: 0a20 2020 2064 6566 2077 6974 685f 636f  .    def with_co
+00028080: 6e66 6967 280a 2020 2020 2020 2020 7365  nfig(.        se
+00028090: 6c66 2c20 636f 6e66 6967 3a20 4f70 7469  lf, config: Opti
+000280a0: 6f6e 616c 5b52 756e 6e61 626c 6543 6f6e  onal[RunnableCon
+000280b0: 6669 675d 203d 204e 6f6e 652c 202a 2a6b  fig] = None, **k
+000280c0: 7761 7267 733a 2041 6e79 0a20 2020 2029  wargs: Any.    )
+000280d0: 202d 3e20 5275 6e6e 6162 6c65 4561 6368   -> RunnableEach
+000280e0: 5b49 6e70 7574 2c20 4f75 7470 7574 5d3a  [Input, Output]:
+000280f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00028100: 5275 6e6e 6162 6c65 4561 6368 2862 6f75  RunnableEach(bou
+00028110: 6e64 3d73 656c 662e 626f 756e 642e 7769  nd=self.bound.wi
+00028120: 7468 5f63 6f6e 6669 6728 636f 6e66 6967  th_config(config
+00028130: 2c20 2a2a 6b77 6172 6773 2929 0a0a 2020  , **kwargs))..  
+00028140: 2020 6465 6620 7769 7468 5f6c 6973 7465    def with_liste
+00028150: 6e65 7273 280a 2020 2020 2020 2020 7365  ners(.        se
+00028160: 6c66 2c0a 2020 2020 2020 2020 2a2c 0a20  lf,.        *,. 
+00028170: 2020 2020 2020 206f 6e5f 7374 6172 743a         on_start:
+00028180: 204f 7074 696f 6e61 6c5b 4c69 7374 656e   Optional[Listen
+00028190: 6572 5d20 3d20 4e6f 6e65 2c0a 2020 2020  er] = None,.    
+000281a0: 2020 2020 6f6e 5f65 6e64 3a20 4f70 7469      on_end: Opti
+000281b0: 6f6e 616c 5b4c 6973 7465 6e65 725d 203d  onal[Listener] =
+000281c0: 204e 6f6e 652c 0a20 2020 2020 2020 206f   None,.        o
+000281d0: 6e5f 6572 726f 723a 204f 7074 696f 6e61  n_error: Optiona
+000281e0: 6c5b 4c69 7374 656e 6572 5d20 3d20 4e6f  l[Listener] = No
+000281f0: 6e65 2c0a 2020 2020 2920 2d3e 2052 756e  ne,.    ) -> Run
+00028200: 6e61 626c 6545 6163 685b 496e 7075 742c  nableEach[Input,
+00028210: 204f 7574 7075 745d 3a0a 2020 2020 2020   Output]:.      
+00028220: 2020 2222 220a 2020 2020 2020 2020 4269    """.        Bi
+00028230: 6e64 206c 6966 6563 7963 6c65 206c 6973  nd lifecycle lis
+00028240: 7465 6e65 7273 2074 6f20 6120 5275 6e6e  teners to a Runn
+00028250: 6162 6c65 2c20 7265 7475 726e 696e 6720  able, returning 
+00028260: 6120 6e65 7720 5275 6e6e 6162 6c65 2e0a  a new Runnable..
+00028270: 0a20 2020 2020 2020 206f 6e5f 7374 6172  .        on_star
+00028280: 743a 2043 616c 6c65 6420 6265 666f 7265  t: Called before
+00028290: 2074 6865 2072 756e 6e61 626c 6520 7374   the runnable st
+000282a0: 6172 7473 2072 756e 6e69 6e67 2c20 7769  arts running, wi
+000282b0: 7468 2074 6865 2052 756e 206f 626a 6563  th the Run objec
+000282c0: 742e 0a20 2020 2020 2020 206f 6e5f 656e  t..        on_en
+000282d0: 643a 2043 616c 6c65 6420 6166 7465 7220  d: Called after 
+000282e0: 7468 6520 7275 6e6e 6162 6c65 2066 696e  the runnable fin
+000282f0: 6973 6865 7320 7275 6e6e 696e 672c 2077  ishes running, w
+00028300: 6974 6820 7468 6520 5275 6e20 6f62 6a65  ith the Run obje
+00028310: 6374 2e0a 2020 2020 2020 2020 6f6e 5f65  ct..        on_e
+00028320: 7272 6f72 3a20 4361 6c6c 6564 2069 6620  rror: Called if 
+00028330: 7468 6520 7275 6e6e 6162 6c65 2074 6872  the runnable thr
+00028340: 6f77 7320 616e 2065 7272 6f72 2c20 7769  ows an error, wi
+00028350: 7468 2074 6865 2052 756e 206f 626a 6563  th the Run objec
+00028360: 742e 0a0a 2020 2020 2020 2020 5468 6520  t...        The 
+00028370: 5275 6e20 6f62 6a65 6374 2063 6f6e 7461  Run object conta
+00028380: 696e 7320 696e 666f 726d 6174 696f 6e20  ins information 
+00028390: 6162 6f75 7420 7468 6520 7275 6e2c 2069  about the run, i
+000283a0: 6e63 6c75 6469 6e67 2069 7473 2069 642c  ncluding its id,
+000283b0: 0a20 2020 2020 2020 2074 7970 652c 2069  .        type, i
+000283c0: 6e70 7574 2c20 6f75 7470 7574 2c20 6572  nput, output, er
+000283d0: 726f 722c 2073 7461 7274 5f74 696d 652c  ror, start_time,
+000283e0: 2065 6e64 5f74 696d 652c 2061 6e64 2061   end_time, and a
+000283f0: 6e79 2074 6167 7320 6f72 206d 6574 6164  ny tags or metad
+00028400: 6174 610a 2020 2020 2020 2020 6164 6465  ata.        adde
+00028410: 6420 746f 2074 6865 2072 756e 2e0a 2020  d to the run..  
+00028420: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00028430: 2020 7265 7475 726e 2052 756e 6e61 626c    return Runnabl
+00028440: 6545 6163 6828 0a20 2020 2020 2020 2020  eEach(.         
+00028450: 2020 2062 6f75 6e64 3d73 656c 662e 626f     bound=self.bo
+00028460: 756e 642e 7769 7468 5f6c 6973 7465 6e65  und.with_listene
+00028470: 7273 280a 2020 2020 2020 2020 2020 2020  rs(.            
+00028480: 2020 2020 6f6e 5f73 7461 7274 3d6f 6e5f      on_start=on_
+00028490: 7374 6172 742c 206f 6e5f 656e 643d 6f6e  start, on_end=on
+000284a0: 5f65 6e64 2c20 6f6e 5f65 7272 6f72 3d6f  _end, on_error=o
+000284b0: 6e5f 6572 726f 720a 2020 2020 2020 2020  n_error.        
+000284c0: 2020 2020 290a 2020 2020 2020 2020 290a      ).        ).
+000284d0: 0a0a 636c 6173 7320 5275 6e6e 6162 6c65  ..class Runnable
+000284e0: 4269 6e64 696e 6742 6173 6528 5275 6e6e  BindingBase(Runn
+000284f0: 6162 6c65 5365 7269 616c 697a 6162 6c65  ableSerializable
+00028500: 5b49 6e70 7574 2c20 4f75 7470 7574 5d29  [Input, Output])
+00028510: 3a0a 2020 2020 2222 2252 756e 6e61 626c  :.    """Runnabl
+00028520: 6520 7468 6174 2064 656c 6567 6174 6573  e that delegates
+00028530: 2063 616c 6c73 2074 6f20 616e 6f74 6865   calls to anothe
+00028540: 7220 5275 6e6e 6162 6c65 2077 6974 6820  r Runnable with 
+00028550: 6120 7365 7420 6f66 206b 7761 7267 732e  a set of kwargs.
+00028560: 0a0a 2020 2020 5573 6520 6f6e 6c79 2069  ..    Use only i
+00028570: 6620 6372 6561 7469 6e67 2061 206e 6577  f creating a new
+00028580: 2052 756e 6e61 626c 6542 696e 6469 6e67   RunnableBinding
+00028590: 2073 7562 636c 6173 7320 7769 7468 2064   subclass with d
+000285a0: 6966 6665 7265 6e74 205f 5f69 6e69 745f  ifferent __init_
+000285b0: 5f20 6172 6773 2e0a 0a20 2020 2053 6565  _ args...    See
+000285c0: 2064 6f63 756d 656e 7461 7469 6f6e 2066   documentation f
+000285d0: 6f72 2052 756e 6e61 626c 6542 696e 6469  or RunnableBindi
+000285e0: 6e67 2066 6f72 206d 6f72 6520 6465 7461  ng for more deta
+000285f0: 696c 732e 0a20 2020 2022 2222 0a0a 2020  ils..    """..  
+00028600: 2020 626f 756e 643a 2052 756e 6e61 626c    bound: Runnabl
+00028610: 655b 496e 7075 742c 204f 7574 7075 745d  e[Input, Output]
+00028620: 0a20 2020 2022 2222 5468 6520 756e 6465  .    """The unde
+00028630: 726c 7969 6e67 2072 756e 6e61 626c 6520  rlying runnable 
+00028640: 7468 6174 2074 6869 7320 7275 6e6e 6162  that this runnab
+00028650: 6c65 2064 656c 6567 6174 6573 2074 6f2e  le delegates to.
+00028660: 2222 220a 0a20 2020 206b 7761 7267 733a  """..    kwargs:
+00028670: 204d 6170 7069 6e67 5b73 7472 2c20 416e   Mapping[str, An
+00028680: 795d 203d 2046 6965 6c64 2864 6566 6175  y] = Field(defau
+00028690: 6c74 5f66 6163 746f 7279 3d64 6963 7429  lt_factory=dict)
+000286a0: 0a20 2020 2022 2222 6b77 6172 6773 2074  .    """kwargs t
+000286b0: 6f20 7061 7373 2074 6f20 7468 6520 756e  o pass to the un
+000286c0: 6465 726c 7969 6e67 2072 756e 6e61 626c  derlying runnabl
+000286d0: 6520 7768 656e 2072 756e 6e69 6e67 2e0a  e when running..
+000286e0: 0a20 2020 2046 6f72 2065 7861 6d70 6c65  .    For example
+000286f0: 2c20 7768 656e 2074 6865 2072 756e 6e61  , when the runna
+00028700: 626c 6520 6269 6e64 696e 6720 6973 2069  ble binding is i
+00028710: 6e76 6f6b 6564 2074 6865 2075 6e64 6572  nvoked the under
+00028720: 6c79 696e 670a 2020 2020 7275 6e6e 6162  lying.    runnab
+00028730: 6c65 2077 696c 6c20 6265 2069 6e76 6f6b  le will be invok
+00028740: 6564 2077 6974 6820 7468 6520 7361 6d65  ed with the same
+00028750: 2069 6e70 7574 2062 7574 2077 6974 6820   input but with 
+00028760: 7468 6573 6520 6164 6469 7469 6f6e 616c  these additional
+00028770: 0a20 2020 206b 7761 7267 732e 0a20 2020  .    kwargs..   
+00028780: 2022 2222 0a0a 2020 2020 636f 6e66 6967   """..    config
+00028790: 3a20 5275 6e6e 6162 6c65 436f 6e66 6967  : RunnableConfig
+000287a0: 203d 2046 6965 6c64 2864 6566 6175 6c74   = Field(default
+000287b0: 5f66 6163 746f 7279 3d64 6963 7429 0a20  _factory=dict). 
+000287c0: 2020 2022 2222 5468 6520 636f 6e66 6967     """The config
+000287d0: 2074 6f20 6269 6e64 2074 6f20 7468 6520   to bind to the 
+000287e0: 756e 6465 726c 7969 6e67 2072 756e 6e61  underlying runna
+000287f0: 626c 652e 2222 220a 0a20 2020 2063 6f6e  ble."""..    con
+00028800: 6669 675f 6661 6374 6f72 6965 733a 204c  fig_factories: L
+00028810: 6973 745b 4361 6c6c 6162 6c65 5b5b 5275  ist[Callable[[Ru
+00028820: 6e6e 6162 6c65 436f 6e66 6967 5d2c 2052  nnableConfig], R
+00028830: 756e 6e61 626c 6543 6f6e 6669 675d 5d20  unnableConfig]] 
+00028840: 3d20 4669 656c 6428 0a20 2020 2020 2020  = Field(.       
+00028850: 2064 6566 6175 6c74 5f66 6163 746f 7279   default_factory
+00028860: 3d6c 6973 740a 2020 2020 290a 2020 2020  =list.    ).    
+00028870: 2222 2254 6865 2063 6f6e 6669 6720 6661  """The config fa
+00028880: 6374 6f72 6965 7320 746f 2062 696e 6420  ctories to bind 
+00028890: 746f 2074 6865 2075 6e64 6572 6c79 696e  to the underlyin
+000288a0: 6720 7275 6e6e 6162 6c65 2e22 2222 0a0a  g runnable."""..
+000288b0: 2020 2020 2320 556e 696f 6e5b 5479 7065      # Union[Type
+000288c0: 5b49 6e70 7574 5d2c 2042 6173 654d 6f64  [Input], BaseMod
+000288d0: 656c 5d20 2b20 7468 696e 6773 206c 696b  el] + things lik
+000288e0: 6520 4c69 7374 5b73 7472 5d0a 2020 2020  e List[str].    
+000288f0: 6375 7374 6f6d 5f69 6e70 7574 5f74 7970  custom_input_typ
+00028900: 653a 204f 7074 696f 6e61 6c5b 416e 795d  e: Optional[Any]
+00028910: 203d 204e 6f6e 650a 2020 2020 2222 224f   = None.    """O
+00028920: 7665 7272 6964 6520 7468 6520 696e 7075  verride the inpu
+00028930: 7420 7479 7065 206f 6620 7468 6520 756e  t type of the un
+00028940: 6465 726c 7969 6e67 2072 756e 6e61 626c  derlying runnabl
+00028950: 6520 7769 7468 2061 2063 7573 746f 6d20  e with a custom 
+00028960: 7479 7065 2e0a 0a20 2020 2054 6865 2074  type...    The t
+00028970: 7970 6520 6361 6e20 6265 2061 2070 7964  ype can be a pyd
+00028980: 616e 7469 6320 6d6f 6465 6c2c 206f 7220  antic model, or 
+00028990: 6120 7479 7065 2061 6e6e 6f74 6174 696f  a type annotatio
+000289a0: 6e20 2865 2e67 2e2c 2060 4c69 7374 5b73  n (e.g., `List[s
+000289b0: 7472 5d60 292e 0a20 2020 2022 2222 0a20  tr]`)..    """. 
+000289c0: 2020 2023 2055 6e69 6f6e 5b54 7970 655b     # Union[Type[
+000289d0: 4f75 7470 7574 5d2c 2042 6173 654d 6f64  Output], BaseMod
+000289e0: 656c 5d20 2b20 7468 696e 6773 206c 696b  el] + things lik
+000289f0: 6520 4c69 7374 5b73 7472 5d0a 2020 2020  e List[str].    
+00028a00: 6375 7374 6f6d 5f6f 7574 7075 745f 7479  custom_output_ty
+00028a10: 7065 3a20 4f70 7469 6f6e 616c 5b41 6e79  pe: Optional[Any
+00028a20: 5d20 3d20 4e6f 6e65 0a20 2020 2022 2222  ] = None.    """
+00028a30: 4f76 6572 7269 6465 2074 6865 206f 7574  Override the out
+00028a40: 7075 7420 7479 7065 206f 6620 7468 6520  put type of the 
+00028a50: 756e 6465 726c 7969 6e67 2072 756e 6e61  underlying runna
+00028a60: 626c 6520 7769 7468 2061 2063 7573 746f  ble with a custo
+00028a70: 6d20 7479 7065 2e0a 0a20 2020 2054 6865  m type...    The
+00028a80: 2074 7970 6520 6361 6e20 6265 2061 2070   type can be a p
+00028a90: 7964 616e 7469 6320 6d6f 6465 6c2c 206f  ydantic model, o
+00028aa0: 7220 6120 7479 7065 2061 6e6e 6f74 6174  r a type annotat
+00028ab0: 696f 6e20 2865 2e67 2e2c 2060 4c69 7374  ion (e.g., `List
+00028ac0: 5b73 7472 5d60 292e 0a20 2020 2022 2222  [str]`)..    """
+00028ad0: 0a0a 2020 2020 636c 6173 7320 436f 6e66  ..    class Conf
+00028ae0: 6967 3a0a 2020 2020 2020 2020 6172 6269  ig:.        arbi
+00028af0: 7472 6172 795f 7479 7065 735f 616c 6c6f  trary_types_allo
+00028b00: 7765 6420 3d20 5472 7565 0a0a 2020 2020  wed = True..    
+00028b10: 6465 6620 5f5f 696e 6974 5f5f 280a 2020  def __init__(.  
+00028b20: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00028b30: 2020 2020 2a2c 0a20 2020 2020 2020 2062      *,.        b
+00028b40: 6f75 6e64 3a20 5275 6e6e 6162 6c65 5b49  ound: Runnable[I
+00028b50: 6e70 7574 2c20 4f75 7470 7574 5d2c 0a20  nput, Output],. 
+00028b60: 2020 2020 2020 206b 7761 7267 733a 204f         kwargs: O
+00028b70: 7074 696f 6e61 6c5b 4d61 7070 696e 675b  ptional[Mapping[
+00028b80: 7374 722c 2041 6e79 5d5d 203d 204e 6f6e  str, Any]] = Non
+00028b90: 652c 0a20 2020 2020 2020 2063 6f6e 6669  e,.        confi
+00028ba0: 673a 204f 7074 696f 6e61 6c5b 5275 6e6e  g: Optional[Runn
+00028bb0: 6162 6c65 436f 6e66 6967 5d20 3d20 4e6f  ableConfig] = No
+00028bc0: 6e65 2c0a 2020 2020 2020 2020 636f 6e66  ne,.        conf
+00028bd0: 6967 5f66 6163 746f 7269 6573 3a20 4f70  ig_factories: Op
+00028be0: 7469 6f6e 616c 5b0a 2020 2020 2020 2020  tional[.        
+00028bf0: 2020 2020 4c69 7374 5b43 616c 6c61 626c      List[Callabl
+00028c00: 655b 5b52 756e 6e61 626c 6543 6f6e 6669  e[[RunnableConfi
+00028c10: 675d 2c20 5275 6e6e 6162 6c65 436f 6e66  g], RunnableConf
+00028c20: 6967 5d5d 0a20 2020 2020 2020 205d 203d  ig]].        ] =
+00028c30: 204e 6f6e 652c 0a20 2020 2020 2020 2063   None,.        c
+00028c40: 7573 746f 6d5f 696e 7075 745f 7479 7065  ustom_input_type
+00028c50: 3a20 4f70 7469 6f6e 616c 5b55 6e69 6f6e  : Optional[Union
+00028c60: 5b54 7970 655b 496e 7075 745d 2c20 4261  [Type[Input], Ba
+00028c70: 7365 4d6f 6465 6c5d 5d20 3d20 4e6f 6e65  seModel]] = None
+00028c80: 2c0a 2020 2020 2020 2020 6375 7374 6f6d  ,.        custom
+00028c90: 5f6f 7574 7075 745f 7479 7065 3a20 4f70  _output_type: Op
+00028ca0: 7469 6f6e 616c 5b55 6e69 6f6e 5b54 7970  tional[Union[Typ
+00028cb0: 655b 4f75 7470 7574 5d2c 2042 6173 654d  e[Output], BaseM
+00028cc0: 6f64 656c 5d5d 203d 204e 6f6e 652c 0a20  odel]] = None,. 
+00028cd0: 2020 2020 2020 202a 2a6f 7468 6572 5f6b         **other_k
+00028ce0: 7761 7267 733a 2041 6e79 2c0a 2020 2020  wargs: Any,.    
+00028cf0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00028d00: 2020 2022 2222 4372 6561 7465 2061 2052     """Create a R
+00028d10: 756e 6e61 626c 6542 696e 6469 6e67 2066  unnableBinding f
+00028d20: 726f 6d20 6120 7275 6e6e 6162 6c65 2061  rom a runnable a
+00028d30: 6e64 206b 7761 7267 732e 0a0a 2020 2020  nd kwargs...    
+00028d40: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00028d50: 2020 2020 2020 626f 756e 643a 2054 6865        bound: The
+00028d60: 2075 6e64 6572 6c79 696e 6720 7275 6e6e   underlying runn
+00028d70: 6162 6c65 2074 6861 7420 7468 6973 2072  able that this r
+00028d80: 756e 6e61 626c 6520 6465 6c65 6761 7465  unnable delegate
+00028d90: 7320 6361 6c6c 7320 746f 2e0a 2020 2020  s calls to..    
+00028da0: 2020 2020 2020 2020 6b77 6172 6773 3a20          kwargs: 
+00028db0: 6f70 7469 6f6e 616c 206b 7761 7267 7320  optional kwargs 
+00028dc0: 746f 2070 6173 7320 746f 2074 6865 2075  to pass to the u
+00028dd0: 6e64 6572 6c79 696e 6720 7275 6e6e 6162  nderlying runnab
+00028de0: 6c65 2c20 7768 656e 2072 756e 6e69 6e67  le, when running
+00028df0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028e00: 2020 2020 2074 6865 2075 6e64 6572 6c79       the underly
+00028e10: 696e 6720 7275 6e6e 6162 6c65 2028 652e  ing runnable (e.
+00028e20: 672e 2c20 7669 6120 6069 6e76 6f6b 6560  g., via `invoke`
+00028e30: 2c20 6062 6174 6368 602c 0a20 2020 2020  , `batch`,.     
+00028e40: 2020 2020 2020 2020 2020 2020 2020 2060                 `
+00028e50: 7472 616e 7366 6f72 6d60 2c20 6f72 2060  transform`, or `
+00028e60: 7374 7265 616d 6020 6f72 2061 7379 6e63  stream` or async
+00028e70: 2076 6172 6961 6e74 7329 0a20 2020 2020   variants).     
+00028e80: 2020 2020 2020 2063 6f6e 6669 673a 2063         config: c
+00028e90: 6f6e 6669 675f 6661 6374 6f72 6965 733a  onfig_factories:
+00028ea0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00028eb0: 6669 675f 6661 6374 6f72 6965 733a 206f  fig_factories: o
+00028ec0: 7074 696f 6e61 6c20 6c69 7374 206f 6620  ptional list of 
+00028ed0: 636f 6e66 6967 2066 6163 746f 7269 6573  config factories
+00028ee0: 2074 6f20 6170 706c 7920 746f 2074 6865   to apply to the
+00028ef0: 0a20 2020 2020 2020 2020 2020 2063 7573  .            cus
+00028f00: 746f 6d5f 696e 7075 745f 7479 7065 3a20  tom_input_type: 
+00028f10: 5370 6563 6966 7920 746f 206f 7665 7272  Specify to overr
+00028f20: 6964 6520 7468 6520 696e 7075 7420 7479  ide the input ty
+00028f30: 7065 206f 6620 7468 6520 756e 6465 726c  pe of the underl
+00028f40: 7969 6e67 0a20 2020 2020 2020 2020 2020  ying.           
+00028f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028f60: 2020 2020 7275 6e6e 6162 6c65 2077 6974      runnable wit
+00028f70: 6820 6120 6375 7374 6f6d 2074 7970 652e  h a custom type.
+00028f80: 0a20 2020 2020 2020 2020 2020 2063 7573  .            cus
+00028f90: 746f 6d5f 6f75 7470 7574 5f74 7970 653a  tom_output_type:
+00028fa0: 2053 7065 6369 6679 2074 6f20 6f76 6572   Specify to over
+00028fb0: 7269 6465 2074 6865 206f 7574 7075 7420  ride the output 
+00028fc0: 7479 7065 206f 6620 7468 6520 756e 6465  type of the unde
+00028fd0: 726c 7969 6e67 0a20 2020 2020 2020 2020  rlying.         
+00028fe0: 2020 2020 2020 2072 756e 6e61 626c 6520         runnable 
+00028ff0: 7769 7468 2061 2063 7573 746f 6d20 7479  with a custom ty
+00029000: 7065 2e0a 2020 2020 2020 2020 2020 2020  pe..            
+00029010: 2a2a 6f74 6865 725f 6b77 6172 6773 3a20  **other_kwargs: 
+00029020: 556e 7061 636b 6564 2069 6e74 6f20 7468  Unpacked into th
+00029030: 6520 6261 7365 2063 6c61 7373 2e0a 2020  e base class..  
+00029040: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00029050: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+00029060: 5f5f 2820 2023 2074 7970 653a 2069 676e  __(  # type: ign
+00029070: 6f72 655b 6361 6c6c 2d61 7267 5d0a 2020  ore[call-arg].  
+00029080: 2020 2020 2020 2020 2020 626f 756e 643d            bound=
+00029090: 626f 756e 642c 0a20 2020 2020 2020 2020  bound,.         
+000290a0: 2020 206b 7761 7267 733d 6b77 6172 6773     kwargs=kwargs
+000290b0: 206f 7220 7b7d 2c0a 2020 2020 2020 2020   or {},.        
+000290c0: 2020 2020 636f 6e66 6967 3d63 6f6e 6669      config=confi
+000290d0: 6720 6f72 207b 7d2c 0a20 2020 2020 2020  g or {},.       
+000290e0: 2020 2020 2063 6f6e 6669 675f 6661 6374       config_fact
+000290f0: 6f72 6965 733d 636f 6e66 6967 5f66 6163  ories=config_fac
+00029100: 746f 7269 6573 206f 7220 5b5d 2c0a 2020  tories or [],.  
+00029110: 2020 2020 2020 2020 2020 6375 7374 6f6d            custom
+00029120: 5f69 6e70 7574 5f74 7970 653d 6375 7374  _input_type=cust
+00029130: 6f6d 5f69 6e70 7574 5f74 7970 652c 0a20  om_input_type,. 
+00029140: 2020 2020 2020 2020 2020 2063 7573 746f             custo
+00029150: 6d5f 6f75 7470 7574 5f74 7970 653d 6375  m_output_type=cu
+00029160: 7374 6f6d 5f6f 7574 7075 745f 7479 7065  stom_output_type
+00029170: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
+00029180: 6f74 6865 725f 6b77 6172 6773 2c0a 2020  other_kwargs,.  
+00029190: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000291a0: 2320 6966 2077 6520 646f 6e27 7420 6578  # if we don't ex
+000291b0: 706c 6963 6974 6c79 2073 6574 2063 6f6e  plicitly set con
+000291c0: 6669 6720 746f 2074 6865 2054 7970 6564  fig to the Typed
+000291d0: 4469 6374 2068 6572 652c 0a20 2020 2020  Dict here,.     
+000291e0: 2020 2023 2074 6865 2070 7964 616e 7469     # the pydanti
+000291f0: 6320 696e 6974 2061 626f 7665 2077 696c  c init above wil
+00029200: 6c20 7374 7269 7020 6f75 7420 616e 7920  l strip out any 
+00029210: 6f66 2074 6865 2022 6578 7472 6122 0a20  of the "extra". 
+00029220: 2020 2020 2020 2023 2066 6965 6c64 7320         # fields 
+00029230: 6576 656e 2074 686f 7567 6820 746f 7461  even though tota
+00029240: 6c3d 4661 6c73 6520 6f6e 2074 6865 2074  l=False on the t
+00029250: 7970 6564 2064 6963 742e 0a20 2020 2020  yped dict..     
+00029260: 2020 2073 656c 662e 636f 6e66 6967 203d     self.config =
+00029270: 2063 6f6e 6669 6720 6f72 207b 7d0a 0a20   config or {}.. 
+00029280: 2020 2064 6566 2067 6574 5f6e 616d 6528     def get_name(
+00029290: 0a20 2020 2020 2020 2073 656c 662c 2073  .        self, s
+000292a0: 7566 6669 783a 204f 7074 696f 6e61 6c5b  uffix: Optional[
+000292b0: 7374 725d 203d 204e 6f6e 652c 202a 2c20  str] = None, *, 
+000292c0: 6e61 6d65 3a20 4f70 7469 6f6e 616c 5b73  name: Optional[s
+000292d0: 7472 5d20 3d20 4e6f 6e65 0a20 2020 2029  tr] = None.    )
+000292e0: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
+000292f0: 2072 6574 7572 6e20 7365 6c66 2e62 6f75   return self.bou
+00029300: 6e64 2e67 6574 5f6e 616d 6528 7375 6666  nd.get_name(suff
+00029310: 6978 2c20 6e61 6d65 3d6e 616d 6529 0a0a  ix, name=name)..
+00029320: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+00029330: 2020 6465 6620 496e 7075 7454 7970 6528    def InputType(
+00029340: 7365 6c66 2920 2d3e 2054 7970 655b 496e  self) -> Type[In
+00029350: 7075 745d 3a0a 2020 2020 2020 2020 7265  put]:.        re
+00029360: 7475 726e 2028 0a20 2020 2020 2020 2020  turn (.         
+00029370: 2020 2063 6173 7428 5479 7065 5b49 6e70     cast(Type[Inp
+00029380: 7574 5d2c 2073 656c 662e 6375 7374 6f6d  ut], self.custom
+00029390: 5f69 6e70 7574 5f74 7970 6529 0a20 2020  _input_type).   
+000293a0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+000293b0: 2e63 7573 746f 6d5f 696e 7075 745f 7479  .custom_input_ty
+000293c0: 7065 2069 7320 6e6f 7420 4e6f 6e65 0a20  pe is not None. 
+000293d0: 2020 2020 2020 2020 2020 2065 6c73 6520             else 
+000293e0: 7365 6c66 2e62 6f75 6e64 2e49 6e70 7574  self.bound.Input
+000293f0: 5479 7065 0a20 2020 2020 2020 2029 0a0a  Type.        )..
+00029400: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+00029410: 2020 6465 6620 4f75 7470 7574 5479 7065    def OutputType
+00029420: 2873 656c 6629 202d 3e20 5479 7065 5b4f  (self) -> Type[O
+00029430: 7574 7075 745d 3a0a 2020 2020 2020 2020  utput]:.        
+00029440: 7265 7475 726e 2028 0a20 2020 2020 2020  return (.       
+00029450: 2020 2020 2063 6173 7428 5479 7065 5b4f       cast(Type[O
+00029460: 7574 7075 745d 2c20 7365 6c66 2e63 7573  utput], self.cus
+00029470: 746f 6d5f 6f75 7470 7574 5f74 7970 6529  tom_output_type)
+00029480: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00029490: 7365 6c66 2e63 7573 746f 6d5f 6f75 7470  self.custom_outp
+000294a0: 7574 5f74 7970 6520 6973 206e 6f74 204e  ut_type is not N
+000294b0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+000294c0: 656c 7365 2073 656c 662e 626f 756e 642e  else self.bound.
+000294d0: 4f75 7470 7574 5479 7065 0a20 2020 2020  OutputType.     
+000294e0: 2020 2029 0a0a 2020 2020 6465 6620 6765     )..    def ge
+000294f0: 745f 696e 7075 745f 7363 6865 6d61 280a  t_input_schema(.
+00029500: 2020 2020 2020 2020 7365 6c66 2c20 636f          self, co
+00029510: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b52  nfig: Optional[R
+00029520: 756e 6e61 626c 6543 6f6e 6669 675d 203d  unnableConfig] =
+00029530: 204e 6f6e 650a 2020 2020 2920 2d3e 2054   None.    ) -> T
+00029540: 7970 655b 4261 7365 4d6f 6465 6c5d 3a0a  ype[BaseModel]:.
+00029550: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00029560: 6375 7374 6f6d 5f69 6e70 7574 5f74 7970  custom_input_typ
+00029570: 6520 6973 206e 6f74 204e 6f6e 653a 0a20  e is not None:. 
+00029580: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00029590: 6e20 7375 7065 7228 292e 6765 745f 696e  n super().get_in
+000295a0: 7075 745f 7363 6865 6d61 2863 6f6e 6669  put_schema(confi
+000295b0: 6729 0a20 2020 2020 2020 2072 6574 7572  g).        retur
+000295c0: 6e20 7365 6c66 2e62 6f75 6e64 2e67 6574  n self.bound.get
+000295d0: 5f69 6e70 7574 5f73 6368 656d 6128 6d65  _input_schema(me
+000295e0: 7267 655f 636f 6e66 6967 7328 7365 6c66  rge_configs(self
+000295f0: 2e63 6f6e 6669 672c 2063 6f6e 6669 6729  .config, config)
+00029600: 290a 0a20 2020 2064 6566 2067 6574 5f6f  )..    def get_o
+00029610: 7574 7075 745f 7363 6865 6d61 280a 2020  utput_schema(.  
+00029620: 2020 2020 2020 7365 6c66 2c20 636f 6e66        self, conf
+00029630: 6967 3a20 4f70 7469 6f6e 616c 5b52 756e  ig: Optional[Run
+00029640: 6e61 626c 6543 6f6e 6669 675d 203d 204e  nableConfig] = N
+00029650: 6f6e 650a 2020 2020 2920 2d3e 2054 7970  one.    ) -> Typ
+00029660: 655b 4261 7365 4d6f 6465 6c5d 3a0a 2020  e[BaseModel]:.  
+00029670: 2020 2020 2020 6966 2073 656c 662e 6375        if self.cu
+00029680: 7374 6f6d 5f6f 7574 7075 745f 7479 7065  stom_output_type
+00029690: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+000296a0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000296b0: 2073 7570 6572 2829 2e67 6574 5f6f 7574   super().get_out
+000296c0: 7075 745f 7363 6865 6d61 2863 6f6e 6669  put_schema(confi
+000296d0: 6729 0a20 2020 2020 2020 2072 6574 7572  g).        retur
+000296e0: 6e20 7365 6c66 2e62 6f75 6e64 2e67 6574  n self.bound.get
+000296f0: 5f6f 7574 7075 745f 7363 6865 6d61 286d  _output_schema(m
+00029700: 6572 6765 5f63 6f6e 6669 6773 2873 656c  erge_configs(sel
+00029710: 662e 636f 6e66 6967 2c20 636f 6e66 6967  f.config, config
+00029720: 2929 0a0a 2020 2020 4070 726f 7065 7274  ))..    @propert
+00029730: 790a 2020 2020 6465 6620 636f 6e66 6967  y.    def config
+00029740: 5f73 7065 6373 2873 656c 6629 202d 3e20  _specs(self) -> 
+00029750: 4c69 7374 5b43 6f6e 6669 6775 7261 626c  List[Configurabl
+00029760: 6546 6965 6c64 5370 6563 5d3a 0a20 2020  eFieldSpec]:.   
+00029770: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00029780: 2e62 6f75 6e64 2e63 6f6e 6669 675f 7370  .bound.config_sp
+00029790: 6563 730a 0a20 2020 2064 6566 2067 6574  ecs..    def get
+000297a0: 5f67 7261 7068 2873 656c 662c 2063 6f6e  _graph(self, con
+000297b0: 6669 673a 204f 7074 696f 6e61 6c5b 5275  fig: Optional[Ru
+000297c0: 6e6e 6162 6c65 436f 6e66 6967 5d20 3d20  nnableConfig] = 
+000297d0: 4e6f 6e65 2920 2d3e 2047 7261 7068 3a0a  None) -> Graph:.
+000297e0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+000297f0: 656c 662e 626f 756e 642e 6765 745f 6772  elf.bound.get_gr
+00029800: 6170 6828 636f 6e66 6967 290a 0a20 2020  aph(config)..   
+00029810: 2040 636c 6173 736d 6574 686f 640a 2020   @classmethod.  
+00029820: 2020 6465 6620 6973 5f6c 635f 7365 7269    def is_lc_seri
+00029830: 616c 697a 6162 6c65 2863 6c73 2920 2d3e  alizable(cls) ->
+00029840: 2062 6f6f 6c3a 0a20 2020 2020 2020 2072   bool:.        r
+00029850: 6574 7572 6e20 5472 7565 0a0a 2020 2020  eturn True..    
+00029860: 4063 6c61 7373 6d65 7468 6f64 0a20 2020  @classmethod.   
+00029870: 2064 6566 2067 6574 5f6c 635f 6e61 6d65   def get_lc_name
+00029880: 7370 6163 6528 636c 7329 202d 3e20 4c69  space(cls) -> Li
+00029890: 7374 5b73 7472 5d3a 0a20 2020 2020 2020  st[str]:.       
+000298a0: 2022 2222 4765 7420 7468 6520 6e61 6d65   """Get the name
+000298b0: 7370 6163 6520 6f66 2074 6865 206c 616e  space of the lan
+000298c0: 6763 6861 696e 206f 626a 6563 742e 2222  gchain object.""
+000298d0: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
+000298e0: 205b 226c 616e 6763 6861 696e 222c 2022   ["langchain", "
+000298f0: 7363 6865 6d61 222c 2022 7275 6e6e 6162  schema", "runnab
+00029900: 6c65 225d 0a0a 2020 2020 6465 6620 5f6d  le"]..    def _m
+00029910: 6572 6765 5f63 6f6e 6669 6773 2873 656c  erge_configs(sel
+00029920: 662c 202a 636f 6e66 6967 733a 204f 7074  f, *configs: Opt
+00029930: 696f 6e61 6c5b 5275 6e6e 6162 6c65 436f  ional[RunnableCo
+00029940: 6e66 6967 5d29 202d 3e20 5275 6e6e 6162  nfig]) -> Runnab
+00029950: 6c65 436f 6e66 6967 3a0a 2020 2020 2020  leConfig:.      
+00029960: 2020 636f 6e66 6967 203d 206d 6572 6765    config = merge
+00029970: 5f63 6f6e 6669 6773 2873 656c 662e 636f  _configs(self.co
+00029980: 6e66 6967 2c20 2a63 6f6e 6669 6773 290a  nfig, *configs).
+00029990: 2020 2020 2020 2020 7265 7475 726e 206d          return m
+000299a0: 6572 6765 5f63 6f6e 6669 6773 2863 6f6e  erge_configs(con
+000299b0: 6669 672c 202a 2866 2863 6f6e 6669 6729  fig, *(f(config)
+000299c0: 2066 6f72 2066 2069 6e20 7365 6c66 2e63   for f in self.c
+000299d0: 6f6e 6669 675f 6661 6374 6f72 6965 7329  onfig_factories)
+000299e0: 290a 0a20 2020 2064 6566 2069 6e76 6f6b  )..    def invok
+000299f0: 6528 0a20 2020 2020 2020 2073 656c 662c  e(.        self,
+00029a00: 0a20 2020 2020 2020 2069 6e70 7574 3a20  .        input: 
+00029a10: 496e 7075 742c 0a20 2020 2020 2020 2063  Input,.        c
+00029a20: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
+00029a30: 5275 6e6e 6162 6c65 436f 6e66 6967 5d20  RunnableConfig] 
+00029a40: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00029a50: 2a2a 6b77 6172 6773 3a20 4f70 7469 6f6e  **kwargs: Option
+00029a60: 616c 5b41 6e79 5d2c 0a20 2020 2029 202d  al[Any],.    ) -
+00029a70: 3e20 4f75 7470 7574 3a0a 2020 2020 2020  > Output:.      
+00029a80: 2020 7265 7475 726e 2073 656c 662e 626f    return self.bo
+00029a90: 756e 642e 696e 766f 6b65 280a 2020 2020  und.invoke(.    
+00029aa0: 2020 2020 2020 2020 696e 7075 742c 0a20          input,. 
+00029ab0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00029ac0: 5f6d 6572 6765 5f63 6f6e 6669 6773 2863  _merge_configs(c
+00029ad0: 6f6e 6669 6729 2c0a 2020 2020 2020 2020  onfig),.        
+00029ae0: 2020 2020 2a2a 7b2a 2a73 656c 662e 6b77      **{**self.kw
+00029af0: 6172 6773 2c20 2a2a 6b77 6172 6773 7d2c  args, **kwargs},
+00029b00: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00029b10: 6173 796e 6320 6465 6620 6169 6e76 6f6b  async def ainvok
+00029b20: 6528 0a20 2020 2020 2020 2073 656c 662c  e(.        self,
+00029b30: 0a20 2020 2020 2020 2069 6e70 7574 3a20  .        input: 
+00029b40: 496e 7075 742c 0a20 2020 2020 2020 2063  Input,.        c
+00029b50: 6f6e 6669 673a 204f 7074 696f 6e61 6c5b  onfig: Optional[
+00029b60: 5275 6e6e 6162 6c65 436f 6e66 6967 5d20  RunnableConfig] 
+00029b70: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00029b80: 2a2a 6b77 6172 6773 3a20 4f70 7469 6f6e  **kwargs: Option
+00029b90: 616c 5b41 6e79 5d2c 0a20 2020 2029 202d  al[Any],.    ) -
+00029ba0: 3e20 4f75 7470 7574 3a0a 2020 2020 2020  > Output:.      
+00029bb0: 2020 7265 7475 726e 2061 7761 6974 2073    return await s
+00029bc0: 656c 662e 626f 756e 642e 6169 6e76 6f6b  elf.bound.ainvok
+00029bd0: 6528 0a20 2020 2020 2020 2020 2020 2069  e(.            i
+00029be0: 6e70 7574 2c0a 2020 2020 2020 2020 2020  nput,.          
+00029bf0: 2020 7365 6c66 2e5f 6d65 7267 655f 636f    self._merge_co
+00029c00: 6e66 6967 7328 636f 6e66 6967 292c 0a20  nfigs(config),. 
+00029c10: 2020 2020 2020 2020 2020 202a 2a7b 2a2a             **{**
+00029c20: 7365 6c66 2e6b 7761 7267 732c 202a 2a6b  self.kwargs, **k
+00029c30: 7761 7267 737d 2c0a 2020 2020 2020 2020  wargs},.        
+00029c40: 290a 0a20 2020 2064 6566 2062 6174 6368  )..    def batch
+00029c50: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00029c60: 2020 2020 2020 2020 696e 7075 7473 3a20          inputs: 
+00029c70: 4c69 7374 5b49 6e70 7574 5d2c 0a20 2020  List[Input],.   
+00029c80: 2020 2020 2063 6f6e 6669 673a 204f 7074       config: Opt
+00029c90: 696f 6e61 6c5b 556e 696f 6e5b 5275 6e6e  ional[Union[Runn
+00029ca0: 6162 6c65 436f 6e66 6967 2c20 4c69 7374  ableConfig, List
+00029cb0: 5b52 756e 6e61 626c 6543 6f6e 6669 675d  [RunnableConfig]
+00029cc0: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
+00029cd0: 2020 202a 2c0a 2020 2020 2020 2020 7265     *,.        re
+00029ce0: 7475 726e 5f65 7863 6570 7469 6f6e 733a  turn_exceptions:
+00029cf0: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+00029d00: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
+00029d10: 204f 7074 696f 6e61 6c5b 416e 795d 2c0a   Optional[Any],.
+00029d20: 2020 2020 2920 2d3e 204c 6973 745b 4f75      ) -> List[Ou
+00029d30: 7470 7574 5d3a 0a20 2020 2020 2020 2069  tput]:.        i
+00029d40: 6620 6973 696e 7374 616e 6365 2863 6f6e  f isinstance(con
+00029d50: 6669 672c 206c 6973 7429 3a0a 2020 2020  fig, list):.    
+00029d60: 2020 2020 2020 2020 636f 6e66 6967 7320          configs 
+00029d70: 3d20 6361 7374 280a 2020 2020 2020 2020  = cast(.        
+00029d80: 2020 2020 2020 2020 4c69 7374 5b52 756e          List[Run
+00029d90: 6e61 626c 6543 6f6e 6669 675d 2c0a 2020  nableConfig],.  
+00029da0: 2020 2020 2020 2020 2020 2020 2020 5b73                [s
+00029db0: 656c 662e 5f6d 6572 6765 5f63 6f6e 6669  elf._merge_confi
+00029dc0: 6773 2863 6f6e 6629 2066 6f72 2063 6f6e  gs(conf) for con
+00029dd0: 6620 696e 2063 6f6e 6669 675d 2c0a 2020  f in config],.  
+00029de0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00029df0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00029e00: 2020 2020 2020 636f 6e66 6967 7320 3d20        configs = 
+00029e10: 5b73 656c 662e 5f6d 6572 6765 5f63 6f6e  [self._merge_con
+00029e20: 6669 6773 2863 6f6e 6669 6729 2066 6f72  figs(config) for
+00029e30: 205f 2069 6e20 7261 6e67 6528 6c65 6e28   _ in range(len(
+00029e40: 696e 7075 7473 2929 5d0a 2020 2020 2020  inputs))].      
+00029e50: 2020 7265 7475 726e 2073 656c 662e 626f    return self.bo
+00029e60: 756e 642e 6261 7463 6828 0a20 2020 2020  und.batch(.     
+00029e70: 2020 2020 2020 2069 6e70 7574 732c 0a20         inputs,. 
+00029e80: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
+00029e90: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
+00029ea0: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
+00029eb0: 733d 7265 7475 726e 5f65 7863 6570 7469  s=return_excepti
+00029ec0: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+00029ed0: 202a 2a7b 2a2a 7365 6c66 2e6b 7761 7267   **{**self.kwarg
+00029ee0: 732c 202a 2a6b 7761 7267 737d 2c0a 2020  s, **kwargs},.  
+00029ef0: 2020 2020 2020 290a 0a20 2020 2061 7379        )..    asy
+00029f00: 6e63 2064 6566 2061 6261 7463 6828 0a20  nc def abatch(. 
+00029f10: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+00029f20: 2020 2020 2069 6e70 7574 733a 204c 6973       inputs: Lis
+00029f30: 745b 496e 7075 745d 2c0a 2020 2020 2020  t[Input],.      
+00029f40: 2020 636f 6e66 6967 3a20 4f70 7469 6f6e    config: Option
+00029f50: 616c 5b55 6e69 6f6e 5b52 756e 6e61 626c  al[Union[Runnabl
+00029f60: 6543 6f6e 6669 672c 204c 6973 745b 5275  eConfig, List[Ru
+00029f70: 6e6e 6162 6c65 436f 6e66 6967 5d5d 5d20  nnableConfig]]] 
+00029f80: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00029f90: 2a2c 0a20 2020 2020 2020 2072 6574 7572  *,.        retur
+00029fa0: 6e5f 6578 6365 7074 696f 6e73 3a20 626f  n_exceptions: bo
+00029fb0: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+00029fc0: 2020 2020 2a2a 6b77 6172 6773 3a20 4f70      **kwargs: Op
+00029fd0: 7469 6f6e 616c 5b41 6e79 5d2c 0a20 2020  tional[Any],.   
+00029fe0: 2029 202d 3e20 4c69 7374 5b4f 7574 7075   ) -> List[Outpu
+00029ff0: 745d 3a0a 2020 2020 2020 2020 6966 2069  t]:.        if i
+0002a000: 7369 6e73 7461 6e63 6528 636f 6e66 6967  sinstance(config
+0002a010: 2c20 6c69 7374 293a 0a20 2020 2020 2020  , list):.       
+0002a020: 2020 2020 2063 6f6e 6669 6773 203d 2063       configs = c
+0002a030: 6173 7428 0a20 2020 2020 2020 2020 2020  ast(.           
+0002a040: 2020 2020 204c 6973 745b 5275 6e6e 6162       List[Runnab
+0002a050: 6c65 436f 6e66 6967 5d2c 0a20 2020 2020  leConfig],.     
+0002a060: 2020 2020 2020 2020 2020 205b 7365 6c66             [self
+0002a070: 2e5f 6d65 7267 655f 636f 6e66 6967 7328  ._merge_configs(
+0002a080: 636f 6e66 2920 666f 7220 636f 6e66 2069  conf) for conf i
+0002a090: 6e20 636f 6e66 6967 5d2c 0a20 2020 2020  n config],.     
+0002a0a0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002a0b0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0002a0c0: 2020 2063 6f6e 6669 6773 203d 205b 7365     configs = [se
+0002a0d0: 6c66 2e5f 6d65 7267 655f 636f 6e66 6967  lf._merge_config
+0002a0e0: 7328 636f 6e66 6967 2920 666f 7220 5f20  s(config) for _ 
+0002a0f0: 696e 2072 616e 6765 286c 656e 2869 6e70  in range(len(inp
+0002a100: 7574 7329 295d 0a20 2020 2020 2020 2072  uts))].        r
+0002a110: 6574 7572 6e20 6177 6169 7420 7365 6c66  eturn await self
+0002a120: 2e62 6f75 6e64 2e61 6261 7463 6828 0a20  .bound.abatch(. 
+0002a130: 2020 2020 2020 2020 2020 2069 6e70 7574             input
+0002a140: 732c 0a20 2020 2020 2020 2020 2020 2063  s,.            c
+0002a150: 6f6e 6669 6773 2c0a 2020 2020 2020 2020  onfigs,.        
+0002a160: 2020 2020 7265 7475 726e 5f65 7863 6570      return_excep
+0002a170: 7469 6f6e 733d 7265 7475 726e 5f65 7863  tions=return_exc
+0002a180: 6570 7469 6f6e 732c 0a20 2020 2020 2020  eptions,.       
+0002a190: 2020 2020 202a 2a7b 2a2a 7365 6c66 2e6b       **{**self.k
+0002a1a0: 7761 7267 732c 202a 2a6b 7761 7267 737d  wargs, **kwargs}
+0002a1b0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+0002a1c0: 2040 6f76 6572 6c6f 6164 0a20 2020 2064   @overload.    d
+0002a1d0: 6566 2062 6174 6368 5f61 735f 636f 6d70  ef batch_as_comp
+0002a1e0: 6c65 7465 6428 0a20 2020 2020 2020 2073  leted(.        s
+0002a1f0: 656c 662c 0a20 2020 2020 2020 2069 6e70  elf,.        inp
+0002a200: 7574 733a 204c 6973 745b 496e 7075 745d  uts: List[Input]
+0002a210: 2c0a 2020 2020 2020 2020 636f 6e66 6967  ,.        config
+0002a220: 3a20 4f70 7469 6f6e 616c 5b55 6e69 6f6e  : Optional[Union
+0002a230: 5b52 756e 6e61 626c 6543 6f6e 6669 672c  [RunnableConfig,
+0002a240: 204c 6973 745b 5275 6e6e 6162 6c65 436f   List[RunnableCo
+0002a250: 6e66 6967 5d5d 5d20 3d20 4e6f 6e65 2c0a  nfig]]] = None,.
+0002a260: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
+0002a270: 2020 2072 6574 7572 6e5f 6578 6365 7074     return_except
+0002a280: 696f 6e73 3a20 4c69 7465 7261 6c5b 4661  ions: Literal[Fa
+0002a290: 6c73 655d 203d 2046 616c 7365 2c0a 2020  lse] = False,.  
+0002a2a0: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
+0002a2b0: 416e 792c 0a20 2020 2029 202d 3e20 4974  Any,.    ) -> It
+0002a2c0: 6572 6174 6f72 5b54 7570 6c65 5b69 6e74  erator[Tuple[int
+0002a2d0: 2c20 4f75 7470 7574 5d5d 3a0a 2020 2020  , Output]]:.    
+0002a2e0: 2020 2020 2e2e 2e0a 0a20 2020 2040 6f76      .....    @ov
+0002a2f0: 6572 6c6f 6164 0a20 2020 2064 6566 2062  erload.    def b
+0002a300: 6174 6368 5f61 735f 636f 6d70 6c65 7465  atch_as_complete
+0002a310: 6428 0a20 2020 2020 2020 2073 656c 662c  d(.        self,
+0002a320: 0a20 2020 2020 2020 2069 6e70 7574 733a  .        inputs:
+0002a330: 204c 6973 745b 496e 7075 745d 2c0a 2020   List[Input],.  
+0002a340: 2020 2020 2020 636f 6e66 6967 3a20 4f70        config: Op
+0002a350: 7469 6f6e 616c 5b55 6e69 6f6e 5b52 756e  tional[Union[Run
+0002a360: 6e61 626c 6543 6f6e 6669 672c 204c 6973  nableConfig, Lis
+0002a370: 745b 5275 6e6e 6162 6c65 436f 6e66 6967  t[RunnableConfig
+0002a380: 5d5d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ]]] = None,.    
+0002a390: 2020 2020 2a2c 0a20 2020 2020 2020 2072      *,.        r
+0002a3a0: 6574 7572 6e5f 6578 6365 7074 696f 6e73  eturn_exceptions
+0002a3b0: 3a20 4c69 7465 7261 6c5b 5472 7565 5d2c  : Literal[True],
+0002a3c0: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+0002a3d0: 733a 2041 6e79 2c0a 2020 2020 2920 2d3e  s: Any,.    ) ->
+0002a3e0: 2049 7465 7261 746f 725b 5475 706c 655b   Iterator[Tuple[
+0002a3f0: 696e 742c 2055 6e69 6f6e 5b4f 7574 7075  int, Union[Outpu
+0002a400: 742c 2045 7863 6570 7469 6f6e 5d5d 5d3a  t, Exception]]]:
+0002a410: 0a20 2020 2020 2020 202e 2e2e 0a0a 2020  .        .....  
+0002a420: 2020 6465 6620 6261 7463 685f 6173 5f63    def batch_as_c
+0002a430: 6f6d 706c 6574 6564 280a 2020 2020 2020  ompleted(.      
+0002a440: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+0002a450: 696e 7075 7473 3a20 4c69 7374 5b49 6e70  inputs: List[Inp
+0002a460: 7574 5d2c 0a20 2020 2020 2020 2063 6f6e  ut],.        con
+0002a470: 6669 673a 204f 7074 696f 6e61 6c5b 556e  fig: Optional[Un
+0002a480: 696f 6e5b 5275 6e6e 6162 6c65 436f 6e66  ion[RunnableConf
+0002a490: 6967 2c20 4c69 7374 5b52 756e 6e61 626c  ig, List[Runnabl
+0002a4a0: 6543 6f6e 6669 675d 5d5d 203d 204e 6f6e  eConfig]]] = Non
+0002a4b0: 652c 0a20 2020 2020 2020 202a 2c0a 2020  e,.        *,.  
+0002a4c0: 2020 2020 2020 7265 7475 726e 5f65 7863        return_exc
+0002a4d0: 6570 7469 6f6e 733a 2062 6f6f 6c20 3d20  eptions: bool = 
+0002a4e0: 4661 6c73 652c 0a20 2020 2020 2020 202a  False,.        *
+0002a4f0: 2a6b 7761 7267 733a 204f 7074 696f 6e61  *kwargs: Optiona
+0002a500: 6c5b 416e 795d 2c0a 2020 2020 2920 2d3e  l[Any],.    ) ->
+0002a510: 2049 7465 7261 746f 725b 5475 706c 655b   Iterator[Tuple[
+0002a520: 696e 742c 2055 6e69 6f6e 5b4f 7574 7075  int, Union[Outpu
+0002a530: 742c 2045 7863 6570 7469 6f6e 5d5d 5d3a  t, Exception]]]:
+0002a540: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+0002a550: 7374 616e 6365 2863 6f6e 6669 672c 206c  stance(config, l
+0002a560: 6973 7429 3a0a 2020 2020 2020 2020 2020  ist):.          
+0002a570: 2020 636f 6e66 6967 7320 3d20 6361 7374    configs = cast
+0002a580: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002a590: 2020 4c69 7374 5b52 756e 6e61 626c 6543    List[RunnableC
+0002a5a0: 6f6e 6669 675d 2c0a 2020 2020 2020 2020  onfig],.        
+0002a5b0: 2020 2020 2020 2020 5b73 656c 662e 5f6d          [self._m
+0002a5c0: 6572 6765 5f63 6f6e 6669 6773 2863 6f6e  erge_configs(con
+0002a5d0: 6629 2066 6f72 2063 6f6e 6620 696e 2063  f) for conf in c
+0002a5e0: 6f6e 6669 675d 2c0a 2020 2020 2020 2020  onfig],.        
+0002a5f0: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
+0002a600: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0002a610: 636f 6e66 6967 7320 3d20 5b73 656c 662e  configs = [self.
+0002a620: 5f6d 6572 6765 5f63 6f6e 6669 6773 2863  _merge_configs(c
+0002a630: 6f6e 6669 6729 2066 6f72 205f 2069 6e20  onfig) for _ in 
+0002a640: 7261 6e67 6528 6c65 6e28 696e 7075 7473  range(len(inputs
+0002a650: 2929 5d0a 2020 2020 2020 2020 2320 6c6f  ))].        # lo
+0002a660: 6c20 6d79 7079 0a20 2020 2020 2020 2069  l mypy.        i
+0002a670: 6620 7265 7475 726e 5f65 7863 6570 7469  f return_excepti
+0002a680: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+0002a690: 2079 6965 6c64 2066 726f 6d20 7365 6c66   yield from self
+0002a6a0: 2e62 6f75 6e64 2e62 6174 6368 5f61 735f  .bound.batch_as_
+0002a6b0: 636f 6d70 6c65 7465 6428 0a20 2020 2020  completed(.     
+0002a6c0: 2020 2020 2020 2020 2020 2069 6e70 7574             input
+0002a6d0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0002a6e0: 2020 2063 6f6e 6669 6773 2c0a 2020 2020     configs,.    
+0002a6f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002a700: 726e 5f65 7863 6570 7469 6f6e 733d 7265  rn_exceptions=re
+0002a710: 7475 726e 5f65 7863 6570 7469 6f6e 732c  turn_exceptions,
+0002a720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a730: 202a 2a7b 2a2a 7365 6c66 2e6b 7761 7267   **{**self.kwarg
+0002a740: 732c 202a 2a6b 7761 7267 737d 2c0a 2020  s, **kwargs},.  
+0002a750: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0002a760: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0002a770: 2020 2020 2020 7969 656c 6420 6672 6f6d        yield from
+0002a780: 2073 656c 662e 626f 756e 642e 6261 7463   self.bound.batc
+0002a790: 685f 6173 5f63 6f6d 706c 6574 6564 280a  h_as_completed(.
+0002a7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a7b0: 696e 7075 7473 2c0a 2020 2020 2020 2020  inputs,.        
+0002a7c0: 2020 2020 2020 2020 636f 6e66 6967 732c          configs,
+0002a7d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a7e0: 2072 6574 7572 6e5f 6578 6365 7074 696f   return_exceptio
+0002a7f0: 6e73 3d72 6574 7572 6e5f 6578 6365 7074  ns=return_except
+0002a800: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
+0002a810: 2020 2020 2020 2a2a 7b2a 2a73 656c 662e        **{**self.
+0002a820: 6b77 6172 6773 2c20 2a2a 6b77 6172 6773  kwargs, **kwargs
+0002a830: 7d2c 0a20 2020 2020 2020 2020 2020 2029  },.            )
+0002a840: 0a0a 2020 2020 406f 7665 726c 6f61 640a  ..    @overload.
+0002a850: 2020 2020 6465 6620 6162 6174 6368 5f61      def abatch_a
+0002a860: 735f 636f 6d70 6c65 7465 6428 0a20 2020  s_completed(.   
+0002a870: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0002a880: 2020 2069 6e70 7574 733a 204c 6973 745b     inputs: List[
+0002a890: 496e 7075 745d 2c0a 2020 2020 2020 2020  Input],.        
+0002a8a0: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
+0002a8b0: 5b55 6e69 6f6e 5b52 756e 6e61 626c 6543  [Union[RunnableC
+0002a8c0: 6f6e 6669 672c 204c 6973 745b 5275 6e6e  onfig, List[Runn
+0002a8d0: 6162 6c65 436f 6e66 6967 5d5d 5d20 3d20  ableConfig]]] = 
+0002a8e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2a2c  None,.        *,
+0002a8f0: 0a20 2020 2020 2020 2072 6574 7572 6e5f  .        return_
+0002a900: 6578 6365 7074 696f 6e73 3a20 4c69 7465  exceptions: Lite
+0002a910: 7261 6c5b 4661 6c73 655d 203d 2046 616c  ral[False] = Fal
+0002a920: 7365 2c0a 2020 2020 2020 2020 2a2a 6b77  se,.        **kw
+0002a930: 6172 6773 3a20 4f70 7469 6f6e 616c 5b41  args: Optional[A
+0002a940: 6e79 5d2c 0a20 2020 2029 202d 3e20 4173  ny],.    ) -> As
+0002a950: 796e 6349 7465 7261 746f 725b 5475 706c  yncIterator[Tupl
+0002a960: 655b 696e 742c 204f 7574 7075 745d 5d3a  e[int, Output]]:
+0002a970: 0a20 2020 2020 2020 202e 2e2e 0a0a 2020  .        .....  
+0002a980: 2020 406f 7665 726c 6f61 640a 2020 2020    @overload.    
+0002a990: 6465 6620 6162 6174 6368 5f61 735f 636f  def abatch_as_co
+0002a9a0: 6d70 6c65 7465 6428 0a20 2020 2020 2020  mpleted(.       
+0002a9b0: 2073 656c 662c 0a20 2020 2020 2020 2069   self,.        i
+0002a9c0: 6e70 7574 733a 204c 6973 745b 496e 7075  nputs: List[Inpu
+0002a9d0: 745d 2c0a 2020 2020 2020 2020 636f 6e66  t],.        conf
+0002a9e0: 6967 3a20 4f70 7469 6f6e 616c 5b55 6e69  ig: Optional[Uni
+0002a9f0: 6f6e 5b52 756e 6e61 626c 6543 6f6e 6669  on[RunnableConfi
+0002aa00: 672c 204c 6973 745b 5275 6e6e 6162 6c65  g, List[Runnable
+0002aa10: 436f 6e66 6967 5d5d 5d20 3d20 4e6f 6e65  Config]]] = None
+0002aa20: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
+0002aa30: 2020 2020 2072 6574 7572 6e5f 6578 6365       return_exce
+0002aa40: 7074 696f 6e73 3a20 4c69 7465 7261 6c5b  ptions: Literal[
+0002aa50: 5472 7565 5d2c 0a20 2020 2020 2020 202a  True],.        *
+0002aa60: 2a6b 7761 7267 733a 204f 7074 696f 6e61  *kwargs: Optiona
+0002aa70: 6c5b 416e 795d 2c0a 2020 2020 2920 2d3e  l[Any],.    ) ->
+0002aa80: 2041 7379 6e63 4974 6572 6174 6f72 5b54   AsyncIterator[T
+0002aa90: 7570 6c65 5b69 6e74 2c20 556e 696f 6e5b  uple[int, Union[
+0002aaa0: 4f75 7470 7574 2c20 4578 6365 7074 696f  Output, Exceptio
+0002aab0: 6e5d 5d5d 3a0a 2020 2020 2020 2020 2e2e  n]]]:.        ..
+0002aac0: 2e0a 0a20 2020 2061 7379 6e63 2064 6566  ...    async def
+0002aad0: 2061 6261 7463 685f 6173 5f63 6f6d 706c   abatch_as_compl
+0002aae0: 6574 6564 280a 2020 2020 2020 2020 7365  eted(.        se
+0002aaf0: 6c66 2c0a 2020 2020 2020 2020 696e 7075  lf,.        inpu
+0002ab00: 7473 3a20 4c69 7374 5b49 6e70 7574 5d2c  ts: List[Input],
+0002ab10: 0a20 2020 2020 2020 2063 6f6e 6669 673a  .        config:
+0002ab20: 204f 7074 696f 6e61 6c5b 556e 696f 6e5b   Optional[Union[
+0002ab30: 5275 6e6e 6162 6c65 436f 6e66 6967 2c20  RunnableConfig, 
+0002ab40: 4c69 7374 5b52 756e 6e61 626c 6543 6f6e  List[RunnableCon
+0002ab50: 6669 675d 5d5d 203d 204e 6f6e 652c 0a20  fig]]] = None,. 
+0002ab60: 2020 2020 2020 202a 2c0a 2020 2020 2020         *,.      
+0002ab70: 2020 7265 7475 726e 5f65 7863 6570 7469    return_excepti
+0002ab80: 6f6e 733a 2062 6f6f 6c20 3d20 4661 6c73  ons: bool = Fals
+0002ab90: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
+0002aba0: 7267 733a 204f 7074 696f 6e61 6c5b 416e  rgs: Optional[An
+0002abb0: 795d 2c0a 2020 2020 2920 2d3e 2041 7379  y],.    ) -> Asy
+0002abc0: 6e63 4974 6572 6174 6f72 5b54 7570 6c65  ncIterator[Tuple
+0002abd0: 5b69 6e74 2c20 556e 696f 6e5b 4f75 7470  [int, Union[Outp
+0002abe0: 7574 2c20 4578 6365 7074 696f 6e5d 5d5d  ut, Exception]]]
+0002abf0: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
+0002ac00: 6e73 7461 6e63 6528 636f 6e66 6967 2c20  nstance(config, 
+0002ac10: 6c69 7374 293a 0a20 2020 2020 2020 2020  list):.         
+0002ac20: 2020 2063 6f6e 6669 6773 203d 2063 6173     configs = cas
+0002ac30: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+0002ac40: 2020 204c 6973 745b 5275 6e6e 6162 6c65     List[Runnable
+0002ac50: 436f 6e66 6967 5d2c 0a20 2020 2020 2020  Config],.       
+0002ac60: 2020 2020 2020 2020 205b 7365 6c66 2e5f           [self._
+0002ac70: 6d65 7267 655f 636f 6e66 6967 7328 636f  merge_configs(co
+0002ac80: 6e66 2920 666f 7220 636f 6e66 2069 6e20  nf) for conf in 
+0002ac90: 636f 6e66 6967 5d2c 0a20 2020 2020 2020  config],.       
+0002aca0: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
+0002acb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0002acc0: 2063 6f6e 6669 6773 203d 205b 7365 6c66   configs = [self
+0002acd0: 2e5f 6d65 7267 655f 636f 6e66 6967 7328  ._merge_configs(
+0002ace0: 636f 6e66 6967 2920 666f 7220 5f20 696e  config) for _ in
+0002acf0: 2072 616e 6765 286c 656e 2869 6e70 7574   range(len(input
+0002ad00: 7329 295d 0a20 2020 2020 2020 2069 6620  s))].        if 
+0002ad10: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
+0002ad20: 733a 0a20 2020 2020 2020 2020 2020 2061  s:.            a
+0002ad30: 7379 6e63 2066 6f72 2069 7465 6d20 696e  sync for item in
+0002ad40: 2073 656c 662e 626f 756e 642e 6162 6174   self.bound.abat
+0002ad50: 6368 5f61 735f 636f 6d70 6c65 7465 6428  ch_as_completed(
+0002ad60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ad70: 2069 6e70 7574 732c 0a20 2020 2020 2020   inputs,.       
+0002ad80: 2020 2020 2020 2020 2063 6f6e 6669 6773           configs
+0002ad90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002ada0: 2020 7265 7475 726e 5f65 7863 6570 7469    return_excepti
+0002adb0: 6f6e 733d 7265 7475 726e 5f65 7863 6570  ons=return_excep
+0002adc0: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
+0002add0: 2020 2020 2020 202a 2a7b 2a2a 7365 6c66         **{**self
+0002ade0: 2e6b 7761 7267 732c 202a 2a6b 7761 7267  .kwargs, **kwarg
+0002adf0: 737d 2c0a 2020 2020 2020 2020 2020 2020  s},.            
+0002ae00: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0002ae10: 2020 2079 6965 6c64 2069 7465 6d0a 2020     yield item.  
+0002ae20: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0002ae30: 2020 2020 2020 2020 6173 796e 6320 666f          async fo
+0002ae40: 7220 6974 656d 2069 6e20 7365 6c66 2e62  r item in self.b
+0002ae50: 6f75 6e64 2e61 6261 7463 685f 6173 5f63  ound.abatch_as_c
+0002ae60: 6f6d 706c 6574 6564 280a 2020 2020 2020  ompleted(.      
+0002ae70: 2020 2020 2020 2020 2020 696e 7075 7473            inputs
+0002ae80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002ae90: 2020 636f 6e66 6967 732c 0a20 2020 2020    configs,.     
+0002aea0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0002aeb0: 6e5f 6578 6365 7074 696f 6e73 3d72 6574  n_exceptions=ret
+0002aec0: 7572 6e5f 6578 6365 7074 696f 6e73 2c0a  urn_exceptions,.
+0002aed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aee0: 2a2a 7b2a 2a73 656c 662e 6b77 6172 6773  **{**self.kwargs
+0002aef0: 2c20 2a2a 6b77 6172 6773 7d2c 0a20 2020  , **kwargs},.   
+0002af00: 2020 2020 2020 2020 2029 3a0a 2020 2020           ):.    
+0002af10: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
+0002af20: 6420 6974 656d 0a0a 2020 2020 6465 6620  d item..    def 
+0002af30: 7374 7265 616d 280a 2020 2020 2020 2020  stream(.        
+0002af40: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
+0002af50: 7075 743a 2049 6e70 7574 2c0a 2020 2020  put: Input,.    
+0002af60: 2020 2020 636f 6e66 6967 3a20 4f70 7469      config: Opti
+0002af70: 6f6e 616c 5b52 756e 6e61 626c 6543 6f6e  onal[RunnableCon
+0002af80: 6669 675d 203d 204e 6f6e 652c 0a20 2020  fig] = None,.   
+0002af90: 2020 2020 202a 2a6b 7761 7267 733a 204f       **kwargs: O
+0002afa0: 7074 696f 6e61 6c5b 416e 795d 2c0a 2020  ptional[Any],.  
+0002afb0: 2020 2920 2d3e 2049 7465 7261 746f 725b    ) -> Iterator[
+0002afc0: 4f75 7470 7574 5d3a 0a20 2020 2020 2020  Output]:.       
+0002afd0: 2079 6965 6c64 2066 726f 6d20 7365 6c66   yield from self
+0002afe0: 2e62 6f75 6e64 2e73 7472 6561 6d28 0a20  .bound.stream(. 
+0002aff0: 2020 2020 2020 2020 2020 2069 6e70 7574             input
+0002b000: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
+0002b010: 6c66 2e5f 6d65 7267 655f 636f 6e66 6967  lf._merge_config
+0002b020: 7328 636f 6e66 6967 292c 0a20 2020 2020  s(config),.     
+0002b030: 2020 2020 2020 202a 2a7b 2a2a 7365 6c66         **{**self
+0002b040: 2e6b 7761 7267 732c 202a 2a6b 7761 7267  .kwargs, **kwarg
+0002b050: 737d 2c0a 2020 2020 2020 2020 290a 0a20  s},.        ).. 
+0002b060: 2020 2061 7379 6e63 2064 6566 2061 7374     async def ast
+0002b070: 7265 616d 280a 2020 2020 2020 2020 7365  ream(.        se
+0002b080: 6c66 2c0a 2020 2020 2020 2020 696e 7075  lf,.        inpu
+0002b090: 743a 2049 6e70 7574 2c0a 2020 2020 2020  t: Input,.      
+0002b0a0: 2020 636f 6e66 6967 3a20 4f70 7469 6f6e    config: Option
+0002b0b0: 616c 5b52 756e 6e61 626c 6543 6f6e 6669  al[RunnableConfi
+0002b0c0: 675d 203d 204e 6f6e 652c 0a20 2020 2020  g] = None,.     
+0002b0d0: 2020 202a 2a6b 7761 7267 733a 204f 7074     **kwargs: Opt
+0002b0e0: 696f 6e61 6c5b 416e 795d 2c0a 2020 2020  ional[Any],.    
+0002b0f0: 2920 2d3e 2041 7379 6e63 4974 6572 6174  ) -> AsyncIterat
+0002b100: 6f72 5b4f 7574 7075 745d 3a0a 2020 2020  or[Output]:.    
+0002b110: 2020 2020 6173 796e 6320 666f 7220 6974      async for it
+0002b120: 656d 2069 6e20 7365 6c66 2e62 6f75 6e64  em in self.bound
+0002b130: 2e61 7374 7265 616d 280a 2020 2020 2020  .astream(.      
+0002b140: 2020 2020 2020 696e 7075 742c 0a20 2020        input,.   
+0002b150: 2020 2020 2020 2020 2073 656c 662e 5f6d           self._m
+0002b160: 6572 6765 5f63 6f6e 6669 6773 2863 6f6e  erge_configs(con
+0002b170: 6669 6729 2c0a 2020 2020 2020 2020 2020  fig),.          
+0002b180: 2020 2a2a 7b2a 2a73 656c 662e 6b77 6172    **{**self.kwar
+0002b190: 6773 2c20 2a2a 6b77 6172 6773 7d2c 0a20  gs, **kwargs},. 
+0002b1a0: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
+0002b1b0: 2020 2020 2020 7969 656c 6420 6974 656d        yield item
+0002b1c0: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+0002b1d0: 6173 7472 6561 6d5f 6576 656e 7473 280a  astream_events(.
+0002b1e0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+0002b1f0: 2020 2020 2020 696e 7075 743a 2049 6e70        input: Inp
+0002b200: 7574 2c0a 2020 2020 2020 2020 636f 6e66  ut,.        conf
+0002b210: 6967 3a20 4f70 7469 6f6e 616c 5b52 756e  ig: Optional[Run
+0002b220: 6e61 626c 6543 6f6e 6669 675d 203d 204e  nableConfig] = N
+0002b230: 6f6e 652c 0a20 2020 2020 2020 202a 2a6b  one,.        **k
+0002b240: 7761 7267 733a 204f 7074 696f 6e61 6c5b  wargs: Optional[
+0002b250: 416e 795d 2c0a 2020 2020 2920 2d3e 2041  Any],.    ) -> A
+0002b260: 7379 6e63 4974 6572 6174 6f72 5b53 7472  syncIterator[Str
+0002b270: 6561 6d45 7665 6e74 5d3a 0a20 2020 2020  eamEvent]:.     
+0002b280: 2020 2061 7379 6e63 2066 6f72 2069 7465     async for ite
+0002b290: 6d20 696e 2073 656c 662e 626f 756e 642e  m in self.bound.
+0002b2a0: 6173 7472 6561 6d5f 6576 656e 7473 280a  astream_events(.
+0002b2b0: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+0002b2c0: 742c 2073 656c 662e 5f6d 6572 6765 5f63  t, self._merge_c
+0002b2d0: 6f6e 6669 6773 2863 6f6e 6669 6729 2c20  onfigs(config), 
+0002b2e0: 2a2a 7b2a 2a73 656c 662e 6b77 6172 6773  **{**self.kwargs
+0002b2f0: 2c20 2a2a 6b77 6172 6773 7d0a 2020 2020  , **kwargs}.    
+0002b300: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+0002b310: 2020 2079 6965 6c64 2069 7465 6d0a 0a20     yield item.. 
+0002b320: 2020 2064 6566 2074 7261 6e73 666f 726d     def transform
+0002b330: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+0002b340: 2020 2020 2020 2020 696e 7075 743a 2049          input: I
+0002b350: 7465 7261 746f 725b 496e 7075 745d 2c0a  terator[Input],.
+0002b360: 2020 2020 2020 2020 636f 6e66 6967 3a20          config: 
+0002b370: 4f70 7469 6f6e 616c 5b52 756e 6e61 626c  Optional[Runnabl
+0002b380: 6543 6f6e 6669 675d 203d 204e 6f6e 652c  eConfig] = None,
+0002b390: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+0002b3a0: 733a 2041 6e79 2c0a 2020 2020 2920 2d3e  s: Any,.    ) ->
+0002b3b0: 2049 7465 7261 746f 725b 4f75 7470 7574   Iterator[Output
+0002b3c0: 5d3a 0a20 2020 2020 2020 2079 6965 6c64  ]:.        yield
+0002b3d0: 2066 726f 6d20 7365 6c66 2e62 6f75 6e64   from self.bound
+0002b3e0: 2e74 7261 6e73 666f 726d 280a 2020 2020  .transform(.    
+0002b3f0: 2020 2020 2020 2020 696e 7075 742c 0a20          input,. 
+0002b400: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0002b410: 5f6d 6572 6765 5f63 6f6e 6669 6773 2863  _merge_configs(c
+0002b420: 6f6e 6669 6729 2c0a 2020 2020 2020 2020  onfig),.        
+0002b430: 2020 2020 2a2a 7b2a 2a73 656c 662e 6b77      **{**self.kw
+0002b440: 6172 6773 2c20 2a2a 6b77 6172 6773 7d2c  args, **kwargs},
+0002b450: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0002b460: 6173 796e 6320 6465 6620 6174 7261 6e73  async def atrans
+0002b470: 666f 726d 280a 2020 2020 2020 2020 7365  form(.        se
+0002b480: 6c66 2c0a 2020 2020 2020 2020 696e 7075  lf,.        inpu
+0002b490: 743a 2041 7379 6e63 4974 6572 6174 6f72  t: AsyncIterator
+0002b4a0: 5b49 6e70 7574 5d2c 0a20 2020 2020 2020  [Input],.       
+0002b4b0: 2063 6f6e 6669 673a 204f 7074 696f 6e61   config: Optiona
+0002b4c0: 6c5b 5275 6e6e 6162 6c65 436f 6e66 6967  l[RunnableConfig
+0002b4d0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0002b4e0: 2020 2a2a 6b77 6172 6773 3a20 416e 792c    **kwargs: Any,
+0002b4f0: 0a20 2020 2029 202d 3e20 4173 796e 6349  .    ) -> AsyncI
+0002b500: 7465 7261 746f 725b 4f75 7470 7574 5d3a  terator[Output]:
+0002b510: 0a20 2020 2020 2020 2061 7379 6e63 2066  .        async f
+0002b520: 6f72 2069 7465 6d20 696e 2073 656c 662e  or item in self.
+0002b530: 626f 756e 642e 6174 7261 6e73 666f 726d  bound.atransform
+0002b540: 280a 2020 2020 2020 2020 2020 2020 696e  (.            in
+0002b550: 7075 742c 0a20 2020 2020 2020 2020 2020  put,.           
+0002b560: 2073 656c 662e 5f6d 6572 6765 5f63 6f6e   self._merge_con
+0002b570: 6669 6773 2863 6f6e 6669 6729 2c0a 2020  figs(config),.  
+0002b580: 2020 2020 2020 2020 2020 2a2a 7b2a 2a73            **{**s
+0002b590: 656c 662e 6b77 6172 6773 2c20 2a2a 6b77  elf.kwargs, **kw
+0002b5a0: 6172 6773 7d2c 0a20 2020 2020 2020 2029  args},.        )
+0002b5b0: 3a0a 2020 2020 2020 2020 2020 2020 7969  :.            yi
+0002b5c0: 656c 6420 6974 656d 0a0a 0a52 756e 6e61  eld item...Runna
+0002b5d0: 626c 6542 696e 6469 6e67 4261 7365 2e75  bleBindingBase.u
+0002b5e0: 7064 6174 655f 666f 7277 6172 645f 7265  pdate_forward_re
+0002b5f0: 6673 2852 756e 6e61 626c 6543 6f6e 6669  fs(RunnableConfi
+0002b600: 673d 5275 6e6e 6162 6c65 436f 6e66 6967  g=RunnableConfig
+0002b610: 290a 0a0a 636c 6173 7320 5275 6e6e 6162  )...class Runnab
+0002b620: 6c65 4269 6e64 696e 6728 5275 6e6e 6162  leBinding(Runnab
+0002b630: 6c65 4269 6e64 696e 6742 6173 655b 496e  leBindingBase[In
+0002b640: 7075 742c 204f 7574 7075 745d 293a 0a20  put, Output]):. 
+0002b650: 2020 2022 2222 5772 6170 2061 2052 756e     """Wrap a Run
+0002b660: 6e61 626c 6520 7769 7468 2061 6464 6974  nable with addit
+0002b670: 696f 6e61 6c20 6675 6e63 7469 6f6e 616c  ional functional
+0002b680: 6974 792e 0a0a 2020 2020 4120 5275 6e6e  ity...    A Runn
+0002b690: 6162 6c65 4269 6e64 696e 6720 6361 6e20  ableBinding can 
+0002b6a0: 6265 2074 686f 7567 6874 206f 6620 6173  be thought of as
+0002b6b0: 2061 2022 7275 6e6e 6162 6c65 2064 6563   a "runnable dec
+0002b6c0: 6f72 6174 6f72 2220 7468 6174 0a20 2020  orator" that.   
+0002b6d0: 2070 7265 7365 7276 6573 2074 6865 2065   preserves the e
+0002b6e0: 7373 656e 7469 616c 2066 6561 7475 7265  ssential feature
+0002b6f0: 7320 6f66 2052 756e 6e61 626c 653b 2069  s of Runnable; i
+0002b700: 2e65 2e2c 2062 6174 6368 696e 672c 2073  .e., batching, s
+0002b710: 7472 6561 6d69 6e67 2c0a 2020 2020 616e  treaming,.    an
+0002b720: 6420 6173 796e 6320 7375 7070 6f72 742c  d async support,
+0002b730: 2077 6869 6c65 2061 6464 696e 6720 6164   while adding ad
+0002b740: 6469 7469 6f6e 616c 2066 756e 6374 696f  ditional functio
+0002b750: 6e61 6c69 7479 2e0a 0a20 2020 2041 6e79  nality...    Any
+0002b760: 2063 6c61 7373 2074 6861 7420 696e 6865   class that inhe
+0002b770: 7269 7473 2066 726f 6d20 5275 6e6e 6162  rits from Runnab
+0002b780: 6c65 2063 616e 2062 6520 626f 756e 6420  le can be bound 
+0002b790: 746f 2061 2060 5275 6e6e 6162 6c65 4269  to a `RunnableBi
+0002b7a0: 6e64 696e 6760 2e0a 2020 2020 5275 6e6e  nding`..    Runn
+0002b7b0: 6162 6c65 7320 6578 706f 7365 2061 2073  ables expose a s
+0002b7c0: 7461 6e64 6172 6420 7365 7420 6f66 206d  tandard set of m
+0002b7d0: 6574 686f 6473 2066 6f72 2063 7265 6174  ethods for creat
+0002b7e0: 696e 6720 6052 756e 6e61 626c 6542 696e  ing `RunnableBin
+0002b7f0: 6469 6e67 7360 0a20 2020 206f 7220 7375  dings`.    or su
+0002b800: 622d 636c 6173 7365 7320 6f66 2060 5275  b-classes of `Ru
+0002b810: 6e6e 6162 6c65 4269 6e64 696e 6773 6020  nnableBindings` 
+0002b820: 2865 2e67 2e2c 2060 5275 6e6e 6162 6c65  (e.g., `Runnable
+0002b830: 5265 7472 7960 2c0a 2020 2020 6052 756e  Retry`,.    `Run
+0002b840: 6e61 626c 6557 6974 6846 616c 6c62 6163  nableWithFallbac
+0002b850: 6b73 6029 2074 6861 7420 6164 6420 6164  ks`) that add ad
+0002b860: 6469 7469 6f6e 616c 2066 756e 6374 696f  ditional functio
+0002b870: 6e61 6c69 7479 2e0a 0a20 2020 2054 6865  nality...    The
+0002b880: 7365 206d 6574 686f 6473 2069 6e63 6c75  se methods inclu
+0002b890: 6465 3a0a 2020 2020 2d20 6062 696e 6460  de:.    - `bind`
+0002b8a0: 3a20 4269 6e64 206b 7761 7267 7320 746f  : Bind kwargs to
+0002b8b0: 2070 6173 7320 746f 2074 6865 2075 6e64   pass to the und
+0002b8c0: 6572 6c79 696e 6720 7275 6e6e 6162 6c65  erlying runnable
+0002b8d0: 2077 6865 6e20 7275 6e6e 696e 6720 6974   when running it
+0002b8e0: 2e0a 2020 2020 2d20 6077 6974 685f 636f  ..    - `with_co
+0002b8f0: 6e66 6967 603a 2042 696e 6420 636f 6e66  nfig`: Bind conf
+0002b900: 6967 2074 6f20 7061 7373 2074 6f20 7468  ig to pass to th
+0002b910: 6520 756e 6465 726c 7969 6e67 2072 756e  e underlying run
+0002b920: 6e61 626c 6520 7768 656e 2072 756e 6e69  nable when runni
+0002b930: 6e67 2069 742e 0a20 2020 202d 2060 7769  ng it..    - `wi
+0002b940: 7468 5f6c 6973 7465 6e65 7273 603a 2020  th_listeners`:  
+0002b950: 4269 6e64 206c 6966 6563 7963 6c65 206c  Bind lifecycle l
+0002b960: 6973 7465 6e65 7273 2074 6f20 7468 6520  isteners to the 
+0002b970: 756e 6465 726c 7969 6e67 2072 756e 6e61  underlying runna
+0002b980: 626c 652e 0a20 2020 202d 2060 7769 7468  ble..    - `with
+0002b990: 5f74 7970 6573 603a 204f 7665 7272 6964  _types`: Overrid
+0002b9a0: 6520 7468 6520 696e 7075 7420 616e 6420  e the input and 
+0002b9b0: 6f75 7470 7574 2074 7970 6573 206f 6620  output types of 
+0002b9c0: 7468 6520 756e 6465 726c 7969 6e67 2072  the underlying r
+0002b9d0: 756e 6e61 626c 652e 0a20 2020 202d 2060  unnable..    - `
+0002b9e0: 7769 7468 5f72 6574 7279 603a 2042 696e  with_retry`: Bin
+0002b9f0: 6420 6120 7265 7472 7920 706f 6c69 6379  d a retry policy
+0002ba00: 2074 6f20 7468 6520 756e 6465 726c 7969   to the underlyi
+0002ba10: 6e67 2072 756e 6e61 626c 652e 0a20 2020  ng runnable..   
+0002ba20: 202d 2060 7769 7468 5f66 616c 6c62 6163   - `with_fallbac
+0002ba30: 6b73 603a 2042 696e 6420 6120 6661 6c6c  ks`: Bind a fall
+0002ba40: 6261 636b 2070 6f6c 6963 7920 746f 2074  back policy to t
+0002ba50: 6865 2075 6e64 6572 6c79 696e 6720 7275  he underlying ru
+0002ba60: 6e6e 6162 6c65 2e0a 0a20 2020 2045 7861  nnable...    Exa
+0002ba70: 6d70 6c65 3a0a 0a20 2020 2060 6269 6e64  mple:..    `bind
+0002ba80: 603a 2042 696e 6420 6b77 6172 6773 2074  `: Bind kwargs t
+0002ba90: 6f20 7061 7373 2074 6f20 7468 6520 756e  o pass to the un
+0002baa0: 6465 726c 7969 6e67 2072 756e 6e61 626c  derlying runnabl
+0002bab0: 6520 7768 656e 2072 756e 6e69 6e67 2069  e when running i
+0002bac0: 742e 0a0a 2020 2020 2020 2020 2e2e 2063  t...        .. c
+0002bad0: 6f64 652d 626c 6f63 6b3a 3a20 7079 7468  ode-block:: pyth
+0002bae0: 6f6e 0a0a 2020 2020 2020 2020 2020 2020  on..            
+0002baf0: 2320 4372 6561 7465 2061 2072 756e 6e61  # Create a runna
+0002bb00: 626c 6520 6269 6e64 696e 6720 7468 6174  ble binding that
+0002bb10: 2069 6e76 6f6b 6573 2074 6865 2043 6861   invokes the Cha
+0002bb20: 744d 6f64 656c 2077 6974 6820 7468 650a  tModel with the.
+0002bb30: 2020 2020 2020 2020 2020 2020 2320 6164              # ad
+0002bb40: 6469 7469 6f6e 616c 206b 7761 7267 2060  ditional kwarg `
+0002bb50: 7374 6f70 3d5b 272d 275d 6020 7768 656e  stop=['-']` when
+0002bb60: 2072 756e 6e69 6e67 2069 742e 0a20 2020   running it..   
+0002bb70: 2020 2020 2020 2020 2066 726f 6d20 6c61           from la
+0002bb80: 6e67 6368 6169 6e5f 636f 6d6d 756e 6974  ngchain_communit
+0002bb90: 792e 6368 6174 5f6d 6f64 656c 7320 696d  y.chat_models im
+0002bba0: 706f 7274 2043 6861 744f 7065 6e41 490a  port ChatOpenAI.
+0002bbb0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+0002bbc0: 6c20 3d20 4368 6174 4f70 656e 4149 2829  l = ChatOpenAI()
+0002bbd0: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
+0002bbe0: 656c 2e69 6e76 6f6b 6528 2753 6179 2022  el.invoke('Say "
+0002bbf0: 5061 7272 6f74 2d4d 4147 4943 2227 2c20  Parrot-MAGIC"', 
+0002bc00: 7374 6f70 3d5b 272d 275d 2920 2320 5368  stop=['-']) # Sh
+0002bc10: 6f75 6c64 2072 6574 7572 6e20 6050 6172  ould return `Par
+0002bc20: 726f 7460 0a20 2020 2020 2020 2020 2020  rot`.           
+0002bc30: 2023 2055 7369 6e67 2069 7420 7468 6520   # Using it the 
+0002bc40: 6561 7379 2077 6179 2076 6961 2060 6269  easy way via `bi
+0002bc50: 6e64 6020 6d65 7468 6f64 2077 6869 6368  nd` method which
+0002bc60: 2072 6574 7572 6e73 2061 206e 6577 0a20   returns a new. 
+0002bc70: 2020 2020 2020 2020 2020 2023 2052 756e             # Run
+0002bc80: 6e61 626c 6542 696e 6469 6e67 0a20 2020  nableBinding.   
+0002bc90: 2020 2020 2020 2020 2072 756e 6e61 626c           runnabl
+0002bca0: 655f 6269 6e64 696e 6720 3d20 6d6f 6465  e_binding = mode
+0002bcb0: 6c2e 6269 6e64 2873 746f 703d 5b27 2d27  l.bind(stop=['-'
+0002bcc0: 5d29 0a20 2020 2020 2020 2020 2020 2072  ]).            r
+0002bcd0: 756e 6e61 626c 655f 6269 6e64 696e 672e  unnable_binding.
+0002bce0: 696e 766f 6b65 2827 5361 7920 2250 6172  invoke('Say "Par
+0002bcf0: 726f 742d 4d41 4749 4322 2729 2023 2053  rot-MAGIC"') # S
+0002bd00: 686f 756c 6420 7265 7475 726e 2060 5061  hould return `Pa
+0002bd10: 7272 6f74 600a 0a20 2020 2020 2020 2043  rrot`..        C
+0002bd20: 616e 2061 6c73 6f20 6265 2064 6f6e 6520  an also be done 
+0002bd30: 6279 2069 6e73 7461 6e74 6961 7469 6e67  by instantiating
+0002bd40: 2061 2052 756e 6e61 626c 6542 696e 6469   a RunnableBindi
+0002bd50: 6e67 2064 6972 6563 746c 7920 286e 6f74  ng directly (not
+0002bd60: 2072 6563 6f6d 6d65 6e64 6564 293a 0a0a   recommended):..
+0002bd70: 2020 2020 2020 2020 2e2e 2063 6f64 652d          .. code-
+0002bd80: 626c 6f63 6b3a 3a20 7079 7468 6f6e 0a0a  block:: python..
+0002bd90: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
+0002bda0: 206c 616e 6763 6861 696e 5f63 6f72 652e   langchain_core.
+0002bdb0: 7275 6e6e 6162 6c65 7320 696d 706f 7274  runnables import
+0002bdc0: 2052 756e 6e61 626c 6542 696e 6469 6e67   RunnableBinding
+0002bdd0: 0a20 2020 2020 2020 2020 2020 2072 756e  .            run
+0002bde0: 6e61 626c 655f 6269 6e64 696e 6720 3d20  nable_binding = 
+0002bdf0: 5275 6e6e 6162 6c65 4269 6e64 696e 6728  RunnableBinding(
+0002be00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002be10: 2062 6f75 6e64 3d6d 6f64 656c 2c0a 2020   bound=model,.  
+0002be20: 2020 2020 2020 2020 2020 2020 2020 6b77                kw
+0002be30: 6172 6773 3d7b 2773 746f 7027 3a20 5b27  args={'stop': ['
+0002be40: 2d27 5d7d 2023 203c 2d2d 204e 6f74 6520  -']} # <-- Note 
+0002be50: 7468 6520 6164 6469 7469 6f6e 616c 206b  the additional k
+0002be60: 7761 7267 730a 2020 2020 2020 2020 2020  wargs.          
+0002be70: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0002be80: 7275 6e6e 6162 6c65 5f62 696e 6469 6e67  runnable_binding
+0002be90: 2e69 6e76 6f6b 6528 2753 6179 2022 5061  .invoke('Say "Pa
+0002bea0: 7272 6f74 2d4d 4147 4943 2227 2920 2320  rrot-MAGIC"') # 
+0002beb0: 5368 6f75 6c64 2072 6574 7572 6e20 6050  Should return `P
+0002bec0: 6172 726f 7460 0a20 2020 2022 2222 0a0a  arrot`.    """..
+0002bed0: 2020 2020 4063 6c61 7373 6d65 7468 6f64      @classmethod
+0002bee0: 0a20 2020 2064 6566 2067 6574 5f6c 635f  .    def get_lc_
+0002bef0: 6e61 6d65 7370 6163 6528 636c 7329 202d  namespace(cls) -
+0002bf00: 3e20 4c69 7374 5b73 7472 5d3a 0a20 2020  > List[str]:.   
+0002bf10: 2020 2020 2022 2222 4765 7420 7468 6520       """Get the 
+0002bf20: 6e61 6d65 7370 6163 6520 6f66 2074 6865  namespace of the
+0002bf30: 206c 616e 6763 6861 696e 206f 626a 6563   langchain objec
+0002bf40: 742e 2222 220a 2020 2020 2020 2020 7265  t.""".        re
+0002bf50: 7475 726e 205b 226c 616e 6763 6861 696e  turn ["langchain
+0002bf60: 222c 2022 7363 6865 6d61 222c 2022 7275  ", "schema", "ru
+0002bf70: 6e6e 6162 6c65 225d 0a0a 2020 2020 6465  nnable"]..    de
+0002bf80: 6620 6269 6e64 2873 656c 662c 202a 2a6b  f bind(self, **k
+0002bf90: 7761 7267 733a 2041 6e79 2920 2d3e 2052  wargs: Any) -> R
+0002bfa0: 756e 6e61 626c 655b 496e 7075 742c 204f  unnable[Input, O
+0002bfb0: 7574 7075 745d 3a0a 2020 2020 2020 2020  utput]:.        
+0002bfc0: 2222 2242 696e 6420 6164 6469 7469 6f6e  """Bind addition
+0002bfd0: 616c 206b 7761 7267 7320 746f 2061 2052  al kwargs to a R
+0002bfe0: 756e 6e61 626c 652c 2072 6574 7572 6e69  unnable, returni
+0002bff0: 6e67 2061 206e 6577 2052 756e 6e61 626c  ng a new Runnabl
+0002c000: 652e 0a0a 2020 2020 2020 2020 4172 6773  e...        Args
+0002c010: 3a0a 2020 2020 2020 2020 2020 2020 2a2a  :.            **
+0002c020: 6b77 6172 6773 3a20 5468 6520 6b77 6172  kwargs: The kwar
+0002c030: 6773 2074 6f20 6269 6e64 2074 6f20 7468  gs to bind to th
+0002c040: 6520 5275 6e6e 6162 6c65 2e0a 0a20 2020  e Runnable...   
+0002c050: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
+0002c060: 2020 2020 2020 2020 2020 4120 6e65 7720            A new 
+0002c070: 5275 6e6e 6162 6c65 2077 6974 6820 7468  Runnable with th
+0002c080: 6520 7361 6d65 2074 7970 6520 616e 6420  e same type and 
+0002c090: 636f 6e66 6967 2061 7320 7468 6520 6f72  config as the or
+0002c0a0: 6967 696e 616c 2c0a 2020 2020 2020 2020  iginal,.        
+0002c0b0: 2020 2020 6275 7420 7769 7468 2074 6865      but with the
+0002c0c0: 2061 6464 6974 696f 6e61 6c20 6b77 6172   additional kwar
+0002c0d0: 6773 2062 6f75 6e64 2e0a 2020 2020 2020  gs bound..      
+0002c0e0: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
+0002c0f0: 7475 726e 2073 656c 662e 5f5f 636c 6173  turn self.__clas
+0002c100: 735f 5f28 0a20 2020 2020 2020 2020 2020  s__(.           
+0002c110: 2062 6f75 6e64 3d73 656c 662e 626f 756e   bound=self.boun
+0002c120: 642c 0a20 2020 2020 2020 2020 2020 2063  d,.            c
+0002c130: 6f6e 6669 673d 7365 6c66 2e63 6f6e 6669  onfig=self.confi
+0002c140: 672c 0a20 2020 2020 2020 2020 2020 206b  g,.            k
+0002c150: 7761 7267 733d 7b2a 2a73 656c 662e 6b77  wargs={**self.kw
+0002c160: 6172 6773 2c20 2a2a 6b77 6172 6773 7d2c  args, **kwargs},
+0002c170: 0a20 2020 2020 2020 2020 2020 2063 7573  .            cus
+0002c180: 746f 6d5f 696e 7075 745f 7479 7065 3d73  tom_input_type=s
+0002c190: 656c 662e 6375 7374 6f6d 5f69 6e70 7574  elf.custom_input
+0002c1a0: 5f74 7970 652c 0a20 2020 2020 2020 2020  _type,.         
+0002c1b0: 2020 2063 7573 746f 6d5f 6f75 7470 7574     custom_output
+0002c1c0: 5f74 7970 653d 7365 6c66 2e63 7573 746f  _type=self.custo
+0002c1d0: 6d5f 6f75 7470 7574 5f74 7970 652c 0a20  m_output_type,. 
+0002c1e0: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
+0002c1f0: 6620 7769 7468 5f63 6f6e 6669 6728 0a20  f with_config(. 
+0002c200: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0002c210: 2020 2020 2063 6f6e 6669 673a 204f 7074       config: Opt
+0002c220: 696f 6e61 6c5b 5275 6e6e 6162 6c65 436f  ional[RunnableCo
+0002c230: 6e66 6967 5d20 3d20 4e6f 6e65 2c0a 2020  nfig] = None,.  
+0002c240: 2020 2020 2020 2320 5361 646c 7920 556e        # Sadly Un
+0002c250: 7061 636b 2069 7320 6e6f 7420 7765 6c6c  pack is not well
+0002c260: 2073 7570 706f 7274 6564 2062 7920 6d79   supported by my
+0002c270: 7079 2073 6f20 7468 6973 2077 696c 6c20  py so this will 
+0002c280: 6861 7665 2074 6f20 6265 2075 6e74 7970  have to be untyp
+0002c290: 6564 0a20 2020 2020 2020 202a 2a6b 7761  ed.        **kwa
+0002c2a0: 7267 733a 2041 6e79 2c0a 2020 2020 2920  rgs: Any,.    ) 
+0002c2b0: 2d3e 2052 756e 6e61 626c 655b 496e 7075  -> Runnable[Inpu
+0002c2c0: 742c 204f 7574 7075 745d 3a0a 2020 2020  t, Output]:.    
+0002c2d0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0002c2e0: 5f5f 636c 6173 735f 5f28 0a20 2020 2020  __class__(.     
+0002c2f0: 2020 2020 2020 2062 6f75 6e64 3d73 656c         bound=sel
+0002c300: 662e 626f 756e 642c 0a20 2020 2020 2020  f.bound,.       
+0002c310: 2020 2020 206b 7761 7267 733d 7365 6c66       kwargs=self
+0002c320: 2e6b 7761 7267 732c 0a20 2020 2020 2020  .kwargs,.       
+0002c330: 2020 2020 2063 6f6e 6669 673d 6361 7374       config=cast
+0002c340: 2852 756e 6e61 626c 6543 6f6e 6669 672c  (RunnableConfig,
+0002c350: 207b 2a2a 7365 6c66 2e63 6f6e 6669 672c   {**self.config,
+0002c360: 202a 2a28 636f 6e66 6967 206f 7220 7b7d   **(config or {}
+0002c370: 292c 202a 2a6b 7761 7267 737d 292c 0a20  ), **kwargs}),. 
+0002c380: 2020 2020 2020 2020 2020 2063 7573 746f             custo
+0002c390: 6d5f 696e 7075 745f 7479 7065 3d73 656c  m_input_type=sel
+0002c3a0: 662e 6375 7374 6f6d 5f69 6e70 7574 5f74  f.custom_input_t
+0002c3b0: 7970 652c 0a20 2020 2020 2020 2020 2020  ype,.           
+0002c3c0: 2063 7573 746f 6d5f 6f75 7470 7574 5f74   custom_output_t
+0002c3d0: 7970 653d 7365 6c66 2e63 7573 746f 6d5f  ype=self.custom_
+0002c3e0: 6f75 7470 7574 5f74 7970 652c 0a20 2020  output_type,.   
+0002c3f0: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+0002c400: 7769 7468 5f6c 6973 7465 6e65 7273 280a  with_listeners(.
+0002c410: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+0002c420: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
+0002c430: 206f 6e5f 7374 6172 743a 204f 7074 696f   on_start: Optio
+0002c440: 6e61 6c5b 4c69 7374 656e 6572 5d20 3d20  nal[Listener] = 
+0002c450: 4e6f 6e65 2c0a 2020 2020 2020 2020 6f6e  None,.        on
+0002c460: 5f65 6e64 3a20 4f70 7469 6f6e 616c 5b4c  _end: Optional[L
+0002c470: 6973 7465 6e65 725d 203d 204e 6f6e 652c  istener] = None,
+0002c480: 0a20 2020 2020 2020 206f 6e5f 6572 726f  .        on_erro
+0002c490: 723a 204f 7074 696f 6e61 6c5b 4c69 7374  r: Optional[List
+0002c4a0: 656e 6572 5d20 3d20 4e6f 6e65 2c0a 2020  ener] = None,.  
+0002c4b0: 2020 2920 2d3e 2052 756e 6e61 626c 655b    ) -> Runnable[
+0002c4c0: 496e 7075 742c 204f 7574 7075 745d 3a0a  Input, Output]:.
+0002c4d0: 2020 2020 2020 2020 2222 2242 696e 6420          """Bind 
+0002c4e0: 6c69 6665 6379 636c 6520 6c69 7374 656e  lifecycle listen
+0002c4f0: 6572 7320 746f 2061 2052 756e 6e61 626c  ers to a Runnabl
+0002c500: 652c 2072 6574 7572 6e69 6e67 2061 206e  e, returning a n
+0002c510: 6577 2052 756e 6e61 626c 652e 0a0a 2020  ew Runnable...  
+0002c520: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
+0002c530: 2020 2020 2020 2020 6f6e 5f73 7461 7274          on_start
+0002c540: 3a20 4361 6c6c 6564 2062 6566 6f72 6520  : Called before 
+0002c550: 7468 6520 7275 6e6e 6162 6c65 2073 7461  the runnable sta
+0002c560: 7274 7320 7275 6e6e 696e 672c 2077 6974  rts running, wit
+0002c570: 6820 7468 6520 5275 6e20 6f62 6a65 6374  h the Run object
+0002c580: 2e0a 2020 2020 2020 2020 2020 2020 6f6e  ..            on
+0002c590: 5f65 6e64 3a20 4361 6c6c 6564 2061 6674  _end: Called aft
+0002c5a0: 6572 2074 6865 2072 756e 6e61 626c 6520  er the runnable 
+0002c5b0: 6669 6e69 7368 6573 2072 756e 6e69 6e67  finishes running
+0002c5c0: 2c20 7769 7468 2074 6865 2052 756e 206f  , with the Run o
+0002c5d0: 626a 6563 742e 0a20 2020 2020 2020 2020  bject..         
+0002c5e0: 2020 206f 6e5f 6572 726f 723a 2043 616c     on_error: Cal
+0002c5f0: 6c65 6420 6966 2074 6865 2072 756e 6e61  led if the runna
+0002c600: 626c 6520 7468 726f 7773 2061 6e20 6572  ble throws an er
+0002c610: 726f 722c 2077 6974 6820 7468 6520 5275  ror, with the Ru
+0002c620: 6e20 6f62 6a65 6374 2e0a 0a20 2020 2020  n object...     
+0002c630: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+0002c640: 2020 2020 2020 2020 5468 6520 5275 6e20          The Run 
+0002c650: 6f62 6a65 6374 2063 6f6e 7461 696e 7320  object contains 
+0002c660: 696e 666f 726d 6174 696f 6e20 6162 6f75  information abou
+0002c670: 7420 7468 6520 7275 6e2c 2069 6e63 6c75  t the run, inclu
+0002c680: 6469 6e67 2069 7473 2069 642c 0a20 2020  ding its id,.   
+0002c690: 2020 2020 2020 2020 2074 7970 652c 2069           type, i
+0002c6a0: 6e70 7574 2c20 6f75 7470 7574 2c20 6572  nput, output, er
+0002c6b0: 726f 722c 2073 7461 7274 5f74 696d 652c  ror, start_time,
+0002c6c0: 2065 6e64 5f74 696d 652c 2061 6e64 2061   end_time, and a
+0002c6d0: 6e79 2074 6167 7320 6f72 206d 6574 6164  ny tags or metad
+0002c6e0: 6174 610a 2020 2020 2020 2020 2020 2020  ata.            
+0002c6f0: 6164 6465 6420 746f 2074 6865 2072 756e  added to the run
+0002c700: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+0002c710: 2020 2020 2020 6672 6f6d 206c 616e 6763        from langc
+0002c720: 6861 696e 5f63 6f72 652e 7472 6163 6572  hain_core.tracer
+0002c730: 732e 726f 6f74 5f6c 6973 7465 6e65 7273  s.root_listeners
+0002c740: 2069 6d70 6f72 7420 526f 6f74 4c69 7374   import RootList
+0002c750: 656e 6572 7354 7261 6365 720a 0a20 2020  enersTracer..   
+0002c760: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0002c770: 2e5f 5f63 6c61 7373 5f5f 280a 2020 2020  .__class__(.    
+0002c780: 2020 2020 2020 2020 626f 756e 643d 7365          bound=se
+0002c790: 6c66 2e62 6f75 6e64 2c0a 2020 2020 2020  lf.bound,.      
+0002c7a0: 2020 2020 2020 6b77 6172 6773 3d73 656c        kwargs=sel
+0002c7b0: 662e 6b77 6172 6773 2c0a 2020 2020 2020  f.kwargs,.      
+0002c7c0: 2020 2020 2020 636f 6e66 6967 3d73 656c        config=sel
+0002c7d0: 662e 636f 6e66 6967 2c0a 2020 2020 2020  f.config,.      
+0002c7e0: 2020 2020 2020 636f 6e66 6967 5f66 6163        config_fac
+0002c7f0: 746f 7269 6573 3d5b 0a20 2020 2020 2020  tories=[.       
+0002c800: 2020 2020 2020 2020 206c 616d 6264 6120           lambda 
+0002c810: 636f 6e66 6967 3a20 7b0a 2020 2020 2020  config: {.      
+0002c820: 2020 2020 2020 2020 2020 2020 2020 2263                "c
+0002c830: 616c 6c62 6163 6b73 223a 205b 0a20 2020  allbacks": [.   
+0002c840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c850: 2020 2020 2052 6f6f 744c 6973 7465 6e65       RootListene
+0002c860: 7273 5472 6163 6572 280a 2020 2020 2020  rsTracer(.      
+0002c870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c880: 2020 2020 2020 636f 6e66 6967 3d63 6f6e        config=con
+0002c890: 6669 672c 0a20 2020 2020 2020 2020 2020  fig,.           
+0002c8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c8b0: 206f 6e5f 7374 6172 743d 6f6e 5f73 7461   on_start=on_sta
+0002c8c0: 7274 2c0a 2020 2020 2020 2020 2020 2020  rt,.            
+0002c8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c8e0: 6f6e 5f65 6e64 3d6f 6e5f 656e 642c 0a20  on_end=on_end,. 
+0002c8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c900: 2020 2020 2020 2020 2020 206f 6e5f 6572             on_er
+0002c910: 726f 723d 6f6e 5f65 7272 6f72 2c0a 2020  ror=on_error,.  
+0002c920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c930: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0002c940: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
+0002c950: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0002c960: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
+0002c970: 2020 2020 2020 2020 2020 2020 6375 7374              cust
+0002c980: 6f6d 5f69 6e70 7574 5f74 7970 653d 7365  om_input_type=se
+0002c990: 6c66 2e63 7573 746f 6d5f 696e 7075 745f  lf.custom_input_
+0002c9a0: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
+0002c9b0: 2020 6375 7374 6f6d 5f6f 7574 7075 745f    custom_output_
+0002c9c0: 7479 7065 3d73 656c 662e 6375 7374 6f6d  type=self.custom
+0002c9d0: 5f6f 7574 7075 745f 7479 7065 2c0a 2020  _output_type,.  
+0002c9e0: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
+0002c9f0: 2077 6974 685f 7479 7065 7328 0a20 2020   with_types(.   
+0002ca00: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0002ca10: 2020 2069 6e70 7574 5f74 7970 653a 204f     input_type: O
+0002ca20: 7074 696f 6e61 6c5b 556e 696f 6e5b 5479  ptional[Union[Ty
+0002ca30: 7065 5b49 6e70 7574 5d2c 2042 6173 654d  pe[Input], BaseM
+0002ca40: 6f64 656c 5d5d 203d 204e 6f6e 652c 0a20  odel]] = None,. 
+0002ca50: 2020 2020 2020 206f 7574 7075 745f 7479         output_ty
+0002ca60: 7065 3a20 4f70 7469 6f6e 616c 5b55 6e69  pe: Optional[Uni
+0002ca70: 6f6e 5b54 7970 655b 4f75 7470 7574 5d2c  on[Type[Output],
+0002ca80: 2042 6173 654d 6f64 656c 5d5d 203d 204e   BaseModel]] = N
+0002ca90: 6f6e 652c 0a20 2020 2029 202d 3e20 5275  one,.    ) -> Ru
+0002caa0: 6e6e 6162 6c65 5b49 6e70 7574 2c20 4f75  nnable[Input, Ou
+0002cab0: 7470 7574 5d3a 0a20 2020 2020 2020 2072  tput]:.        r
+0002cac0: 6574 7572 6e20 7365 6c66 2e5f 5f63 6c61  eturn self.__cla
+0002cad0: 7373 5f5f 280a 2020 2020 2020 2020 2020  ss__(.          
+0002cae0: 2020 626f 756e 643d 7365 6c66 2e62 6f75    bound=self.bou
+0002caf0: 6e64 2c0a 2020 2020 2020 2020 2020 2020  nd,.            
+0002cb00: 6b77 6172 6773 3d73 656c 662e 6b77 6172  kwargs=self.kwar
+0002cb10: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
+0002cb20: 636f 6e66 6967 3d73 656c 662e 636f 6e66  config=self.conf
+0002cb30: 6967 2c0a 2020 2020 2020 2020 2020 2020  ig,.            
+0002cb40: 6375 7374 6f6d 5f69 6e70 7574 5f74 7970  custom_input_typ
+0002cb50: 653d 280a 2020 2020 2020 2020 2020 2020  e=(.            
+0002cb60: 2020 2020 696e 7075 745f 7479 7065 2069      input_type i
+0002cb70: 6620 696e 7075 745f 7479 7065 2069 7320  f input_type is 
+0002cb80: 6e6f 7420 4e6f 6e65 2065 6c73 6520 7365  not None else se
+0002cb90: 6c66 2e63 7573 746f 6d5f 696e 7075 745f  lf.custom_input_
+0002cba0: 7479 7065 0a20 2020 2020 2020 2020 2020  type.           
+0002cbb0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+0002cbc0: 6375 7374 6f6d 5f6f 7574 7075 745f 7479  custom_output_ty
+0002cbd0: 7065 3d28 0a20 2020 2020 2020 2020 2020  pe=(.           
+0002cbe0: 2020 2020 206f 7574 7075 745f 7479 7065       output_type
+0002cbf0: 2069 6620 6f75 7470 7574 5f74 7970 6520   if output_type 
+0002cc00: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+0002cc10: 2073 656c 662e 6375 7374 6f6d 5f6f 7574   self.custom_out
+0002cc20: 7075 745f 7479 7065 0a20 2020 2020 2020  put_type.       
+0002cc30: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+0002cc40: 290a 0a20 2020 2064 6566 2077 6974 685f  )..    def with_
+0002cc50: 7265 7472 7928 7365 6c66 2c20 2a2a 6b77  retry(self, **kw
+0002cc60: 6172 6773 3a20 416e 7929 202d 3e20 5275  args: Any) -> Ru
+0002cc70: 6e6e 6162 6c65 5b49 6e70 7574 2c20 4f75  nnable[Input, Ou
+0002cc80: 7470 7574 5d3a 0a20 2020 2020 2020 2072  tput]:.        r
+0002cc90: 6574 7572 6e20 7365 6c66 2e5f 5f63 6c61  eturn self.__cla
+0002cca0: 7373 5f5f 280a 2020 2020 2020 2020 2020  ss__(.          
+0002ccb0: 2020 626f 756e 643d 7365 6c66 2e62 6f75    bound=self.bou
+0002ccc0: 6e64 2e77 6974 685f 7265 7472 7928 2a2a  nd.with_retry(**
+0002ccd0: 6b77 6172 6773 292c 0a20 2020 2020 2020  kwargs),.       
+0002cce0: 2020 2020 206b 7761 7267 733d 7365 6c66       kwargs=self
+0002ccf0: 2e6b 7761 7267 732c 0a20 2020 2020 2020  .kwargs,.       
+0002cd00: 2020 2020 2063 6f6e 6669 673d 7365 6c66       config=self
+0002cd10: 2e63 6f6e 6669 672c 0a20 2020 2020 2020  .config,.       
+0002cd20: 2029 0a0a 2020 2020 6465 6620 5f5f 6765   )..    def __ge
+0002cd30: 7461 7474 725f 5f28 7365 6c66 2c20 6e61  tattr__(self, na
+0002cd40: 6d65 3a20 7374 7229 202d 3e20 416e 793a  me: str) -> Any:
+0002cd50: 0a20 2020 2020 2020 2061 7474 7220 3d20  .        attr = 
+0002cd60: 6765 7461 7474 7228 7365 6c66 2e62 6f75  getattr(self.bou
+0002cd70: 6e64 2c20 6e61 6d65 290a 0a20 2020 2020  nd, name)..     
+0002cd80: 2020 2069 6620 6361 6c6c 6162 6c65 2861     if callable(a
+0002cd90: 7474 7229 2061 6e64 2028 0a20 2020 2020  ttr) and (.     
+0002cda0: 2020 2020 2020 2063 6f6e 6669 675f 7061         config_pa
+0002cdb0: 7261 6d20 3a3d 2069 6e73 7065 6374 2e73  ram := inspect.s
+0002cdc0: 6967 6e61 7475 7265 2861 7474 7229 2e70  ignature(attr).p
+0002cdd0: 6172 616d 6574 6572 732e 6765 7428 2263  arameters.get("c
+0002cde0: 6f6e 6669 6722 290a 2020 2020 2020 2020  onfig").        
+0002cdf0: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+0002ce00: 6620 636f 6e66 6967 5f70 6172 616d 2e6b  f config_param.k
+0002ce10: 696e 6420 3d3d 2069 6e73 7065 6374 2e50  ind == inspect.P
+0002ce20: 6172 616d 6574 6572 2e4b 4559 574f 5244  arameter.KEYWORD
+0002ce30: 5f4f 4e4c 593a 0a0a 2020 2020 2020 2020  _ONLY:..        
+0002ce40: 2020 2020 2020 2020 4077 7261 7073 2861          @wraps(a
+0002ce50: 7474 7229 0a20 2020 2020 2020 2020 2020  ttr).           
+0002ce60: 2020 2020 2064 6566 2077 7261 7070 6572       def wrapper
+0002ce70: 282a 6172 6773 3a20 416e 792c 202a 2a6b  (*args: Any, **k
+0002ce80: 7761 7267 733a 2041 6e79 2920 2d3e 2041  wargs: Any) -> A
+0002ce90: 6e79 3a0a 2020 2020 2020 2020 2020 2020  ny:.            
+0002cea0: 2020 2020 2020 2020 7265 7475 726e 2061          return a
+0002ceb0: 7474 7228 0a20 2020 2020 2020 2020 2020  ttr(.           
+0002cec0: 2020 2020 2020 2020 2020 2020 202a 6172               *ar
+0002ced0: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
+0002cee0: 2020 2020 2020 2020 2020 2020 636f 6e66              conf
+0002cef0: 6967 3d6d 6572 6765 5f63 6f6e 6669 6773  ig=merge_configs
+0002cf00: 2873 656c 662e 636f 6e66 6967 2c20 6b77  (self.config, kw
+0002cf10: 6172 6773 2e70 6f70 2822 636f 6e66 6967  args.pop("config
+0002cf20: 222c 204e 6f6e 6529 292c 0a20 2020 2020  ", None)),.     
+0002cf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cf40: 2020 202a 2a6b 7761 7267 732c 0a20 2020     **kwargs,.   
+0002cf50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cf60: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+0002cf70: 2020 2020 7265 7475 726e 2077 7261 7070      return wrapp
+0002cf80: 6572 0a20 2020 2020 2020 2020 2020 2065  er.            e
+0002cf90: 6c69 6620 636f 6e66 6967 5f70 6172 616d  lif config_param
+0002cfa0: 2e6b 696e 6420 3d3d 2069 6e73 7065 6374  .kind == inspect
+0002cfb0: 2e50 6172 616d 6574 6572 2e50 4f53 4954  .Parameter.POSIT
+0002cfc0: 494f 4e41 4c5f 4f52 5f4b 4559 574f 5244  IONAL_OR_KEYWORD
+0002cfd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002cfe0: 2020 6964 7820 3d20 6c69 7374 2869 6e73    idx = list(ins
+0002cff0: 7065 6374 2e73 6967 6e61 7475 7265 2861  pect.signature(a
+0002d000: 7474 7229 2e70 6172 616d 6574 6572 7329  ttr).parameters)
+0002d010: 2e69 6e64 6578 2822 636f 6e66 6967 2229  .index("config")
+0002d020: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0002d030: 2020 4077 7261 7073 2861 7474 7229 0a20    @wraps(attr). 
+0002d040: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0002d050: 6566 2077 7261 7070 6572 282a 6172 6773  ef wrapper(*args
+0002d060: 3a20 416e 792c 202a 2a6b 7761 7267 733a  : Any, **kwargs:
+0002d070: 2041 6e79 2920 2d3e 2041 6e79 3a0a 2020   Any) -> Any:.  
+0002d080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d090: 2020 6966 206c 656e 2861 7267 7329 203e    if len(args) >
+0002d0a0: 3d20 6964 7820 2b20 313a 0a20 2020 2020  = idx + 1:.     
+0002d0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d0c0: 2020 2061 7267 736c 203d 206c 6973 7428     argsl = list(
+0002d0d0: 6172 6773 290a 2020 2020 2020 2020 2020  args).          
+0002d0e0: 2020 2020 2020 2020 2020 2020 2020 6172                ar
+0002d0f0: 6773 6c5b 6964 785d 203d 206d 6572 6765  gsl[idx] = merge
+0002d100: 5f63 6f6e 6669 6773 2873 656c 662e 636f  _configs(self.co
+0002d110: 6e66 6967 2c20 6172 6773 6c5b 6964 785d  nfig, argsl[idx]
+0002d120: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002d130: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0002d140: 2061 7474 7228 2a61 7267 736c 2c20 2a2a   attr(*argsl, **
+0002d150: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
+0002d160: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0002d170: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002d180: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0002d190: 2061 7474 7228 0a20 2020 2020 2020 2020   attr(.         
+0002d1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d1b0: 2020 202a 6172 6773 2c0a 2020 2020 2020     *args,.      
+0002d1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d1d0: 2020 2020 2020 636f 6e66 6967 3d6d 6572        config=mer
+0002d1e0: 6765 5f63 6f6e 6669 6773 280a 2020 2020  ge_configs(.    
+0002d1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d200: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0002d210: 2e63 6f6e 6669 672c 206b 7761 7267 732e  .config, kwargs.
+0002d220: 706f 7028 2263 6f6e 6669 6722 2c20 4e6f  pop("config", No
+0002d230: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
+0002d240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d250: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0002d260: 2020 2020 2020 2020 2020 2020 2020 202a                 *
+0002d270: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
+0002d280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d290: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+0002d2a0: 2020 2020 7265 7475 726e 2077 7261 7070      return wrapp
+0002d2b0: 6572 0a0a 2020 2020 2020 2020 7265 7475  er..        retu
+0002d2c0: 726e 2061 7474 720a 0a0a 5275 6e6e 6162  rn attr...Runnab
+0002d2d0: 6c65 4c69 6b65 203d 2055 6e69 6f6e 5b0a  leLike = Union[.
+0002d2e0: 2020 2020 5275 6e6e 6162 6c65 5b49 6e70      Runnable[Inp
+0002d2f0: 7574 2c20 4f75 7470 7574 5d2c 0a20 2020  ut, Output],.   
+0002d300: 2043 616c 6c61 626c 655b 5b49 6e70 7574   Callable[[Input
+0002d310: 5d2c 204f 7574 7075 745d 2c0a 2020 2020  ], Output],.    
+0002d320: 4361 6c6c 6162 6c65 5b5b 496e 7075 745d  Callable[[Input]
+0002d330: 2c20 4177 6169 7461 626c 655b 4f75 7470  , Awaitable[Outp
+0002d340: 7574 5d5d 2c0a 2020 2020 4361 6c6c 6162  ut]],.    Callab
+0002d350: 6c65 5b5b 4974 6572 6174 6f72 5b49 6e70  le[[Iterator[Inp
+0002d360: 7574 5d5d 2c20 4974 6572 6174 6f72 5b4f  ut]], Iterator[O
+0002d370: 7574 7075 745d 5d2c 0a20 2020 2043 616c  utput]],.    Cal
+0002d380: 6c61 626c 655b 5b41 7379 6e63 4974 6572  lable[[AsyncIter
+0002d390: 6174 6f72 5b49 6e70 7574 5d5d 2c20 4173  ator[Input]], As
+0002d3a0: 796e 6349 7465 7261 746f 725b 4f75 7470  yncIterator[Outp
+0002d3b0: 7574 5d5d 2c0a 2020 2020 4d61 7070 696e  ut]],.    Mappin
+0002d3c0: 675b 7374 722c 2041 6e79 5d2c 0a5d 0a0a  g[str, Any],.]..
+0002d3d0: 0a64 6566 2063 6f65 7263 655f 746f 5f72  .def coerce_to_r
+0002d3e0: 756e 6e61 626c 6528 7468 696e 673a 2052  unnable(thing: R
+0002d3f0: 756e 6e61 626c 654c 696b 6529 202d 3e20  unnableLike) -> 
+0002d400: 5275 6e6e 6162 6c65 5b49 6e70 7574 2c20  Runnable[Input, 
+0002d410: 4f75 7470 7574 5d3a 0a20 2020 2022 2222  Output]:.    """
+0002d420: 436f 6572 6365 2061 2072 756e 6e61 626c  Coerce a runnabl
+0002d430: 652d 6c69 6b65 206f 626a 6563 7420 696e  e-like object in
+0002d440: 746f 2061 2052 756e 6e61 626c 652e 0a0a  to a Runnable...
+0002d450: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+0002d460: 2020 7468 696e 673a 2041 2072 756e 6e61    thing: A runna
+0002d470: 626c 652d 6c69 6b65 206f 626a 6563 742e  ble-like object.
+0002d480: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
+0002d490: 2020 2020 2020 2041 2052 756e 6e61 626c         A Runnabl
+0002d4a0: 652e 0a20 2020 2022 2222 0a20 2020 2069  e..    """.    i
+0002d4b0: 6620 6973 696e 7374 616e 6365 2874 6869  f isinstance(thi
+0002d4c0: 6e67 2c20 5275 6e6e 6162 6c65 293a 0a20  ng, Runnable):. 
+0002d4d0: 2020 2020 2020 2072 6574 7572 6e20 7468         return th
+0002d4e0: 696e 670a 2020 2020 656c 6966 2069 6e73  ing.    elif ins
+0002d4f0: 7065 6374 2e69 7361 7379 6e63 6765 6e66  pect.isasyncgenf
+0002d500: 756e 6374 696f 6e28 7468 696e 6729 206f  unction(thing) o
+0002d510: 7220 696e 7370 6563 742e 6973 6765 6e65  r inspect.isgene
+0002d520: 7261 746f 7266 756e 6374 696f 6e28 7468  ratorfunction(th
+0002d530: 696e 6729 3a0a 2020 2020 2020 2020 7265  ing):.        re
+0002d540: 7475 726e 2052 756e 6e61 626c 6547 656e  turn RunnableGen
+0002d550: 6572 6174 6f72 2874 6869 6e67 290a 2020  erator(thing).  
+0002d560: 2020 656c 6966 2063 616c 6c61 626c 6528    elif callable(
+0002d570: 7468 696e 6729 3a0a 2020 2020 2020 2020  thing):.        
+0002d580: 7265 7475 726e 2052 756e 6e61 626c 654c  return RunnableL
+0002d590: 616d 6264 6128 6361 7374 2843 616c 6c61  ambda(cast(Calla
+0002d5a0: 626c 655b 5b49 6e70 7574 5d2c 204f 7574  ble[[Input], Out
+0002d5b0: 7075 745d 2c20 7468 696e 6729 290a 2020  put], thing)).  
+0002d5c0: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+0002d5d0: 6528 7468 696e 672c 2064 6963 7429 3a0a  e(thing, dict):.
+0002d5e0: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+0002d5f0: 6173 7428 5275 6e6e 6162 6c65 5b49 6e70  ast(Runnable[Inp
+0002d600: 7574 2c20 4f75 7470 7574 5d2c 2052 756e  ut, Output], Run
+0002d610: 6e61 626c 6550 6172 616c 6c65 6c28 7468  nableParallel(th
+0002d620: 696e 6729 290a 2020 2020 656c 7365 3a0a  ing)).    else:.
+0002d630: 2020 2020 2020 2020 7261 6973 6520 5479          raise Ty
+0002d640: 7065 4572 726f 7228 0a20 2020 2020 2020  peError(.       
+0002d650: 2020 2020 2066 2245 7870 6563 7465 6420       f"Expected 
+0002d660: 6120 5275 6e6e 6162 6c65 2c20 6361 6c6c  a Runnable, call
+0002d670: 6162 6c65 206f 7220 6469 6374 2e22 0a20  able or dict.". 
+0002d680: 2020 2020 2020 2020 2020 2066 2249 6e73             f"Ins
+0002d690: 7465 6164 2067 6f74 2061 6e20 756e 7375  tead got an unsu
+0002d6a0: 7070 6f72 7465 6420 7479 7065 3a20 7b74  pported type: {t
+0002d6b0: 7970 6528 7468 696e 6729 7d22 0a20 2020  ype(thing)}".   
+0002d6c0: 2020 2020 2029 0a0a 0a40 6f76 6572 6c6f       )...@overlo
+0002d6d0: 6164 0a64 6566 2063 6861 696e 280a 2020  ad.def chain(.  
+0002d6e0: 2020 6675 6e63 3a20 4361 6c6c 6162 6c65    func: Callable
+0002d6f0: 5b5b 496e 7075 745d 2c20 436f 726f 7574  [[Input], Corout
+0002d700: 696e 655b 416e 792c 2041 6e79 2c20 4f75  ine[Any, Any, Ou
+0002d710: 7470 7574 5d5d 2c0a 2920 2d3e 2052 756e  tput]],.) -> Run
+0002d720: 6e61 626c 655b 496e 7075 742c 204f 7574  nable[Input, Out
+0002d730: 7075 745d 3a0a 2020 2020 2e2e 2e0a 0a0a  put]:.    ......
+0002d740: 406f 7665 726c 6f61 640a 6465 6620 6368  @overload.def ch
+0002d750: 6169 6e28 0a20 2020 2066 756e 633a 2043  ain(.    func: C
+0002d760: 616c 6c61 626c 655b 5b49 6e70 7574 5d2c  allable[[Input],
+0002d770: 2049 7465 7261 746f 725b 4f75 7470 7574   Iterator[Output
+0002d780: 5d5d 2c0a 2920 2d3e 2052 756e 6e61 626c  ]],.) -> Runnabl
+0002d790: 655b 496e 7075 742c 204f 7574 7075 745d  e[Input, Output]
+0002d7a0: 3a0a 2020 2020 2e2e 2e0a 0a0a 406f 7665  :.    ......@ove
+0002d7b0: 726c 6f61 640a 6465 6620 6368 6169 6e28  rload.def chain(
+0002d7c0: 0a20 2020 2066 756e 633a 2043 616c 6c61  .    func: Calla
+0002d7d0: 626c 655b 5b49 6e70 7574 5d2c 2041 7379  ble[[Input], Asy
+0002d7e0: 6e63 4974 6572 6174 6f72 5b4f 7574 7075  ncIterator[Outpu
+0002d7f0: 745d 5d2c 0a29 202d 3e20 5275 6e6e 6162  t]],.) -> Runnab
+0002d800: 6c65 5b49 6e70 7574 2c20 4f75 7470 7574  le[Input, Output
+0002d810: 5d3a 0a20 2020 202e 2e2e 0a0a 0a40 6f76  ]:.    ......@ov
+0002d820: 6572 6c6f 6164 0a64 6566 2063 6861 696e  erload.def chain
+0002d830: 280a 2020 2020 6675 6e63 3a20 4361 6c6c  (.    func: Call
+0002d840: 6162 6c65 5b5b 496e 7075 745d 2c20 4f75  able[[Input], Ou
+0002d850: 7470 7574 5d2c 0a29 202d 3e20 5275 6e6e  tput],.) -> Runn
+0002d860: 6162 6c65 5b49 6e70 7574 2c20 4f75 7470  able[Input, Outp
+0002d870: 7574 5d3a 0a20 2020 202e 2e2e 0a0a 0a64  ut]:.    ......d
+0002d880: 6566 2063 6861 696e 280a 2020 2020 6675  ef chain(.    fu
+0002d890: 6e63 3a20 556e 696f 6e5b 0a20 2020 2020  nc: Union[.     
+0002d8a0: 2020 2043 616c 6c61 626c 655b 5b49 6e70     Callable[[Inp
+0002d8b0: 7574 5d2c 204f 7574 7075 745d 2c0a 2020  ut], Output],.  
+0002d8c0: 2020 2020 2020 4361 6c6c 6162 6c65 5b5b        Callable[[
+0002d8d0: 496e 7075 745d 2c20 4974 6572 6174 6f72  Input], Iterator
+0002d8e0: 5b4f 7574 7075 745d 5d2c 0a20 2020 2020  [Output]],.     
+0002d8f0: 2020 2043 616c 6c61 626c 655b 5b49 6e70     Callable[[Inp
+0002d900: 7574 5d2c 2043 6f72 6f75 7469 6e65 5b41  ut], Coroutine[A
+0002d910: 6e79 2c20 416e 792c 204f 7574 7075 745d  ny, Any, Output]
+0002d920: 5d2c 0a20 2020 2020 2020 2043 616c 6c61  ],.        Calla
+0002d930: 626c 655b 5b49 6e70 7574 5d2c 2041 7379  ble[[Input], Asy
+0002d940: 6e63 4974 6572 6174 6f72 5b4f 7574 7075  ncIterator[Outpu
+0002d950: 745d 5d2c 0a20 2020 205d 2c0a 2920 2d3e  t]],.    ],.) ->
+0002d960: 2052 756e 6e61 626c 655b 496e 7075 742c   Runnable[Input,
+0002d970: 204f 7574 7075 745d 3a0a 2020 2020 2222   Output]:.    ""
+0002d980: 2244 6563 6f72 6174 6520 6120 6675 6e63  "Decorate a func
+0002d990: 7469 6f6e 2074 6f20 6d61 6b65 2069 7420  tion to make it 
+0002d9a0: 6120 5275 6e6e 6162 6c65 2e0a 2020 2020  a Runnable..    
+0002d9b0: 5365 7473 2074 6865 206e 616d 6520 6f66  Sets the name of
+0002d9c0: 2074 6865 2072 756e 6e61 626c 6520 746f   the runnable to
+0002d9d0: 2074 6865 206e 616d 6520 6f66 2074 6865   the name of the
+0002d9e0: 2066 756e 6374 696f 6e2e 0a20 2020 2041   function..    A
+0002d9f0: 6e79 2072 756e 6e61 626c 6573 2063 616c  ny runnables cal
+0002da00: 6c65 6420 6279 2074 6865 2066 756e 6374  led by the funct
+0002da10: 696f 6e20 7769 6c6c 2062 6520 7472 6163  ion will be trac
+0002da20: 6564 2061 7320 6465 7065 6e64 656e 6369  ed as dependenci
+0002da30: 6573 2e0a 0a20 2020 2041 7267 733a 0a20  es...    Args:. 
+0002da40: 2020 2020 2020 2066 756e 633a 2041 2063         func: A c
+0002da50: 616c 6c61 626c 652e 0a0a 2020 2020 5265  allable...    Re
+0002da60: 7475 726e 733a 0a20 2020 2020 2020 2041  turns:.        A
+0002da70: 2052 756e 6e61 626c 652e 0a0a 2020 2020   Runnable...    
+0002da80: 4578 616d 706c 653a 0a0a 2020 2020 2e2e  Example:..    ..
+0002da90: 2063 6f64 652d 626c 6f63 6b3a 3a20 7079   code-block:: py
+0002daa0: 7468 6f6e 0a0a 2020 2020 2020 2020 6672  thon..        fr
+0002dab0: 6f6d 206c 616e 6763 6861 696e 5f63 6f72  om langchain_cor
+0002dac0: 652e 7275 6e6e 6162 6c65 7320 696d 706f  e.runnables impo
+0002dad0: 7274 2063 6861 696e 0a20 2020 2020 2020  rt chain.       
+0002dae0: 2066 726f 6d20 6c61 6e67 6368 6169 6e5f   from langchain_
+0002daf0: 636f 7265 2e70 726f 6d70 7473 2069 6d70  core.prompts imp
+0002db00: 6f72 7420 5072 6f6d 7074 5465 6d70 6c61  ort PromptTempla
+0002db10: 7465 0a20 2020 2020 2020 2066 726f 6d20  te.        from 
+0002db20: 6c61 6e67 6368 6169 6e5f 6f70 656e 6169  langchain_openai
+0002db30: 2069 6d70 6f72 7420 4f70 656e 4149 0a0a   import OpenAI..
+0002db40: 2020 2020 2020 2020 4063 6861 696e 0a20          @chain. 
+0002db50: 2020 2020 2020 2064 6566 206d 795f 6675         def my_fu
+0002db60: 6e63 2866 6965 6c64 7329 3a0a 2020 2020  nc(fields):.    
+0002db70: 2020 2020 2020 2020 7072 6f6d 7074 203d          prompt =
+0002db80: 2050 726f 6d70 7454 656d 706c 6174 6528   PromptTemplate(
+0002db90: 2248 656c 6c6f 2c20 7b6e 616d 657d 2122  "Hello, {name}!"
+0002dba0: 290a 2020 2020 2020 2020 2020 2020 6c6c  ).            ll
+0002dbb0: 6d20 3d20 4f70 656e 4149 2829 0a20 2020  m = OpenAI().   
+0002dbc0: 2020 2020 2020 2020 2066 6f72 6d61 7474           formatt
+0002dbd0: 6564 203d 2070 726f 6d70 742e 696e 766f  ed = prompt.invo
+0002dbe0: 6b65 282a 2a66 6965 6c64 7329 0a0a 2020  ke(**fields)..  
+0002dbf0: 2020 2020 2020 2020 2020 666f 7220 6368            for ch
+0002dc00: 756e 6b20 696e 206c 6c6d 2e73 7472 6561  unk in llm.strea
+0002dc10: 6d28 666f 726d 6174 7465 6429 3a0a 2020  m(formatted):.  
+0002dc20: 2020 2020 2020 2020 2020 2020 2020 7969                yi
+0002dc30: 656c 6420 6368 756e 6b0a 2020 2020 2222  eld chunk.    ""
+0002dc40: 220a 2020 2020 7265 7475 726e 2052 756e  ".    return Run
+0002dc50: 6e61 626c 654c 616d 6264 6128 6675 6e63  nableLambda(func
+0002dc60: 290a                                     ).
```

### Comparing `langchain_core-0.1.9/langchain_core/runnables/branch.py` & `langchain_core-0.2.0rc1/langchain_core/runnables/branch.py`

 * *Files 3% similar despite different names*

```diff
@@ -34,21 +34,21 @@
     Input,
     Output,
     get_unique_config_specs,
 )
 
 
 class RunnableBranch(RunnableSerializable[Input, Output]):
-    """A Runnable that selects which branch to run based on a condition.
+    """Runnable that selects which branch to run based on a condition.
 
-    The runnable is initialized with a list of (condition, runnable) pairs and
+    The Runnable is initialized with a list of (condition, Runnable) pairs and
     a default branch.
 
     When operating on an input, the first condition that evaluates to True is
-    selected, and the corresponding runnable is run on the input.
+    selected, and the corresponding Runnable is run on the input.
 
     If no condition evaluates to True, the default branch is run on the input.
 
     Examples:
 
         .. code-block:: python
 
@@ -115,15 +115,15 @@
                     f"tuples or lists of length 2, not {len(branch)}"
                 )
             condition, runnable = branch
             condition = cast(Runnable[Input, bool], coerce_to_runnable(condition))
             runnable = coerce_to_runnable(runnable)
             _branches.append((condition, runnable))
 
-        super().__init__(branches=_branches, default=default_)
+        super().__init__(branches=_branches, default=default_)  # type: ignore[call-arg]
 
     class Config:
         arbitrary_types_allowed = True
 
     @classmethod
     def is_lc_serializable(cls) -> bool:
         """RunnableBranch is serializable if all its branches are serializable."""
@@ -179,14 +179,15 @@
         """First evaluates the condition, then delegate to true or false branch."""
         config = ensure_config(config)
         callback_manager = get_callback_manager_for_config(config)
         run_manager = callback_manager.on_chain_start(
             dumpd(self),
             input,
             name=config.get("run_name"),
+            run_id=config.pop("run_id", None),
         )
 
         try:
             for idx, branch in enumerate(self.branches):
                 condition, runnable = branch
 
                 expression_value = condition.invoke(
@@ -227,14 +228,15 @@
         """Async version of invoke."""
         config = ensure_config(config)
         callback_manager = get_async_callback_manager_for_config(config)
         run_manager = await callback_manager.on_chain_start(
             dumpd(self),
             input,
             name=config.get("run_name"),
+            run_id=config.pop("run_id", None),
         )
         try:
             for idx, branch in enumerate(self.branches):
                 condition, runnable = branch
 
                 expression_value = await condition.ainvoke(
                     input,
@@ -278,14 +280,15 @@
         then delegate to true or false branch."""
         config = ensure_config(config)
         callback_manager = get_callback_manager_for_config(config)
         run_manager = callback_manager.on_chain_start(
             dumpd(self),
             input,
             name=config.get("run_name"),
+            run_id=config.pop("run_id", None),
         )
         final_output: Optional[Output] = None
         final_output_supported = True
 
         try:
             for idx, branch in enumerate(self.branches):
                 condition, runnable = branch
@@ -352,14 +355,15 @@
         then delegate to true or false branch."""
         config = ensure_config(config)
         callback_manager = get_async_callback_manager_for_config(config)
         run_manager = await callback_manager.on_chain_start(
             dumpd(self),
             input,
             name=config.get("run_name"),
+            run_id=config.pop("run_id", None),
         )
         final_output: Optional[Output] = None
         final_output_supported = True
 
         try:
             for idx, branch in enumerate(self.branches):
                 condition, runnable = branch
```

### Comparing `langchain_core-0.1.9/langchain_core/runnables/config.py` & `langchain_core-0.2.0rc1/langchain_core/runnables/config.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,10 +1,12 @@
 from __future__ import annotations
 
 import asyncio
+import uuid
+import warnings
 from concurrent.futures import Executor, Future, ThreadPoolExecutor
 from contextlib import contextmanager
 from contextvars import ContextVar, copy_context
 from functools import partial
 from typing import (
     TYPE_CHECKING,
     Any,
@@ -91,14 +93,20 @@
     """
     Runtime values for attributes previously made configurable on this Runnable,
     or sub-Runnables, through .configurable_fields() or .configurable_alternatives().
     Check .output_schema() for a description of the attributes that have been made 
     configurable.
     """
 
+    run_id: Optional[uuid.UUID]
+    """
+    Unique identifier for the tracer run for this call. If not provided, a new UUID
+        will be generated.
+    """
+
 
 var_child_runnable_config = ContextVar(
     "child_runnable_config", default=RunnableConfig()
 )
 
 
 def ensure_config(config: Optional[RunnableConfig] = None) -> RunnableConfig:
@@ -112,23 +120,27 @@
         RunnableConfig: The ensured config.
     """
     empty = RunnableConfig(
         tags=[],
         metadata={},
         callbacks=None,
         recursion_limit=25,
+        run_id=None,
     )
     if var_config := var_child_runnable_config.get():
         empty.update(
             cast(RunnableConfig, {k: v for k, v in var_config.items() if v is not None})
         )
     if config is not None:
         empty.update(
             cast(RunnableConfig, {k: v for k, v in config.items() if v is not None})
         )
+    for key, value in empty.get("configurable", {}).items():
+        if isinstance(value, (str, int, float, bool)) and key not in empty["metadata"]:
+            empty["metadata"][key] = value
     return empty
 
 
 def get_config_list(
     config: Optional[Union[RunnableConfig, List[RunnableConfig]]], length: int
 ) -> List[RunnableConfig]:
     """Get a list of configs from a single config or a list of configs.
@@ -151,19 +163,29 @@
         raise ValueError(f"length must be >= 0, but got {length}")
     if isinstance(config, list) and len(config) != length:
         raise ValueError(
             f"config must be a list of the same length as inputs, "
             f"but got {len(config)} configs for {length} inputs"
         )
 
-    return (
-        list(map(ensure_config, config))
-        if isinstance(config, list)
-        else [ensure_config(config) for _ in range(length)]
-    )
+    if isinstance(config, list):
+        return list(map(ensure_config, config))
+    if length > 1 and isinstance(config, dict) and config.get("run_id") is not None:
+        warnings.warn(
+            "Provided run_id be used only for the first element of the batch.",
+            category=RuntimeWarning,
+        )
+        subsequent = cast(
+            RunnableConfig, {k: v for k, v in config.items() if k != "run_id"}
+        )
+        return [
+            ensure_config(subsequent) if i else ensure_config(config)
+            for i in range(length)
+        ]
+    return [ensure_config(config) for i in range(length)]
 
 
 def patch_config(
     config: Optional[RunnableConfig],
     *,
     callbacks: Optional[BaseCallbackManager] = None,
     recursion_limit: Optional[int] = None,
@@ -192,14 +214,16 @@
     config = ensure_config(config)
     if callbacks is not None:
         # If we're replacing callbacks, we need to unset run_name
         # As that should apply only to the same run as the original callbacks
         config["callbacks"] = callbacks
         if "run_name" in config:
             del config["run_name"]
+        if "run_id" in config:
+            del config["run_id"]
     if recursion_limit is not None:
         config["recursion_limit"] = recursion_limit
     if max_concurrency is not None:
         config["max_concurrency"] = max_concurrency
     if run_name is not None:
         config["run_name"] = run_name
     if configurable is not None:
```

### Comparing `langchain_core-0.1.9/langchain_core/runnables/configurable.py` & `langchain_core-0.2.0rc1/langchain_core/runnables/configurable.py`

 * *Files 23% similar despite different names*

```diff
@@ -1,12 +1,13 @@
 from __future__ import annotations
 
 import enum
 import threading
 from abc import abstractmethod
+from functools import wraps
 from typing import (
     Any,
     AsyncIterator,
     Callable,
     Dict,
     Iterator,
     List,
@@ -22,14 +23,15 @@
 from langchain_core.pydantic_v1 import BaseModel
 from langchain_core.runnables.base import Runnable, RunnableSerializable
 from langchain_core.runnables.config import (
     RunnableConfig,
     ensure_config,
     get_config_list,
     get_executor_for_config,
+    merge_configs,
 )
 from langchain_core.runnables.graph import Graph
 from langchain_core.runnables.utils import (
     AnyConfigurableField,
     ConfigurableField,
     ConfigurableFieldMultiOption,
     ConfigurableFieldSingleOption,
@@ -38,18 +40,20 @@
     Output,
     gather_with_concurrency,
     get_unique_config_specs,
 )
 
 
 class DynamicRunnable(RunnableSerializable[Input, Output]):
-    """A Serializable Runnable that can be dynamically configured."""
+    """Serializable Runnable that can be dynamically configured."""
 
     default: RunnableSerializable[Input, Output]
 
+    config: Optional[RunnableConfig] = None
+
     class Config:
         arbitrary_types_allowed = True
 
     @classmethod
     def is_lc_serializable(cls) -> bool:
         return True
 
@@ -65,55 +69,73 @@
     @property
     def OutputType(self) -> Type[Output]:
         return self.default.OutputType
 
     def get_input_schema(
         self, config: Optional[RunnableConfig] = None
     ) -> Type[BaseModel]:
-        runnable, config = self._prepare(config)
+        runnable, config = self.prepare(config)
         return runnable.get_input_schema(config)
 
     def get_output_schema(
         self, config: Optional[RunnableConfig] = None
     ) -> Type[BaseModel]:
-        runnable, config = self._prepare(config)
+        runnable, config = self.prepare(config)
         return runnable.get_output_schema(config)
 
     def get_graph(self, config: Optional[RunnableConfig] = None) -> Graph:
-        runnable, config = self._prepare(config)
+        runnable, config = self.prepare(config)
         return runnable.get_graph(config)
 
+    def with_config(
+        self,
+        config: Optional[RunnableConfig] = None,
+        # Sadly Unpack is not well supported by mypy so this will have to be untyped
+        **kwargs: Any,
+    ) -> Runnable[Input, Output]:
+        return self.__class__(
+            **{**self.__dict__, "config": ensure_config(merge_configs(config, kwargs))}  # type: ignore[arg-type]
+        )
+
+    def prepare(
+        self, config: Optional[RunnableConfig] = None
+    ) -> Tuple[Runnable[Input, Output], RunnableConfig]:
+        runnable: Runnable[Input, Output] = self
+        while isinstance(runnable, DynamicRunnable):
+            runnable, config = runnable._prepare(merge_configs(runnable.config, config))
+        return runnable, cast(RunnableConfig, config)
+
     @abstractmethod
     def _prepare(
         self, config: Optional[RunnableConfig] = None
     ) -> Tuple[Runnable[Input, Output], RunnableConfig]:
         ...
 
     def invoke(
         self, input: Input, config: Optional[RunnableConfig] = None, **kwargs: Any
     ) -> Output:
-        runnable, config = self._prepare(config)
+        runnable, config = self.prepare(config)
         return runnable.invoke(input, config, **kwargs)
 
     async def ainvoke(
         self, input: Input, config: Optional[RunnableConfig] = None, **kwargs: Any
     ) -> Output:
-        runnable, config = self._prepare(config)
+        runnable, config = self.prepare(config)
         return await runnable.ainvoke(input, config, **kwargs)
 
     def batch(
         self,
         inputs: List[Input],
         config: Optional[Union[RunnableConfig, List[RunnableConfig]]] = None,
         *,
         return_exceptions: bool = False,
         **kwargs: Optional[Any],
     ) -> List[Output]:
         configs = get_config_list(config, len(inputs))
-        prepared = [self._prepare(c) for c in configs]
+        prepared = [self.prepare(c) for c in configs]
 
         if all(p is self.default for p, _ in prepared):
             return self.default.batch(
                 inputs,
                 [c for _, c in prepared],
                 return_exceptions=return_exceptions,
                 **kwargs,
@@ -147,15 +169,15 @@
         inputs: List[Input],
         config: Optional[Union[RunnableConfig, List[RunnableConfig]]] = None,
         *,
         return_exceptions: bool = False,
         **kwargs: Optional[Any],
     ) -> List[Output]:
         configs = get_config_list(config, len(inputs))
-        prepared = [self._prepare(c) for c in configs]
+        prepared = [self.prepare(c) for c in configs]
 
         if all(p is self.default for p, _ in prepared):
             return await self.default.abatch(
                 inputs,
                 [c for _, c in prepared],
                 return_exceptions=return_exceptions,
                 **kwargs,
@@ -182,74 +204,172 @@
 
     def stream(
         self,
         input: Input,
         config: Optional[RunnableConfig] = None,
         **kwargs: Optional[Any],
     ) -> Iterator[Output]:
-        runnable, config = self._prepare(config)
+        runnable, config = self.prepare(config)
         return runnable.stream(input, config, **kwargs)
 
     async def astream(
         self,
         input: Input,
         config: Optional[RunnableConfig] = None,
         **kwargs: Optional[Any],
     ) -> AsyncIterator[Output]:
-        runnable, config = self._prepare(config)
+        runnable, config = self.prepare(config)
         async for chunk in runnable.astream(input, config, **kwargs):
             yield chunk
 
     def transform(
         self,
         input: Iterator[Input],
         config: Optional[RunnableConfig] = None,
         **kwargs: Optional[Any],
     ) -> Iterator[Output]:
-        runnable, config = self._prepare(config)
+        runnable, config = self.prepare(config)
         return runnable.transform(input, config, **kwargs)
 
     async def atransform(
         self,
         input: AsyncIterator[Input],
         config: Optional[RunnableConfig] = None,
         **kwargs: Optional[Any],
     ) -> AsyncIterator[Output]:
-        runnable, config = self._prepare(config)
+        runnable, config = self.prepare(config)
         async for chunk in runnable.atransform(input, config, **kwargs):
             yield chunk
 
+    def __getattr__(self, name: str) -> Any:
+        attr = getattr(self.default, name)
+        if callable(attr):
+
+            @wraps(attr)
+            def wrapper(*args: Any, **kwargs: Any) -> Any:
+                for key, arg in kwargs.items():
+                    if key == "config" and (
+                        isinstance(arg, dict)
+                        and "configurable" in arg
+                        and isinstance(arg["configurable"], dict)
+                    ):
+                        runnable, config = self.prepare(cast(RunnableConfig, arg))
+                        kwargs = {**kwargs, "config": config}
+                        return getattr(runnable, name)(*args, **kwargs)
+
+                for idx, arg in enumerate(args):
+                    if (
+                        isinstance(arg, dict)
+                        and "configurable" in arg
+                        and isinstance(arg["configurable"], dict)
+                    ):
+                        runnable, config = self.prepare(cast(RunnableConfig, arg))
+                        argsl = list(args)
+                        argsl[idx] = config
+                        return getattr(runnable, name)(*argsl, **kwargs)
+
+                if self.config:
+                    runnable, config = self.prepare()
+                    return getattr(runnable, name)(*args, **kwargs)
+
+                return attr(*args, **kwargs)
+
+            return wrapper
+
+        else:
+            return attr
+
 
 class RunnableConfigurableFields(DynamicRunnable[Input, Output]):
-    """A Runnable that can be dynamically configured."""
+    """Runnable that can be dynamically configured.
+
+    A RunnableConfigurableFields should be initiated using the
+    `configurable_fields` method of a Runnable.
+
+    Here is an example of using a RunnableConfigurableFields with LLMs:
+
+        .. code-block:: python
+
+            from langchain_core.prompts import PromptTemplate
+            from langchain_core.runnables import ConfigurableField
+            from langchain_openai import ChatOpenAI
+
+            model = ChatOpenAI(temperature=0).configurable_fields(
+                temperature=ConfigurableField(
+                    id="temperature",
+                    name="LLM Temperature",
+                    description="The temperature of the LLM",
+                )
+            )
+            # This creates a RunnableConfigurableFields for a chat model.
+
+            # When invoking the created RunnableSequence, you can pass in the
+            # value for your ConfigurableField's id which in this case
+            # will be change in temperature
+
+            prompt = PromptTemplate.from_template("Pick a random number above {x}")
+            chain = prompt | model
+
+            chain.invoke({"x": 0})
+            chain.invoke({"x": 0}, config={"configurable": {"temperature": 0.9}})
+
+
+    Here is an example of using a RunnableConfigurableFields with HubRunnables:
+
+        .. code-block:: python
+
+            from langchain_core.prompts import PromptTemplate
+            from langchain_core.runnables import ConfigurableField
+            from langchain_openai import ChatOpenAI
+            from langchain.runnables.hub import HubRunnable
+
+            prompt = HubRunnable("rlm/rag-prompt").configurable_fields(
+                owner_repo_commit=ConfigurableField(
+                    id="hub_commit",
+                    name="Hub Commit",
+                    description="The Hub commit to pull from",
+                )
+            )
+
+            prompt.invoke({"question": "foo", "context": "bar"})
+
+            # Invoking prompt with `with_config` method
+
+            prompt.invoke(
+                {"question": "foo", "context": "bar"},
+                config={"configurable": {"hub_commit": "rlm/rag-prompt-llama"}},
+            )
+    """
 
     fields: Dict[str, AnyConfigurableField]
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "runnable"]
 
     @property
     def config_specs(self) -> List[ConfigurableFieldSpec]:
         return get_unique_config_specs(
             [
-                ConfigurableFieldSpec(
-                    id=spec.id,
-                    name=spec.name,
-                    description=spec.description
-                    or self.default.__fields__[field_name].field_info.description,
-                    annotation=spec.annotation
-                    or self.default.__fields__[field_name].annotation,
-                    default=getattr(self.default, field_name),
-                    is_shared=spec.is_shared,
-                )
-                if isinstance(spec, ConfigurableField)
-                else make_options_spec(
-                    spec, self.default.__fields__[field_name].field_info.description
+                (
+                    ConfigurableFieldSpec(
+                        id=spec.id,
+                        name=spec.name,
+                        description=spec.description
+                        or self.default.__fields__[field_name].field_info.description,
+                        annotation=spec.annotation
+                        or self.default.__fields__[field_name].annotation,
+                        default=getattr(self.default, field_name),
+                        is_shared=spec.is_shared,
+                    )
+                    if isinstance(spec, ConfigurableField)
+                    else make_options_spec(
+                        spec, self.default.__fields__[field_name].field_info.description
+                    )
                 )
                 for field_name, spec in self.fields.items()
             ]
             + list(self.default.config_specs)
         )
 
     def configurable_fields(
@@ -283,25 +403,30 @@
         configurable = {
             **configurable_fields,
             **configurable_single_options,
             **configurable_multi_options,
         }
 
         if configurable:
+            init_params = {
+                k: v
+                for k, v in self.default.__dict__.items()
+                if k in self.default.__fields__
+            }
             return (
-                self.default.__class__(**{**self.default.__dict__, **configurable}),
+                self.default.__class__(**{**init_params, **configurable}),
                 config,
             )
         else:
             return (self.default, config)
 
 
 # Before Python 3.11 native StrEnum is not available
 class StrEnum(str, enum.Enum):
-    """A string enum."""
+    """String enum."""
 
     pass
 
 
 _enums_for_spec: WeakValueDictionary[
     Union[
         ConfigurableFieldSingleOption, ConfigurableFieldMultiOption, ConfigurableField
@@ -309,15 +434,68 @@
     Type[StrEnum],
 ] = WeakValueDictionary()
 
 _enums_for_spec_lock = threading.Lock()
 
 
 class RunnableConfigurableAlternatives(DynamicRunnable[Input, Output]):
-    """A Runnable that can be dynamically configured."""
+    """Runnable that can be dynamically configured.
+
+    A RunnableConfigurableAlternatives should be initiated using the
+    `configurable_alternatives` method of a Runnable or can be
+    initiated directly as well.
+
+    Here is an example of using a RunnableConfigurableAlternatives that uses
+    alternative prompts to illustrate its functionality:
+
+        .. code-block:: python
+
+            from langchain_core.runnables import ConfigurableField
+            from langchain_openai import ChatOpenAI
+
+            # This creates a RunnableConfigurableAlternatives for Prompt Runnable
+            # with two alternatives.
+            prompt = PromptTemplate.from_template(
+                "Tell me a joke about {topic}"
+            ).configurable_alternatives(
+                ConfigurableField(id="prompt"),
+                default_key="joke",
+                poem=PromptTemplate.from_template("Write a short poem about {topic}")
+            )
+
+            # When invoking the created RunnableSequence, you can pass in the
+            # value for your ConfigurableField's id which in this case will either be
+            # `joke` or `poem`.
+            chain = prompt | ChatOpenAI(model="gpt-3.5-turbo-0125", temperature=0)
+
+            # The `with_config` method brings in the desired Prompt Runnable in your
+            # Runnable Sequence.
+            chain.with_config(configurable={"prompt": "poem"}).invoke({"topic": "bears"})
+
+
+    Equivalently, you can initialize RunnableConfigurableAlternatives directly
+    and use in LCEL in the same way:
+
+        .. code-block:: python
+
+            from langchain_core.runnables import ConfigurableField
+            from langchain_core.runnables.configurable import RunnableConfigurableAlternatives
+            from langchain_openai import ChatOpenAI
+
+            prompt = RunnableConfigurableAlternatives(
+                which=ConfigurableField(id='prompt'),
+                default=PromptTemplate.from_template("Tell me a joke about {topic}"),
+                default_key='joke',
+                prefix_keys=False,
+                alternatives={"poem":PromptTemplate.from_template("Write a short poem about {topic}")}
+            )
+            chain = prompt | ChatOpenAI(model="gpt-3.5-turbo-0125", temperature=0)
+            chain.with_config(configurable={"prompt": "poem"}).invoke({"topic": "bears"})
+
+    """  # noqa: E501
 
     which: ConfigurableField
 
     alternatives: Dict[
         str,
         Union[Runnable[Input, Output], Callable[[], Runnable[Input, Output]]],
     ]
@@ -368,30 +546,34 @@
                     for s in self.default.config_specs
                 ]
                 if self.prefix_keys
                 else self.default.config_specs
             )
             # config specs of the alternatives
             + [
-                prefix_config_spec(s, f"{self.which.id}=={alt_key}")
-                if self.prefix_keys
-                else s
+                (
+                    prefix_config_spec(s, f"{self.which.id}=={alt_key}")
+                    if self.prefix_keys
+                    else s
+                )
                 for alt_key, alt in self.alternatives.items()
                 if isinstance(alt, RunnableSerializable)
                 for s in alt.config_specs
             ]
         )
 
     def configurable_fields(
         self, **kwargs: AnyConfigurableField
     ) -> RunnableSerializable[Input, Output]:
         return self.__class__(
             which=self.which,
             default=self.default.configurable_fields(**kwargs),
             alternatives=self.alternatives,
+            default_key=self.default_key,
+            prefix_keys=self.prefix_keys,
         )
 
     def _prepare(
         self, config: Optional[RunnableConfig] = None
     ) -> Tuple[Runnable[Input, Output], RunnableConfig]:
         config = ensure_config(config)
         which = config.get("configurable", {}).get(self.which.id, self.default_key)
@@ -455,15 +637,16 @@
 
 
 def make_options_spec(
     spec: Union[ConfigurableFieldSingleOption, ConfigurableFieldMultiOption],
     description: Optional[str],
 ) -> ConfigurableFieldSpec:
     """Make a ConfigurableFieldSpec for a ConfigurableFieldSingleOption or
-    ConfigurableFieldMultiOption."""
+    ConfigurableFieldMultiOption.
+    """
     with _enums_for_spec_lock:
         if enum := _enums_for_spec.get(spec):
             pass
         else:
             enum = StrEnum(  # type: ignore[call-overload]
                 spec.name or spec.id,
                 ((v, v) for v in list(spec.options.keys())),
```

### Comparing `langchain_core-0.1.9/langchain_core/runnables/fallbacks.py` & `langchain_core-0.2.0rc1/langchain_core/runnables/retry.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,345 +1,342 @@
-import asyncio
 from typing import (
     TYPE_CHECKING,
     Any,
-    Iterator,
+    Dict,
     List,
     Optional,
-    Sequence,
     Tuple,
     Type,
+    TypeVar,
     Union,
+    cast,
 )
 
-from langchain_core.load.dump import dumpd
-from langchain_core.pydantic_v1 import BaseModel
-from langchain_core.runnables.base import Runnable, RunnableSerializable
-from langchain_core.runnables.config import (
-    RunnableConfig,
-    ensure_config,
-    get_async_callback_manager_for_config,
-    get_callback_manager_for_config,
-    get_config_list,
-    patch_config,
-)
-from langchain_core.runnables.utils import (
-    ConfigurableFieldSpec,
-    Input,
-    Output,
-    get_unique_config_specs,
+from tenacity import (
+    AsyncRetrying,
+    RetryCallState,
+    RetryError,
+    Retrying,
+    retry_if_exception_type,
+    stop_after_attempt,
+    wait_exponential_jitter,
 )
 
+from langchain_core.runnables.base import Input, Output, RunnableBindingBase
+from langchain_core.runnables.config import RunnableConfig, patch_config
+
 if TYPE_CHECKING:
-    from langchain_core.callbacks.manager import AsyncCallbackManagerForChainRun
+    from langchain_core.callbacks.manager import (
+        AsyncCallbackManagerForChainRun,
+        CallbackManagerForChainRun,
+    )
 
+    T = TypeVar("T", CallbackManagerForChainRun, AsyncCallbackManagerForChainRun)
+U = TypeVar("U")
 
-class RunnableWithFallbacks(RunnableSerializable[Input, Output]):
-    """A Runnable that can fallback to other Runnables if it fails.
 
-    External APIs (e.g., APIs for a language model) may at times experience
-    degraded performance or even downtime.
+class RunnableRetry(RunnableBindingBase[Input, Output]):
+    """Retry a Runnable if it fails.
 
-    In these cases, it can be useful to have a fallback runnable that can be
-    used in place of the original runnable (e.g., fallback to another LLM provider).
+    RunnableRetry can be used to add retry logic to any object
+    that subclasses the base Runnable.
 
-    Fallbacks can be defined at the level of a single runnable, or at the level
-    of a chain of runnables. Fallbacks are tried in order until one succeeds or
-    all fail.
+    Such retries are especially useful for network calls that may fail
+    due to transient errors.
 
-    While you can instantiate a ``RunnableWithFallbacks`` directly, it is usually
-    more convenient to use the ``with_fallbacks`` method on a runnable.
+    The RunnableRetry is implemented as a RunnableBinding. The easiest
+    way to use it is through the `.with_retry()` method on all Runnables.
 
     Example:
 
+    Here's an example that uses a RunnableLambda to raise an exception
+
         .. code-block:: python
 
-            from langchain_core.chat_models.openai import ChatOpenAI
-            from langchain_core.chat_models.anthropic import ChatAnthropic
+            import time
 
-            model = ChatAnthropic().with_fallbacks([ChatOpenAI()])
-            # Will usually use ChatAnthropic, but fallback to ChatOpenAI
-            # if ChatAnthropic fails.
-            model.invoke('hello')
-
-            # And you can also use fallbacks at the level of a chain.
-            # Here if both LLM providers fail, we'll fallback to a good hardcoded
-            # response.
+            def foo(input) -> None:
+                '''Fake function that raises an exception.'''
+                raise ValueError(f"Invoking foo failed. At time {time.time()}")
+
+            runnable = RunnableLambda(foo)
+
+            runnable_with_retries = runnable.with_retry(
+                retry_if_exception_type=(ValueError,), # Retry only on ValueError
+                wait_exponential_jitter=True, # Add jitter to the exponential backoff
+                stop_after_attempt=2, # Try twice
+            )
 
-            from langchain_core.prompts import PromptTemplate
-            from langchain_core.output_parser import StrOutputParser
-            from langchain_core.runnables import RunnableLambda
+            # The method invocation above is equivalent to the longer form below:
 
-            def when_all_is_lost(inputs):
-                return ("Looks like our LLM providers are down. "
-                        "Here's a nice 🦜️ emoji for you instead.")
-
-            chain_with_fallback = (
-                PromptTemplate.from_template('Tell me a joke about {topic}')
-                | model
-                | StrOutputParser()
-            ).with_fallbacks([RunnableLambda(when_all_is_lost)])
-    """
+            runnable_with_retries = RunnableRetry(
+                bound=runnable,
+                retry_exception_types=(ValueError,),
+                max_attempt_number=2,
+                wait_exponential_jitter=True
+            )
 
-    runnable: Runnable[Input, Output]
-    """The runnable to run first."""
-    fallbacks: Sequence[Runnable[Input, Output]]
-    """A sequence of fallbacks to try."""
-    exceptions_to_handle: Tuple[Type[BaseException], ...] = (Exception,)
-    """The exceptions on which fallbacks should be tried.
-    
-    Any exception that is not a subclass of these exceptions will be raised immediately.
-    """
+    This logic can be used to retry any Runnable, including a chain of Runnables,
+    but in general it's best practice to keep the scope of the retry as small as
+    possible. For example, if you have a chain of Runnables, you should only retry
+    the Runnable that is likely to fail, not the entire chain.
 
-    class Config:
-        arbitrary_types_allowed = True
+    Example:
 
-    @property
-    def InputType(self) -> Type[Input]:
-        return self.runnable.InputType
+        .. code-block:: python
 
-    @property
-    def OutputType(self) -> Type[Output]:
-        return self.runnable.OutputType
+            from langchain_core.chat_models import ChatOpenAI
+            from langchain_core.prompts import PromptTemplate
 
-    def get_input_schema(
-        self, config: Optional[RunnableConfig] = None
-    ) -> Type[BaseModel]:
-        return self.runnable.get_input_schema(config)
-
-    def get_output_schema(
-        self, config: Optional[RunnableConfig] = None
-    ) -> Type[BaseModel]:
-        return self.runnable.get_output_schema(config)
+            template = PromptTemplate.from_template("tell me a joke about {topic}.")
+            model = ChatOpenAI(temperature=0.5)
 
-    @property
-    def config_specs(self) -> List[ConfigurableFieldSpec]:
-        return get_unique_config_specs(
-            spec
-            for step in [self.runnable, *self.fallbacks]
-            for spec in step.config_specs
-        )
+            # Good
+            chain = template | model.with_retry()
 
-    @classmethod
-    def is_lc_serializable(cls) -> bool:
-        return True
+            # Bad
+            chain = template | model
+            retryable_chain = chain.with_retry()
+    """
+
+    retry_exception_types: Tuple[Type[BaseException], ...] = (Exception,)
+    """The exception types to retry on. By default all exceptions are retried.
+    
+    In general you should only retry on exceptions that are likely to be
+    transient, such as network errors.
+    
+    Good exceptions to retry are all server errors (5xx) and selected client
+    errors (4xx) such as 429 Too Many Requests.
+    """
+
+    wait_exponential_jitter: bool = True
+    """Whether to add jitter to the exponential backoff."""
+
+    max_attempt_number: int = 3
+    """The maximum number of attempts to retry the runnable."""
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "runnable"]
 
     @property
-    def runnables(self) -> Iterator[Runnable[Input, Output]]:
-        yield self.runnable
-        yield from self.fallbacks
+    def _kwargs_retrying(self) -> Dict[str, Any]:
+        kwargs: Dict[str, Any] = dict()
 
-    def invoke(
-        self, input: Input, config: Optional[RunnableConfig] = None, **kwargs: Any
+        if self.max_attempt_number:
+            kwargs["stop"] = stop_after_attempt(self.max_attempt_number)
+
+        if self.wait_exponential_jitter:
+            kwargs["wait"] = wait_exponential_jitter()
+
+        if self.retry_exception_types:
+            kwargs["retry"] = retry_if_exception_type(self.retry_exception_types)
+
+        return kwargs
+
+    def _sync_retrying(self, **kwargs: Any) -> Retrying:
+        return Retrying(**self._kwargs_retrying, **kwargs)
+
+    def _async_retrying(self, **kwargs: Any) -> AsyncRetrying:
+        return AsyncRetrying(**self._kwargs_retrying, **kwargs)
+
+    def _patch_config(
+        self,
+        config: RunnableConfig,
+        run_manager: "T",
+        retry_state: RetryCallState,
+    ) -> RunnableConfig:
+        attempt = retry_state.attempt_number
+        tag = "retry:attempt:{}".format(attempt) if attempt > 1 else None
+        return patch_config(config, callbacks=run_manager.get_child(tag))
+
+    def _patch_config_list(
+        self,
+        config: List[RunnableConfig],
+        run_manager: List["T"],
+        retry_state: RetryCallState,
+    ) -> List[RunnableConfig]:
+        return [
+            self._patch_config(c, rm, retry_state) for c, rm in zip(config, run_manager)
+        ]
+
+    def _invoke(
+        self,
+        input: Input,
+        run_manager: "CallbackManagerForChainRun",
+        config: RunnableConfig,
+        **kwargs: Any,
     ) -> Output:
-        # setup callbacks
-        config = ensure_config(config)
-        callback_manager = get_callback_manager_for_config(config)
-        # start the root run
-        run_manager = callback_manager.on_chain_start(
-            dumpd(self), input, name=config.get("run_name")
-        )
-        first_error = None
-        for runnable in self.runnables:
-            try:
-                output = runnable.invoke(
+        for attempt in self._sync_retrying(reraise=True):
+            with attempt:
+                result = super().invoke(
                     input,
-                    patch_config(config, callbacks=run_manager.get_child()),
+                    self._patch_config(config, run_manager, attempt.retry_state),
                     **kwargs,
                 )
-            except self.exceptions_to_handle as e:
-                if first_error is None:
-                    first_error = e
-            except BaseException as e:
-                run_manager.on_chain_error(e)
-                raise e
-            else:
-                run_manager.on_chain_end(output)
-                return output
-        if first_error is None:
-            raise ValueError("No error stored at end of fallbacks.")
-        run_manager.on_chain_error(first_error)
-        raise first_error
+            if attempt.retry_state.outcome and not attempt.retry_state.outcome.failed:
+                attempt.retry_state.set_result(result)
+        return result
 
-    async def ainvoke(
+    def invoke(
+        self, input: Input, config: Optional[RunnableConfig] = None, **kwargs: Any
+    ) -> Output:
+        return self._call_with_config(self._invoke, input, config, **kwargs)
+
+    async def _ainvoke(
         self,
         input: Input,
-        config: Optional[RunnableConfig] = None,
-        **kwargs: Optional[Any],
+        run_manager: "AsyncCallbackManagerForChainRun",
+        config: RunnableConfig,
+        **kwargs: Any,
     ) -> Output:
-        # setup callbacks
-        config = ensure_config(config)
-        callback_manager = get_async_callback_manager_for_config(config)
-        # start the root run
-        run_manager = await callback_manager.on_chain_start(
-            dumpd(self), input, name=config.get("run_name")
-        )
-
-        first_error = None
-        for runnable in self.runnables:
-            try:
-                output = await runnable.ainvoke(
+        async for attempt in self._async_retrying(reraise=True):
+            with attempt:
+                result = await super().ainvoke(
                     input,
-                    patch_config(config, callbacks=run_manager.get_child()),
+                    self._patch_config(config, run_manager, attempt.retry_state),
                     **kwargs,
                 )
-            except self.exceptions_to_handle as e:
-                if first_error is None:
-                    first_error = e
-            except BaseException as e:
-                await run_manager.on_chain_error(e)
-                raise e
+            if attempt.retry_state.outcome and not attempt.retry_state.outcome.failed:
+                attempt.retry_state.set_result(result)
+        return result
+
+    async def ainvoke(
+        self, input: Input, config: Optional[RunnableConfig] = None, **kwargs: Any
+    ) -> Output:
+        return await self._acall_with_config(self._ainvoke, input, config, **kwargs)
+
+    def _batch(
+        self,
+        inputs: List[Input],
+        run_manager: List["CallbackManagerForChainRun"],
+        config: List[RunnableConfig],
+        **kwargs: Any,
+    ) -> List[Union[Output, Exception]]:
+        results_map: Dict[int, Output] = {}
+
+        def pending(iterable: List[U]) -> List[U]:
+            return [item for idx, item in enumerate(iterable) if idx not in results_map]
+
+        try:
+            for attempt in self._sync_retrying():
+                with attempt:
+                    # Get the results of the inputs that have not succeeded yet.
+                    result = super().batch(
+                        pending(inputs),
+                        self._patch_config_list(
+                            pending(config), pending(run_manager), attempt.retry_state
+                        ),
+                        return_exceptions=True,
+                        **kwargs,
+                    )
+                    # Register the results of the inputs that have succeeded.
+                    first_exception = None
+                    for i, r in enumerate(result):
+                        if isinstance(r, Exception):
+                            if not first_exception:
+                                first_exception = r
+                            continue
+                        results_map[i] = r
+                    # If any exception occurred, raise it, to retry the failed ones
+                    if first_exception:
+                        raise first_exception
+                if (
+                    attempt.retry_state.outcome
+                    and not attempt.retry_state.outcome.failed
+                ):
+                    attempt.retry_state.set_result(result)
+        except RetryError as e:
+            try:
+                result
+            except UnboundLocalError:
+                result = cast(List[Output], [e] * len(inputs))
+
+        outputs: List[Union[Output, Exception]] = []
+        for idx, _ in enumerate(inputs):
+            if idx in results_map:
+                outputs.append(results_map[idx])
             else:
-                await run_manager.on_chain_end(output)
-                return output
-        if first_error is None:
-            raise ValueError("No error stored at end of fallbacks.")
-        await run_manager.on_chain_error(first_error)
-        raise first_error
+                outputs.append(result.pop(0))
+        return outputs
 
     def batch(
         self,
         inputs: List[Input],
         config: Optional[Union[RunnableConfig, List[RunnableConfig]]] = None,
         *,
         return_exceptions: bool = False,
-        **kwargs: Optional[Any],
+        **kwargs: Any,
     ) -> List[Output]:
-        from langchain_core.callbacks.manager import CallbackManager
-
-        if return_exceptions:
-            raise NotImplementedError()
-
-        if not inputs:
-            return []
-
-        # setup callbacks
-        configs = get_config_list(config, len(inputs))
-        callback_managers = [
-            CallbackManager.configure(
-                inheritable_callbacks=config.get("callbacks"),
-                local_callbacks=None,
-                verbose=False,
-                inheritable_tags=config.get("tags"),
-                local_tags=None,
-                inheritable_metadata=config.get("metadata"),
-                local_metadata=None,
-            )
-            for config in configs
-        ]
-        # start the root runs, one per input
-        run_managers = [
-            cm.on_chain_start(
-                dumpd(self),
-                input if isinstance(input, dict) else {"input": input},
-                name=config.get("run_name"),
-            )
-            for cm, input, config in zip(callback_managers, inputs, configs)
-        ]
+        return self._batch_with_config(
+            self._batch, inputs, config, return_exceptions=return_exceptions, **kwargs
+        )
 
-        first_error = None
-        for runnable in self.runnables:
+    async def _abatch(
+        self,
+        inputs: List[Input],
+        run_manager: List["AsyncCallbackManagerForChainRun"],
+        config: List[RunnableConfig],
+        **kwargs: Any,
+    ) -> List[Union[Output, Exception]]:
+        results_map: Dict[int, Output] = {}
+
+        def pending(iterable: List[U]) -> List[U]:
+            return [item for idx, item in enumerate(iterable) if idx not in results_map]
+
+        try:
+            async for attempt in self._async_retrying():
+                with attempt:
+                    # Get the results of the inputs that have not succeeded yet.
+                    result = await super().abatch(
+                        pending(inputs),
+                        self._patch_config_list(
+                            pending(config), pending(run_manager), attempt.retry_state
+                        ),
+                        return_exceptions=True,
+                        **kwargs,
+                    )
+                    # Register the results of the inputs that have succeeded.
+                    first_exception = None
+                    for i, r in enumerate(result):
+                        if isinstance(r, Exception):
+                            if not first_exception:
+                                first_exception = r
+                            continue
+                        results_map[i] = r
+                    # If any exception occurred, raise it, to retry the failed ones
+                    if first_exception:
+                        raise first_exception
+                if (
+                    attempt.retry_state.outcome
+                    and not attempt.retry_state.outcome.failed
+                ):
+                    attempt.retry_state.set_result(result)
+        except RetryError as e:
             try:
-                outputs = runnable.batch(
-                    inputs,
-                    [
-                        # each step a child run of the corresponding root run
-                        patch_config(config, callbacks=rm.get_child())
-                        for rm, config in zip(run_managers, configs)
-                    ],
-                    return_exceptions=return_exceptions,
-                    **kwargs,
-                )
-            except self.exceptions_to_handle as e:
-                if first_error is None:
-                    first_error = e
-            except BaseException as e:
-                for rm in run_managers:
-                    rm.on_chain_error(e)
-                raise e
+                result
+            except UnboundLocalError:
+                result = cast(List[Output], [e] * len(inputs))
+
+        outputs: List[Union[Output, Exception]] = []
+        for idx, _ in enumerate(inputs):
+            if idx in results_map:
+                outputs.append(results_map[idx])
             else:
-                for rm, output in zip(run_managers, outputs):
-                    rm.on_chain_end(output)
-                return outputs
-        if first_error is None:
-            raise ValueError("No error stored at end of fallbacks.")
-        for rm in run_managers:
-            rm.on_chain_error(first_error)
-        raise first_error
+                outputs.append(result.pop(0))
+        return outputs
 
     async def abatch(
         self,
         inputs: List[Input],
         config: Optional[Union[RunnableConfig, List[RunnableConfig]]] = None,
         *,
         return_exceptions: bool = False,
-        **kwargs: Optional[Any],
+        **kwargs: Any,
     ) -> List[Output]:
-        from langchain_core.callbacks.manager import AsyncCallbackManager
-
-        if return_exceptions:
-            raise NotImplementedError()
-
-        if not inputs:
-            return []
-
-        # setup callbacks
-        configs = get_config_list(config, len(inputs))
-        callback_managers = [
-            AsyncCallbackManager.configure(
-                inheritable_callbacks=config.get("callbacks"),
-                local_callbacks=None,
-                verbose=False,
-                inheritable_tags=config.get("tags"),
-                local_tags=None,
-                inheritable_metadata=config.get("metadata"),
-                local_metadata=None,
-            )
-            for config in configs
-        ]
-        # start the root runs, one per input
-        run_managers: List[AsyncCallbackManagerForChainRun] = await asyncio.gather(
-            *(
-                cm.on_chain_start(
-                    dumpd(self),
-                    input,
-                    name=config.get("run_name"),
-                )
-                for cm, input, config in zip(callback_managers, inputs, configs)
-            )
+        return await self._abatch_with_config(
+            self._abatch, inputs, config, return_exceptions=return_exceptions, **kwargs
         )
 
-        first_error = None
-        for runnable in self.runnables:
-            try:
-                outputs = await runnable.abatch(
-                    inputs,
-                    [
-                        # each step a child run of the corresponding root run
-                        patch_config(config, callbacks=rm.get_child())
-                        for rm, config in zip(run_managers, configs)
-                    ],
-                    return_exceptions=return_exceptions,
-                    **kwargs,
-                )
-            except self.exceptions_to_handle as e:
-                if first_error is None:
-                    first_error = e
-            except BaseException as e:
-                await asyncio.gather(*(rm.on_chain_error(e) for rm in run_managers))
-            else:
-                await asyncio.gather(
-                    *(
-                        rm.on_chain_end(output)
-                        for rm, output in zip(run_managers, outputs)
-                    )
-                )
-                return outputs
-        if first_error is None:
-            raise ValueError("No error stored at end of fallbacks.")
-        await asyncio.gather(*(rm.on_chain_error(first_error) for rm in run_managers))
-        raise first_error
+    # stream() and transform() are not retried because retrying a stream
+    # is not very intuitive.
```

#### encoding

```diff
@@ -1 +1 @@
-utf-8
+us-ascii
```

### Comparing `langchain_core-0.1.9/langchain_core/runnables/graph_draw.py` & `langchain_core-0.2.0rc1/langchain_core/runnables/graph_ascii.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,13 +1,15 @@
 """Draws DAG in ASCII.
 Adapted from https://github.com/iterative/dvc/blob/main/dvc/dagascii.py"""
 
 import math
 import os
-from typing import Any, Mapping, Sequence, Tuple
+from typing import Any, Mapping, Sequence
+
+from langchain_core.runnables.graph import Edge as LangEdge
 
 
 class VertexViewer:
     """Class to define vertex box boundaries that will be accounted for during
     graph building by grandalf.
 
     Args:
@@ -152,38 +154,40 @@
         self.point(x0, y0, "+")
         self.point(x0 + width, y0, "+")
         self.point(x0, y0 + height, "+")
         self.point(x0 + width, y0 + height, "+")
 
 
 def _build_sugiyama_layout(
-    vertices: Mapping[str, str], edges: Sequence[Tuple[str, str]]
+    vertices: Mapping[str, str], edges: Sequence[LangEdge]
 ) -> Any:
     try:
         from grandalf.graphs import Edge, Graph, Vertex  # type: ignore[import]
         from grandalf.layouts import SugiyamaLayout  # type: ignore[import]
         from grandalf.routing import (  # type: ignore[import]
             EdgeViewer,
             route_with_lines,
         )
-    except ImportError:
-        print("Install grandalf to draw graphs. `pip install grandalf`")
-        raise
+    except ImportError as exc:
+        raise ImportError(
+            "Install grandalf to draw graphs: `pip install grandalf`."
+        ) from exc
+
     #
     # Just a reminder about naming conventions:
     # +------------X
     # |
     # |
     # |
     # |
     # Y
     #
 
     vertices_ = {id: Vertex(f" {data} ") for id, data in vertices.items()}
-    edges_ = [Edge(vertices_[s], vertices_[e]) for s, e in edges]
+    edges_ = [Edge(vertices_[s], vertices_[e], data=cond) for s, e, _, cond in edges]
     vertices_list = vertices_.values()
     graph = Graph(vertices_list, edges_)
 
     for vertex in vertices_list:
         vertex.view = VertexViewer(vertex.data)
 
     # NOTE: determine min box length to create the best layout
@@ -203,26 +207,25 @@
     sug.route_edge = route_with_lines
 
     sug.draw()
 
     return sug
 
 
-def draw(vertices: Mapping[str, str], edges: Sequence[Tuple[str, str]]) -> str:
+def draw_ascii(vertices: Mapping[str, str], edges: Sequence[LangEdge]) -> str:
     """Build a DAG and draw it in ASCII.
 
     Args:
         vertices (list): list of graph vertices.
         edges (list): list of graph edges.
 
     Returns:
         str: ASCII representation
 
     Example:
-        >>> from dvc.dagascii import draw
         >>> vertices = [1, 2, 3, 4]
         >>> edges = [(1, 2), (2, 3), (2, 4), (1, 4)]
         >>> print(draw(vertices, edges))
         +---+     +---+
         | 3 |     | 4 |
         +---+    *+---+
           *    **   *
@@ -281,15 +284,15 @@
             end_y = int(round(end[1] - miny))
 
             assert start_x >= 0
             assert start_y >= 0
             assert end_x >= 0
             assert end_y >= 0
 
-            canvas.line(start_x, start_y, end_x, end_y, "*")
+            canvas.line(start_x, start_y, end_x, end_y, "." if edge.data else "*")
 
     for vertex in sug.g.sV:
         # NOTE: moving boxes w/2 to the left
         x = vertex.view.xy[0] - vertex.view.w / 2.0
         y = vertex.view.xy[1]
 
         canvas.box(
```

### Comparing `langchain_core-0.1.9/langchain_core/runnables/history.py` & `langchain_core-0.2.0rc1/langchain_core/runnables/history.py`

 * *Files 11% similar despite different names*

```diff
@@ -11,103 +11,187 @@
     Sequence,
     Type,
     Union,
 )
 
 from langchain_core.chat_history import BaseChatMessageHistory
 from langchain_core.load.load import load
-from langchain_core.pydantic_v1 import BaseModel, create_model
+from langchain_core.pydantic_v1 import BaseModel
 from langchain_core.runnables.base import Runnable, RunnableBindingBase, RunnableLambda
-from langchain_core.runnables.config import run_in_executor
 from langchain_core.runnables.passthrough import RunnablePassthrough
 from langchain_core.runnables.utils import (
     ConfigurableFieldSpec,
+    create_model,
     get_unique_config_specs,
 )
 
 if TYPE_CHECKING:
+    from langchain_core.language_models import LanguageModelLike
     from langchain_core.messages import BaseMessage
     from langchain_core.runnables.config import RunnableConfig
     from langchain_core.tracers.schemas import Run
 
 
 MessagesOrDictWithMessages = Union[Sequence["BaseMessage"], Dict[str, Any]]
 GetSessionHistoryCallable = Callable[..., BaseChatMessageHistory]
 
 
 class RunnableWithMessageHistory(RunnableBindingBase):
-    """A runnable that manages chat message history for another runnable.
+    """Runnable that manages chat message history for another Runnable.
 
-    Base runnable must have inputs and outputs that can be converted to a list of BaseMessages.
+    A chat message history is a sequence of messages that represent a conversation.
 
-    RunnableWithMessageHistory must always be called with a config that contains session_id, e.g. ``{"configurable": {"session_id": "<SESSION_ID>"}}`.
+    RunnableWithMessageHistory wraps another Runnable and manages the chat message
+    history for it; it is responsible for reading and updating the chat message
+    history.
+
+    The formats supports for the inputs and outputs of the wrapped Runnable
+    are described below.
+
+    RunnableWithMessageHistory must always be called with a config that contains
+    the appropriate parameters for the chat message history factory.
+
+    By default the Runnable is expected to take a single configuration parameter
+    called `session_id` which is a string. This parameter is used to create a new
+    or look up an existing chat message history that matches the given session_id.
+
+    In this case, the invocation would look like this:
+
+    `with_history.invoke(..., config={"configurable": {"session_id": "bar"}})`
+    ; e.g., ``{"configurable": {"session_id": "<SESSION_ID>"}}``.
+
+    The configuration can be customized by passing in a list of
+    ``ConfigurableFieldSpec`` objects to the ``history_factory_config`` parameter (see
+    example below).
+
+    In the examples, we will use a chat message history with an in-memory
+    implementation to make it easy to experiment and see the results.
+
+    For production use cases, you will want to use a persistent implementation
+    of chat message history, such as ``RedisChatMessageHistory``.
+
+
+    Example: Chat message history with an in-memory implementation for testing.
+
+    .. code-block:: python
+
+        from operator import itemgetter
+        from typing import List
+
+        from langchain_openai.chat_models import ChatOpenAI
+
+        from langchain_core.chat_history import BaseChatMessageHistory
+        from langchain_core.documents import Document
+        from langchain_core.messages import BaseMessage, AIMessage
+        from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
+        from langchain_core.pydantic_v1 import BaseModel, Field
+        from langchain_core.runnables import (
+            RunnableLambda,
+            ConfigurableFieldSpec,
+            RunnablePassthrough,
+        )
+        from langchain_core.runnables.history import RunnableWithMessageHistory
+
+
+        class InMemoryHistory(BaseChatMessageHistory, BaseModel):
+            \"\"\"In memory implementation of chat message history.\"\"\"
+
+            messages: List[BaseMessage] = Field(default_factory=list)
+
+            def add_messages(self, messages: List[BaseMessage]) -> None:
+                \"\"\"Add a list of messages to the store\"\"\"
+                self.messages.extend(messages)
+
+            def clear(self) -> None:
+                self.messages = []
+
+        # Here we use a global variable to store the chat message history.
+        # This will make it easier to inspect it to see the underlying results.
+        store = {}
+
+        def get_by_session_id(session_id: str) -> BaseChatMessageHistory:
+            if session_id not in store:
+                store[session_id] = InMemoryHistory()
+            return store[session_id]
+
+
+        history = get_by_session_id("1")
+        history.add_message(AIMessage(content="hello"))
+        print(store)  # noqa: T201
+
+
+    Example where the wrapped Runnable takes a dictionary input:
 
-    Example (dict input):
         .. code-block:: python
 
             from typing import Optional
 
             from langchain_community.chat_models import ChatAnthropic
-            from langchain_community.chat_message_histories import RedisChatMessageHistory
-
             from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
             from langchain_core.runnables.history import RunnableWithMessageHistory
 
 
             prompt = ChatPromptTemplate.from_messages([
                 ("system", "You're an assistant who's good at {ability}"),
                 MessagesPlaceholder(variable_name="history"),
                 ("human", "{question}"),
             ])
 
             chain = prompt | ChatAnthropic(model="claude-2")
 
             chain_with_history = RunnableWithMessageHistory(
                 chain,
-                RedisChatMessageHistory,
+                # Uses the get_by_session_id function defined in the example
+                # above.
+                get_by_session_id,
                 input_messages_key="question",
                 history_messages_key="history",
             )
 
-            chain_with_history.invoke(
+            print(chain_with_history.invoke(  # noqa: T201
                 {"ability": "math", "question": "What does cosine mean?"},
                 config={"configurable": {"session_id": "foo"}}
-            )
-            # -> "Cosine is ..."
-            chain_with_history.invoke(
+            ))
+
+            # Uses the store defined in the example above.
+            print(store)  # noqa: T201
+
+            print(chain_with_history.invoke(  # noqa: T201
                 {"ability": "math", "question": "What's its inverse"},
                 config={"configurable": {"session_id": "foo"}}
-            )
-            # -> "The inverse of cosine is called arccosine ..."
+            ))
+
+            print(store)  # noqa: T201
 
 
-    Example (get_session_history takes two keys, user_id and conversation id):
+    Example where the session factory takes two keys, user_id and conversation id):
+
         .. code-block:: python
 
             store = {}
 
             def get_session_history(
                 user_id: str, conversation_id: str
-            ) -> ChatMessageHistory:
+            ) -> BaseChatMessageHistory:
                 if (user_id, conversation_id) not in store:
-                    store[(user_id, conversation_id)] = ChatMessageHistory()
+                    store[(user_id, conversation_id)] = InMemoryHistory()
                 return store[(user_id, conversation_id)]
 
             prompt = ChatPromptTemplate.from_messages([
                 ("system", "You're an assistant who's good at {ability}"),
                 MessagesPlaceholder(variable_name="history"),
                 ("human", "{question}"),
             ])
 
             chain = prompt | ChatAnthropic(model="claude-2")
 
             with_message_history = RunnableWithMessageHistory(
                 chain,
                 get_session_history=get_session_history,
-                input_messages_key="messages",
+                input_messages_key="question",
                 history_messages_key="history",
                 history_factory_config=[
                     ConfigurableFieldSpec(
                         id="user_id",
                         annotation=str,
                         name="User ID",
                         description="Unique identifier for the user.",
@@ -121,15 +205,15 @@
                         description="Unique identifier for the conversation.",
                         default="",
                         is_shared=True,
                     ),
                 ],
             )
 
-            chain_with_history.invoke(
+            with_message_history.invoke(
                 {"ability": "math", "question": "What does cosine mean?"},
                 config={"configurable": {"user_id": "123", "conversation_id": "1"}}
             )
 
     """  # noqa: E501
 
     get_session_history: GetSessionHistoryCallable
@@ -141,17 +225,20 @@
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "runnable"]
 
     def __init__(
         self,
-        runnable: Runnable[
-            MessagesOrDictWithMessages,
-            Union[str, BaseMessage, MessagesOrDictWithMessages],
+        runnable: Union[
+            Runnable[
+                Union[MessagesOrDictWithMessages],
+                Union[str, BaseMessage, MessagesOrDictWithMessages],
+            ],
+            LanguageModelLike,
         ],
         get_session_history: GetSessionHistoryCallable,
         *,
         input_messages_key: Optional[str] = None,
         output_messages_key: Optional[str] = None,
         history_messages_key: Optional[str] = None,
         history_factory_config: Optional[Sequence[ConfigurableFieldSpec]] = None,
@@ -254,15 +341,17 @@
             super().config_specs + list(self.history_factory_config)
         )
 
     def get_input_schema(
         self, config: Optional[RunnableConfig] = None
     ) -> Type[BaseModel]:
         super_schema = super().get_input_schema(config)
-        if super_schema.__custom_root_type__ is not None:
+        if super_schema.__custom_root_type__ or not super_schema.schema().get(
+            "properties"
+        ):
             from langchain_core.messages import BaseMessage
 
             fields: Dict = {}
             if self.input_messages_key and self.history_messages_key:
                 fields[self.input_messages_key] = (
                     Union[str, BaseMessage, Sequence[BaseMessage]],
                     ...,
@@ -275,18 +364,27 @@
                 "RunnableWithChatHistoryInput",
                 **fields,
             )
         else:
             return super_schema
 
     def _get_input_messages(
-        self, input_val: Union[str, BaseMessage, Sequence[BaseMessage]]
+        self, input_val: Union[str, BaseMessage, Sequence[BaseMessage], dict]
     ) -> List[BaseMessage]:
         from langchain_core.messages import BaseMessage
 
+        if isinstance(input_val, dict):
+            if self.input_messages_key:
+                key = self.input_messages_key
+            elif len(input_val) == 1:
+                key = list(input_val.keys())[0]
+            else:
+                key = "input"
+            input_val = input_val[key]
+
         if isinstance(input_val, str):
             from langchain_core.messages import HumanMessage
 
             return [HumanMessage(content=input_val)]
         elif isinstance(input_val, BaseMessage):
             return [input_val]
         elif isinstance(input_val, (list, tuple)):
@@ -299,64 +397,78 @@
 
     def _get_output_messages(
         self, output_val: Union[str, BaseMessage, Sequence[BaseMessage], dict]
     ) -> List[BaseMessage]:
         from langchain_core.messages import BaseMessage
 
         if isinstance(output_val, dict):
-            output_val = output_val[self.output_messages_key or "output"]
+            if self.output_messages_key:
+                key = self.output_messages_key
+            elif len(output_val) == 1:
+                key = list(output_val.keys())[0]
+            else:
+                key = "output"
+            # If you are wrapping a chat model directly
+            # The output is actually this weird generations object
+            if key not in output_val and "generations" in output_val:
+                output_val = output_val["generations"][0][0]["message"]
+            else:
+                output_val = output_val[key]
 
         if isinstance(output_val, str):
             from langchain_core.messages import AIMessage
 
             return [AIMessage(content=output_val)]
         elif isinstance(output_val, BaseMessage):
             return [output_val]
         elif isinstance(output_val, (list, tuple)):
             return list(output_val)
         else:
             raise ValueError()
 
     def _enter_history(self, input: Any, config: RunnableConfig) -> List[BaseMessage]:
-        hist = config["configurable"]["message_history"]
-        # return only historic messages
-        if self.history_messages_key:
-            return hist.messages.copy()
-        # return all messages
-        else:
-            input_val = (
-                input if not self.input_messages_key else input[self.input_messages_key]
-            )
-            return hist.messages.copy() + self._get_input_messages(input_val)
+        hist: BaseChatMessageHistory = config["configurable"]["message_history"]
+        messages = hist.messages.copy()
+
+        if not self.history_messages_key:
+            # return all messages
+            messages += self._get_input_messages(input)
+        return messages
 
     async def _aenter_history(
         self, input: Dict[str, Any], config: RunnableConfig
     ) -> List[BaseMessage]:
-        return await run_in_executor(config, self._enter_history, input, config)
+        hist: BaseChatMessageHistory = config["configurable"]["message_history"]
+        messages = (await hist.aget_messages()).copy()
+
+        if not self.history_messages_key:
+            # return all messages
+            input_val = (
+                input if not self.input_messages_key else input[self.input_messages_key]
+            )
+            messages += self._get_input_messages(input_val)
+        return messages
 
     def _exit_history(self, run: Run, config: RunnableConfig) -> None:
-        hist = config["configurable"]["message_history"]
+        hist: BaseChatMessageHistory = config["configurable"]["message_history"]
 
         # Get the input messages
         inputs = load(run.inputs)
-        input_val = inputs[self.input_messages_key or "input"]
-        input_messages = self._get_input_messages(input_val)
+        input_messages = self._get_input_messages(inputs)
 
         # If historic messages were prepended to the input messages, remove them to
         # avoid adding duplicate messages to history.
         if not self.history_messages_key:
             historic_messages = config["configurable"]["message_history"].messages
             input_messages = input_messages[len(historic_messages) :]
 
         # Get the output messages
         output_val = load(run.outputs)
         output_messages = self._get_output_messages(output_val)
-
-        for m in input_messages + output_messages:
-            hist.add_message(m)
+        hist.add_messages(input_messages + output_messages)
 
     def _merge_configs(self, *configs: Optional[RunnableConfig]) -> RunnableConfig:
         config = super()._merge_configs(*configs)
         expected_keys = [field_spec.id for field_spec in self.history_factory_config]
 
         configurable = config.get("configurable", {})
```

### Comparing `langchain_core-0.1.9/langchain_core/runnables/passthrough.py` & `langchain_core-0.2.0rc1/langchain_core/runnables/passthrough.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,8 +1,9 @@
 """Implementation of the RunnablePassthrough."""
+
 from __future__ import annotations
 
 import asyncio
 import inspect
 import threading
 from typing import (
     TYPE_CHECKING,
@@ -16,15 +17,15 @@
     Mapping,
     Optional,
     Type,
     Union,
     cast,
 )
 
-from langchain_core.pydantic_v1 import BaseModel, create_model
+from langchain_core.pydantic_v1 import BaseModel
 from langchain_core.runnables.base import (
     Other,
     Runnable,
     RunnableParallel,
     RunnableSerializable,
 )
 from langchain_core.runnables.config import (
@@ -32,43 +33,47 @@
     acall_func_with_variable_args,
     call_func_with_variable_args,
     ensure_config,
     get_executor_for_config,
     patch_config,
 )
 from langchain_core.runnables.graph import Graph
-from langchain_core.runnables.utils import AddableDict, ConfigurableFieldSpec
+from langchain_core.runnables.utils import (
+    AddableDict,
+    ConfigurableFieldSpec,
+    create_model,
+)
 from langchain_core.utils.aiter import atee, py_anext
 from langchain_core.utils.iter import safetee
 
 if TYPE_CHECKING:
     from langchain_core.callbacks.manager import (
         AsyncCallbackManagerForChainRun,
         CallbackManagerForChainRun,
     )
 
 
 def identity(x: Other) -> Other:
-    """An identity function"""
+    """Identity function"""
     return x
 
 
 async def aidentity(x: Other) -> Other:
-    """An async identity function"""
+    """Async identity function"""
     return x
 
 
 class RunnablePassthrough(RunnableSerializable[Other, Other]):
-    """A runnable to passthrough inputs unchanged or with additional keys.
+    """Runnable to passthrough inputs unchanged or with additional keys.
 
     This runnable behaves almost like the identity function, except that it
     can be configured to add additional keys to the output, if the input is a
     dict.
 
-    The examples below demonstrate this runnable works using a few simple
+    The examples below demonstrate this Runnable works using a few simple
     chains. The chains rely on simple lambdas to make the examples easy to execute
     and experiment with.
 
     Examples:
 
         .. code-block:: python
 
@@ -97,26 +102,25 @@
             chain.invoke('hello') # {'original': 'completion', 'parsed': 'noitelpmoc'}
 
     In some cases, it may be useful to pass the input through while adding some
     keys to the output. In this case, you can use the `assign` method:
 
         .. code-block:: python
 
-            from langchain_core.runnables import RunnablePassthrough, RunnableParallel
+            from langchain_core.runnables import RunnablePassthrough
 
             def fake_llm(prompt: str) -> str: # Fake LLM for the example
                 return "completion"
 
             runnable = {
                 'llm1':  fake_llm,
                 'llm2':  fake_llm,
-            }
-            | RunnablePassthrough.assign(
+            } | RunnablePassthrough.assign(
                 total_chars=lambda inputs: len(inputs['llm1'] + inputs['llm2'])
-              )
+            )
 
             runnable.invoke('hello')
             # {'llm1': 'completion', 'llm2': 'completion', 'total_chars': 20}
     """
 
     input_type: Optional[Type[Other]] = None
 
@@ -157,15 +161,15 @@
         input_type: Optional[Type[Other]] = None,
         **kwargs: Any,
     ) -> None:
         if inspect.iscoroutinefunction(func):
             afunc = func
             func = None
 
-        super().__init__(func=func, afunc=afunc, input_type=input_type, **kwargs)
+        super().__init__(func=func, afunc=afunc, input_type=input_type, **kwargs)  # type: ignore[call-arg]
 
     @classmethod
     def is_lc_serializable(cls) -> bool:
         return True
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
@@ -234,24 +238,30 @@
         config: Optional[RunnableConfig] = None,
         **kwargs: Any,
     ) -> Iterator[Other]:
         if self.func is None:
             for chunk in self._transform_stream_with_config(input, identity, config):
                 yield chunk
         else:
-            final = None
+            final: Other
+            got_first_chunk = False
 
             for chunk in self._transform_stream_with_config(input, identity, config):
                 yield chunk
-                if final is None:
+
+                if not got_first_chunk:
                     final = chunk
+                    got_first_chunk = True
                 else:
-                    final = final + chunk
+                    try:
+                        final = final + chunk  # type: ignore[operator]
+                    except TypeError:
+                        final = chunk
 
-            if final is not None:
+            if got_first_chunk:
                 call_func_with_variable_args(
                     self.func, final, ensure_config(config), **kwargs
                 )
 
     async def atransform(
         self,
         input: AsyncIterator[Other],
@@ -260,26 +270,36 @@
     ) -> AsyncIterator[Other]:
         if self.afunc is None and self.func is None:
             async for chunk in self._atransform_stream_with_config(
                 input, identity, config
             ):
                 yield chunk
         else:
-            final = None
+            got_first_chunk = False
 
             async for chunk in self._atransform_stream_with_config(
                 input, identity, config
             ):
                 yield chunk
-                if final is None:
+
+                # By definitions, a function will operate on the aggregated
+                # input. So we'll aggregate the input until we get to the last
+                # chunk.
+                # If the input is not addable, then we'll assume that we can
+                # only operate on the last chunk.
+                if not got_first_chunk:
                     final = chunk
+                    got_first_chunk = True
                 else:
-                    final = final + chunk
+                    try:
+                        final = final + chunk  # type: ignore[operator]
+                    except TypeError:
+                        final = chunk
 
-            if final is not None:
+            if got_first_chunk:
                 config = ensure_config(config)
                 if self.afunc is not None:
                     await acall_func_with_variable_args(
                         self.afunc, final, config, **kwargs
                     )
                 elif self.func is not None:
                     call_func_with_variable_args(self.func, final, config, **kwargs)
@@ -305,37 +325,71 @@
             yield chunk
 
 
 _graph_passthrough: RunnablePassthrough = RunnablePassthrough()
 
 
 class RunnableAssign(RunnableSerializable[Dict[str, Any], Dict[str, Any]]):
-    """
-    A runnable that assigns key-value pairs to Dict[str, Any] inputs.
+    """Runnable that assigns key-value pairs to Dict[str, Any] inputs.
+
+    The `RunnableAssign` class takes input dictionaries and, through a
+    `RunnableParallel` instance, applies transformations, then combines
+    these with the original data, introducing new key-value pairs based
+    on the mapper's logic.
+
+    Examples:
+        .. code-block:: python
+
+            # This is a RunnableAssign
+            from typing import Dict
+            from langchain_core.runnables.passthrough import (
+                RunnableAssign,
+                RunnableParallel,
+            )
+            from langchain_core.runnables.base import RunnableLambda
+
+            def add_ten(x: Dict[str, int]) -> Dict[str, int]:
+                return {"added": x["input"] + 10}
+
+            mapper = RunnableParallel(
+                {"add_step": RunnableLambda(add_ten),}
+            )
+
+            runnable_assign = RunnableAssign(mapper)
+
+            # Synchronous example
+            runnable_assign.invoke({"input": 5})
+            # returns {'input': 5, 'add_step': {'added': 15}}
+
+            # Asynchronous example
+            await runnable_assign.ainvoke({"input": 5})
+            # returns {'input': 5, 'add_step': {'added': 15}}
     """
 
     mapper: RunnableParallel[Dict[str, Any]]
 
     def __init__(self, mapper: RunnableParallel[Dict[str, Any]], **kwargs: Any) -> None:
-        super().__init__(mapper=mapper, **kwargs)
+        super().__init__(mapper=mapper, **kwargs)  # type: ignore[call-arg]
 
     @classmethod
     def is_lc_serializable(cls) -> bool:
         return True
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
         """Get the namespace of the langchain object."""
         return ["langchain", "schema", "runnable"]
 
     def get_name(
         self, suffix: Optional[str] = None, *, name: Optional[str] = None
     ) -> str:
         name = (
-            name or self.name or f"RunnableAssign<{','.join(self.mapper.steps.keys())}>"
+            name
+            or self.name
+            or f"RunnableAssign<{','.join(self.mapper.steps__.keys())}>"
         )
         return super().get_name(suffix, name=name)
 
     def get_input_schema(
         self, config: Optional[RunnableConfig] = None
     ) -> Type[BaseModel]:
         map_input_schema = self.mapper.get_input_schema(config)
@@ -446,15 +500,15 @@
         self,
         input: Iterator[Dict[str, Any]],
         run_manager: CallbackManagerForChainRun,
         config: RunnableConfig,
         **kwargs: Any,
     ) -> Iterator[Dict[str, Any]]:
         # collect mapper keys
-        mapper_keys = set(self.mapper.steps.keys())
+        mapper_keys = set(self.mapper.steps__.keys())
         # create two streams, one for the map and one for the passthrough
         for_passthrough, for_map = safetee(input, 2, lock=threading.Lock())
 
         # create map output stream
         map_output = self.mapper.transform(
             for_map,
             patch_config(
@@ -502,15 +556,15 @@
         self,
         input: AsyncIterator[Dict[str, Any]],
         run_manager: AsyncCallbackManagerForChainRun,
         config: RunnableConfig,
         **kwargs: Any,
     ) -> AsyncIterator[Dict[str, Any]]:
         # collect mapper keys
-        mapper_keys = set(self.mapper.steps.keys())
+        mapper_keys = set(self.mapper.steps__.keys())
         # create two streams, one for the map and one for the passthrough
         for_passthrough, for_map = atee(input, 2, lock=asyncio.Lock())
         # create map output stream
         map_output = self.mapper.atransform(
             for_map,
             patch_config(
                 config,
@@ -567,22 +621,44 @@
             yield input
 
         async for chunk in self.atransform(input_aiter(), config, **kwargs):
             yield chunk
 
 
 class RunnablePick(RunnableSerializable[Dict[str, Any], Dict[str, Any]]):
-    """
-    A runnable that picks keys from Dict[str, Any] inputs.
+    """Runnable that picks keys from Dict[str, Any] inputs.
+
+    RunnablePick class represents a runnable that selectively picks keys from a
+    dictionary input. It allows you to specify one or more keys to extract
+    from the input dictionary. It returns a new dictionary containing only
+    the selected keys.
+
+    Example :
+        .. code-block:: python
+
+            from langchain_core.runnables.passthrough import RunnablePick
+
+            input_data = {
+                'name': 'John',
+                'age': 30,
+                'city': 'New York',
+                'country': 'USA'
+            }
+
+            runnable = RunnablePick(keys=['name', 'age'])
+
+            output_data = runnable.invoke(input_data)
+
+            print(output_data)  # Output: {'name': 'John', 'age': 30}
     """
 
     keys: Union[str, List[str]]
 
     def __init__(self, keys: Union[str, List[str]], **kwargs: Any) -> None:
-        super().__init__(keys=keys, **kwargs)
+        super().__init__(keys=keys, **kwargs)  # type: ignore[call-arg]
 
     @classmethod
     def is_lc_serializable(cls) -> bool:
         return True
 
     @classmethod
     def get_lc_namespace(cls) -> List[str]:
```

### Comparing `langchain_core-0.1.9/langchain_core/runnables/router.py` & `langchain_core-0.2.0rc1/langchain_core/runnables/router.py`

 * *Files 3% similar despite different names*

```diff
@@ -30,44 +30,57 @@
     ConfigurableFieldSpec,
     gather_with_concurrency,
     get_unique_config_specs,
 )
 
 
 class RouterInput(TypedDict):
-    """A Router input.
+    """Router input.
 
     Attributes:
         key: The key to route on.
         input: The input to pass to the selected runnable.
     """
 
     key: str
     input: Any
 
 
 class RouterRunnable(RunnableSerializable[RouterInput, Output]):
     """
-    A runnable that routes to a set of runnables based on Input['key'].
-    Returns the output of the selected runnable.
+    Runnable that routes to a set of Runnables based on Input['key'].
+    Returns the output of the selected Runnable.
+
+    For example,
+
+    .. code-block:: python
+
+        from langchain_core.runnables.router import RouterRunnable
+        from langchain_core.runnables import RunnableLambda
+
+        add = RunnableLambda(func=lambda x: x + 1)
+        square = RunnableLambda(func=lambda x: x**2)
+
+        router = RouterRunnable(runnables={"add": add, "square": square})
+        router.invoke({"key": "square", "input": 3})
     """
 
     runnables: Mapping[str, Runnable[Any, Output]]
 
     @property
     def config_specs(self) -> List[ConfigurableFieldSpec]:
         return get_unique_config_specs(
             spec for step in self.runnables.values() for spec in step.config_specs
         )
 
     def __init__(
         self,
         runnables: Mapping[str, Union[Runnable[Any, Output], Callable[[Any], Output]]],
     ) -> None:
-        super().__init__(
+        super().__init__(  # type: ignore[call-arg]
             runnables={key: coerce_to_runnable(r) for key, r in runnables.items()}
         )
 
     class Config:
         arbitrary_types_allowed = True
 
     @classmethod
```

### Comparing `langchain_core-0.1.9/langchain_core/runnables/utils.py` & `langchain_core-0.2.0rc1/langchain_core/runnables/utils.py`

 * *Files 17% similar despite different names*

```diff
@@ -1,13 +1,15 @@
+"""Utility code for runnables."""
 from __future__ import annotations
 
 import ast
 import asyncio
 import inspect
 import textwrap
+from functools import lru_cache
 from inspect import signature
 from itertools import groupby
 from typing import (
     Any,
     AsyncIterable,
     Callable,
     Coroutine,
@@ -16,18 +18,23 @@
     List,
     Mapping,
     NamedTuple,
     Optional,
     Protocol,
     Sequence,
     Set,
+    Type,
     TypeVar,
     Union,
 )
 
+from langchain_core.pydantic_v1 import BaseConfig, BaseModel
+from langchain_core.pydantic_v1 import create_model as _create_model_base
+from langchain_core.runnables.schema import StreamEvent
+
 Input = TypeVar("Input", contravariant=True)
 # Output type should implement __concat__, as eg str, list, dict do
 Output = TypeVar("Output", covariant=True)
 
 
 async def gated_coro(semaphore: asyncio.Semaphore, coro: Coroutine) -> Any:
     """Run a coroutine with a semaphore.
@@ -39,15 +46,23 @@
         The result of the coroutine.
     """
     async with semaphore:
         return await coro
 
 
 async def gather_with_concurrency(n: Union[int, None], *coros: Coroutine) -> list:
-    """Gather coroutines with a limit on the number of concurrent coroutines."""
+    """Gather coroutines with a limit on the number of concurrent coroutines.
+
+    Args:
+        n: The number of coroutines to run concurrently.
+        coros: The coroutines to run.
+
+    Returns:
+        The results of the coroutines.
+    """
     if n is None:
         return await asyncio.gather(*coros)
 
     semaphore = asyncio.Semaphore(n)
 
     return await asyncio.gather(*(gated_coro(semaphore, c) for c in coros))
 
@@ -199,15 +214,15 @@
     """Get the keys of the first argument of a function if it is a dict."""
     try:
         code = inspect.getsource(func)
         tree = ast.parse(textwrap.dedent(code))
         visitor = IsFunctionArgDict()
         visitor.visit(tree)
         return list(visitor.keys) if visitor.keys else None
-    except (SyntaxError, TypeError, OSError):
+    except (SyntaxError, TypeError, OSError, SystemError):
         return None
 
 
 def get_lambda_source(func: Callable) -> Optional[str]:
     """Get the source code of a lambda function.
 
     Args:
@@ -222,15 +237,15 @@
         name = None
     try:
         code = inspect.getsource(func)
         tree = ast.parse(textwrap.dedent(code))
         visitor = GetLambdaSource()
         visitor.visit(tree)
         return visitor.source if visitor.count == 1 else name
-    except (SyntaxError, TypeError, OSError):
+    except (SyntaxError, TypeError, OSError, SystemError):
         return name
 
 
 def get_function_nonlocals(func: Callable) -> List[Any]:
     """Get the nonlocal variables accessed by a function."""
     try:
         code = inspect.getsource(func)
@@ -241,18 +256,25 @@
         for k, v in inspect.getclosurevars(func).nonlocals.items():
             if k in visitor.nonlocals:
                 values.append(v)
             for kk in visitor.nonlocals:
                 if "." in kk and kk.startswith(k):
                     vv = v
                     for part in kk.split(".")[1:]:
-                        vv = getattr(vv, part)
-                    values.append(vv)
+                        if vv is None:
+                            break
+                        else:
+                            try:
+                                vv = getattr(vv, part)
+                            except AttributeError:
+                                break
+                    else:
+                        values.append(vv)
         return values
-    except (SyntaxError, TypeError, OSError):
+    except (SyntaxError, TypeError, OSError, SystemError):
         return []
 
 
 def indent_lines_after_first(text: str, prefix: str) -> str:
     """Indent all lines of text after the first line.
 
     Args:
@@ -333,44 +355,44 @@
             final = chunk
         else:
             final = final + chunk
     return final
 
 
 class ConfigurableField(NamedTuple):
-    """A field that can be configured by the user."""
+    """Field that can be configured by the user."""
 
     id: str
 
     name: Optional[str] = None
     description: Optional[str] = None
     annotation: Optional[Any] = None
     is_shared: bool = False
 
     def __hash__(self) -> int:
         return hash((self.id, self.annotation))
 
 
 class ConfigurableFieldSingleOption(NamedTuple):
-    """A field that can be configured by the user with a default value."""
+    """Field that can be configured by the user with a default value."""
 
     id: str
     options: Mapping[str, Any]
     default: str
 
     name: Optional[str] = None
     description: Optional[str] = None
     is_shared: bool = False
 
     def __hash__(self) -> int:
         return hash((self.id, tuple(self.options.keys()), self.default))
 
 
 class ConfigurableFieldMultiOption(NamedTuple):
-    """A field that can be configured by the user with multiple default values."""
+    """Field that can be configured by the user with multiple default values."""
 
     id: str
     options: Mapping[str, Any]
     default: Sequence[str]
 
     name: Optional[str] = None
     description: Optional[str] = None
@@ -382,15 +404,15 @@
 
 AnyConfigurableField = Union[
     ConfigurableField, ConfigurableFieldSingleOption, ConfigurableFieldMultiOption
 ]
 
 
 class ConfigurableFieldSpec(NamedTuple):
-    """A field that can be configured by the user. It is a specification of a field."""
+    """Field that can be configured by the user. It is a specification of a field."""
 
     id: str
     annotation: Any
 
     name: Optional[str] = None
     description: Optional[str] = None
     default: Any = None
@@ -415,7 +437,99 @@
             unique.append(first)
         else:
             raise ValueError(
                 "RunnableSequence contains conflicting config specs"
                 f"for {id}: {[first] + others}"
             )
     return unique
+
+
+class _RootEventFilter:
+    def __init__(
+        self,
+        *,
+        include_names: Optional[Sequence[str]] = None,
+        include_types: Optional[Sequence[str]] = None,
+        include_tags: Optional[Sequence[str]] = None,
+        exclude_names: Optional[Sequence[str]] = None,
+        exclude_types: Optional[Sequence[str]] = None,
+        exclude_tags: Optional[Sequence[str]] = None,
+    ) -> None:
+        """Utility to filter the root event in the astream_events implementation.
+
+        This is simply binding the arguments to the namespace to make save on
+        a bit of typing in the astream_events implementation.
+        """
+        self.include_names = include_names
+        self.include_types = include_types
+        self.include_tags = include_tags
+        self.exclude_names = exclude_names
+        self.exclude_types = exclude_types
+        self.exclude_tags = exclude_tags
+
+    def include_event(self, event: StreamEvent, root_type: str) -> bool:
+        """Determine whether to include an event."""
+        if (
+            self.include_names is None
+            and self.include_types is None
+            and self.include_tags is None
+        ):
+            include = True
+        else:
+            include = False
+
+        event_tags = event.get("tags") or []
+
+        if self.include_names is not None:
+            include = include or event["name"] in self.include_names
+        if self.include_types is not None:
+            include = include or root_type in self.include_types
+        if self.include_tags is not None:
+            include = include or any(tag in self.include_tags for tag in event_tags)
+
+        if self.exclude_names is not None:
+            include = include and event["name"] not in self.exclude_names
+        if self.exclude_types is not None:
+            include = include and root_type not in self.exclude_types
+        if self.exclude_tags is not None:
+            include = include and all(
+                tag not in self.exclude_tags for tag in event_tags
+            )
+
+        return include
+
+
+class _SchemaConfig(BaseConfig):
+    arbitrary_types_allowed = True
+    frozen = True
+
+
+def create_model(
+    __model_name: str,
+    **field_definitions: Any,
+) -> Type[BaseModel]:
+    """Create a pydantic model with the given field definitions.
+
+    Args:
+        __model_name: The name of the model.
+        **field_definitions: The field definitions for the model.
+
+    Returns:
+        Type[BaseModel]: The created model.
+    """
+    try:
+        return _create_model_cached(__model_name, **field_definitions)
+    except TypeError:
+        # something in field definitions is not hashable
+        return _create_model_base(
+            __model_name, __config__=_SchemaConfig, **field_definitions
+        )
+
+
+@lru_cache(maxsize=256)
+def _create_model_cached(
+    __model_name: str,
+    **field_definitions: Any,
+) -> Type[BaseModel]:
+    return _create_model_base(
+        __model_name, __config__=_SchemaConfig, **field_definitions
+    )
```

### Comparing `langchain_core-0.1.9/langchain_core/tools.py` & `langchain_core-0.2.0rc1/langchain_core/tools.py`

 * *Files 14% similar despite different names*

```diff
@@ -1,55 +1,101 @@
-"""Base implementation for tools or skills."""
+"""**Tools** are classes that an Agent uses to interact with the world.
+
+Each tool has a **description**. Agent uses the description to choose the right
+tool for the job.
+
+**Class hierarchy:**
+
+.. code-block::
+
+    RunnableSerializable --> BaseTool --> <name>Tool  # Examples: AIPluginTool, BaseGraphQLTool
+                                          <name>      # Examples: BraveSearch, HumanInputRun
+
+**Main helpers:**
+
+.. code-block::
+
+    CallbackManagerForToolRun, AsyncCallbackManagerForToolRun
+"""  # noqa: E501
+
 from __future__ import annotations
 
+import asyncio
 import inspect
+import textwrap
+import uuid
 import warnings
-from abc import abstractmethod
+from abc import ABC, abstractmethod
+from contextvars import copy_context
+from functools import partial
 from inspect import signature
 from typing import Any, Awaitable, Callable, Dict, List, Optional, Tuple, Type, Union
 
+from langchain_core._api import deprecated
 from langchain_core.callbacks import (
     AsyncCallbackManager,
     AsyncCallbackManagerForToolRun,
     BaseCallbackManager,
     CallbackManager,
     CallbackManagerForToolRun,
+)
+from langchain_core.callbacks.manager import (
     Callbacks,
 )
 from langchain_core.load.serializable import Serializable
+from langchain_core.prompts import (
+    BasePromptTemplate,
+    PromptTemplate,
+    aformat_document,
+    format_document,
+)
 from langchain_core.pydantic_v1 import (
     BaseModel,
     Extra,
     Field,
+    ValidationError,
     create_model,
     root_validator,
     validate_arguments,
 )
+from langchain_core.retrievers import BaseRetriever
 from langchain_core.runnables import (
     Runnable,
     RunnableConfig,
     RunnableSerializable,
     ensure_config,
 )
-from langchain_core.runnables.config import run_in_executor
+from langchain_core.runnables.config import (
+    patch_config,
+    run_in_executor,
+    var_child_runnable_config,
+)
+from langchain_core.runnables.utils import accepts_context
 
 
 class SchemaAnnotationError(TypeError):
     """Raised when 'args_schema' is missing or has an incorrect type annotation."""
 
 
 def _create_subset_model(
-    name: str, model: BaseModel, field_names: list
+    name: str, model: Type[BaseModel], field_names: list
 ) -> Type[BaseModel]:
     """Create a pydantic model with only a subset of model's fields."""
     fields = {}
     for field_name in field_names:
         field = model.__fields__[field_name]
-        fields[field_name] = (field.outer_type_, field.field_info)
-    return create_model(name, **fields)  # type: ignore
+        t = (
+            # this isn't perfect but should work for most functions
+            field.outer_type_
+            if field.required and not field.allow_none
+            else Optional[field.outer_type_]
+        )
+        fields[field_name] = (t, field.field_info)
+    rtn = create_model(name, **fields)  # type: ignore
+    return rtn
 
 
 def _get_filtered_args(
     inferred_model: Type[BaseModel],
     func: Callable,
 ) -> dict:
     """Get the arguments from a function's signature."""
@@ -87,18 +133,18 @@
     valid_properties = _get_filtered_args(inferred_model, func)
     return _create_subset_model(
         f"{model_name}Schema", inferred_model, list(valid_properties)
     )
 
 
 class ToolException(Exception):
-    """An optional exception that tool throws when execution error occurs.
+    """Optional exception that tool throws when execution error occurs.
 
     When this exception is thrown, the agent will not stop working,
-    but will handle the exception according to the handle_tool_error
+    but it will handle the exception according to the handle_tool_error
     variable of the tool, and the processing result will be returned
     to the agent as observation, and printed in red on the console.
     """
 
     pass
 
 
@@ -107,33 +153,32 @@
 
     def __init_subclass__(cls, **kwargs: Any) -> None:
         """Create the definition of the new tool class."""
         super().__init_subclass__(**kwargs)
 
         args_schema_type = cls.__annotations__.get("args_schema", None)
 
-        if args_schema_type is not None:
-            if args_schema_type is None or args_schema_type == BaseModel:
-                # Throw errors for common mis-annotations.
-                # TODO: Use get_args / get_origin and fully
-                # specify valid annotations.
-                typehint_mandate = """
+        if args_schema_type is not None and args_schema_type == BaseModel:
+            # Throw errors for common mis-annotations.
+            # TODO: Use get_args / get_origin and fully
+            # specify valid annotations.
+            typehint_mandate = """
 class ChildTool(BaseTool):
     ...
     args_schema: Type[BaseModel] = SchemaClass
     ..."""
-                name = cls.__name__
-                raise SchemaAnnotationError(
-                    f"Tool definition for {name} must include valid type annotations"
-                    f" for argument 'args_schema' to behave as expected.\n"
-                    f"Expected annotation of 'Type[BaseModel]'"
-                    f" but got '{args_schema_type}'.\n"
-                    f"Expected class looks like:\n"
-                    f"{typehint_mandate}"
-                )
+            name = cls.__name__
+            raise SchemaAnnotationError(
+                f"Tool definition for {name} must include valid type annotations"
+                f" for argument 'args_schema' to behave as expected.\n"
+                f"Expected annotation of 'Type[BaseModel]'"
+                f" but got '{args_schema_type}'.\n"
+                f"Expected class looks like:\n"
+                f"{typehint_mandate}"
+            )
 
     name: str
     """The unique name of the tool that clearly communicates its purpose."""
     description: str
     """Used to tell the model how/when/why to use the tool.
     
     You can provide few-shot examples as a part of the description.
@@ -166,14 +211,19 @@
     """
 
     handle_tool_error: Optional[
         Union[bool, str, Callable[[ToolException], str]]
     ] = False
     """Handle the content of the ToolException thrown."""
 
+    handle_validation_error: Optional[
+        Union[bool, str, Callable[[ValidationError], str]]
+    ] = False
+    """Handle the content of the ValidationError thrown."""
+
     class Config(Serializable.Config):
         """Configuration for this pydantic object."""
 
         arbitrary_types_allowed = True
 
     @property
     def is_single_input(self) -> bool:
@@ -209,14 +259,16 @@
         config = ensure_config(config)
         return self.run(
             input,
             callbacks=config.get("callbacks"),
             tags=config.get("tags"),
             metadata=config.get("metadata"),
             run_name=config.get("run_name"),
+            run_id=config.pop("run_id", None),
+            config=config,
             **kwargs,
         )
 
     async def ainvoke(
         self,
         input: Union[str, Dict],
         config: Optional[RunnableConfig] = None,
@@ -225,14 +277,16 @@
         config = ensure_config(config)
         return await self.arun(
             input,
             callbacks=config.get("callbacks"),
             tags=config.get("tags"),
             metadata=config.get("metadata"),
             run_name=config.get("run_name"),
+            run_id=config.pop("run_id", None),
+            config=config,
             **kwargs,
         )
 
     # --- Tool ---
 
     def _parse_input(
         self,
@@ -244,15 +298,19 @@
             if input_args is not None:
                 key_ = next(iter(input_args.__fields__.keys()))
                 input_args.validate({key_: tool_input})
             return tool_input
         else:
             if input_args is not None:
                 result = input_args.parse_obj(tool_input)
-                return {k: v for k, v in result.dict().items() if k in tool_input}
+                return {
+                    k: getattr(result, k)
+                    for k, v in result.dict().items()
+                    if k in tool_input
+                }
         return tool_input
 
     @root_validator()
     def raise_deprecation(cls, values: Dict) -> Dict:
         """Raise deprecation warning if callback_manager is used."""
         if values.get("callback_manager") is not None:
             warnings.warn(
@@ -292,27 +350,28 @@
         if isinstance(tool_input, str):
             return (tool_input,), {}
         else:
             return (), tool_input
 
     def run(
         self,
-        tool_input: Union[str, Dict],
+        tool_input: Union[str, Dict[str, Any]],
         verbose: Optional[bool] = None,
         start_color: Optional[str] = "green",
         color: Optional[str] = "green",
         callbacks: Callbacks = None,
         *,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
         run_name: Optional[str] = None,
+        run_id: Optional[uuid.UUID] = None,
+        config: Optional[RunnableConfig] = None,
         **kwargs: Any,
     ) -> Any:
         """Run the tool."""
-        parsed_input = self._parse_input(tool_input)
         if not self.verbose and verbose is not None:
             verbose_ = verbose
         else:
             verbose_ = self.verbose
         callback_manager = CallbackManager.configure(
             callbacks,
             self.callbacks,
@@ -325,23 +384,53 @@
         # TODO: maybe also pass through run_manager is _run supports kwargs
         new_arg_supported = signature(self._run).parameters.get("run_manager")
         run_manager = callback_manager.on_tool_start(
             {"name": self.name, "description": self.description},
             tool_input if isinstance(tool_input, str) else str(tool_input),
             color=start_color,
             name=run_name,
+            run_id=run_id,
+            # Inputs by definition should always be dicts.
+            # For now, it's unclear whether this assumption is ever violated,
+            # but if it is we will send a `None` value to the callback instead
+            # And will need to address issue via a patch.
+            inputs=None if isinstance(tool_input, str) else tool_input,
             **kwargs,
         )
         try:
+            child_config = patch_config(
+                config,
+                callbacks=run_manager.get_child(),
+            )
+            context = copy_context()
+            context.run(var_child_runnable_config.set, child_config)
+            parsed_input = self._parse_input(tool_input)
             tool_args, tool_kwargs = self._to_args_and_kwargs(parsed_input)
             observation = (
-                self._run(*tool_args, run_manager=run_manager, **tool_kwargs)
+                context.run(
+                    self._run, *tool_args, run_manager=run_manager, **tool_kwargs
+                )
                 if new_arg_supported
-                else self._run(*tool_args, **tool_kwargs)
+                else context.run(self._run, *tool_args, **tool_kwargs)
             )
+        except ValidationError as e:
+            if not self.handle_validation_error:
+                raise e
+            elif isinstance(self.handle_validation_error, bool):
+                observation = "Tool input validation error"
+            elif isinstance(self.handle_validation_error, str):
+                observation = self.handle_validation_error
+            elif callable(self.handle_validation_error):
+                observation = self.handle_validation_error(e)
+            else:
+                raise ValueError(
+                    f"Got unexpected type of `handle_validation_error`. Expected bool, "
+                    f"str or callable. Received: {self.handle_validation_error}"
+                )
+            return observation
         except ToolException as e:
             if not self.handle_tool_error:
                 run_manager.on_tool_error(e)
                 raise e
             elif isinstance(self.handle_tool_error, bool):
                 if e.args:
                     observation = e.args[0]
@@ -352,42 +441,39 @@
             elif callable(self.handle_tool_error):
                 observation = self.handle_tool_error(e)
             else:
                 raise ValueError(
                     f"Got unexpected type of `handle_tool_error`. Expected bool, str "
                     f"or callable. Received: {self.handle_tool_error}"
                 )
-            run_manager.on_tool_end(
-                str(observation), color="red", name=self.name, **kwargs
-            )
+            run_manager.on_tool_end(observation, color="red", name=self.name, **kwargs)
             return observation
         except (Exception, KeyboardInterrupt) as e:
             run_manager.on_tool_error(e)
             raise e
         else:
-            run_manager.on_tool_end(
-                str(observation), color=color, name=self.name, **kwargs
-            )
+            run_manager.on_tool_end(observation, color=color, name=self.name, **kwargs)
             return observation
 
     async def arun(
         self,
         tool_input: Union[str, Dict],
         verbose: Optional[bool] = None,
         start_color: Optional[str] = "green",
         color: Optional[str] = "green",
         callbacks: Callbacks = None,
         *,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
         run_name: Optional[str] = None,
+        run_id: Optional[uuid.UUID] = None,
+        config: Optional[RunnableConfig] = None,
         **kwargs: Any,
     ) -> Any:
         """Run the tool asynchronously."""
-        parsed_input = self._parse_input(tool_input)
         if not self.verbose and verbose is not None:
             verbose_ = verbose
         else:
             verbose_ = self.verbose
         callback_manager = AsyncCallbackManager.configure(
             callbacks,
             self.callbacks,
@@ -399,24 +485,55 @@
         )
         new_arg_supported = signature(self._arun).parameters.get("run_manager")
         run_manager = await callback_manager.on_tool_start(
             {"name": self.name, "description": self.description},
             tool_input if isinstance(tool_input, str) else str(tool_input),
             color=start_color,
             name=run_name,
+            inputs=tool_input,
+            run_id=run_id,
             **kwargs,
         )
         try:
+            parsed_input = self._parse_input(tool_input)
             # We then call the tool on the tool input to get an observation
             tool_args, tool_kwargs = self._to_args_and_kwargs(parsed_input)
-            observation = (
-                await self._arun(*tool_args, run_manager=run_manager, **tool_kwargs)
+            child_config = patch_config(
+                config,
+                callbacks=run_manager.get_child(),
+            )
+            context = copy_context()
+            context.run(var_child_runnable_config.set, child_config)
+            coro = (
+                context.run(
+                    self._arun, *tool_args, run_manager=run_manager, **tool_kwargs
+                )
                 if new_arg_supported
-                else await self._arun(*tool_args, **tool_kwargs)
+                else context.run(self._arun, *tool_args, **tool_kwargs)
             )
+            if accepts_context(asyncio.create_task):
+                observation = await asyncio.create_task(coro, context=context)  # type: ignore
+            else:
+                observation = await coro
+
+        except ValidationError as e:
+            if not self.handle_validation_error:
+                raise e
+            elif isinstance(self.handle_validation_error, bool):
+                observation = "Tool input validation error"
+            elif isinstance(self.handle_validation_error, str):
+                observation = self.handle_validation_error
+            elif callable(self.handle_validation_error):
+                observation = self.handle_validation_error(e)
+            else:
+                raise ValueError(
+                    f"Got unexpected type of `handle_validation_error`. Expected bool, "
+                    f"str or callable. Received: {self.handle_validation_error}"
+                )
+            return observation
         except ToolException as e:
             if not self.handle_tool_error:
                 await run_manager.on_tool_error(e)
                 raise e
             elif isinstance(self.handle_tool_error, bool):
                 if e.args:
                     observation = e.args[0]
@@ -428,26 +545,27 @@
                 observation = self.handle_tool_error(e)
             else:
                 raise ValueError(
                     f"Got unexpected type of `handle_tool_error`. Expected bool, str "
                     f"or callable. Received: {self.handle_tool_error}"
                 )
             await run_manager.on_tool_end(
-                str(observation), color="red", name=self.name, **kwargs
+                observation, color="red", name=self.name, **kwargs
             )
             return observation
         except (Exception, KeyboardInterrupt) as e:
             await run_manager.on_tool_error(e)
             raise e
         else:
             await run_manager.on_tool_end(
-                str(observation), color=color, name=self.name, **kwargs
+                observation, color=color, name=self.name, **kwargs
             )
             return observation
 
+    @deprecated("0.1.47", alternative="invoke", removal="0.3.0")
     def __call__(self, tool_input: str, callbacks: Callbacks = None) -> str:
         """Make tool callable."""
         return self.run(tool_input, callbacks=callbacks)
 
 
 class Tool(BaseTool):
     """Tool that takes in function or coroutine directly."""
@@ -486,15 +604,16 @@
     def _to_args_and_kwargs(self, tool_input: Union[str, Dict]) -> Tuple[Tuple, Dict]:
         """Convert tool input to pydantic model."""
         args, kwargs = super()._to_args_and_kwargs(tool_input)
         # For backwards compatibility. The tool must be run with a single input
         all_args = list(args) + list(kwargs.values())
         if len(all_args) != 1:
             raise ToolException(
-                f"Too many arguments to single-input tool {self.name}."
+                f"""Too many arguments to single-input tool {self.name}.
+                Consider using StructuredTool instead."""
                 f" Args: {all_args}"
             )
         return tuple(all_args), {}
 
     def _run(
         self,
         *args: Any,
@@ -545,15 +664,15 @@
             )
 
     # TODO: this is for backwards compatibility, remove in future
     def __init__(
         self, name: str, func: Optional[Callable], description: str, **kwargs: Any
     ) -> None:
         """Initialize tool."""
-        super(Tool, self).__init__(
+        super(Tool, self).__init__(  # type: ignore[call-arg]
             name=name, func=func, description=description, **kwargs
         )
 
     @classmethod
     def from_function(
         cls,
         func: Optional[Callable],
@@ -703,33 +822,37 @@
         if func is not None:
             source_function = func
         elif coroutine is not None:
             source_function = coroutine
         else:
             raise ValueError("Function and/or coroutine must be provided")
         name = name or source_function.__name__
-        description = description or source_function.__doc__
-        if description is None:
+        description_ = description or source_function.__doc__
+        if description_ is None:
             raise ValueError(
                 "Function must have a docstring if description not provided."
             )
+        if description is None:
+            # Only apply if using the function's docstring
+            description_ = textwrap.dedent(description_).strip()
 
         # Description example:
         # search_api(query: str) - Searches the API for the query.
         sig = signature(source_function)
-        description = f"{name}{sig} - {description.strip()}"
+        description_ = f"{name}{sig} - {description_.strip()}"
         _args_schema = args_schema
         if _args_schema is None and infer_schema:
-            _args_schema = create_schema_from_function(f"{name}Schema", source_function)
+            # schema name is appended within function
+            _args_schema = create_schema_from_function(name, source_function)
         return cls(
             name=name,
             func=func,
             coroutine=coroutine,
-            args_schema=_args_schema,
-            description=description,
+            args_schema=_args_schema,  # type: ignore[arg-type]
+            description=description_,
             return_direct=return_direct,
             **kwargs,
         )
 
 
 def tool(
     *args: Union[str, Callable, Runnable],
@@ -841,7 +964,123 @@
         # Example usage: @tool(return_direct=True)
         def _partial(func: Callable[[str], str]) -> BaseTool:
             return _make_with_name(func.__name__)(func)
 
         return _partial
     else:
         raise ValueError("Too many arguments for tool decorator")
+
+
+class RetrieverInput(BaseModel):
+    """Input to the retriever."""
+
+    query: str = Field(description="query to look up in retriever")
+
+
+def _get_relevant_documents(
+    query: str,
+    retriever: BaseRetriever,
+    document_prompt: BasePromptTemplate,
+    document_separator: str,
+    callbacks: Callbacks = None,
+) -> str:
+    docs = retriever.invoke(query, config={"callbacks": callbacks})
+    return document_separator.join(
+        format_document(doc, document_prompt) for doc in docs
+    )
+
+
+async def _aget_relevant_documents(
+    query: str,
+    retriever: BaseRetriever,
+    document_prompt: BasePromptTemplate,
+    document_separator: str,
+    callbacks: Callbacks = None,
+) -> str:
+    docs = await retriever.ainvoke(query, config={"callbacks": callbacks})
+    return document_separator.join(
+        [await aformat_document(doc, document_prompt) for doc in docs]
+    )
+
+
+def create_retriever_tool(
+    retriever: BaseRetriever,
+    name: str,
+    description: str,
+    *,
+    document_prompt: Optional[BasePromptTemplate] = None,
+    document_separator: str = "\n\n",
+) -> Tool:
+    """Create a tool to do retrieval of documents.
+
+    Args:
+        retriever: The retriever to use for the retrieval
+        name: The name for the tool. This will be passed to the language model,
+            so should be unique and somewhat descriptive.
+        description: The description for the tool. This will be passed to the language
+            model, so should be descriptive.
+
+    Returns:
+        Tool class to pass to an agent
+    """
+    document_prompt = document_prompt or PromptTemplate.from_template("{page_content}")
+    func = partial(
+        _get_relevant_documents,
+        retriever=retriever,
+        document_prompt=document_prompt,
+        document_separator=document_separator,
+    )
+    afunc = partial(
+        _aget_relevant_documents,
+        retriever=retriever,
+        document_prompt=document_prompt,
+        document_separator=document_separator,
+    )
+    return Tool(
+        name=name,
+        description=description,
+        func=func,
+        coroutine=afunc,
+        args_schema=RetrieverInput,
+    )
+
+
+ToolsRenderer = Callable[[List[BaseTool]], str]
+
+
+def render_text_description(tools: List[BaseTool]) -> str:
+    """Render the tool name and description in plain text.
+
+    Output will be in the format of:
+
+    .. code-block:: markdown
+
+        search: This tool is used for search
+        calculator: This tool is used for math
+    """
+    return "\n".join([f"{tool.name}: {tool.description}" for tool in tools])
+
+
+def render_text_description_and_args(tools: List[BaseTool]) -> str:
+    """Render the tool name, description, and args in plain text.
+
+    Output will be in the format of:
+
+    .. code-block:: markdown
+
+        search: This tool is used for search, args: {"query": {"type": "string"}}
+        calculator: This tool is used for math, \
+args: {"expression": {"type": "string"}}
+    """
+    tool_strings = []
+    for tool in tools:
+        args_schema = str(tool.args)
+        tool_strings.append(f"{tool.name}: {tool.description}, args: {args_schema}")
+    return "\n".join(tool_strings)
+
+
+class BaseToolkit(BaseModel, ABC):
+    """Base Toolkit representing a collection of related tools."""
+
+    @abstractmethod
+    def get_tools(self) -> List[BaseTool]:
+        """Get the tools in the toolkit."""
```

### Comparing `langchain_core-0.1.9/langchain_core/tracers/base.py` & `langchain_core-0.2.0rc1/langchain_core/tracers/base.py`

 * *Files 18% similar despite different names*

```diff
@@ -1,32 +1,37 @@
 """Base interfaces for tracing runs."""
+
 from __future__ import annotations
 
 import logging
 import sys
 import traceback
 from abc import ABC, abstractmethod
 from datetime import datetime, timezone
 from typing import (
     TYPE_CHECKING,
     Any,
     Dict,
     List,
+    Literal,
     Optional,
     Sequence,
+    Set,
+    Tuple,
     Union,
     cast,
 )
 from uuid import UUID
 
 from tenacity import RetryCallState
 
 from langchain_core.callbacks.base import BaseCallbackHandler
 from langchain_core.exceptions import TracerException
 from langchain_core.load import dumpd
+from langchain_core.messages import BaseMessage
 from langchain_core.outputs import (
     ChatGeneration,
     ChatGenerationChunk,
     GenerationChunk,
     LLMResult,
 )
 from langchain_core.tracers.schemas import Run
@@ -36,17 +41,41 @@
 
 logger = logging.getLogger(__name__)
 
 
 class BaseTracer(BaseCallbackHandler, ABC):
     """Base interface for tracers."""
 
-    def __init__(self, **kwargs: Any) -> None:
+    def __init__(
+        self,
+        *,
+        _schema_format: Literal["original", "streaming_events"] = "original",
+        **kwargs: Any,
+    ) -> None:
+        """Initialize the tracer.
+
+        Args:
+            _schema_format: Primarily changes how the inputs and outputs are
+                handled. For internal use only. This API will change.
+                - 'original' is the format used by all current tracers.
+                   This format is slightly inconsistent with respect to inputs
+                   and outputs.
+                - 'streaming_events' is used for supporting streaming events,
+                   for internal usage. It will likely change in the future, or
+                   be deprecated entirely in favor of a dedicated async tracer
+                   for streaming events.
+            kwargs: Additional keyword arguments that will be passed to
+                    the super class.
+        """
         super().__init__(**kwargs)
+        self._schema_format = _schema_format  # For internal use only API will change.
         self.run_map: Dict[str, Run] = {}
+        """Map of run ID to run. Cleared on run end."""
+        self.order_map: Dict[UUID, Tuple[UUID, str]] = {}
+        """Map of run ID to (trace_id, dotted_order). Cleared when tracer GCed."""
 
     @staticmethod
     def _add_child_run(
         parent_run: Run,
         child_run: Run,
     ) -> None:
         """Add child run to a chain run or tool run."""
@@ -71,115 +100,135 @@
         except:  # noqa: E722
             return msg
 
     def _start_trace(self, run: Run) -> None:
         """Start a trace for a run."""
         current_dotted_order = run.start_time.strftime("%Y%m%dT%H%M%S%fZ") + str(run.id)
         if run.parent_run_id:
-            parent_run = self.run_map.get(str(run.parent_run_id))
-            if parent_run:
-                self._add_child_run(parent_run, run)
-                parent_run.child_execution_order = max(
-                    parent_run.child_execution_order, run.child_execution_order
-                )
-                run.trace_id = parent_run.trace_id
-                if parent_run.dotted_order:
-                    run.dotted_order = (
-                        parent_run.dotted_order + "." + current_dotted_order
-                    )
-                else:
-                    # Something wrong with tracer parent run has no dotted_order
-                    logger.debug(
-                        f"Parent run with UUID {run.parent_run_id} has no dotted_order."
-                    )
+            if parent := self.order_map.get(run.parent_run_id):
+                run.trace_id, run.dotted_order = parent
+                run.dotted_order += "." + current_dotted_order
+                if parent_run := self.run_map.get(str(run.parent_run_id)):
+                    self._add_child_run(parent_run, run)
             else:
-                # Something wrong with tracer, parent run not found
-                # Calculate the trace_id and dotted_order server side
-                logger.debug(f"Parent run with UUID {run.parent_run_id} not found.")
+                logger.warning(
+                    f"Parent run {run.parent_run_id} not found for run {run.id}."
+                    " Treating as a root run."
+                )
+                run.parent_run_id = None
+                run.trace_id = run.id
+                run.dotted_order = current_dotted_order
         else:
             run.trace_id = run.id
             run.dotted_order = current_dotted_order
+        self.order_map[run.id] = (run.trace_id, run.dotted_order)
         self.run_map[str(run.id)] = run
         self._on_run_create(run)
 
     def _end_trace(self, run: Run) -> None:
         """End a trace for a run."""
         if not run.parent_run_id:
             self._persist_run(run)
-        else:
-            parent_run = self.run_map.get(str(run.parent_run_id))
-            if parent_run is None:
-                logger.debug(f"Parent run with UUID {run.parent_run_id} not found.")
-            elif (
-                run.child_execution_order is not None
-                and parent_run.child_execution_order is not None
-                and run.child_execution_order > parent_run.child_execution_order
-            ):
-                parent_run.child_execution_order = run.child_execution_order
         self.run_map.pop(str(run.id))
         self._on_run_update(run)
 
-    def _get_execution_order(self, parent_run_id: Optional[str] = None) -> int:
-        """Get the execution order for a run."""
-        if parent_run_id is None:
-            return 1
-
-        parent_run = self.run_map.get(parent_run_id)
-        if parent_run is None:
-            logger.debug(f"Parent run with UUID {parent_run_id} not found.")
-            return 1
-        if parent_run.child_execution_order is None:
-            raise TracerException(
-                f"Parent run with UUID {parent_run_id} has no child execution order."
-            )
-
-        return parent_run.child_execution_order + 1
-
-    def _get_run(self, run_id: UUID, run_type: Optional[str] = None) -> Run:
+    def _get_run(
+        self, run_id: UUID, run_type: Union[str, Set[str], None] = None
+    ) -> Run:
         try:
             run = self.run_map[str(run_id)]
         except KeyError as exc:
             raise TracerException(f"No indexed run ID {run_id}.") from exc
-        if run_type is not None and run.run_type != run_type:
+
+        if isinstance(run_type, str):
+            run_types: Union[Set[str], None] = {run_type}
+        else:
+            run_types = run_type
+        if run_types is not None and run.run_type not in run_types:
             raise TracerException(
-                f"Found {run.run_type} run at ID {run_id}, but expected {run_type} run."
+                f"Found {run.run_type} run at ID {run_id}, "
+                f"but expected {run_types} run."
             )
         return run
 
+    def on_chat_model_start(
+        self,
+        serialized: Dict[str, Any],
+        messages: List[List[BaseMessage]],
+        *,
+        run_id: UUID,
+        tags: Optional[List[str]] = None,
+        parent_run_id: Optional[UUID] = None,
+        metadata: Optional[Dict[str, Any]] = None,
+        name: Optional[str] = None,
+        **kwargs: Any,
+    ) -> Run:
+        """Start a trace for an LLM run."""
+        if self._schema_format != "streaming_events":
+            # Please keep this un-implemented for backwards compatibility.
+            # When it's unimplemented old tracers that use the "original" format
+            # fallback on the on_llm_start method implementation if they
+            # find that the on_chat_model_start method is not implemented.
+            # This can eventually be cleaned up by writing a "modern" tracer
+            # that has all the updated schema changes corresponding to
+            # the "streaming_events" format.
+            raise NotImplementedError(
+                f"Chat model tracing is not supported in "
+                f"for {self._schema_format} format."
+            )
+        start_time = datetime.now(timezone.utc)
+        if metadata:
+            kwargs.update({"metadata": metadata})
+        chat_model_run = Run(
+            id=run_id,
+            parent_run_id=parent_run_id,
+            serialized=serialized,
+            inputs={"messages": [[dumpd(msg) for msg in batch] for batch in messages]},
+            extra=kwargs,
+            events=[{"name": "start", "time": start_time}],
+            start_time=start_time,
+            # WARNING: This is valid ONLY for streaming_events.
+            # run_type="llm" is what's used by virtually all tracers.
+            # Changing this to "chat_model" may break triggering on_llm_start
+            run_type="chat_model",
+            tags=tags,
+            name=name,  # type: ignore[arg-type]
+        )
+        self._start_trace(chat_model_run)
+        self._on_chat_model_start(chat_model_run)
+        return chat_model_run
+
     def on_llm_start(
         self,
         serialized: Dict[str, Any],
         prompts: List[str],
         *,
         run_id: UUID,
         tags: Optional[List[str]] = None,
         parent_run_id: Optional[UUID] = None,
         metadata: Optional[Dict[str, Any]] = None,
         name: Optional[str] = None,
         **kwargs: Any,
     ) -> Run:
         """Start a trace for an LLM run."""
-        parent_run_id_ = str(parent_run_id) if parent_run_id else None
-        execution_order = self._get_execution_order(parent_run_id_)
         start_time = datetime.now(timezone.utc)
         if metadata:
             kwargs.update({"metadata": metadata})
         llm_run = Run(
             id=run_id,
             parent_run_id=parent_run_id,
             serialized=serialized,
+            # TODO: Figure out how to expose kwargs here
             inputs={"prompts": prompts},
             extra=kwargs,
             events=[{"name": "start", "time": start_time}],
             start_time=start_time,
-            execution_order=execution_order,
-            child_execution_order=execution_order,
             run_type="llm",
             tags=tags or [],
-            name=name,
+            name=name,  # type: ignore[arg-type]
         )
         self._start_trace(llm_run)
         self._on_llm_start(llm_run)
         return llm_run
 
     def on_llm_new_token(
         self,
@@ -187,15 +236,17 @@
         *,
         chunk: Optional[Union[GenerationChunk, ChatGenerationChunk]] = None,
         run_id: UUID,
         parent_run_id: Optional[UUID] = None,
         **kwargs: Any,
     ) -> Run:
         """Run on new LLM token. Only available when streaming is enabled."""
-        llm_run = self._get_run(run_id, run_type="llm")
+        # "chat_model" is only used for the experimental new streaming_events format.
+        # This change should not affect any existing tracers.
+        llm_run = self._get_run(run_id, run_type={"llm", "chat_model"})
         event_kwargs: Dict[str, Any] = {"token": token}
         if chunk:
             event_kwargs["chunk"] = chunk
         llm_run.events.append(
             {
                 "name": "new_token",
                 "time": datetime.now(timezone.utc),
@@ -234,15 +285,17 @@
                 "kwargs": retry_d,
             },
         )
         return llm_run
 
     def on_llm_end(self, response: LLMResult, *, run_id: UUID, **kwargs: Any) -> Run:
         """End a trace for an LLM run."""
-        llm_run = self._get_run(run_id, run_type="llm")
+        # "chat_model" is only used for the experimental new streaming_events format.
+        # This change should not affect any existing tracers.
+        llm_run = self._get_run(run_id, run_type={"llm", "chat_model"})
         llm_run.outputs = response.dict()
         for i, generations in enumerate(response.generations):
             for j, generation in enumerate(generations):
                 output_generation = llm_run.outputs["generations"][i][j]
                 if "message" in output_generation:
                     output_generation["message"] = dumpd(
                         cast(ChatGeneration, generation).message
@@ -257,15 +310,17 @@
         self,
         error: BaseException,
         *,
         run_id: UUID,
         **kwargs: Any,
     ) -> Run:
         """Handle an error for an LLM run."""
-        llm_run = self._get_run(run_id, run_type="llm")
+        # "chat_model" is only used for the experimental new streaming_events format.
+        # This change should not affect any existing tracers.
+        llm_run = self._get_run(run_id, run_type={"llm", "chat_model"})
         llm_run.error = self._get_stacktrace(error)
         llm_run.end_time = datetime.now(timezone.utc)
         llm_run.events.append({"name": "error", "time": llm_run.end_time})
         self._end_trace(llm_run)
         self._on_llm_error(llm_run)
         return llm_run
 
@@ -279,55 +334,71 @@
         parent_run_id: Optional[UUID] = None,
         metadata: Optional[Dict[str, Any]] = None,
         run_type: Optional[str] = None,
         name: Optional[str] = None,
         **kwargs: Any,
     ) -> Run:
         """Start a trace for a chain run."""
-        parent_run_id_ = str(parent_run_id) if parent_run_id else None
-        execution_order = self._get_execution_order(parent_run_id_)
         start_time = datetime.now(timezone.utc)
         if metadata:
             kwargs.update({"metadata": metadata})
         chain_run = Run(
             id=run_id,
             parent_run_id=parent_run_id,
             serialized=serialized,
-            inputs=inputs if isinstance(inputs, dict) else {"input": inputs},
+            inputs=self._get_chain_inputs(inputs),
             extra=kwargs,
             events=[{"name": "start", "time": start_time}],
             start_time=start_time,
-            execution_order=execution_order,
-            child_execution_order=execution_order,
             child_runs=[],
             run_type=run_type or "chain",
-            name=name,
+            name=name,  # type: ignore[arg-type]
             tags=tags or [],
         )
         self._start_trace(chain_run)
         self._on_chain_start(chain_run)
         return chain_run
 
+    def _get_chain_inputs(self, inputs: Any) -> Any:
+        """Get the inputs for a chain run."""
+        if self._schema_format == "original":
+            return inputs if isinstance(inputs, dict) else {"input": inputs}
+        elif self._schema_format == "streaming_events":
+            return {
+                "input": inputs,
+            }
+        else:
+            raise ValueError(f"Invalid format: {self._schema_format}")
+
+    def _get_chain_outputs(self, outputs: Any) -> Any:
+        """Get the outputs for a chain run."""
+        if self._schema_format == "original":
+            return outputs if isinstance(outputs, dict) else {"output": outputs}
+        elif self._schema_format == "streaming_events":
+            return {
+                "output": outputs,
+            }
+        else:
+            raise ValueError(f"Invalid format: {self._schema_format}")
+
     def on_chain_end(
         self,
         outputs: Dict[str, Any],
         *,
         run_id: UUID,
         inputs: Optional[Dict[str, Any]] = None,
         **kwargs: Any,
     ) -> Run:
         """End a trace for a chain run."""
         chain_run = self._get_run(run_id)
-        chain_run.outputs = (
-            outputs if isinstance(outputs, dict) else {"output": outputs}
-        )
+        chain_run.outputs = self._get_chain_outputs(outputs)
         chain_run.end_time = datetime.now(timezone.utc)
         chain_run.events.append({"name": "end", "time": chain_run.end_time})
         if inputs is not None:
-            chain_run.inputs = inputs if isinstance(inputs, dict) else {"input": inputs}
+            chain_run.inputs = self._get_chain_inputs(inputs)
         self._end_trace(chain_run)
         self._on_chain_end(chain_run)
         return chain_run
 
     def on_chain_error(
         self,
         error: BaseException,
@@ -338,57 +409,63 @@
     ) -> Run:
         """Handle an error for a chain run."""
         chain_run = self._get_run(run_id)
         chain_run.error = self._get_stacktrace(error)
         chain_run.end_time = datetime.now(timezone.utc)
         chain_run.events.append({"name": "error", "time": chain_run.end_time})
         if inputs is not None:
-            chain_run.inputs = inputs if isinstance(inputs, dict) else {"input": inputs}
+            chain_run.inputs = self._get_chain_inputs(inputs)
         self._end_trace(chain_run)
         self._on_chain_error(chain_run)
         return chain_run
 
     def on_tool_start(
         self,
         serialized: Dict[str, Any],
         input_str: str,
         *,
         run_id: UUID,
         tags: Optional[List[str]] = None,
         parent_run_id: Optional[UUID] = None,
         metadata: Optional[Dict[str, Any]] = None,
         name: Optional[str] = None,
+        inputs: Optional[Dict[str, Any]] = None,
         **kwargs: Any,
     ) -> Run:
         """Start a trace for a tool run."""
-        parent_run_id_ = str(parent_run_id) if parent_run_id else None
-        execution_order = self._get_execution_order(parent_run_id_)
         start_time = datetime.now(timezone.utc)
         if metadata:
             kwargs.update({"metadata": metadata})
+
+        if self._schema_format == "original":
+            inputs = {"input": input_str}
+        elif self._schema_format == "streaming_events":
+            inputs = {"input": inputs}
+        else:
+            raise AssertionError(f"Invalid format: {self._schema_format}")
+
         tool_run = Run(
             id=run_id,
             parent_run_id=parent_run_id,
             serialized=serialized,
-            inputs={"input": input_str},
+            # Wrapping in dict since Run requires a dict object.
+            inputs=inputs,
             extra=kwargs,
             events=[{"name": "start", "time": start_time}],
             start_time=start_time,
-            execution_order=execution_order,
-            child_execution_order=execution_order,
             child_runs=[],
             run_type="tool",
             tags=tags or [],
-            name=name,
+            name=name,  # type: ignore[arg-type]
         )
         self._start_trace(tool_run)
         self._on_tool_start(tool_run)
         return tool_run
 
-    def on_tool_end(self, output: str, *, run_id: UUID, **kwargs: Any) -> Run:
+    def on_tool_end(self, output: Any, *, run_id: UUID, **kwargs: Any) -> Run:
         """End a trace for a tool run."""
         tool_run = self._get_run(run_id, run_type="tool")
         tool_run.outputs = {"output": output}
         tool_run.end_time = datetime.now(timezone.utc)
         tool_run.events.append({"name": "end", "time": tool_run.end_time})
         self._end_trace(tool_run)
         self._on_tool_end(tool_run)
@@ -419,30 +496,26 @@
         parent_run_id: Optional[UUID] = None,
         tags: Optional[List[str]] = None,
         metadata: Optional[Dict[str, Any]] = None,
         name: Optional[str] = None,
         **kwargs: Any,
     ) -> Run:
         """Run when Retriever starts running."""
-        parent_run_id_ = str(parent_run_id) if parent_run_id else None
-        execution_order = self._get_execution_order(parent_run_id_)
         start_time = datetime.now(timezone.utc)
         if metadata:
             kwargs.update({"metadata": metadata})
         retrieval_run = Run(
             id=run_id,
             name=name or "Retriever",
             parent_run_id=parent_run_id,
             serialized=serialized,
             inputs={"query": query},
             extra=kwargs,
             events=[{"name": "start", "time": start_time}],
             start_time=start_time,
-            execution_order=execution_order,
-            child_execution_order=execution_order,
             tags=tags,
             child_runs=[],
             run_type="retriever",
         )
         self._start_trace(retrieval_run)
         self._on_retriever_start(retrieval_run)
         return retrieval_run
```

### Comparing `langchain_core-0.1.9/langchain_core/tracers/context.py` & `langchain_core-0.2.0rc1/langchain_core/tracers/context.py`

 * *Files 5% similar despite different names*

```diff
@@ -14,65 +14,43 @@
     cast,
 )
 from uuid import UUID
 
 from langsmith import utils as ls_utils
 from langsmith.run_helpers import get_run_tree_context
 
-from langchain_core._api import deprecated
 from langchain_core.tracers.langchain import LangChainTracer
-from langchain_core.tracers.langchain_v1 import LangChainTracerV1
 from langchain_core.tracers.run_collector import RunCollectorCallbackHandler
 from langchain_core.tracers.schemas import TracerSessionV1
 from langchain_core.utils.env import env_var_is_set
 
 if TYPE_CHECKING:
     from langsmith import Client as LangSmithClient
 
     from langchain_core.callbacks.base import BaseCallbackHandler, Callbacks
     from langchain_core.callbacks.manager import AsyncCallbackManager, CallbackManager
 
-# Deprecated as of 0.1.0, will be removed in 0.2.0.
-tracing_callback_var: ContextVar[Optional[LangChainTracerV1]] = ContextVar(  # noqa: E501
-    "tracing_callback", default=None
-)
-
-tracing_v2_callback_var: ContextVar[Optional[LangChainTracer]] = ContextVar(  # noqa: E501
+# for backwards partial compatibility if this is imported by users but unused
+tracing_callback_var: Any = None
+tracing_v2_callback_var: ContextVar[Optional[LangChainTracer]] = ContextVar(
     "tracing_callback_v2", default=None
-)
-run_collector_var: ContextVar[Optional[RunCollectorCallbackHandler]] = ContextVar(  # noqa: E501
+)  # noqa: E501
+run_collector_var: ContextVar[Optional[RunCollectorCallbackHandler]] = ContextVar(
     "run_collector", default=None
-)
+)  # noqa: E501
 
 
 @contextmanager
-@deprecated("0.1.0", alternative="tracing_v2_enabled", removal="0.2.0")
 def tracing_enabled(
     session_name: str = "default",
 ) -> Generator[TracerSessionV1, None, None]:
-    """Get the Deprecated LangChainTracer in a context manager.
-
-    Args:
-        session_name (str, optional): The name of the session.
-          Defaults to "default".
-
-    Returns:
-        TracerSessionV1: The LangChainTracer session.
-
-    Example:
-        >>> with tracing_enabled() as session:
-        ...     # Use the LangChainTracer session
-    """
-    cb = LangChainTracerV1()
-    session = cast(TracerSessionV1, cb.load_session(session_name))
-    try:
-        tracing_callback_var.set(cb)
-        yield session
-    finally:
-        tracing_callback_var.set(None)
+    """Throw an error because this has been replaced by tracing_v2_enabled."""
+    raise RuntimeError(
+        "tracing_enabled is no longer supported. Please use tracing_enabled_v2 instead."
+    )
 
 
 @contextmanager
 def tracing_v2_enabled(
     project_name: Optional[str] = None,
     *,
     example_id: Optional[Union[str, UUID]] = None,
@@ -165,14 +143,16 @@
         cb = None
     return cb
 
 
 def _tracing_v2_is_enabled() -> bool:
     return (
         env_var_is_set("LANGCHAIN_TRACING_V2")
+        or env_var_is_set("LANGSMITH_TRACING")
+        or env_var_is_set("LANGSMITH_TRACING_V2")
         or tracing_v2_callback_var.get() is not None
         or get_run_tree_context() is not None
     )
 
 
 def _get_tracer_project() -> str:
     run_tree = get_run_tree_context()
```

### Comparing `langchain_core-0.1.9/langchain_core/tracers/evaluation.py` & `langchain_core-0.2.0rc1/langchain_core/tracers/evaluation.py`

 * *Files 1% similar despite different names*

```diff
@@ -27,15 +27,15 @@
     global _TRACERS
     for tracer in list(_TRACERS):
         if tracer is not None:
             tracer.wait_for_futures()
 
 
 class EvaluatorCallbackHandler(BaseTracer):
-    """A tracer that runs a run evaluator whenever a run is persisted.
+    """Tracer that runs a run evaluator whenever a run is persisted.
 
     Parameters
     ----------
     evaluators : Sequence[RunEvaluator]
         The run evaluators to apply to all top level runs.
     client : LangSmith Client, optional
         The LangSmith client instance to use for evaluating the runs.
```

### Comparing `langchain_core-0.1.9/langchain_core/tracers/langchain.py` & `langchain_core-0.2.0rc1/langchain_core/tracers/langchain.py`

 * *Files 10% similar despite different names*

```diff
@@ -1,15 +1,15 @@
 """A Tracer implementation that records to LangChain endpoint."""
+
 from __future__ import annotations
 
 import logging
-import weakref
-from concurrent.futures import Future, ThreadPoolExecutor, wait
+from concurrent.futures import ThreadPoolExecutor
 from datetime import datetime, timezone
-from typing import TYPE_CHECKING, Any, Callable, Dict, List, Optional, Union
+from typing import TYPE_CHECKING, Any, Dict, List, Optional, Union
 from uuid import UUID
 
 from langsmith import Client
 from langsmith import utils as ls_utils
 from tenacity import (
     Retrying,
     retry_if_exception_type,
@@ -23,15 +23,14 @@
 from langchain_core.tracers.schemas import Run
 
 if TYPE_CHECKING:
     from langchain_core.messages import BaseMessage
 
 logger = logging.getLogger(__name__)
 _LOGGED = set()
-_TRACERS: weakref.WeakSet[LangChainTracer] = weakref.WeakSet()
 _CLIENT: Optional[Client] = None
 _EXECUTOR: Optional[ThreadPoolExecutor] = None
 
 
 def log_error_once(method: str, exception: Exception) -> None:
     """Log an error once."""
     global _LOGGED
@@ -39,18 +38,17 @@
         return
     _LOGGED.add((method, type(exception)))
     logger.error(exception)
 
 
 def wait_for_all_tracers() -> None:
     """Wait for all tracers to finish."""
-    global _TRACERS
-    for tracer in list(_TRACERS):
-        if tracer is not None:
-            tracer.wait_for_futures()
+    global _CLIENT
+    if _CLIENT is not None and _CLIENT.tracing_queue is not None:
+        _CLIENT.tracing_queue.join()
 
 
 def get_client() -> Client:
     """Get the client."""
     global _CLIENT
     if _CLIENT is None:
         _CLIENT = Client()
@@ -61,84 +59,74 @@
     """Get the executor."""
     global _EXECUTOR
     if _EXECUTOR is None:
         _EXECUTOR = ThreadPoolExecutor()
     return _EXECUTOR
 
 
-def _copy(run: Run) -> Run:
-    """Copy a run."""
-    try:
-        return run.copy(deep=True)
-    except TypeError:
-        # Fallback in case the object contains a lock or other
-        # non-pickleable object
-        return run.copy()
+def _run_to_dict(run: Run) -> dict:
+    return {
+        **run.dict(exclude={"child_runs", "inputs", "outputs"}),
+        "inputs": run.inputs.copy() if run.inputs is not None else None,
+        "outputs": run.outputs.copy() if run.outputs is not None else None,
+    }
 
 
 class LangChainTracer(BaseTracer):
-    """An implementation of the SharedTracer that POSTS to the langchain endpoint."""
+    """Implementation of the SharedTracer that POSTS to the LangChain endpoint."""
 
     def __init__(
         self,
         example_id: Optional[Union[UUID, str]] = None,
         project_name: Optional[str] = None,
         client: Optional[Client] = None,
         tags: Optional[List[str]] = None,
-        use_threading: bool = True,
         **kwargs: Any,
     ) -> None:
         """Initialize the LangChain tracer."""
         super().__init__(**kwargs)
         self.example_id = (
             UUID(example_id) if isinstance(example_id, str) else example_id
         )
         self.project_name = project_name or ls_utils.get_tracer_project()
         self.client = client or get_client()
-        self._futures: weakref.WeakSet[Future] = weakref.WeakSet()
         self.tags = tags or []
-        self.executor = _get_executor() if use_threading else None
         self.latest_run: Optional[Run] = None
-        global _TRACERS
-        _TRACERS.add(self)
 
     def on_chat_model_start(
         self,
         serialized: Dict[str, Any],
         messages: List[List[BaseMessage]],
         *,
         run_id: UUID,
         tags: Optional[List[str]] = None,
         parent_run_id: Optional[UUID] = None,
         metadata: Optional[Dict[str, Any]] = None,
         name: Optional[str] = None,
         **kwargs: Any,
-    ) -> None:
+    ) -> Run:
         """Start a trace for an LLM run."""
-        parent_run_id_ = str(parent_run_id) if parent_run_id else None
-        execution_order = self._get_execution_order(parent_run_id_)
         start_time = datetime.now(timezone.utc)
         if metadata:
             kwargs.update({"metadata": metadata})
         chat_model_run = Run(
             id=run_id,
             parent_run_id=parent_run_id,
             serialized=serialized,
             inputs={"messages": [[dumpd(msg) for msg in batch] for batch in messages]},
             extra=kwargs,
             events=[{"name": "start", "time": start_time}],
             start_time=start_time,
-            execution_order=execution_order,
-            child_execution_order=execution_order,
             run_type="llm",
             tags=tags,
-            name=name,
+            name=name,  # type: ignore[arg-type]
         )
         self._start_trace(chat_model_run)
         self._on_chat_model_start(chat_model_run)
+        return chat_model_run
 
     def _persist_run(self, run: Run) -> None:
         run_ = run.copy()
         run_.reference_example_id = self.example_id
         self.latest_run = run_
 
     def get_run_url(self) -> str:
@@ -163,102 +151,96 @@
         """Get combined tags for a run."""
         tags = set(run.tags or [])
         tags.update(self.tags or [])
         return list(tags)
 
     def _persist_run_single(self, run: Run) -> None:
         """Persist a run."""
-        run_dict = run.dict(exclude={"child_runs"})
+        run_dict = _run_to_dict(run)
         run_dict["tags"] = self._get_tags(run)
         extra = run_dict.get("extra", {})
         extra["runtime"] = get_runtime_environment()
         run_dict["extra"] = extra
         try:
             self.client.create_run(**run_dict, project_name=self.project_name)
         except Exception as e:
             # Errors are swallowed by the thread executor so we need to log them here
             log_error_once("post", e)
             raise
 
     def _update_run_single(self, run: Run) -> None:
         """Update a run."""
         try:
-            run_dict = run.dict()
+            run_dict = _run_to_dict(run)
             run_dict["tags"] = self._get_tags(run)
             self.client.update_run(run.id, **run_dict)
         except Exception as e:
             # Errors are swallowed by the thread executor so we need to log them here
             log_error_once("patch", e)
             raise
 
-    def _submit(self, function: Callable[[Run], None], run: Run) -> None:
-        """Submit a function to the executor."""
-        if self.executor is None:
-            function(run)
-        else:
-            self._futures.add(self.executor.submit(function, run))
-
     def _on_llm_start(self, run: Run) -> None:
         """Persist an LLM run."""
         if run.parent_run_id is None:
             run.reference_example_id = self.example_id
-        self._submit(self._persist_run_single, _copy(run))
+        self._persist_run_single(run)
 
     def _on_chat_model_start(self, run: Run) -> None:
         """Persist an LLM run."""
         if run.parent_run_id is None:
             run.reference_example_id = self.example_id
-        self._submit(self._persist_run_single, _copy(run))
+        self._persist_run_single(run)
 
     def _on_llm_end(self, run: Run) -> None:
         """Process the LLM Run."""
-        self._submit(self._update_run_single, _copy(run))
+        self._update_run_single(run)
 
     def _on_llm_error(self, run: Run) -> None:
         """Process the LLM Run upon error."""
-        self._submit(self._update_run_single, _copy(run))
+        self._update_run_single(run)
 
     def _on_chain_start(self, run: Run) -> None:
         """Process the Chain Run upon start."""
         if run.parent_run_id is None:
             run.reference_example_id = self.example_id
-        self._submit(self._persist_run_single, _copy(run))
+        self._persist_run_single(run)
 
     def _on_chain_end(self, run: Run) -> None:
         """Process the Chain Run."""
-        self._submit(self._update_run_single, _copy(run))
+        self._update_run_single(run)
 
     def _on_chain_error(self, run: Run) -> None:
         """Process the Chain Run upon error."""
-        self._submit(self._update_run_single, _copy(run))
+        self._update_run_single(run)
 
     def _on_tool_start(self, run: Run) -> None:
         """Process the Tool Run upon start."""
         if run.parent_run_id is None:
             run.reference_example_id = self.example_id
-        self._submit(self._persist_run_single, _copy(run))
+        self._persist_run_single(run)
 
     def _on_tool_end(self, run: Run) -> None:
         """Process the Tool Run."""
-        self._submit(self._update_run_single, _copy(run))
+        self._update_run_single(run)
 
     def _on_tool_error(self, run: Run) -> None:
         """Process the Tool Run upon error."""
-        self._submit(self._update_run_single, _copy(run))
+        self._update_run_single(run)
 
     def _on_retriever_start(self, run: Run) -> None:
         """Process the Retriever Run upon start."""
         if run.parent_run_id is None:
             run.reference_example_id = self.example_id
-        self._submit(self._persist_run_single, _copy(run))
+        self._persist_run_single(run)
 
     def _on_retriever_end(self, run: Run) -> None:
         """Process the Retriever Run."""
-        self._submit(self._update_run_single, _copy(run))
+        self._update_run_single(run)
 
     def _on_retriever_error(self, run: Run) -> None:
         """Process the Retriever Run upon error."""
-        self._submit(self._update_run_single, _copy(run))
+        self._update_run_single(run)
 
     def wait_for_futures(self) -> None:
         """Wait for the given futures to complete."""
-        wait(self._futures)
+        if self.client is not None and self.client.tracing_queue is not None:
+            self.client.tracing_queue.join()
```

### Comparing `langchain_core-0.1.9/langchain_core/tracers/root_listeners.py` & `langchain_core-0.2.0rc1/langchain_core/tracers/root_listeners.py`

 * *Files 1% similar despite different names*

```diff
@@ -8,15 +8,15 @@
 from langchain_core.tracers.base import BaseTracer
 from langchain_core.tracers.schemas import Run
 
 Listener = Union[Callable[[Run], None], Callable[[Run, RunnableConfig], None]]
 
 
 class RootListenersTracer(BaseTracer):
-    """A tracer that calls listeners on run start, end, and error."""
+    """Tracer that calls listeners on run start, end, and error."""
 
     def __init__(
         self,
         *,
         config: RunnableConfig,
         on_start: Optional[Listener],
         on_end: Optional[Listener],
```

### Comparing `langchain_core-0.1.9/langchain_core/tracers/run_collector.py` & `langchain_core-0.2.0rc1/langchain_core/tracers/run_collector.py`

 * *Files 1% similar despite different names*

```diff
@@ -5,15 +5,15 @@
 
 from langchain_core.tracers.base import BaseTracer
 from langchain_core.tracers.schemas import Run
 
 
 class RunCollectorCallbackHandler(BaseTracer):
     """
-    A tracer that collects all nested runs in a list.
+    Tracer that collects all nested runs in a list.
 
     This tracer is useful for inspection and evaluation purposes.
 
     Parameters
     ----------
     example_id : Optional[Union[UUID, str]], default=None
         The ID of the example being traced. It can be either a UUID or a string.
```

### Comparing `langchain_core-0.1.9/langchain_core/tracers/schemas.py` & `langchain_core-0.2.0rc1/langchain_core/tracers/schemas.py`

 * *Files 10% similar despite different names*

```diff
@@ -10,61 +10,61 @@
 from langsmith.schemas import RunTypeEnum as RunTypeEnumDep
 
 from langchain_core._api import deprecated
 from langchain_core.outputs import LLMResult
 from langchain_core.pydantic_v1 import BaseModel, Field, root_validator
 
 
-@deprecated("0.1.0", alternative="Use string instead.", removal="0.2.0")
+@deprecated("0.1.0", alternative="Use string instead.", removal="0.3.0")
 def RunTypeEnum() -> Type[RunTypeEnumDep]:
     """RunTypeEnum."""
     warnings.warn(
         "RunTypeEnum is deprecated. Please directly use a string instead"
         " (e.g. 'llm', 'chain', 'tool').",
         DeprecationWarning,
     )
     return RunTypeEnumDep
 
 
-@deprecated("0.1.0", removal="0.2.0")
+@deprecated("0.1.0", removal="0.3.0")
 class TracerSessionV1Base(BaseModel):
     """Base class for TracerSessionV1."""
 
     start_time: datetime.datetime = Field(default_factory=datetime.datetime.utcnow)
     name: Optional[str] = None
     extra: Optional[Dict[str, Any]] = None
 
 
-@deprecated("0.1.0", removal="0.2.0")
+@deprecated("0.1.0", removal="0.3.0")
 class TracerSessionV1Create(TracerSessionV1Base):
     """Create class for TracerSessionV1."""
 
 
-@deprecated("0.1.0", removal="0.2.0")
+@deprecated("0.1.0", removal="0.3.0")
 class TracerSessionV1(TracerSessionV1Base):
     """TracerSessionV1 schema."""
 
     id: int
 
 
-@deprecated("0.1.0", removal="0.2.0")
+@deprecated("0.1.0", removal="0.3.0")
 class TracerSessionBase(TracerSessionV1Base):
     """Base class for TracerSession."""
 
     tenant_id: UUID
 
 
-@deprecated("0.1.0", removal="0.2.0")
+@deprecated("0.1.0", removal="0.3.0")
 class TracerSession(TracerSessionBase):
     """TracerSessionV1 schema for the V2 API."""
 
     id: UUID
 
 
-@deprecated("0.1.0", alternative="Run", removal="0.2.0")
+@deprecated("0.1.0", alternative="Run", removal="0.3.0")
 class BaseRun(BaseModel):
     """Base class for Run."""
 
     uuid: str
     parent_uuid: Optional[str] = None
     start_time: datetime.datetime = Field(default_factory=datetime.datetime.utcnow)
     end_time: datetime.datetime = Field(default_factory=datetime.datetime.utcnow)
@@ -72,34 +72,34 @@
     execution_order: int
     child_execution_order: int
     serialized: Dict[str, Any]
     session_id: int
     error: Optional[str] = None
 
 
-@deprecated("0.1.0", alternative="Run", removal="0.2.0")
+@deprecated("0.1.0", alternative="Run", removal="0.3.0")
 class LLMRun(BaseRun):
     """Class for LLMRun."""
 
     prompts: List[str]
     response: Optional[LLMResult] = None
 
 
-@deprecated("0.1.0", alternative="Run", removal="0.2.0")
+@deprecated("0.1.0", alternative="Run", removal="0.3.0")
 class ChainRun(BaseRun):
     """Class for ChainRun."""
 
     inputs: Dict[str, Any]
     outputs: Optional[Dict[str, Any]] = None
     child_llm_runs: List[LLMRun] = Field(default_factory=list)
     child_chain_runs: List[ChainRun] = Field(default_factory=list)
     child_tool_runs: List[ToolRun] = Field(default_factory=list)
 
 
-@deprecated("0.1.0", alternative="Run", removal="0.2.0")
+@deprecated("0.1.0", alternative="Run", removal="0.3.0")
 class ToolRun(BaseRun):
     """Class for ToolRun."""
 
     tool_input: str
     output: Optional[str] = None
     action: str
     child_llm_runs: List[LLMRun] = Field(default_factory=list)
@@ -109,16 +109,14 @@
 
 # Begin V2 API Schemas
 
 
 class Run(BaseRunV2):
     """Run schema for the V2 API in the Tracer."""
 
-    execution_order: int
-    child_execution_order: int
     child_runs: List[Run] = Field(default_factory=list)
     tags: Optional[List[str]] = Field(default_factory=list)
     events: List[Dict[str, Any]] = Field(default_factory=list)
     trace_id: Optional[UUID] = None
     dotted_order: Optional[str] = None
 
     @root_validator(pre=True)
```

### Comparing `langchain_core-0.1.9/langchain_core/tracers/stdout.py` & `langchain_core-0.2.0rc1/langchain_core/tracers/stdout.py`

 * *Files 5% similar despite different names*

```diff
@@ -64,17 +64,17 @@
             else:
                 break
         return parents
 
     def get_breadcrumbs(self, run: Run) -> str:
         parents = self.get_parents(run)[::-1]
         string = " > ".join(
-            f"{parent.execution_order}:{parent.run_type}:{parent.name}"
+            f"{parent.run_type}:{parent.name}"
             if i != len(parents) - 1
-            else f"{parent.execution_order}:{parent.run_type}:{parent.name}"
+            else f"{parent.run_type}:{parent.name}"
             for i, parent in enumerate(parents + [run])
         )
         return string
 
     # logging methods
     def _on_chain_start(self, run: Run) -> None:
         crumbs = self.get_breadcrumbs(run)
```

### Comparing `langchain_core-0.1.9/langchain_core/utils/__init__.py` & `langchain_core-0.2.0rc1/langchain_core/utils/__init__.py`

 * *Files 14% similar despite different names*

```diff
@@ -1,13 +1,14 @@
 """
 **Utility functions** for LangChain.
 
 These functions do not depend on any other LangChain module.
 """
 
+from langchain_core.utils import image
 from langchain_core.utils.env import get_from_dict_or_env, get_from_env
 from langchain_core.utils.formatting import StrictFormatter, formatter
 from langchain_core.utils.input import (
     get_bolded_text,
     get_color_mapping,
     get_colored_text,
     print_text,
@@ -37,13 +38,14 @@
     "guard_import",
     "mock_now",
     "print_text",
     "raise_for_status_with_text",
     "xor_args",
     "try_load_from_hub",
     "build_extra_kwargs",
+    "image",
     "get_from_env",
     "get_from_dict_or_env",
     "stringify_dict",
     "comma_list",
     "stringify_value",
 ]
```

### Comparing `langchain_core-0.1.9/langchain_core/utils/aiter.py` & `langchain_core-0.2.0rc1/langchain_core/utils/aiter.py`

 * *Files 1% similar despite different names*

```diff
@@ -116,15 +116,15 @@
             # if we are the last peer, try and close the iterator
             if not peers and hasattr(iterator, "aclose"):
                 await iterator.aclose()
 
 
 class Tee(Generic[T]):
     """
-    Create ``n`` separate asynchronous iterators over ``iterable``
+    Create ``n`` separate asynchronous iterators over ``iterable``.
 
     This splits a single ``iterable`` into multiple iterators, each providing
     the same items in the same order.
     All child iterators may advance separately but share the same items
     from ``iterable`` -- when the most advanced iterator retrieves an item,
     it is buffered until the least advanced iterator has yielded it as well.
     A ``tee`` works lazily and can handle an infinite ``iterable``, provided
```

### Comparing `langchain_core-0.1.9/langchain_core/utils/env.py` & `langchain_core-0.2.0rc1/langchain_core/utils/env.py`

 * *Files identical despite different names*

### Comparing `langchain_core-0.1.9/langchain_core/utils/formatting.py` & `langchain_core-0.2.0rc1/langchain_core/utils/formatting.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 """Utilities for formatting strings."""
 from string import Formatter
 from typing import Any, List, Mapping, Sequence
 
 
 class StrictFormatter(Formatter):
-    """A subclass of formatter that checks for extra keys."""
+    """Formatter that checks for extra keys."""
 
     def vformat(
         self, format_string: str, args: Sequence, kwargs: Mapping[str, Any]
     ) -> str:
         """Check that no arguments are provided."""
         if len(args) > 0:
             raise ValueError(
```

### Comparing `langchain_core-0.1.9/langchain_core/utils/html.py` & `langchain_core-0.2.0rc1/langchain_core/utils/html.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,11 +1,14 @@
+import logging
 import re
 from typing import List, Optional, Sequence, Union
 from urllib.parse import urljoin, urlparse
 
+logger = logging.getLogger(__name__)
+
 PREFIXES_TO_IGNORE = ("javascript:", "mailto:", "#")
 SUFFIXES_TO_IGNORE = (
     ".css",
     ".js",
     ".ico",
     ".png",
     ".jpg",
@@ -48,44 +51,56 @@
     raw_html: str,
     url: str,
     *,
     base_url: Optional[str] = None,
     pattern: Union[str, re.Pattern, None] = None,
     prevent_outside: bool = True,
     exclude_prefixes: Sequence[str] = (),
+    continue_on_failure: bool = False,
 ) -> List[str]:
     """Extract all links from a raw html string and convert into absolute paths.
 
     Args:
         raw_html: original html.
         url: the url of the html.
         base_url: the base url to check for outside links against.
         pattern: Regex to use for extracting links from raw html.
         prevent_outside: If True, ignore external links which are not children
             of the base url.
         exclude_prefixes: Exclude any URLs that start with one of these prefixes.
-
+        continue_on_failure: If True, continue if parsing a specific link raises an
+            exception. Otherwise, raise the exception.
     Returns:
         List[str]: sub links
     """
     base_url_to_use = base_url if base_url is not None else url
     parsed_base_url = urlparse(base_url_to_use)
+    parsed_url = urlparse(url)
     all_links = find_all_links(raw_html, pattern=pattern)
     absolute_paths = set()
     for link in all_links:
-        parsed_link = urlparse(link)
-        # Some may be absolute links like https://to/path
-        if parsed_link.scheme == "http" or parsed_link.scheme == "https":
-            absolute_path = link
-        # Some may have omitted the protocol like //to/path
-        elif link.startswith("//"):
-            absolute_path = f"{urlparse(url).scheme}:{link}"
-        else:
-            absolute_path = urljoin(url, parsed_link.path)
-        absolute_paths.add(absolute_path)
+        try:
+            parsed_link = urlparse(link)
+            # Some may be absolute links like https://to/path
+            if parsed_link.scheme == "http" or parsed_link.scheme == "https":
+                absolute_path = link
+            # Some may have omitted the protocol like //to/path
+            elif link.startswith("//"):
+                absolute_path = f"{parsed_url.scheme}:{link}"
+            else:
+                absolute_path = urljoin(url, parsed_link.path)
+                if parsed_link.query:
+                    absolute_path += f"?{parsed_link.query}"
+            absolute_paths.add(absolute_path)
+        except Exception as e:
+            if continue_on_failure:
+                logger.warning(f"Unable to load link {link}. Raised exception:\n\n{e}")
+                continue
+            else:
+                raise e
 
     results = []
     for path in absolute_paths:
         if any(path.startswith(exclude_prefix) for exclude_prefix in exclude_prefixes):
             continue
 
         if prevent_outside:
```

### Comparing `langchain_core-0.1.9/langchain_core/utils/input.py` & `langchain_core-0.2.0rc1/langchain_core/utils/input.py`

 * *Files 15% similar despite different names*

```diff
@@ -1,8 +1,9 @@
 """Handle chained inputs."""
+
 from typing import Dict, List, Optional, TextIO
 
 _TEXT_COLOR_MAPPING = {
     "blue": "36;1",
     "yellow": "33;1",
     "pink": "38;5;200",
     "green": "32;1",
@@ -33,10 +34,10 @@
 
 
 def print_text(
     text: str, color: Optional[str] = None, end: str = "", file: Optional[TextIO] = None
 ) -> None:
     """Print text with highlighting and no end characters."""
     text_to_print = get_colored_text(text, color) if color else text
-    print(text_to_print, end=end, file=file)
+    print(text_to_print, end=end, file=file)  # noqa: T201
     if file:
         file.flush()  # ensure all printed content are written to file
```

### Comparing `langchain_core-0.1.9/langchain_core/utils/iter.py` & `langchain_core-0.2.0rc1/langchain_core/utils/iter.py`

 * *Files 10% similar despite different names*

```diff
@@ -161,15 +161,23 @@
             child.close()
 
 
 # Why this is needed https://stackoverflow.com/a/44638570
 safetee = Tee
 
 
-def batch_iterate(size: int, iterable: Iterable[T]) -> Iterator[List[T]]:
-    """Utility batching function."""
+def batch_iterate(size: Optional[int], iterable: Iterable[T]) -> Iterator[List[T]]:
+    """Utility batching function.
+
+    Args:
+        size: The size of the batch. If None, returns a single batch.
+        iterable: The iterable to batch.
+
+    Returns:
+        An iterator over the batches.
+    """
     it = iter(iterable)
     while True:
         chunk = list(islice(it, size))
         if not chunk:
             return
         yield chunk
```

### Comparing `langchain_core-0.1.9/langchain_core/utils/strings.py` & `langchain_core-0.2.0rc1/langchain_core/utils/strings.py`

 * *Files identical despite different names*

### Comparing `langchain_core-0.1.9/langchain_core/utils/utils.py` & `langchain_core-0.2.0rc1/langchain_core/utils/utils.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,8 +1,9 @@
 """Generic utility functions."""
+
 import contextlib
 import datetime
 import functools
 import importlib
 import warnings
 from importlib.metadata import version
 from typing import Any, Callable, Dict, Optional, Set, Tuple, Union
@@ -80,22 +81,23 @@
     finally:
         datetime.datetime = real_datetime
 
 
 def guard_import(
     module_name: str, *, pip_name: Optional[str] = None, package: Optional[str] = None
 ) -> Any:
-    """Dynamically imports a module and raises a helpful exception if the module is not
+    """Dynamically import a module and raise an exception if the module is not
     installed."""
     try:
         module = importlib.import_module(module_name, package)
-    except ImportError:
+    except (ImportError, ModuleNotFoundError):
+        pip_name = pip_name or module_name.split(".")[0].replace("_", "-")
         raise ImportError(
             f"Could not import {module_name} python package. "
-            f"Please install it with `pip install {pip_name or module_name}`."
+            f"Please install it with `pip install {pip_name}`."
         )
     return module
 
 
 def check_package_version(
     package: str,
     lt_version: Optional[str] = None,
```

### Comparing `langchain_core-0.1.9/langchain_core/vectorstores.py` & `langchain_core-0.2.0rc1/langchain_core/vectorstores.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,7 +1,27 @@
+"""**Vector store** stores embedded data and performs vector search.
+
+One of the most common ways to store and search over unstructured data is to
+embed it and store the resulting embedding vectors, and then query the store
+and retrieve the data that are 'most similar' to the embedded query.
+
+**Class hierarchy:**
+
+.. code-block::
+
+    VectorStore --> <name>  # Examples: Annoy, FAISS, Milvus
+
+    BaseRetriever --> VectorStoreRetriever --> <name>Retriever  # Example: VespaRetriever
+
+**Main helpers:**
+
+.. code-block::
+
+    Embeddings, Document
+"""  # noqa: E501
 from __future__ import annotations
 
 import logging
 import math
 import warnings
 from abc import ABC, abstractmethod
 from typing import (
@@ -88,16 +108,15 @@
             ids: List of ids to delete.
             **kwargs: Other keyword arguments that subclasses might use.
 
         Returns:
             Optional[bool]: True if deletion is successful,
             False otherwise, None if not implemented.
         """
-
-        raise NotImplementedError("delete method must be implemented by subclass.")
+        return await run_in_executor(None, self.delete, ids, **kwargs)
 
     async def aadd_texts(
         self,
         texts: Iterable[str],
         metadatas: Optional[List[dict]] = None,
         **kwargs: Any,
     ) -> List[str]:
@@ -439,15 +458,30 @@
         self,
         query: str,
         k: int = 4,
         fetch_k: int = 20,
         lambda_mult: float = 0.5,
         **kwargs: Any,
     ) -> List[Document]:
-        """Return docs selected using the maximal marginal relevance."""
+        """Return docs selected using the maximal marginal relevance.
+
+        Maximal marginal relevance optimizes for similarity to query AND diversity
+        among selected documents.
+
+        Args:
+            query: Text to look up documents similar to.
+            k: Number of Documents to return. Defaults to 4.
+            fetch_k: Number of Documents to fetch to pass to MMR algorithm.
+            lambda_mult: Number between 0 and 1 that determines the degree
+                        of diversity among the results with 0 corresponding
+                        to maximum diversity and 1 to minimum diversity.
+                        Defaults to 0.5.
+        Returns:
+            List of Documents selected by maximal marginal relevance.
+        """
 
         # This is a temporary workaround to make the similarity search
         # asynchronous. The proper solution is to make the similarity search
         # asynchronous in the vector store implementations.
         return await run_in_executor(
             None,
             self.max_marginal_relevance_search,
@@ -489,15 +523,23 @@
         embedding: List[float],
         k: int = 4,
         fetch_k: int = 20,
         lambda_mult: float = 0.5,
         **kwargs: Any,
     ) -> List[Document]:
         """Return docs selected using the maximal marginal relevance."""
-        raise NotImplementedError
+        return await run_in_executor(
+            None,
+            self.max_marginal_relevance_search_by_vector,
+            embedding,
+            k=k,
+            fetch_k=fetch_k,
+            lambda_mult=lambda_mult,
+            **kwargs,
+        )
 
     @classmethod
     def from_documents(
         cls: Type[VST],
         documents: List[Document],
         embedding: Embeddings,
         **kwargs: Any,
```

### Comparing `langchain_core-0.1.9/pyproject.toml` & `langchain_core-0.2.0rc1/pyproject.toml`

 * *Files 8% similar despite different names*

```diff
@@ -1,43 +1,42 @@
 [tool.poetry]
 name = "langchain-core"
-version = "0.1.9"
+version = "0.2.0rc1"
 description = "Building applications with LLMs through composability"
 authors = []
 license = "MIT"
 readme = "README.md"
 repository = "https://github.com/langchain-ai/langchain"
 
 
 [tool.poetry.dependencies]
 python = ">=3.8.1,<4.0"
 pydantic = ">=1,<3"
-langsmith = "~0.0.63"
+langsmith = "^0.1.0"
 tenacity = "^8.1.0"
 jsonpatch = "^1.33"
-anyio = ">=3,<5"
 PyYAML = ">=5.3"
-requests = "^2"
 packaging = "^23.2"
-jinja2 = {version = "^3", optional = true}
+jinja2 = { version = "^3", optional = true }
 
 [tool.poetry.group.lint]
 optional = true
 
 [tool.poetry.group.lint.dependencies]
 ruff = "^0.1.5"
 
 [tool.poetry.group.typing]
 optional = true
 
 [tool.poetry.group.typing.dependencies]
-mypy = "^0.991"
+mypy = "^1"
 types-pyyaml = "^6.0.12.2"
 types-requests = "^2.28.11.5"
 types-jinja2 = "^2.11.9"
+langchain-text-splitters = { path = "../text-splitters", develop = true }
 
 [tool.poetry.group.dev]
 optional = true
 
 [tool.poetry.group.dev.dependencies]
 jupyter = "^1.0.0"
 setuptools = "^67.6.1"
@@ -48,43 +47,45 @@
 
 [tool.poetry.group.test.dependencies]
 # The only dependencies that should be added are
 # dependencies used for running tests (e.g., pytest, freezegun, response).
 # Any dependencies that do not meet that criteria will be removed.
 pytest = "^7.3.0"
 freezegun = "^1.2.2"
-pytest-mock  = "^3.10.0"
+pytest-mock = "^3.10.0"
 syrupy = "^4.0.2"
 pytest-watcher = "^0.3.4"
 pytest-asyncio = "^0.21.1"
 grandalf = "^0.8"
+pytest-profiling = "^1.7.0"
+responses = "^0.25.0"
+numpy = "^1.24.0"
 
 
 [tool.poetry.group.test_integration]
 optional = true
 dependencies = {}
 
 [tool.poetry.extras]
 extended_testing = ["jinja2"]
 
-[tool.ruff]
+[tool.ruff.lint]
 select = [
-  "E",  # pycodestyle
-  "F",  # pyflakes
-  "I",  # isort
+  "E",    # pycodestyle
+  "F",    # pyflakes
+  "I",    # isort
+  "T201", # print
 ]
 
 [tool.mypy]
 disallow_untyped_defs = "True"
 exclude = ["notebooks", "examples", "example_data", "langchain_core/pydantic"]
 
 [tool.coverage.run]
-omit = [
-    "tests/*",
-]
+omit = ["tests/*"]
 
 [build-system]
 requires = ["poetry-core>=1.0.0"]
 build-backend = "poetry.core.masonry.api"
 
 [tool.pytest.ini_options]
 # --strict-markers will raise errors on unknown marks.
```

