# Comparing `tmp/odoo_addon_attachment_synchronize-16.0.1.0.0.8-py3-none-any.whl.zip` & `tmp/odoo_addon_attachment_synchronize-16.0.1.0.1-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,32 +1,33 @@
-Zip file size: 167616 bytes, number of entries: 30
--rw-r--r--  2.0 unx     5880 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/README.rst
--rw-r--r--  2.0 unx       21 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/__init__.py
--rw-r--r--  2.0 unx      997 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/__manifest__.py
--rw-r--r--  2.0 unx      644 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/data/cron.xml
--rw-r--r--  2.0 unx     1000 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/demo/attachment_synchronize_task_demo.xml
--rw-r--r--  2.0 unx    14192 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/i18n/attachment_synchronize.pot
--rw-r--r--  2.0 unx    16589 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/i18n/it.po
--rw-r--r--  2.0 unx       77 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/models/__init__.py
--rw-r--r--  2.0 unx     1626 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/models/attachment_queue.py
--rw-r--r--  2.0 unx     9326 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/models/attachment_synchronize_task.py
--rw-r--r--  2.0 unx     2390 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/models/storage_backend.py
--rw-r--r--  2.0 unx      279 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/readme/CONTRIBUTORS.rst
--rw-r--r--  2.0 unx      658 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/readme/DESCRIPTION.rst
--rw-r--r--  2.0 unx     1260 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/readme/USAGE.rst
--rw-r--r--  2.0 unx      216 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/security/ir.model.access.csv
--rw-r--r--  2.0 unx    62223 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/static/description/export_task.png
--rw-r--r--  2.0 unx     9455 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/static/description/icon.png
--rw-r--r--  2.0 unx    69921 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/static/description/import_task.png
--rw-r--r--  2.0 unx    16335 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/static/description/index.html
--rw-r--r--  2.0 unx       52 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/tests/__init__.py
--rw-r--r--  2.0 unx     1425 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/tests/common.py
--rw-r--r--  2.0 unx     1387 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/tests/test_export.py
--rw-r--r--  2.0 unx     3044 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/tests/test_import.py
--rw-r--r--  2.0 unx     2413 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/views/attachment_queue_views.xml
--rw-r--r--  2.0 unx    10360 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/views/attachment_synchronize_task_views.xml
--rw-r--r--  2.0 unx     1378 b- defN 24-Feb-06 06:08 odoo/addons/attachment_synchronize/views/storage_backend_views.xml
--rw-r--r--  2.0 unx     6580 b- defN 24-Feb-06 06:09 odoo_addon_attachment_synchronize-16.0.1.0.0.8.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 24-Feb-06 06:09 odoo_addon_attachment_synchronize-16.0.1.0.0.8.dist-info/WHEEL
--rw-r--r--  2.0 unx        5 b- defN 24-Feb-06 06:09 odoo_addon_attachment_synchronize-16.0.1.0.0.8.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     3444 b- defN 24-Feb-06 06:09 odoo_addon_attachment_synchronize-16.0.1.0.0.8.dist-info/RECORD
-30 files, 243269 bytes uncompressed, 161718 bytes compressed:  33.5%
+Zip file size: 171181 bytes, number of entries: 31
+-rw-r--r--  2.0 unx     5880 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/README.rst
+-rw-r--r--  2.0 unx       21 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/__init__.py
+-rw-r--r--  2.0 unx      997 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/__manifest__.py
+-rw-r--r--  2.0 unx      644 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/data/cron.xml
+-rw-r--r--  2.0 unx     2750 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/demo/attachment_synchronize_task_demo.xml
+-rw-r--r--  2.0 unx    14192 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/i18n/attachment_synchronize.pot
+-rw-r--r--  2.0 unx    16896 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/i18n/es.po
+-rw-r--r--  2.0 unx    16590 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/i18n/it.po
+-rw-r--r--  2.0 unx       77 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/models/__init__.py
+-rw-r--r--  2.0 unx     1626 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/models/attachment_queue.py
+-rw-r--r--  2.0 unx    10101 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/models/attachment_synchronize_task.py
+-rw-r--r--  2.0 unx     2390 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/models/storage_backend.py
+-rw-r--r--  2.0 unx      279 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/readme/CONTRIBUTORS.rst
+-rw-r--r--  2.0 unx      658 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/readme/DESCRIPTION.rst
+-rw-r--r--  2.0 unx     1260 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/readme/USAGE.rst
+-rw-r--r--  2.0 unx      216 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/security/ir.model.access.csv
+-rw-r--r--  2.0 unx    62223 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/static/description/export_task.png
+-rw-r--r--  2.0 unx     9455 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/static/description/icon.png
+-rw-r--r--  2.0 unx    69921 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/static/description/import_task.png
+-rw-r--r--  2.0 unx    16335 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/static/description/index.html
+-rw-r--r--  2.0 unx       52 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/tests/__init__.py
+-rw-r--r--  2.0 unx     1899 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/tests/common.py
+-rw-r--r--  2.0 unx     1387 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/tests/test_export.py
+-rw-r--r--  2.0 unx     3044 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/tests/test_import.py
+-rw-r--r--  2.0 unx     2413 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/views/attachment_queue_views.xml
+-rw-r--r--  2.0 unx    10360 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/views/attachment_synchronize_task_views.xml
+-rw-r--r--  2.0 unx     1378 b- defN 24-May-14 08:25 odoo/addons/attachment_synchronize/views/storage_backend_views.xml
+-rw-r--r--  2.0 unx     6578 b- defN 24-May-14 08:25 odoo_addon_attachment_synchronize-16.0.1.0.1.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 24-May-14 08:25 odoo_addon_attachment_synchronize-16.0.1.0.1.dist-info/WHEEL
+-rw-r--r--  2.0 unx        5 b- defN 24-May-14 08:25 odoo_addon_attachment_synchronize-16.0.1.0.1.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     3540 b- defN 24-May-14 08:25 odoo_addon_attachment_synchronize-16.0.1.0.1.dist-info/RECORD
+31 files, 263259 bytes uncompressed, 165133 bytes compressed:  37.3%
```

## zipnote {}

```diff
@@ -12,14 +12,17 @@
 
 Filename: odoo/addons/attachment_synchronize/demo/attachment_synchronize_task_demo.xml
 Comment: 
 
 Filename: odoo/addons/attachment_synchronize/i18n/attachment_synchronize.pot
 Comment: 
 
+Filename: odoo/addons/attachment_synchronize/i18n/es.po
+Comment: 
+
 Filename: odoo/addons/attachment_synchronize/i18n/it.po
 Comment: 
 
 Filename: odoo/addons/attachment_synchronize/models/__init__.py
 Comment: 
 
 Filename: odoo/addons/attachment_synchronize/models/attachment_queue.py
@@ -72,20 +75,20 @@
 
 Filename: odoo/addons/attachment_synchronize/views/attachment_synchronize_task_views.xml
 Comment: 
 
 Filename: odoo/addons/attachment_synchronize/views/storage_backend_views.xml
 Comment: 
 
-Filename: odoo_addon_attachment_synchronize-16.0.1.0.0.8.dist-info/METADATA
+Filename: odoo_addon_attachment_synchronize-16.0.1.0.1.dist-info/METADATA
 Comment: 
 
-Filename: odoo_addon_attachment_synchronize-16.0.1.0.0.8.dist-info/WHEEL
+Filename: odoo_addon_attachment_synchronize-16.0.1.0.1.dist-info/WHEEL
 Comment: 
 
-Filename: odoo_addon_attachment_synchronize-16.0.1.0.0.8.dist-info/top_level.txt
+Filename: odoo_addon_attachment_synchronize-16.0.1.0.1.dist-info/top_level.txt
 Comment: 
 
-Filename: odoo_addon_attachment_synchronize-16.0.1.0.0.8.dist-info/RECORD
+Filename: odoo_addon_attachment_synchronize-16.0.1.0.1.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## odoo/addons/attachment_synchronize/README.rst

```diff
@@ -3,15 +3,15 @@
 ======================
 
 .. 
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !! This file is generated by oca-gen-addon-readme !!
    !! changes will be overwritten.                   !!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-   !! source digest: sha256:df01bd9b8a51738a68feed9421bed8ce9d5a23d4c5e8db7a8f230218cb95a611
+   !! source digest: sha256:0f1a47ff1d87a76dc1e0bce4178fc538be9abc93414fbcec5bfd3a6299aa2dcd
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 
 .. |badge1| image:: https://img.shields.io/badge/maturity-Beta-yellow.png
     :target: https://odoo-community.org/page/development-status
     :alt: Beta
 .. |badge2| image:: https://img.shields.io/badge/licence-AGPL--3-blue.png
     :target: http://www.gnu.org/licenses/agpl-3.0-standalone.html
```

## odoo/addons/attachment_synchronize/__manifest__.py

```diff
@@ -1,15 +1,15 @@
 # @ 2016 florian DA COSTA @ Akretion
 # © 2016 @author Mourad EL HADJ MIMOUNE <mourad.elhadj.mimoune@akretion.com>
 # @ 2020 Giovanni Serra @ GSlab.it
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl.html).
 
 {
     "name": "Attachment Synchronize",
-    "version": "16.0.1.0.0",
+    "version": "16.0.1.0.1",
     "author": "Akretion,Odoo Community Association (OCA)",
     "website": "https://github.com/OCA/server-tools",
     "maintainers": ["florian-dacosta", "sebastienbeau", "GSLabIt", "bealdav"],
     "license": "AGPL-3",
     "category": "Generic Modules",
     "depends": [
         "attachment_queue",
```

## odoo/addons/attachment_synchronize/demo/attachment_synchronize_task_demo.xml

### odoo/addons/attachment_synchronize/demo/attachment_synchronize_task_demo.xml

```diff
@@ -1,16 +1,48 @@
 <?xml version="1.0" encoding="utf-8"?>
 <odoo>
   <record id="import_from_filestore" model="attachment.synchronize.task">
     <field name="name">TEST Import</field>
     <field name="backend_id" ref="fs_storage.default_fs_storage"/>
     <field name="method_type">import</field>
+    <field name="filepath">test_import</field>
+    <field name="avoid_duplicated_files" eval="True"/>
+  </record>
+  <record id="import_from_filestore_delete" model="attachment.synchronize.task">
+    <field name="name">TEST Import then delete</field>
+    <field name="backend_id" ref="fs_storage.default_fs_storage"/>
+    <field name="method_type">import</field>
     <field name="after_import">delete</field>
     <field name="filepath">test_import</field>
   </record>
+  <record id="import_from_filestore_rename" model="attachment.synchronize.task">
+    <field name="name">TEST Import then rename</field>
+    <field name="backend_id" ref="fs_storage.default_fs_storage"/>
+    <field name="method_type">import</field>
+    <field name="after_import">rename</field>
+    <field name="filepath">test_import</field>
+    <field name="new_name">test-${obj.name}</field>
+  </record>
+  <record id="import_from_filestore_move" model="attachment.synchronize.task">
+    <field name="name">TEST Import then move</field>
+    <field name="backend_id" ref="fs_storage.default_fs_storage"/>
+    <field name="method_type">import</field>
+    <field name="after_import">move</field>
+    <field name="filepath">test_import</field>
+    <field name="move_path">test_archived</field>
+  </record>
+  <record id="import_from_filestore_move_rename" model="attachment.synchronize.task">
+    <field name="name">TEST Import then move and rename</field>
+    <field name="backend_id" ref="fs_storage.default_fs_storage"/>
+    <field name="method_type">import</field>
+    <field name="after_import">move_rename</field>
+    <field name="filepath">test_import</field>
+    <field name="move_path">test_archived</field>
+    <field name="new_name">foo.txt</field>
+  </record>
   <record id="export_to_filestore" model="attachment.synchronize.task">
     <field name="name">TEST Export</field>
     <field name="backend_id" ref="fs_storage.default_fs_storage"/>
     <field name="method_type">export</field>
     <field name="filepath">test_export</field>
   </record>
   <record id="attachment_queue_imported_demo" model="attachment.queue">
```

## odoo/addons/attachment_synchronize/i18n/it.po

```diff
@@ -2,15 +2,15 @@
 # This file contains the translation of the following modules:
 # 	* attachment_synchronize
 #
 msgid ""
 msgstr ""
 "Project-Id-Version: Odoo Server 16.0\n"
 "Report-Msgid-Bugs-To: \n"
-"PO-Revision-Date: 2024-02-05 09:35+0000\n"
+"PO-Revision-Date: 2024-04-04 11:35+0000\n"
 "Last-Translator: mymage <stefano.consolaro@mymage.it>\n"
 "Language-Team: none\n"
 "Language: it\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: \n"
 "Plural-Forms: nplurals=2; plural=n != 1;\n"
@@ -370,15 +370,15 @@
 
 #. module: attachment_synchronize
 #: model:ir.model.fields,help:attachment_synchronize.field_attachment_queue__file_type
 msgid ""
 "The file type determines an import method to be used to parse and transform "
 "data before their import in ERP or an export"
 msgstr ""
-"Il tipo di file determina il metodo di importazine da utilizzare per "
+"Il tipo di file determina il metodo di importazione da utilizzare per "
 "elaborare e trasformare i dati prima dell'importazione nell'ERP o per "
 "l'esportazione"
 
 #. module: attachment_synchronize
 #: model:ir.model.fields,help:attachment_synchronize.field_attachment_synchronize_task__failure_emails
 msgid ""
 "Used to fill the 'Failure Emails' field in the 'Attachments Queues' related "
```

## odoo/addons/attachment_synchronize/models/attachment_synchronize_task.py

```diff
@@ -139,15 +139,23 @@
 
     @api.model
     def run_task_import_scheduler(self, domain=None):
         if domain is None:
             domain = []
         domain = expression.AND([domain, [("method_type", "=", "import")]])
         for task in self.search(domain):
-            task.run_import()
+            try:
+                task.run_import()
+            except Exception as e:
+                self.env.cr.rollback()
+                # log exception and continue in order to no block all task from all
+                # remote servers one is unavailable
+                _logger.warning(
+                    "Task import %s failed with error %s" % (task.name, str(e))
+                )
 
     def run(self):
         for record in self:
             method = "run_{}".format(record.method_type)
             if not hasattr(self, method):
                 raise NotImplementedError
             else:
@@ -193,24 +201,32 @@
         attach_obj = self.env["attachment.queue"]
         file_path_names = self._get_files()
         total_import = 0
         fs = self.backend_id.fs
         for file_path in file_path_names:
             if fs.isdir(file_path):
                 continue
-            with self.env.cr.savepoint():
+            # we need to commit after each file because it may be renamed, deleted
+            # moved on remote and if it fails later, we would could lose the file
+            # forever.
+            with self.env.registry.cursor() as new_cr:
+                new_env = api.Environment(new_cr, self.env.uid, self.env.context)
                 file_name = file_path.split(fs.sep)[-1]
                 # avoid use of cat_file because it may not be implemeted in async
                 # implementation like sshfs
                 with fs.open(file_path, "rb") as fs_file:
                     data = fs_file.read()
                 data = base64.b64encode(data)
-                attach_vals = self._prepare_attachment_vals(data, file_name)
-                attachment = attach_obj.create(attach_vals)
-                self._manage_file_after_import(file_name, file_path, attachment)
+                attach_vals = self.with_env(new_env)._prepare_attachment_vals(
+                    data, file_name
+                )
+                attachment = attach_obj.with_env(new_env).create(attach_vals)
+                self.with_env(new_env)._manage_file_after_import(
+                    file_name, file_path, attachment
+                )
                 total_import += 1
         _logger.info("Run import complete! Imported {} files".format(total_import))
 
     def _filter_duplicates(self, file_path_names):
         fs = self.backend_id.fs
         self.ensure_one()
         if self.filepath:
```

## odoo/addons/attachment_synchronize/static/description/index.html

```diff
@@ -362,15 +362,15 @@
 <div class="document" id="attachment-synchronize">
 <h1 class="title">Attachment Synchronize</h1>
 
 <!-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 !! This file is generated by oca-gen-addon-readme !!
 !! changes will be overwritten.                   !!
 !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-!! source digest: sha256:df01bd9b8a51738a68feed9421bed8ce9d5a23d4c5e8db7a8f230218cb95a611
+!! source digest: sha256:0f1a47ff1d87a76dc1e0bce4178fc538be9abc93414fbcec5bfd3a6299aa2dcd
 !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! -->
 <p><a class="reference external image-reference" href="https://odoo-community.org/page/development-status"><img alt="Beta" src="https://img.shields.io/badge/maturity-Beta-yellow.png" /></a> <a class="reference external image-reference" href="http://www.gnu.org/licenses/agpl-3.0-standalone.html"><img alt="License: AGPL-3" src="https://img.shields.io/badge/licence-AGPL--3-blue.png" /></a> <a class="reference external image-reference" href="https://github.com/OCA/server-tools/tree/16.0/attachment_synchronize"><img alt="OCA/server-tools" src="https://img.shields.io/badge/github-OCA%2Fserver--tools-lightgray.png?logo=github" /></a> <a class="reference external image-reference" href="https://translation.odoo-community.org/projects/server-tools-16-0/server-tools-16-0-attachment_synchronize"><img alt="Translate me on Weblate" src="https://img.shields.io/badge/weblate-Translate%20me-F47D42.png" /></a> <a class="reference external image-reference" href="https://runboat.odoo-community.org/builds?repo=OCA/server-tools&amp;target_branch=16.0"><img alt="Try me on Runboat" src="https://img.shields.io/badge/runboat-Try%20me-875A7B.png" /></a></p>
 <p>This module allows to <strong>import/export files</strong> from/to backend servers.</p>
 <p>A backend server is defined by the basic <a class="reference external" href="https://github.com/OCA/storage/tree/16.0/fs_storage">fs_storage</a> OCA module, while it can be configured (amazon S3, sftp,…) with additional modules fs python libraries</p>
 <p>The imported files (and the files to be exported) are stored in Odoo as <tt class="docutils literal">attachment.queue</tt> objects, defined by the <a class="reference external" href="https://github.com/OCA/server-tools/tree/16.0/attachment_queue">attachment_queue</a> module while the importation itself (resp. exportation) is realized by <strong>“Attachments Import Tasks”</strong> (resp. “Attachments Export Tasks”) defined by this current module.</p>
 <p><strong>Table of contents</strong></p>
 <div class="contents local topic" id="contents">
```

## odoo/addons/attachment_synchronize/tests/common.py

```diff
@@ -32,11 +32,23 @@
         self.filedata = base64.b64encode(b"This is a simple file")
         self.directory_input = "test_import"
         self.directory_output = "test_export"
         self.directory_archived = "test_archived"
         self._clean_testing_directory()
         self._create_test_file()
         self.task = self.env.ref("attachment_synchronize.import_from_filestore")
+        self.task_delete = self.env.ref(
+            "attachment_synchronize.import_from_filestore_delete"
+        )
+        self.task_move = self.env.ref(
+            "attachment_synchronize.import_from_filestore_move"
+        )
+        self.task_rename = self.env.ref(
+            "attachment_synchronize.import_from_filestore_rename"
+        )
+        self.task_move_rename = self.env.ref(
+            "attachment_synchronize.import_from_filestore_move_rename"
+        )
 
     def tearDown(self):
         self._clean_testing_directory()
         super().tearDown()
```

## odoo/addons/attachment_synchronize/tests/test_import.py

```diff
@@ -1,81 +1,87 @@
 # Copyright 2020 Akretion (http://www.akretion.com).
 # @author Sébastien BEAU <sebastien.beau@akretion.com>
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl).
 
+from odoo import api
+
 from .common import SyncCommon
 
 
 class TestImport(SyncCommon):
+    def tearDown(self):
+        self.registry.leave_test_mode()
+        super().tearDown()
+
+    def setUp(self):
+        super().setUp()
+        self.registry.enter_test_mode(self.env.cr)
+        self.env = api.Environment(
+            self.registry.test_cr, self.env.uid, self.env.context
+        )
+
     @property
     def archived_files(self):
         return self.backend.fs.ls(self.directory_archived, detail=False)
 
     @property
     def input_files(self):
         return self.backend.fs.ls(self.directory_input, detail=False)
 
     def _check_attachment_created(self, count=1):
-        attachment = self.env["attachment.queue"].search([("name", "=", "bar.txt")])
-        self.assertEqual(len(attachment), count)
+        with self.env.registry.cursor() as new_cr:
+            attachment = self.env(cr=new_cr)["attachment.queue"].search(
+                [("name", "=", "bar.txt")]
+            )
+            self.assertEqual(len(attachment), count)
 
     def test_import_with_rename(self):
-        self.task.write({"after_import": "rename", "new_name": "test-${obj.name}"})
-        self.task.run_import()
+        self.task_rename.run_import()
         self._check_attachment_created()
         self.assertEqual(self.input_files, ["test_import/test-bar.txt"])
         self.assertEqual(self.archived_files, [])
 
     def test_import_with_move(self):
-        self.task.write({"after_import": "move", "move_path": self.directory_archived})
-        self.task.run_import()
+        self.task_move.run_import()
         self._check_attachment_created()
         self.assertEqual(self.input_files, [])
         self.assertEqual(self.archived_files, ["test_archived/bar.txt"])
 
     def test_import_with_move_and_rename(self):
-        self.task.write(
-            {
-                "after_import": "move_rename",
-                "new_name": "foo.txt",
-                "move_path": self.directory_archived,
-            }
-        )
-        self.task.run_import()
+        self.task_move_rename.run_import()
         self._check_attachment_created()
         self.assertEqual(self.input_files, [])
         self.assertEqual(self.archived_files, ["test_archived/foo.txt"])
 
     def test_import_with_delete(self):
-        self.task.write({"after_import": "delete"})
-        self.task.run_import()
+        self.task_delete.run_import()
         self._check_attachment_created()
         self.assertEqual(self.input_files, [])
         self.assertEqual(self.archived_files, [])
 
     def test_import_twice(self):
-        self.task.write({"after_import": "delete"})
-        self.task.run_import()
+        self.task_delete.run_import()
         self._check_attachment_created(count=1)
 
         self._create_test_file()
-        self.task.run_import()
+        self.task_delete.run_import()
         self._check_attachment_created(count=2)
 
     def test_import_twice_no_duplicate(self):
-        self.task.write({"after_import": "delete", "avoid_duplicated_files": True})
         self.task.run_import()
         self._check_attachment_created(count=1)
 
         self._create_test_file()
         self.task.run_import()
         self._check_attachment_created(count=1)
 
     def test_running_cron(self):
-        self.task.write({"after_import": "delete"})
+        self.env["attachment.synchronize.task"].search(
+            [("id", "!=", self.task.id)]
+        ).write({"active": False})
         self.env["attachment.synchronize.task"].run_task_import_scheduler()
         self._check_attachment_created(count=1)
 
     def test_running_cron_disable_task(self):
-        self.task.write({"after_import": "delete", "active": False})
+        self.env["attachment.synchronize.task"].search([]).write({"active": False})
         self.env["attachment.synchronize.task"].run_task_import_scheduler()
         self._check_attachment_created(count=0)
```

## Comparing `odoo_addon_attachment_synchronize-16.0.1.0.0.8.dist-info/METADATA` & `odoo_addon_attachment_synchronize-16.0.1.0.1.dist-info/METADATA`

 * *Files 3% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: odoo-addon-attachment-synchronize
-Version: 16.0.1.0.0.8
+Version: 16.0.1.0.1
 Summary: Attachment Synchronize
 Home-page: https://github.com/OCA/server-tools
 Author: Akretion,Odoo Community Association (OCA)
 Author-email: support@odoo-community.org
 License: AGPL-3
 Platform: UNKNOWN
 Classifier: Programming Language :: Python
@@ -22,15 +22,15 @@
 ======================
 
 .. 
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !! This file is generated by oca-gen-addon-readme !!
    !! changes will be overwritten.                   !!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-   !! source digest: sha256:df01bd9b8a51738a68feed9421bed8ce9d5a23d4c5e8db7a8f230218cb95a611
+   !! source digest: sha256:0f1a47ff1d87a76dc1e0bce4178fc538be9abc93414fbcec5bfd3a6299aa2dcd
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 
 .. |badge1| image:: https://img.shields.io/badge/maturity-Beta-yellow.png
     :target: https://odoo-community.org/page/development-status
     :alt: Beta
 .. |badge2| image:: https://img.shields.io/badge/licence-AGPL--3-blue.png
     :target: http://www.gnu.org/licenses/agpl-3.0-standalone.html
```

## Comparing `odoo_addon_attachment_synchronize-16.0.1.0.0.8.dist-info/RECORD` & `odoo_addon_attachment_synchronize-16.0.1.0.1.dist-info/RECORD`

 * *Files 9% similar despite different names*

```diff
@@ -1,30 +1,31 @@
-odoo/addons/attachment_synchronize/README.rst,sha256=Pd5ZzOhVmavmuxm5VAMtF06L5FwzBqAlIZc3A8l8Ddw,5880
+odoo/addons/attachment_synchronize/README.rst,sha256=N5rjmu0Vd9SlQTpuUouruZj5tJzL769tTYgl3tQ2T6M,5880
 odoo/addons/attachment_synchronize/__init__.py,sha256=X9EJGOE2GtZbS0G82PtSXmWSZ_R8jEM0rlJTDliQjp4,21
-odoo/addons/attachment_synchronize/__manifest__.py,sha256=7U8ofU7Ppj2JgFiyyDzPh9BTjr-1-alUAq_oAEeig-E,997
+odoo/addons/attachment_synchronize/__manifest__.py,sha256=fwQOR2HN9NZrLFgZAd0sK3GLct1adHmBSS_gnlUD4Kc,997
 odoo/addons/attachment_synchronize/data/cron.xml,sha256=2OmlM9ePrLcaDZ6rW5cWO0A956z8bdOoAbqzhExd5fc,644
-odoo/addons/attachment_synchronize/demo/attachment_synchronize_task_demo.xml,sha256=qknQ_FjBuk8Vq_Uf1Wr3LZeK_QL9_SPLJKAe1IPXnhY,1000
+odoo/addons/attachment_synchronize/demo/attachment_synchronize_task_demo.xml,sha256=-G9arzSkcVNKeMsxAmnV7F-1Gcsl7R2mkn8Q21EIF5g,2750
 odoo/addons/attachment_synchronize/i18n/attachment_synchronize.pot,sha256=caZR1BsiKKcDMie2Rl0Pi98cMjD-mcJMw_oY8sGErjY,14192
-odoo/addons/attachment_synchronize/i18n/it.po,sha256=YkQSxUlPvbHFJ9WV1KM8tsMJnltNiU1JhyQ4jHweMl0,16589
+odoo/addons/attachment_synchronize/i18n/es.po,sha256=8QAsFkQur-mUue6t4vIT2qoXcgj_M_CpZJpTb3jbZ8c,16896
+odoo/addons/attachment_synchronize/i18n/it.po,sha256=2SjSJRIsVkVAYoz_wR64hv_IEei8BKNNfCzZpzpXJoE,16590
 odoo/addons/attachment_synchronize/models/__init__.py,sha256=nD1T_ZApWZjACP_j3NtLINLLXlf-3Cg0HSWzc99Pb7I,77
 odoo/addons/attachment_synchronize/models/attachment_queue.py,sha256=5atxnf7gzNNMwfaWuki2tFRIeN2mibGmjP9-PVfp9DE,1626
-odoo/addons/attachment_synchronize/models/attachment_synchronize_task.py,sha256=8TTRkDm4kz48ydicyMMJue_j1Zo8a2ko5IyKsLNviq8,9326
+odoo/addons/attachment_synchronize/models/attachment_synchronize_task.py,sha256=wZfUwrmG_mZwwpy5jtBt-zT1OFNVxCiS1CCUvJ9YNK4,10101
 odoo/addons/attachment_synchronize/models/storage_backend.py,sha256=UN1h1jjWbaNfJlhvYYNxW8KhifDUAYPSdHg6Pgiy0Vw,2390
 odoo/addons/attachment_synchronize/readme/CONTRIBUTORS.rst,sha256=f9rdrf-SNJQjycMC7_uKG8Nwn4azlI8xa9ZIWGIVC6g,279
 odoo/addons/attachment_synchronize/readme/DESCRIPTION.rst,sha256=0DzeqfgFfT_neLWDEHKvTY3tvxWYgvIgTsk0WxyzYeg,658
 odoo/addons/attachment_synchronize/readme/USAGE.rst,sha256=yc-Dto9ntujDsxKpa7d5SaWAjz4VbLn30DbNIH3Srf4,1260
 odoo/addons/attachment_synchronize/security/ir.model.access.csv,sha256=QgoOy_NkxWjikWmngbJSaXJd8dEN1c3t5zLt71aVAyE,216
 odoo/addons/attachment_synchronize/static/description/export_task.png,sha256=EOkzd34b4_X-Mu26PBxCZXSconLFjWM1uoGEAGtja1o,62223
 odoo/addons/attachment_synchronize/static/description/icon.png,sha256=6xBPJauaFOF0KDHfHgQopSc28kKvxMaeoQFQWZtfZDo,9455
 odoo/addons/attachment_synchronize/static/description/import_task.png,sha256=_g0tbFsGhRYogNugDcGqV5gc24qIkA_cq8SN7oFUdyU,69921
-odoo/addons/attachment_synchronize/static/description/index.html,sha256=fcnankOKrsWGKzk-shJhHY3Fj6-YzOTDI5xAqj_VmKY,16335
+odoo/addons/attachment_synchronize/static/description/index.html,sha256=w9TR9D-R6j9C1OgHnv6EjWBFDxiNFYYQ2l2Q_i-cVTw,16335
 odoo/addons/attachment_synchronize/tests/__init__.py,sha256=zU_GwZ2thmM5Ih9uWHVH1_2vivygGf_M7R63GAqko4M,52
-odoo/addons/attachment_synchronize/tests/common.py,sha256=qJfVqn3M7dQCBP81Dd0-9vw27KauqpRCYooOJ1fwK70,1425
+odoo/addons/attachment_synchronize/tests/common.py,sha256=Vtjiv2QyXW9IroEuWHfu1Cz1UGLiM_sqtQb8zJ-KpKk,1899
 odoo/addons/attachment_synchronize/tests/test_export.py,sha256=QBwxiY3OBxqT-LaK7HfBl5QBujPoTuIIPNOYDU5vfLU,1387
-odoo/addons/attachment_synchronize/tests/test_import.py,sha256=0ilujZLjTobw_yVCjtekz_b-ocv0s01FH6mABLv7BXE,3044
+odoo/addons/attachment_synchronize/tests/test_import.py,sha256=vrmUDyZJf4LJxEmM95MQ7a4ESK06Sm4bPkYKnoJHDHg,3044
 odoo/addons/attachment_synchronize/views/attachment_queue_views.xml,sha256=81jzBm3R7W5peHSFqPpFtkbLpxjjk891w4QOSlCTOj4,2413
 odoo/addons/attachment_synchronize/views/attachment_synchronize_task_views.xml,sha256=eDA-5vHpw3rzxCj5ws_A3948_U13c33OSeq0wtQhfPI,10360
 odoo/addons/attachment_synchronize/views/storage_backend_views.xml,sha256=Isv1GzfaUVyCg0se747MzSnv2puNftDfZwP2VA1S0wg,1378
-odoo_addon_attachment_synchronize-16.0.1.0.0.8.dist-info/METADATA,sha256=4TagaKdveVGMM8mLGty89JdTHgnHzWsZyQn-_6UMJ2o,6580
-odoo_addon_attachment_synchronize-16.0.1.0.0.8.dist-info/WHEEL,sha256=oiQVh_5PnQM0E3gPdiz09WCNmwiHDMaGer_elqB3coM,92
-odoo_addon_attachment_synchronize-16.0.1.0.0.8.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
-odoo_addon_attachment_synchronize-16.0.1.0.0.8.dist-info/RECORD,,
+odoo_addon_attachment_synchronize-16.0.1.0.1.dist-info/METADATA,sha256=xU3RphQkalTTEtvpawxEEvnBkQJ5TD7ar-05f_j8zRQ,6578
+odoo_addon_attachment_synchronize-16.0.1.0.1.dist-info/WHEEL,sha256=GJ7t_kWBFywbagK5eo9IoUwLW6oyOeTKmQ-9iHFVNxQ,92
+odoo_addon_attachment_synchronize-16.0.1.0.1.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
+odoo_addon_attachment_synchronize-16.0.1.0.1.dist-info/RECORD,,
```

